<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>PENDING WIKI</title>
    <url>/wiki/3/</url>
    <content><![CDATA[<blockquote>
<p> 等待发布的 Wiki 页面，基于 Gist 可以方便地在线编辑内容。</p>
</blockquote>
<script src="https://gist.github.com/imzlp/04b41b75fe4f956ad70f7cf6e0967bf7.js"></script>

<hr>
<ul>
<li><a href="https://imzlp.com/posts/25331/">UE 开发的问题笔记和资料辑录 </a></li>
<li><a href="https://imzlp.com/posts/3380/">UE 和 VR 开发技术笔记 </a></li>
<li><a href="https://imzlp.com/posts/12143/">UE 工具链配置与开发技巧 </a></li>
<li><a href="https://imzlp.com/categories/Unreal-Engine/"> 我的 Unreal Engine 技术文章归档 </a></li>
</ul>
<hr>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <tags>
        <tag>Wiki</tag>
      </tags>
  </entry>
  <entry>
    <title>欢迎访问虚幻社区知识库！</title>
    <url>/wiki/1/</url>
    <content><![CDATA[<p>我是查利鹏，<a href="https://imzlp.com/">循迹研究室 </a> 博客作者，过去几年积累了很多 UE 相关的文章和技术笔记，为了方便组织、管理以及检索，创建本站点作为 Unreal Engine Wiki 知识站点，用于发布 UE 相关的技术内容。<br>同时也计划把虚幻社区那些优秀但散落在各个平台的内容整合起来，方便统一地查阅和检索，目标是创建一个由 <strong> 社区驱动 </strong> 的<strong>公益性 </strong> 虚幻知识库，期望能发展成为一个全面的 Unreal Engine 的中文 wiki 站点。<br>本站会持续更新，包含 UE 特性、引擎分析、工具教程、开发技巧等内容，希望能对 UE 开发者提供一些帮助，也欢迎投稿支持，共同促进 UE 社区的发展。</p>
<p>我之前开源了一批 UE 的工具和插件并整理了一些文档链接资料，详情可在 <a href="https://ue5wiki.com/resources/#Plugins">Resources</a> 中查看。</p>
<p>我的博客：<a href="https://imzlp.com/">imzlp.com</a>  Github：<a href="http://github.com/hxhb">hxhb</a> / <a href="http://github.com/UnrealCommunity">UnrealCommunity</a></p>
<blockquote>
<p>本站被部署在 Github Pages 上，提交和编辑内容，均基于 Github 账号系统。</p>
</blockquote>
<ol>
<li><a href="https://ue5wiki.com/wiki/2/#%E5%86%85%E5%AE%B9%E6%8A%95%E7%A8%BF"><strong>内容投稿 </strong></a>，在<a href="https://github.com/UnrealCommunity/commit_wiki">UnrealCommunity/commit_wiki</a> 仓库中创建一个 issue，按照 <a href="https://ue5wiki.com/wiki/2/">Wiki 内容编写格式与提交规则</a> 方式编写并提交即可，当被投稿被接收一次之后会被添加至 Authors 用户组，在页面或右侧分类中点击 <code>New</code> 即可创建新内容，并且可以通过 <code>Edit</code> 跳转到 Github 页面直接编辑。</li>
<li><a href="https://ue5wiki.com/wiki/2/#%E9%93%BE%E6%8E%A5%E6%8A%95%E7%A8%BF"><strong>链接投稿 </strong></a>，可以把发布于外部网站的内容被本站收录，可以添加分类、标签，能够在本站搜索，通过<a href="https://docs.google.com/spreadsheets/d/1EKEiP8OeTS45cMnOUPYpB-1Ek9rVWT8YP9bSAqNO70g/edit#gid=240522518">Google Docs</a> 编辑管理。<strong>本站不做任何非原作者内容搬运，链接投稿的内容会直接跳转至原链接</strong>。</li>
</ol>
<p>我会定期整理 <code>issues</code> 方式的投稿并发布。通过 <code>New</code> 创建的会自动发布，并更新贡献者名单，以及为每一位作者创建一个独立的归档页面，如<a href="https://ue5wiki.com/contributor/lipengzha/">contributor/lipengzha</a>。</p>
<h3 id="Epic-Offical-Documents"><a href="#Epic-Offical-Documents" class="headerlink" title="Epic Offical Documents"></a>Epic Offical Documents</h3><ul>
<li><a href="https://docs.unrealengine.com/5.0/en-US/">Unreal Engine 5 Documentation</a></li>
<li><a href="https://docs.unrealengine.com/4.27/en-US/">Unreal Engine 4 Documentation</a></li>
<li><a href="https://docs.unrealengine.com/en-US/API/index.html">Unreal Engine API Reference</a></li>
<li><a href="https://docs.unrealengine.com/4.27/en-US/WhatsNew/Builds/">Unreal Engine  4 Release Notes</a></li>
<li><a href="https://docs.unrealengine.com/5.1/en-US/unreal-engine-5.1-release-notes/">Unreal Engine  5 Release Notes</a></li>
<li><a href="https://www.unrealengine.com/en-US/resources">Unreal Engine Resource</a></li>
<li><a href="https://www.unrealengine.com/en-US/feed">Unreal Engine Feeds</a></li>
<li><a href="https://portal.productboard.com/epicgames/">Unreal Engine Public Roadmap</a></li>
<li><a href="https://docs.unrealengine.com/en-US/ProgrammingAndScripting/ProgrammingWithCPP/index.html">Programming with C++</a></li>
<li><a href="https://issues.unrealengine.com/">Unreal Engine Issues</a></li>
<li><a href="https://ue4community.wiki/">Unreal Engine Community Wiki</a></li>
<li><a href="https://www.zhihu.com/column/egc-community">虚幻中国 - 虚幻引擎官方社区新闻文章</a></li>
<li><a href="https://imzlp.com/posts/11515/">Unreal Engine C++ API Dash Document</a></li>
<li><a href="https://consolehelp.imzlp.com/">Unreal Engine Console Variables and Commands</a>(<a href="https://consolehelp.imzlp.com/ue5">ue5</a>)</li>
</ul>
<h3 id="Contributor"><a href="#Contributor" class="headerlink" title="Contributor"></a>Contributor</h3><blockquote>
<p>希望更多的开发者能踊跃投稿，分享自己的开发经验，为虚幻社区添砖加瓦！</p>
</blockquote>
<p>感谢以下组织对开发者的支持：</p>
<div class="contributor-box" style="overflow-y:auto;">
<table style="width:auto;margin:unset;margin-bottom:5px;margin-top:5px;">
<tr>
<td align="center" style="text-align:center;border: 1px solid #c1cfdc;color: #009bf5;font-weight: 500;width: 90px; padding: 10px 10px;white-space:nowrap;"><a href="https://unrealengine.com/"><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/uelogo.webp" width="60px;" alt=""style="display: block;margin: 0 auto;padding: 2px;max-width: 96px;height: auto;border: 2px solid #333;border-radius: 60px;"/></a><sub text-align="center"style="font-size: 15px;">Epic Games</sub></a><br/><a href="https://github.com/EpicGames"title="Github"><i class="fab fa-github fa-fw"style="color:#555"></i></a></a></td>
<td align="center" style="text-align:center;border: 1px solid #c1cfdc;color: #009bf5;font-weight: 500;width: 90px; padding: 10px 10px;white-space:nowrap;"><a href="https://opensource.tencent.com/"><img src="https://avatars.githubusercontent.com/Tencent" width="60px;" alt=""style="display: block;margin: 0 auto;padding: 2px;max-width: 96px;height: auto;border: 2px solid #333;border-radius: 60px;"/></a><sub text-align="center"style="font-size: 15px;">Tencent</sub></a><br/><a href="https://github.com/Tencent"title="Github"><i class="fab fa-github fa-fw"style="color:#555"></i></a></a></td>
</table>
</tr>
</div>


<p>本站的内容贡献者：</p>
<!-- contributor list -->
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <tags>
        <tag>Wiki</tag>
      </tags>
  </entry>
  <entry>
    <title>Wiki 内容编写格式与规则</title>
    <url>/wiki/2/</url>
    <content><![CDATA[<blockquote>
<p><strong>重要</strong>：本站不允许非作者的全文转载，每篇内容版权归作者所有，欢迎外部作者将内容投稿到本站。</p>
</blockquote>
<p>本站支持两种投稿方式：</p>
<ol>
<li>内容投稿，直接把内容创建一个 md 文件发布到本站，能够进行全文搜索、贡献统计。</li>
<li>链接投稿，能够把一篇外部链接的内容发布到本站，可以进行分类和添加标签，点击会跳转到指定的链接。</li>
</ol>
<p>方式均为在 <a href="https://github.com/UnrealCommunity/commit_wiki/issues">commit_wiki/issues</a> 创建一个 issue，我提供了 <strong> 链接投稿 </strong> 和<strong>内容投稿 </strong> 的两个模板，按照格式提交即可。</p>
<h3 id="链接投稿"><a href="# 链接投稿" class="headerlink" title="链接投稿"></a>链接投稿 </h3><p> 收录外部平台的文章，需要创建一个外部平台文章的 issues:<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211107122447.webp"></p>
<p>并按照以下格式编写 issue，提交即可。</p>
<figure class="highlight md"><table><tr><td class="code"><pre><span class="line">文章名: 这是一篇新文章 </span><br><span class="line"> 作者: author</span><br><span class="line">文章链接: https://ue5wiki.com/</span><br><span class="line">发表时间: 2022/10/10</span><br><span class="line">分类 (/ 分隔): Category1/Cateogry2</span><br><span class="line"> 标签(/ 分隔): Tag1/Tag2/Tag3</span><br><span class="line">GithubID: hxhb</span><br><span class="line">Email: </span><br><span class="line">Website: https://ue5wiki.com/</span><br><span class="line">AvatarLink: </span><br></pre></td></tr></table></figure>

<p>同样能够被本站的分类、标签中查看、以及搜索（仅限标题），点击链接会自动跳转到所指定的链接页面。</p>
<p>发布之后就会在分类和标签页面显示：<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210710170854.webp" alt="分类"><br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210710171140.webp" alt="标签云"><br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210710171323.webp" alt="标签"><br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210710171252.webp" alt="搜索"></p>
<h3 id="内容投稿"><a href="# 内容投稿" class="headerlink" title="内容投稿"></a>内容投稿 </h3><p> 提交新的 Wiki 词条需要在 <a href="https://github.com/UnrealCommunity/commit_wiki">UnrealCommunity/commit_wiki</a> 中创建一个 issue，Wiki 格式已创建模版，在 issues 页面选择“创建新的 Wiki 内容”即可，当使用这种方式投稿并被接受一次之后会被添加 <code>Authors</code> 权限，就能够点击页面右上角的 <code>Edit</code>/<code>New</code> 进行在线创建会让编辑。</p>
<p>Unreal Engine Wiki 的文档编写规则与组织方式：</p>
<ol>
<li>每个 Wiki 页面是一个独立的 md 文档</li>
<li>使用 categories 进行分类</li>
<li>添加合适的 Tag</li>
<li>通过文档所在的文件夹进行自动分类</li>
<li>指定作者名字以及链接</li>
<li>能够指定文章使用的引擎版本</li>
<li>能够指定自定义导流 / 打赏二维码</li>
<li>能够自定义 copyright 以及备份链接信息</li>
<li>能够控制是否开启评论功能</li>
<li>能够添加外部链接引用</li>
</ol>
<p>可以预览文章效果：<a href="https://ue5wiki.com/wiki/24066/">Profiling for UE</a>，配置模板（在 github 上创建 issue 时会自动创建）：</p>
<figure class="highlight md"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: # 标题</span><br><span class="line">date: 2021-06-29 22:32:01 # 创建时间</span><br><span class="line">toc: true # 开启目录</span><br><span class="line">categories: # 分类，可以指定多个，用于进行目录分类</span><br><span class="line"><span class="bullet">  -</span> 父分类</span><br><span class="line"><span class="bullet">  -</span> 子分类</span><br><span class="line">tag: # 标签可以指定多个（每行一个）</span><br><span class="line"><span class="bullet">  -</span> </span><br><span class="line">comments: true # 开启评论</span><br><span class="line">ue<span class="emphasis">_version: UE4.25 # 文章使用的引擎版本</span></span><br><span class="line"><span class="emphasis">author: # 作者信息，会显示在贡献者列表</span></span><br><span class="line"><span class="emphasis">  name: # 名字</span></span><br><span class="line"><span class="emphasis">  site_</span>addr: # 网站链接</span><br><span class="line">  avatar<span class="emphasis">_image: # 头像图片链接，如果为空则默认使用 github 头像</span></span><br><span class="line"><span class="emphasis">  github_</span>id: # github 账户 ID</span><br><span class="line">  zhihu<span class="emphasis">_addr: # 知乎链接</span></span><br><span class="line"><span class="emphasis">  email: # 邮件地址</span></span><br><span class="line"><span class="emphasis">  wechat_</span>image: # 微信二维码图片地址</span><br><span class="line">postQR:</span><br><span class="line">  enable: false # 开启文章末尾二维码</span><br><span class="line">  image: # 二维码链接</span><br><span class="line">  info: # 显示文字</span><br><span class="line">copyright: # 文章末尾的版权信息</span><br><span class="line"><span class="code">    enable: true</span></span><br><span class="line"><span class="code">    history: true # 是否可查看文章编辑历史、RAW 文本</span></span><br><span class="line"><span class="code">    license: CC BY-NC-SA 4.0 # 文章的授权协议</span></span><br><span class="line"><span class="code">    backupAddr: # 文章的备份链接</span></span><br><span class="line"><span class="code">---</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">&lt;!-- WIKI 内容 --&gt;</span><br></pre></td></tr></table></figure>
<p>注意需要填写贡献者信息（author），如果不指定 <code>avatar_image</code> 图片链接，则会默认获取 github 账户头像。</p>
<p>本站的 Wiki 的文件存储在 <code>source/_posts/</code> 下，Title 为文件名。</p>
<h3 id="插入 b 站视频"><a href="# 插入 b 站视频" class="headerlink" title="插入 b 站视频"></a>插入 b 站视频</h3><p>md 中可以直接插入 html 代码：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;//player.bilibili.com/player.html?aid=583305972&amp;bvid=BV1Tz4y197tR&amp;cid=209073526&amp;page=1&quot;</span> <span class="attr">scrolling</span>=<span class="string">&quot;no&quot;</span> <span class="attr">border</span>=<span class="string">&quot;0&quot;</span> <span class="attr">frameborder</span>=<span class="string">&quot;no&quot;</span> <span class="attr">framespacing</span>=<span class="string">&quot;0&quot;</span> <span class="attr">allowfullscreen</span>=<span class="string">&quot;true&quot;</span>&gt;</span> <span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>但是推荐使用<code>&#123;% bilibili your_video_id %&#125;</code>，能根据屏幕自适应：</p>
<div class="bilibili-video" style="position: relative;width: 100%;height: 0;padding-bottom: 75%;"><iframe frameborder="0" src="https://player.bilibili.com/player.html?bvid=BV1Tz4y197tR&high_quality=1&danmaku=1" style="position: absolute;width: 100%;height: 100%;left: 0;top: 0;"></iframe></div>

<h3 id="内容要求"><a href="# 内容要求" class="headerlink" title="内容要求"></a>内容要求 </h3><p> 需要保证 Wiki 内容在测试环境的准确性，所有内容应该在本地测试通过，不允许提交未被验证的内容。</p>
<script src="https://gist.github.com/imzlp/041c8e006470b2a02a077640bb4baee0.js"></script>

<blockquote>
<p>未完，待补充。</p>
</blockquote>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <tags>
        <tag>Wiki</tag>
      </tags>
  </entry>
  <entry>
    <title>OptimizeCode 代码优化</title>
    <url>/wiki/15647/</url>
    <content><![CDATA[<blockquote>
<p>注意：如果 <strong> 关闭代码优化 </strong> 导致构造对象 Crash（或者 new 走不到对象的构造函数），需要检查项目和插件的代码中是否有重名的类，会导致一些奇怪的问题。<br>在 build.cs 中可以通过 <code>OptimizeCode</code> 来控制是否执行代码优化：  </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">OptimizeCode = CodeOptimization.InShippingBuildsOnly; </span><br></pre></td></tr></table></figure>
<p>有以下几个可选值： </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> CodeOptimization  </span><br><span class="line">&#123; </span><br><span class="line">  Never,  </span><br><span class="line">  InNonDebugBuilds, </span><br><span class="line">  InShippingBuildsOnly, </span><br><span class="line">  Always, </span><br><span class="line">  Default,  </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>当开启优化时，对翻译单元的编译指令参数：  </p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">/Ox </span><br><span class="line">/Ot </span><br><span class="line">/GF </span><br><span class="line">/Zo </span><br></pre></td></tr></table></figure>
<p>并且会使用优化版本的<code>Engine/SharedPCH.Engine.h</code>。  </p>
<p>当关闭优化时的编译指令为： </p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">/Od </span><br></pre></td></tr></table></figure>
<p>会使用非优化版本的<code>Engine/SharedPCH.Engine.NonOptimized.h</code>.  </p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>BuildSystem</category>
        <category>Optimization</category>
      </categories>
      <tags>
        <tag>BuildSystem</tag>
        <tag>Optimization</tag>
      </tags>
  </entry>
  <entry>
    <title>UBT 中 EULA 的内容分发限制</title>
    <url>/wiki/9050/</url>
    <content><![CDATA[<p>UE 的 <a href="https://www.unrealengine.com/en-US/eula">EULA</a> <strong>License Grant/(A)<strong> 中明确说明了，使用 UE 开发并再分发的内容不得包含 </strong> 未 Cook 的源格式 </strong> 和基于 <strong> 引擎工具 </strong> 开发的付费内容，本篇文章研究一下 EULA 里对内容分发的具体内容和从技术上怎么绕过这个限制。</p>
<span id="more"></span>

<blockquote>
<p>There is no restriction on your Distribution of a Product made using the Licensed Technology that does not include any Engine Code or any Paid Content Distributed in uncooked source format (in each case, including as modified by you under the License) and does not require any Licensed Technology (including as modified by you under the License) to run (“Unrestricted Products”). For clarity, the foregoing does not constitute a license under any patents, copyrights, trademarks, trade secrets or other intellectual property rights, whether by implication, estoppel or otherwise.</p>
</blockquote>
<p>而 EULA 中对于 <code>Engine Tools</code> 的定义是：</p>
<blockquote>
<p>“Engine Tools” means (a) editors and other tools included in the Engine Code; (b) any code and modules in either the Developer or Editor folders, including in object code format, whether statically or dynamically linked; and (c) other software that may be used to develop standalone products based on the Licensed Technology.</p>
</blockquote>
<p>这意味着开发者无法在游戏内容中使用 <code>Editor</code> 与<code>Developer</code>下的任何模块。<br>用户协议是具有 <strong> 法律效力 </strong> 的协议文件，我本着要折腾一下的精神并且想顺便看一下 UE 是怎么实现这个限制的，仅作记录分析用，<strong>并不会对内容进行收费的二次分发 </strong> 或用在正式的项目中。我读了一下 UBT 的处理逻辑，UBT 的代码只需要简单地改几处。</p>
<blockquote>
<p>注意：在正式的发行版本中这么做是违反 UE 的 EULA 的，强烈不建议在正式项目中这么做。<br>本文代码和编译均基于 UE_4.18 版本(本地通过源码编译出的引擎)，本文介绍的操作不适用从 EpicLauncher 安装的引擎，文末会写原因。</p>
</blockquote>
<p>在 UE 中，当打包的游戏 (Target is <code>Game</code>) 为<code>Shipping</code>的时候，如果工程中中包含了 <code>Editor</code>/<code>Developer</code> 的模块，会报下列错误：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   ERROR: ERROR: Non-editor build cannot depend on non-redistributable modules. C:\Users\imzlp\Documents\Unreal Projects\EULA418\Binaries\Win64\EULA418-Win64-Shipping.exe depends on <span class="string">&#x27;DesktopPlatform&#x27;</span>.</span><br></pre></td></tr></table></figure>
<p>意思就是 <code>DesktopPlatform</code> 是不可再发行的模块，你不能在 <code>Game</code> 中用，通过查看 UBT 的代码发现这个异常是在 UBT 的 <code>CheckForEULAViolation</code> 中抛出的：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Source/Programs/UnrealBuildTools/Configuration/UEBuildTarget.cs</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckForEULAViolation</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (TargetType != TargetType.Editor &amp;&amp; TargetType != TargetType.Program &amp;&amp; Configuration == UnrealTargetConfiguration.Shipping &amp;&amp;</span><br><span class="line">    Rules.bCheckLicenseViolations)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">bool</span> bLicenseViolation = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (UEBuildBinary Binary <span class="keyword">in</span> AppBinaries)</span><br><span class="line">    &#123;</span><br><span class="line">      List&lt;UEBuildModule&gt; AllDependencies = Binary.GetAllDependencyModules(<span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">      IEnumerable&lt;UEBuildModule&gt; NonRedistModules = AllDependencies.Where((DependencyModule) =&gt;</span><br><span class="line">        !IsRedistributable(DependencyModule) &amp;&amp; DependencyModule.Name != AppName</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (NonRedistModules.Count() != <span class="number">0</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        IEnumerable&lt;UEBuildModule&gt; NonRedistDeps = AllDependencies.Where((DependantModule) =&gt;</span><br><span class="line">          DependantModule.GetDirectDependencyModules().Intersect(NonRedistModules).Any()</span><br><span class="line">        );</span><br><span class="line">        <span class="built_in">string</span> Message = <span class="built_in">string</span>.Format(<span class="string">&quot;Non-editor build cannot depend on non-redistributable modules. &#123;0&#125; depends on &#x27;&#123;1&#125;&#x27;.&quot;</span>, Binary.ToString(), <span class="built_in">string</span>.Join(<span class="string">&quot;&#x27;, &#x27;&quot;</span>, NonRedistModules));</span><br><span class="line">        <span class="keyword">if</span> (NonRedistDeps.Any())</span><br><span class="line">        &#123;</span><br><span class="line">          Message = <span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125;\nDependant modules &#x27;&#123;1&#125;&#x27;&quot;</span>, Message, <span class="built_in">string</span>.Join(<span class="string">&quot;&#x27;, &#x27;&quot;</span>, NonRedistDeps));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(Rules.bBreakBuildOnLicenseViolation)</span><br><span class="line">        &#123;</span><br><span class="line">          Log.TraceError(<span class="string">&quot;ERROR: &#123;0&#125;&quot;</span>, Message);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          Log.TraceWarning(<span class="string">&quot;WARNING: &#123;0&#125;&quot;</span>, Message);</span><br><span class="line">        &#125;</span><br><span class="line">          bLicenseViolation = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Rules.bBreakBuildOnLicenseViolation &amp;&amp; bLicenseViolation)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">&quot;Non-editor build cannot depend on non-redistributable modules.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关键的判断是 <code>IsRedistributable</code> 这个方法(概念等同于 C++ 里的成员函数)：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Source/Programs/UnrealBuildTools/Configuration/UEBuildTarget.cs</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsRedistributable</span><span class="params">(UEBuildModule Module)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(Module.Rules != null &amp;&amp; Module.Rules.IsRedistributableOverride.HasValue)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> Module.Rules.IsRedistributableOverride.Value;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(Module.RulesFile != null)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> !Module.RulesFile.<span class="built_in">IsUnderDirectory</span>(UnrealBuildTool.EngineSourceDeveloperDirectory) &amp;&amp; !Module.RulesFile.<span class="built_in">IsUnderDirectory</span>(UnrealBuildTool.EngineSourceEditorDirectory);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里做的判断是模块是不是属于 <code>Editor</code>/<code>Developer</code> 的，是就返回<code>true</code>，从而进行下面的异常抛出。为了测试我将这里直接修改为<code>return true;</code></p>
<p>只是改了上面之后还是打包不成功，不过现在的错误变成了链接错误。继续看 UBT 的代码后发现还有一个地方对打包是 <code>Shipping</code> 的模式做了判断（前后的 <code>// ...</code> 表示省略了不相关代码）：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Source/Programs/UnrealBuildTools/Configuration/UEBuildTarget.cs</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">AddPrecompiledModules</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="built_in">bool</span> bAllowDeveloperModules = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span>(Configuration != UnrealTargetConfiguration.Shipping)</span><br><span class="line">  &#123;</span><br><span class="line">    Directories.Add(UnrealBuildTool.EngineSourceDeveloperDirectory);</span><br><span class="line">    bAllowDeveloperModules = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Find all the modules that are not part of the standard set</span></span><br><span class="line">  HashSet&lt;<span class="built_in">string</span>&gt; FilteredModuleNames = <span class="keyword">new</span> HashSet&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">  <span class="keyword">foreach</span> (<span class="built_in">string</span> ModuleName <span class="keyword">in</span> ModuleNames)</span><br><span class="line">  &#123;</span><br><span class="line">    FileReference ModuleFileName = RulesAssembly.GetModuleFileName(ModuleName);</span><br><span class="line">    <span class="keyword">if</span> (Directories.Any(x =&gt; ModuleFileName.IsUnderDirectory(x)))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">string</span> RelativeFileName = ModuleFileName.MakeRelativeTo(UnrealBuildTool.EngineSourceDirectory);</span><br><span class="line">      <span class="keyword">if</span> (ExcludeFolders.All(x =&gt; RelativeFileName.IndexOf(x, StringComparison.InvariantCultureIgnoreCase) == <span class="number">-1</span>) &amp;&amp; !PrecompiledModules.Any(x =&gt; x.Name == ModuleName))</span><br><span class="line">      &#123;</span><br><span class="line">        FilteredModuleNames.Add(ModuleName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add all the plugins which aren&#x27;t already being built</span></span><br><span class="line">  <span class="keyword">foreach</span>(UEBuildPlugin PrecompilePlugin <span class="keyword">in</span> PrecompilePlugins)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">foreach</span> (ModuleDescriptor ModuleDescriptor <span class="keyword">in</span> PrecompilePlugin.Descriptor.Modules)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (ModuleDescriptor.IsCompiledInConfiguration(Platform, TargetType, bAllowDeveloperModules &amp;&amp; Rules.bBuildDeveloperTools, Rules.bBuildEditor, Rules.bBuildRequiresCookedData))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">string</span> RelativeFileName = RulesAssembly.GetModuleFileName(ModuleDescriptor.Name).MakeRelativeTo(UnrealBuildTool.EngineDirectory);</span><br><span class="line">        <span class="keyword">if</span> (!ExcludeFolders.Any(x =&gt; RelativeFileName.Contains(x)) &amp;&amp; !PrecompiledModules.Any(x =&gt; x.Name == ModuleDescriptor.Name))</span><br><span class="line">        &#123;</span><br><span class="line">          FilteredModuleNames.Add(ModuleDescriptor.Name);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将上面关于 <code>bAllowDeveloperModules</code> 的部分注释掉，然后直接：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">Directories.Add(UnrealBuildTool.EngineSourceDeveloperDirectory);</span><br><span class="line"><span class="built_in">bool</span> bAllowDeveloperModules=<span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>重新编译 UBT 即可。</p>
<p>然后可以写个简单的例子测试了，比如使用 Developer 下的 <code>DesktopPlatform</code> 来调用系统的选择文件。<br>首先在 <code>*.build.cs</code> 中添加 <code>DesktopPlatform</code> 模块依赖：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">PublicDependencyModuleNames.AddRange(<span class="keyword">new</span> <span class="built_in">string</span>[] &#123; <span class="string">&quot;Core&quot;</span>, <span class="string">&quot;CoreUObject&quot;</span>, <span class="string">&quot;Engine&quot;</span>, <span class="string">&quot;InputCore&quot;</span> ,<span class="string">&quot;DesktopPlatform&quot;</span>&#125;);</span><br><span class="line">PrivateDependencyModuleNames.AddRange(<span class="keyword">new</span> <span class="built_in">string</span>[] &#123; <span class="string">&quot;DesktopPlatform&quot;</span> &#125;);</span><br></pre></td></tr></table></figure>
<p>然后写一个简单的函数暴露给蓝图：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// .h</span></span><br><span class="line"><span class="built_in">UCLASS</span>()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EULA418_API</span> <span class="title">UFileOperatorFlib</span> :</span> <span class="keyword">public</span> UBlueprintFunctionLibrary</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UFUNCTION</span>(BlueprintCallable)</span><br><span class="line">    <span class="function"><span class="keyword">static</span> FString <span class="title">ExtendGetOpenFileName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// .cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;FileOperatorFlib.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Developer/DesktopPlatform/Public/DesktopPlatformModule.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Paths.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">FString <span class="title">UFileOperatorFlib::ExtendGetOpenFileName</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  IDesktopPlatform* DesktopPlatform = FDesktopPlatformModule::<span class="built_in">Get</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (DesktopPlatform)</span><br><span class="line">  &#123;</span><br><span class="line">    TArray&lt;FString&gt; OpenFilenames;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> bOpened = DesktopPlatform-&gt;<span class="built_in">OpenFileDialog</span>(</span><br><span class="line">      <span class="literal">nullptr</span>,</span><br><span class="line">      <span class="built_in">TEXT</span>(<span class="string">&quot;OpenFileDialog&quot;</span>),</span><br><span class="line">      <span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>)),</span><br><span class="line">      <span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>),</span><br><span class="line">      <span class="built_in">TEXT</span>(<span class="string">&quot;All Files (*.*)&quot;</span>),</span><br><span class="line">      EFileDialogFlags::None,</span><br><span class="line">      OpenFilenames</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (OpenFilenames.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> FPaths::<span class="built_in">ConvertRelativePathToFull</span>(OpenFilenames[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>正常的情况下，将上面的代码打包 Shipping 会产生文章最开始的错误，但是我们改过之后可以打包成功并且可以正确执行，这个简单的工程和打包的内容可以在 <a href="https://stusdnueducn-my.sharepoint.com/:f:/g/personal/2017020625_stu_sdnu_edu_cn/EsWiScEXarZNmEOWXSHcGLEBVE00xqNH7eT9Pyp_6xtlRA?e=ZH4XAo"> 这里 </a> 下载。<br>启动之后按下数字键 <code>1</code>(不是<code>Num 1</code>) 即可打开 windows 的选择文件窗口，选择之后会将选择的文件的路径显示到屏幕上。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9050/EULA418-00.webp"><br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9050/EULA418-01.webp"></p>
<blockquote>
<p>注意：需要使用源码版引擎编译项目，如果编译时具有 <code>noexcept</code> 的错误，则可以在项目的 <code>*.target.cs</code> 中添加 <code>bForceEnableExceptions = true;</code>。<br> 重新编译项目会编译引擎内的模块(打开从 EpicLauncher 安装的引擎文件夹就可以知道，默认 Editor/Developer 的模块是没有编译出静态链接库的，这也是不能用从 EpicLauncher 安装的引擎来执行本文的操作的原因)。</p>
</blockquote>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>BuildSystem</category>
      </categories>
      <tags>
        <tag>BuildSystem</tag>
        <tag>EULA</tag>
        <tag>UBT</tag>
      </tags>
  </entry>
  <entry>
    <title>UBT 中定义的 C++ 宏</title>
    <url>/wiki/5214/</url>
    <content><![CDATA[<p>UE4 引擎里面定义了很多引擎中的宏和一些处理逻辑，如 <code>WITH_ENGINE</code>/<code>WITH_EDITOR</code> 等，它们部分是 UBT 通过读取 <code>*.target.cs</code> 文件中的配置来定义的，有些逻辑是通过读取 <code>*.Build.cs</code> 的配置处理的。<br>我读了一下 UBT 的代码，抽出来部分 UBT 中配置文件 (<code>Target.cs</code>/<code>Build.cs</code>) 参数与 MACRO 的相互定义，作为速查手册。<br><code>*.Target.cs</code>的参数可以看：<a href="https://docs.unrealengine.com/en-US/Programming/BuildTools/UnrealBuildTool/TargetFiles/index.html">UnrealBuildSystem/Targets</a><br><code>*.Build.cs</code>的参数可以看：<a href="https://docs.unrealengine.com/en-US/Programming/BuildTools/UnrealBuildTool/ModuleFiles/index.html">UnrealBuildSystem/ModuleFiles</a><br>UE 的构建系统文档：<a href="https://docs.unrealengine.com/en-US/Programming/BuildTools/index.html">Build Tools</a></p>
<span id="more"></span>

<h3 id="IS-PROGRAM"><a href="#IS-PROGRAM" class="headerlink" title="IS_PROGRAM"></a>IS_PROGRAM</h3><ul>
<li>(TargetType) Target.Program</li>
</ul>
<blockquote>
<p>Type (TargetType): The type of target.</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line">GlobalCompileEnvironment.Definitions.Add(String.Format(<span class="string">&quot;IS_PROGRAM=&#123;0&#125;&quot;</span>, TargetType == TargetType.Program ? <span class="string">&quot;1&quot;</span> : <span class="string">&quot;0&quot;</span>));</span><br></pre></td></tr></table></figure>
<h3 id="ENABLE-PGO-PROFILE"><a href="#ENABLE-PGO-PROFILE" class="headerlink" title="ENABLE_PGO_PROFILE"></a>ENABLE_PGO_PROFILE</h3><ul>
<li>(bool) bPGOProfile</li>
</ul>
<blockquote>
<p>Whether to enable Profile Guided Optimization (PGO) instrumentation in this build.</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Rules.bPGOProfile)</span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;ENABLE_PGO_PROFILE=1&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;ENABLE_PGO_PROFILE=0&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ENGINE-BASE-DIR-ADJUST"><a href="#ENGINE-BASE-DIR-ADJUST" class="headerlink" title="ENGINE_BASE_DIR_ADJUST"></a>ENGINE_BASE_DIR_ADJUST</h3><ul>
<li>(String) ExeBinariesSubFolder</li>
</ul>
<blockquote>
<p>Subfolder to place executables in, relative to the default location.</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!String.IsNullOrEmpty(Rules.ExeBinariesSubFolder))</span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(String.Format(<span class="string">&quot;ENGINE_BASE_DIR_ADJUST=&#123;0&#125;&quot;</span>, Rules.ExeBinariesSubFolder.Replace(<span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).Trim(<span class="string">&#x27;/&#x27;</span>).Count(x =&gt; x == <span class="string">&#x27;/&#x27;</span>) + <span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="WITH-DEV-AUTOMATION-TESTS"><a href="#WITH-DEV-AUTOMATION-TESTS" class="headerlink" title="WITH_DEV_AUTOMATION_TESTS"></a>WITH_DEV_AUTOMATION_TESTS</h3><ul>
<li>(bool) bForceCompileDevelopmentAutomationTests</li>
</ul>
<blockquote>
<p>Whether to compile development automation tests.</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Rules.bForceCompileDevelopmentAutomationTests)</span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;WITH_DEV_AUTOMATION_TESTS=1&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span>(Configuration)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> UnrealTargetConfiguration.Test:</span><br><span class="line">		<span class="keyword">case</span> UnrealTargetConfiguration.Shipping:</span><br><span class="line">				GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;WITH_DEV_AUTOMATION_TESTS=0&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		<span class="literal">default</span>:</span><br><span class="line">				GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;WITH_DEV_AUTOMATION_TESTS=1&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="WITH-PERF-AUTOMATION-TESTS"><a href="#WITH-PERF-AUTOMATION-TESTS" class="headerlink" title="WITH_PERF_AUTOMATION_TESTS"></a>WITH_PERF_AUTOMATION_TESTS</h3><ul>
<li>(bool) bForceCompilePerformanceAutomationTests</li>
</ul>
<blockquote>
<p>Whether to compile performance automation tests.</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Rules.bForceCompilePerformanceAutomationTests)</span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;WITH_PERF_AUTOMATION_TESTS=1&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">switch</span> (Configuration)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> UnrealTargetConfiguration.Shipping:</span><br><span class="line">			GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;WITH_PERF_AUTOMATION_TESTS=0&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="literal">default</span>:</span><br><span class="line">			GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;WITH_PERF_AUTOMATION_TESTS=1&quot;</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="IS-MONOLITHIC"><a href="#IS-MONOLITHIC" class="headerlink" title="IS_MONOLITHIC"></a>IS_MONOLITHIC</h3><ul>
<li>(TargetLinkType) LinkType</li>
</ul>
<blockquote>
<p><strong>Monolithic Mode</strong>, which puts all code together in a single executable file.<a href="https://docs.unrealengine.com/en-US/Programming/Modules/API">Module API Specifiers</a></p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">bCompileMonolithic = (Rules.LinkType == TargetLinkType.Monolithic);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... </span></span><br><span class="line">GlobalCompileEnvironment.Definitions.Add(String.Format(<span class="string">&quot;IS_MONOLITHIC=&#123;0&#125;&quot;</span>, ShouldCompileMonolithic() ? <span class="string">&quot;1&quot;</span> : <span class="string">&quot;0&quot;</span>));</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>


<h3 id="WITH-ENGINE"><a href="#WITH-ENGINE" class="headerlink" title="WITH_ENGINE"></a>WITH_ENGINE</h3><ul>
<li>(bool) bCompileAgainstEngine</li>
</ul>
<blockquote>
<p>Enabled for all builds that include the engine project. Disabled only when building standalone apps that only link with Core.</p>
</blockquote>
<h4 id="WITH-UNREAL-DEVELOPER-TOOLS"><a href="#WITH-UNREAL-DEVELOPER-TOOLS" class="headerlink" title="WITH_UNREAL_DEVELOPER_TOOLS"></a>WITH_UNREAL_DEVELOPER_TOOLS</h4><ul>
<li>bBuildDeveloperTools</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Rules.bCompileAgainstEngine)</span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;WITH_ENGINE=1&quot;</span>);</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(</span><br><span class="line">		String.Format(<span class="string">&quot;WITH_UNREAL_DEVELOPER_TOOLS=&#123;0&#125;&quot;</span>, Rules.bBuildDeveloperTools ? <span class="string">&quot;1&quot;</span> : <span class="string">&quot;0&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;WITH_ENGINE=0&quot;</span>);</span><br><span class="line">	<span class="comment">// Can&#x27;t have developer tools w/out engine</span></span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;WITH_UNREAL_DEVELOPER_TOOLS=0&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="WITH-COREUOBJECT"><a href="#WITH-COREUOBJECT" class="headerlink" title="WITH_COREUOBJECT"></a>WITH_COREUOBJECT</h3><ul>
<li>(bool)bCompileAgainstCoreUObject</li>
</ul>
<blockquote>
<p>Enabled for all builds that include the CoreUObject project. Disabled only when building standalone apps that only link with Core.</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Rules.bCompileAgainstCoreUObject)</span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;WITH_COREUOBJECT=1&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;WITH_COREUOBJECT=0&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="USE-STATS-WITHOUT-ENGINE"><a href="#USE-STATS-WITHOUT-ENGINE" class="headerlink" title="USE_STATS_WITHOUT_ENGINE"></a>USE_STATS_WITHOUT_ENGINE</h3><ul>
<li>(bool) bCompileWithStatsWithoutEngine</li>
</ul>
<blockquote>
<p>Whether to include stats support even without the engine.</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Rules.bCompileWithStatsWithoutEngine)</span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;USE_STATS_WITHOUT_ENGINE=1&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;USE_STATS_WITHOUT_ENGINE=0&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="WITH-PLUGIN-SUPPORT"><a href="#WITH-PLUGIN-SUPPORT" class="headerlink" title="WITH_PLUGIN_SUPPORT"></a>WITH_PLUGIN_SUPPORT</h3><ul>
<li>(bool) bCompileWithPluginSupport</li>
</ul>
<blockquote>
<p>Whether to include plugin support.</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Rules.bCompileWithPluginSupport)</span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;WITH_PLUGIN_SUPPORT=1&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;WITH_PLUGIN_SUPPORT=0&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="WITH-PERFCOUNTERS"><a href="#WITH-PERFCOUNTERS" class="headerlink" title="WITH_PERFCOUNTERS"></a>WITH_PERFCOUNTERS</h3><ul>
<li>(bool) bWithPerfCounters</li>
</ul>
<blockquote>
<p>Whether to include PerfCounters support.</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Rules.bWithPerfCounters)</span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;WITH_PERFCOUNTERS=1&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;WITH_PERFCOUNTERS=0&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="USE-LOGGING-IN-SHIPPING"><a href="#USE-LOGGING-IN-SHIPPING" class="headerlink" title="USE_LOGGING_IN_SHIPPING"></a>USE_LOGGING_IN_SHIPPING</h3><ul>
<li>(bool) bUseLoggingInShipping</li>
</ul>
<blockquote>
<p>Whether to turn on logging for test/shipping builds.</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Rules.bUseLoggingInShipping)</span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;USE_LOGGING_IN_SHIPPING=1&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;USE_LOGGING_IN_SHIPPING=0&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="WITH-LOGGING-TO-MEMORY"><a href="#WITH-LOGGING-TO-MEMORY" class="headerlink" title="WITH_LOGGING_TO_MEMORY"></a>WITH_LOGGING_TO_MEMORY</h3><ul>
<li>(bool) bLoggingToMemoryEnabled</li>
</ul>
<blockquote>
<p>Whether to turn on logging to memory for test/shipping builds.</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Rules.bLoggingToMemoryEnabled)</span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;WITH_LOGGING_TO_MEMORY=1&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;WITH_LOGGING_TO_MEMORY=0&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="USE-CACHE-FREED-OS-ALLOCS"><a href="#USE-CACHE-FREED-OS-ALLOCS" class="headerlink" title="USE_CACHE_FREED_OS_ALLOCS"></a>USE_CACHE_FREED_OS_ALLOCS</h3><ul>
<li>(bool) bUseCacheFreedOSAllocs</li>
</ul>
<blockquote>
<p>Whether to turn on logging to memory for test/shipping builds.</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Rules.bUseCacheFreedOSAllocs)</span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;USE_CACHE_FREED_OS_ALLOCS=1&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;USE_CACHE_FREED_OS_ALLOCS=0&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="USE-CHECKS-IN-SHIPPING"><a href="#USE-CHECKS-IN-SHIPPING" class="headerlink" title="USE_CHECKS_IN_SHIPPING"></a>USE_CHECKS_IN_SHIPPING</h3><ul>
<li>(bool) bUseChecksInShipping</li>
</ul>
<blockquote>
<p>Whether to turn on checks (asserts) for test/shipping builds.</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Rules.bUseChecksInShipping)</span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;USE_CHECKS_IN_SHIPPING=1&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;USE_CHECKS_IN_SHIPPING=0&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="UE-BUILD-MINIMAL"><a href="#UE-BUILD-MINIMAL" class="headerlink" title="UE_BUILD_MINIMAL"></a>UE_BUILD_MINIMAL</h3><ul>
<li>(bool) bCompileLeanAndMeanUE</li>
</ul>
<blockquote>
<p>Whether to compile lean and mean version of UE.</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Propagate whether we want a lean and mean build to the C++ code.</span></span><br><span class="line"><span class="keyword">if</span> (Rules.bCompileLeanAndMeanUE)</span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;UE_BUILD_MINIMAL=1&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;UE_BUILD_MINIMAL=0&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="WITH-EDITOR"><a href="#WITH-EDITOR" class="headerlink" title="WITH_EDITOR"></a>WITH_EDITOR</h3><ul>
<li>(bool) bBuildEditor</li>
</ul>
<blockquote>
<p>Whether to compile the editor or not. Only desktop platforms (Windows or Mac) will use this, other platforms force this to false.</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// bBuildEditor has now been set appropriately for all platforms, so this is here to make sure the #define </span></span><br><span class="line"><span class="keyword">if</span> (Rules.bBuildEditor)</span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;WITH_EDITOR=1&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (!GlobalCompileEnvironment.Definitions.Contains(<span class="string">&quot;WITH_EDITOR=0&quot;</span>))</span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;WITH_EDITOR=0&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="WITH-EDITORONLY-DATA"><a href="#WITH-EDITORONLY-DATA" class="headerlink" title="WITH_EDITORONLY_DATA"></a>WITH_EDITORONLY_DATA</h3><ul>
<li>(bool) bBuildWithEditorOnlyData</li>
</ul>
<blockquote>
<p>Whether to compile WITH_EDITORONLY_DATA disabled. Only Windows will use this, other platforms force this to false.</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Rules.bBuildWithEditorOnlyData == <span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;WITH_EDITORONLY_DATA=0&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="WITH-SERVER-CODE"><a href="#WITH-SERVER-CODE" class="headerlink" title="WITH_SERVER_CODE"></a>WITH_SERVER_CODE</h3><ul>
<li>(bool) bWithServerCode</li>
</ul>
<blockquote>
<p>Compile server-only code.</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Check if server-only code should be compiled out.</span></span><br><span class="line"><span class="keyword">if</span> (Rules.bWithServerCode == <span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;WITH_SERVER_CODE=1&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;WITH_SERVER_CODE=0&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="WITH-CEF3"><a href="#WITH-CEF3" class="headerlink" title="WITH_CEF3"></a>WITH_CEF3</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Set the define for whether we&#x27;re compiling with CEF3</span></span><br><span class="line"><span class="keyword">if</span> (Rules.bCompileCEF3 &amp;&amp; (Platform == UnrealTargetPlatform.Win32 || Platform == UnrealTargetPlatform.Win64 || Platform == UnrealTargetPlatform.Mac || Platform == UnrealTargetPlatform.Linux))</span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;WITH_CEF3=1&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;WITH_CEF3=0&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="WITH-XGE-CONTROLLER"><a href="#WITH-XGE-CONTROLLER" class="headerlink" title="WITH_XGE_CONTROLLER"></a>WITH_XGE_CONTROLLER</h3><ul>
<li>bUseXGEController</li>
<li>TargetType.Editor &amp;&amp; UnrealTargetPlatform is Win32/Win64</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Rules.bUseXGEController &amp;&amp;</span><br><span class="line">	Rules.Type == TargetType.Editor &amp;&amp;</span><br><span class="line">	(Platform == UnrealTargetPlatform.Win32 || Platform == UnrealTargetPlatform.Win64))</span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;WITH_XGE_CONTROLLER=1&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;WITH_XGE_CONTROLLER=0&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="UBT-MODULE-MANIFEST"><a href="#UBT-MODULE-MANIFEST" class="headerlink" title="UBT_MODULE_MANIFEST"></a>UBT_MODULE_MANIFEST</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">GlobalCompileEnvironment.Definitions.Add(String.Format(<span class="string">&quot;UBT_MODULE_MANIFEST=\&quot;&#123;0&#125;\&quot;&quot;</span>, ModuleManifest.GetStandardFileName(AppName, Platform, Configuration, Architecture, <span class="literal">false</span>)));</span><br></pre></td></tr></table></figure>

<h3 id="UBT-MODULE-MANIFEST-DEBUGGAME"><a href="#UBT-MODULE-MANIFEST-DEBUGGAME" class="headerlink" title="UBT_MODULE_MANIFEST_DEBUGGAME"></a>UBT_MODULE_MANIFEST_DEBUGGAME</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line">GlobalCompileEnvironment.Definitions.Add(String.Format(<span class="string">&quot;UBT_MODULE_MANIFEST_DEBUGGAME=\&quot;&#123;0&#125;\&quot;&quot;</span>, ModuleManifest.GetStandardFileName(AppName, Platform, UnrealTargetConfiguration.DebugGame, Architecture, <span class="literal">true</span>)));</span><br></pre></td></tr></table></figure>

<h3 id="UBT-COMPILED-PLATFORM"><a href="#UBT-COMPILED-PLATFORM" class="headerlink" title="UBT_COMPILED_PLATFORM"></a>UBT_COMPILED_PLATFORM</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">UEBuildTarget</span>(<span class="params">SerializationInfo Info, StreamingContext Context</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	Platform = (UnrealTargetPlatform)Info.GetInt32(<span class="string">&quot;pl&quot;</span>);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;UBT_COMPILED_PLATFORM=&quot;</span> + Platform.ToString());</span><br></pre></td></tr></table></figure>

<h3 id="UBT-COMPILED-TARGET"><a href="#UBT-COMPILED-TARGET" class="headerlink" title="UBT_COMPILED_TARGET"></a>UBT_COMPILED_TARGET</h3><ul>
<li>TargetType</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line">GlobalCompileEnvironment.Definitions.Add(<span class="string">&quot;UBT_COMPILED_TARGET=&quot;</span> + TargetType.ToString());</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="WITH-PHYSX"><a href="#WITH-PHYSX" class="headerlink" title="WITH_PHYSX"></a>WITH_PHYSX</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">bool</span>) bCompilePhysX</span><br><span class="line"></span><br><span class="line">&gt;Whether to include PhysX support.</span><br><span class="line"></span><br><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/ModuleRules.cs</span></span><br><span class="line"><span class="comment">// SetupModulePhysXAPEXSupport(ReadOnlyTargetRules Target)</span></span><br><span class="line"><span class="comment">// definitions used outside of PhysX/APEX need to be set here, not in PhysX.Build.cs or APEX.Build.cs, </span></span><br><span class="line"><span class="comment">// since we need to make sure we always set it, even to 0 (because these are Private dependencies, the</span></span><br><span class="line"><span class="comment">// defines inside their Build.cs files won&#x27;t leak out)</span></span><br><span class="line"><span class="keyword">if</span> (Target.bCompilePhysX == <span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">	PrivateDependencyModuleNames.Add(<span class="string">&quot;PhysX&quot;</span>);</span><br><span class="line">	PublicDefinitions.Add(<span class="string">&quot;WITH_PHYSX=1&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	PublicDefinitions.Add(<span class="string">&quot;WITH_PHYSX=0&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="WITH-APEX"><a href="#WITH-APEX" class="headerlink" title="WITH_APEX"></a>WITH_APEX</h3><blockquote>
<p>Whether to include PhysX APEX support.</p>
</blockquote>
<h4 id="WITH-APEX-CLOTHING"><a href="#WITH-APEX-CLOTHING" class="headerlink" title="WITH_APEX_CLOTHING"></a>WITH_APEX_CLOTHING</h4><h4 id="WITH-CLOTH-COLLISION-DETECTION"><a href="#WITH-CLOTH-COLLISION-DETECTION" class="headerlink" title="WITH_CLOTH_COLLISION_DETECTION"></a>WITH_CLOTH_COLLISION_DETECTION</h4><h4 id="WITH-PHYSX-COOKING"><a href="#WITH-PHYSX-COOKING" class="headerlink" title="WITH_PHYSX_COOKING"></a>WITH_PHYSX_COOKING</h4><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/ModuleRules.cs</span></span><br><span class="line"><span class="comment">// SetupModulePhysXAPEXSupport(ReadOnlyTargetRules Target)</span></span><br><span class="line"><span class="keyword">if</span> (Target.bCompileAPEX == <span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (!Target.bCompilePhysX)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">&quot;APEX is enabled, without PhysX. This is not supported!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	PrivateDependencyModuleNames.Add(<span class="string">&quot;APEX&quot;</span>);</span><br><span class="line">	PublicDefinitions.Add(<span class="string">&quot;WITH_APEX=1&quot;</span>);</span><br><span class="line">	PublicDefinitions.Add(<span class="string">&quot;WITH_APEX_CLOTHING=1&quot;</span>);</span><br><span class="line">	PublicDefinitions.Add(<span class="string">&quot;WITH_CLOTH_COLLISION_DETECTION=1&quot;</span>);</span><br><span class="line">	PublicDefinitions.Add(<span class="string">&quot;WITH_PHYSX_COOKING=1&quot;</span>);  <span class="comment">// APEX currently relies on cooking even at runtime</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	PublicDefinitions.Add(<span class="string">&quot;WITH_APEX=0&quot;</span>);</span><br><span class="line">	PublicDefinitions.Add(<span class="string">&quot;WITH_APEX_CLOTHING=0&quot;</span>);</span><br><span class="line">	PublicDefinitions.Add(<span class="string">&quot;WITH_CLOTH_COLLISION_DETECTION=0&quot;</span>);</span><br><span class="line">	PublicDefinitions.Add(<span class="built_in">string</span>.Format(<span class="string">&quot;WITH_PHYSX_COOKING=&#123;0&#125;&quot;</span>, Target.bBuildEditor &amp;&amp; Target.bCompilePhysX ? <span class="number">1</span> : <span class="number">0</span>));  <span class="comment">// without APEX, we only need cooking in editor builds</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="WITH-NVCLOTH"><a href="#WITH-NVCLOTH" class="headerlink" title="WITH_NVCLOTH"></a>WITH_NVCLOTH</h3><ul>
<li>(bool) bCompileNvCloth</li>
</ul>
<blockquote>
<p>Whether to include NvCloth.</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/ModuleRules.cs</span></span><br><span class="line"><span class="comment">// SetupModulePhysXAPEXSupport(ReadOnlyTargetRules Target)</span></span><br><span class="line"><span class="keyword">if</span> (Target.bCompileNvCloth == <span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (!Target.bCompilePhysX)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">&quot;NvCloth is enabled, without PhysX. This is not supported!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	PrivateDependencyModuleNames.Add(<span class="string">&quot;NvCloth&quot;</span>);</span><br><span class="line">                PublicDefinitions.Add(<span class="string">&quot;WITH_NVCLOTH=1&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	PublicDefinitions.Add(<span class="string">&quot;WITH_NVCLOTH=0&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="bUsesSlate"><a href="#bUsesSlate" class="headerlink" title="bUsesSlate"></a>bUsesSlate</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Configuration/UEBuildTargets.cs</span></span><br><span class="line"><span class="comment">// void PrepareReceipts(UEToolChain ToolChain, List&lt;KeyValuePair&lt;FileReference, BuildProductType&gt;&gt; BuildProducts, List&lt;KeyValuePair&lt;FileReference, BuildProductType&gt;&gt; PrecompileOnlyBuildProducts, EHotReload HotReload)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Rules.bUsesSlate)</span><br><span class="line">&#123;</span><br><span class="line">	AddRuntimeDependenciesFromDir(DirectoryReference.Combine(UnrealBuildTool.EngineDirectory, <span class="string">&quot;Content&quot;</span>, <span class="string">&quot;Slate&quot;</span>), StagedFileType.UFS);</span><br><span class="line">	AddRuntimeDependenciesFromDir(DirectoryReference.Combine(UnrealBuildTool.EngineDirectory, <span class="string">&quot;Content&quot;</span>, <span class="string">&quot;SlateDebug&quot;</span>), StagedFileType.UFS);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ProjectFile != <span class="literal">null</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		AddRuntimeDependenciesFromDir(DirectoryReference.Combine(ProjectDirectory, <span class="string">&quot;Content&quot;</span>, <span class="string">&quot;Slate&quot;</span>), StagedFileType.UFS);</span><br><span class="line">		AddRuntimeDependenciesFromDir(DirectoryReference.Combine(ProjectDirectory, <span class="string">&quot;Content&quot;</span>, <span class="string">&quot;SlateDebug&quot;</span>), StagedFileType.UFS);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="bIsBuildingConsoleApplication"><a href="#bIsBuildingConsoleApplication" class="headerlink" title="bIsBuildingConsoleApplication"></a>bIsBuildingConsoleApplication</h3><blockquote>
<p>True if this is a console application that’s being built.</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealBuildTool/Platform/Windows/VCToolChains.cs</span></span><br><span class="line"><span class="comment">// void AppendLibArguments(LinkEnvironment LinkEnvironment, List&lt;string&gt; Arguments)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AppendLibArguments</span>(<span class="params">LinkEnvironment LinkEnvironment, List&lt;<span class="built_in">string</span>&gt; Arguments</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Prevents the linker from displaying its logo for each invocation.</span></span><br><span class="line">	Arguments.Add(<span class="string">&quot;/NOLOGO&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Prompt the user before reporting internal errors to Microsoft.</span></span><br><span class="line">	Arguments.Add(<span class="string">&quot;/errorReport:prompt&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//	PC</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="keyword">if</span> (LinkEnvironment.Platform == CppPlatform.Win32 || LinkEnvironment.Platform == CppPlatform.Win64)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Set machine type/ architecture to be 64 bit.</span></span><br><span class="line">		<span class="keyword">if</span> (LinkEnvironment.Platform == CppPlatform.Win64)</span><br><span class="line">		&#123;</span><br><span class="line">			Arguments.Add(<span class="string">&quot;/MACHINE:x64&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 32 bit executable/ target.</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			Arguments.Add(<span class="string">&quot;/MACHINE:x86&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (LinkEnvironment.bIsBuildingConsoleApplication)</span><br><span class="line">			&#123;</span><br><span class="line">				Arguments.Add(<span class="string">&quot;/SUBSYSTEM:CONSOLE&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				Arguments.Add(<span class="string">&quot;/SUBSYSTEM:WINDOWS&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//	Shipping &amp; LTCG</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="keyword">if</span> (LinkEnvironment.Configuration == CppConfiguration.Shipping)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Use link-time code generation.</span></span><br><span class="line">		Arguments.Add(<span class="string">&quot;/LTCG&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>BuildSystem</category>
      </categories>
      <tags>
        <tag>BuildSystem</tag>
        <tag>UBT</tag>
      </tags>
  </entry>
  <entry>
    <title>UE4 编译代码的真正命令参数</title>
    <url>/wiki/15960/</url>
    <content><![CDATA[<p>在之前的文章 <a href="https://imzlp.com/posts/6362/">Build flow of the Unreal Engine4 project</a> 中有提到，UE 编译模块的时候会执行到 <code>ExecuteActions</code> 中。<br>那么 UE 真正编译每个翻译单元的编译器参数是什么呢？<br>在 UBT 调用 ExecuteAction 之前，会完成所有编译参数的拼接和预处理。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ExecuteAction</span><span class="params">(ManagedProcessGroup ProcessGroup, BuildAction Action, List CompletedActions, AutoResetEvent CompletedEvent)</span></span></span><br></pre></td></tr></table></figure>
<p>在 Win 上是通过调用 <code>cl-filter.exe</code> 来执行的，而如何把代码和编译参数喂给编译器呢？<br>UE 是通过生成了一个 <code>.cpp.obj.response</code> 来记录当前编译单元的信息的，包含编译器参数和包含目录 / 输出等等。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201217202145.webp"></p>
<p>该文件在生成位置在模块的 Intermediate 目录下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Intermediate\Build\Win64\UE4Editor\Development\HotPatcherRuntime\FlibPakReader.cpp.obj.response</span><br></pre></td></tr></table></figure>
<p>文件内容太长，可以下载该文件查看：<a href="https://imzlp.com/notes/UE4/ubt/FlibPakReader.cpp.obj.response">FlibPakReader.cpp.obj.response</a></p>
<p>可以使用手动调用 <code>cl.exe</code> 的方式来执行测试：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cl.exe @CPP_OBJ_RESPONSE_PATH //showIncludes</span><br><span class="line">// <span class="string">&quot;C:\Program Files (x86)\Microsoft Visual Studio\2019\Professional\VC\Tools\MSVC\14.27.29110\bin\HostX64\x64\cl.exe&quot;</span>  @<span class="string">&quot;C:\BuildAgent\workspace\PackageWindows\Client\Plugins\UnLua\Intermediate\Build\Win64\UE4\Development\LuaProtobuf\Module.LuaProtobuf.cpp.obj.response&quot;</span> /showIncludes</span><br></pre></td></tr></table></figure>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/16082078824716.webp"></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>BuildSystem</category>
      </categories>
      <tags>
        <tag>BuildSystem</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 构建系统：Target 和 Module</title>
    <url>/wiki/16643/</url>
    <content><![CDATA[<p>Module 是构成 Unreal 的基本元素，每一个 Module 封装和实现了一组功能，并且可以供其他的 Module 使用，整个 Unreal Engine 就是靠各个 Module 组合驱动的，连我们创建的游戏项目本身，都是一个单独的 Module。</p>
<p>那么 UE 又是怎么创建和构建这这些 Module 的呢？这是写这篇文章的主要目的，研究一下 Unreal 的构建系统以及它们 (Target 和 Module) 支持的各种属性。</p>
<p>建议在看这篇文章之前先看一下我之前的这篇文章：<a href="https://imzlp.com/posts/6362/">Build flow of the Unreal Engine4 project</a>，主要内容是大致过一遍 UE 的构建流程，本篇文章只是 UE 构建系统中的一环。</p>
<span id="more"></span>
<p>对于 UE 项目比较熟悉的都知道，当使用 UE 创建一个 C++ 游戏项目时，会在项目路径下创建 <code>Source</code> 文件夹，默认包含了下列文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Example\GWorld\Source&gt;tree /a /f</span><br><span class="line">|   GWorld.Target.cs</span><br><span class="line">|   GWorldEditor.Target.cs</span><br><span class="line">|</span><br><span class="line">\---GWorld</span><br><span class="line">        GWorld.Build.cs</span><br><span class="line">        GWorld.cpp</span><br><span class="line">        GWorld.h</span><br><span class="line">        GWorldGameModeBase.cpp</span><br><span class="line">        GWorldGameModeBase.h</span><br></pre></td></tr></table></figure>
<p>其中，<code>*.Target.cs</code>与 <code>*.Build.cs</code> 是 Unreal 构建系统的实际控制者，UBT 通过扫描这两个文件来确定整个编译环境，它们也是本篇文章研究的重点。<br>它们的职责各不相同：</p>
<ul>
<li><code>*.Target.cs</code>控制的是生成的可执行程序的外部编译环境，就是所谓的<strong>Target</strong>。比如，生成的是什么<code>Type</code>(Game/Client/Server/Editor/Program)，开不开启 RTTI(<code>bForceEnableRTTI</code>)，CRT 使用什么方式链接(<code>bUseStaticCRT</code>) 等等。</li>
<li><code>*.Build.cs</code>控制的是 Module 编译过程，由它来控制所属 Module 的对其他 Module 的依赖、文件包含、链接、宏定义等等相关的操作，<code>*.Build.cs</code>告诉 UE 的构建系统，它是一个 Module，并且编译的时候要做哪些事情。</li>
</ul>
<p>以一言以蔽之：与外部编译环境相关的都归 <code>*.target.cs</code> 管，与 Module 自身相关的都归 <code>*.build.cs</code> 管。</p>
<p>插个题外话，在 <code>GWorld.h</code> 和<code>GWorld.cpp</code>中定义的是 Module 真正的执行逻辑，使用 <code>IMPLEMENT_MODULE</code> 定义。UE 中所有的 Module 都是继承自<code>IModuleInterface</code>，具有以下接口：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IModuleInterface</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">IModuleInterface</span>();</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">StartupModule</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PreUnloadCallback</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PostLoadCallback</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ShutdownModule</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">SupportsDynamicReloading</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">SupportsAutomaticShutdown</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">IsGameModule</span><span class="params">()</span></span>; <span class="keyword">const</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>通过 <code>IModuleInterface</code> 来驱动 Module 的启动与关闭，不过一般 <code>Game Module</code> 不使用这个控制游戏流程。<br>这部分的详细内容可以看我之前的文章：<a href="https://imzlp.com/posts/24007/">UE4 Modules:Load and Startup</a></p>
<h2 id="Target"><a href="#Target" class="headerlink" title="Target"></a>Target</h2><p>每一个基于 Unreal 的项目，都有一个 <code>Tergat.cs</code>，具有一个继承自<code>TargetRules</code> 的类定义；并且默认需要关联着一个同名 (非必要，但建议) 的<code>Module</code>的定义，否则编译时会有 Module 未定义错误，它的含意时将指定的 <code>Module</code> 编译到 <code>Target</code> 中：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UnrealBuildTool : error : Could not find definition for module &#x27;GWorld&#x27; (referenced via GWorld.Target.cs)</span><br></pre></td></tr></table></figure>
<p>与 <code>Target</code> 关联的 <code>Module</code> 的名字可以通过 <code>ExtraModuleNames</code> 来指定：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GWorldTarget</span> : <span class="title">TargetRules</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">GWorldTarget</span>(<span class="params">TargetInfo Target</span>) : <span class="title">base</span>(<span class="params">Target</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    Type = TargetType.Game;</span><br><span class="line">    ExtraModuleNames.AddRange(<span class="keyword">new</span> <span class="built_in">string</span>[] &#123; <span class="string">&quot;GWorld&quot;</span> &#125; );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面指定的是 <code>GWorld</code>，UBT 解析的时候就会去找<code>GWorld</code> 这个 Module 的定义，也就是 <code>GWorld.build.cs</code> 这个文件中的 <code>GWorld</code> 类定义，如果没有就会产生上面的 Module 未定义错误。</p>
<blockquote>
<p>注意，与 <code>Target</code> 关联的 <code>Module</code> 不仅仅只是一个指定的名字这么简单，所有代码中使用的 <code>XXXX_API</code> 都是与 <code>Module</code> 的名字相关的。</p>
</blockquote>
<p>如果我进行以下改动：<code>ExtraModuleNames.AddRange(new string[] &#123; &quot;GWorldAAA&quot; &#125; );</code>，那么需要对项目中所有的源文件进行的改动有：</p>
<ol>
<li>将原有的 <code>GWorld.build.cs</code> 文件改名为 <code>GWorldAAA.build.cs</code>，并将文件内容的所有<code>GWorld</code> 替换为<code>GWorldAAA</code>；</li>
<li>将项目内所有头文件的 <code>GWORLD_API</code> 改名为 <code>GWORLDAAA_API</code>，因为<code>XXX_API</code> 的导出符号是依赖于 <code>ModuleName</code> 的；</li>
</ol>
<p>实在是个不小的工作量，所以还是建议将 <code>ExtraModuleNames</code> 中指定的名字与 <code>Game Module</code> 同名。<br>通过上面的内容，我们可以知道了 <code>Target.cs</code> 是如何与 <code>Build.cs</code> 关联的。那么，其实 <code>Game</code>/<code>Server</code>/<code>Client</code>/<code>Editor</code> 的<code>Target</code>可以共用同一个 <code>Module</code>，将他们的<code>ExtraModuleNames</code> 都设置成同一个就可以了(如果你想要针对每个 Target 类型单独写也可以)。</p>
<p><code>TargetRules</code>的代码在 <a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Programs/UnrealBuildTool/Configuration/TargetRules.cs">UnrealBuildTools/Configuration/ModuleRules</a>（<code>ReadOnlyTargetRules</code> 也定义其中），可以看一下所支持参数的默认值；UE 对 <code>Target</code> 支持属性的描述文档：<a href="https://docs.unrealengine.com/en-US/Programming/BuildTools/UnrealBuildTool/TargetFiles/index.html">Targets</a>。</p>
<p>但是 UE 的官方文档里面也只是代码里的注释，有些描述看了之后摸不着头脑，后面我会分析一下 <code>TargetRule</code> 一些属性的含义，先埋个坑。</p>
<h3 id="Type-TargetType"><a href="#Type-TargetType" class="headerlink" title="Type(TargetType)"></a>Type(TargetType)</h3><p><code>TargetRules</code>中的属性 <code>Type</code>，其类型为<code>TargetType</code>，定义为<code>TargetRules.cs</code> 中，是指定项目要编译出来的是什么程序。</p>
<ul>
<li><strong>Game</strong> - A standalone game which requires cooked data to run.</li>
<li><strong>Client</strong> - Same as Game, but does not include any server code. Useful for networked games.</li>
<li><strong>Server</strong> - Same as Game, but does not include any client code. Useful for dedicated servers in networked games.</li>
<li><strong>Editor</strong> - A target which extends the Unreal Editor.</li>
<li><strong>Program</strong> - A standalone utility program built on top of the Unreal Engine.</li>
</ul>
<h3 id="LinkType-TargetLinkType"><a href="#LinkType-TargetLinkType" class="headerlink" title="LinkType(TargetLinkType)"></a>LinkType(TargetLinkType)</h3><p><code>TargetRules</code>中的 <code>LinkType</code>，其类型为<code>TargetLinkType</code>，定义在<code>TargetRules.cs</code> 中，是指定项目的链接类型。</p>
<p><code>TargetLinkType</code>具有三个枚举值：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/// &lt;summary&gt;</span></span><br><span class="line"><span class="comment">/// Specifies how to link all the modules in this target</span></span><br><span class="line"><span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line">[Serializable]</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">TargetLinkType</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">/// &lt;summary&gt;</span></span><br><span class="line">    <span class="comment">/// Use the default link type based on the current target type</span></span><br><span class="line">    <span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line">    Default,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// &lt;summary&gt;</span></span><br><span class="line">    <span class="comment">/// Link all modules into a single binary</span></span><br><span class="line">    <span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line">    Monolithic,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// &lt;summary&gt;</span></span><br><span class="line">    <span class="comment">/// Link modules into individual dynamic libraries</span></span><br><span class="line">    <span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line">    Modular,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>TargetLinkType.Default</code>是 <code>LinkType</code> 的默认值，在此种状态下，如果当前 <code>Target</code> 的<code>Type</code>为 <code>Editor</code> 则使用 <code>Modular</code> 类型，链接所有的模块的方式为动态链接库。</li>
<li><code>TargetLinkType.Modular</code>：以动态链接库的方式链接 Module</li>
<li><code>TargetLinkType.Monolithic</code>：将所有的模块链接到单个文件(静态链接)</li>
</ul>
<p>可以通过修改 <code>LinkType</code> 来修改。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/// &lt;summary&gt;</span></span><br><span class="line"><span class="comment">/// Backing storage for the LinkType property.</span></span><br><span class="line"><span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line">[RequiresUniqueBuildEnvironment]</span><br><span class="line">[<span class="built_in">CommandLine</span>(<span class="string">&quot;-Monolithic&quot;</span>, Value =<span class="string">&quot;Monolithic&quot;</span>)]</span><br><span class="line">[<span class="built_in">CommandLine</span>(<span class="string">&quot;-Modular&quot;</span>, Value =<span class="string">&quot;Modular&quot;</span>)]</span><br><span class="line">TargetLinkType LinkTypePrivate = TargetLinkType.Default;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// &lt;summary&gt;</span></span><br><span class="line"><span class="comment">/// Specifies how to link modules in this target (monolithic or modular). This is currently protected for backwards compatibility. Call the GetLinkType() accessor</span></span><br><span class="line"><span class="comment">/// until support for the deprecated ShouldCompileMonolithic() override has been removed.</span></span><br><span class="line"><span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line"><span class="keyword">public</span> TargetLinkType LinkType</span><br><span class="line">&#123;</span><br><span class="line">    get</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> (LinkTypePrivate != TargetLinkType.Default) ? LinkTypePrivate : ((Type == global::UnrealBuildTool.TargetType.Editor) ? TargetLinkType.Modular : TargetLinkType.Monolithic);</span><br><span class="line">    &#125;</span><br><span class="line">    set</span><br><span class="line">    &#123;</span><br><span class="line">        LinkTypePrivate = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Name-string"><a href="#Name-string" class="headerlink" title="Name(string)"></a>Name(string)</h3><p>Target 的名字，只读属性，传进来的项目名字。</p>
<h3 id="Platform-UnrealTargetPlatform"><a href="#Platform-UnrealTargetPlatform" class="headerlink" title="Platform(UnrealTargetPlatform)"></a>Platform(UnrealTargetPlatform)</h3><p><code>Platform</code>的类型为<code>UnrealTargetPlatform</code>，它是一个枚举，定义在<code>UnrealBuildTool\Configuration\UEBuildTarget.cs</code>。</p>
<p>它记录着当前 Target 的平台信息，如 Win32/Win64 等等，目前 <code>UE_4.22</code> 的版本支持的平台为：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> UnrealTargetPlatform</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> Unknown target platform</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  Unknown,</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> 32-bit Windows</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  Win32,</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> 64-bit Windows</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  Win64,</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> Mac</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  Mac,</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> XboxOne</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  XboxOne,</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> Playstation 4</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  PS4,</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> iOS</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  IOS,</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> Android</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  Android,</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> HTML5</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  HTML5,</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> Linux</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  Linux,</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> All desktop platforms</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  AllDesktop,</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> TVOS</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  TVOS,</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> Nintendo Switch</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  Switch,</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> NDA&#x27;d platform Quail</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  Quail,</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> Confidential platform</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  Lumin,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以在 <code>build.cs</code> 或者 <code>target.cs</code> 中通过判断 Platform 来做不同的事情。</p>
<p>如：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(Target.Platform != UnrealTargetPlatform.Win32 &amp;&amp; Target.Platform != UnrealTargetPlatform.Win64)</span><br><span class="line">&#123;</span><br><span class="line">  PublicDefinitions.<span class="built_in">Add</span>(<span class="string">&quot;HAVE_PTHREAD&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="IsInPlatformGroup"><a href="#IsInPlatformGroup" class="headerlink" title="IsInPlatformGroup"></a>IsInPlatformGroup</h3><p>这是一个函数 <code>bool IsInPlatformGroup(UnrealPlatformGroup Group)</code>，定义在<code>TargetRules.cs</code> 中，它用来判断当前的 <code>Platform</code> 是否输入某一组。</p>
<p>需要传入的参数为 <code>UnrealTargetformGroup</code> 枚举类型，它定义在 <code>UEBuildTarget.cs</code> 中：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Platform groups</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> UnrealPlatformGroup</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> this group is just to lump Win32 and Win64 into Windows directories, removing the special Windows logic in MakeListOfUnsupportedPlatforms</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  Windows,</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> Microsoft platforms</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  Microsoft,</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> Apple platforms</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  Apple,</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> making IOS a group allows TVOS to compile IOS code</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  IOS,</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> Unix platforms</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  Unix,</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> Android platforms</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  Android,</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> Sony platforms</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  Sony,</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> Target all desktop platforms (Win64, Mac, Linux) simultaneously</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  AllDesktop,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Configuration-UnrealTargetConfiguration"><a href="#Configuration-UnrealTargetConfiguration" class="headerlink" title="Configuration(UnrealTargetConfiguration)"></a>Configuration(UnrealTargetConfiguration)</h3><p>当前编译的配置，类型为 <code>UnrealTargetConfiguration</code> 的枚举，定义在 <code>UEBuildTarget.cs</code> 中，由 VS 中的 <code>Configuration</code> 构造而来，如：</p>
<ul>
<li>Development</li>
<li>Shipping</li>
<li>DebugGame</li>
<li>Debug</li>
<li>Test</li>
<li>Unknow</li>
</ul>
<p>也就是通过这个设置，UBT 才在编译环境中添加了下列宏：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetUpConfigurationEnvironment</span><span class="params">(ReadOnlyTargetRules Target, CppCompileEnvironment GlobalCompileEnvironment, LinkEnvironment GlobalLinkEnvironment)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// other code</span></span><br><span class="line">	UnrealTargetConfiguration CheckConfig = Target.Configuration;</span><br><span class="line">	<span class="built_in"><span class="keyword">switch</span></span> (CheckConfig)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">default</span>:</span><br><span class="line">	  <span class="keyword">case</span> UnrealTargetConfiguration.Debug:</span><br><span class="line">	    GlobalCompileEnvironment.Definitions.<span class="built_in">Add</span>(<span class="string">&quot;UE_BUILD_DEBUG=1&quot;</span>);</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	  <span class="keyword">case</span> UnrealTargetConfiguration.DebugGame:</span><br><span class="line">	  <span class="comment">// Default to Development; can be overridden by individual modules.</span></span><br><span class="line">	  <span class="keyword">case</span> UnrealTargetConfiguration.Development:</span><br><span class="line">	    GlobalCompileEnvironment.Definitions.<span class="built_in">Add</span>(<span class="string">&quot;UE_BUILD_DEVELOPMENT=1&quot;</span>);</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	  <span class="keyword">case</span> UnrealTargetConfiguration.Shipping:</span><br><span class="line">	    GlobalCompileEnvironment.Definitions.<span class="built_in">Add</span>(<span class="string">&quot;UE_BUILD_SHIPPING=1&quot;</span>);</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	  <span class="keyword">case</span> UnrealTargetConfiguration.Test:</span><br><span class="line">	    GlobalCompileEnvironment.Definitions.<span class="built_in">Add</span>(<span class="string">&quot;UE_BUILD_TEST=1&quot;</span>);</span><br><span class="line">	  <span class="keyword">break</span>;bUseDebugCRT</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// other code</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Architecture-string"><a href="#Architecture-string" class="headerlink" title="Architecture(string)"></a>Architecture(string)</h3><p>所运行的平台的架构信息：<code>x86</code>/<code>arm</code>等等。</p>
<h3 id="CppStandard-CppStandardVersion"><a href="#CppStandard-CppStandardVersion" class="headerlink" title="CppStandard(CppStandardVersion)"></a>CppStandard(CppStandardVersion)</h3><p>用于指定编译项目时所用的 C++ 标准版本（在新版本引擎 (4.23) 中才有）。<br><code>CppStandardVersion</code>：</p>
<ul>
<li><code>Latast</code></li>
<li><code>Cpp17</code></li>
<li>Cpp14</li>
</ul>
<p>这个选项本质上就是将 <code>/std:c++xxx</code> 添加到 VS 的编译选项中。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AppendCLArguments_CPP</span><span class="params">(CppCompileEnvironment CompileEnvironment, List&lt;string&gt; Arguments)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// other code...</span></span><br><span class="line">  <span class="keyword">if</span>(CompileEnvironment.CppStandard &gt;= CppStandardVersion.Latest)</span><br><span class="line">  &#123;</span><br><span class="line">    Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/std:c++latest&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span>(CompileEnvironment.CppStandard &gt;= CppStandardVersion.Cpp17)</span><br><span class="line">  &#123;</span><br><span class="line">    Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/std:c++17&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span>(CompileEnvironment.CppStandard &gt;= CppStandardVersion.Cpp14)</span><br><span class="line">  &#123;</span><br><span class="line">    Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/std:c++14&quot;</span>);</span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="comment">// other code...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="bUseDebugCRT-bool"><a href="#bUseDebugCRT-bool" class="headerlink" title="bUseDebugCRT(bool)"></a>bUseDebugCRT(bool)</h3><p>用来控制输出的 <code>Runtime Librart</code> 类型是 <code>MT</code> 还是 <code>MD</code>；<br> 还用来控制添加 <code>_DEBUG</code> 和<code>NODEBUG</code>宏：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetUpConfigurationEnvironment</span><span class="params">(ReadOnlyTargetRules Target, CppCompileEnvironment GlobalCompileEnvironment, LinkEnvironment GlobalLinkEnvironment)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (GlobalCompileEnvironment.bUseDebugCRT)</span><br><span class="line">  &#123;</span><br><span class="line">    GlobalCompileEnvironment.Definitions.<span class="built_in">Add</span>(<span class="string">&quot;_DEBUG=1&quot;</span>); <span class="comment">// the engine doesn&#x27;t use this, but lots of 3rd party stuff does</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    GlobalCompileEnvironment.Definitions.<span class="built_in">Add</span>(<span class="string">&quot;NDEBUG=1&quot;</span>); <span class="comment">// the engine doesn&#x27;t use this, but lots of 3rd party stuff does</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// other code</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ProjectDefinitions-List-lt-string-gt"><a href="#ProjectDefinitions-List-lt-string-gt" class="headerlink" title="ProjectDefinitions(List&lt;string&gt;)"></a>ProjectDefinitions(List&lt;string&gt;)</h3><p>为当前项目添加的宏定义，在整个项目中可用。</p>
<h3 id="GlobalDefinitions-List-lt-string-gt"><a href="#GlobalDefinitions-List-lt-string-gt" class="headerlink" title="GlobalDefinitions(List&lt;string&gt;)"></a>GlobalDefinitions(List&lt;string&gt;)</h3><p>添加在整个 Target 中都可以用的宏定义。</p>
<h3 id="bShouldCompileAsDLL-bool"><a href="#bShouldCompileAsDLL-bool" class="headerlink" title="bShouldCompileAsDLL(bool)"></a>bShouldCompileAsDLL(bool)</h3><p>将 Target 编译为 DLL，为 <code>true</code> 时要求 <code>LinkType</code> 为<code>Monolithic</code>。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/// &lt;summary&gt;</span></span><br><span class="line"><span class="comment">/// Whether this target should be compiled as a DLL.  Requires LinkType to be set to TargetLinkType.Monolithic.</span></span><br><span class="line"><span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line">[RequiresUniqueBuildEnvironment]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">bool</span> bShouldCompileAsDLL = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<h3 id="AdditionalCompilerArguments-String"><a href="#AdditionalCompilerArguments-String" class="headerlink" title="AdditionalCompilerArguments(String)"></a>AdditionalCompilerArguments(String)</h3><p>传递给编译器的参数。</p>
<h3 id="AdditionalLinkerArguments-String"><a href="#AdditionalLinkerArguments-String" class="headerlink" title="AdditionalLinkerArguments(String)"></a>AdditionalLinkerArguments(String)</h3><p>传递给连接器的参数。</p>
<h3 id="bUsesSlate-bool"><a href="#bUsesSlate-bool" class="headerlink" title="bUsesSlate(bool)"></a>bUsesSlate(bool)</h3><p>控制打包时时候把 <code>Slate</code> 相关的图片资源打包到 pak 中。</p>
<h2 id="Module"><a href="#Module" class="headerlink" title="Module"></a>Module</h2><p>与 <code>Target</code> 类似，每一个 Unreal 的 <code>Module</code>，都有一个专属的<code>ModuleName.Build.cs</code> 里面定义着专属的 <code>ModuleName</code> 类，它由 <code>ModuleRules</code> 继承而来，我们对 <code>Module</code> 构建时进行的操作就是通过它来控制。</p>
<blockquote>
<p>注意：不管是 Game Module 还是 Plugin Module，只要是 <strong> 项目依赖 </strong> 的 Module，编译时它们都会接收到当前使用的 <code>Target</code> 信息。</p>
</blockquote>
<p><code>ModuleRules</code>的代码在 <a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Programs/UnrealBuildTool/Configuration/ModuleRules.cs">UnrealBuildTools/Configuration/ModuleRules</a>，同样可以看一下支持的属性默认值；UE 对<code>Modules</code> 描述的官方文档：<a href="https://docs.unrealengine.com/en-US/Programming/BuildTools/UnrealBuildTool/ModuleFiles/index.html">Modules</a>，这里也同样只有代码的注释内容，没有实际例子，我就先来分析一些在工程中常见的 <strong>Build.cs</strong> 中属性的含义。</p>
<p><code>*.Build.cs</code>中可以通过它构造接收的 <code>ReadOnlyTargetRules Target</code> 参数来获取 <code>*.Target.cs</code> 中的属性信息。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> UnrealBuildTool;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GWorld</span> : <span class="title">ModuleRules</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">GWorld</span>(<span class="params">ReadOnlyTargetRules ReadOnlyTargetRules</span>) : <span class="title">base</span>(<span class="params">Target</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    PCHUsage = PCHUsageMode.UseExplicitOrSharedPCHs;</span><br><span class="line">    <span class="comment">// something</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 <code>Target</code> 对象，可以在 <code>*.build.cs</code> 中控制对不同的平台(Platform)，架构(Architecture)，以及其他的选项来对 Module 进行不同的操作(比如定义不同的宏 / 包含不同的 ThridParty/ 链接不同的 Lib 等等)。</p>
<h3 id="ModuleDirectory"><a href="#ModuleDirectory" class="headerlink" title="ModuleDirectory"></a>ModuleDirectory</h3><ul>
<li><code>string ModuleDirectory</code>：项目的源码路径 <code>PROJECT_NAME/Source/PROJECT_NAME</code> 的绝对路径。</li>
</ul>
<h3 id="EngineDirectory"><a href="#EngineDirectory" class="headerlink" title="EngineDirectory"></a>EngineDirectory</h3><ul>
<li><code>string EngineDirectory</code>：引擎目录 <code>Engine/</code> 在当前环境的绝对路径。</li>
</ul>
<h3 id="PublicAdditionalLibraries"><a href="#PublicAdditionalLibraries" class="headerlink" title="PublicAdditionalLibraries"></a>PublicAdditionalLibraries</h3><p>添加静态链接库文件 (注意与<code>PublicLibraryPaths</code> 的区别)，一般是用于第三方库的链接。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">PublicAdditionalLibraries.<span class="built_in">AddRange</span>(</span><br><span class="line">  <span class="keyword">new</span> string[]</span><br><span class="line">  &#123;</span><br><span class="line">    Path.<span class="built_in">Combine</span>(ThridPartyPath,<span class="string">&quot;protobuf/lib/Win64/MD/Release&quot;</span>,<span class="string">&quot;libprotobuf.lib&quot;</span>),</span><br><span class="line">    Path.<span class="built_in">Combine</span>(ThridPartyPath,<span class="string">&quot;protobuf/lib/Win64/MD/Release&quot;</span>,<span class="string">&quot;libprotobuf-lite.lib&quot;</span>),</span><br><span class="line">    Path.<span class="built_in">Combine</span>(ThridPartyPath,<span class="string">&quot;protobuf/lib/Win64/MD/Release&quot;</span>,<span class="string">&quot;libprotoc.lib&quot;</span>),</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>详细的内容可以看：<a href="https://wiki.unrealengine.com/Linking_Static_Libraries_Using_The_Build_System">Linking Static Libraries Using The Build System</a></p>
<blockquote>
<p>同样可以用在 DLL 的导入库，与 <code>PublicDelayLoadDLLs</code> 和<code>RuntimeDependencies</code>配合使用。</p>
</blockquote>
<h3 id="PublicAdditionalShadowFiles"><a href="#PublicAdditionalShadowFiles" class="headerlink" title="PublicAdditionalShadowFiles"></a>PublicAdditionalShadowFiles</h3><p>当执行远程编译的时候，指定当前模块需要复制到远程服务器上的文件，确保能够链接成功。</p>
<p>如远程打包 IOS 平台时，需要把当前模块依赖的静态链接库添加到里面（如 Game 模块依赖某个插件中的 <code>External</code> 模块）。</p>
<h3 id="RuntimeDependencies"><a href="#RuntimeDependencies" class="headerlink" title="RuntimeDependencies"></a>RuntimeDependencies</h3><ul>
<li><code>list&lt;RuntimeDependency&gt; RuntimeDependencies</code>：Module 在运行时依赖的文件 (<code>.so</code>/<code>.dll</code> 等)，打包时将会拷贝到存储目录。</li>
</ul>
<p>在打包 Windows 时会直接把文件拷贝到打包的对应目录下，但是在 Android 上会把文件放到 Apk 包的 main.obb.webp 中。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/16643/android-runtimedependencies.webp"></p>
<h3 id="PublicDelayLoadDLLs"><a href="#PublicDelayLoadDLLs" class="headerlink" title="PublicDelayLoadDLLs"></a>PublicDelayLoadDLLs</h3><ul>
<li><code>List&lt;string&gt; PublicDelayLoadDLLs</code>：延迟加载的 DLL 列表，通常用于第三方库。</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// build.cs</span></span><br><span class="line">PublicAdditionalLibraries.Add(Path.Combine(LibrariesPath, <span class="string">&quot;myExternalLib.lib&quot;</span>));</span><br><span class="line">PublicDelayLoadDLLs.Add(<span class="string">&quot;myExternalLib.dll&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>含义是不在程序启动时立即加载 DLL 的列表，等到首次需要使用他们的符号后再进行加载。这样可以在模块的 <code>StartupModule</code> 中自行指定位置并加载他们，从而实现可以不把 dll 放到 exe 的目录。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">FString AbsPath = FileManager::<span class="built_in">Get</span>().<span class="built_in">ConvertToAbsolutePathForExternalAppForRead</span>(*MyLibPath);</span><br><span class="line">FPlatformProcess::<span class="built_in">AddDllDirectory</span>(AbsPath)</span><br><span class="line">FPlatformProcess::<span class="built_in">PushDllDirectory</span>(*AbsPath);</span><br><span class="line"><span class="comment">// direct call dll function</span></span><br><span class="line"><span class="comment">// or load dll handle</span></span><br><span class="line"><span class="comment">// void* DLLHandle3 = FPlatformProcess::GetDllHandle(L&quot;myExternalLib.dll&quot;);</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>PS：配合 <code>PublicAdditionalLibraries</code> 可以用在使用 DLL 导入库的第三方库。</p>
</blockquote>
<ol>
<li>使用 PublicAdditionalLibraries 添加 lib</li>
<li>DLL 的名字添加至 PublicDelayLoadDLLs</li>
<li>使用 RuntimeDependencies 打包时拷贝 dll</li>
<li>如果拷贝到的目录不是 exe 路径，需要 StartupModule 里执行 <code>AddDllDirectory</code> 和<code>PushDllDirectory</code>把 dll 的路径添加到里面<blockquote>
<p>PublicDelayLoadDLLs 只添加 xxxx.dll 就可以了，不需要路径。</p>
</blockquote>
</li>
</ol>
<p>我使用 <code>GoogleInstantPreview</code> 测试使用 DLL+ 导入库并将 DLL 放在非 exe 目录的例子：<a href="ue4-plugin-GoogleInstanceIns.7z">ue4-plugin-GoogleInstanceIns.7z</a></p>
<ul>
<li><a href="https://stackoverflow.com/questions/49172258/runtime-error-when-referencing-external-library-in-unreal-engine">Runtime error when referencing external library in Unreal Engine</a></li>
<li><a href="https://forums.unrealengine.com/development-discussion/c-gameplay-programming/121369-how-unreal-build-tool-works">How Unreal Build Tool works</a></li>
</ul>
<h3 id="PublicDefinitions"><a href="#PublicDefinitions" class="headerlink" title="PublicDefinitions"></a>PublicDefinitions</h3><ul>
<li><code>List&lt;string&gt; PublicDefinitions</code>：为当前 Module 添加公开宏定义，等同于传统 VS 项目在项目设置中添加一个预处理宏。</li>
</ul>
<p>它被 UBT 分析之后会在产生一个 <code>Definitions.PROJECT_NAME.h</code> 的头文件，里面定了各种宏。</p>
<figure class="highlight pp"><table><tr><td class="code"><pre><span class="line">Intermediate\Build\Win64\UE4Editor\Development\ReflectionExample\Definitions.ReflectionExample.h</span><br></pre></td></tr></table></figure>

<h3 id="PublicSystemIncludePaths"><a href="#PublicSystemIncludePaths" class="headerlink" title="PublicSystemIncludePaths"></a>PublicSystemIncludePaths</h3><ul>
<li><code>List&lt;string&gt; PublicSystemIncludePaths</code>：文档介绍是用于添加系统的 Include 路径，与 <code>PublicIncludePaths</code> 的区别是会跳过头文件解析检查(但是经我测试，使用这种方式包含的代码依然会检测下列错误(UE_4.20)):</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">error : Expected mpack-platform.h to be first header included.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：如果不指定路径，则默认的 IncludePath 路径是<code>Engine/Source</code>。</p>
</blockquote>
<p>比如：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">PublicSystemIncludePaths.AddRange(</span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">string</span>[] &#123;</span><br><span class="line">    <span class="string">&quot;TEST_LIB&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>它表示的路径是：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\UnrealEngine\Epic\UE_4.21\Engine\Source\TEST_LIB</span><br></pre></td></tr></table></figure>
<p>所有可以在 <code>*.build.cs</code> 中指定的<code>*IncludePaths</code>，默认的路径都是<code>Engine/Source</code>.</p>
<h3 id="PrivateRuntimeLibraryPaths"><a href="#PrivateRuntimeLibraryPaths" class="headerlink" title="PrivateRuntimeLibraryPaths"></a>PrivateRuntimeLibraryPaths</h3><ul>
<li><code>List&lt;string&gt; PrivateRuntimeLibraryPaths</code>：运行时库的搜索路径。例如 <code>.so</code> 或者<code>.dll</code>。</li>
</ul>
<h3 id="PublicRuntimeLibraryPaths"><a href="#PublicRuntimeLibraryPaths" class="headerlink" title="PublicRuntimeLibraryPaths"></a>PublicRuntimeLibraryPaths</h3><ul>
<li><code>List&lt;string&gt; PublicRuntimeLibraryPaths</code>：运行时库的搜索路径。例如 <code>.so</code> 或者<code>.dll</code>。</li>
</ul>
<p>因为动态链接库的查找路径默认只有：</p>
<ol>
<li>系统的 PATH 路径；</li>
<li>可执行程序的当前目录；</li>
</ol>
<p>如果我们的动态链接库在其他的位置，运行时就会错误，可以通过 <code>PublicRuntimeLibraryPaths</code> 或者 <code>PrivateRuntimeLibraryPaths</code> 来添加。</p>
<h3 id="PublicLibraryPaths"><a href="#PublicLibraryPaths" class="headerlink" title="PublicLibraryPaths"></a>PublicLibraryPaths</h3><p>添加链接库文件的 <strong> 路径</strong>，如在源码中使用的:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib,<span class="meta-string">&quot;Lua.lib&quot;</span>)</span></span><br></pre></td></tr></table></figure>

<p>可以通过 <code>PublicLibraryPaths</code> 来添加依赖的 Lib。</p>
<h3 id="DynamicallyLoadedModuleNames"><a href="#DynamicallyLoadedModuleNames" class="headerlink" title="DynamicallyLoadedModuleNames"></a>DynamicallyLoadedModuleNames</h3><ul>
<li><code>List&lt;string&gt; DynamicallyLoadedModuleNames</code>：添加需要运行时动态加载的 Module，使用 <code>FModuleManager::LoadModuleChecked&lt;MODULE_TYPE&gt;(TEXT(&quot;MODULE_NAME&quot;))</code> 等函数启动。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// e.g</span></span><br><span class="line">FModuleManager::LoadModuleChecked&lt; IAIModule &gt;(<span class="string">&quot;AIModule&quot;</span> );</span><br></pre></td></tr></table></figure>

<h3 id="PublicDependencyModuleNames"><a href="#PublicDependencyModuleNames" class="headerlink" title="PublicDependencyModuleNames"></a>PublicDependencyModuleNames</h3><ul>
<li><code>List&lt;string&gt; PublicDependencyModuleNames</code>：添加对执行 Module 的源文件依赖，自动添加所依赖 Module 的 <code>Public</code> 和<code>Private</code>源文件包含。</li>
</ul>
<h3 id="PrivateDependencyModuleNames"><a href="#PrivateDependencyModuleNames" class="headerlink" title="PrivateDependencyModuleNames"></a>PrivateDependencyModuleNames</h3><ul>
<li><code>List&lt;string&gt; PrivateDependencyModuleNames</code>：与 <code>PublicDependencyModuleNames</code> 不同的是，意味着所依赖的 Module 中的源文件只可以在 <code>Private</code> 中使用。</li>
</ul>
<p>假如现在有一个模块 A，还有一个模块 B，他们中都是 UE 的 <code>Module/Public</code> 和<code>Module/Private</code>的文件结构。</p>
<ul>
<li>如果 B 中依赖 A，如果使用的是 <code>PrivateDependencyModuleNames</code> 的方式添加的依赖，则 A 模块的源文件只可以在 B 的 <code>Private</code> 目录下的源文件中使用，在 <code>Public</code> 目录下的源文件使用时会报 <code>No such file or directory</code> 的错误。</li>
<li>如果使用的是 <code>PublicDependencyModuleNames</code> 方式添加的依赖，则 A 的源文件在 B 的 <code>Public</code> 与<code>Private</code>中都可用。</li>
</ul>
<p>除了上述的区别之外，还影响依赖于 B 模块的模块 ，当一个模块 C 依赖模块 B 的时候，只能访问到 B 模块的 PublicDependencyModule 中的模块暴露出来的类。<br>例如，C 依赖 B，B 依赖 A；那么，假如 C 想访问 A 中的类则有两种方式：</p>
<ol>
<li>在 C 的依赖中添加上 A 模块</li>
<li>确保 B 在 <code>PublicDependencyModuleNames</code> 依赖中添加的 A 模块，这样 C 就可以间接的访问到 A。</li>
</ol>
<p>经过测试发现，其实对于 <strong> 游戏模块 </strong>(<code>PROJECT_NAME/Source/PROJECT_NAME.target.cs</code>) 使用而言，所依赖的模块是使用 <code>PublicDependencyModuleNames</code> 还是 <code>PrivateDependencyModuleNames</code> 包含，没什么区别。<br>使用 <code>Private</code> 方式依赖的 Module 中的头文件依然可以在游戏模块的 <code>Public</code> 中用，这一点与插件等其他模块有所不同（但是这只有在所依赖的模块不是 <code>bUsePreCompiled</code> 的基础上的，如果所依赖的模块是 <code>bUsePreCompiled</code> 的，则与其他的模块一样，<code>PrivateDependencyModuleNames</code>依赖的模块不可以在 <code>Pulibc</code> 目录下的源文件使用），这个行为比较奇怪：有时候出错有时又不出错。</p>
<blockquote>
<p>注意：在游戏项目中使用依赖其他 Module 时尽量确定性需求地使用 <code>PrivateDependencyModuleNames</code> 或者<code>PublicDependencyModuleNames</code>，在组合其他的选项时可能会有一些奇怪的行为。</p>
</blockquote>
<p>相关的讨论：</p>
<ol>
<li><a href="https://answers.unrealengine.com/questions/23384/what-is-the-difference-between-publicdependencymod.html">What is the difference between PublicDependencyModuleNames and PrivateDependencyModuleNames</a></li>
<li><a href="https://answers.unrealengine.com/questions/20310/explanation-of-source-code-folder-structure.html">Explanation of Source Code folder structure?</a></li>
</ol>
<h3 id="bPreCompile 与 bUsePreCompiled"><a href="#bPreCompile 与 bUsePreCompiled" class="headerlink" title="bPreCompile 与 bUsePreCompiled"></a>bPreCompile 与 bUsePreCompiled</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Whether this module should be precompiled. Defaults to the bPrecompile flag from the target. Clear this flag to prevent a module being precompiled.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">bool</span> bPrecompile;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Whether this module should use precompiled data. Always true for modules created from installed assemblies.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">bool</span> bUsePrecompiled;</span><br></pre></td></tr></table></figure>

<p>这个两个属性需要组合来使用。</p>
<p>考虑下列需求：<br>如果我们写好的一个模块 A 希望拿给别人来用，但是又不想把所有代码开放出来，该怎么办？</p>
<p>在传统的 C++ 领域，我应该会说：把代码编译成 DLL，然后把头文件和 DLL 发放给用户就可以啦。<br>对！其实 <code>bPreCompile</code> 和<code>bUsePreCompiled</code>就是做的类似的事情。</p>
<p>当我们对模块 A 进行编译之前，在它的 <code>*.build.cs</code> 中添加：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">A</span> : <span class="title">ModuleRules</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">A</span>(<span class="params">ReadOnlyTargetRules Target</span>) : <span class="title">base</span>(<span class="params">Target</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    bPreCompile=<span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后编译模块 A。编译完成之后，将模块 A 的 <code>Source/Private</code> 删除 (删除之前请确保你已经备份)，然后删除模块目录下的<code>Intermediate</code>，但是要保留<code>Binaries</code> 目录。<br>最后，打开模块 A 的 <code>A.build.cs</code>，将<code>bPreCompile=true;</code> 删掉，然后再添加：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">A</span> : <span class="title">ModuleRules</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">A</span>(<span class="params">ReadOnlyTargetRules Target</span>) : <span class="title">base</span>(<span class="params">Target</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    bUsePreCompiled=<span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时我们想要实现的目标都已经完成了：不发布实现代码(<code>Private</code>)，发布预先编译好的二进制，但是这样无法进行静态链接，如果只是暴露给蓝图使用可以，在其他的 Module 中使用它的符号会有符号未定义错误。</p>
<h3 id="OptimizeCode-CodeOptimization"><a href="#OptimizeCode-CodeOptimization" class="headerlink" title="OptimizeCode(CodeOptimization)"></a>OptimizeCode(CodeOptimization)</h3><p>这个属性是用来控制当前模块是否要开启优化代码，在我们用 VS 调试时，有时候会看到“变量已被优化，因而不可用”，这就是因为被优化了。</p>
<p>可以使用它来关闭优化：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// build.cs</span></span><br><span class="line">OptimizeCode = CodeOptimization.Never;</span><br></pre></td></tr></table></figure>

<p><code>CodeOptimization</code>支持几种值，默认是<code>Default</code>，开启优化：</p>
<ul>
<li>Never</li>
<li>Default</li>
<li>InNonDebugBuilds</li>
<li>InShippingBuildsOnly</li>
</ul>
<p>相关的代码：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTool/Configutation/UEBuildModuleCPP.cs</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">ShouldEnableOptimization</span><span class="params">(ModuleRules.CodeOptimization Setting, UnrealTargetConfiguration Configuration, <span class="keyword">bool</span> bIsEngineModule)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in"><span class="keyword">switch</span></span>(Setting)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> ModuleRules.CodeOptimization.Never:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">case</span> ModuleRules.CodeOptimization.Default:</span><br><span class="line">    <span class="keyword">case</span> ModuleRules.CodeOptimization.InNonDebugBuilds:</span><br><span class="line">      <span class="keyword">return</span> (Configuration == UnrealTargetConfiguration.Debug)? <span class="literal">false</span> : (Configuration != UnrealTargetConfiguration.DebugGame || bIsEngineModule);</span><br><span class="line">    <span class="keyword">case</span> ModuleRules.CodeOptimization.InShippingBuildsOnly:</span><br><span class="line">      <span class="keyword">return</span> (Configuration == UnrealTargetConfiguration.Shipping);</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数在 <code>UEBuildModuleCPP.cs</code> 的<code>CreateModuleCompileEnvironment</code>中调用，将结果赋值给了 <code>CppCompileEnvironment.bOptimizeCode</code>，进而又在<code>VCToolChain.cs</code> 中被使用：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">UnrealBuildTool\Platform\Windows\VCToolChain.<span class="function">cs</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AppendCLArguments_Global</span><span class="params">(CppCompileEnvironment CompileEnvironment, List&lt;string&gt; Arguments)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// other code ...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//  Debug</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="keyword">if</span> (CompileEnvironment.Configuration == CppConfiguration.Debug)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="comment">// Disable compiler optimization.</span></span><br><span class="line">	  Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/Od&quot;</span>);</span><br><span class="line"></span><br><span class="line">	  <span class="comment">// Favor code size (especially useful for embedded platforms).</span></span><br><span class="line">	  Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/Os&quot;</span>);</span><br><span class="line"></span><br><span class="line">	  <span class="comment">// Allow inline method expansion unless E&amp;C support is requested</span></span><br><span class="line">	  <span class="keyword">if</span> (!CompileEnvironment.bSupportEditAndContinue &amp;&amp; CompileEnvironment.bUseInlining)</span><br><span class="line">	  &#123;</span><br><span class="line">	    Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/Ob2&quot;</span>);</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> ((CompileEnvironment.Platform == CppPlatform.Win32) ||</span><br><span class="line">	    (CompileEnvironment.Platform == CppPlatform.Win64))</span><br><span class="line">	  &#123;</span><br><span class="line">	    Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/RTCs&quot;</span>);</span><br><span class="line">	  &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//  Development and LTCG</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">if</span>(!CompileEnvironment.bOptimizeCode)</span><br><span class="line">	  &#123;</span><br><span class="line">	    <span class="comment">// Disable compiler optimization.</span></span><br><span class="line">	    Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/Od&quot;</span>);</span><br><span class="line">	  &#125;</span><br><span class="line">	  <span class="keyword">else</span></span><br><span class="line">	  &#123;</span><br><span class="line">	    <span class="comment">// Maximum optimizations.</span></span><br><span class="line">	    Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/Ox&quot;</span>);</span><br><span class="line"></span><br><span class="line">	    <span class="comment">// Favor code speed.</span></span><br><span class="line">	    Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/Ot&quot;</span>);</span><br><span class="line"></span><br><span class="line">	    <span class="comment">// Coalesce duplicate strings</span></span><br><span class="line">	    Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/GF&quot;</span>);</span><br><span class="line"></span><br><span class="line">	    <span class="comment">// Only omit frame pointers on the PC (which is implied by /Ox) if wanted.</span></span><br><span class="line">	    <span class="keyword">if</span> (CompileEnvironment.bOmitFramePointers == <span class="literal">false</span></span><br><span class="line">	    &amp;&amp; ((CompileEnvironment.Platform == CppPlatform.Win32) ||</span><br><span class="line">	      (CompileEnvironment.Platform == CppPlatform.Win64)))</span><br><span class="line">	    &#123;</span><br><span class="line">	      Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/Oy-&quot;</span>);</span><br><span class="line">	    &#125;</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  <span class="comment">// Allow inline method expansion</span></span><br><span class="line">	  Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/Ob2&quot;</span>);</span><br><span class="line"></span><br><span class="line">	  <span class="comment">//</span></span><br><span class="line">	  <span class="comment">// LTCG</span></span><br><span class="line">	  <span class="comment">//</span></span><br><span class="line">	  <span class="keyword">if</span> (CompileEnvironment.bAllowLTCG)</span><br><span class="line">	  &#123;</span><br><span class="line">	    <span class="comment">// Enable link-time code generation.</span></span><br><span class="line">	    Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/GL&quot;</span>);</span><br><span class="line">	  &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// other code...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，在 <code>Debug</code> 的环境下，是默认关闭优化的。在非 <code>Debug</code> 时根据 <code>CompileEnvironment.bOptimizeCode</code> 的值来决定是否开启优化。<br>调试效果：<br>当使用默认时（<code>OptimizeCode = CodeOptimization.Default;</code>）:<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/16643/UE-codeoptimize-default.webp"></p>
<p>当关闭代码优化时(<code>OptimizeCode = CodeOptimization.Never;</code>)：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/16643/UE-codeoptimize-never.webp"></p>
<p>建议使用<code>OptimizeCode = CodeOptimization.InShippingBuildsOnly;</code>。</p>
<blockquote>
<p>注意：这个选项和普通的 C++ 项目在 VS 中的 <code>Properties</code>-<code>Configuration</code>-<code>C/C++</code>-<code>Optimization</code>-<code>Optimization</code> 的设置时一样的。</p>
</blockquote>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/16643/vs-disable-optimization.webp"></p>
<h3 id="bEnableUndefinedIdentifierWarnings-bool"><a href="#bEnableUndefinedIdentifierWarnings-bool" class="headerlink" title="bEnableUndefinedIdentifierWarnings (bool)"></a>bEnableUndefinedIdentifierWarnings (bool)</h3><p>是否启用在预处理代码 <code>#if</code> 中使用未定义标识符的警告。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> GOOGLE_PROTOBUF_USE_UNALIGNED</span></span><br></pre></td></tr></table></figure>

<p>如果这个宏未定义，在启用 <code>bEnableUndefinedIdentifierWarnings</code> 的情况下会产生 <code>C4688</code> 错误。</p>
<p>相关的代码时定义在 UBT 的代码中的:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Source\Programs\UnrealBuildTool\Platform\Windows\VCToolChain.cs</span></span><br><span class="line"><span class="keyword">if</span>(WindowsPlatform.bUseVCCompilerArgs &amp;&amp; CompileEnvironment.bEnableUndefinedIdentifierWarnings)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (CompileEnvironment.bUndefinedIdentifierWarningsAsErrors)</span><br><span class="line">  &#123;</span><br><span class="line">    Arguments.Add(<span class="string">&quot;/we4668&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    Arguments.Add(<span class="string">&quot;/w44668&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="bUseRTTI-bool"><a href="#bUseRTTI-bool" class="headerlink" title="bUseRTTI (bool)"></a><strong>bUseRTTI</strong> (bool)</h4><p>UE4 默认关闭了 RTTI，所以在工程的代码中写了类似 <code>typeid</code> 的代码，会产生下列错误：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">In file included from C:\UnrealProject_\Source\GWorld\Private\Modules\Flibs\FLibIniConfigHelper.cpp:<span class="number">10</span>:</span><br><span class="line">C:/UnrealProject_/Source/GWorld/Public/Modules/Flibs\FlibMateReflectionHelper.<span class="built_in">h</span>(<span class="number">29</span>,<span class="number">41</span>):  error: cannot use <span class="keyword">typeid</span> with -fno-rtti</span><br><span class="line">    FString EnumTypeName = <span class="built_in">ANSI_TO_TCHAR</span>(<span class="built_in"><span class="keyword">typeid</span></span>(ENUM_TYPE).<span class="built_in">name</span>());</span><br></pre></td></tr></table></figure>

<p>解决办法只有两个：去掉 <code>rtti</code> 相关的代码，或者在当前 <code>Module</code> 的<code>build.cs</code>中把 <code>bUseRTTI</code> 设置为<code>true</code>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>BuildSystem</category>
        <category>UBT</category>
      </categories>
      <tags>
        <tag>BuildSystem</tag>
        <tag>UBT</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 编译时 PCH 虚拟内存不足的错误</title>
    <url>/wiki/5cc4f8a/</url>
    <content><![CDATA[<p>在多核心 CPU 上编译 UE 时，如 Ryzen 线程撕裂者（64 核 128 线程），比较频繁的遇到以下错误：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">c1xx: note: 请访问 https://aka.ms/pch-help 了解更多详情</span><br><span class="line">c1xx: fatal error C1076: 编译器限制: 达到内部堆限制</span><br><span class="line">[12/1456] Module.Renderer.17_of_18.cpp</span><br><span class="line">c1xx: error C3859: 未能创建 PCH 的虚拟内存</span><br><span class="line">c1xx: note: 系统返回代码 1455: 页面文件太小，无法完成操作。</span><br><span class="line">// english log</span><br><span class="line">2&gt;  c1xx: note: please visit https://aka.ms/pch-help for more details</span><br><span class="line">2&gt;c1xx: Error C1076 : compiler limit: internal heap limit reached</span><br><span class="line">2&gt;  [353/3017] Module.AdvancedPreviewScene.cpp</span><br><span class="line">2&gt;  [354/3017] Module.PlacementMode.cpp</span><br><span class="line">2&gt;c1xx: Error C3859 : Failed to create virtual memory for PCH</span><br><span class="line">2&gt;  c1xx: note: the system returned code 1455: The paging file is too small for this operation to complete.</span><br></pre></td></tr></table></figure>
<p>默认情况下，UE 会拉起系统最大线程数量的编译进程。</p>
<p>如我的机器就是 128 个：<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20220720113017.png"></p>
<p>UE 里每个编译任务的 <code>/zm</code> 值为 1000：<a href="https://cs.github.com/EpicGames/UnrealEngine/blob/d11782b9046e9d0b130309591e4efc57f4b8b037/Engine/Source/Programs/UnrealBuildTool/Platform/Windows/VCToolChain.cs?q=/zm#L354">VCToolChain.cs?q=%2Fzm#L354</a></p>
<p>表示每个 cl 进程会分配 750M 的虚拟内存：<a href="https://docs.microsoft.com/en-us/cpp/build/reference/zm-specify-precompiled-header-memory-allocation-limit?view=msvc-160">/Zm (Specify precompiled header memory allocation limit)</a></p>
<table>
<thead>
<tr>
<th align="left">Value of <em><code>factor</code></em></th>
<th align="left">Memory allocation limit</th>
</tr>
</thead>
<tbody><tr>
<td align="left">10</td>
<td align="left">7.5 MB</td>
</tr>
<tr>
<td align="left">100</td>
<td align="left">75 MB</td>
</tr>
<tr>
<td align="left">200</td>
<td align="left">150 MB</td>
</tr>
<tr>
<td align="left">1000</td>
<td align="left">750 MB</td>
</tr>
<tr>
<td align="left">2000</td>
<td align="left">1500 MB</td>
</tr>
</tbody></table>
<p>而系统的虚拟内存大小是有上限的：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20220720113358.png"></p>
<p>如果进程数 * 每个进程的 <code>/zm</code> 大于系统的虚拟内存，会导致虚拟内存分配失败：</p>
<p>$TaskCount * PCHMemoryAllocationFactor &gt; SystemVirtualMemery$</p>
<p>也就出现了前面的问题。</p>
<p>解决这个问题的办法有两个：</p>
<ol>
<li>根据线程数 *750M 来设置系统的虚拟内存大小</li>
<li>限制并行的任务数量，避免大量的进程同时分配虚拟内存</li>
</ol>
<blockquote>
<p>注意：如果 <code>/zm</code> 值设置的太小，可能无法满足 UE 合并翻译单元的要求，导致编译错误，所以，最好还是修改系统虚拟内存大小或者控制并行的任务数量。</p>
</blockquote>
<p>通过编辑 <code>BuildConfiguration.xml</code> 就可以控制编译进程的 <code>/zm</code> 值，以及能够使用多少个 Task：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">xmlns</span>=<span class="string">&quot;https://www.unrealengine.com/BuildConfiguration&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">WindowsPlatform</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">PCHMemoryAllocationFactor</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">PCHMemoryAllocationFactor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">WindowsPlatform</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">LocalExecutor</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">MaxProcessorCount</span>&gt;</span>60<span class="tag">&lt;/<span class="name">MaxProcessorCount</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">LocalExecutor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ParallelExecutor</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">MaxProcessorCount</span>&gt;</span>60<span class="tag">&lt;/<span class="name">MaxProcessorCount</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ParallelExecutor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>按照 128*750M 的计算，在 Ryzen3990X 上，至少要设置 <code>94G</code> 的虚拟内存，才能够满足 UE 拉起 128 个进程编译的需要。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>BuildSystem</category>
      </categories>
      <tags>
        <tag>BuildSystem</tag>
        <tag>PCH</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 项目的编译流程</title>
    <url>/wiki/6362/</url>
    <content><![CDATA[<p>UE 通过 UBT 来构建项目(不管是 VS 里的 Build 也好，Editor 里的 Compile 也好，最终都会调用 UBT)。UBT 和 UHT 是 UE 工具链的基石，内容太多，没办法一次性分析全部，先梳理出一个大致的轮廓，有时间再慢慢补充。</p>
<span id="more"></span>
<p>先对 UBT 和 UHT 的工作职责有一个大概介绍：<br><strong>UBT</strong>：</p>
<ul>
<li>Scans solution directory for modules and plug-ins</li>
<li>Determines all modules that need to be rebuilt</li>
<li>Invokes UHT to parse C++ headers</li>
<li>Creates compiler &amp; linker options from .Build.cs &amp; .Target.cs</li>
<li>Executes platform specific compilers (VisualStudio, LLVM)</li>
</ul>
<p><strong>UHT</strong>：</p>
<ul>
<li>Parses all C++ headers containing UClasses</li>
<li>Generates glue code for all Unreal classes &amp; functions</li>
<li>Generated files stored in Intermediates directory</li>
</ul>
<h2 id="VS"><a href="#VS" class="headerlink" title="VS"></a>VS</h2><p>言归正传。首先，从零开始，第一步先创建一个 C++ 项目 (BasicCode/ThridPerson 任选)，并打开 VS。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/01_UECreateCppProject.webp"><br> 打开 VS 之后可以看到这样的 Solution 结构：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/02_UEProject_VS_SolutionLayout.webp"><br>在 Solution 中选中创建的 Project 点击 <strong> 右键 </strong>-<strong>Properties</strong>：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/03_UE_VS_Project_Properties.webp"><br> 可以看到，NMake-Gerneral 下的 <code> 构建命令 (Build Command)</code> 使用的均是 <code>Engine\Build\BatchFiles</code> 目录下的 bat(在 Windows 平台)：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># Build</span><br><span class="line">Engine\Build\BatchFiles\Build.bat</span><br><span class="line"># ReBuild</span><br><span class="line">Engine\Build\BatchFiles\Rebuild.bat</span><br><span class="line"># Clean</span><br><span class="line">Engine\Build\BatchFiles\Clean.bat</span><br></pre></td></tr></table></figure>
<p>以 Build.bat 为例：</p>
<figure class="highlight bat"><table><tr><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="built_in">setlocal</span> enabledelayedexpansion</span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">REM The %~dp0 specifier resolves to the path to the directory where this .bat is located in.</span></span><br><span class="line"><span class="comment">REM We use this so that regardless of where the .bat file was executed from, we can change to</span></span><br><span class="line"><span class="comment">REM directory relative to where we know the .bat is stored.</span></span><br><span class="line"><span class="built_in">pushd</span> &quot;%~dp0\..\..\Source&quot;</span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">REM %1 is the game name</span></span><br><span class="line"><span class="comment">REM %2 is the platform name</span></span><br><span class="line"><span class="comment">REM %3 is the configuration name</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">IF</span> <span class="keyword">EXIST</span> ..\..\Engine\Binaries\DotNET\UnrealBuildTool.exe (</span><br><span class="line">        ..\..\Engine\Binaries\DotNET\UnrealBuildTool.exe %* -DEPLOY</span><br><span class="line">		<span class="built_in">popd</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">		REM Ignore exit codes of 2 (&quot;ECompilationResult.UpToDate&quot;) from UBT; it&#x27;s not a failure.</span></span><br><span class="line">		<span class="keyword">if</span> &quot;<span class="variable">!ERRORLEVEL!</span>&quot;==&quot;<span class="number">2</span>&quot; (</span><br><span class="line">			<span class="keyword">EXIT</span> /B <span class="number">0</span></span><br><span class="line">		)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">EXIT</span> /B <span class="variable">!ERRORLEVEL!</span></span><br><span class="line">) <span class="keyword">ELSE</span> (</span><br><span class="line">	<span class="built_in">ECHO</span> UnrealBuildTool.exe <span class="keyword">not</span> found <span class="keyword">in</span> ..\..\Engine\Binaries\DotNET\UnrealBuildTool.exe</span><br><span class="line">	<span class="built_in">popd</span></span><br><span class="line">	<span class="keyword">EXIT</span> /B <span class="number">999</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>可以看到 <code>Build.bat</code> 将接收的参数都转发给了<code>UnrealBuildTool.exe</code>:</p>
<figure class="highlight bat"><table><tr><td class="code"><pre><span class="line">..\..\Engine\Binaries\DotNET\UnrealBuildTool.exe %*</span><br></pre></td></tr></table></figure>
<h2 id="UBT"><a href="#UBT" class="headerlink" title="UBT"></a>UBT</h2><p>通过 UnrealBuildTool 构建项目需要传递参数：</p>
<ol>
<li>%1 is the game name</li>
<li>%2 is the platform name</li>
<li>%3 is the configuration name</li>
<li>%4 is the ProjectPath</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># Example</span><br><span class="line">UnrealBuildTool.exe ThridPerson420 Win64 Development &quot;C:\Users\visionsmile\Documents\Unreal Projects\Examples\ThridPerson420\ThridPerson420.uproject&quot; -WaitMutex -FromMsBuild</span><br></pre></td></tr></table></figure>
<p>然后来看一下 UnrealBuildTools 是怎么处理的：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Engine\Source\Programs\UnrealBuildTools\UnrealBuildTool.cs</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">Main</span><span class="params">(string[] Arguments)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// make sure we catch any exceptions and return an appropriate error code.</span></span><br><span class="line">	<span class="comment">// Some inner code already does this (to ensure the Mutex is released),</span></span><br><span class="line">	<span class="comment">// but we need something to cover all outer code as well.</span></span><br><span class="line">	<span class="keyword">try</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">GuardedMain</span>(Arguments);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in"><span class="keyword">catch</span></span> (Exception Exception)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (Log.<span class="built_in">IsInitialized</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			Log.<span class="built_in">TraceError</span>(<span class="string">&quot;UnrealBuildTool Exception: &quot;</span> + Exception.<span class="built_in">ToString</span>());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (ExtendedErrorCode != <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> ExtendedErrorCode;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> (<span class="keyword">int</span>)ECompilationResult.OtherCompilationError;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/04_UnrealBuildTool_MainFunction.webp"><br>可以看到传入进来的参数。<br>在 GuardedMain 中对引擎和传入参数做了一堆检测之后，会调用<code>RunUBT</code>:<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/05_UnrealBuildTool_RunUBTFunction.webp"></p>
<h3 id="RulesAssembly"><a href="#RulesAssembly" class="headerlink" title="RulesAssembly"></a>RulesAssembly</h3><p>在 <code>RunUBT</code> 中，有一个相当重要的函数调用<code>UEBuildTarget.CreateTarget</code>：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Engine\Source\Programs\UnrealBuildTools\UnrealBuildTool.cs</span></span><br><span class="line"><span class="function">internal <span class="keyword">static</span> ECompilationResult <span class="title">RunUBT</span><span class="params">(BuildConfiguration BuildConfiguration, string[] Arguments, FileReference ProjectFile, <span class="keyword">bool</span> bCatchExceptions)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// other code...</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (UBTMakefile != null &amp;&amp; !bIsGatheringBuild &amp;&amp; bIsAssemblingBuild)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// If we&#x27;ve loaded a makefile, then we can fill target information from this file!</span></span><br><span class="line">		Targets = UBTMakefile.Targets;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		DateTime TargetInitStartTime = DateTime.UtcNow;</span><br><span class="line"></span><br><span class="line">		ReadOnlyBuildVersion Version = <span class="keyword">new</span> <span class="built_in">ReadOnlyBuildVersion</span>(BuildVersion.<span class="built_in">ReadDefault</span>());</span><br><span class="line"></span><br><span class="line">		Targets = <span class="keyword">new</span> List&lt;UEBuildTarget&gt;();</span><br><span class="line">		foreach (TargetDescriptor TargetDesc in TargetDescs)</span><br><span class="line">		&#123;</span><br><span class="line">			UEBuildTarget Target = UEBuildTarget.<span class="built_in">CreateTarget</span>(TargetDesc, Arguments, bSkipRulesCompile, BuildConfiguration.SingleFileToCompile != null, BuildConfiguration.bUsePrecompiled, Version);</span><br><span class="line">			<span class="keyword">if</span> ((Target == null) &amp;&amp; (BuildConfiguration.bCleanProject))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			Targets.<span class="built_in">Add</span>(Target);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (UnrealBuildTool.bPrintPerformanceInfo)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">double</span> TargetInitTime = (DateTime.UtcNow - TargetInitStartTime).TotalSeconds;</span><br><span class="line">			Log.<span class="built_in">TraceInformation</span>(<span class="string">&quot;Target init took &quot;</span> + TargetInitTime + <span class="string">&quot;s&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// other code ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>UEBuildTarget.CreateTarget</code>的定义在 <code>Configuration/UEBuildTarget.cs</code> 中。它在里面构造了一个 <code>RulesAssembly</code> 的对象，它是用来读取和构造项目中的 <code>target.cs</code> 和 Module 的 <code>build.cs</code> 的。<br><code>RulesAssembly</code>的构造调用栈如下：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/05-construct-rulesassembly.webp"></p>
<p><code>RulesAssembly</code>的构造函数接收了一堆参数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RulesAssembly</span><span class="params">(DirectoryReference BaseDir, IReadOnlyList&lt;PluginInfo&gt; Plugins, List&lt;FileReference&gt; ModuleFiles, List&lt;FileReference&gt; TargetFiles, Dictionary&lt;FileReference, PluginInfo&gt; ModuleFileToPluginInfo, FileReference AssemblyFileName, <span class="keyword">bool</span> bContainsEngineModules, <span class="keyword">bool</span> bUseBackwardsCompatibleDefaults, <span class="keyword">bool</span> bReadOnly, <span class="keyword">bool</span> bSkipCompile, RulesAssembly Parent</span></span></span><br></pre></td></tr></table></figure>

<ol>
<li>BaseDir：项目目录</li>
<li>Plugins：项目依赖的所有插件的 <code>.uplugin</code> 文件的绝对路径</li>
<li>ModuleFiles：是当前 Target 中的所有 Module(Game Module 和所有插件内的 Module)的 <code>.build.cs</code> 文件的绝对路径</li>
<li>TargetFiles：当前 Target 中所有的 <code>target.cs</code> 的文件绝对路径</li>
<li>ModuleFileToPluginInfo：插件的信息 map，Module 的 <code>build.cs</code> 文件与 Module 的基本信息<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/ruleassembly-constructor-param-moduleFileToPluginInfo.webp"></li>
<li>AssemblyFileName：项目的 BuildRules 的 DLL 文件绝对路径 (该文件位于(<code>Intermediate/Build/BuildRules</code> 下，是调用 <code>UnrealVersionSelector</code> 生成 VS 项目时创建的))</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// e.g</span><br><span class="line">C:\Users\imzlp\Documents\Unreal Projects\GWorld\Intermediate\Build\BuildRules\GWorldModuleRules.dll</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>其他参数(不是本篇文章的重点)</li>
</ol>
<p><code>RulesAssembly</code>类中定义了两个重要的成员：<code>TargetNameToTargetFile</code>和 <code>ModuleNameToModuleFile</code>，在构造函数中把当前的项目中中所有定义的<strong>TargetRules</strong> 和<strong>ModuleRules</strong>都添加到了里面。</p>
<p>下面是 <code>RulesAssembly</code> 的构造函数：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTool/System/RulesAssembly.cs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Constructor. Compiles a rules assembly from the given source files.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;BaseDir&quot;&gt;</span>The base directory for this assembly<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Plugins&quot;&gt;</span>All the plugins included in this assembly<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ModuleFiles&quot;&gt;</span>List of module files to compile<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;TargetFiles&quot;&gt;</span>List of target files to compile<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ModuleFileToPluginInfo&quot;&gt;</span>Mapping of module file to the plugin that contains it<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;AssemblyFileName&quot;&gt;</span>The output path for the compiled assembly<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;bContainsEngineModules&quot;&gt;</span>Whether this assembly contains engine modules. Used to initialize the default value for ModuleRules.bTreatAsEngineModule.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;bUseBackwardsCompatibleDefaults&quot;&gt;</span>Whether modules in this assembly should use backwards-compatible defaults.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;bReadOnly&quot;&gt;</span>Whether the modules and targets in this assembly are installed, and should be created with the bUsePrecompiled flag set<span class="doctag">&lt;/param&gt;</span> </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;bSkipCompile&quot;&gt;</span>Whether to skip compiling this assembly<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Parent&quot;&gt;</span>The parent rules assembly<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RulesAssembly</span>(<span class="params">DirectoryReference BaseDir, IReadOnlyList&lt;PluginInfo&gt; Plugins, List&lt;FileReference&gt; ModuleFiles, List&lt;FileReference&gt; TargetFiles, Dictionary&lt;FileReference, PluginInfo&gt; ModuleFileToPluginInfo, FileReference AssemblyFileName, <span class="built_in">bool</span> bContainsEngineModules, <span class="built_in">bool</span> bUseBackwardsCompatibleDefaults, <span class="built_in">bool</span> bReadOnly, <span class="built_in">bool</span> bSkipCompile, RulesAssembly Parent</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">this</span>.BaseDir = BaseDir;</span><br><span class="line">	<span class="keyword">this</span>.Plugins = Plugins;</span><br><span class="line">	<span class="keyword">this</span>.ModuleFileToPluginInfo = ModuleFileToPluginInfo;</span><br><span class="line">	<span class="keyword">this</span>.bContainsEngineModules = bContainsEngineModules;</span><br><span class="line">	<span class="keyword">this</span>.bUseBackwardsCompatibleDefaults = bUseBackwardsCompatibleDefaults;</span><br><span class="line">	<span class="keyword">this</span>.bReadOnly = bReadOnly;</span><br><span class="line">	<span class="keyword">this</span>.Parent = Parent;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Find all the source files</span></span><br><span class="line">	List&lt;FileReference&gt; AssemblySourceFiles = <span class="keyword">new</span> List&lt;FileReference&gt;();</span><br><span class="line">	AssemblySourceFiles.AddRange(ModuleFiles);</span><br><span class="line">	AssemblySourceFiles.AddRange(TargetFiles);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Compile the assembly</span></span><br><span class="line">	<span class="keyword">if</span> (AssemblySourceFiles.Count &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		List&lt;<span class="built_in">string</span>&gt; PreprocessorDefines = GetPreprocessorDefinitions();</span><br><span class="line">		CompiledAssembly = DynamicCompilation.CompileAndLoadAssembly(AssemblyFileName, AssemblySourceFiles, PreprocessorDefines: PreprocessorDefines, DoNotCompile: bSkipCompile);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Setup the module map</span></span><br><span class="line">	<span class="keyword">foreach</span> (FileReference ModuleFile <span class="keyword">in</span> ModuleFiles)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">string</span> ModuleName = ModuleFile.GetFileNameWithoutAnyExtensions();</span><br><span class="line">		<span class="keyword">if</span> (!ModuleNameToModuleFile.ContainsKey(ModuleName))</span><br><span class="line">		&#123;</span><br><span class="line">			ModuleNameToModuleFile.Add(ModuleName, ModuleFile);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Setup the target map</span></span><br><span class="line">	<span class="keyword">foreach</span> (FileReference TargetFile <span class="keyword">in</span> TargetFiles)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">string</span> TargetName = TargetFile.GetFileNameWithoutAnyExtensions();</span><br><span class="line">		<span class="keyword">if</span> (!TargetNameToTargetFile.ContainsKey(TargetName))</span><br><span class="line">		&#123;</span><br><span class="line">			TargetNameToTargetFile.Add(TargetName, TargetFile);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ignore other code..</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="编译环境：构造 Target 并执行"><a href="# 编译环境：构造 Target 并执行" class="headerlink" title="编译环境：构造 Target 并执行"></a>编译环境：构造 Target 并执行 </h3><p><code>Target</code> 的主要作用是收集和设定项目的编译信息用于编译真正的可执行程序的设置，类似于在 VS 中的项目设置。</p>
<p>在 <code>RunUBT</code> 中会对传入的参数（Platform/Configuration 等）做提取，并添加上一系列参数，之后通过调用 <code>UEBuildTarget.CreateTarget</code>，创建一个<code>UBuildTarget</code> 的对象：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"><span class="comment">// 执行 `target.cs` 中的逻辑，并构造出一个 URBduileTarget 对象</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> UEBuildTarget <span class="title">CreateTarget</span>(<span class="params">TargetDescriptor Desc, <span class="built_in">string</span>[] Arguments, <span class="built_in">bool</span> bSkipRulesCompile, <span class="built_in">bool</span> bCompilingSingleFile, <span class="built_in">bool</span> bUsePrecompiled, ReadOnlyBuildVersion Version</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  DateTime CreateTargetStartTime = DateTime.UtcNow;</span><br><span class="line"></span><br><span class="line">  RulesAssembly RulesAssembly = RulesCompiler.CreateTargetRulesAssembly(Desc.ProjectFile, Desc.Name, bSkipRulesCompile, bUsePrecompiled, Desc.ForeignPlugin);</span><br><span class="line"></span><br><span class="line">  FileReference TargetFileName;</span><br><span class="line">  TargetRules RulesObject = RulesAssembly.CreateTargetRules(Desc.Name, Desc.Platform, Desc.Configuration, Desc.Architecture, Desc.ProjectFile, Version, Arguments, <span class="keyword">out</span> TargetFileName);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>CreateTarget</code> 中又调用了 <code>RulesAssembly.CreateTargetRules</code>(获取<code>target.cs</code> 文件，以及将最基本的编译环境信息构造出 <code>TargetInfo</code> 并传递给 <code>CreateTargetRulesInstance</code> 用于创建 <code>TargetRules</code> 对象)：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTool/System/RulesAssembly.cs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Creates a target rules object for the specified target name.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;TargetName&quot;&gt;</span>Name of the target<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Platform&quot;&gt;</span>Platform being compiled<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Configuration&quot;&gt;</span>Configuration being compiled<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Architecture&quot;&gt;</span>Architecture being built<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ProjectFile&quot;&gt;</span>Path to the project file for this target<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Version&quot;&gt;</span>The current build version<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Arguments&quot;&gt;</span>Command line arguments for this target<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;TargetFileName&quot;&gt;</span>The original source file name of the Target.cs file for this target<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>The build target rules for the specified target<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> TargetRules <span class="title">CreateTargetRules</span>(<span class="params"><span class="built_in">string</span> TargetName, UnrealTargetPlatform Platform, UnrealTargetConfiguration Configuration, <span class="built_in">string</span> Architecture, FileReference ProjectFile, ReadOnlyBuildVersion Version, <span class="built_in">string</span>[] Arguments, <span class="keyword">out</span> FileReference TargetFileName</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ignore conditional check code...</span></span><br><span class="line">    </span><br><span class="line">  <span class="comment">// Return the target file name to the caller</span></span><br><span class="line">  TargetFileName = TargetNameToTargetFile[TargetName];</span><br><span class="line">  <span class="comment">// Currently, we expect the user&#x27;s rules object type name to be the same as the module name + &#x27;Target&#x27;</span></span><br><span class="line">  <span class="built_in">string</span> TargetTypeName = TargetName + <span class="string">&quot;Target&quot;</span>;</span><br><span class="line">  <span class="comment">// The build module must define a type named &#x27;&lt;TargetName&gt;Target&#x27; that derives from our &#x27;TargetRules&#x27; type.  </span></span><br><span class="line">  <span class="comment">// 通过构造 TargetInfo 对象，将基本的编译环境信息传递给 `target.cs` 中定义的构造函数</span></span><br><span class="line">  <span class="keyword">return</span> CreateTargetRulesInstance(TargetTypeName, <span class="keyword">new</span> TargetInfo(TargetName, Platform, Configuration, Architecture, ProjectFile, Version), Arguments);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获得项目的 <code>*.Target.cs</code> 文件，然后调用 <code>CreateTargetRulesInstance</code> 构造出一个 <code>TargetRules</code> 的对象（<code>target.cs</code>中构造的就是这个类型的对象），并执行 <code>target.cs</code> 中的构造函数中的代码。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTool/System/RulesAssembly.cs</span></span><br><span class="line"><span class="comment">// 获取定义在 target.cs 中的 TargetRules 对象，并调用其构造函数 </span></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Construct an instance of the given target rules</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;TypeName&quot;&gt;</span>Type name of the target rules<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;TargetInfo&quot;&gt;</span>Target configuration information to pass to the constructor<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Arguments&quot;&gt;</span>Command line arguments for this target<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>Instance of the corresponding TargetRules<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> TargetRules <span class="title">CreateTargetRulesInstance</span>(<span class="params"><span class="built_in">string</span> TypeName, TargetInfo TargetInfo, <span class="built_in">string</span>[] Arguments</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// The build module must define a type named &#x27;&lt;TargetName&gt;Target&#x27; that derives from our &#x27;TargetRules&#x27; type.  </span></span><br><span class="line">  Type RulesType = CompiledAssembly.GetType(TypeName);</span><br><span class="line">  <span class="keyword">if</span> (RulesType == <span class="literal">null</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">&quot;Expecting to find a type to be declared in a target rules named &#x27;&#123;0&#125;&#x27;.  This type must derive from the &#x27;TargetRules&#x27; type defined by Unreal Build Tool.&quot;</span>, TypeName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create an instance of the module&#x27;s rules object, and set some defaults before calling the constructor.</span></span><br><span class="line">  TargetRules Rules = (TargetRules)FormatterServices.GetUninitializedObject(RulesType);</span><br><span class="line">  Rules.bUseBackwardsCompatibleDefaults = bUseBackwardsCompatibleDefaults;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Find the constructor</span></span><br><span class="line">  ConstructorInfo Constructor = RulesType.GetConstructor(<span class="keyword">new</span> Type[] &#123; <span class="keyword">typeof</span>(TargetInfo) &#125;);</span><br><span class="line">  <span class="keyword">if</span>(Constructor == <span class="literal">null</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">&quot;No constructor found on &#123;0&#125; which takes an argument of type TargetInfo.&quot;</span>, RulesType.Name);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Invoke the regular constructor</span></span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">  &#123;</span><br><span class="line">    Constructor.Invoke(Rules, <span class="keyword">new</span> <span class="built_in">object</span>[] &#123; TargetInfo &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  catch (Exception Ex)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(Ex, <span class="string">&quot;Unable to instantiate instance of &#x27;&#123;0&#125;&#x27; object type from compiled assembly &#x27;&#123;1&#125;&#x27;.  Unreal Build Tool creates an instance of your module&#x27;s &#x27;Rules&#x27; object in order to find out about your module&#x27;s requirements.  The CLR exception details may provide more information:  &#123;2&#125;&quot;</span>, TypeName, Path.GetFileNameWithoutExtension(CompiledAssembly.Location), Ex.ToString());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ignore other code...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过上面的一波操作之后，我们现在已经从 <code>target.cs</code> 中得到了 <code>TargetRules</code> 对象，它代表了当前项目的编译环境，代码列了一堆，看着有点烦人，他们的调用栈如下：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/05-UBT-construct-TargetRule-callstack.webp"></p>
<h3 id="编译目标：Module"><a href="# 编译目标：Module" class="headerlink" title="编译目标：Module"></a>编译目标：Module</h3><p><code>Module</code>是 UE 中真正用来执行的一个个小目标文件，编译出 exe 或者 DLL（通过启动模块编译出 exe，非启动模块编译出 DLL，或者静态链接到 exe 中）。</p>
<p>在上面的执行完毕之后，UBT 会开始读取和分析项目中的<code>ModuleRules</code>，并通过它们构造出一个个<code>UEBuildModule</code>，用于后续的编译处理。</p>
<p>在 <code>RunUBT</code>-&gt;<code>UEBuildTarget.Build</code>-&gt;<code>PreBuidSetup</code>，可以理解真正的执行逻辑是在<code>PreBuildSetup</code> 中执行的：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Setup target before build. This method finds dependencies, sets up global environment etc.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PreBuildSetup</span>(<span class="params">UEToolChain TargetToolChain</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// Describe what&#x27;s being built.</span></span><br><span class="line">  Log.TraceVerbose(<span class="string">&quot;Building &#123;0&#125; - &#123;1&#125; - &#123;2&#125; - &#123;3&#125;&quot;</span>, AppName, TargetName, Platform, Configuration);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Setup the target&#x27;s binaries.</span></span><br><span class="line">  SetupBinaries();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Setup the target&#x27;s plugins</span></span><br><span class="line">  SetupPlugins();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Setup the custom build steps for this target</span></span><br><span class="line">  SetupCustomBuildSteps();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add the plugin binaries to the build</span></span><br><span class="line">  <span class="keyword">foreach</span> (UEBuildPlugin Plugin <span class="keyword">in</span> BuildPlugins)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">foreach</span>(UEBuildModuleCPP Module <span class="keyword">in</span> Plugin.Modules)</span><br><span class="line">    &#123;</span><br><span class="line">      AddModuleToBinary(Module);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add all of the extra modules, including game modules, that need to be compiled along</span></span><br><span class="line">  <span class="comment">// with this app.  These modules are always statically linked in monolithic targets, but not necessarily linked to anything in modular targets,</span></span><br><span class="line">  <span class="comment">// and may still be required at runtime in order for the application to load and function properly!</span></span><br><span class="line">  AddExtraModules();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create all the modules referenced by the existing binaries</span></span><br><span class="line">  <span class="keyword">foreach</span>(UEBuildBinary Binary <span class="keyword">in</span> Binaries)</span><br><span class="line">  &#123;</span><br><span class="line">    Binary.CreateAllDependentModules(FindOrCreateModuleByName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Bind every referenced C++ module to a binary</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="built_in">int</span> Idx = <span class="number">0</span>; Idx &lt; Binaries.Count; Idx++)</span><br><span class="line">  &#123;</span><br><span class="line">    List&lt;UEBuildModule&gt; DependencyModules = Binaries[Idx].GetAllDependencyModules(<span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (UEBuildModuleCPP DependencyModule <span class="keyword">in</span> DependencyModules.OfType&lt;UEBuildModuleCPP&gt;())</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span>(DependencyModule.Binary == <span class="literal">null</span>)</span><br><span class="line">      &#123;</span><br><span class="line">    AddModuleToBinary(DependencyModule);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add all the modules to the target if necessary.</span></span><br><span class="line">  <span class="keyword">if</span>(Rules.bBuildAllModules)</span><br><span class="line">  &#123;</span><br><span class="line">    AddAllValidModulesToTarget();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add the external and non-C++ referenced modules to the binaries that reference them.</span></span><br><span class="line">  <span class="keyword">foreach</span> (UEBuildModuleCPP Module <span class="keyword">in</span> Modules.Values.OfType&lt;UEBuildModuleCPP&gt;())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span>(Module.Binary != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">foreach</span> (UEBuildModule ReferencedModule <span class="keyword">in</span> Module.GetUnboundReferences())</span><br><span class="line">      &#123;</span><br><span class="line">    Module.Binary.AddModule(ReferencedModule);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!bCompileMonolithic)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (Platform == UnrealTargetPlatform.Win64 || Platform == UnrealTargetPlatform.Win32)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// On Windows create import libraries for all binaries ahead of time, since linking binaries often causes bottlenecks</span></span><br><span class="line">      <span class="keyword">foreach</span> (UEBuildBinary Binary <span class="keyword">in</span> Binaries)</span><br><span class="line">      &#123;</span><br><span class="line">    Binary.SetCreateImportLibrarySeparately(<span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// On other platforms markup all the binaries containing modules with circular references</span></span><br><span class="line">      <span class="keyword">foreach</span> (UEBuildModule Module <span class="keyword">in</span> Modules.Values.Where(x =&gt; x.Binary != <span class="literal">null</span>))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="built_in">string</span> CircularlyReferencedModuleName <span class="keyword">in</span> Module.Rules.CircularlyReferencedDependentModules)</span><br><span class="line">        &#123;</span><br><span class="line">          UEBuildModule CircularlyReferencedModule;</span><br><span class="line">          <span class="keyword">if</span> (Modules.TryGetValue(CircularlyReferencedModuleName, <span class="keyword">out</span> CircularlyReferencedModule) &amp;&amp; CircularlyReferencedModule.Binary != <span class="literal">null</span>)</span><br><span class="line">          &#123;</span><br><span class="line">        CircularlyReferencedModule.Binary.SetCreateImportLibrarySeparately(<span class="literal">true</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// On Mac AppBinaries paths for non-console targets need to be adjusted to be inside the app bundle</span></span><br><span class="line">  <span class="keyword">if</span> (Platform == UnrealTargetPlatform.Mac &amp;&amp; !Rules.bIsBuildingConsoleApplication)</span><br><span class="line">  &#123;</span><br><span class="line">    TargetToolChain.FixBundleBinariesPaths(<span class="keyword">this</span>, Binaries);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中的：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Setup the target&#x27;s binaries.</span></span><br><span class="line"><span class="comment">// 读取 LaunchModule, 要编译出来的可执行目标 exe，创建出启动模块的 UEBuildModuleCPP 和 UEBuildBinary(编译 exe)</span></span><br><span class="line"><span class="comment">// UEBuildBinary 只在这里被创建</span></span><br><span class="line"><span class="built_in">SetupBinaries</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Setup the target&#x27;s plugins</span></span><br><span class="line"><span class="comment">// 构造所有插件的 Module 并创建出编译对象 UEBuildModuleCPP</span></span><br><span class="line"><span class="built_in">SetupPlugins</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>它们直接或间接地又调用 <code>FindOrCreateCppModuleByName</code>，最终又会调用到<code>CreateModuleRulesAndSetDefaults</code> 来构造出真正的 <code>ModuleRules</code> 对象，并创建出 <code>UEBuildModuleCPP</code> 用于编译的模块：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/pre-create-modulerules.webp"></p>
<p><code>CreateModuleRulesAndSetDefaults</code>又调用了 <code>RulesAssembly.CreateModuleRules</code>（注意此时执行流已经又回到<code>RulesAssembly</code> 来了）。</p>
<p><code>RulesAssembly.CreateModuleRules</code>通过上面构造时存起来的 <code>ModuleNameToModuleFile</code> 通过 Module 名拿到 <code>*.build.cs</code> 文件，然后与调用 <code>TargetRules</code> 的构造方法一样调用 <code>ModuleRules</code> 的构造函数，并且将上面构造出来的 <code>TargetRules</code> 传递给<code>ModuleRules</code>。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Creates an instance of a module rules descriptor object for the specified module name</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ModuleName&quot;&gt;</span>Name of the module<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Target&quot;&gt;</span>Information about the target associated with this module<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ReferenceChain&quot;&gt;</span>Chain of references leading to this module<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>Compiled module rule info<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ModuleRules <span class="title">CreateModuleRules</span>(<span class="params"><span class="built_in">string</span> ModuleName, ReadOnlyTargetRules Target, <span class="built_in">string</span> ReferenceChain</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// Currently, we expect the user&#x27;s rules object type name to be the same as the module name</span></span><br><span class="line">  <span class="built_in">string</span> ModuleTypeName = ModuleName;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Make sure the module file is known to us</span></span><br><span class="line">  FileReference ModuleFileName;</span><br><span class="line">  <span class="keyword">if</span> (!ModuleNameToModuleFile.TryGetValue(ModuleName, <span class="keyword">out</span> ModuleFileName))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (Parent == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">&quot;Could not find definition for module &#x27;&#123;0&#125;&#x27; (referenced via &#123;1&#125;)&quot;</span>, ModuleName, ReferenceChain);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> Parent.CreateModuleRules(ModuleName, Target, ReferenceChain);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The build module must define a type named &#x27;Rules&#x27; that derives from our &#x27;ModuleRules&#x27; type.  </span></span><br><span class="line">  Type RulesObjectType = GetModuleRulesTypeInternal(ModuleName);</span><br><span class="line">  <span class="keyword">if</span> (RulesObjectType == <span class="literal">null</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">&quot;Expecting to find a type to be declared in a module rules named &#x27;&#123;0&#125;&#x27; in &#123;1&#125;.  This type must derive from the &#x27;ModuleRules&#x27; type defined by Unreal Build Tool.&quot;</span>, ModuleTypeName, CompiledAssembly.FullName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create an instance of the module&#x27;s rules object</span></span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Create an uninitialized ModuleRules object and set some defaults.</span></span><br><span class="line">    ModuleRules RulesObject = (ModuleRules)FormatterServices.GetUninitializedObject(RulesObjectType);</span><br><span class="line">    RulesObject.Name = ModuleName;</span><br><span class="line">    RulesObject.File = ModuleFileName;</span><br><span class="line">    RulesObject.Directory = ModuleFileName.Directory;</span><br><span class="line">    ModuleFileToPluginInfo.TryGetValue(RulesObject.File, <span class="keyword">out</span> RulesObject.Plugin);</span><br><span class="line">    RulesObject.bTreatAsEngineModule = bContainsEngineModules;</span><br><span class="line">    RulesObject.bUseBackwardsCompatibleDefaults = bUseBackwardsCompatibleDefaults &amp;&amp; Target.bUseBackwardsCompatibleDefaults;</span><br><span class="line">    RulesObject.bPrecompile = (RulesObject.bTreatAsEngineModule || ModuleName.Equals(<span class="string">&quot;UE4Game&quot;</span>, StringComparison.OrdinalIgnoreCase)) &amp;&amp; Target.bPrecompile;</span><br><span class="line">    RulesObject.bUsePrecompiled = bReadOnly;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Call the constructor</span></span><br><span class="line">    ConstructorInfo Constructor = RulesObjectType.GetConstructor(<span class="keyword">new</span> Type[] &#123; <span class="keyword">typeof</span>(ReadOnlyTargetRules) &#125;);</span><br><span class="line">    <span class="keyword">if</span>(Constructor == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">&quot;No valid constructor found for &#123;0&#125;.&quot;</span>, ModuleName);</span><br><span class="line">    &#125;</span><br><span class="line">    Constructor.Invoke(RulesObject, <span class="keyword">new</span> <span class="built_in">object</span>[] &#123; Target &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> RulesObject;</span><br><span class="line">  &#125;</span><br><span class="line">  catch (Exception Ex)</span><br><span class="line">  &#123;</span><br><span class="line">    Exception MessageEx = (Ex <span class="keyword">is</span> TargetInvocationException &amp;&amp; Ex.InnerException != <span class="literal">null</span>)? Ex.InnerException : Ex;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(Ex, <span class="string">&quot;Unable to instantiate module &#x27;&#123;0&#125;&#x27;: &#123;1&#125;\n(referenced via &#123;2&#125;)&quot;</span>, ModuleName, MessageEx.ToString(), ReferenceChain);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们在所有的 GameMode 与所有 Plugin 中的 <code>build.cs</code> 中的代码在此时执行。</p>
<h3 id="Launch 模块的编译"><a href="#Launch 模块的编译" class="headerlink" title="Launch 模块的编译"></a>Launch 模块的编译 </h3><p> 上面写到了编译 <code>Module</code>，有一个<code>Module</code> 很特殊，那就是 <code>Launch</code> 模块。</p>
<p>任何可执行程序都会有一个执行入口，在 UE 中，每一个 Target 都会编译出一个可执行程序。引擎启动是从 <code>Launch</code> 模块开始的，<code>main</code>函数也是定义在其中的，所以需要将 Launch 模块中的 main 函数编译出一个可执行程序来。</p>
<p>启动模块是在 <code>UBT</code> 的<code>TargetRules</code>中指定的：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> LaunchModuleName</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">get</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> (LaunchModuleNamePrivate == <span class="literal">null</span> &amp;&amp; Type != <span class="keyword">global</span>::UnrealBuildTool.TargetType.Program)? <span class="string">&quot;Launch&quot;</span> : LaunchModuleNamePrivate;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">set</span></span><br><span class="line">  &#123;</span><br><span class="line">    LaunchModuleNamePrivate = <span class="keyword">value</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以在 <code>TargetRules</code> 中使用 <code>LaunchModuleNamePrivate</code> 指定一个启动模块，如果 <strong> 没有指定 </strong> 且 Target 类型不为 <code>Program</code>，则使用<code>Launch</code> 模块，否则使用指定的模块。即不管是 Game/Editor/Server/Client 的 Target 启动模块都是 <code>Launch</code>。<br><strong> 但是 </strong>，因为<code>LaunchModuleNamePrivate</code> 在<code>TargetRules</code>的定义中是一个 <code>private</code> 成员，无法在我们继承来的 <code>TargetRules</code> 中赋值，所以目前也没有什么用。</p>
<p>在 <code>UEBuildTarget.SetupBinaries</code> 中被使用（上面也已经提到过了，<code>UEBuildBinary</code>就是我们要编译出的启动模块的可执行 exe 编译对象，并且只在这里被创建）：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Sets up the binaries for the target.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">SetupBinaries</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// If we&#x27;re using the new method for specifying binaries, fill in the binary configurations now</span></span><br><span class="line">  <span class="keyword">if</span>(Rules.LaunchModuleName == <span class="literal">null</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">&quot;LaunchModuleName must be set for all targets.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create the launch module</span></span><br><span class="line">  UEBuildModuleCPP LaunchModule = FindOrCreateCppModuleByName(Rules.LaunchModuleName, TargetRulesFile.GetFileName());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create the binary</span></span><br><span class="line">  UEBuildBinary Binary = <span class="keyword">new</span> UEBuildBinary(</span><br><span class="line">    Type: Rules.bShouldCompileAsDLL? UEBuildBinaryType.DynamicLinkLibrary : UEBuildBinaryType.Executable,</span><br><span class="line">    OutputFilePaths: OutputPaths,</span><br><span class="line">    IntermediateDirectory: (!LaunchModule.RulesFile.IsUnderDirectory(UnrealBuildTool.EngineDirectory) || ShouldCompileMonolithic()) ? ProjectIntermediateDirectory : EngineIntermediateDirectory,</span><br><span class="line">    bAllowExports: Rules.bHasExports,</span><br><span class="line">    PrimaryModule: LaunchModule,</span><br><span class="line">    bUsePrecompiled: LaunchModule.Rules.bUsePrecompiled &amp;&amp; OutputPaths[<span class="number">0</span>].IsUnderDirectory(UnrealBuildTool.EngineDirectory)</span><br><span class="line">    );</span><br><span class="line">  Binaries.Add(Binary);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add the launch module to it</span></span><br><span class="line">  LaunchModule.Binary = Binary;</span><br><span class="line">  Binary.AddModule(LaunchModule);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create an additional console app for the editor</span></span><br><span class="line">  <span class="keyword">if</span> (Platform == UnrealTargetPlatform.Win64 &amp;&amp; Configuration != UnrealTargetConfiguration.Shipping &amp;&amp; TargetType == TargetType.Editor)</span><br><span class="line">  &#123;</span><br><span class="line">    Binary.bBuildAdditionalConsoleApp = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行环境如下：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/ue-compile-launch-module-to-executable.webp"></p>
<p>可以看到这里的输出文件就是我们编译的项目 exe 了。</p>
<h2 id="UHT"><a href="#UHT" class="headerlink" title="UHT"></a>UHT</h2><p>之后会调用 UHT 来生成代码：<br>调用的函数为 <code>ExecuteHeaderToolIfNecessary</code>(System/ExternalExecution.cs):<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/06_UBT_Call_UHT.webp"><br> 如果上一步通过 UHT 生成成功，就会执行编译的 Action 了 (<code>ActionGraph.ExecuteActions</code> in System/ActionGraphs.cs)：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/07_UBT_ExecuteActions.webp"><br> 继续进入会检测一堆引擎的构建配置（e.g:Engine/Saved/UnrealBuildTool/BuildConfiguration.xml）：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/08_UBT_ExecuteActions.webp"><br>我这里保持的是引擎默认的构建配置，则创建了一个 <code>ParallelExecutor</code>(System/ParallelExecutor.cs)，然后执行：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/09_UBT_ActionGraph_ExecuteActions_CreateExecutor.webp"><br> 将当前的编译任务创建出多个 Action，并执行:<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/10_UBT_ActionGraph_ExecuteActions_CreateExecutor_Executing.webp"><br>开始编译代码：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/11_UBT_Real_Is_Building.webp"></p>
<h2 id="后记"><a href="# 后记" class="headerlink" title="后记"></a>后记 </h2><p> 根据上面的分析，UE 的 build 路径是：</p>
<ol>
<li>在 VS 中点击 Build，调用 build.bat</li>
<li>build.bat 中调用 UBT</li>
<li>UBT 执行 <code>target.cs</code> 和所有 Module 的 <code>build.cs</code> 中的逻辑</li>
<li>UBT 调用 UHT(根据 UE 的 <strong> 宏标记 </strong> 生成代码)</li>
<li>UHT 生成完毕后，UBT 调用编译器</li>
<li>预处理</li>
<li>编译</li>
<li>链接</li>
</ol>
<p>这个流程的关键点在：UBT 调用 UHT 生成的顺序是在调用编译器的预处理之前的，这意味着我们无法包裹 UE 的宏 (其实<code>UCLASS</code>/<code>UFUNCTION</code> 之类的不应该叫宏，应该叫 <strong> 标记</strong>)，因为 UE 的宏由 UHT 先于编译器预处理了。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>BuildSystem</category>
      </categories>
      <tags>
        <tag>BuildSystem</tag>
        <tag>UBT</tag>
      </tags>
  </entry>
  <entry>
    <title>target.cs 中检测是否是源码版引擎</title>
    <url>/wiki/3d4f2054/</url>
    <content><![CDATA[<p>可以从 <code>TargetRules</code> 中使用 <code>bIsEngineInstalled</code> 来检查。</p>
<p>它调用的是 <code>UnrealBuildTool.IsEngineInstalled()</code>，检测的也是<code>Engine/Build/InstalledBuild.txt</code> 文件是否存在。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// Expose a setting for whether or not the engine is installed</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">/// &lt;returns&gt;Flag for whether the engine is installed&lt;/returns&gt;</span><br><span class="line">public bool bIsEngineInstalled</span><br><span class="line">&#123;</span><br><span class="line">	get &#123; return UnrealBuildTool.IsEngineInstalled(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 UE4 与 5 中还有些区别，在 UE4 中调用的是 <code>UnrealBuildTool.IsEngineInstalled()</code>，定义在<code>UnrealBuildTool.cs</code>。<br> 在 UE5 中，调用的是 <code>Unreal.IsEngineInstalled()</code> 定义在<code>Unreal.cs</code>。</p>
<figure class="highlight csharp"><figcaption><span>UnrealBuildTool.cs or Unreal.cs(UE5)</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Returns true if UnrealBuildTool is running using installed Engine components</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>True if running using installed Engine components<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">IsEngineInstalled</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (!bIsEngineInstalled.HasValue)</span><br><span class="line">	&#123;</span><br><span class="line">		bIsEngineInstalled = FileReference.Exists(FileReference.Combine(EngineDirectory, <span class="string">&quot;Build&quot;</span>, <span class="string">&quot;InstalledBuild.txt&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> bIsEngineInstalled.Value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>BuildSystem</category>
      </categories>
      <tags>
        <tag>BuildSystem</tag>
        <tag>target.cs</tag>
      </tags>
  </entry>
  <entry>
    <title>代码编译时执行脚本</title>
    <url>/wiki/10758/</url>
    <content><![CDATA[<p>在插件的 <code>uplugin</code> 文件中可以写入 <code>PreBuildSteps/PostBuildSteps</code> 以下两个元素：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;PostBuildSteps&quot;</span>:</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;Win64&quot;</span>:</span><br><span class="line">    [</span><br><span class="line">      <span class="string">&quot;\&quot;$(PluginDir)\\Source\\AkAudio\\WwisePostBuildSteps.bat\&quot; \&quot;$(EngineDir)\\Binaries\\Win64\\UE4Editor-cmd.exe\&quot; \&quot;$(ProjectFile)\&quot; $(TargetType) -run=AkPluginActivator -platform=$(TargetPlatform) -configuration=Profile -targetconfig=$(TargetConfiguration)&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;PS4&quot;</span>:</span><br><span class="line">    [</span><br><span class="line">      <span class="string">&quot;\&quot;$(PluginDir)\\Source\\AkAudio\\WwisePostBuildSteps.bat\&quot; \&quot;$(EngineDir)\\Binaries\\Win64\\UE4Editor-cmd.exe\&quot; \&quot;$(ProjectFile)\&quot; -run=AkPluginActivator -platform=$(TargetPlatform) -configuration=Profile -targetconfig=$(TargetConfiguration)&quot;</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以在构建时指定自动执行一个脚本，用来处理一些特殊的功能。</p>
<p><code>ProjectDescriptor</code>的声明：Source\Programs\UnrealBuildTool\System\ProjectDescriptor.cs</p>
<p>在 UBT 的 <code>Source\Programs\UnrealBuildTool\Configuration\UEBuildTarget.cs</code> 中被解析:</p>
<figure class="highlight csharp"><figcaption><span>Source\Programs\UnrealBuildTool\Configuration\UEBuildTarget.cs</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Creates scripts for executing the pre-build scripts</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> FileReference[] <span class="title">CreatePreBuildScripts</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="comment">// Find all the pre-build steps</span></span><br><span class="line">  List &lt; Tuple &lt; <span class="built_in">string</span>[],</span><br><span class="line">  UEBuildPlugin &gt;&gt; PreBuildCommandBatches = <span class="keyword">new</span> List &lt; Tuple &lt; <span class="built_in">string</span>[],</span><br><span class="line">  UEBuildPlugin &gt;&gt; ();</span><br><span class="line">  <span class="keyword">if</span> (ProjectDescriptor != <span class="literal">null</span> &amp;&amp; ProjectDescriptor.PreBuildSteps != <span class="literal">null</span>) &#123;</span><br><span class="line">    AddCustomBuildSteps(ProjectDescriptor.PreBuildSteps, <span class="literal">null</span>, PreBuildCommandBatches);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (Rules.PreBuildSteps.Count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    PreBuildCommandBatches.Add(<span class="keyword">new</span> Tuple &lt; <span class="built_in">string</span>[], UEBuildPlugin &gt; (Rules.PreBuildSteps.ToArray(), <span class="literal">null</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">foreach</span>(UEBuildPlugin BuildPlugin <span class="keyword">in</span> BuildPlugins.Where(x =&gt;x.Descriptor.PreBuildSteps != <span class="literal">null</span>)) &#123;</span><br><span class="line">    AddCustomBuildSteps(BuildPlugin.Descriptor.PreBuildSteps, BuildPlugin, PreBuildCommandBatches);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> WriteCustomBuildStepScripts(BuildHostPlatform.Current.Platform, ProjectIntermediateDirectory, <span class="string">&quot;PreBuild&quot;</span>, PreBuildCommandBatches);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Creates scripts for executing post-build steps</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>Array of post-build scripts<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> FileReference[] <span class="title">CreatePostBuildScripts</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="comment">// Find all the post-build steps</span></span><br><span class="line">  List &lt; Tuple &lt; <span class="built_in">string</span>[],</span><br><span class="line">  UEBuildPlugin &gt;&gt; PostBuildCommandBatches = <span class="keyword">new</span> List &lt; Tuple &lt; <span class="built_in">string</span>[],</span><br><span class="line">  UEBuildPlugin &gt;&gt; ();</span><br><span class="line">  <span class="keyword">if</span> (!Rules.bDisableLinking) &#123;</span><br><span class="line">    <span class="keyword">if</span> (ProjectDescriptor != <span class="literal">null</span> &amp;&amp; ProjectDescriptor.PostBuildSteps != <span class="literal">null</span>) &#123;</span><br><span class="line">      AddCustomBuildSteps(ProjectDescriptor.PostBuildSteps, <span class="literal">null</span>, PostBuildCommandBatches);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Rules.PostBuildSteps.Count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      PostBuildCommandBatches.Add(<span class="keyword">new</span> Tuple &lt; <span class="built_in">string</span>[], UEBuildPlugin &gt; (Rules.PostBuildSteps.ToArray(), <span class="literal">null</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span>(UEBuildPlugin BuildPlugin <span class="keyword">in</span> BuildPlugins.Where(x =&gt;x.Descriptor.PostBuildSteps != <span class="literal">null</span>)) &#123;</span><br><span class="line">      AddCustomBuildSteps(BuildPlugin.Descriptor.PostBuildSteps, BuildPlugin, PostBuildCommandBatches);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> WriteCustomBuildStepScripts(BuildHostPlatform.Current.Platform, ProjectIntermediateDirectory, <span class="string">&quot;PostBuild&quot;</span>, PostBuildCommandBatches);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Adds custom build steps from the given JSON object to the list of command batches</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;BuildSteps&quot;&gt;</span>The custom build steps<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Plugin&quot;&gt;</span>The plugin to associate with these commands<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;CommandBatches&quot;&gt;</span>List to receive the command batches<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">AddCustomBuildSteps</span>(<span class="params">CustomBuildSteps BuildSteps, UEBuildPlugin Plugin, List &lt; Tuple &lt; <span class="built_in">string</span>[], UEBuildPlugin &gt;&gt; CommandBatches</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">string</span>[] Commands;</span><br><span class="line">  <span class="keyword">if</span> (BuildSteps.TryGetCommands(BuildHostPlatform.Current.Platform, <span class="keyword">out</span> Commands)) &#123;</span><br><span class="line">    CommandBatches.Add(Tuple.Create(Commands, Plugin));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Write scripts containing the custom build steps for the given host platform</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;HostPlatform&quot;&gt;</span>The current host platform<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Directory&quot;&gt;</span>The output directory for the scripts<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;FilePrefix&quot;&gt;</span>Bare prefix for all the created script files<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;CommandBatches&quot;&gt;</span>List of custom build steps, and their matching PluginInfo (if appropriate)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>List of created script files<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> FileReference[] <span class="title">WriteCustomBuildStepScripts</span>(<span class="params">UnrealTargetPlatform HostPlatform, DirectoryReference Directory, <span class="built_in">string</span> FilePrefix, List &lt; Tuple &lt; <span class="built_in">string</span>[], UEBuildPlugin &gt;&gt; CommandBatches</span>)</span> &#123;</span><br><span class="line">  List &lt; FileReference &gt; ScriptFiles = <span class="keyword">new</span> List &lt; FileReference &gt; ();</span><br><span class="line">  <span class="keyword">foreach</span>(Tuple &lt; <span class="built_in">string</span>[], UEBuildPlugin &gt; CommandBatch <span class="keyword">in</span> CommandBatches) &#123;</span><br><span class="line">    <span class="comment">// Find all the standard variables</span></span><br><span class="line">    Dictionary &lt; <span class="built_in">string</span>,</span><br><span class="line">    <span class="built_in">string</span> &gt; Variables = GetTargetVariables(CommandBatch.Item2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get the output path to the script</span></span><br><span class="line">    <span class="built_in">string</span> ScriptExtension = (HostPlatform == UnrealTargetPlatform.Win64) ? <span class="string">&quot;.bat&quot;</span>: <span class="string">&quot;.sh&quot;</span>;</span><br><span class="line">    FileReference ScriptFile = FileReference.Combine(Directory, String.Format(<span class="string">&quot;&#123;0&#125;-&#123;1&#125;&#123;2&#125;&quot;</span>, FilePrefix, ScriptFiles.Count + <span class="number">1</span>, ScriptExtension));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write it to disk</span></span><br><span class="line">    List &lt; <span class="built_in">string</span> &gt; Contents = <span class="keyword">new</span> List &lt; <span class="built_in">string</span> &gt; ();</span><br><span class="line">    <span class="keyword">if</span> (HostPlatform == UnrealTargetPlatform.Win64) &#123;</span><br><span class="line">      Contents.Insert(<span class="number">0</span>, <span class="string">&quot;@echo off&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="built_in">string</span> Command <span class="keyword">in</span> CommandBatch.Item1) &#123;</span><br><span class="line">      Contents.Add(Utils.ExpandVariables(Command, Variables));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!DirectoryReference.Exists(ScriptFile.Directory)) &#123;</span><br><span class="line">      DirectoryReference.CreateDirectory(ScriptFile.Directory);</span><br><span class="line">    &#125;</span><br><span class="line">    File.WriteAllLines(ScriptFile.FullName, Contents);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add the output file to the list of generated scripts</span></span><br><span class="line">    ScriptFiles.Add(ScriptFile);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ScriptFiles.ToArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在编译代码之后会执行指定的脚本，会有以下 Log：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2&gt;8&gt; Exec: PostBuild-1.bat.ran</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：测试中发现如果插件的代码没有变动，它不会执行。</p>
</blockquote>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>BuildSystem</category>
      </categories>
      <tags>
        <tag>BuildSystem</tag>
      </tags>
  </entry>
  <entry>
    <title>关闭 UnityBuild</title>
    <url>/wiki/36076/</url>
    <content><![CDATA[<p>默认情况下，UE 默认开启了 <code>bUseUnityBuild</code>，会把多个 cpp 合并成一个翻译单元进行编译，加快项目的编译速度，编译时有<code>*_1_of_8.cpp.obj</code> 等 log。所以如果项目的头文件包含不规范，编译时头文件检测可能会出现问题：修改了 A 文件导致 B 文件出现错误。</p>
<p>所以，想在检测出中这种错误，可以关闭<code>UnityBuild</code>，使每个 cpp 都作为单独的翻译单元编译，有两种方法：</p>
<ol>
<li>对整个工程（包含插件）关闭<code>bUseUnityBuild</code>，在项目的 Target.cs 中添加</li>
</ol>
<figure class="highlight cpp"><figcaption><span>target.cs</span></figcaption><table><tr><td class="code"><pre><span class="line">bForceUnityBuild = <span class="literal">false</span>;</span><br><span class="line">bUseUnityBuild = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
<p>不修改代码，也可以在 BuildCongiguration.xml 中配置关闭：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Whether to unify C++ code into larger files for faster compilation.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CommandLine(<span class="meta-string">&quot;-DisableUnity&quot;</span>, Value = <span class="meta-string">&quot;false&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">XmlConfigFile(Category = <span class="meta-string">&quot;BuildConfiguration&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">bool</span> bUseUnityBuild = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Whether to force C++ source files to be combined into larger files for faster compilation.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CommandLine(<span class="meta-string">&quot;-ForceUnity&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">XmlConfigFile(Category = <span class="meta-string">&quot;BuildConfiguration&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">bool</span> bForceUnityBuild = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>对单个模块关闭<code>UnityBuild</code>，在 Build.cs 中关闭</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">bUseUnity = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
<p>可以在 <code>Target.cs</code> 中指定关闭 UnityBuild 的模块，也可以配置在 <code>BuildConfiguration.xml</code> 中：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> List of modules to disable unity builds for</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">XmlConfigFile(Category = <span class="meta-string">&quot;ModuleConfiguration&quot;</span>, Name = <span class="meta-string">&quot;DisableUnityBuild&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span>[] DisableUnityBuildForModules = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<p>可以在 <code>Intermediate\Build\Win64\UE4Editor\Development\Client</code> 等路径下看到生成的大量 <code>.response</code> 文件。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>BuildSystem</category>
        <category>UnityBuild</category>
      </categories>
      <tags>
        <tag>BuildSystem</tag>
        <tag>UnityBuild</tag>
      </tags>
  </entry>
  <entry>
    <title>开启多核心编译</title>
    <url>/wiki/32770/</url>
    <content><![CDATA[<p>UBT 会从下面三个文件中读取配置：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">* Engine/Saved/UnrealBuildTool/BuildConfiguration.xml</span><br><span class="line">* *User Folder/AppData*/Roaming/Unreal Engine/UnrealBuildTool/BuildConfiguration.xml</span><br><span class="line">* *My Documents*/Unreal Engine/UnrealBuildTool/BuildConfiguration.xml</span><br></pre></td></tr></table></figure>

<p>我们只需要修改其中的任意一个就可以。</p>
<p>默认具有以下内容：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">xmlns</span>=<span class="string">&quot;https://www.unrealengine.com/BuildConfiguration&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>更多的 BuildConfigutation 的参数可以看引擎文档 <a href="https://docs.unrealengine.com/en-US/Programming/UnrealBuildSystem/Configuration/index.html">Configuring Unreal Build System</a>。在文档中<code>ProcessorCountMultiplier</code> 元素的数字就是允许使用的处理器数，<strong>但是 </strong>，UE 的文档和实际的代码有出入，按照上面的文档，设置<code>ProcessorCountMultiplier</code> 是在 <code>BuildConfigutation</code> 下的，但是这么写会与错误：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">xmlns</span>=<span class="string">&quot;https://www.unrealengine.com/BuildConfiguration&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">BuildConfiguration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ProcessorCountMultiplier</span>&gt;</span>7<span class="tag">&lt;/<span class="name">ProcessorCountMultiplier</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">BuildConfiguration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>错误信息：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">BuildConfiguration.xml(4): [] 元素 命名空间“https://www.unrealengine.com/BuildConfiguration”中的“BuildConfiguration”。 的子元素 命名空间“https://www.unrealengine.com/BuildConfiguration”中的“ProcessorCountMultiplier”。 无效。应为可能元素的列表: 命名空间“https://www.unrealengine.com/BuildConfiguration”中的“bPGOProfile, bAllowHybridExecutor, DMUCSDistProp, bAllowXGE, bGeneratedSYMFile, bAllowSNDBS, bIgnoreOutdatedImportLibraries, bUseFastSemanticsRenderContexts, bDisableDebugInfo, bParseTimingInfoForTracing, CppStandard, bPrintDebugInfo, bUseSharedPCHs, bDisableDebugInfoForGeneratedCode, bForcePrecompiledHeaderForGameModules, bUseShippingPhysXLibraries, bUseAdaptiveUnityBuild, bXGENoWatchdogThread, MinGameModuleSourceFilesForUnityBuild, bAdaptiveUnityDisablesOptimizations, bCheckLicenseViolations, bAllowParallelExecutor, bOmitFramePointers, bUseCheckedPhysXLibraries, bSupportEditAndContinue, bAllowASLRInShipping, bStripSymbols, bAllowDistcc, bVerboseDistccOutput, bUseInlining, bAllowDistccLocalFallback, bAdaptiveUnityEnablesEditAndContinue, bEnableMemorySanitizer, bCheckSystemHeadersForModification, bUseFastPDBLinking, bAdaptiveUnityDisablesProjectPCHForProjectPrivate, BaseLogFileName, bUsePerFileIntellisense, bCreateMapFile, bUsePCHFiles, DMUCSCoordinat...。</span><br></pre></td></tr></table></figure>

<p>查阅代码之后发现，这些配置选项要去看 <a href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Documentation/Source/Programming/UnrealBuildSystem/Configuration/BuildConfigProperties/BuildConfigProperties.INT.udn">BuildConfigProperties.INT.udn</a> 里的参数，<code>ProcessorCountMultiplier </code>是在 <code>ParallelExecutor</code> 下的，所以改成以下配置：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">xmlns</span>=<span class="string">&quot;https://www.unrealengine.com/BuildConfiguration&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ParallelExecutor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ProcessorCountMultiplier</span>&gt;</span>7<span class="tag">&lt;/<span class="name">ProcessorCountMultiplier</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">MaxProcessorCount</span>&gt;</span>7<span class="tag">&lt;/<span class="name">MaxProcessorCount</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bStopCompilationAfterErrors</span>&gt;</span>true<span class="tag">&lt;/<span class="name">bStopCompilationAfterErrors</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ParallelExecutor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>目前我使用的完整配置：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">xmlns</span>=<span class="string">&quot;https://www.unrealengine.com/BuildConfiguration&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">BuildConfiguration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ProcessorCountMultiplier</span>&gt;</span>7<span class="tag">&lt;/<span class="name">ProcessorCountMultiplier</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">MaxParallelActions</span>&gt;</span>7<span class="tag">&lt;/<span class="name">MaxParallelActions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bAllowParallelExecutor</span>&gt;</span>true<span class="tag">&lt;/<span class="name">bAllowParallelExecutor</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">BuildConfiguration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">SNDBS</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ProcessorCountMultiplier</span>&gt;</span>4<span class="tag">&lt;/<span class="name">ProcessorCountMultiplier</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">MaxProcessorCount</span>&gt;</span>4<span class="tag">&lt;/<span class="name">MaxProcessorCount</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">SNDBS</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ParallelExecutor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ProcessorCountMultiplier</span>&gt;</span>7<span class="tag">&lt;/<span class="name">ProcessorCountMultiplier</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">MaxProcessorCount</span>&gt;</span>7<span class="tag">&lt;/<span class="name">MaxProcessorCount</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bStopCompilationAfterErrors</span>&gt;</span>true<span class="tag">&lt;/<span class="name">bStopCompilationAfterErrors</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ParallelExecutor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>相关连接：</p>
<ul>
<li><a href="https://answers.unrealengine.com/questions/747044/view.html">How to use multiple processors for compiling?</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>BuildSystem</category>
      </categories>
      <tags>
        <tag>BuildSystem</tag>
      </tags>
  </entry>
  <entry>
    <title>引用 windows 头文件的警告 / 错误</title>
    <url>/wiki/34627/</url>
    <content><![CDATA[<p>有时候需要包含一些平台相关的代码，如 <code>windows.h</code> 里面包含了很多头文件，其中一些定义了很多宏，如：</p>
<figure class="highlight cpp"><figcaption><span>fileapi.h</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> UNICODE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DeleteFile  DeleteFileW</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DeleteFile  DeleteFileA</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// !UNICODE</span></span></span><br></pre></td></tr></table></figure>
<p>如果我们同时在代码中包含了 <code>windows.h</code> 和使用了 <code>IPlatformFile</code> 的接口来调用它的 <code>DeleteFile</code> 函数，因为 <code>DeleteFile</code> 被定义成了宏，所以在预处理阶段就会被替换，导致编译时访问 <code>IPlatformFile</code> 的<code>DeleteFileW</code>成员，但实际上它是不存在的，就产生了以下编译错误：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">error C2039: &#x27;DeleteFileW&#x27;: is not a member of &#x27;IPlatformFile&#x27;</span><br></pre></td></tr></table></figure>
<p>解决办法就是不直接包含 <code>windows.h</code> 而是使用以下封装：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Windows/AllowWindowsPlatformTypes.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;windows.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Windows/HideWindowsPlatformTypes.h&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>这样可以避免污染 UE 的符号名字。</p>
<p>UE 的文档中也有介绍：<a href="https://docs.unrealengine.com/zh-CN/ProductionPipelines/BuildTools/UnrealBuildTool/ThirdPartyLibraries/index.html">第三方库 #故障排除</a></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>BuildSystem</category>
        <category>UBT</category>
      </categories>
      <tags>
        <tag>BuildSystem</tag>
        <tag>UBT</tag>
      </tags>
  </entry>
  <entry>
    <title>接收命令行参数控制程序编译行为</title>
    <url>/wiki/29447/</url>
    <content><![CDATA[<p>在 build.cs 以及 target.cs 中可以获取命令行参数，对编译选项进行控制：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">string</span>[] CmdArgs = Environment.GetCommandLineArgs();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="built_in">string</span> CmdLineArg <span class="keyword">in</span> CmdArgs)</span><br><span class="line">&#123;</span><br><span class="line">    Console.WriteLine(<span class="string">&quot;CmdLineArg: &quot;</span> + CmdLineArg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译时输出：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0&gt;E:\UnrealEngine\Launcher\UE_4.26\Engine\Build\BatchFiles\Build.bat GWorldEditor Win64 Development -Project=&quot;E:\UnrealProjects\GWorld\GWorld.uproject&quot; -WaitMutex -FromMsBuild -test</span><br><span class="line">0&gt;CmdLineArg: ..\..\Engine\Binaries\DotNET\UnrealBuildTool.exe</span><br><span class="line">0&gt;CmdLineArg: GWorldEditor</span><br><span class="line">0&gt;CmdLineArg: Win64</span><br><span class="line">0&gt;CmdLineArg: Development</span><br><span class="line">0&gt;CmdLineArg: -Project=E:\UnrealProjects\GWorld\GWorld.uproject</span><br><span class="line">0&gt;CmdLineArg: -WaitMutex</span><br><span class="line">0&gt;CmdLineArg: -FromMsBuild</span><br><span class="line">0&gt;CmdLineArg: -test</span><br></pre></td></tr></table></figure>
<p>基于传递的参数可以动态地修改编译行为，比如添加宏、依赖的模块等。</p>
<p>以动态开启 ASAN 的方法，开启 ADDRESS SANITIZER，可以更好的进行内存异常访问分析：<a href="https://ue4daily.com/blog/ios-address-sanitizer-UE4">iOS Address Sanitizer in UE4</a></p>
<p>在 Target.cs 中开启：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">Environment.SetEnvironmentVariable(<span class="string">&quot;ENABLE_ADDRESS_SANITIZER&quot;</span>, <span class="string">&quot;YES&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>使用命令行控制在打包阶段是否开启 ASAN：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">string[] CmdArgs = Environment.GetCommandLineArgs();</span><br><span class="line">foreach (string CmdLineArg in CmdArgs)</span><br><span class="line">&#123;</span><br><span class="line">	if (CmdLineArg.Equals(&quot;-asan&quot;))</span><br><span class="line">	&#123;</span><br><span class="line">		if (Target.Platform == UnrealTargetPlatform.Mac || </span><br><span class="line">		    Target.Platform == UnrealTargetPlatform.IOS)</span><br><span class="line">		&#123;</span><br><span class="line">			Environment.SetEnvironmentVariable(&quot;ENABLE_ADDRESS_SANITIZER&quot;, &quot;YES&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在打包时传递 <code>-asan</code> 参数给 UBT 即可，</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>BuildSystem</category>
      </categories>
      <tags>
        <tag>BuildSystem</tag>
        <tag>TargetRules</tag>
      </tags>
  </entry>
  <entry>
    <title>构建支持多平台打包的二进制引擎</title>
    <url>/wiki/11956/</url>
    <content><![CDATA[<p>通常，UE4 开发者获取 UE4 引擎的方式有两种：</p>
<ol>
<li>从 Epic Games Launcher 安装</li>
<li>从 Github 上 Clone 代码本地编译</li>
</ol>
<p>从 EpicGamesLauncher 安装的是公版引擎，不能修改代码重新编译，可以在根据选择安装支持的平台、调试符号等。<br>自己从 Github 上 Clone 代码进行编译的则是源码版引擎，有些功能只能在源码版中使用（比如 Standalone Application），但是如果在项目中修改了引擎的代码，导致每个人都需要 Clone 一遍源码编译一遍引擎，这个过程十分耗时，而且源码版引擎的占用的磁盘空间十分巨大，达到上百 G。在当需要把引擎部署到多台构建机时，编译引擎的时间和空间是冗余的，所以需要通过一台机器编译引擎，然后其他的机器只需要拉取编译后的引擎即可，实现与安装版引擎一样的行为。</p>
<p>本篇文章主要介绍 BuildGraph 的工作流程，以及对引擎默认构建脚本 <code>InstalledEngineBuild.xml</code> 的分析；如何使用 BuildGraph 从源码配置、编译并导出支持 Android/IOS 打包的二进制引擎、以及如何裁剪和加速整个的构建流程。</p>
<span id="more"></span>

<p>UE 提供了 BuildGraph 功能使我们可以从源码中构建出和 Epic Game Launcher 相同的安装版引擎。</p>
<p>使用参数如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">RunUAT.bat BuildGraph -target=<span class="string">&quot;Make Installed Build Win64&quot;</span> -script=Engine/Build/InstalledEngineBuild.xml -<span class="built_in">set</span>:WithMac=<span class="literal">false</span> -<span class="built_in">set</span>:WithAndroid=<span class="literal">false</span> -<span class="built_in">set</span>:WithIOS=<span class="literal">false</span> -<span class="built_in">set</span>:WithTVOS=<span class="literal">false</span> -<span class="built_in">set</span>:WithLinux=<span class="literal">false</span> -<span class="built_in">set</span>:WithHTML5=<span class="literal">false</span> -<span class="built_in">set</span>:WithSwitch=<span class="literal">false</span> -WithDDC=<span class="literal">false</span> -<span class="built_in">set</span>:WithWin32=<span class="literal">false</span> -<span class="built_in">set</span>:WithLumin=<span class="literal">false</span> -<span class="built_in">set</span>:WithPS4=<span class="literal">false</span> -<span class="built_in">set</span>:WithXboxOne=<span class="literal">false</span> -<span class="built_in">set</span>:WithHoloLens=<span class="literal">false</span> -<span class="built_in">set</span>:GameConfigurations=Development</span><br></pre></td></tr></table></figure>

<p>通过 <code>BuildGraph</code> 来执行 <code>InstalledEngineBuild.xml</code> 脚本中的 <code>Make Installed Build Win64</code> 实现，引擎编译、导出二进制的一条龙流程。</p>
<p>但是这样有几个问题：默认这样构建出来的只能够打包 Windows，不能打包 Android/IOS。</p>
<p>如何构建 Android/IOS 的二进制引擎，暂时先按下不表，首先先来分析一下 UE 默认的 <code>InstalledEngineBuild.xml</code> 脚本。</p>
<h2 id="优化 BuildGraph 的构建流程"><a href="# 优化 BuildGraph 的构建流程" class="headerlink" title="优化 BuildGraph 的构建流程"></a>优化 BuildGraph 的构建流程 </h2><p><code>InstalledEngineBuild.xml</code> 是位于引擎的 <code>Engine/Build/</code> 目录下的 BuildGraph 的构建脚本，主要实现了通过代码导出二进制引擎的功能，支持了很多的平台。BuildGraph 的官方介绍和语法：<a href="https://docs.unrealengine.com/zh-CN/Programming/BuildTools/AutomationTool/BuildGraph/index.html">BuildGraph</a>。</p>
<p>我们主要使用<code>Make Installed Build Win64</code>，是它的一个 Node 实现。</p>
<p>主要流程如下：</p>
<ol>
<li>编译 UBT 等构建工具</li>
<li>编译 NotForLicence 工具</li>
<li>编译 Editor</li>
<li>编译支持的平台（默认 Win64）</li>
<li>Make Feature Packs</li>
<li>拷贝构建结果</li>
</ol>
<p>而且，经过分析<code>Make Installed Build Win64</code>，发现它其中有很多重复执行的编译流程。</p>
<p>以编译 <code>UE4Game Win64</code> 为例：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Node</span> <span class="attr">Name</span>=<span class="string">&quot;Compile UE4Game Win64&quot;</span> <span class="attr">Requires</span>=<span class="string">&quot;Compile UnrealHeaderTool Win64&quot;</span> <span class="attr">Produces</span>=<span class="string">&quot;#UE4Game Win64;#UE4Game Win64 Unstripped;#UE4Game Win64 Stripped;#UE4Game Win64 Unsigned;#UE4Game Win64 Signed&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">ForEach</span> <span class="attr">Name</span>=<span class="string">&quot;Target&quot;</span> <span class="attr">Values</span>=<span class="string">&quot;UE4Game;$(OptionalClientTarget);$(OptionalServerTarget)&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">ForEach</span> <span class="attr">Name</span>=<span class="string">&quot;Configuration&quot;</span> <span class="attr">Values</span>=<span class="string">&quot;$(GameConfigurations)&quot;</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">Compile</span> <span class="attr">Target</span>=<span class="string">&quot;$(Target)&quot;</span> <span class="attr">Platform</span>=<span class="string">&quot;Win64&quot;</span> <span class="attr">Configuration</span>=<span class="string">&quot;$(Configuration)&quot;</span> <span class="attr">Tag</span>=<span class="string">&quot;#UE4Game Win64&quot;</span> <span class="attr">Arguments</span>=<span class="string">&quot;-precompile -allmodules -nolink $(VSCompilerArg) $(TargetDebugInfoArg)&quot;</span>/&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">Compile</span> <span class="attr">Target</span>=<span class="string">&quot;$(Target)&quot;</span> <span class="attr">Platform</span>=<span class="string">&quot;Win64&quot;</span> <span class="attr">Configuration</span>=<span class="string">&quot;$(Configuration)&quot;</span> <span class="attr">Tag</span>=<span class="string">&quot;#UE4Game Win64&quot;</span> <span class="attr">Arguments</span>=<span class="string">&quot;-precompile $(VSCompilerArg) $(TargetDebugInfoArg)&quot;</span> <span class="attr">Clean</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">ForEach</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">ForEach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Node</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到，针对同一个编译的 Target，使用不同的编译参数执行了两次：</p>
<ol>
<li>具有 <code>-allmodules</code>、<code>-nolink</code> 等参数</li>
<li>不具有上述参数</li>
</ol>
<p>而开启了 <code>-allmodules</code>，则意味着引擎中所有的模块都要重新编译，是完整地编译引擎。当下次执行，还是要完整地编译整个引擎，UBT 中具有对<code>-allmodules</code> 的介绍：</p>
<p><code>-allmodules</code>参数是定义在 UBT 的 <code>TargetRules.cs</code> 中的：</p>
<figure class="highlight csharp"><figcaption><span>UnrealBuildTool/Configuration/TargetRules.cs</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Build all the modules that are valid for this target type. Used for CIS and making installed engine builds.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CommandLine(<span class="meta-string">&quot;-AllModules&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">bool</span> bBuildAllModules = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
<p>专门用来构建安装版引擎的，我觉得可以关掉，使用增量编译的方式执行，不然在 ci 上每次执行都太慢了。</p>
<p>而且这个脚本中对每个平台都执行了两遍，一遍是不含 <code>-nolink</code> 参数的，一遍是包含 <code>-nolink</code> 参数的，可以根据自己的需求决定是否关闭。<br>UE 的文档中是这么介绍的(<a href="https://www.unrealengine.com/en-US/blog/unreal-engine-4-14-released">Unreal Engine 4.14 Released!</a>)：</p>
<blockquote>
<p>New: Added a -nolink command line option for Unreal Build Tool, which enables compiling a target without linking it. This is useful for automated build tests, such as non-unity compiles.</p>
</blockquote>
<p>当使用 BuildGraph 来构建引擎的时候，默认情况下对引擎的编译次数计算公式：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UE4Editor DebugGame/Development 2 次</span><br><span class="line">UE4Game Win64/Android/IOS/...   每个平台 2*Configuration 次（-allmodules -nolink）</span><br></pre></td></tr></table></figure>
<p>如果我们使用 BuildGraph 通过 <code>Make Installed Build Win64</code> 来构建出安装版引擎（支持 Win/Android/IOS 打包），至少需要编译<code>2+3*2=8</code>，对引擎的代码要编译八次！而且每一次执行都要完整的编译所有的模块，耗时非常之长。</p>
<p>所以裁剪是非常有必要的，上面也已经提到了：</p>
<ol>
<li>去掉 <code>-allmodules</code> 参数，增量编译</li>
<li>去掉 <code>-nolink</code> 的构建（根据需求决定）</li>
<li>减少需要构建的平台</li>
</ol>
<p>裁剪之后需要需要编译的次数：</p>
<ol>
<li>UE4Editor Development 1 次</li>
<li>UE4Game Win64/Android/IOS/…   每个平台 <code>1*Configuration</code> 次</li>
</ol>
<p>则需要编译 4 次，与默认减少一倍，并且可以增量编译，时间会快很多了。</p>
<h2 id="构建引擎支持 Android 打包"><a href="# 构建引擎支持 Android 打包" class="headerlink" title="构建引擎支持 Android 打包"></a>构建引擎支持 Android 打包 </h2><p> 想要使用 <code>Make Installed Build Win64</code> 构建出支持 Android 打包的引擎，需要在执行 BuildGraph 脚本时添加 <code>-set:WithAndroid=true</code>，因为<code>WithAndroid</code> 是<code>InstalledEngineBuild.xml</code>中定义的参数，可以通过命令行传递。</p>
<p>不过，仅仅是命令行指定开启是不够的，在执行 BuildGraph 之前，需要安装好 Android 的开发环境，在 BuildGraph 在执行编译时会去系统 PATH 里查找 JDK/Android NDK/Android SDK 以及 <code>gradle</code> 的路径，需要自己进行预先配置：</p>
<p><strong>注意</strong>：虽然在执行编译时会检测环境自动下载 gradle，但是由于在墙内的原因，不一定会下载成功。</p>
<p>需要把 Android 的环境按照添加至系统的环境变量中：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/11956/20201105155939.webp"></p>
<p><strong>注意</strong>：当使用一些 ci 工具的时候，ci 只能查到服务启动的用户的环境变量，为避免额外的问题，最好添加至系统的环境变量。</p>
<p>默认情况下会编译出支持打包 Android 架构为 <code>armv7</code> 和<code>arm64</code>的引擎，如果不需要其中的某个架构，可以在 <code>InstalledEngineBuild.xml</code> 里选择注释掉指定的平台。</p>
<p>Android 比较简单，配置完 Android 的开发环境就可以直接导出可以打包 Android 的引擎：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/11956/20201105094329.webp"></p>
<h2 id="构建引擎支持 IOS 打包"><a href="# 构建引擎支持 IOS 打包" class="headerlink" title="构建引擎支持 IOS 打包"></a>构建引擎支持 IOS 打包 </h2><p> 前面已经提到了，构建支持 Android 打包的二进制引擎，支持 IOS 平台要更复杂一些。</p>
<p>首先构建支持 IOS 打包的引擎必须要有一台 Mac 执行远程构建，因为 BuildGraph 需要编译 IOS 平台的 UE4Game，在 Win 上无法编译 IOS 的库，所以必须要一台 Mac。</p>
<ol>
<li>局域网中有一台可访问的 Mac</li>
<li>具有 mobileprovision</li>
<li>生成 SSH Key</li>
</ol>
<p>至于“为什么有了 Mac 还需要在 Win 上支持 IOS？”这个问题主要是因为：</p>
<ol>
<li>Mac 机能受限，直接在 Mac 上打包是编译 +Cook 的操作都在 Mac 上，如果进行远程构建，则 Mac 只需要处理代码的编译，而不需要执行 Cook 的流程，降低对 Mac 机能的依赖，可以提高构建的效率。</li>
<li>统一地使用 Win 来构建出全平台包（Win/Android/IOS）</li>
</ol>
<p>首先需要在 Win 上生成 Mac 的 SSH Keys，BuildGraph 编译引擎支持 IOS 也需要设置 ssh key，生成的方法在我之前的博客中有记录，不再赘述：<a href="https://imzlp.com/posts/1948/#%E9%85%8D%E7%BD%AE%E8%BF%9C%E7%A8%8B%E6%9E%84%E5%BB%BA">UE4 开发笔记：Mac/iOS 篇 #配置远程构建</a></p>
<p>当生成了 SSHkey 之后，需要在引擎的 <code>Engine/Config/BaseEngine.ini</code> 中修改以下配置：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[/Script/IOSRuntimeSettings.IOSRuntimeSettings]</span></span><br><span class="line"><span class="attr">RemoteServerName</span>=</span><br><span class="line"><span class="attr">RSyncUsername</span>=</span><br><span class="line"><span class="attr">SSHPrivateKeyOverridePath</span>=</span><br><span class="line"><span class="attr">mobileprovision</span>=</span><br><span class="line">SigningCertificate=</span><br></pre></td></tr></table></figure>
<p>注意：这里的 mobileprovision 和 SigningCertificate 指定名字就可以，如：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">MobileProvision</span>=com.XXXX.XXXX.fmgame_Development_SignProvision.mobileprovision</span><br><span class="line"><span class="attr">SigningCertificate</span>=iPhone Developer: Created via API (JDPXHYVWYZ)</span><br></pre></td></tr></table></figure>
<p>并且，可以不指定 <code>SSHPrivateKeyOverridePath</code> 的路径，在 <code>RemoteMac.cs</code> 中，针对引擎目录有三个自动查找的路径：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (ProjectFile != <span class="literal">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">	Locations.Add(DirectoryReference.Combine(ProjectFile.Directory, <span class="string">&quot;Build&quot;</span>, <span class="string">&quot;NotForLicensees&quot;</span>));</span><br><span class="line">	Locations.Add(DirectoryReference.Combine(ProjectFile.Directory, <span class="string">&quot;Build&quot;</span>, <span class="string">&quot;NoRedist&quot;</span>));</span><br><span class="line">	Locations.Add(DirectoryReference.Combine(ProjectFile.Directory, <span class="string">&quot;Build&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>把 SSH Key 按照这样的命名格式放到这三个目录下即可：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SSHKeys/IP_ADDR/USER_NAME/RemoteToolChainPrivate.key</span><br></pre></td></tr></table></figure>
<p>如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SSHKeys/192.168.1.123/buildmachine/RemoteToolChainPrivate.key</span><br></pre></td></tr></table></figure>

<h3 id="远程构建的 UBT 路径异常"><a href="# 远程构建的 UBT 路径异常" class="headerlink" title="远程构建的 UBT 路径异常"></a>远程构建的 UBT 路径异常 </h3><p> 在执行时 <code>RemoteMac.cs</code> 中报错的问题：</p>
<figure class="highlight csharp"><figcaption><span>// RemoteMac.cs</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Attempts to get the SSH private key from the standard locations</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;OutPrivateKey&quot;&gt;</span>If successful, receives the location of the private key that was found<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>True if a private key was found, false otherwise<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">TryGetSshPrivateKey</span>(<span class="params"><span class="keyword">out</span> FileReference OutPrivateKey</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Build a list of all the places to look for a private key</span></span><br><span class="line">	List&lt;DirectoryReference&gt; Locations = <span class="keyword">new</span> List&lt;DirectoryReference&gt;();</span><br><span class="line">	Locations.Add(DirectoryReference.Combine(DirectoryReference.GetSpecialFolder(Environment.SpecialFolder.ApplicationData), <span class="string">&quot;Unreal Engine&quot;</span>, <span class="string">&quot;UnrealBuildTool&quot;</span>));</span><br><span class="line">	Locations.Add(DirectoryReference.Combine(DirectoryReference.GetSpecialFolder(Environment.SpecialFolder.Personal), <span class="string">&quot;Unreal Engine&quot;</span>, <span class="string">&quot;UnrealBuildTool&quot;</span>));</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码在 Combine 时没有做检测，<code>Environment.SpecialFolder.ApplicationData</code>这个路径是不一定能得到的，所以要修改 UBT 的 <code>RemoteMac.cs</code> 中的这部分代码，进行检测：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">TryGetSshPrivateKey</span>(<span class="params"><span class="keyword">out</span> FileReference OutPrivateKey</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Build a list of all the places to look for a private key</span></span><br><span class="line">	List&lt;DirectoryReference&gt; Locations = <span class="keyword">new</span> List&lt;DirectoryReference&gt;();</span><br><span class="line">	DirectoryReference ApplicationData = DirectoryReference.GetSpecialFolder(Environment.SpecialFolder.ApplicationData);</span><br><span class="line"></span><br><span class="line">	DirectoryReference Personal = DirectoryReference.GetSpecialFolder(Environment.SpecialFolder.Personal);</span><br><span class="line">	<span class="keyword">if</span>(ApplicationData != <span class="literal">null</span>)</span><br><span class="line">		Locations.Add(DirectoryReference.Combine(ApplicationData, <span class="string">&quot;Unreal Engine&quot;</span>, <span class="string">&quot;UnrealBuildTool&quot;</span>));</span><br><span class="line">	<span class="keyword">if</span>(Personal != <span class="literal">null</span>)</span><br><span class="line">		Locations.Add(DirectoryReference.Combine(Personal, <span class="string">&quot;Unreal Engine&quot;</span>, <span class="string">&quot;UnrealBuildTool&quot;</span>));</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上一步的操作，只能解决找 ssh key 时的路径报错问题。</p>
<h3 id="远程构建时 SSH 连接错误"><a href="# 远程构建时 SSH 连接错误" class="headerlink" title="远程构建时 SSH 连接错误"></a>远程构建时 SSH 连接错误 </h3><p> 解决了这个问题还有另外一个问题：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">****** [4/11] Compile UnrealHeaderTool Mac</span><br><span class="line"></span><br><span class="line">Reading local file list from C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Saved\BuildGraph\Update Version Files\Tag-Update Version Files.xml</span><br><span class="line">Running: C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Binaries\DotNET\UnrealBuildTool.exe UnrealHeaderTool Mac Development  -NoUBTMakefiles -nobuilduht -precompile -allmodules -Manifest=C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Intermediate\Build\Manifest.xml -NoHotReload -log=&quot;C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Programs\AutomationTool\Saved\Logs\UBT-UnrealHeaderTool-Mac-Development.txt&quot;</span><br><span class="line">  [Remote] Using remote server &#x27;xx.xx.xx.xx&#x27; on port 2222 (user &#x27;buildmachine&#x27;)</span><br><span class="line">  [Remote] Using private key at C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Build\NotForLicensees\SSHKeys\xx.xx.xx.xx\buildmachine\RemoteToolChainPrivate.key</span><br><span class="line">  ERROR: Unable to determine home directory for remote user. SSH output:</span><br><span class="line">           Host key verification failed.</span><br><span class="line">Took 0.6103776s to run UnrealBuildTool.exe, ExitCode=6</span><br><span class="line">UnrealBuildTool failed. See log for more details. (C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Programs\AutomationTool\Saved\Logs\UBT-UnrealHeaderTool-Mac-Development.txt)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>看到是 ssh key 的验证失败了，其实这个错误并不是 Key 的问题（这个问题非常坑）。<br>而是因为 <code>RemoteMac.cs</code> 中对 ssh 连接命令的代码里是这么写的：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">RemoteMac</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> The authentication used for SSH (probably similar to RsyncAuthentication).</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	[<span class="meta">XmlConfigFile</span>]</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">string</span> SshAuthentication = <span class="string">&quot;-i &#x27;$&#123;CYGWIN_SSH_PRIVATE_KEY&#125;&#x27;&quot;</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RemoteMac</span>(<span class="params">FileReference ProjectFile</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    SshAuthentication = ExpandVariables(SshAuthentication);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Build a list of arguments for SSH</span></span><br><span class="line">    CommonSshArguments = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">    CommonSshArguments.Add(<span class="string">&quot;-o BatchMode=yes&quot;</span>);</span><br><span class="line">    CommonSshArguments.Add(SshAuthentication);</span><br><span class="line">    CommonSshArguments.Add(String.Format(<span class="string">&quot;-p &#123;0&#125;&quot;</span>, ServerPort));</span><br><span class="line">    CommonSshArguments.Add(String.Format(<span class="string">&quot;\&quot;&#123;0&#125;@&#123;1&#125;\&quot;&quot;</span>, UserName, ServerName));</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个代码生成的拼接的 ssh 命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">\Engine\Extras\ThirdPartyNotUE\DeltaCopy\Binaries\ssh.exe -o BatchMode=yes -i \Engine\Build\NotForLicensees\SSHKeys\xx.xx.xx.xx\buildmachine\RemoteToolChainPrivate.key -p 22 buildmachine@xx.xx.xx.xx</span><br></pre></td></tr></table></figure>
<p>问题的关键就是处在 <code>BatchMode=yes</code> 上，当我们第一次通过 ssh 连接一台主机，会下列提示：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ Engine\Extras\ThirdPartyNotUE\DeltaCopy\Binaries\ssh.exe -p 22 buildmachine@ 192.168.1.123 </span><br><span class="line">The authenticity of host <span class="string">&#x27;[192.168.1.123]:22 ([192.168.1.123]:22)&#x27;</span> can<span class="string">&#x27;t be established.</span></span><br><span class="line"><span class="string">RSA key fingerprint is e0:8d:b9:7c:65:c7:9e:18:94:12:ed:ef:40:1a:15:47.</span></span><br><span class="line"><span class="string">Are you sure you want to continue connecting (yes/no)? yes</span></span><br><span class="line"><span class="string">Warning: Permanently added &#x27;</span>[192.168.1.123]:22<span class="string">&#x27; (RSA) to the list of known hosts.</span></span><br><span class="line"><span class="string">Password:</span></span><br></pre></td></tr></table></figure>
<p>会弹出提示让你验证这台主机（需要手动输入 yes），但是开启了 <code>BatchMode=yes</code> 之后，会禁止所有的交互式提示，出现交互直接连接失败！这就是我们使用正确的 Key，但是会提示 <code>Host key verification failed.</code> 的原因。<br>那么，知道了原因，解决这个问题的办法有两种：</p>
<ol>
<li>关闭 ssh 的连接时验证</li>
<li>在进行构建之前，手动使用 ssh 命令连接主机，通过交互式的验证（只需要初始化验证一次）</li>
</ol>
<h3 id="未导入 provision 的错误"><a href="# 未导入 provision 的错误" class="headerlink" title="未导入 provision 的错误"></a>未导入 provision 的错误 </h3><p> 编译时的其他错误：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">****** [6/11] Compile UE4Game IOS</span><br><span class="line"></span><br><span class="line">Reading local file list from C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Saved\BuildGraph\Compile UnrealHeaderTool Mac\Tag-Compile UnrealHeaderTool Mac.xml</span><br><span class="line">Reading local file list from C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Saved\BuildGraph\Update Version Files\Tag-Update Version Files.xml</span><br><span class="line">Reading shared manifest from C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Saved\BuildGraph\Compile UnrealHeaderTool Mac\Manifest.xml</span><br><span class="line">Running: C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Binaries\DotNET\UnrealBuildTool.exe UE4Game IOS Development  -NoUBTMakefiles -nobuilduht -precompile -allmodules -nolink -nodebuginfo -Manifest=C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Intermediate\Build\Manifest.xml -NoHotReload -log=&quot;C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Programs\AutomationTool\Saved\Logs\UBT-UE4Game-IOS-Development.txt&quot;</span><br><span class="line">  [Remote] Using remote server &#x27;xx.xx.xx.xxx&#x27; on port 22 (user &#x27;buildmachine&#x27;)</span><br><span class="line">  [Remote] Using private key at C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Build\NotForLicensees\SSHKeys\10.75.27.129\buildmachine\RemoteToolChainPrivate.key</span><br><span class="line">  [Remote] Using base directory &#x27;/Users/buildmachine/UE4/Builds/lipengzha-PC2&#x27;</span><br><span class="line">  ERROR: Unable to find mobile provision for UE4Game. See log for more information.</span><br><span class="line">Took 4.0300959s to run UnrealBuildTool.exe, ExitCode=6</span><br></pre></td></tr></table></figure>
<p>这是因为编译引擎时没有配置 <code>provision</code>，需要在<code>Engine/Config/BaseEngine.ini</code> 中设置。</p>
<p>在这里可以只指定 <code>provision</code> 文件的名字，在 <code>UEBuildIOS.cs</code> 中的代码会从 <code>C:\Users\lipengzha\AppData\Local\Apple Computer\MobileDevice\Provisioning Profiles</code> 路径下去查找。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">IOSProvisioningData</span>(<span class="params">IOSProjectSettings ProjectSettings, <span class="built_in">bool</span> bIsTVOS, <span class="built_in">bool</span> bForDistribtion</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span>(!<span class="built_in">string</span>.IsNullOrEmpty(MobileProvision))</span><br><span class="line">	&#123;</span><br><span class="line">		DirectoryReference MobileProvisionDir;</span><br><span class="line">		<span class="keyword">if</span>(BuildHostPlatform.Current.Platform == UnrealTargetPlatform.Mac)</span><br><span class="line">		&#123;</span><br><span class="line">			MobileProvisionDir = DirectoryReference.Combine(<span class="keyword">new</span> DirectoryReference(Environment.GetEnvironmentVariable(<span class="string">&quot;HOME&quot;</span>)), <span class="string">&quot;Library&quot;</span>, <span class="string">&quot;MobileDevice&quot;</span>, <span class="string">&quot;Provisioning Profiles&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			MobileProvisionDir = DirectoryReference.Combine(DirectoryReference.GetSpecialFolder(Environment.SpecialFolder.LocalApplicationData), <span class="string">&quot;Apple Computer&quot;</span>, <span class="string">&quot;MobileDevice&quot;</span>, <span class="string">&quot;Provisioning Profiles&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		FileReference PossibleMobileProvisionFile = FileReference.Combine(MobileProvisionDir, MobileProvision);</span><br><span class="line">		<span class="keyword">if</span>(FileReference.Exists(PossibleMobileProvisionFile))</span><br><span class="line">		&#123;</span><br><span class="line">			MobileProvisionFile = PossibleMobileProvisionFile;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这部分操作也可以通过引擎来导入，不仅仅只需要导入 <code>provision</code> 还需要导入证书（也可以通过 iPhonePackager 来导入）：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/11956/20201105142657.webp"><br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/11956/20201105143249.webp"></p>
<p>如果不导入会有下列错误：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">****** [7/12] Compile UE4Game IOS</span><br><span class="line"></span><br><span class="line">Reading local file list from C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Saved\BuildGraph\Compile UnrealHeaderTool Mac\Tag-Compile UnrealHeaderTool Mac.xml</span><br><span class="line">Reading local file list from C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Saved\BuildGraph\Update Version Files\Tag-Update Version Files.xml</span><br><span class="line">Reading shared manifest from C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Saved\BuildGraph\Compile UnrealHeaderTool Mac\Manifest.xml</span><br><span class="line">Running: C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Binaries\DotNET\UnrealBuildTool.exe UE4Game IOS Development  -NoUBTMakefiles -nobuilduht -precompile -allmodules -nolink -nodebuginfo -Manifest=C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Intermediate\Build\Manifest.xml -NoHotReload -log=&quot;C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Programs\AutomationTool\Saved\Logs\UBT-UE4Game-IOS-Development.txt&quot;</span><br><span class="line">  [Remote] Using remote server &#x27;192.168.1.123&#x27; on port 22 (user &#x27;buildmachine&#x27;)</span><br><span class="line">  [Remote] Using private key at C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Build\NotForLicensees\SSHKeys\192.168.1.123\buildmachine\RemoteToolChainPrivate.key</span><br><span class="line">  [Remote] Using base directory &#x27;/Users/buildmachine/UE4/Builds/lipengzha-PC3&#x27;</span><br><span class="line">  [Remote] Uploading C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Intermediate\Remote\UE4Game\IOS\Development\com.xxxxx.xxxx.xx_Development_SignProvision.mobileprovision</span><br><span class="line">  [Remote] Exporting certificate for C:\Users\lipengzha\AppData\Local\Apple Computer\MobileDevice\Provisioning Profiles\com.xxxxx.xxxx.xx_Development_SignProvision.mobileprovision...</span><br><span class="line">  Executing iPhonePackager ExportCertificate C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Source -provisionfile C:\Users\lipengzha\AppData\Local\Apple Computer\MobileDevice\Provisioning Profiles\com.xxxxx.xxxx.xx_Development_SignProvision.mobileprovision -outputcertificate C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Intermediate\Remote\UE4Game\IOS\Development\Certificate.p12</span><br><span class="line">  CWD: C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Binaries\DotNET\IOS</span><br><span class="line">  Initial Dir: C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Source</span><br><span class="line">  Env CWD: C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Binaries\DotNET\IOS</span><br><span class="line">  BranchPath = lipengzha-PC3/C/BuildAgent/workspace/FGameEngine/Engine/Engine/Binaries --- GameBranchPath = lipengzha-PC3/C/BuildAgent/workspace/FGameEngine/Engine/Engine/Binaries</span><br><span class="line">  </span><br><span class="line">  ----------</span><br><span class="line">  Executing command &#x27;ExportCertificate&#x27; &#x27;&#x27; ...</span><br><span class="line">    Looking for a certificate that matches the application identifier &#x27;9TV4ZYSS4J.com.xxxxx.xxxx.xx&#x27;</span><br><span class="line">    .. Provision entry SN &#x27;61B440405D86B84D&#x27; matched 0 installed certificate(s)</span><br><span class="line">    .. Failed to find a valid certificate that was in date</span><br><span class="line">  IPP ERROR: Failed to find a valid certificate</span><br><span class="line">  </span><br><span class="line">  ERROR: IphonePackager failed.</span><br><span class="line">Took 2.9281688s to run UnrealBuildTool.exe, ExitCode=6</span><br></pre></td></tr></table></figure>

<p>上述的问题解决完毕之后就能够正常地把 BuildGraph 的流程执行完毕，导出了根据引擎代码编译出的二进制引擎，启动之后就可以看到能够打包 Windows/Android/IOS 了。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/11956/support-package-win-android-ios.webp"></p>
<h2 id="错误排查"><a href="# 错误排查" class="headerlink" title="错误排查"></a>错误排查 </h2><h3 id="No-certificate-for-team-xxxx-matching"><a href="#No-certificate-for-team-xxxx-matching" class="headerlink" title="No certificate for team xxxx matching"></a>No certificate for team xxxx matching</h3><p> 如果有以下错误提示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Code Signing Error: No certificate for team &#x27;9TV4ZYSS4J&#x27; matching &#x27;iPhone Developer: Created via API (JDPXHYVWYZ)&#x27; found: Select a different signing certificate for CODE_SIGN_IDENTITY, a team that matches your selected certificate, or switch to autom atic provisioning.</span><br></pre></td></tr></table></figure>
<p>解决办法：</p>
<ol>
<li>在 Mac 上的 <code>~/Library/MobileDevice/Provisioning\ Profiles</code> 清理掉多余的 mobileprovision 文件。</li>
<li>在 Mac 钥匙串中清理掉过期的开发者证书</li>
<li>重新导入 mobileprovision 与证书</li>
</ol>
<p>注意：导入的 mobileprovision 的文件命名要与在 <code>BaseEngine.ini</code> 中指定的 <code>MobileProvision</code> 相同。</p>
<h3 id="errSecInternalComponent 错误"><a href="#errSecInternalComponent 错误" class="headerlink" title="errSecInternalComponent 错误"></a>errSecInternalComponent 错误</h3><ul>
<li><a href="https://stackoverflow.com/questions/24023639/xcode-command-usr-bin-codesign-failed-with-exit-code-1-errsecinternalcomponen">Xcode Command /usr/bin/codesign failed with exit code 1 : errSecInternalComponent</a></li>
<li><a href="https://www.jianshu.com/p/b03e59560d31">iOS 远程自动打包问题</a></li>
<li><a href="https://medium.com/@ceyhunkeklik/how-to-fix-ios-application-code-signing-error-4818bd331327">How to Fix iOS Application Code Signing Error?</a></li>
<li><a href="https://stackoverflow.com/questions/48911289/warning-unable-to-build-chain-to-self-signed-root-for-signer-warning-in-xcode">“Warning: unable to build chain to self-signed root for signer” warning in Xcode 9.2</a></li>
</ul>
<h4 id="方法一"><a href="# 方法一" class="headerlink" title="方法一"></a>方法一 </h4><p> 是因为通过 ssh 去调用 <code>/usr/bin/codesign</code> 访问钥匙串没有权限，可以使用以下命令在 ssh 中执行解锁：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">security unlock-keychain -p password login.keychain</span><br></pre></td></tr></table></figure>
<p>在 UE 远程构建时，可以先执行这条命令在当前的 ssh 环境下解锁 keychain，使后面的签名可以正常执行。<br>修改 UE 中的 <code>Engine\Build\BatchFiles\Mac\Build.sh</code> 文件，在调用 UBT 编译之前，写入以下内容：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="string">&quot;`dirname &quot;</span><span class="variable">$0</span><span class="string">&quot;`/../../../..&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Setup Mono</span></span><br><span class="line"><span class="built_in">source</span> Engine/Build/BatchFiles/Mac/SetupMono.sh Engine/Build/BatchFiles/Mac</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [<span class="string">&quot;<span class="variable">$4</span>&quot;</span> == <span class="string">&quot;-buildscw&quot;</span> ] || [<span class="string">&quot;<span class="variable">$5</span>&quot;</span> == <span class="string">&quot;-buildscw&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> Building ShaderCompileWorker...</span><br><span class="line">	mono Engine/Binaries/DotNET/UnrealBuildTool.exe ShaderCompileWorker Mac Development</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> unlock mac keychain...</span><br><span class="line">security unlock-keychain -p password login.keychain</span><br><span class="line"><span class="built_in">echo</span> Running <span class="built_in">command</span> : Engine/Binaries/DotNET/UnrealBuildTool.exe <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line">mono Engine/Binaries/DotNET/UnrealBuildTool.exe <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line"></span><br><span class="line">ExitCode=$?</span><br><span class="line"><span class="keyword">if</span> [<span class="variable">$ExitCode</span> -eq 254 ] || [<span class="variable">$ExitCode</span> -eq 255 ] || [<span class="variable">$ExitCode</span> -eq 2 ]; <span class="keyword">then</span></span><br><span class="line">	<span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="built_in">exit</span> <span class="variable">$ExitCode</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>因为编译时会把 Build.sh 通过 RSync 传递到 Mac 上，所以可以看到以下 log:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[Remote] Executing build</span><br><span class="line">  Running bundled mono, ue_version: Mono JIT compiler version 5.16.0.220 (2018-06/bb3ae37d71a Fri Nov 16 17:12:11 EST 2018)</span><br><span class="line">  unlock mac keychain...</span><br><span class="line">  Running command : Engine/Binaries/DotNET/UnrealBuildTool.exe UnrealHeaderTool Mac Development -SkipRulesCompile -XmlConfigCache=/Users/buildmachine/UE4/Builds/lipengzha-PC2/C/BuildAgent/workspace/FGameEngine/Engine/Engine/Intermediate/Build/XmlConfigCache.bin -precompile -allmodules -Log=/Users/buildmachine/UE4/Builds/lipengzha-PC2/C/BuildAgent/workspace/FGameEngine/Engine/Engine/Programs/AutomationTool/Saved/Logs/UBT-UnrealHeaderTool-Mac-Development_Remote.txt -Manifest=/Users/buildmachine/UE4/Builds/lipengzha-PC2/C/BuildAgent/workspace/FGameEngine/Engine/Engine/Intermediate/Remote/UnrealHeaderTool/Mac/Development/Manifest.xml</span><br><span class="line">  Target is up to date</span><br><span class="line">  Deploying UnrealHeaderTool Mac Development...</span><br><span class="line">  Deploying now!</span><br><span class="line">  Total execution time: 1.01 seconds</span><br><span class="line">[Remote] Downloading C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Intermediate\Remote\UnrealHeaderTool\Mac\Development\Manifest.xml</span><br><span class="line">[Remote] Downloading build products</span><br><span class="line">  receiving file list ... done</span><br></pre></td></tr></table></figure>
<p>这样每次编译都会解锁 keychain，从而避免 ssh 连接时没有访问 codesign 导致的签名错误。</p>
<blockquote>
<p>注意：也需要排查 BaseEngine.ini 中 <code>SigningCertificate</code> 的值是否被指定。</p>
</blockquote>
<h4 id="方法二"><a href="# 方法二" class="headerlink" title="方法二"></a>方法二 </h4><p> 导入新的苹果开发者根证书：</p>
<ul>
<li><a href="https://developer.apple.com/de/support/expiration/">Apple Worldwide Developer Relations Intermediate Certificate Expiration</a></li>
</ul>
<p>把 <code> 钥匙串 </code>-<code> 系统 </code>-<code>Apple Worldwise Developer Relations Certification Authority</code> 删除，然后从上面的连接中下载新的，重新导入即可。<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210611130513.webp"></p>
<h3 id="Invalid-trust-settings"><a href="#Invalid-trust-settings" class="headerlink" title="Invalid trust settings"></a>Invalid trust settings</h3><p>如果 Log 中出现以下错误：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Code Signing Error: Invalid trust settings. Restore system default trust settings for certificate &quot;iPhone Developer: Created via API (JDPXHYVWYZ)&quot; in order to sign code with it.</span><br><span class="line">Code Signing Error: Code signing is required for product type &#x27;Application&#x27; in SDK &#x27;iOS 13.6&#x27;</span><br></pre></td></tr></table></figure>
<p>这是因为在 Mac 上的钥匙串中对证书的设置被修改为了 <code> 始终信任 </code>，修改回<code> 使用系统默认 </code> 即可。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/11956/20210326121855.webp"></p>
<h2 id="结语"><a href="# 结语" class="headerlink" title="结语"></a>结语 </h2><p> 本篇文章主要介绍了 BuildGraph 的工作流程、优化构建速度，以及支持 Android/IOS 的打包。</p>
<p>需要注意的是，文章开头使用的命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">RunUAT.bat BuildGraph -target=<span class="string">&quot;Make Installed Build Win64&quot;</span> -script=Engine/Build/InstalledEngineBuild.xml -<span class="built_in">set</span>:WithMac=<span class="literal">false</span> -<span class="built_in">set</span>:WithAndroid=<span class="literal">false</span> -<span class="built_in">set</span>:WithIOS=<span class="literal">false</span> -<span class="built_in">set</span>:WithTVOS=<span class="literal">false</span> -<span class="built_in">set</span>:WithLinux=<span class="literal">false</span> -<span class="built_in">set</span>:WithHTML5=<span class="literal">false</span> -<span class="built_in">set</span>:WithSwitch=<span class="literal">false</span> -WithDDC=<span class="literal">false</span> -<span class="built_in">set</span>:WithWin32=<span class="literal">false</span> -<span class="built_in">set</span>:WithLumin=<span class="literal">false</span> -<span class="built_in">set</span>:WithPS4=<span class="literal">false</span> -<span class="built_in">set</span>:WithXboxOne=<span class="literal">false</span> -<span class="built_in">set</span>:WithHoloLens=<span class="literal">false</span> -<span class="built_in">set</span>:GameConfigurations=Development</span><br></pre></td></tr></table></figure>

<p>它的 <code>GameConfigurations</code> 只设置了 <code>Dvelopment</code>，所以编译出来的引擎也只能打包<code>Development</code>，如果想要支持 Shipping 打包，就需要在<code>BuildGraph</code> 中指定：<code>-set:GameConfigurations=Development;Shipping</code>，但是这样会增加构建的时间，因为 Development 和 Shipping 都是需要分别编译的，对执行支持的所有平台都增加了一次引擎编译的时间开销，当然是必要的，不过在日常的开发中，可以有选择性地开启，节省构建的时间。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>BuildSystem</category>
        <category>BuildGraph</category>
      </categories>
      <tags>
        <tag>BuildSystem</tag>
        <tag>BuildGraph</tag>
      </tags>
  </entry>
  <entry>
    <title>模块的宏定义</title>
    <url>/wiki/38550/</url>
    <content><![CDATA[<h3 id="MODULE-NAME-API"><a href="#MODULE-NAME-API" class="headerlink" title="MODULE_NAME_API"></a>MODULE_NAME_API</h3><p>UE 中的模块，如果定义的符号允许被外部模块访问，则需要在 class 前加 <code>MODULE_NAME_API</code>，这个宏是什么意思呢？<br> 打开 <code>Definitions.MODULE_NAME.h</code> 这个文件可以知道，<code>MODULE_NAME_API</code>这个宏的定义是 <code>DLLEXPORT</code>，看名字就知道是导出符号的，但是针对不同的平台是不一样的，<code>DLLEXPORT</code> 和<code>DLLIMPORT</code>的宏是定义在 <code>Runtime\Core\Public\$&#123;PLATFROM&#125;\$&#123;PLATFROM&#125;Platfrom.h</code> 下的(Android 与 Linux 的相同)：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime\Core\Public\Android\AndroidPlatform.h</span></span><br><span class="line"><span class="comment">// Runtime\Core\Public\Linux\LinuxPlatform.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// DLL export and import definitions</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DLLEXPORT      __attribute__((visibility(<span class="meta-string">&quot;default&quot;</span>)))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DLLIMPORT      __attribute__((visibility(<span class="meta-string">&quot;default&quot;</span>)))</span></span><br></pre></td></tr></table></figure>
<p>MacOS 则是一个空的宏定义：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime\Core\Public\Mac\MacPlatform.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// DLL export and import definitions</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DLLEXPORT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DLLIMPORT</span></span><br></pre></td></tr></table></figure>

<p>Windows 的为<code>__declspec</code>：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime\Core\Public\Windows\WIndowsPlatform.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// DLL export and import definitions</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DLLEXPORT __declspec(dllexport)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DLLIMPORT __declspec(dllimport)</span></span><br></pre></td></tr></table></figure>

<h3 id="模块的宏定义"><a href="# 模块的宏定义" class="headerlink" title="模块的宏定义"></a>模块的宏定义</h3><p>UE 中模块的宏定义会汇总在这个文件下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Intermediate\Build\Win64\UE4Editor\Development\NetExampleDemo\Definitions.MODULE_NAME.h</span><br></pre></td></tr></table></figure>
<p>其中定义了 <code>MODULE_NAME_API</code> 为<code>DLLEXPORT</code>，导出自己模块内的符号，还有引用的其他模块的 <code>MODULE_NAME_API</code> 为<code>DLLIMPORT</code>，导入引用模块内的符号，在编译时链接可用，还有一些宏开关。<br>类似于这样：<a href="index/UE4/Macro/Definitions.MODULENAME.h">Definations.WebBrowserEx.h</a></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>BuildSystem</category>
      </categories>
      <tags>
        <tag>Module</tag>
      </tags>
  </entry>
  <entry>
    <title>添加编译器参数</title>
    <url>/wiki/b25cab28/</url>
    <content><![CDATA[<p>如果想要在编译引擎时自定义加一些编译器参数可以修改 <code>Programs\UnrealBuildTool\Platform</code> 下各个平台的 <code>*Toolchain.cs</code> 中的：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="built_in">string</span> <span class="title">GetCompileArguments_Global</span>(<span class="params">CppCompileEnvironment CompileEnvironment</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ++[RSTUDIO][lipengzha] support xcode12</span></span><br><span class="line">  Result += <span class="string">&quot; -Wno-range-loop-analysis&quot;</span>;</span><br><span class="line">  <span class="comment">// --[RSTUDIO]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样是全局配置（包含引擎和 Program 的编译都会使用该参数），如果只是想要给某个 Target 添加编译器参数可以在 target.cs 里通过 <code>AdditionalCompilerArguments</code> 设置：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">bOverrideBuildEnvironment = <span class="literal">true</span>;</span><br><span class="line">AdditionalCompilerArguments = <span class="string">&quot;-Wno-range-loop-analysis&quot;</span>;</span><br></pre></td></tr></table></figure>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>BuildSystem</category>
        <category>UBT</category>
      </categories>
      <tags>
        <tag>BuildSystem</tag>
        <tag>UBT</tag>
      </tags>
  </entry>
  <entry>
    <title>编译目标的 RuntimeLibrary 类型</title>
    <url>/wiki/37913/</url>
    <content><![CDATA[<p>与普通的 c++ 项目不一样，UE 的 Game 工程是不能在项目属性中设置 <code>RuntimeLibrary</code> 的，这部分有 UBT 代劳替我们处理。<br>其相关的代码在 <code>UnrealBuildTool\Windows\VCToolchain.cs</code>(UE_4.22) 中：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AppendCLArguments_Global</span><span class="params">(CppCompileEnvironment CompileEnvironment, List&lt;string&gt; Arguments)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// Specify the appropriate runtime library based on the platform and config.</span></span><br><span class="line"><span class="keyword">if</span> (CompileEnvironment.bUseStaticCRT)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (CompileEnvironment.bUseDebugCRT)</span><br><span class="line">	&#123;</span><br><span class="line">		Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/MTd&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/MT&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (CompileEnvironment.bUseDebugCRT)</span><br><span class="line">	&#123;</span><br><span class="line">		Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/MDd&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/MD&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>*.target.cs</code> 中使用了 <code>bUseStaticCRT=true</code> 后（默认为 false），编译 Debug 版本是 <code>/MTd</code>，其他版本是<code>MT</code>。<br> 在<code>*.target.cs</code>中不能直接控制 <code>bUseDebugCRT</code>, 但是可以控制<code>bDebugBuildsActuallyUseDebugCRT</code>（默认为 false）, 它由我们在<code>VS</code> 选的 <code>Configuration</code> 和<code>bDebugBuildsActuallyUseDebugCRT</code>的值来控制。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// UEBuildTarget.cs</span><br><span class="line"></span><br><span class="line">// GetCppConfiguration</span><br><span class="line">static CppConfiguration GetCppConfiguration(UnrealTargetConfiguration Configuration)</span><br><span class="line">&#123;</span><br><span class="line">  switch (Configuration)</span><br><span class="line">  &#123;</span><br><span class="line">    case UnrealTargetConfiguration.Debug:</span><br><span class="line">      return CppConfiguration.Debug;</span><br><span class="line">    case UnrealTargetConfiguration.DebugGame:</span><br><span class="line">    case UnrealTargetConfiguration.Development:</span><br><span class="line">      return CppConfiguration.Development;</span><br><span class="line">    case UnrealTargetConfiguration.Shipping:</span><br><span class="line">      return CppConfiguration.Shipping;</span><br><span class="line">    case UnrealTargetConfiguration.Test:</span><br><span class="line">      return CppConfiguration.Shipping;</span><br><span class="line">    default:</span><br><span class="line">      throw new BuildException(&quot;Unhandled target configuration&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// CreateCompileEnvironmentForProjectFiles</span><br><span class="line">public CppCompileEnvironment CreateCompileEnvironmentForProjectFiles()</span><br><span class="line">&#123;</span><br><span class="line">  CppPlatform CppPlatform = UEBuildPlatform.GetBuildPlatform(Platform).DefaultCppPlatform;</span><br><span class="line">  CppConfiguration CppConfiguration = GetCppConfiguration(Configuration);</span><br><span class="line"></span><br><span class="line">  SourceFileMetadataCache MetadataCache = SourceFileMetadataCache.CreateHierarchy(ProjectFile);</span><br><span class="line"></span><br><span class="line">  CppCompileEnvironment GlobalCompileEnvironment = new CppCompileEnvironment(CppPlatform, CppConfiguration, Architecture, MetadataCache);</span><br><span class="line">  LinkEnvironment GlobalLinkEnvironment = new LinkEnvironment(GlobalCompileEnvironment.Platform, GlobalCompileEnvironment.Configuration, GlobalCompileEnvironment.Architecture);</span><br><span class="line"></span><br><span class="line">  UEToolChain TargetToolChain = CreateToolchain(CppPlatform);</span><br><span class="line">  SetupGlobalEnvironment(TargetToolChain, GlobalCompileEnvironment, GlobalLinkEnvironment);</span><br><span class="line"></span><br><span class="line">  return GlobalCompileEnvironment;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// SetupGlobalEnvironment</span><br><span class="line">private void SetupGlobalEnvironment(UEToolChain ToolChain, CppCompileEnvironment GlobalCompileEnvironment, LinkEnvironment GlobalLinkEnvironment)</span><br><span class="line">&#123;</span><br><span class="line">	// ...</span><br><span class="line">	GlobalCompileEnvironment.bUseDebugCRT = GlobalCompileEnvironment.Configuration == CppConfiguration.Debug &amp;&amp; Rules.bDebugBuildsActuallyUseDebugCRT;</span><br><span class="line">	// ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以，总结上面的代码，只有当 VS 的编译选项选的是 <code>Debug</code>，并且在<code>*.Target.cs</code> 中<code>bDebugBuildsActuallyUseDebugCRT=true</code>的时候，<code>bUseDebugCRT</code>才为<code>true</code>。</p>
<h3 id="情况一"><a href="# 情况一" class="headerlink" title="情况一"></a>情况一</h3><ul>
<li>当<code>bUseStaticCRT=true;</code></li>
<li>以及<code>bDebugBuildsActuallyUseDebugCRT=true;</code></li>
<li>以及 VS 中的 Configuration 为<code>Debug</code></li>
</ul>
<p>以上三个条件全部满足的时候，编译的 Runtime Library 为<code>/MTd</code>。</p>
<h3 id="情况二"><a href="# 情况二" class="headerlink" title="情况二"></a>情况二</h3><ul>
<li>当<code>bUseStaticCRT=false;</code>(默认)</li>
<li>以及<code>bDebugBuildsActuallyUseDebugCRT=true;</code></li>
<li>以及 VS 中的 Configuration 为<code>Debug</code></li>
</ul>
<p>这三个条件，编译的 Runtime Library 为<code>/MDd</code>。</p>
<h3 id="情况三"><a href="# 情况三" class="headerlink" title="情况三"></a>情况三 </h3><p> 在<strong>情况二 </strong> 基础上把下列条件改为：</p>
<ul>
<li>以及<code>bDebugBuildsActuallyUseDebugCRT=false;</code>(默认)</li>
</ul>
<p>或者：</p>
<ul>
<li>以及 VS 中的 Configuration 不是<code>Debug</code></li>
</ul>
<p>则这种情况下，编译的 Runtime Library 都是<code>/MD</code>.</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>BuildSystem</category>
      </categories>
      <tags>
        <tag>BuildSystem</tag>
      </tags>
  </entry>
  <entry>
    <title>编译系统 PCH 配置</title>
    <url>/wiki/320933567/</url>
    <content><![CDATA[<h2 id="修改 PCH-Buffer-size"><a href="# 修改 PCH-Buffer-size" class="headerlink" title="修改 PCH Buffer size"></a>修改 PCH Buffer size</h2><p>默认是<code>/Zm1000</code>，就是 750M，如果编译时产生页面文件太小的错误：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">c1xx: error C3859: Failed to create <span class="keyword">virtual</span> memory <span class="keyword">for</span> PCH</span><br><span class="line">c1xx: note: the system returned code <span class="number">1455</span>: 页面文件太小，无法完成操作。</span><br><span class="line">c1xx: note: please visit https:<span class="comment">//aka.ms/pch-help for more details</span></span><br><span class="line">c1xx: fatal error C1076: compiler limit: internal heap limit reached</span><br></pre></td></tr></table></figure>

<p>可以在项目的 target.cs 里添加以下代码：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(Target.Platform == UnrealTargetPlatform.Win64)</span><br><span class="line">&#123;</span><br><span class="line">  bOverrideBuildEnvironment = <span class="literal">true</span>;</span><br><span class="line">  AdditionalCompilerArguments = <span class="string">&quot;/Zm2000&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><a href="https://docs.microsoft.com/en-us/cpp/build/reference/zm-specify-precompiled-header-memory-allocation-limit?view=msvc-160">/Zm (Specify Precompiled Header Memory Allocation Limit)</a></li>
</ul>
<h2 id="关闭 PCH"><a href="# 关闭 PCH" class="headerlink" title="关闭 PCH"></a>关闭 PCH</h2><p>在 TargetRules.cs 中有 <code>bUsePCHFiles</code> 和<code>bUseSharedPCHs</code>两个选项，可以控制项目是否开启 PCH：</p>
<figure class="highlight cpp"><figcaption><span>UnrealBuildTool\Configuration\TargetRules.cs</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">/// &lt;summary&gt;</span></span><br><span class="line"><span class="comment">/// Whether PCH files should be used.</span></span><br><span class="line"><span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line">[<span class="built_in">CommandLine</span>(<span class="string">&quot;-NoPCH&quot;</span>, Value = <span class="string">&quot;false&quot;</span>)]</span><br><span class="line">[<span class="built_in">XmlConfigFile</span>(Category = <span class="string">&quot;BuildConfiguration&quot;</span>)]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">bool</span> bUsePCHFiles = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// &lt;summary&gt;</span></span><br><span class="line"><span class="comment">/// Enables &quot;Shared PCHs&quot;, a feature which significantly speeds up compile times by attempting to</span></span><br><span class="line"><span class="comment">/// share certain PCH files between modules that UBT detects is including those PCH&#x27;s header files.</span></span><br><span class="line"><span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line">[<span class="built_in">CommandLine</span>(<span class="string">&quot;-NoSharedPCH&quot;</span>, Value = <span class="string">&quot;false&quot;</span>)]</span><br><span class="line">[<span class="built_in">XmlConfigFile</span>(Category = <span class="string">&quot;BuildConfiguration&quot;</span>)]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">bool</span> bUseSharedPCHs = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>但是为了不改动代码，也可以通过 <code>BuildConfiguration.xml</code> 中的设置：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">C:\Users\lipengzha\AppData\Roaming\Unreal Engine\UnrealBuildTool\BuildConfiguration.xml</span><br><span class="line">F:\EngineSource\UE_4.26\Engine\Saved\UnrealBuildTool\BuildConfiguration.xml</span><br></pre></td></tr></table></figure>
<p>这两个路径下的均可，在 <code>Configuration</code> 下添加以下配置：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bUsePCHFiles</span>&gt;</span>true<span class="tag">&lt;/<span class="name">bUsePCHFiles</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bUseSharedPCHs</span>&gt;</span>false<span class="tag">&lt;/<span class="name">bUseSharedPCHs</span>&gt;</span></span><br></pre></td></tr></table></figure>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>BuildSystem</category>
      </categories>
      <tags>
        <tag>BuildSystem</tag>
        <tag>UBT</tag>
      </tags>
  </entry>
  <entry>
    <title>变量已被优化，因而不可用。</title>
    <url>/wiki/12876/</url>
    <content><![CDATA[<p>在调试时关闭 Target 或者指定模块的代码优化，能够更好的分析问题。<br><code>ModuleRules</code>的 <code>OptimizeCode</code> 属性是用来控制当前模块是否要开启优化代码，在我们用 VS 调试时，有时候会看到“变量已被优化，因而不可用”，这就是因为被优化了。<br>可以使用它来关闭优化：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// build.cs</span></span><br><span class="line">OptimizeCode = CodeOptimization.Never;</span><br></pre></td></tr></table></figure>

<p><code>CodeOptimization</code>支持几种值，默认是<code>Default</code>，开启优化：</p>
<ul>
<li>Never</li>
<li>Default</li>
<li>InNonDebugBuilds</li>
<li>InShippingBuildsOnly</li>
</ul>
<p>相关的代码：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTool/Configutation/UEBuildModuleCPP.cs</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">ShouldEnableOptimization</span><span class="params">(ModuleRules.CodeOptimization Setting, UnrealTargetConfiguration Configuration, <span class="keyword">bool</span> bIsEngineModule)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in"><span class="keyword">switch</span></span>(Setting)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> ModuleRules.CodeOptimization.Never:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">case</span> ModuleRules.CodeOptimization.Default:</span><br><span class="line">    <span class="keyword">case</span> ModuleRules.CodeOptimization.InNonDebugBuilds:</span><br><span class="line">      <span class="keyword">return</span> (Configuration == UnrealTargetConfiguration.Debug)? <span class="literal">false</span> : (Configuration != UnrealTargetConfiguration.DebugGame || bIsEngineModule);</span><br><span class="line">    <span class="keyword">case</span> ModuleRules.CodeOptimization.InShippingBuildsOnly:</span><br><span class="line">      <span class="keyword">return</span> (Configuration == UnrealTargetConfiguration.Shipping);</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数在 <code>UEBuildModuleCPP.cs</code> 的<code>CreateModuleCompileEnvironment</code>中调用，将结果赋值给了 <code>CppCompileEnvironment.bOptimizeCode</code>，进而又在<code>VCToolChain.cs</code> 中被使用：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">UnrealBuildTool\Platform\Windows\VCToolChain.<span class="function">cs</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AppendCLArguments_Global</span><span class="params">(CppCompileEnvironment CompileEnvironment, List&lt;string&gt; Arguments)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// other code ...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//  Debug</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="keyword">if</span> (CompileEnvironment.Configuration == CppConfiguration.Debug)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="comment">// Disable compiler optimization.</span></span><br><span class="line">	  Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/Od&quot;</span>);</span><br><span class="line"></span><br><span class="line">	  <span class="comment">// Favor code size (especially useful for embedded platforms).</span></span><br><span class="line">	  Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/Os&quot;</span>);</span><br><span class="line"></span><br><span class="line">	  <span class="comment">// Allow inline method expansion unless E&amp;C support is requested</span></span><br><span class="line">	  <span class="keyword">if</span> (!CompileEnvironment.bSupportEditAndContinue &amp;&amp; CompileEnvironment.bUseInlining)</span><br><span class="line">	  &#123;</span><br><span class="line">	    Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/Ob2&quot;</span>);</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> ((CompileEnvironment.Platform == CppPlatform.Win32) ||</span><br><span class="line">	    (CompileEnvironment.Platform == CppPlatform.Win64))</span><br><span class="line">	  &#123;</span><br><span class="line">	    Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/RTCs&quot;</span>);</span><br><span class="line">	  &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//  Development and LTCG</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">if</span>(!CompileEnvironment.bOptimizeCode)</span><br><span class="line">	  &#123;</span><br><span class="line">	    <span class="comment">// Disable compiler optimization.</span></span><br><span class="line">	    Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/Od&quot;</span>);</span><br><span class="line">	  &#125;</span><br><span class="line">	  <span class="keyword">else</span></span><br><span class="line">	  &#123;</span><br><span class="line">	    <span class="comment">// Maximum optimizations.</span></span><br><span class="line">	    Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/Ox&quot;</span>);</span><br><span class="line"></span><br><span class="line">	    <span class="comment">// Favor code speed.</span></span><br><span class="line">	    Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/Ot&quot;</span>);</span><br><span class="line"></span><br><span class="line">	    <span class="comment">// Coalesce duplicate strings</span></span><br><span class="line">	    Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/GF&quot;</span>);</span><br><span class="line"></span><br><span class="line">	    <span class="comment">// Only omit frame pointers on the PC (which is implied by /Ox) if wanted.</span></span><br><span class="line">	    <span class="keyword">if</span> (CompileEnvironment.bOmitFramePointers == <span class="literal">false</span></span><br><span class="line">	    &amp;&amp; ((CompileEnvironment.Platform == CppPlatform.Win32) ||</span><br><span class="line">	      (CompileEnvironment.Platform == CppPlatform.Win64)))</span><br><span class="line">	    &#123;</span><br><span class="line">	      Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/Oy-&quot;</span>);</span><br><span class="line">	    &#125;</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  <span class="comment">// Allow inline method expansion</span></span><br><span class="line">	  Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/Ob2&quot;</span>);</span><br><span class="line"></span><br><span class="line">	  <span class="comment">//</span></span><br><span class="line">	  <span class="comment">// LTCG</span></span><br><span class="line">	  <span class="comment">//</span></span><br><span class="line">	  <span class="keyword">if</span> (CompileEnvironment.bAllowLTCG)</span><br><span class="line">	  &#123;</span><br><span class="line">	    <span class="comment">// Enable link-time code generation.</span></span><br><span class="line">	    Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/GL&quot;</span>);</span><br><span class="line">	  &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// other code...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，在 <code>Debug</code> 的环境下，是默认关闭优化的。在非 <code>Debug</code> 时根据 <code>CompileEnvironment.bOptimizeCode</code> 的值来决定是否开启优化。<br>调试效果：<br>当使用默认时（<code>OptimizeCode = CodeOptimization.Default;</code>）:<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/16643/UE-codeoptimize-default.webp"></p>
<p>当关闭代码优化时(<code>OptimizeCode = CodeOptimization.Never;</code>)：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/16643/UE-codeoptimize-never.webp"></p>
<p>建议使用<code>OptimizeCode = CodeOptimization.InShippingBuildsOnly;</code>。</p>
<blockquote>
<p>注意：这个选项和普通的 C++ 项目在 VS 中的 <code>Properties</code>-<code>Configuration</code>-<code>C/C++</code>-<code>Optimization</code>-<code>Optimization</code> 的设置时一样的。</p>
</blockquote>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/16643/vs-disable-optimization.webp"></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Debugging</category>
      </categories>
      <tags>
        <tag>Debugging</tag>
      </tags>
  </entry>
  <entry>
    <title>VS 真机调试 Android</title>
    <url>/wiki/6b9bc0ab/</url>
    <content><![CDATA[<p>对于 UE 项目而言，绝大部分情况下，不需要关心 Apk 的构建流程，虽然 UE 在打包时会生成一个 Android Studio 的工程，但基本对于开发层而言是隔离的，UE 的构建工具会自动处理。</p>
<p>调试也是一样，在 UE 项目开发中，Coding 在 VS 或 Rider 等 <strong> 游戏开发环境 </strong> 中进行，直接在 VS 中进行调试也是最合适的，再去打开 Android Studio，一是工具的臃肿，二是额外的 IDE 熟悉成本。</p>
<p>好在，谷歌推出了 <a href="https://developer.android.com/games/agde">AGDE</a> 扩展工具（Android Game Development Extension for Visual Studio），可以直接在 VS 中调试 Android 项目，而不用使用 Android Studio。</p>
<p>首先，就是要下载 <a href="https://developer.android.com/games/agde">AGDE</a> 并安装。它支持 VS2017-2022（但 UE 的文档里建议使用 VS2019）。</p>
<h3 id="Android 环境"><a href="#Android 环境" class="headerlink" title="Android 环境"></a>Android 环境</h3><p>AGDE 对于 JDK 的要求是 JDK11+，太老的版本打开时会提示不支持。新版本的 JDK 可以从 Oracle 网站上下载：<a href="https://www.oracle.com/java/technologies/downloads/">Java Downloads</a></p>
<p>在系统中，添加以下环境变量：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">setx JAVA_HOME &quot;%current_dir_name%\jdk-18.0.1.1&quot;</span><br><span class="line">setx ANDROID_HOME &quot;%current_dir_name%\android-sdk-windows&quot;</span><br><span class="line">setx ANDROID_SDK_ROOT &quot;%current_dir_name%\android-sdk-windows&quot;</span><br><span class="line">setx ANDROID_NDK_ROOT &quot;%current_dir_name%\%ndk_version%&quot;</span><br><span class="line">setx ANT_HOME &quot;%current_dir_name%\apache-ant-1.8.2&quot;</span><br><span class="line">setx GRADLE_HOME &quot;%current_dir_name%\%grade_version%&quot;</span><br></pre></td></tr></table></figure>

<p>路径可根据实际情况修改，我在 <a href="https://imzlp.com/posts/17996/">UE 开发笔记：Android 篇</a> 文章中提供了一份完整的 Andoird 环境，只需要更新 JDK 版本即可开箱即用。</p>
<p>安装的 ADGE 会读取环境变量中的配置，无需再在 VS 中配置 JDK/NDK/SDK 的路径。</p>
<h3 id="UE 侧的要求"><a href="#UE 侧的要求" class="headerlink" title="UE 侧的要求"></a>UE 侧的要求 </h3><p> 调试环境包在 <code>Project Settings</code>-<code>Package</code> 中取消勾选<code>For Distribution</code>：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/image-20220706151853395.png"></p>
<p>根据需要，打包为 <code>Development</code> 或<code>Debug</code>/<code>DebugGame</code>即可。</p>
<h3 id="VS"><a href="#VS" class="headerlink" title="VS"></a>VS</h3><p>在 VS 解决方案的 <code>Games</code> 下，添加打包出的 APK：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/image-20220706152622741.png"></p>
<p>会出现一个 <code>PROJECT_NAME-armv7</code> 等命名的项：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/image-20220706152853841.png"></p>
<p>将其设置为启动项目：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/image-20220706153039258.png"></p>
<p>即可在 VS 中看到设备：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/image-20220706153229942.png"></p>
<p>之后就可以像在 Win 上调试编辑器一样了，F5 即可安装到设备上。</p>
<p>设备上运行的会进程会等待调试器附加：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/image-20220706154408319.png"></p>
<p><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/image-20220706154930415.png"></p>
<p>附加之后就能正确地在 VS 中进行断点了。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Debugging</category>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Debugging</tag>
        <tag>Android</tag>
        <tag>Mobile</tag>
        <tag>Visual Studio</tag>
        <tag>VS</tag>
        <tag>调试</tag>
      </tags>
  </entry>
  <entry>
    <title>VisualStudio 调试 UE 项目技巧</title>
    <url>/wiki/14373/</url>
    <content><![CDATA[<h3 id="在 VS 中调试时显示对象值"><a href="# 在 VS 中调试时显示对象值" class="headerlink" title="在 VS 中调试时显示对象值"></a>在 VS 中调试时显示对象值 </h3><p> 打开引擎路径:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Engine\Extras\VisualStudioDebugging</span><br></pre></td></tr></table></figure>

<p>该路径下会有一个 <a href="https://img.imzlp.com/imgs/zlp/blog/posts/12143/UE4_native.7z">UE4.natvis.zip</a> 文件，将其拷贝到 VS 的下列路径中：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\Common7\Packages\Debugger\Visualizers</span><br></pre></td></tr></table></figure>

<p>然后重启启动调试，就可以在调试窗口看到对象值了。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/12143/ue4-debug-in-vs-show-object-value.webp"></p>
<h3 id="调试独立运行的 UE 项目"><a href="# 调试独立运行的 UE 项目" class="headerlink" title="调试独立运行的 UE 项目"></a>调试独立运行的 UE 项目 </h3><p> 在 UE 的编辑器模式下以 <code>Standalone</code> 方式运行，在 VS 中是没办法及时 <code>Attach to process</code> 上的。<br>比如我们想要在 standalone 模式下调试引擎和项目，在 editor 下直接启动会创建一个新的进程，在 VS 中手动点 <code>Attach to process</code> 是很不方便的，也没有那么及时 (因为点完启动在等我们在 VS 中 attach 到进程上有可能引擎都已经启动完毕了)。<br> 幸好 UE 提供了一个插件：<a href="https://docs.unrealengine.com/en-US/Programming/Development/VisualStudioSetup/UnrealVS">UnrealVS</a>，该插件的 VS 安装程序在引擎的 <code>Engine\Extras\UnrealVS</code> 目录下，根据你的 VS 版本选择安装。<br>安装完之后启动 VS，在 <code>View-&gt;Toolbars-&gt;UnrealVS</code> 启用，就会在 VS 的工具栏看到了。在这里选择你的项目：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/12143/UnrealVS-Plugins-Toolbar.webp"></p>
<p>后面的框是命令行框，填入的参数会在启动时传递给程序 (具体介绍看<a href="https://docs.unrealengine.com/en-US/Programming/Development/VisualStudioSetup/UnrealVS">UnrealVS</a> 里面的描述)，所以我们可以在后面填参数使其以独立模式启动 (可以从<a href="https://docs.unrealengine.com/en-us/Programming/Basics/CommandLineArguments">Command-Line Arguments</a> 查看支持的参数)：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;<span class="subst">$(SolutionDir)</span><span class="subst">$(ProjectName)</span>.uproject&quot;</span> -game -windowed -<span class="built_in">log</span> -verbose</span><br></pre></td></tr></table></figure>
<p>这样就会在 VS 中使用 F5 启动项目时自动 attach 的到进程上的。</p>
<h3 id="关闭代码优化"><a href="# 关闭代码优化" class="headerlink" title="关闭代码优化"></a>关闭代码优化 </h3><p> 在调试时关闭 Target 或者指定模块的代码优化，能够更好的分析问题。<br><code>ModuleRules</code>的 <code>OptimizeCode</code> 属性是用来控制当前模块是否要开启优化代码，在我们用 VS 调试时，有时候会看到“变量已被优化，因而不可用”，这就是因为被优化了。<br>可以使用它来关闭优化：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// build.cs</span></span><br><span class="line">OptimizeCode = CodeOptimization.Never;</span><br></pre></td></tr></table></figure>

<p>具体的分析见这篇内容：<a href="https://ue5wiki.com/wiki/12876/">变量已被优化，因而不可用。</a></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Debugging</category>
      </categories>
      <tags>
        <tag>Debugging</tag>
        <tag>Visual Studio</tag>
        <tag>调试</tag>
      </tags>
  </entry>
  <entry>
    <title>使用 IDetailCustomization 自定义属性面板</title>
    <url>/wiki/38904/</url>
    <content><![CDATA[<p>使用 <code>IDetailCustomization</code> 的方式可以给 UE 的属性面板添加特殊的东西，比如按钮。</p>
<p>以给 F 的结构的 Detail 添加按钮的方法如下：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ReleaseSettingsDetails.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;IDetailCustomization.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FReleaseSettingsDetails</span> :</span> <span class="keyword">public</span> IDetailCustomization</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/** Makes a new instance of this detail layout class for a specific detail view requesting it */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> TSharedRef&lt;IDetailCustomization&gt; <span class="title">MakeInstance</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** IDetailCustomization interface */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">CustomizeDetails</span><span class="params">(IDetailLayoutBuilder&amp; DetailBuilder)</span> <span class="keyword">override</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>.cpp:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ReleaseSettingsDetails.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CreatePatch/ReleaseSettingsDetails.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CreatePatch/FExportReleaseSettings.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// engine header</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;DetailLayoutBuilder.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;DetailCategoryBuilder.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;DetailWidgetRow.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Widgets/Input/SButton.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOCTEXT_NAMESPACE <span class="meta-string">&quot;ReleaseSettingsDetails&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">TSharedRef&lt;IDetailCustomization&gt; <span class="title">FReleaseSettingsDetails::MakeInstance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> <span class="built_in">FReleaseSettingsDetails</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FReleaseSettingsDetails::CustomizeDetails</span><span class="params">(IDetailLayoutBuilder&amp; DetailBuilder)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TArray&lt; TSharedPtr&lt;FStructOnScope&gt; &gt; StructBeingCustomized;</span><br><span class="line">    DetailBuilder.<span class="built_in">GetStructsBeingCustomized</span>(StructBeingCustomized);</span><br><span class="line">    <span class="built_in">check</span>(StructBeingCustomized.<span class="built_in">Num</span>() == <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    FExportReleaseSettings* ReleaseSettingsIns = (FExportReleaseSettings*)StructBeingCustomized[<span class="number">0</span>].<span class="built_in">Get</span>()-&gt;<span class="built_in">GetStructMemory</span>();</span><br><span class="line">    </span><br><span class="line">    IDetailCategoryBuilder&amp; VersionCategory = DetailBuilder.<span class="built_in">EditCategory</span>(<span class="string">&quot;Version&quot;</span>,FText::<span class="built_in">GetEmpty</span>(),ECategoryPriority::Default);</span><br><span class="line">    VersionCategory.<span class="built_in">SetShowAdvanced</span>(<span class="literal">true</span>);</span><br><span class="line">    </span><br><span class="line">    VersionCategory.<span class="built_in">AddCustomRow</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;ImportPakLists&quot;</span>, <span class="string">&quot;Import Pak Lists&quot;</span>),<span class="literal">true</span>)</span><br><span class="line">        .<span class="built_in">ValueContent</span>()</span><br><span class="line">        [</span><br><span class="line">            <span class="built_in">SNew</span>(SHorizontalBox)</span><br><span class="line">            + SHorizontalBox::<span class="built_in">Slot</span>()</span><br><span class="line">            .<span class="built_in">Padding</span>(<span class="number">0</span>)</span><br><span class="line">            .<span class="built_in">AutoWidth</span>()</span><br><span class="line">            [</span><br><span class="line">                <span class="built_in">SNew</span>(SButton)</span><br><span class="line">                .<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;Import&quot;</span>, <span class="string">&quot;Import&quot;</span>))</span><br><span class="line">                .<span class="built_in">ToolTipText</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;ImportPakLists_Tooltip&quot;</span>, <span class="string">&quot;Import Pak Lists&quot;</span>))</span><br><span class="line">                .<span class="built_in">IsEnabled_Lambda</span>([<span class="keyword">this</span>,ReleaseSettingsIns]()-&gt;<span class="keyword">bool</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> ReleaseSettingsIns-&gt;<span class="built_in">IsByPakList</span>();</span><br><span class="line">                &#125;)</span><br><span class="line">                .<span class="built_in">OnClicked_Lambda</span>([<span class="keyword">this</span>, ReleaseSettingsIns]()</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ReleaseSettingsIns)</span><br><span class="line">                    &#123;</span><br><span class="line">                        ReleaseSettingsIns-&gt;<span class="built_in">ImportPakLists</span>();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="built_in"><span class="keyword">return</span></span>(FReply::<span class="built_in">Handled</span>());</span><br><span class="line">                &#125;)</span><br><span class="line">            ]</span><br><span class="line">            + SHorizontalBox::<span class="built_in">Slot</span>()</span><br><span class="line">            .<span class="built_in">Padding</span>(<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">            .<span class="built_in">AutoWidth</span>()</span><br><span class="line">            [</span><br><span class="line">                <span class="built_in">SNew</span>(SButton)</span><br><span class="line">                .<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;Clear&quot;</span>, <span class="string">&quot;Clear&quot;</span>))</span><br><span class="line">                .<span class="built_in">ToolTipText</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;ClearPakLists_Tooltip&quot;</span>, <span class="string">&quot;Clear Pak Lists&quot;</span>))</span><br><span class="line">                .<span class="built_in">IsEnabled_Lambda</span>([<span class="keyword">this</span>,ReleaseSettingsIns]()-&gt;<span class="keyword">bool</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> ReleaseSettingsIns-&gt;<span class="built_in">IsByPakList</span>();</span><br><span class="line">                &#125;)</span><br><span class="line">                .<span class="built_in">OnClicked_Lambda</span>([<span class="keyword">this</span>, ReleaseSettingsIns]()</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ReleaseSettingsIns)</span><br><span class="line">                    &#123;</span><br><span class="line">                        ReleaseSettingsIns-&gt;<span class="built_in">ClearImportedPakList</span>();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="built_in"><span class="keyword">return</span></span>(FReply::<span class="built_in">Handled</span>());</span><br><span class="line">                &#125;)</span><br><span class="line">            ]</span><br><span class="line">        ];</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> LOCTEXT_NAMESPACE</span></span><br></pre></td></tr></table></figure>
<p>这里我们只是定义了一个 <code>IDetailCustomization</code> 的类，其中的 <code>CustomizeDetails</code> 是对 <code>FExportReleaseSettings</code> 添加的细节。</p>
<p>该类在创建 <code>DetailView</code> 时使用：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SHotPatcherExportRelease::CreateExportFilterListView</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// Create a property view</span></span><br><span class="line">	FPropertyEditorModule&amp; EditModule = FModuleManager::<span class="built_in">Get</span>().GetModuleChecked&lt;FPropertyEditorModule&gt;(<span class="string">&quot;PropertyEditor&quot;</span>);</span><br><span class="line"></span><br><span class="line">	FDetailsViewArgs DetailsViewArgs;</span><br><span class="line">	&#123;</span><br><span class="line">		DetailsViewArgs.bAllowSearch = <span class="literal">true</span>;</span><br><span class="line">		DetailsViewArgs.bHideSelectionTip = <span class="literal">true</span>;</span><br><span class="line">		DetailsViewArgs.bLockable = <span class="literal">false</span>;</span><br><span class="line">		DetailsViewArgs.bSearchInitialKeyFocus = <span class="literal">true</span>;</span><br><span class="line">		DetailsViewArgs.bUpdatesFromSelection = <span class="literal">false</span>;</span><br><span class="line">		DetailsViewArgs.NotifyHook = <span class="literal">nullptr</span>;</span><br><span class="line">		DetailsViewArgs.bShowOptions = <span class="literal">true</span>;</span><br><span class="line">		DetailsViewArgs.bShowModifiedPropertiesOption = <span class="literal">false</span>;</span><br><span class="line">		DetailsViewArgs.bShowScrollBar = <span class="literal">false</span>;</span><br><span class="line">		DetailsViewArgs.bShowOptions = <span class="literal">true</span>;</span><br><span class="line">		DetailsViewArgs.bUpdatesFromSelection= <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FStructureDetailsViewArgs StructureViewArgs;</span><br><span class="line">	&#123;</span><br><span class="line">		StructureViewArgs.bShowObjects = <span class="literal">true</span>;</span><br><span class="line">		StructureViewArgs.bShowAssets = <span class="literal">true</span>;</span><br><span class="line">		StructureViewArgs.bShowClasses = <span class="literal">true</span>;</span><br><span class="line">		StructureViewArgs.bShowInterfaces = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	SettingsView = EditModule.<span class="built_in">CreateStructureDetailView</span>(DetailsViewArgs, StructureViewArgs, <span class="literal">nullptr</span>);</span><br><span class="line">	FStructOnScope* Struct = <span class="keyword">new</span> <span class="built_in">FStructOnScope</span>(FExportReleaseSettings::<span class="built_in">StaticStruct</span>(), (uint8*)ExportReleaseSettings.<span class="built_in">Get</span>());</span><br><span class="line">	SettingsView-&gt;<span class="built_in">GetOnFinishedChangingPropertiesDelegate</span>().<span class="built_in">AddRaw</span>(ExportReleaseSettings.<span class="built_in">Get</span>(),&amp;FExportReleaseSettings::OnFinishedChangingProperties);</span><br><span class="line">	SettingsView-&gt;<span class="built_in">GetDetailsView</span>()-&gt;<span class="built_in">RegisterInstancedCustomPropertyLayout</span>(FExportReleaseSettings::<span class="built_in">StaticStruct</span>(),FOnGetDetailCustomizationInstance::<span class="built_in">CreateStatic</span>(&amp;FReleaseSettingsDetails::MakeInstance));</span><br><span class="line">	SettingsView-&gt;<span class="built_in">SetStructureData</span>(<span class="built_in">MakeShareable</span>(Struct));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>RegisterInstancedCustomPropertyLayout</code> 把所写的 <code>FReleaseSettingsDetails</code> 实例注册到 <code>DetailView</code> 中。注意调用时机要在 <code>SetStructureData</code> 之前。<br>然后就可以看到添加的两个按钮了：<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201026200135.webp"></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Editor</category>
      </categories>
      <tags>
        <tag>Editor</tag>
        <tag>IDetailCustomization</tag>
      </tags>
  </entry>
  <entry>
    <title>监听资源创建 / 操作事件</title>
    <url>/wiki/38218/</url>
    <content><![CDATA[<h3 id="资源创建"><a href="# 资源创建" class="headerlink" title="资源创建"></a>资源创建 </h3><p> 在 Editor 中创建资源，并没有直接保存到磁盘上，所以要监听<code>OnInMemoryAssetCreated</code>：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">FAssetRegistryModule&amp; AssetRegistryModule = FModuleManager::LoadModuleChecked&lt;FAssetRegistryModule&gt;(</span><br><span class="line">    <span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>));</span><br><span class="line">  AssetRegistryModule.<span class="built_in">Get</span>().<span class="built_in">OnInMemoryAssetCreated</span>().<span class="built_in">AddRaw</span>(<span class="keyword">this</span>, &amp;FTestEditorModule::OnInMemoryAssetCreated);</span><br></pre></td></tr></table></figure>
<p>回调过来的就是一个<code>UObject*</code>，实际上是一个<code>UBlueprint*</code>：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FTestEditorModule::OnInMemoryAssetCreated</span><span class="params">(UObject* Object)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Object) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  UBlueprint* Blueprint = Cast&lt;UBlueprint&gt;(Object);</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Blueprint) <span class="keyword">return</span>;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以实现监听 uasset 创建事件，对该 uasset 执行一些操作（如默认添加接口等）。</p>
<p>拿到 <code>UBlueprint</code> 后就可以通过 <code>FBlueprintEditorUtils</code> 等辅助类来实现对蓝图资源的操作了。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FTestEditor::AddInterface</span><span class="params">(UBlueprint* Blueprint)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Blueprint) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  UClass* Class = Blueprint ? *Blueprint-&gt;GeneratedClass : Blueprint ? Blueprint-&gt;<span class="built_in">GetClass</span>() : <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Class) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!Class-&gt;IsChildOf&lt;UUserWidget&gt;()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> UClass* InterfaceClass = UUnLuaInterface::<span class="built_in">StaticClass</span>();</span><br><span class="line"></span><br><span class="line">  UFunction* Func = FBlueprintEditorUtils::<span class="built_in">GetInterfaceFunction</span>(Blueprint, <span class="built_in">FName</span>(<span class="string">&quot;GetModuleName&quot;</span>));</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Func)</span><br><span class="line">  &#123;</span><br><span class="line">    FBlueprintEditorUtils::<span class="built_in">ImplementNewInterface</span>(Blueprint, InterfaceClass-&gt;<span class="built_in">GetFName</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Func = FBlueprintEditorUtils::<span class="built_in">GetInterfaceFunction</span>(Blueprint, <span class="built_in">FName</span>(<span class="string">&quot;GetModuleName&quot;</span>));</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Func) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> ImplementedInterfaces = Blueprint-&gt;ImplementedInterfaces;</span><br><span class="line">  <span class="keyword">if</span> (ImplementedInterfaces.<span class="built_in">Num</span>() &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> InterfacesDesc = ImplementedInterfaces[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> Graphs = InterfacesDesc.Graphs;</span><br><span class="line">  <span class="keyword">if</span> (Graphs.<span class="built_in">Num</span>() &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> Graph = Graphs[<span class="number">0</span>]; <span class="comment">//UEdGraph</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Graph) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> Nodes = Graph-&gt;Nodes;</span><br><span class="line">  <span class="keyword">if</span> (Nodes.<span class="built_in">Num</span>() &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> Node = Nodes[<span class="number">1</span>]; <span class="comment">//UEdGraphNode</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Node) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> Pins = Node-&gt;Pins;</span><br><span class="line">  <span class="keyword">if</span> (Pins.<span class="built_in">Num</span>() &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> Pin = Pins[<span class="number">1</span>]; <span class="comment">//UEdGraphPin</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Pin) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  FString moduleName;</span><br><span class="line">  UnLuaExtensionUtils::<span class="built_in">GetLuaModuleName</span>(Class-&gt;<span class="built_in">GetName</span>(), Class-&gt;<span class="built_in">GetPathName</span>(), moduleName);</span><br><span class="line"></span><br><span class="line">  Pin-&gt;DefaultValue = moduleName;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="监听资源操作事件"><a href="# 监听资源操作事件" class="headerlink" title="监听资源操作事件"></a>监听资源操作事件 </h3><p> 可以通过 <code>IAssetRegistry</code> 获取到下列事件的 delegate 并监听：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">DECLARE_DERIVED_EVENT</span>(UAssetRegistryImpl, IAssetRegistry::FAssetAddedEvent, FAssetAddedEvent);</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FAssetAddedEvent&amp; <span class="title">OnAssetAdded</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> AssetAddedEvent; &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">DECLARE_DERIVED_EVENT</span>(UAssetRegistryImpl, IAssetRegistry::FAssetRemovedEvent, FAssetRemovedEvent);</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FAssetRemovedEvent&amp; <span class="title">OnAssetRemoved</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> AssetRemovedEvent; &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">DECLARE_DERIVED_EVENT</span>(UAssetRegistryImpl, IAssetRegistry::FAssetRenamedEvent, FAssetRenamedEvent);</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FAssetRenamedEvent&amp; <span class="title">OnAssetRenamed</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> AssetRenamedEvent; &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">DECLARE_DERIVED_EVENT</span>(UAssetRegistryImpl, IAssetRegistry::FAssetUpdatedEvent, FAssetUpdatedEvent);</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FAssetUpdatedEvent&amp; <span class="title">OnAssetUpdated</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> AssetUpdatedEvent; &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">DECLARE_DERIVED_EVENT</span>(UAssetRegistryImpl, IAssetRegistry::FInMemoryAssetCreatedEvent, FInMemoryAssetCreatedEvent);</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FInMemoryAssetCreatedEvent&amp; <span class="title">OnInMemoryAssetCreated</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> InMemoryAssetCreatedEvent; &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">DECLARE_DERIVED_EVENT</span>(UAssetRegistryImpl, IAssetRegistry::FInMemoryAssetDeletedEvent, FInMemoryAssetDeletedEvent);</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FInMemoryAssetDeletedEvent&amp; <span class="title">OnInMemoryAssetDeleted</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> InMemoryAssetDeletedEvent; &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">DECLARE_DERIVED_EVENT</span>(UAssetRegistryImpl, IAssetRegistry::FFilesLoadedEvent, FFilesLoadedEvent);</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FFilesLoadedEvent&amp; <span class="title">OnFilesLoaded</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> FileLoadedEvent; &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">DECLARE_DERIVED_EVENT</span>(UAssetRegistryImpl, IAssetRegistry::FFileLoadProgressUpdatedEvent, FFileLoadProgressUpdatedEvent);</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FFileLoadProgressUpdatedEvent&amp; <span class="title">OnFileLoadProgressUpdated</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> FileLoadProgressUpdatedEvent; &#125;</span><br></pre></td></tr></table></figure>

<h3 id="监听资源保存的事件"><a href="# 监听资源保存的事件" class="headerlink" title="监听资源保存的事件"></a>监听资源保存的事件</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PackageSaved</span><span class="params">(<span class="keyword">const</span> FString&amp; PacStr,UObject* PackageSaved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">UE_LOG</span>(LogTemp,Log,<span class="built_in">TEXT</span>(<span class="string">&quot;Package %s Saved.&quot;</span>),*PacStr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FEmptyProjectModule::StartupModule</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    UPackage::PackageSavedEvent.<span class="built_in">AddStatic</span>(&amp;PackageSaved);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Editor</category>
      </categories>
      <tags>
        <tag>Editor</tag>
        <tag>Asset</tag>
      </tags>
  </entry>
  <entry>
    <title>给特定类型资源添加右键菜单选项</title>
    <url>/wiki/a70352ea/</url>
    <content><![CDATA[<p>有些需求，需要在 UE 的 <code>Content Browser</code> 里给某些资源添加一些处理功能，希望能直接选中右键进行处理。<br>UE 中提供了这样的方式，用于扩展某种类型资源的右键菜单，需要继承自<code>FAssetTypeActions_Base</code>：</p>
<figure class="highlight cpp"><figcaption><span>.h</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Engine/StaticMesh.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Toolkits/IToolkitHost.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;AssetTypeActions_Base.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Engine/PrimaryAssetLabel.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FToolMenuSection</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FMenuBuilder</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FAssetTypeActions_PrimaryAssetLabel</span> :</span> <span class="keyword">public</span> FAssetTypeActions_Base</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">// IAssetTypeActions Implementation</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> FText <span class="title">GetName</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">NSLOCTEXT</span>(<span class="string">&quot;AssetTypeActions&quot;</span>, <span class="string">&quot;AssetTypeActions_PrimaryAssetLabel&quot;</span>, <span class="string">&quot;Primary Asset Label&quot;</span>); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> FColor <span class="title">GetTypeColor</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">FColor</span>(<span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> UClass* <span class="title">GetSupportedClass</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> UPrimaryAssetLabel::<span class="built_in">StaticClass</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">HasActions</span><span class="params">(<span class="keyword">const</span> TArray&lt;UObject*&gt;&amp; InObjects )</span> <span class="keyword">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">GetActions</span><span class="params">(<span class="keyword">const</span> TArray&lt;UObject*&gt;&amp; InObjects, FToolMenuSection&amp; Section)</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="comment">// virtual void OpenAssetEditor(const TArray&lt;UObject*&gt;&amp; InObjects, TSharedPtr&lt;class IToolkitHost&gt; EditWithinLevelEditor = TSharedPtr&lt;IToolkitHost&gt;() ) override;</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> uint32 <span class="title">GetCategories</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> EAssetTypeCategories::Basic; &#125;</span><br><span class="line">	<span class="comment">// virtual class UThumbnailInfo* GetThumbnailInfo(UObject* Asset) const override;</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">IsImportedAsset</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line">	<span class="comment">// virtual void GetResolvedSourceFilePaths(const TArray&lt;UObject*&gt;&amp; TypeAssets, TArray&lt;FString&gt;&amp; OutSourceFilePaths) const override;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>其中最关键的是重写 <code>GetSupportedClass</code> 返回想要添加到哪种资源的右键菜单里。</p>
<figure class="highlight cpp"><figcaption><span>.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FAssetTypeActions_PrimaryAssetLabel::GetActions</span><span class="params">(<span class="keyword">const</span> TArray&lt;UObject*&gt;&amp; InObjects,</span></span></span><br><span class="line"><span class="params"><span class="function">	FToolMenuSection&amp; Section)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">auto</span> Labels = GetTypedWeakObjectPtrs&lt;UPrimaryAssetLabel&gt;(InObjects);</span><br><span class="line">	Section.<span class="built_in">AddMenuEntry</span>(</span><br><span class="line">	<span class="string">&quot;ObjectContext_AddToPatchIncludeFilters&quot;</span>,</span><br><span class="line">	<span class="built_in">NSLOCTEXT</span>(<span class="string">&quot;AssetTypeActions_PrimaryAssetLabel&quot;</span>, <span class="string">&quot;ObjectContext_AddToPatchIncludeFilters&quot;</span>, <span class="string">&quot;Add To Patch Include Filters&quot;</span>),</span><br><span class="line">	<span class="built_in">NSLOCTEXT</span>(<span class="string">&quot;AssetTypeActions_PrimaryAssetLabel&quot;</span>, <span class="string">&quot;ObjectContext_AddToPatchIncludeFiltersTooltip&quot;</span>, <span class="string">&quot;Add the label to HotPatcher Include Filters.&quot;</span>),</span><br><span class="line">	<span class="built_in">FSlateIcon</span>(),</span><br><span class="line">	<span class="built_in">FUIAction</span>(</span><br><span class="line">		FExecuteAction::<span class="built_in">CreateSP</span>(<span class="keyword">this</span>, &amp;FAssetTypeActions_PrimaryAssetLabel::ExecuteAddToPatchIncludeFilter, Labels)</span><br><span class="line">	));</span><br><span class="line">	Section.<span class="built_in">AddMenuEntry</span>(</span><br><span class="line">			<span class="string">&quot;ObjectContext_AddToChunkConfig&quot;</span>,</span><br><span class="line">			<span class="built_in">NSLOCTEXT</span>(<span class="string">&quot;AssetTypeActions_PrimaryAssetLabel&quot;</span>, <span class="string">&quot;ObjectContext_AddToChunkConfig&quot;</span>, <span class="string">&quot;Add To Chunk Config&quot;</span>),</span><br><span class="line">			<span class="built_in">NSLOCTEXT</span>(<span class="string">&quot;AssetTypeActions_PrimaryAssetLabel&quot;</span>, <span class="string">&quot;ObjectContext_AddToChunkConfigTooltip&quot;</span>, <span class="string">&quot;Add Label To Chunk Config&quot;</span>),</span><br><span class="line">			<span class="built_in">FSlateIcon</span>(),</span><br><span class="line">			<span class="built_in">FUIAction</span>(</span><br><span class="line">				FExecuteAction::<span class="built_in">CreateSP</span>(<span class="keyword">this</span>, &amp;FAssetTypeActions_PrimaryAssetLabel::ExecuteAddToChunkConfig, Labels)</span><br><span class="line">			));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在绑定的事件里可以处理对资源的操作流程。</p>
<p>最后，需要把所写的这个类注册到 <code>AssetTools</code> 里，可以写到 Module 的 <code>StartupModule</code> 中：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">FAssetToolsModule::<span class="built_in">GetModule</span>().<span class="built_in">Get</span>().<span class="built_in">RegisterAssetTypeActions</span>(<span class="built_in">MakeShareable</span>(<span class="keyword">new</span> FAssetTypeActions_PrimaryAssetLabel));</span><br></pre></td></tr></table></figure>
<p>效果：<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210715172415.webp"></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Editor</category>
      </categories>
      <tags>
        <tag>Editor</tag>
        <tag>Asset Tools</tag>
      </tags>
  </entry>
  <entry>
    <title>编辑器模式下焦点不在窗口内的卡顿</title>
    <url>/wiki/96599194/</url>
    <content><![CDATA[<p>在 Windows 等平台上运行 UE 时在编辑器内 Play 游戏，若当前的焦点不在编辑器 /VR 应用内，会减少对 CPU 的占用，从而出现卡顿的问题 (打包出来不会出现这个问题)。<br> 其实是因为 UE 在编辑器环境下做了不在焦点内的检测：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime/ApplicationCore/Private/Windows/WindowsPlatformApplicationMisc.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FWindowsPlatformApplicationMisc::PumpMessages</span><span class="params">(<span class="keyword">bool</span> bFromMainLoop)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!bFromMainLoop)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="function">TGuardValue&lt;<span class="keyword">bool</span>&gt; <span class="title">PumpMessageGuard</span><span class="params">(GPumpingMessagesOutsideOfMainLoop, <span class="literal">true</span> )</span></span>;</span><br><span class="line">		<span class="comment">// Process pending windows messages, which is necessary to the rendering thread in some rare cases where D3D</span></span><br><span class="line">		<span class="comment">// sends window messages (from IDXGISwapChain::Present) to the main thread owned viewport window.</span></span><br><span class="line">		<span class="built_in">WinPumpSentMessages</span>();</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	GPumpingMessagesOutsideOfMainLoop = <span class="literal">false</span>;</span><br><span class="line">	<span class="built_in">WinPumpMessages</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Determine if application has focus</span></span><br><span class="line">	<span class="keyword">bool</span> HasFocus = FApp::<span class="built_in">UseVRFocus</span>() ? FApp::<span class="built_in">HasVRFocus</span>() : FWindowsPlatformApplicationMisc::<span class="built_in">IsThisApplicationForeground</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If editor thread doesn&#x27;t have the focus, don&#x27;t suck up too much CPU time.</span></span><br><span class="line">	<span class="keyword">if</span>(GIsEditor)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">static</span> <span class="keyword">bool</span> HadFocus=<span class="number">1</span>;</span><br><span class="line">		<span class="keyword">if</span>(HadFocus &amp;&amp; !HasFocus)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Drop our priority to speed up whatever is in the foreground.</span></span><br><span class="line">			<span class="built_in">SetThreadPriority</span>(<span class="built_in">GetCurrentThread</span>(), THREAD_PRIORITY_BELOW_NORMAL);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(HasFocus &amp;&amp; !HadFocus)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Boost our priority back to normal.</span></span><br><span class="line">			<span class="built_in">SetThreadPriority</span>(<span class="built_in">GetCurrentThread</span>(), THREAD_PRIORITY_NORMAL);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(!HasFocus)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Sleep for a bit to not eat up all CPU time.</span></span><br><span class="line">			FPlatformProcess::<span class="built_in">Sleep</span>(<span class="number">0.005f</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		HadFocus = HasFocus;</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只需要把 <code>FPlatformProcess::Sleep(0.005f);</code> 这一行注释掉就可以了。</p>
<p>这个需求是因为想要在非 DS 架构下多开在编辑器进行测试，因为不在焦点就会 sleep，所以会造成收发包的卡顿。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Editor</category>
      </categories>
      <tags>
        <tag>Editor</tag>
      </tags>
  </entry>
  <entry>
    <title>跨 Level 选择 Actor</title>
    <url>/wiki/40032/</url>
    <content><![CDATA[<p>在场景中，美术和游戏逻辑是区分开的，所以有时候需要程序关卡去操控美术关卡的对象，但是 UE 的不同关卡其实是不同的资源，属于不同的 Pacakge，是不能直接跨关卡来选择对象实例的。<br>选择时会有以下错误：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">LogProperty: Warning: Illegal TEXT reference to a private object in external package (StaticMeshActor /Game/Test/Map/Level_Sub2.Level_Sub2:PersistentLevel.Cube_2) from referencer (BP_AActor_C /Game/Test/Map/Level_Sub1.Level_Sub1:PersistentLevel.BP_AActor_2).  Import failed...</span><br></pre></td></tr></table></figure>
<p>这是因为在 <code>PropertyBaseObject.cpp</code> 的<code>FObjectPropertyBase::ImportText_Internal</code>中对 Object 属性是否可以跨关卡做了检测：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">UObject* <span class="title">FObjectPropertyBase::FindImportedObject</span><span class="params">(<span class="keyword">const</span> FProperty* Property, UObject* OwnerObject, UClass* ObjectClass, UClass* RequiredMetaClass, <span class="keyword">const</span> TCHAR* Text, uint32 PortFlags<span class="comment">/*=0*/</span>, FUObjectSerializeContext* InSerializeContext <span class="comment">/*= nullptr*/</span>, <span class="keyword">bool</span> bAllowAnyPackage <span class="comment">/*= true*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">	<span class="comment">// if we found an object, and we have a parent, make sure we are in the same package if the found object is private, unless it&#x27;s a cross level property</span></span><br><span class="line">	<span class="keyword">if</span> (Result &amp;&amp; !Result-&gt;<span class="built_in">HasAnyFlags</span>(RF_Public) &amp;&amp; OwnerObject &amp;&amp; Result-&gt;<span class="built_in">GetOutermost</span>() != OwnerObject-&gt;<span class="built_in">GetOutermost</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">const</span> FObjectPropertyBase* ObjectProperty = CastField&lt;<span class="keyword">const</span> FObjectPropertyBase&gt;(Property);</span><br><span class="line">		<span class="keyword">if</span> (!ObjectProperty || !ObjectProperty-&gt;<span class="built_in">AllowCrossLevel</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogProperty, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Illegal TEXT reference to a private object in external package (%s) from referencer (%s).  Import failed...&quot;</span>), *Result-&gt;<span class="built_in">GetFullName</span>(), *OwnerObject-&gt;<span class="built_in">GetFullName</span>());</span><br><span class="line">			Result = <span class="literal">nullptr</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中 <code>AllowCrossLevel</code> 有两个继承类有覆写：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime/CoreUObject/Private/UObject/PropertyBaseObject.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FObjectPropertyBase::AllowCrossLevel</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Runtime/CoreUObject/Private/UObject/PropertyLazyObjectPtr.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FLazyObjectProperty::AllowCrossLevel</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Runtime/CoreUObject/Private/UObject/PropertySoftObjectPtr.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FSoftObjectProperty::AllowCrossLevel</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以，不能够直接通过创建 <code>FObjectPropertyBase</code> 这种硬引用方式的属性从 SubLevel1 选择 SubLevel2 中的 Actor。<br>那么如何解决这么问题呢？，上面已经列出了两个可以跨平台选择的属性，分别是 <code>FLazyObjectProperty</code> 和<code>FSoftObjectProperty</code>，那么以 <code>FSoftObjectProperty</code> 为例，可以通过 <code>TSoftObjectPtr</code> 来实现：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">TSoftObjectPtr&lt;AActor&gt; Actor;</span><br></pre></td></tr></table></figure>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201110213023.webp"></p>
<p><code>TSoftObjectPtr</code>获取到的其实是 SubLevel2 中的资源的路径：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/Game/Test/Map/Level_Sub2.Level_Sub2:PersistentLevel.Cube_2</span><br></pre></td></tr></table></figure>
<p>在运行时访问需要使用以下操作来获取：<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201110213249.webp"></p>
<p>上面蓝图中节点 <code>Load Asset Blocking</code> 是<code>UKismetSystemLibrary</code>中的函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime/Engine/Private/KismetSystemLibrary.cpp</span></span><br><span class="line"><span class="function">UObject* <span class="title">UKismetSystemLibrary::LoadAsset_Blocking</span><span class="params">(TSoftObjectPtr&lt;UObject&gt; Asset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> Asset.<span class="built_in">LoadSynchronous</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>看来 UE 加载资源时，并没有区分真正的物理资源和场景中的实例，统一使用资源的路径来加载，这一点做的非常爽，可以把另一个关卡中的 Actor 当作资源来读取，并且获取的还就是运行时的那个实例，非常 Nice。</p>
</blockquote>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Editor</category>
      </categories>
      <tags>
        <tag>Editor</tag>
      </tags>
  </entry>
  <entry>
    <title>COMPILED_PLATFORM_HEADER</title>
    <url>/wiki/35464/</url>
    <content><![CDATA[<p>在 UE4.22 之前，UE 的跨平台库的实现方式都是创建一个泛型平台类：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FGenericPlatformUtils</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GenericMethod</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>然后每个平台实现：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Windows/WindowsPlatformUtils.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FWindowsPlatformUtils</span>:</span><span class="keyword">public</span> FGenericPlatformUtils</span><br><span class="line">&#123;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GenericMethod</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="comment">//doSomething...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">typedef</span> FWindowsPlatformUtils FPlatformUtils;</span><br></pre></td></tr></table></figure>

<p>在 UE4.22 之前，需要使用下面这种方法：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// PlatformUtils.h</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">if</span> PLATFORM_ANDROID</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Android/AndroidPlatformUtils.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_IOS</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;IOS/IOSPlatformUtils.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_WINDOWS</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Windows/WindowsPlatformUtils.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_MAC</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Mac/MacPlatformUtils.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>需要手动判断每个平台再进行包含，也是比较麻烦的，在 4.23 之后，UE 引入了一个宏：<code>COMPILED_PLATFORM_HEADER</code>，可以把上面的包含简化为下面的代码：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> COMPILED_PLATFORM_HEADER(PlatformUtils.h)</span></span><br></pre></td></tr></table></figure>

<p>它是定义在 <code>Runtime/Core/Public/HAL/PreprocessorHelpers.h</code> 下的宏：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_IS_EXTENSION</span></span><br><span class="line"><span class="comment">// Creates a string that can be used to include a header in the platform extension form &quot;PlatformHeader.h&quot;, not like below form</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMPILED_PLATFORM_HEADER(Suffix) PREPROCESSOR_TO_STRING(PREPROCESSOR_JOIN(PLATFORM_HEADER_NAME, Suffix))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="comment">// Creates a string that can be used to include a header in the form &quot;Platform/PlatformHeader.h&quot;, like &quot;Windows/WindowsPlatformFile.h&quot;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMPILED_PLATFORM_HEADER(Suffix) PREPROCESSOR_TO_STRING(PREPROCESSOR_JOIN(PLATFORM_HEADER_NAME/PLATFORM_HEADER_NAME, Suffix))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>注释已经比较说明作用了。而且它还有兄弟宏：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_IS_EXTENSION</span></span><br><span class="line"><span class="comment">// Creates a string that can be used to include a header with the platform in its name, like &quot;Pre/Fix/PlatformNameSuffix.h&quot;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMPILED_PLATFORM_HEADER_WITH_PREFIX(Prefix, Suffix) PREPROCESSOR_TO_STRING(Prefix/PREPROCESSOR_JOIN(PLATFORM_HEADER_NAME, Suffix))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="comment">// Creates a string that can be used to include a header with the platform in its name, like &quot;Pre/Fix/PlatformName/PlatformNameSuffix.h&quot;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMPILED_PLATFORM_HEADER_WITH_PREFIX(Prefix, Suffix) PREPROCESSOR_TO_STRING(Prefix/PLATFORM_HEADER_NAME/PREPROCESSOR_JOIN(PLATFORM_HEADER_NAME, Suffix))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>命名有规律是多么重要的一件事…</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
      </categories>
      <tags>
        <tag>跨平台</tag>
      </tags>
  </entry>
  <entry>
    <title>Create A Standalone Application in UE4</title>
    <url>/wiki/3824a03c/</url>
    <content><![CDATA[<p>虽然 UE 是个 <strong> 游戏引擎 </strong>，但并不是只能写游戏——你甚至可以用来写 Win32 GUI 程序😏.<br> 通常，我们使用 Editor 创建一个 UE 的游戏项目，然后在其基础上构建自己的类并在游戏中使用。但是如果不想要创建一个游戏项目，UE 也支持可以独立运行的程序 (Standalone Application)，能够从<code>main</code> 函数来自主构建自己的程序，完全控制启用哪些 Modules，而不依赖于引擎本身的逻辑架构，也可以将其作为学习和测试 UE 模块的轻便方法。</p>
<blockquote>
<p><strong>注 </strong>：UE 并没有提供直接创建 Standalone Application 的方法，我自己写了一个创建<code>Program</code> 项目的工具：<a href="https://github.com/hxhb/ue4program">hxhb/ue4program</a>，并实现了一个独立运行工具的 Demo：<a href="https://github.com/hxhb/UE4Launcher">hxhb/UE4Launcher</a>。</p>
</blockquote>
<h3 id="Forward"><a href="#Forward" class="headerlink" title="Forward"></a>Forward</h3><p>本文的内容实践需要使用 <strong> 本地从源码构建出来的引擎 </strong>(源码版引擎) 而非 <strong> 从 EpicGameLauncher 安装的引擎 </strong>(安装版引擎)，我之前的文章里介绍过 UBT 是检测是否存在<code>Engine/Build/InstalledBuild.txt</code> 该文件，来判断引擎是从 Launcher 安装的还是从源码编译的，但是源码版和安装版并不是只有这么多区别，一些 ThridParty 的 <code>build.cs</code> 是不一样的，会造成源码版和安装版引擎对于相同的代码会有不同的编译行为(比如<code>Engine/Source/ThirdParty/HarfBuzz</code>)，虽然这些问题也可是可以搞定的，但是我不建议你那么做。</p>
<h3 id="Create-Program"><a href="#Create-Program" class="headerlink" title="Create Program"></a>Create Program</h3><p>首先，<a href="https://github.com/hxhb/ue4program/releases">下载 </a> 我写的<a href="https://github.com/hxhb/ue4program">hxhb/ue4program</a>，将其添加到系统的 PATH 路径中。添加之后的用法如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ue4program.exe ProgramName</span></span><br><span class="line">$ ue4program.exe StandaloneApplication</span><br></pre></td></tr></table></figure>

<p>此时会在当前目录下创建出一个 <code>StandaloneApplication</code> 文件夹，其目录结构如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">StandaloneApplication</span><br><span class="line">│  GenerateProgramProject.bat</span><br><span class="line">│  OpenProgramProject.bat</span><br><span class="line">│  StandaloneApplication.Build.cs</span><br><span class="line">│  StandaloneApplication.Target.cs</span><br><span class="line">│</span><br><span class="line">├─Resources</span><br><span class="line">│      Icon.ico</span><br><span class="line">│      Resource.h</span><br><span class="line">│      Resource.rc</span><br><span class="line">│      VersionResource.inl</span><br><span class="line">│</span><br><span class="line">└─Source</span><br><span class="line">    ├─Private</span><br><span class="line">    │  │  RealExecutionMain.cpp</span><br><span class="line">    │  │  StandaloneApplication.cpp</span><br><span class="line">    │  │</span><br><span class="line">    │  ├─Console</span><br><span class="line">    │  │      ConsoleMain.cpp</span><br><span class="line">    │  │</span><br><span class="line">    │  └─Windows</span><br><span class="line">    │          WindowsMain.cpp</span><br><span class="line">    │</span><br><span class="line">    └─Public</span><br><span class="line">            RealExecutionMain.h</span><br><span class="line">            StandaloneApplication.h</span><br><span class="line">            StandaloneApplicationLog.h</span><br></pre></td></tr></table></figure>
<p>本篇文章着重需要分析的是 <code>*.target.cs</code> 与<code>*.build.cs</code>这两个文件.<br>创建出来之后，需要将 <code>StandaloneApplication</code> 文件夹移动到 <code>Engine\Source\Programs</code> 下，UE 所有的辅助程序 (UHT/UBT 等) 都在这个目录之下。<br>然后，运行 <code>GenerateProgramProject.bat</code>，这是我仿照 UE 的<code>GenerateProjectFiles.bat</code> 写的一个脚本，通过调用 UBT 来创建 <code>Standalone Application</code> 程序，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># bash path in Engine\Source\Programs\StandaloneApplication</span></span><br><span class="line">$ UnrealBuildTool.exe -notinstallengine -ProjectFiles StandaloneApplication</span><br></pre></td></tr></table></figure>
<p><strong>注意 </strong>：直接在安装版引擎中使用上面的命令会报错(不允许创建非 Game 项目)，因为虽然传入了<code>-notinstallengine</code> 参数，但是对 <code>Engine/Build/InstalledBuild.txt</code> 文件检测的优先级高于<code>-notinstallengine</code>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Zhalipeng MINGW64 /d/UE_4.18/Engine/Source/Programs/StandaloneApplication (master)</span><br><span class="line">$ ../../../../Engine/Binaries/DotNET/UnrealBuildTool.exe -notinstallengine -ProjectFiles StandaloneApplication</span><br><span class="line">ERROR: UnrealBuildTool Exception: A game project path was not specified, <span class="built_in">which</span> is required when generating project files using an installed build or passing -game on the <span class="built_in">command</span> line</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我写的脚本中做了检测，如果使用的是安装版引擎会先重命名 <strong>InstalledBuild.txt</strong>，生产完毕后会恢复(但是我还是建议不要在安装版引擎中执行)。其执行完毕后会在<code>Engine\Intermediate\ProjectFiles</code> 下生成：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">StandaloneApplication.vcxproj</span><br><span class="line">StandaloneApplication.vcxproj.filters</span><br><span class="line">StandaloneApplication.vcxproj.user</span><br></pre></td></tr></table></figure>
<p>其实就是将当前项目添加到 UE 的解决方案，执行完毕之后，打开引擎根目录下的 <code>UE4.sln</code>, 就可以看到创建的项目了：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/31962/UE4sln_Solution.webp"><br> 先来编译运行看一下结果：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/31962/run-template-program.webp"></p>
<h3 id="Program-target-cs"><a href="#Program-target-cs" class="headerlink" title="Program *.target.cs"></a>Program *.target.cs</h3><p>UBT 支持数种 Target 类型(通过枚举类型 TargetType 来指定):</p>
<ul>
<li><strong>Game</strong>: 独立运行的游戏;</li>
<li><strong>Client</strong>: 与 Game 相同，但不包含任何服务器代码;</li>
<li><strong>Server</strong>: 与 Game 相同，但不包含任何客户端代码;</li>
<li><strong>Editor</strong>:UE 编辑器的扩展;</li>
<li><strong>Program</strong>: 独立运行的程序;</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// Engine/Source/Programs/UnrealBuildTool/Configuration/TargetRules.cs</span><br><span class="line">public enum TargetType</span><br><span class="line">&#123;</span><br><span class="line">  // Cooked monolithic game executable (GameName.exe).  Also used for a game-agnostic engine executable (UE4Game.exe or RocketGame.exe)</span><br><span class="line">  Game,</span><br><span class="line">  // Uncooked modular editor executable and DLLs (UE4Editor.exe, UE4Editor*.dll, GameName*.dll)</span><br><span class="line">  Editor,</span><br><span class="line">  // Cooked monolithic game client executable (GameNameClient.exe, but no server code)</span><br><span class="line">  Client,</span><br><span class="line">  // Cooked monolithic game server executable (GameNameServer.exe, but no client code)</span><br><span class="line">  Server,</span><br><span class="line">  // Program (standalone program, e.g. ShaderCompileWorker.exe, can be modular or monolithic depending on the program)</span><br><span class="line">  Program,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于 <code>.target.cs</code> 的文档介绍：<a href="https://docs.unrealengine.com/en-us/Programming/BuildTools/UnrealBuildTool/TargetFiles">UnrealBuildTool/Targets</a>.</p>
<p><a href="https://github.com/hxhb/ue4program">hxhb/ue4program</a>创建生成的 <code>*.target.cs</code> 模板：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">using UnrealBuildTool;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line"></span><br><span class="line">[SupportedPlatforms(UnrealPlatformClass.All)]</span><br><span class="line">public class StandaloneApplicationTarget : TargetRules</span><br><span class="line">&#123;</span><br><span class="line">    public StandaloneApplicationTarget(TargetInfo Target) : base(Target)</span><br><span class="line">    &#123;</span><br><span class="line">        Type = TargetType.Program;</span><br><span class="line">        LinkType = TargetLinkType.Monolithic;</span><br><span class="line">        LaunchModuleName = &quot;StandaloneApplication&quot;;</span><br><span class="line">        ExtraModuleNames.Add(&quot;EditorStyle&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public override void SetupGlobalEnvironment(</span><br><span class="line">        TargetInfo Target,</span><br><span class="line">        ref LinkEnvironmentConfiguration OutLinkEnvironmentConfiguration,</span><br><span class="line">        ref CPPEnvironmentConfiguration OutCPPEnvironmentConfiguration</span><br><span class="line">        )</span><br><span class="line">    &#123;</span><br><span class="line">        // Lean and mean</span><br><span class="line">        bCompileLeanAndMeanUE = true;</span><br><span class="line"></span><br><span class="line">        // No editor or editor-only data is needed</span><br><span class="line">        bBuildEditor = false;</span><br><span class="line"></span><br><span class="line">        // Whether to compile WITH_EDITORONLY_DATA disabled. Only Windows will use this, other platforms force this to false.</span><br><span class="line">        //bBuildWithEditorOnlyData = false;</span><br><span class="line"></span><br><span class="line">        // Compile out references from Core to the rest of the engine</span><br><span class="line">        bCompileAgainstEngine = false;</span><br><span class="line"></span><br><span class="line">        // Enabled for all builds that include the CoreUObject project. Disabled only when building standalone apps that only link with Core.</span><br><span class="line">        bCompileAgainstCoreUObject = true;</span><br><span class="line"></span><br><span class="line">        // Whether to include plugin support.</span><br><span class="line">        bCompileWithPluginSupport = true;</span><br><span class="line"></span><br><span class="line">        // Enable exceptions for all modules</span><br><span class="line">        bForceEnableExceptions = false;</span><br><span class="line"></span><br><span class="line">        // Enable RTTI for all modules.</span><br><span class="line">        // bForceEnableRTTI = true;</span><br><span class="line"></span><br><span class="line">        // If ture the program entrance is WinMain,otherwise entrance is main</span><br><span class="line">        bIsBuildingConsoleApplication = false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>目前，最需要关注的参数只有三个：</p>
<ul>
<li><strong>Type</strong>：需要指定为需要构建的目标类型<code>TargetType.Program</code>.</li>
<li><strong>LinkType</strong>：指定为 <code>TargetLinkType.Monolithic</code> 则将目标编译成一个单个的可执行文件(不依赖任何 DLL).</li>
<li><strong>bIsBuildingConsoleApplication</strong>：<code>ture</code>支持 Console，函数入口为 <code>main</code>;<code>false</code> 则不支持 Console，主函数入口为<code>WinMain</code>.</li>
</ul>
<p>其他参数的 (RTTI/Exceptions) 均能在用到时根据需求从文档查询。</p>
<h3 id="Program-Build-cs"><a href="#Program-Build-cs" class="headerlink" title="Program *.Build.cs"></a>Program *.Build.cs</h3><p>Program 的 <code>*.Build.cs</code> 与普通的游戏项目的没有区别 (因为 Game 是一个模块，Program 也是)，唯一的区别就是将这些模块构建成什么样的目标类型(由<code>*.target.cs</code> 决定)。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
      </categories>
      <tags>
        <tag>Engine</tag>
        <tag>工具</tag>
        <tag>Standalone Application</tag>
      </tags>
  </entry>
  <entry>
    <title>Delegate 分析</title>
    <url>/wiki/36829/</url>
    <content><![CDATA[<p>UE 的 <code>Delegate</code> 分了几个不同的种类，普通的代理是模板类，<code>Dynamic Delegate</code>是通过宏展开生成类，<code>Dynamic Mulitcast Delegate</code>需要 UHT 参与生成代码，所以动态多播代理只能写到包含 <code>generated.h</code> 的文件中。</p>
<ul>
<li><a href="https://docs.unrealengine.com/en-US/Programming/UnrealArchitecture/Delegates/index.html#DeclaringDelegates">Delegates</a></li>
<li><a href="https://docs.unrealengine.com/en-US/Programming/UnrealArchitecture/Delegates/Multicast/index.html">Multi-cast Delegates</a></li>
<li><a href="https://docs.unrealengine.com/en-US/Programming/UnrealArchitecture/Delegates/Dynamic/index.html">Dynamic Delegates</a></li>
</ul>
<h3 id="Delegate"><a href="#Delegate" class="headerlink" title="Delegate"></a>Delegate</h3><ul>
<li><code>DECLARE_DELEGATE</code>：普通代理，可以被值传递，本质实现是 <code>TBaseDelegare&lt;__VA_ARGS__&gt;</code> 的对象，可以使用 <code>BindUObject</code> 等函数。</li>
</ul>
<p><code>TBaseDelegate</code>里定义了很多的辅助函数，如 <code>BindSP</code>/<code>BindRaw</code>/<code>BindStatic</code>/<code>CreateSP</code> 等。</p>
<h3 id="Dynamic-Delegate"><a href="#Dynamic-Delegate" class="headerlink" title="Dynamic Delegate"></a>Dynamic Delegate</h3><ul>
<li><code>DECLARE_DYNAMIC_DELEGATE</code>：动态代理可以序列化，其函数可按命名查找，执行速度比常规代理慢。</li>
</ul>
<p>动态代理本质上是继承自 <code>TBaseDynamicDelegate</code> 的类，<code>TBaseDynamicDelegate</code>又继承自<code>TScriptDelegate</code>，所以动态代理可以绑定 UObject 和绑定 UFUNCTION。</p>
<p>其中 <code>BindUFunction</code> 是<code>TScriptInterface</code>的函数，而 <code>BindUbject</code> 是个宏，定义在 <code>Delegate.h</code> 中。</p>
<p>代码分析：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">DECLARE_DYNAMIC_DELEGATE_OneParam</span>(FOnTestDynamicDelegate, <span class="keyword">const</span> FString&amp;, InStr);</span><br></pre></td></tr></table></figure>

<p><code>DECLARE_DYNAMIC_DELEGATE_OneParam</code>的宏定义为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_DYNAMIC_DELEGATE_OneParam(DelegateName, Param1Type, Param1Name) BODY_MACRO_COMBINE(CURRENT_FILE_ID,_,__LINE__,_DELEGATE) FUNC_DECLARE_DYNAMIC_DELEGATE(FWeakObjectPtr, DelegateName, DelegateName##_DelegateWrapper, FUNC_CONCAT( Param1Type InParam1), FUNC_CONCAT(*this, InParam1), void, Param1Type )</span></span><br></pre></td></tr></table></figure>

<p><code>BODY_MACRO_COMBINE</code>宏其经过 UHT 之后生成的代码为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GWorldClient_Plugins_HotPackage_HotPatcher_Source_HotPatcherEditor_Private_CreatePatch_ExportPatchSettings_h_22_DELEGATE \</span></span><br><span class="line"><span class="meta">struct _Script_HotPatcherEditor_eventOnTestDynamicDelegate_Parms \</span></span><br><span class="line"><span class="meta">&#123; \</span></span><br><span class="line"><span class="meta">	FString InStr; \</span></span><br><span class="line"><span class="meta">&#125;; \</span></span><br><span class="line"><span class="meta">static inline void FOnTestDynamicDelegate_DelegateWrapper(const FScriptDelegate&amp; OnTestDynamicDelegate, const FString&amp; InStr) \</span></span><br><span class="line"><span class="meta">&#123; \</span></span><br><span class="line"><span class="meta">	_Script_HotPatcherEditor_eventOnTestDynamicDelegate_Parms Parms; \</span></span><br><span class="line"><span class="meta">	Parms.InStr=InStr; \</span></span><br><span class="line"><span class="meta">	OnTestDynamicDelegate.ProcessDelegate<span class="meta-string">&lt;UObject&gt;</span>(&amp;Parms); \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br></pre></td></tr></table></figure>
<p>进行展开之后，可以看到使用 <code>DECLARE_DYNAMIC_DELEGATE_OneParam</code> 声明的代理实际上是就被定义了一个 static 函数。</p>
<p><code>FUNC_DECLARE_DYNAMIC_DELEGATE</code>宏是裹了一个<code>TBaseDynamicDelegate</code>：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** Declare user&#x27;s dynamic delegate, with wrapper proxy method for executing the delegate */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FUNC_DECLARE_DYNAMIC_DELEGATE(TWeakPtr, DynamicDelegateName, ExecFunction, FuncParamList, FuncParamPassThru, ...) \</span></span><br><span class="line"><span class="meta">	class DynamicDelegateName : public TBaseDynamicDelegate<span class="meta-string">&lt;TWeakPtr, __VA_ARGS__&gt;</span> \</span></span><br><span class="line"><span class="meta">	&#123; \</span></span><br><span class="line"><span class="meta">	public: \</span></span><br><span class="line"><span class="meta">		<span class="comment">/** Default constructor */</span> \</span></span><br><span class="line"><span class="meta">		DynamicDelegateName() \</span></span><br><span class="line"><span class="meta">		&#123; \</span></span><br><span class="line"><span class="meta">		&#125; \</span></span><br><span class="line"><span class="meta">		\</span></span><br><span class="line"><span class="meta">		<span class="comment">/** Construction from an FScriptDelegate must be explicit.  This is really only used by UObject system internals. */</span> \</span></span><br><span class="line"><span class="meta">		explicit DynamicDelegateName(const TScriptDelegate<span class="meta-string">&lt;&gt;</span>&amp; InScriptDelegate ) \</span></span><br><span class="line"><span class="meta">			: TBaseDynamicDelegate<span class="meta-string">&lt;TWeakPtr, __VA_ARGS__&gt;</span>(InScriptDelegate) \</span></span><br><span class="line"><span class="meta">		&#123; \</span></span><br><span class="line"><span class="meta">		&#125; \</span></span><br><span class="line"><span class="meta">		\</span></span><br><span class="line"><span class="meta">		<span class="comment">/** Execute the delegate.  If the function pointer is not valid, an error will occur. */</span> \</span></span><br><span class="line"><span class="meta">		inline void Execute(FuncParamList) const \</span></span><br><span class="line"><span class="meta">		&#123; \</span></span><br><span class="line"><span class="meta">			<span class="comment">/* Verify that the user object is still valid.  We only have a weak reference to it. */</span> \</span></span><br><span class="line"><span class="meta">			checkSlow(IsBound() ); \</span></span><br><span class="line"><span class="meta">			ExecFunction(FuncParamPassThru); \</span></span><br><span class="line"><span class="meta">		&#125; \</span></span><br><span class="line"><span class="meta">		<span class="comment">/** Execute the delegate, but only if the function pointer is still valid */</span> \</span></span><br><span class="line"><span class="meta">		inline bool ExecuteIfBound(FuncParamList) const \</span></span><br><span class="line"><span class="meta">		&#123; \</span></span><br><span class="line"><span class="meta">			<span class="meta-keyword">if</span>(IsBound() ) \</span></span><br><span class="line"><span class="meta">			&#123; \</span></span><br><span class="line"><span class="meta">				ExecFunction(FuncParamPassThru); \</span></span><br><span class="line"><span class="meta">				return true; \</span></span><br><span class="line"><span class="meta">			&#125; \</span></span><br><span class="line"><span class="meta">			return false; \</span></span><br><span class="line"><span class="meta">		&#125; \</span></span><br><span class="line"><span class="meta">	&#125;;</span></span><br></pre></td></tr></table></figure>

<p>所有的宏都被展开之后：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">Script_HotPatcherEditor_eventOnTestDynamicDelegate_Parms</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	FString InStr;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">FOnTestDynamicDelegate_DelegateWrapper</span><span class="params">(<span class="keyword">const</span> FScriptDelegate&amp; OnTestDynamicDelegate, <span class="keyword">const</span> FString&amp; InStr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	_Script_HotPatcherEditor_eventOnTestDynamicDelegate_Parms Parms;</span><br><span class="line">	Parms.InStr=InStr;</span><br><span class="line">	OnTestDynamicDelegate.ProcessDelegate&lt;UObject&gt;(&amp;Parms);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FOnTestDynamicDelegate</span> :</span> <span class="keyword">public</span> TBaseDynamicDelegate&lt;FWeakObjectPtr, <span class="keyword">void</span>, <span class="keyword">const</span> FString&amp;&gt;</span><br><span class="line">&#123; </span><br><span class="line"><span class="keyword">public</span>: </span><br><span class="line">	<span class="built_in">FOnTestDynamicDelegate</span>() &#123; &#125; </span><br><span class="line">	<span class="function"><span class="keyword">explicit</span> <span class="title">FOnTestDynamicDelegate</span><span class="params">(<span class="keyword">const</span> TScriptDelegate&lt;&gt;&amp; InScriptDelegate )</span> : TBaseDynamicDelegate&lt;FWeakObjectPtr, void, const FString&amp;&gt;(InScriptDelegate) &#123;</span> &#125; </span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">Execute</span><span class="params">(<span class="keyword">const</span> FString&amp; InStr )</span> <span class="keyword">const</span> </span>&#123; <span class="built_in">checkSlow</span>(<span class="built_in">IsBound</span>()); <span class="built_in">FOnTestDynamicDelegate_DelegateWrapper</span>(*<span class="keyword">this</span>, InStr ); &#125; </span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">ExecuteIfBound</span><span class="params">(<span class="keyword">const</span> FString&amp; InStr )</span> <span class="keyword">const</span> </span></span><br><span class="line"><span class="function">	</span>&#123; </span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">IsBound</span>()) </span><br><span class="line">		&#123; </span><br><span class="line">			<span class="built_in">FOnTestDynamicDelegate_DelegateWrapper</span>(*<span class="keyword">this</span>, InStr ); </span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>; </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125; </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在使用的时候可以通过 <code>BindUFunction</code> 来绑定函数，通过 <code>Execute</code> 或者 <code>ExecuteIfBound</code> 来调用。</p>
<p>在当作回调函数传递的时候比较方便，因为它继承自<code>FScriptDelegate</code>，可以当作通用的方式传递。</p>
<h3 id="Multicast-Delegate"><a href="#Multicast-Delegate" class="headerlink" title="Multicast Delegate"></a>Multicast Delegate</h3><ul>
<li><strong>多播代理 </strong>：与普通代理的大部分功能相同，它们只拥有对象的弱引用，可以和结构体一起使用，可以复制。其本质是<code>TMulticastDelegate&lt;__VA_ARGS__&gt;</code> 的对象。多播代理可以被加载 / 保存和远程触发，但多播代理不能使用返回值。</li>
</ul>
<p>多播代理可以具有多个绑定，当 <code>Broadcast</code> 触发时，所有的绑定都会被调用。</p>
<p>多播代理可以使用 <code>Add</code>/<code>AddStatic</code>/<code>AddRaw</code>/<code>AddSP</code>/<code>AddUObject</code>/<code>Remove</code>/<code>RemoveAll</code> 等函数。</p>
<blockquote>
<p>注意：RemoveAll 会删除所有绑定时提供指针的代理，未绑定到对象的 <code>Raw</code> 代理不会被该函数删除。</p>
</blockquote>
<h3 id="Dynamic-Multicast-Delegate"><a href="#Dynamic-Multicast-Delegate" class="headerlink" title="Dynamic Multicast Delegate"></a>Dynamic Multicast Delegate</h3><ul>
<li><code>DECLARE_DYNAMIC_MULITCAST_DELEGATE</code>：动态多播代理。</li>
</ul>
<p>动态多播代理必须要绑定到 UFUNCTION 的函数，使用宏 <code>AddDynamic</code> 或者 <code>AddUnique</code> 来添加绑定。</p>
<p>代码分析：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam</span>(FOnTestDynamicMultiDelegate, <span class="keyword">const</span> FString&amp;, InStr);</span><br></pre></td></tr></table></figure>
<p><code>DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam</code>其宏定义为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam(DelegateName, Param1Type, Param1Name)\</span></span><br><span class="line"><span class="meta"> BODY_MACRO_COMBINE(CURRENT_FILE_ID,_,__LINE__,_DELEGATE)\</span></span><br><span class="line"><span class="meta"> FUNC_DECLARE_DYNAMIC_MULTICAST_DELEGATE(FWeakObjectPtr, DelegateName, DelegateName##_DelegateWrapper, FUNC_CONCAT( Param1Type InParam1), FUNC_CONCAT(*this, InParam1), void, Param1Type )</span></span><br></pre></td></tr></table></figure>
<p>其中 <code>BODY_MACRO_COMBINE</code> 经过 UHT 之后生成下列代码：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GWorldClient_Plugins_HotPackage_HotPatcher_Source_HotPatcherEditor_Private_CreatePatch_ExportPatchSettings_h_22_DELEGATE \</span></span><br><span class="line"><span class="meta">struct _Script_HotPatcherEditor_eventOnTestDynamicMultiDelegate_Parms \</span></span><br><span class="line"><span class="meta">&#123; \</span></span><br><span class="line"><span class="meta">	FString InStr; \</span></span><br><span class="line"><span class="meta">&#125;; \</span></span><br><span class="line"><span class="meta">static inline void FOnTestDynamicMultiDelegate_DelegateWrapper(const FMulticastScriptDelegate&amp; OnTestDynamicMultiDelegate, const FString&amp; InStr) \</span></span><br><span class="line"><span class="meta">&#123; \</span></span><br><span class="line"><span class="meta">	_Script_HotPatcherEditor_eventOnTestDynamicMultiDelegate_Parms Parms; \</span></span><br><span class="line"><span class="meta">	Parms.InStr=InStr; \</span></span><br><span class="line"><span class="meta">	OnTestDynamicMultiDelegate.ProcessMulticastDelegate<span class="meta-string">&lt;UObject&gt;</span>(&amp;Parms); \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br></pre></td></tr></table></figure>
<p><code>FUNC_DECLARE_DYNAMIC_MULTICAST_DELEGATE</code>则创建了一个继承自 <code>TBaseDynamicMulticastDelegate</code> 类：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** Declare user&#x27;s dynamic multi-cast delegate, with wrapper proxy method for executing the delegate */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FUNC_DECLARE_DYNAMIC_MULTICAST_DELEGATE(TWeakPtr, DynamicMulticastDelegateName, ExecFunction, FuncParamList, FuncParamPassThru, ...) \</span></span><br><span class="line"><span class="meta">class DynamicMulticastDelegateName : public TBaseDynamicMulticastDelegate<span class="meta-string">&lt;TWeakPtr, __VA_ARGS__&gt;</span> \</span></span><br><span class="line"><span class="meta">	&#123; \</span></span><br><span class="line"><span class="meta">	public: \</span></span><br><span class="line"><span class="meta">		<span class="comment">/** Default constructor */</span> \</span></span><br><span class="line"><span class="meta">		DynamicMulticastDelegateName() \</span></span><br><span class="line"><span class="meta">		&#123; \</span></span><br><span class="line"><span class="meta">		&#125; \</span></span><br><span class="line"><span class="meta">		\</span></span><br><span class="line"><span class="meta">		<span class="comment">/** Construction from an FMulticastScriptDelegate must be explicit.  This is really only used by UObject system internals. */</span> \</span></span><br><span class="line"><span class="meta">		explicit DynamicMulticastDelegateName(const TMulticastScriptDelegate<span class="meta-string">&lt;&gt;</span>&amp; InMulticastScriptDelegate ) \</span></span><br><span class="line"><span class="meta">			: TBaseDynamicMulticastDelegate<span class="meta-string">&lt;TWeakPtr, __VA_ARGS__&gt;</span>(InMulticastScriptDelegate) \</span></span><br><span class="line"><span class="meta">		&#123; \</span></span><br><span class="line"><span class="meta">		&#125; \</span></span><br><span class="line"><span class="meta">		\</span></span><br><span class="line"><span class="meta">		<span class="comment">/** Broadcasts this delegate to all bound objects, except to those that may have expired */</span> \</span></span><br><span class="line"><span class="meta">		void Broadcast(FuncParamList) const \</span></span><br><span class="line"><span class="meta">		&#123; \</span></span><br><span class="line"><span class="meta">			ExecFunction(FuncParamPassThru); \</span></span><br><span class="line"><span class="meta">		&#125; \</span></span><br><span class="line"><span class="meta">	&#125;;</span></span><br></pre></td></tr></table></figure>
<p><code>FUNC_CONCT</code>宏只是简单的拼接：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** Helper macro that enables passing comma-separated arguments as a single macro parameter */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FUNC_CONCAT(...) __VA_ARGS__</span></span><br></pre></td></tr></table></figure>
<p>展开所有宏之后的代码：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">Script_HotPatcherEditor_eventOnTestDynamicMultiDelegate_Parms</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	FString InStr;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">FOnTestDynamicMultiDelegate_DelegateWrapper</span><span class="params">(<span class="keyword">const</span> FMulticastScriptDelegate&amp; OnTestDynamicMultiDelegate, <span class="keyword">const</span> FString&amp; InStr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	_Script_HotPatcherEditor_eventOnTestDynamicMultiDelegate_Parms Parms;</span><br><span class="line">	Parms.InStr=InStr;</span><br><span class="line">	OnTestDynamicMultiDelegate.ProcessMulticastDelegate&lt;UObject&gt;(&amp;Parms);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FOnTestDynamicMultiDelegate</span> :</span> <span class="keyword">public</span> TBaseDynamicMulticastDelegate&lt;FWeakObjectPtr, <span class="keyword">void</span>, <span class="keyword">const</span> FString&amp;&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>: </span><br><span class="line">	<span class="built_in">FOnTestDynamicMultiDelegate</span>() &#123; &#125; </span><br><span class="line">	<span class="function"><span class="keyword">explicit</span> <span class="title">FOnTestDynamicMultiDelegate</span><span class="params">(<span class="keyword">const</span> TMulticastScriptDelegate&lt;&gt;&amp; InMulticastScriptDelegate )</span> : TBaseDynamicMulticastDelegate&lt;FWeakObjectPtr, void, const FString&amp;&gt;(InMulticastScriptDelegate) &#123;</span> &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Broadcast</span><span class="params">(<span class="keyword">const</span> FString&amp; InStr )</span> <span class="keyword">const</span> </span>&#123; <span class="built_in">FOnTestDynamicMultiDelegate_DelegateWrapper</span>(*<span class="keyword">this</span>, InStr ); &#125; </span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注，由上面的代码可知，只有普通代理（<code>DECLARE_DELEGATE</code>）声明的代理才可以使用 <code>TBaseDelegate</code> 的<code>BindUObject</code>等函数，动态代理和多播代理都不可以。</p>
</blockquote>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
      </categories>
      <tags>
        <tag>Delegate</tag>
      </tags>
  </entry>
  <entry>
    <title>DoesPackageExists 分析</title>
    <url>/wiki/11264/</url>
    <content><![CDATA[<p>该函数用来检测 Package 是否 <strong> 在磁盘上存在</strong>：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">COREUOBJECT_API</span> <span class="title">FPackageName</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Checks if the package exists on disk.</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * @param LongPackageName Package name.</span></span><br><span class="line"><span class="comment">   * @param OutFilename Package filename on disk.</span></span><br><span class="line"><span class="comment">   * @param InAllowTextFormats Detect text format packages as well as binary (priority to text)</span></span><br><span class="line"><span class="comment">   * @return true if the specified package name points to an existing package, false otherwise.</span></span><br><span class="line"><span class="comment">   **/</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">DoesPackageExist</span><span class="params">(<span class="keyword">const</span> FString&amp; LongPackageName, <span class="keyword">const</span> FGuid* Guid = <span class="literal">NULL</span>, FString* OutFilename = <span class="literal">NULL</span>, <span class="keyword">bool</span> InAllowTextFormats = <span class="literal">true</span>)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：在磁盘上存在在 UE 里有两个情况：</p>
<ol>
<li>Editor 下存在 uasset 文件</li>
<li>打包模式下 uasset 是否在 Mounted 的 Pak 中存在</li>
</ol>
<p>事实上，UE 也是这么做检测的：</p>
<ol>
<li>首先把要检测的 LongPackageName 根据规则转换为文件路径</li>
<li>通过 FileManager 来检测文件路径是否存在</li>
</ol>
<p>在 Editor 和打包模式下，FileManager 通过 <code>GetLowLevel()</code> 拿到<code>IPlatformFile</code>，之后再进行 FileExist 的检测，UE 针对各个平台封装了<code>IPlatformFile</code>，而且也具有 PakPlatformFile 的实现，可以实现从 Pak 中读取文件与在普通文件系统中访问一样的接口。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210224143321.webp"><br>UE 的跨平台写法，声明在通用接口里，定义在各个平台的单独文件中：<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210224143807.webp"></p>
<p>在引擎启动时会把这些 <code>IPlatformFile</code> 的对象创建：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/Launch/Private/LaunchEngineLoop.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Look for any file overrides on the command line (i.e. network connection file handler)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">LaunchCheckForFileOverride</span><span class="params">(<span class="keyword">const</span> TCHAR* CmdLine, <span class="keyword">bool</span>&amp; OutFileOverrideFound)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  OutFileOverrideFound = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Get the physical platform file.</span></span><br><span class="line">  IPlatformFile* CurrentPlatformFile = &amp;FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">GetPlatformFile</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Try to create pak file wrapper</span></span><br><span class="line">  &#123;</span><br><span class="line">    IPlatformFile* PlatformFile = <span class="built_in">ConditionallyCreateFileWrapper</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;PakFile&quot;</span>), CurrentPlatformFile, CmdLine);</span><br><span class="line">    <span class="keyword">if</span> (PlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = PlatformFile;</span><br><span class="line">      FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">SetPlatformFile</span>(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line">    PlatformFile = <span class="built_in">ConditionallyCreateFileWrapper</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;CachedReadFile&quot;</span>), CurrentPlatformFile, CmdLine);</span><br><span class="line">    <span class="keyword">if</span> (PlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = PlatformFile;</span><br><span class="line">      FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">SetPlatformFile</span>(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Try to create sandbox wrapper</span></span><br><span class="line">  &#123;</span><br><span class="line">    IPlatformFile* PlatformFile = <span class="built_in">ConditionallyCreateFileWrapper</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;SandboxFile&quot;</span>), CurrentPlatformFile, CmdLine);</span><br><span class="line">    <span class="keyword">if</span> (PlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = PlatformFile;</span><br><span class="line">      FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">SetPlatformFile</span>(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !UE_BUILD_SHIPPING <span class="comment">// UFS clients are not available in shipping builds.</span></span></span><br><span class="line">  <span class="comment">// Streaming network wrapper (it has a priority over normal network wrapper)</span></span><br><span class="line">  <span class="keyword">bool</span> bNetworkFailedToInitialize = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">bool</span> bShouldUseStreamingFile = <span class="literal">false</span>;</span><br><span class="line">    IPlatformFile* NetworkPlatformFile = <span class="built_in">ConditionallyCreateFileWrapper</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;StreamingFile&quot;</span>), CurrentPlatformFile, CmdLine, &amp;bNetworkFailedToInitialize, &amp;bShouldUseStreamingFile);</span><br><span class="line">    <span class="keyword">if</span> (NetworkPlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = NetworkPlatformFile;</span><br><span class="line">      FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">SetPlatformFile</span>(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> bShouldUseCookedIterativeFile = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (!bShouldUseStreamingFile &amp;&amp; !NetworkPlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      NetworkPlatformFile = <span class="built_in">ConditionallyCreateFileWrapper</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;CookedIterativeFile&quot;</span>), CurrentPlatformFile, CmdLine, &amp;bNetworkFailedToInitialize, &amp;bShouldUseCookedIterativeFile);</span><br><span class="line">      <span class="keyword">if</span> (NetworkPlatformFile)</span><br><span class="line">      &#123;</span><br><span class="line">        CurrentPlatformFile = NetworkPlatformFile;</span><br><span class="line">        FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">SetPlatformFile</span>(*CurrentPlatformFile);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if streaming network platform file was tried this loop don&#x27;t try this one</span></span><br><span class="line">    <span class="comment">// Network file wrapper (only create if the streaming wrapper hasn&#x27;t been created)</span></span><br><span class="line">    <span class="keyword">if</span> (!bShouldUseStreamingFile &amp;&amp; !bShouldUseCookedIterativeFile &amp;&amp; !NetworkPlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      NetworkPlatformFile = <span class="built_in">ConditionallyCreateFileWrapper</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;NetworkFile&quot;</span>), CurrentPlatformFile, CmdLine, &amp;bNetworkFailedToInitialize);</span><br><span class="line">      <span class="keyword">if</span> (NetworkPlatformFile)</span><br><span class="line">      &#123;</span><br><span class="line">        CurrentPlatformFile = NetworkPlatformFile;</span><br><span class="line">        FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">SetPlatformFile</span>(*CurrentPlatformFile);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bNetworkFailedToInitialize)</span><br><span class="line">    &#123;</span><br><span class="line">      FString HostIpString;</span><br><span class="line">      FParse::<span class="built_in">Value</span>(CmdLine, <span class="built_in">TEXT</span>(<span class="string">&quot;-FileHostIP=&quot;</span>), HostIpString);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_REQUIRES_FILESERVER</span></span><br><span class="line">      FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Failed to connect to file server at %s. RETRYING in 5s.\n&quot;</span>), *HostIpString);</span><br><span class="line">      FPlatformProcess::<span class="built_in">Sleep</span>(<span class="number">5.0f</span>);</span><br><span class="line">      uint32 Result = <span class="number">2</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span> <span class="comment">//PLATFORM_REQUIRES_FILESERVER</span></span></span><br><span class="line">      <span class="comment">// note that this can&#x27;t be localized because it happens before we connect to a filserver - localizing would cause ICU to try to load.... from over the file server connection!</span></span><br><span class="line">      FString Error = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Failed to connect to any of the following file servers:\n\n    %s\n\nWould you like to try again? No will fallback to local disk files, Cancel will quit.&quot;</span>), *HostIpString.<span class="built_in">Replace</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;+&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;\n    &quot;</span>)));</span><br><span class="line">      uint32 Result = FMessageDialog::<span class="built_in">Open</span>(EAppMsgType::YesNoCancel, FText::<span class="built_in">FromString</span>(Error) );</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">//PLATFORM_REQUIRES_FILESERVER</span></span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (Result == EAppReturnType::No)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (Result == EAppReturnType::Cancel)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// Cancel - return a failure, and quit</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> (bNetworkFailedToInitialize);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !UE_BUILD_SHIPPING</span></span><br><span class="line">  <span class="comment">// Try to create file profiling wrapper</span></span><br><span class="line">  &#123;</span><br><span class="line">    IPlatformFile* PlatformFile = <span class="built_in">ConditionallyCreateFileWrapper</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ProfileFile&quot;</span>), CurrentPlatformFile, CmdLine);</span><br><span class="line">    <span class="keyword">if</span> (PlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = PlatformFile;</span><br><span class="line">      FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">SetPlatformFile</span>(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &#123;</span><br><span class="line">    IPlatformFile* PlatformFile = <span class="built_in">ConditionallyCreateFileWrapper</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;SimpleProfileFile&quot;</span>), CurrentPlatformFile, CmdLine);</span><br><span class="line">    <span class="keyword">if</span> (PlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = PlatformFile;</span><br><span class="line">      FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">SetPlatformFile</span>(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Try and create file timings stats wrapper</span></span><br><span class="line">  &#123;</span><br><span class="line">    IPlatformFile* PlatformFile = <span class="built_in">ConditionallyCreateFileWrapper</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;FileReadStats&quot;</span>), CurrentPlatformFile, CmdLine);</span><br><span class="line">    <span class="keyword">if</span> (PlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = PlatformFile;</span><br><span class="line">      FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">SetPlatformFile</span>(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Try and create file open log wrapper (lists the order files are first opened)</span></span><br><span class="line">  &#123;</span><br><span class="line">    IPlatformFile* PlatformFile = <span class="built_in">ConditionallyCreateFileWrapper</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;FileOpenLog&quot;</span>), CurrentPlatformFile, CmdLine);</span><br><span class="line">    <span class="keyword">if</span> (PlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = PlatformFile;</span><br><span class="line">      FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">SetPlatformFile</span>(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">//#if !UE_BUILD_SHIPPING</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Wrap the above in a file logging singleton if requested</span></span><br><span class="line">  &#123;</span><br><span class="line">    IPlatformFile* PlatformFile = <span class="built_in">ConditionallyCreateFileWrapper</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;LogFile&quot;</span>), CurrentPlatformFile, CmdLine);</span><br><span class="line">    <span class="keyword">if</span> (PlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = PlatformFile;</span><br><span class="line">      FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">SetPlatformFile</span>(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If our platform file is different than it was when we started, then an override was used</span></span><br><span class="line">  OutFileOverrideFound = (CurrentPlatformFile != &amp;FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">GetPlatformFile</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
      </categories>
      <tags>
        <tag>Package</tag>
      </tags>
  </entry>
  <entry>
    <title>FCommandLine 过滤模式</title>
    <url>/wiki/36198/</url>
    <content><![CDATA[<p><code>FCommandLine</code>是 UE 封装的启动参数的管理类，在 <code>Launch</code> 模块下的 <code>FEngineLoop::PreInit</code> 中被初始化 (<code>FCommandLine::Set</code>) 为程序启动的 <code>CmdLine</code>。<br><code>FCommandLine</code> 支持 <code>Append</code> 和<code>Parser</code>这是比较常用的功能，但是今天要说的是另外一个：CommandLine 的白名单和黑名单模式。<br>考虑这样的需求：在游戏开发阶段，有很多参数可以在启动时配置，方便测试，但是在发行时需要把启动时从命令行读取配置的功能给去掉，强制使用我们设置的默认参数。</p>
<h3 id="OVERRIDE-COMMANDLINE-WHITELIST"><a href="#OVERRIDE-COMMANDLINE-WHITELIST" class="headerlink" title="OVERRIDE_COMMANDLINE_WHITELIST"></a>OVERRIDE_COMMANDLINE_WHITELIST</h3><p>怎么才是最简单的办法？其实这一点根本不需要自己去处理这部分的内容，因为 <code>FCommandLine</code> 支持白名单模式。<br>开启的方法为在 <code>target.cs</code> 中增加 <code>WANTS_COMMANDLINE_WHITELIST</code> 宏：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">GlobalDefinitions.<span class="built_in">Add</span>(<span class="string">&quot;WANTS_COMMANDLINE_WHITELIST=1&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>如果只开启这个，则默认情况下不允许接收任何外部传入的参数，但具有默认的参数 <code>-fullscreen /windowed</code>。<br> 当然，我们可以自己指定这个 <code>WHITLIST</code>，那么就是在<code>target.cs</code> 中使用 <code>OVERRIDE_COMMANDLINE_WHITELIST</code> 宏：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">GlobalDefinitions.<span class="built_in">Add</span>(<span class="string">&quot;OVERRIDE_COMMANDLINE_WHITELIST=\&quot;-arg1 -arg2 -arg3 -arg4\&quot;&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>这样就只有我们指定的这些参数才可以在运行时接收，防止玩家恶意传递参数导致游戏出错。<br>这部分的代码是写在 <a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/Core/Private/Misc/CommandLine.cpp">Misc/CommandLine.cpp</a> 中的。</p>
<p><strong>Example</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// target.cs</span></span><br><span class="line">GlobalDefinitions.<span class="built_in">Add</span>(<span class="string">&quot;WANTS_COMMANDLINE_WHITELIST=1&quot;</span>);</span><br><span class="line">GlobalDefinitions.<span class="built_in">Add</span>(<span class="string">&quot;OVERRIDE_COMMANDLINE_WHITELIST=\&quot;-e -c\&quot;&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>这里只指定了 <code>-e</code>/<code>-c</code> 两个参数，如果程序在启动时被指定了其他的参数，如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:/UnrealEngine/EngineSource/UE_4.21_Source/Engine/Binaries/Win64/UE4Launcher.exe -e -c -d</span><br></pre></td></tr></table></figure>

<p>在 <code>FCommandLine::Get()</code> 只能得到 <code>-e</code> 和<code>-c</code>，<code>-d</code>和 exe 路径都被丢弃了，只能用在指定开关，不能用来传递值。</p>
<h3 id="FILTER-COMMANDLINE-LOGGING"><a href="#FILTER-COMMANDLINE-LOGGING" class="headerlink" title="FILTER_COMMANDLINE_LOGGING"></a>FILTER_COMMANDLINE_LOGGING</h3><p>还可以在 <code>target.cs</code> 中指定 <code>FILTER_COMMANDLINE_LOGGING</code> 来控制对 <code>FCommandLine::LoggingCmdLine</code> 的过滤：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">GlobalDefinitions.<span class="built_in">Add</span>(<span class="string">&quot;FILTER_COMMANDLINE_LOGGING=\&quot;-arg1 -arg2 -arg3 -arg4\&quot;&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>它会在程序从命令行中接收的参数中过滤所指定的参数，类似于参数的黑名单。</p>
<p><strong>Example</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">GlobalDefinitions.<span class="built_in">Add</span>(<span class="string">&quot;WANTS_COMMANDLINE_WHITELIST=1&quot;</span>);</span><br><span class="line">GlobalDefinitions.<span class="built_in">Add</span>(<span class="string">&quot;FILTER_COMMANDLINE_LOGGING=\&quot;-e -c\&quot;&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>在运行时传入参数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">D:/UnrealEngine/EngineSource/UE_4<span class="number">.21</span>_Source/Engine/Binaries/Win64/UE4Launcher.exe -e -c -d</span><br></pre></td></tr></table></figure>

<p>得到的是：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">-D:/UnrealEngine/EngineSource/UE_4<span class="number">.21</span>_Source/Engine/Binaries/Win64/UE4Launcher.exe -d</span><br></pre></td></tr></table></figure>

<p><code>-e</code>和 <code>-c</code> 被过滤掉了。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
      </categories>
      <tags>
        <tag>Commandline</tag>
      </tags>
  </entry>
  <entry>
    <title>FName/FString/FText 的区别</title>
    <url>/wiki/41082/</url>
    <content><![CDATA[<h3 id="FName"><a href="#FName" class="headerlink" title="FName"></a>FName</h3><p>FName 的字符串一般用在为资源命名或者访问资源时（比如命名的骨骼）需要使用。<br>它使用一个轻型系统使用字符串，特定字符串会被重复使用，在数据表中也就只存储一次。</p>
<ol>
<li>只在内存中存储一次</li>
<li>不区分大小写</li>
<li>不能被修改</li>
<li>查找和访问速度比较快</li>
<li>内部有一个 HASH 值 <br>FName 在 Edior 中占 12 个字节，打包 8 字节，FName 的<code>XXXX_12</code> 这样的字符串会被分成 string part 和 number part，估计是为了想不为每个拼接的结果都在 NamePool 中创建一份吧。</li>
</ol>
<h3 id="FString"><a href="#FString" class="headerlink" title="FString"></a>FString</h3><p>FSting 比较类似于标准库的<code>std::string</code>，区分大小写，可修改，每份实例都是单独的内存。</p>
<h3 id="FText"><a href="#FText" class="headerlink" title="FText"></a>FText</h3><p>FText 是用于本地化的类，所有需要展示的文本都需要使用 FText，它提供了以下功能：</p>
<ol>
<li>创建本地化文本</li>
<li>格式化文本</li>
<li>从数字生成文本</li>
<li>从日期或时间生成文本</li>
<li>转换文本（大小写转换等）</li>
</ol>
<h3 id="文档"><a href="# 文档" class="headerlink" title="文档"></a>文档</h3><ul>
<li><a href="https://docs.unrealengine.com/en-US/Programming/UnrealArchitecture/StringHandling/index.html">String Handling</a></li>
<li><a href="https://docs.unrealengine.com/en-US/Gameplay/Localization/Formatting/index.html#textliterals">Text Localization</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/144850633">UE4 FName 原理分析</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/139711646">UE4 底层剖析之命名系统</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
      </categories>
      <tags>
        <tag>Engine</tag>
        <tag>String</tag>
      </tags>
  </entry>
  <entry>
    <title>FPaths 中 Dir 函数的对应路径</title>
    <url>/wiki/67808803/</url>
    <content><![CDATA[<p>FPaths 提供了很多 <code>EngineDir</code> 等之类的函数，我在 unlua 里导出了这些符号：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;EngineDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">EngineDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;EngineUserDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">EngineUserDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;EngineContentDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">EngineContentDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;EngineConfigDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">EngineConfigDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;EngineSavedDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">EngineSavedDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;EnginePluginsDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">EnginePluginsDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;RootDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">RootDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;ProjectDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">ProjectDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;ProjectUserDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">ProjectUserDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;ProjectContentDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">ProjectContentDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;ProjectConfigDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">ProjectConfigDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;ProjectSavedDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">ProjectSavedDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;ProjectIntermediateDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">ProjectIntermediateDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;ProjectPluginsDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">ProjectPluginsDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;ProjectLogDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">ProjectLogDir</span>()))</span><br></pre></td></tr></table></figure>

<p>他们对应的具体路径为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">EngineDir: ../../../Engine/</span><br><span class="line">EngineUserDir: : /Users/imzlp/AppData/Local/UnrealEngine/4.22/</span><br><span class="line">EngineContentDir: ../../../Engine/Content/</span><br><span class="line">EngineConfigDir: ../../../Engine/Config/</span><br><span class="line">EngineSavedDir: : /Users/imzlp/AppData/Local/UnrealEngine/4.22/Saved/</span><br><span class="line">EnginePluginsDir: ../../../Engine/Plugins/</span><br><span class="line">RootDir: : /Program Files/Epic Games/UE_4.22/</span><br><span class="line">ProjectDir: ../../../../../../Users/imzlp/Documents/UnrealProjectSSD/GWorldClient/</span><br><span class="line">ProjectUserDir: ../../../../../../Users/imzlp/Documents/UnrealProjectSSD/GWorldClient/</span><br><span class="line">ProjectContentDir: ../../../../../../Users/imzlp/Documents/UnrealProjectSSD/GWorldClient/Content/</span><br><span class="line">ProjectConfigDir: ../../../../../../Users/imzlp/Documents/UnrealProjectSSD/GWorldClient/Config/</span><br><span class="line">ProjectSavedDir: ../../../../../../Users/imzlp/Documents/UnrealProjectSSD/GWorldClient/Saved/</span><br><span class="line">ProjectIntermediateDir: ../../../../../../Users/imzlp/Documents/UnrealProjectSSD/GWorldClient/Intermediate/</span><br><span class="line">ProjectPluginsDir: ../../../../../../Users/imzlp/Documents/UnrealProjectSSD/GWorldClient/Plugins/</span><br><span class="line">ProjectLogDir: ../../../../../../Users/imzlp/Documents/UnrealProjectSSD/GWorldClient/Saved/Logs/</span><br></pre></td></tr></table></figure>
<p>这些相对路径都是 <strong> 相对于引擎的 exe</strong>的路径的：<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-fpath-relative-engine-binary.webp"></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
      </categories>
      <tags>
        <tag>Engine</tag>
        <tag>FPaths</tag>
      </tags>
  </entry>
  <entry>
    <title>GC Config of BaseEngine.ini</title>
    <url>/wiki/810b02a6/</url>
    <content><![CDATA[<p>打开 <code>ProjectSettings</code>-<code>Engine</code>-<code>GarbageCollection</code> 查看设置:<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/UE4-Engine-Garbage-Collection-GlobalSetting.webp"><br>它们是在配置文件 <code>Engine\Config\BaseEngine.ini</code> 中的。</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment">; Engine\Config\BaseEngine.ini</span></span><br><span class="line"><span class="section">[/Script/Engine.GarbageCollectionSettings]</span></span><br><span class="line"><span class="attr">gc.MaxObjectsNotConsideredByGC</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">gc.SizeOfPermanentObjectPool</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">gc.FlushStreamingOnGC</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">gc.NumRetriesBeforeForcingGC</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">gc.AllowParallelGC</span>=<span class="literal">True</span></span><br><span class="line"><span class="attr">gc.TimeBetweenPurgingPendingKillObjects</span>=<span class="number">60</span></span><br><span class="line"><span class="attr">gc.MaxObjectsInEditor</span>=<span class="number">8388607</span></span><br><span class="line"><span class="attr">gc.CreateGCClusters</span>=<span class="literal">True</span></span><br><span class="line"><span class="attr">gc.MergeGCClusters</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">gc.ActorClusteringEnabled</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">gc.BlueprintClusteringEnabled</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">gc.UseDisregardForGCOnDedicatedServers</span>=<span class="literal">False</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>AllowParallelGC</code>：允许多线程执行 GC</p>
</li>
<li><p><code>TimeBetweenPurgingPendingKillObjects</code>：GC 的清理周期默认为 60s，可以通过调用：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">GetWorld</span>()-&gt;<span class="built_in">ForceGarbageCollection</span>(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<p>来强制 GC。但是如果不想然一个 UObject 被 GC 回收，可以使用<code>AddToRoot</code>。</p>
</li>
<li><p><code>CreateGCClusters</code>：开启可以防止对很多子物体进行 GC 遍历。</p>
</li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
      </categories>
      <tags>
        <tag>Engine</tag>
        <tag>GC</tag>
      </tags>
  </entry>
  <entry>
    <title>Hook UObject</title>
    <url>/wiki/e6148e24/</url>
    <content><![CDATA[<p>Hook 是一种机制，通过拦截和勾取一些事件来实现自己需求的方式。不同于传统的底层 Hook，本篇文章主要介绍在 UE 中如何使用类似 Hook 的这种机制来实现业务需求。</p>
<p>有些需求是要全局地修改某个类的所有对象，比如在 UI 中为某种类型的的 Button 播放统一的音效，如果在每个控件都需要监听它的 OnClicked 再去播放音效，会有大量的重复操作。所以，我想要找一种全局的方法，可以监听所有 UButton 的点击事件，然后统一来处理。再或者想要控制一个在蓝图中不可见的属性，如果只是一些简单的需求就要去修改引擎的代码，有点得不偿失。</p>
<p>可以通过 UE 的反射机制来实现这些需求，本篇文章来提供一种思路，做一个简单的实现分析。</p>
<span id="more"></span>

<h3 id="监听对象创建执行操作"><a href="# 监听对象创建执行操作" class="headerlink" title="监听对象创建执行操作"></a>监听对象创建执行操作 </h3><p> 需求有了，要修改指定类型所有的对象的属性，那么要实现这样的需求大致的思路是这样的：</p>
<ol>
<li>首先需要能够知道 <strong> 指定类型的对象 </strong> 被创建了</li>
<li>当对象被 <strong> 创建完成之后 </strong> 修改它的属性</li>
</ol>
<p>能够实现这两点，就可以解决我们的需求，那么问题的关键就是要先找到 <strong> 知道对象被创建了 </strong> 的方法。</p>
<p>经过翻阅 UE 的代码，发现 UE 创建和销毁对象时都可以注册 <code>Listener</code> 来接收通知：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FUObjectArray::AllocateUObjectIndex</span><span class="params">(UObjectBase* Object, <span class="keyword">bool</span> bMergingThreads <span class="comment">/*= false*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">for</span> (int32 ListenerIndex = <span class="number">0</span>; ListenerIndex &lt; UObjectCreateListeners.<span class="built_in">Num</span>(); ListenerIndex++)</span><br><span class="line">  &#123;</span><br><span class="line">    UObjectCreateListeners[ListenerIndex]-&gt;<span class="built_in">NotifyUObjectCreated</span>(Object,Index);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用栈：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/15049/ue-create-uobject-notify.webp"></p>
<p>既然知道了创建 UObject 的时候会调用到所有的 Listener，那么就自己注册进去一个对象。</p>
<p><code>UObjectCreateListeners</code>的类型为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">TArray&lt;FUObjectCreateListener* &gt; UObjectCreateListeners;</span><br></pre></td></tr></table></figure>

<p><code>FUObjectCreateListener</code>是个抽象类，定义了两个虚函数，当作接口使用：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FUObjectCreateListener</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">FUObjectCreateListener</span>() &#123;&#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Provides notification that a UObjectBase has been added to the uobject array</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * @param Object object that has been destroyed</span></span><br><span class="line"><span class="comment">    * @param Index  index of object that is being deleted</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">NotifyUObjectCreated</span><span class="params">(<span class="keyword">const</span> class UObjectBase *Object, int32 Index)</span></span>=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Called when UObject Array is being shut down, this is where all listeners should be removed from it </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnUObjectArrayShutdown</span><span class="params">()</span></span>=<span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>同时，还有监听对象被删除的接口<code>FUObjectDeleteListener</code>：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Base class for UObjectBase delete class listeners</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FUObjectDeleteListener</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">FUObjectDeleteListener</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Provides notification that a UObjectBase has been removed from the uobject array</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * @param Object object that has been destroyed</span></span><br><span class="line"><span class="comment">    * @param Index  index of object that is being deleted</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">NotifyUObjectDeleted</span><span class="params">(<span class="keyword">const</span> class UObjectBase *Object, int32 Index)</span></span>=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Called when UObject Array is being shut down, this is where all listeners should be removed from it</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnUObjectArrayShutdown</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>我既想监听对象创建也想监听删除，所以我写了个类来同时继承它们两个：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FUButtonListener</span> :</span> <span class="keyword">public</span> FUObjectArray::FUObjectCreateListener, <span class="keyword">public</span> FUObjectArray::FUObjectDeleteListener</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> FButtonListenerMisc* <span class="title">Get</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> FButtonListenerMisc StaticIns;</span><br><span class="line">        <span class="keyword">return</span> &amp;StaticIns;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// Listener</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">NotifyUObjectCreated</span><span class="params">(<span class="keyword">const</span> class UObjectBase *Object, int32 Index)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">NotifyUObjectDeleted</span><span class="params">(<span class="keyword">const</span> class UObjectBase *Object, int32 Index)</span></span>;</span><br><span class="line">    <span class="function">FORCEINLINE <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnUObjectArrayShutdown</span><span class="params">()</span><span class="keyword">override</span> </span>&#123; &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>创建好了，关键的一步是要自己写的类注册到 <code>GUObjectArray</code> 中，<code>FUObjectArray</code>提供了两组 <code>Add</code> 和<code>Remove</code>的函数用来添加和移除 Listener。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Adds a new listener for object creation</span></span><br><span class="line"><span class="comment">* @param Listener listener to notify when an object is deleted</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AddUObjectCreateListener</span><span class="params">(FUObjectCreateListener* Listener)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Removes a listener for object creation</span></span><br><span class="line"><span class="comment">* @param Listener listener to remove</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RemoveUObjectCreateListener</span><span class="params">(FUObjectCreateListener* Listener)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Adds a new listener for object deletion</span></span><br><span class="line"><span class="comment">* @param Listener listener to notify when an object is deleted</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AddUObjectDeleteListener</span><span class="params">(FUObjectDeleteListener* Listener)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Removes a listener for object deletion</span></span><br><span class="line"><span class="comment">* @param Listener listener to remove</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RemoveUObjectDeleteListener</span><span class="params">(FUObjectDeleteListener* Listener)</span></span>;</span><br></pre></td></tr></table></figure>

<p>OK，知道怎么添加了，那么 <strong> 什么时机 </strong> 来添加 Listener 呢？</p>
<p>当然需要在游戏运行时资源 UObject 创建之前，不然对象都已经创建了，再绑定也监听不到了。</p>
<p>因为区分了 PIE 和打包，所以 PIE Play 和打包运行需要分别处理：</p>
<p>在编辑器下可以通过监听以下两个事件来开始进行监听 UObject 创建的流程：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">  FEditorDelegates::PreBeginPIE.<span class="built_in">AddStatic</span>(&amp;PreBeginPIE);</span><br><span class="line">  FGameDelegates::<span class="built_in">Get</span>().<span class="built_in">GetEndPlayMapDelegate</span>().<span class="built_in">AddRaw</span>(FHookerMisc::<span class="built_in">Get</span>(), &amp;FHookerMisc::Shutdown);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>打包的流程不是这两个事件，可以使用以下两个代理替换：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !WITH_EDITOR</span></span><br><span class="line">FCoreDelegates::OnPostEngineInit.<span class="built_in">AddRaw</span>(FHookerMisc::<span class="built_in">Get</span>(),&amp;FHookerMisc::Init);</span><br><span class="line">FCoreDelegates::OnPreExit.<span class="built_in">AddRaw</span>(FHookerMisc::<span class="built_in">Get</span>(),&amp;FHookerMisc::Shutdown); </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>这两个代理转发到的函数中可以进行处理添加 Listener 和删除的操作：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FHookerMisc::Init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GUObjectArray.<span class="built_in">AddUObjectCreateListener</span>(FHookerMisc::<span class="built_in">Get</span>());</span><br><span class="line">    GUObjectArray.<span class="built_in">AddUObjectDeleteListener</span>(FHookerMisc::<span class="built_in">Get</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FHookerMisc::Shutdown</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GUObjectArray.<span class="built_in">RemoveUObjectCreateListener</span>(FHookerMisc::<span class="built_in">Get</span>());</span><br><span class="line">    GUObjectArray.<span class="built_in">RemoveUObjectDeleteListener</span>(FHookerMisc::<span class="built_in">Get</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后就可以通过 <code>override</code> 以下两个函数来获取 Object 的创建和删除事件了：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FHookerMisc::NotifyUObjectCreated</span><span class="params">(<span class="keyword">const</span> UObjectBase* Object, int32 Index)</span></span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FHookerMisc::NotifyUObjectDeleted</span><span class="params">(<span class="keyword">const</span> UObjectBase* Object, int32 Index)</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意 </strong>：当<code>NotifyUObjectCreated</code> 函数被调用，这里传递过来的 UObject 并不是最终创建完成的对象，因为该 Object 还没有被初始化，它的构造函数还没有被调用，所以，如果此时直接修改 Object，是没有作用的，因为在引擎后续的流程中，在这个 Object 所在的内存上调用了它的构造函数。</p>
<p>调用栈：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/15049/20201108214812.webp"></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">UObject* <span class="title">StaticConstructObject_Internal</span></span></span><br><span class="line"><span class="function"><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">const</span> UClass*  InClass,</span></span></span><br><span class="line"><span class="params"><span class="function">  UObject*    InOuter                <span class="comment">/*=GetTransientPackage()*/</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  FName      InName                <span class="comment">/*=NAME_None*/</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  EObjectFlags  InFlags                <span class="comment">/*=0*/</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  EInternalObjectFlags InternalSetFlags        <span class="comment">/*=0*/</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  UObject*    InTemplate              <span class="comment">/*=NULL*/</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">bool</span> bCopyTransientsFromClassDefaults        <span class="comment">/*=false*/</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  FObjectInstancingGraph* InInstanceGraph        <span class="comment">/*=NULL*/</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">bool</span> bAssumeTemplateIsArchetype  <span class="comment">/*=false*/</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">bool</span> bRecycledSubobject = <span class="literal">false</span>;  </span><br><span class="line">  Result = <span class="built_in">StaticAllocateObject</span>(InClass, InOuter, InName, InFlags, InternalSetFlags, bCanRecycleSubobjects, &amp;bRecycledSubobject);</span><br><span class="line">  <span class="built_in">check</span>(Result != <span class="literal">NULL</span>);</span><br><span class="line">  <span class="comment">// Don&#x27;t call the constructor on recycled subobjects, they haven&#x27;t been destroyed.</span></span><br><span class="line">  <span class="keyword">if</span> (!bRecycledSubobject)</span><br><span class="line">  &#123;    </span><br><span class="line">    <span class="built_in">STAT</span>(FScopeCycleCounterUObject <span class="built_in">ConstructorScope</span>(InClass, <span class="built_in">GET_STATID</span>(STAT_ConstructObject)));</span><br><span class="line">    (*InClass-&gt;ClassConstructor)(<span class="built_in">FObjectInitializer</span>(Result, InTemplate, bCopyTransientsFromClassDefaults, <span class="literal">true</span>, InInstanceGraph) );</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> Result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，是先通过 <code>StaticAllocateObject</code> 进行创建 UObject（其实是分配 UObject 的内存）在下面的流程中，通过 UClass 得到当前类的构造函数，并执行。</p>
<p><strong>什么是构造函数？</strong>构造函数可以理解为 <strong> 模具</strong>，一块内存拿过来，通过这块模具生成出来一个具体的对象，构造函数就是一种初始化内存的方式——以什么样的形式来解释这块内存，并给它初始值。</p>
<p>构造函数会调用基类的构造函数、执行类内初始化、调用类成员的构造函数，把这块内存修改为对象默认的状态。</p>
<p>所以，不能直接在 <code>NotifyUObjectCreated</code> 中对 UObject 进行修改，要等到它构造完成之后。</p>
<p>此时的 Object 具有<code>RF_NeedInitialization</code>Flag，标记当前对象需要初始化，而我们可以通过这个 FLAG 的有无来决定是否修改它。</p>
<p>当 <code>NotifyUObjectCreated</code> 事件调用时，可以把传递过来的 Object 存储到一个列表中，在下次创建事件过来以及下一帧时，对列表中的所有对象进行检测，是否还具有<code>RF_NeedInitialization</code>Flag，如果没有，就表明该对象已经被初始化成功了，可以对其进行修改了，不用担心修改的数据被覆盖了。</p>
<p>在 <code>FObjectInitializer</code> 的<code>PostConstructInit</code>函数 (由<code>~FObjectInitializer</code> 调用)中对该 FLAG 进行了清理：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FObjectInitializer::PostConstructInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    Obj-&gt;<span class="built_in">ClearFlags</span>(RF_NeedInitialization);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以，只要当一个对象没有了<code>RF_NeedInitialization</code>FLAG，就可以对它进行操作了。</p>
<h3 id="修改 UClass 控制反射属性"><a href="# 修改 UClass 控制反射属性" class="headerlink" title="修改 UClass 控制反射属性"></a>修改 UClass 控制反射属性 </h3><p> 有时候，想要在编辑器中控制一个对象的属性，但是虽然该属性是 UProperty，但是没有标记为<code>EditAnyWhere</code>，在编辑器中是不可见的。</p>
<p>如：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ANetActor</span>:</span><span class="keyword">public</span> AActor</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">GENERATE_BODY</span>()</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">UPROPERTY</span>(EditAnywhere)</span><br><span class="line">  int32 ival;</span><br><span class="line">  <span class="built_in">UPROPERTY</span>()</span><br><span class="line">  int32 ival2;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>上述成员变量中 <code>ival</code> 是可以在蓝图和编辑中访问的，因为它有 <code>EditAnywhere</code> 属性，而 <code>ival2</code> 没有，则不能。</p>
<p>对于我们自己创建的类，可以通过修改代码解决，但是对于引擎或者其他第三方模块的类，直接去改动相关的代码并不是一个好主意，会带来额外的限制：需要使用源码版引擎、自己管理修改的代码版本。</p>
<p>有没有一种方法，不修改引擎里的代码，来实现我们的需求呢？</p>
<p>有！因为 <strong> 在编辑器中是否显示 </strong> 是通过 UE 给对象和它的属性生成的反射信息来决定的，如果能够找到一种方法让引擎读取反射信息时认为 <code>ival2</code> 也是可以在编辑器显示的就 OK 了。</p>
<p>思路有了，即：修改 <code>ival2</code> 的反射信息，让编辑器认为它也需要在编辑器中显示。</p>
<p>通过代码分析，发现对象是否允许被显示在 <code>Details</code> 中显示时通过对 UProperty 检测<code>CPF_Edit</code>Flag 实现的。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">EPropertyFlags</span> :</span> uint64</span><br><span class="line">&#123;</span><br><span class="line">  CPF_None = <span class="number">0</span>,</span><br><span class="line">  CPF_Edit              = <span class="number">0x0000000000000001</span>,  <span class="comment">///&lt; Property is user-settable in the editor.</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>EPropertyFlags</code>中对 <code>CPF_Edit</code> 的描述也正是如此。</p>
<p>可以看一下上面例子中 <code>ival</code> 和<code>ival2</code>生成反射代码的差异：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FIntPropertyParams Z_Construct_UClass_ANetActor_Statics::NewProp_iVal2 = &#123; <span class="string">&quot;iVal2&quot;</span>, <span class="literal">nullptr</span>, (EPropertyFlags)<span class="number">0x0010000000000000</span>, UE4CodeGen_Private::EPropertyGenFlags::Int, RF_Public|RF_Transient|RF_MarkAsNative, <span class="number">1</span>, <span class="built_in">STRUCT_OFFSET</span>(ANetActor, iVal2), <span class="built_in">METADATA_PARAMS</span>(Z_Construct_UClass_ANetActor_Statics::NewProp_iVal2_MetaData, <span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UClass_ANetActor_Statics::NewProp_iVal2_MetaData)) &#125;;</span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FIntPropertyParams Z_Construct_UClass_ANetActor_Statics::NewProp_ival = &#123; <span class="string">&quot;ival&quot;</span>, <span class="literal">nullptr</span>, (EPropertyFlags)<span class="number">0x0010000000000001</span>, UE4CodeGen_Private::EPropertyGenFlags::Int, RF_Public|RF_Transient|RF_MarkAsNative, <span class="number">1</span>, <span class="built_in">STRUCT_OFFSET</span>(ANetActor, ival), <span class="built_in">METADATA_PARAMS</span>(Z_Construct_UClass_ANetActor_Statics::NewProp_ival_MetaData, <span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UClass_ANetActor_Statics::NewProp_ival_MetaData)) &#125;;</span><br></pre></td></tr></table></figure>

<p>可以看到，它们除了 <code>ival</code>(<code>(EPropertyFlags)0x0010000000000001</code>)/<code>ival2</code>(<code>(EPropertyFlags)0x0010000000000000</code>) 这两个 FLag 内容不一样之外，其他的部分完全相同，<code>ival</code>的 FLAG 内容就是多了 <code>CPF_Edit</code>，它是<code>EPropertyFlags</code> 的第二个属性，它的值为 <code>0x01</code>，<code>EPropertyFlags</code> 的枚举值是按位来表示的。</p>
<p>UE 的反射机制通过引擎启动时，读取这些生成的反射信息，为类内的反射属性生成 FProperty 对象，用来在运行时获取该属性的反射信息。</p>
<p><code>FProperty</code>类定义在 <code>Runtime/CoreUObject/Public/UObject/UnrealType.h</code> 中，它记录了当前属性在类内的偏移值、元素大小、名字，以及我们需要的<code>PropertyFlags</code>。</p>
<p>通过上面的分析，现在问题的关键是：如何在运行时（编辑器运行时），修改一个类反射属性的<code>PropertyFlags</code>。</p>
<p>流程有以下几步（在属性窗口创建之前）：</p>
<ol>
<li>获取类的反射信息（UClass）</li>
<li>从反射信息获取指定的属性的反射信息（FProperty）</li>
<li>修改属性的反射信息，添加<code>CPF_Edit</code></li>
</ol>
<p>实现代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">auto</span> AddEditFlagLambda = [](UClass* Class,FName flagName)-&gt;<span class="keyword">bool</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">bool</span> bStatus = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span>(Class)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span>(TFieldIterator&lt;FProperty&gt; <span class="built_in">PropertyIter</span>(Class);PropertyIter;++PropertyIter)</span><br><span class="line">    &#123;</span><br><span class="line">      FProperty* PropertyIns = *PropertyIter;</span><br><span class="line">      <span class="keyword">if</span>(PropertyIns-&gt;<span class="built_in">GetName</span>().<span class="built_in">Equals</span>(flagName.<span class="built_in">ToString</span>()))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span>(!PropertyIns-&gt;<span class="built_in">HasAnyPropertyFlags</span>(CPF_Edit))</span><br><span class="line">        &#123;</span><br><span class="line">          PropertyIns-&gt;<span class="built_in">SetPropertyFlags</span>(CPF_Edit);</span><br><span class="line">          bStatus = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> bStatus;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">AddEditFlagLambda</span>(ANetActor::<span class="built_in">StaticClass</span>(),<span class="built_in">TEXT</span>(<span class="string">&quot;ival2&quot;</span>));</span><br></pre></td></tr></table></figure>
<p>使用上一节 <code>NotifyUObjectCreated</code> 的方法，来实现修改，不过有区别的地方在于，不是针对某个实例，而是直接修改指定的 UClass，所以也就不需要就对象进行初始化完成的判断。</p>
<p>运行起来的效果：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/15049/add_CPF_Edit_in_editor.webp"></p>
<p>使用这种方式可以很简单地给引擎中的反射类的反射属性添加编辑器支持，如 <code>EditAnywhere</code>/<code>Interp</code> 等，从而实现不修改引擎，而修改引擎代码中的反射信息。</p>
<h3 id="后记"><a href="# 后记" class="headerlink" title="后记"></a>后记 </h3><p> 使用反射的机制，可以很方便地修改反射类、反射属性，通过这样的形式来实现业务需求，可以避免修改引擎代码的行为。本篇文章只是开了一个脑洞，提供了一种思路，反射不仅仅能做这些事情，有时间分析一下 UE 的反射下实现以及它是如何使用这些反射信息的。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
      </categories>
      <tags>
        <tag>Engine</tag>
        <tag>UObject</tag>
        <tag>反射</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 加载和查找 DLL 模块分析</title>
    <url>/wiki/31203/</url>
    <content><![CDATA[<p>在 Windows 上，UE 的模块在非 <code>IS_MONOLITHIC</code>(打包成一个单独的可执行文件的<strong> 单片模式 (Monolithic)</strong>) 模式下，是通过查找 DLL 来加载模块的。可以调用 <code>FModuleManager</code> 下的 <code>LoadModuleWithFailureReason</code>/<code>LoadModuleChecked</code> 等函数，通过传入 Module 的字符串名字来加载。<br>本篇文章算是 <a href="https://imzlp.com/posts/24007/">UE4 Modules:Load and Startup</a> 的扩展和补充，与之不同的是，这篇文章的 <strong> 侧重点 </strong> 在于 Module 的 DLL 的查找和加载的细节 <strong> 而不是 </strong> 引擎启动和加载 Module 的时机和顺序。</p>
<span id="more"></span>

<p>首先，还记得 <code>MODULE_NAME_API</code> 这个宏的作用吗? 在 Windows 平台上它的宏定义是<code>__declspec(dllexport)</code>，导出到 DLL，意味着 UE 的模块就是一个 DLL。</p>
<p>使用 <code>FModuleManager::LoadModuleWithFailureReason</code> 加载 Module 的基本的调用流程为 (这几个函数均在<code>FModuleManager</code> 下)：在 <code>LoadModuleWithFailureReason</code> 中调用 <code>AddModule</code>，在其中又调用<code>FindModulePaths</code>-&gt;<code>FindModulePathsInDirectory</code> 来查找模块。</p>
<h3 id="FindModulePaths"><a href="#FindModulePaths" class="headerlink" title="FindModulePaths"></a>FindModulePaths</h3><p><code>FModuleManager::FindModulePaths</code>的逻辑也比较简单，它接收 Module 的名字和 <strong> 返回 ModuleName-DLLPath</strong>的<code>TMap</code>。</p>
<p>它内部的逻辑就是从 <strong> 引擎 </strong>/<strong> 引擎插件 </strong>/<strong> 项目及插件 </strong> 的 Binaries 路径依次调用<code>FindModulePathsInDirectory</code>：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FModuleManager::FindModulePaths</span><span class="params">(<span class="keyword">const</span> TCHAR* NamePattern, TMap&lt;FName, FString&gt; &amp;OutModulePaths, <span class="keyword">bool</span> bCanUseCache <span class="comment">/*= true*/</span>)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// .... USING CACHE PATH ....</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Search through the engine directory</span></span><br><span class="line">	<span class="built_in">FindModulePathsInDirectory</span>(FPlatformProcess::<span class="built_in">GetModulesDirectory</span>(), <span class="literal">false</span>, NamePattern, OutModulePaths);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Search any engine directories</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> Idx = <span class="number">0</span>; Idx &lt; EngineBinariesDirectories.<span class="built_in">Num</span>(); Idx++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">FindModulePathsInDirectory</span>(EngineBinariesDirectories[Idx], <span class="literal">false</span>, NamePattern, OutModulePaths);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Search any game directories</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> Idx = <span class="number">0</span>; Idx &lt; GameBinariesDirectories.<span class="built_in">Num</span>(); Idx++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">FindModulePathsInDirectory</span>(GameBinariesDirectories[Idx], <span class="literal">true</span>, NamePattern, OutModulePaths);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码的上半部分从缓存路径中查找就不解释了，重要的是下面三个路径的查找：</p>
<ul>
<li><code>FPlatformProcess::GetModulesDirectory()</code></li>
<li><code>EngineBinariesDirectories</code></li>
<li><code>GameBinariesDirectories</code></li>
</ul>
<p><code>FPlatformProcess::GetModulesDirectory()</code>为相对于当前引擎的 Binaries:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">L<span class="string">&quot;../../../Engine/Binaries/Win64&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>EngineBinariesDirectories</strong>与 <strong>GameBinariesDirectories</strong> 这两个数组均通过 <code>FModuleManager::AddBinariesDirectory</code> 函数添加进来的。</p>
<p>这个函数有三处调用：</p>
<ul>
<li><code>FModuleManager::Get</code></li>
<li><code>FEngineLoop::PreInit</code>(Enterprise Project)</li>
<li><code>FPluginManager::ConfigureEnabledPlugin</code></li>
<li><code>FPluginManager::MountNewlyCreatedPlugin</code></li>
</ul>
<p><code>EngineBinariesDirectories</code>中存储的是引擎目录中 <code>Plugins</code> 的<code>Binaries</code>的路径：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">L<span class="string">&quot;../../../Engine/Plugins/&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/31203/UE-Load-Module-Engine-Bianries-Directories.webp"></p>
<p><code>GameBinariesDirectories</code>中存储的路径为当前工程以及当前工程目录下的插件的 <code>Binaries</code> 路径，比如<code>Binaries/Win64</code>:</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/31203/UE-Load-Module-GameBinariesDirectories.webp"></p>
<p>小节一下：UE 加载 Module 时查找的路径依次为</p>
<ul>
<li><strong>引擎的 Binaries 路径(Engine/Binaries/Win64)</strong></li>
<li><strong>引擎中插件的 Binaries 路径(Engine/Plugins/${PLUGIN_NAME}/Win64)</strong></li>
<li>** 游戏项目的 Binaries 及项目目录下所有插件的 Binaries 路径 (<code>$&#123;PROJECT_NAME&#125;/Binaries</code> 以及<code>$&#123;PROJECT_NAME&#125;/Plugins/$&#123;PLUGIN_NAME&#125;/Binaries</code>)**。</li>
</ul>
<h4 id="FindModulePathsInDirectory"><a href="#FindModulePathsInDirectory" class="headerlink" title="FindModulePathsInDirectory"></a>FindModulePathsInDirectory</h4><p>而且，在 <code>FModuleManager::FindModulePathsInDirectory</code> 这个函数中，每传进来一个路径是通过 <code>FModuleEnumerator::QueryModules</code> 来得到当前路径下的有效 Modules 的。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime/Core/Private/Modules/ModuleManager.cpp</span></span><br><span class="line"><span class="comment">// FModuleManager::FindModulePathsInDirectory</span></span><br><span class="line">QueryModulesDelegate.<span class="built_in">Execute</span>(SearchDirectoryName, bIsGameDirectory, ValidModules);</span><br></pre></td></tr></table></figure>

<p>这个调用的派发事件在 <code>FModuleEnumerator::RegisterWithModuleManager()</code> 中绑定，执行的函数为<code>FModuleEnumerator::QueryModules</code>：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FModuleEnumerator::QueryModules</span><span class="params">(<span class="keyword">const</span> FString&amp; InDirectoryName, <span class="keyword">bool</span> bIsGameDirectory, TMap&lt;FString, FString&gt;&amp; OutModules)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FModuleManifest Manifest;</span><br><span class="line">	<span class="keyword">if</span>(FModuleManifest::<span class="built_in">TryRead</span>(FModuleManifest::<span class="built_in">GetFileName</span>(InDirectoryName, bIsGameDirectory), Manifest) &amp;&amp; Manifest.BuildId == BuildId)</span><br><span class="line">	&#123;</span><br><span class="line">		OutModules = Manifest.ModuleNameToFileName;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>FModuleManifest::GetFileName</code>返回的是传进来的 Binaries 目录下的 <code>*.modules</code> 文件，每一个编译出来的 Module 的 Binaries 路径下都会有这个文件，随便打开一个看一下内容：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Engime/Binaires/Win64/UE4Editor.mosules</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;BuildId&quot;</span>: <span class="string">&quot;3709383&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;Modules&quot;</span>: </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="attr">&quot;ActorPickerMode&quot;</span>: <span class="string">&quot;UE4Editor-ActorPickerMode.dll&quot;</span>,</span><br><span class="line">		<span class="attr">&quot;AddContentDialog&quot;</span>: <span class="string">&quot;UE4Editor-AddContentDialog.dll&quot;</span>,</span><br><span class="line">		<span class="attr">&quot;AdvancedPreviewScene&quot;</span>: <span class="string">&quot;UE4Editor-AdvancedPreviewScene.dll&quot;</span>,</span><br><span class="line">		<span class="attr">&quot;Advertising&quot;</span>: <span class="string">&quot;UE4Editor-Advertising.dll&quot;</span>,</span><br><span class="line">		<span class="attr">&quot;AIGraph&quot;</span>: <span class="string">&quot;UE4Editor-AIGraph.dll&quot;</span>,</span><br><span class="line">		<span class="attr">&quot;AIModule&quot;</span>: <span class="string">&quot;UE4Editor-AIModule.dll&quot;</span>,</span><br><span class="line">		<span class="comment">// .....</span></span><br><span class="line">		<span class="attr">&quot;WindowsNoEditorTargetPlatform&quot;</span>: <span class="string">&quot;UE4Editor-WindowsNoEditorTargetPlatform.dll&quot;</span>,</span><br><span class="line">		<span class="attr">&quot;WindowsPlatformEditor&quot;</span>: <span class="string">&quot;UE4Editor-WindowsPlatformEditor.dll&quot;</span>,</span><br><span class="line">		<span class="attr">&quot;WindowsServerTargetPlatform&quot;</span>: <span class="string">&quot;UE4Editor-WindowsServerTargetPlatform.dll&quot;</span>,</span><br><span class="line">		<span class="attr">&quot;WindowsTargetPlatform&quot;</span>: <span class="string">&quot;UE4Editor-WindowsTargetPlatform.dll&quot;</span>,</span><br><span class="line">		<span class="attr">&quot;WorkspaceMenuStructure&quot;</span>: <span class="string">&quot;UE4Editor-WorkspaceMenuStructure.dll&quot;</span>,</span><br><span class="line">		<span class="attr">&quot;WorldBrowser&quot;</span>: <span class="string">&quot;UE4Editor-WorldBrowser.dll&quot;</span>,</span><br><span class="line">		<span class="attr">&quot;XAudio2&quot;</span>: <span class="string">&quot;UE4Editor-XAudio2.dll&quot;</span>,</span><br><span class="line">		<span class="attr">&quot;XGEController&quot;</span>: <span class="string">&quot;UE4Editor-XGEController.dll&quot;</span>,</span><br><span class="line">		<span class="attr">&quot;XmlParser&quot;</span>: <span class="string">&quot;UE4Editor-XmlParser.dll&quot;</span>,</span><br><span class="line">		<span class="attr">&quot;XMPP&quot;</span>: <span class="string">&quot;UE4Editor-XMPP.dll&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，其中的 json 对应了 <code>ModuleName</code> 和其 DLL。</p>
<p>然后调用 <code>FModuleManifest::TryRead</code> 将调用 <code>FModuleManifest::GetFileName</code> 得到的 <code>*.modules</code> 文件解析成一个 <code>FModuleManifest</code> 结构，包含 <code>BuildId</code> 与<code>TMap&lt;FString,FString&gt;</code>的 <code>ModuleName-DLLName</code> 的关联容器。</p>
<p>此时 <code>FModuleManager::FindModulePaths</code> 的任务已经全部完成，通过它得到了指定模块中的所有 Module 和 Module 对应的 DLL 信息，此时工作流转回到 <code>FModuleManager::AddModule</code> 中。</p>
<h3 id="AddModule"><a href="#AddModule" class="headerlink" title="AddModule"></a>AddModule</h3><p>后续的 <code>FModuleManager::AddModule</code> 执行就中规中矩了。从得到的 Map 中将所要添加的 Module 的信息提取出来，组成一个 <code>ModuleInfoRef</code> 对象:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> TSharedRef&lt;FModuleInfo, ESPMode::ThreadSafe&gt; ModuleInfoRef;</span><br></pre></td></tr></table></figure>

<p>并将其添加至 Module 的列表中(<code>FModuleManager::Get().AddModuleToModulesList(InModuleName, ModuleInfo)</code>).</p>
<p>PS：在 <code>FModuleManager::AddModule</code> 的代码中有一个风骚的技巧：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">ON_SCOPE_EXIT</span><br><span class="line">&#123;</span><br><span class="line">	FModuleManager::<span class="built_in">Get</span>().<span class="built_in">AddModuleToModulesList</span>(InModuleName, ModuleInfo);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这段代码的意思是在退出当前的作用域 (Scope) 时执行 <code>&#123;&#125;</code> 中的逻辑，简单地来说，它定义了一个当前作用域的对象并托管了一个 Lambda，在离开当前作用域的时候通过 C++ 的 RAII 机制来调用托管的 Lambda，但它的具体实现不是这篇文章的主题，有时间再来单独分析。</p>
<h3 id="FindModuleWithFailureReason"><a href="#FindModuleWithFailureReason" class="headerlink" title="FindModuleWithFailureReason"></a>FindModuleWithFailureReason</h3><p>在 <code>FModuleManager::AddModule</code> 执行完毕之后，将指定模块的 DLL 信息，存放到了 <code>FModuleManager::Modules</code> 中，接下来就可以得到这个模块的句柄了：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">IModuleInterface* <span class="title">FModuleManager::LoadModuleWithFailureReason</span><span class="params">(<span class="keyword">const</span> FName InModuleName, EModuleLoadResult&amp; OutFailureReason, <span class="keyword">bool</span> bWasReloaded <span class="comment">/*=false*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line">	IModuleInterface* LoadedModule = <span class="literal">nullptr</span>;</span><br><span class="line">	OutFailureReason = EModuleLoadResult::Success;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Update our set of known modules, in case we don&#x27;t already know about this module</span></span><br><span class="line">	<span class="built_in">AddModule</span>(InModuleName);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Grab the module info.  This has the file name of the module, as well as other info.</span></span><br><span class="line">	ModuleInfoRef ModuleInfo = Modules.<span class="built_in">FindChecked</span>(InModuleName);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ModuleInfo-&gt;Module.<span class="built_in">IsValid</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Assign the already loaded module into the return value, otherwise the return value gives the impression the module failed load!</span></span><br><span class="line">		LoadedModule = ModuleInfo-&gt;Module.<span class="built_in">Get</span>();</span><br><span class="line">        <span class="comment">// ....</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为所有的模块在 <code>ModuleName.cpp</code> 中都使用了 <code>IMPLEMENT_MODULE</code> 及其衍生宏来注册模块，所以它们都继承了 <code>IModuleInterface</code>，其中有<code>StartupModule</code> 和<code>ShutdownModule</code>，获取到句柄，启动的时候调用的就是每个模块里定义的逻辑了。</p>
<blockquote>
<p>注：模块的 <code>StartupModule</code> 是在 <code>FModuleManager::LoadModuleWithFailureReason</code> 中调用的。不管是 <code>LoadModule</code> 或者 <code>LoadModuleChecked</code> 最终都是调用到 <code>LoadModuleWithFailureReason</code> 进行实际的加载和启动的。</p>
<p>同理，<code>FModuleManager::UnLoadModule</code>中执行了模块的<code>ShutdownModule</code>。</p>
</blockquote>
<p>UE 设计的这一套 Module 架构还是很方便的，但是也是 UE 的工具链实在是太完善了，自成一套体系，有些想要剥离出来某些功能比较麻烦。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
      </categories>
      <tags>
        <tag>Module</tag>
        <tag>Engine</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 中 Log 实现代码分析</title>
    <url>/wiki/39534/</url>
    <content><![CDATA[<p>在 UE 中，经常需要在 C++ 代码中打印日志，UE 也提供了方法来创建出可以通过 UE_LOG 打印日志的宏。<br>首先，先来看一下 UE_LOG 是什么，它是个宏，使用的方法：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UE_LOG</span>(LogTemp,Log,<span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>));</span><br></pre></td></tr></table></figure>
<p>它被定义在<a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/Core/Public/Logging/LogMacros.h#L192">Core/Public/Logging/LogMacros.h</a>：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * A  macro that outputs a formatted message to log if a given logging category is active at a given verbosity level</span></span><br><span class="line"><span class="comment"> * @param CategoryName name of the logging category</span></span><br><span class="line"><span class="comment"> * @param Verbosity, verbosity level to test against</span></span><br><span class="line"><span class="comment"> * @param Format, format text</span></span><br><span class="line"><span class="comment"> ***/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UE_LOG(CategoryName, Verbosity, Format, ...) \</span></span><br><span class="line"><span class="meta">&#123; \</span></span><br><span class="line"><span class="meta">  static_assert(TIsArrayOrRefOfType<span class="meta-string">&lt;decltype(Format), TCHAR&gt;</span>::Value, <span class="meta-string">&quot;Formatting string must be a TCHAR array.&quot;</span>); \</span></span><br><span class="line"><span class="meta">  static_assert((ELogVerbosity::Verbosity &amp; ELogVerbosity::VerbosityMask) <span class="meta-string">&lt; ELogVerbosity::NumVerbosity &amp;&amp; ELogVerbosity::Verbosity &gt;</span> 0, <span class="meta-string">&quot;Verbosity must be constant and in range.&quot;</span>); \</span></span><br><span class="line"><span class="meta">  CA_CONSTANT_IF((ELogVerbosity::Verbosity &amp; ELogVerbosity::VerbosityMask) &lt;= ELogVerbosity::COMPILED_IN_MINIMUM_VERBOSITY &amp;&amp; (ELogVerbosity::Warning &amp; ELogVerbosity::VerbosityMask) &lt;= FLogCategory###CategoryName::CompileTimeVerbosity) \</span></span><br><span class="line"><span class="meta">  &#123; \</span></span><br><span class="line"><span class="meta">    UE_LOG_EXPAND_IS_FATAL(Verbosity, PREPROCESSOR_NOTHING, <span class="meta-keyword">if</span> (!CategoryName.IsSuppressed(ELogVerbosity::Verbosity))) \</span></span><br><span class="line"><span class="meta">    &#123; \</span></span><br><span class="line"><span class="meta">      auto UE_LOG_noinline_lambda = [](const auto&amp; LCategoryName, const auto&amp; LFormat, const auto&amp;... UE_LOG_Args) FORCENOINLINE \</span></span><br><span class="line"><span class="meta">      &#123; \</span></span><br><span class="line"><span class="meta">        TRACE_LOG_MESSAGE(LCategoryName, Verbosity, LFormat, UE_LOG_Args...) \</span></span><br><span class="line"><span class="meta">        UE_LOG_EXPAND_IS_FATAL(Verbosity, \</span></span><br><span class="line"><span class="meta">          &#123; \</span></span><br><span class="line"><span class="meta">            FMsg::Logf_Internal(UE_LOG_SOURCE_FILE(__FILE__), __LINE__, LCategoryName.GetCategoryName(), ELogVerbosity::Verbosity, LFormat, UE_LOG_Args...); \</span></span><br><span class="line"><span class="meta">            _DebugBreakAndPromptForRemote(); \</span></span><br><span class="line"><span class="meta">            FDebug::ProcessFatalError(); \</span></span><br><span class="line"><span class="meta">          &#125;, \</span></span><br><span class="line"><span class="meta">          &#123; \</span></span><br><span class="line"><span class="meta">            FMsg::Logf_Internal(nullptr, 0, LCategoryName.GetCategoryName(), ELogVerbosity::Verbosity, LFormat, UE_LOG_Args...); \</span></span><br><span class="line"><span class="meta">          &#125; \</span></span><br><span class="line"><span class="meta">        ) \</span></span><br><span class="line"><span class="meta">      &#125;; \</span></span><br><span class="line"><span class="meta">      UE_LOG_noinline_lambda(CategoryName, Format, ###__VA_ARGS__); \</span></span><br><span class="line"><span class="meta">      UE_LOG_EXPAND_IS_FATAL(Verbosity, CA_ASSUME(false);, PREPROCESSOR_NOTHING) \</span></span><br><span class="line"><span class="meta">    &#125; \</span></span><br><span class="line"><span class="meta">  &#125; \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br></pre></td></tr></table></figure>
<p>可以看到，使用 UE_LOG 时传入的第一个参数，是一个对象，后面的参数则是一个枚举值以及输出的 Formater，以及更多的参数（用于匹配 Formater 中的占位符）。</p>
<p>UE 提供了几种方法来创建 Log 的 Category：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">DECLARE_LOG_CATEGORY_EXTERN</span>(LogCategoryName,All,All);</span><br><span class="line"><span class="built_in">DECLARE_LOG_CATEGORY_CLASS</span>(LogCategoryName2,All,All);</span><br><span class="line"><span class="built_in">DECLARE_LOG_CATEGORY_EXTERN_HELPER</span>(LogCategoryName3,All,All);</span><br></pre></td></tr></table></figure>

<p>挨个来看一下它们的定义，其实他们都是定义了一个类，并需要创建出一个对象，可以用来传递给 <code>UE_LOG</code> 的第一个参数，而后两个参数则都是 <code>ELogVerbosity</code> 的枚举值，用于给当前的 LogCategory 指定运行时和编译时的日志等级。<br>看一下这个枚举的定义：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Enum that defines the verbosity levels of the logging system.</span></span><br><span class="line"><span class="comment"> * Also defines some non-verbosity levels that are hacks that allow</span></span><br><span class="line"><span class="comment"> * breaking on a given log line or setting the color.</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">namespace</span> ELogVerbosity</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">enum</span> <span class="title">Type</span> :</span> uint8</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/** Not used */</span></span><br><span class="line">    NoLogging  = <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Always prints a fatal error to console (and log file) and crashes (even if logging is disabled) */</span></span><br><span class="line">    Fatal,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * Prints an error to console (and log file). </span></span><br><span class="line"><span class="comment">     * Commandlets and the editor collect and report errors. Error messages result in commandlet failure.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Error,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * Prints a warning to console (and log file).</span></span><br><span class="line"><span class="comment">     * Commandlets and the editor collect and report warnings. Warnings can be treated as an error.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Warning,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Prints a message to console (and log file) */</span></span><br><span class="line">    Display,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Prints a message to a log file (does not print to console) */</span></span><br><span class="line">    Log,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * Prints a verbose message to a log file (if Verbose logging is enabled for the given category, </span></span><br><span class="line"><span class="comment">     * usually used for detailed logging) </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Verbose,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * Prints a verbose message to a log file (if VeryVerbose logging is enabled, </span></span><br><span class="line"><span class="comment">     * usually used for detailed logging that would otherwise spam output) </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    VeryVerbose,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Log masks and special Enum values</span></span><br><span class="line"></span><br><span class="line">    All    = VeryVerbose,</span><br><span class="line">    NumVerbosity,</span><br><span class="line">    VerbosityMask  = <span class="number">0xf</span>,</span><br><span class="line">    SetColor  = <span class="number">0x40</span>, <span class="comment">// not actually a verbosity, used to set the color of an output device </span></span><br><span class="line">    BreakOnLog  = <span class="number">0x80</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以根据自己的需求来指定不同的日志等级。</p>
<h3 id="DECLARE-LOG-CATEGORY-EXTERN"><a href="#DECLARE-LOG-CATEGORY-EXTERN" class="headerlink" title="DECLARE_LOG_CATEGORY_EXTERN"></a>DECLARE_LOG_CATEGORY_EXTERN</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * A macro to declare a logging category as a C++ &quot;extern&quot;, usually declared in the header and paired with DEFINE_LOG_CATEGORY in the source. Accessible by all files that include the header.</span></span><br><span class="line"><span class="comment"> * @param CategoryName, category to declare</span></span><br><span class="line"><span class="comment"> * @param DefaultVerbosity, default run time verbosity</span></span><br><span class="line"><span class="comment"> * @param CompileTimeVerbosity, maximum verbosity to compile into the code</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_LOG_CATEGORY_EXTERN(CategoryName, DefaultVerbosity, CompileTimeVerbosity) \</span></span><br><span class="line"><span class="meta">extern struct FLogCategory###CategoryName : public FLogCategory<span class="meta-string">&lt;ELogVerbosity::DefaultVerbosity, ELogVerbosity::CompileTimeVerbosity&gt;</span> \</span></span><br><span class="line"><span class="meta">&#123; \</span></span><br><span class="line"><span class="meta">  FORCEINLINE FLogCategory###CategoryName() : FLogCategory(TEXT(#CategoryName)) &#123;&#125; \</span></span><br><span class="line"><span class="meta">&#125; CategoryName;</span></span><br></pre></td></tr></table></figure>
<p>如果有以下声明：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">DECLARE_LOG_CATEGORY_EXTERN</span>(LogCategoryName,All,All);</span><br></pre></td></tr></table></figure>
<p>宏展开之后就为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="class"><span class="keyword">struct</span> <span class="title">FLogCategoryLogCategoryName</span> :</span> <span class="keyword">public</span> FLogCategory&lt;ELogVerbosity::All, ELogVerbosity::All&gt;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function">FORCEINLINE <span class="title">FLogCategoryLogCategoryName</span><span class="params">()</span> : FLogCategory(TEXT(<span class="string">&quot;LogCategoryName&quot;</span>)) &#123;</span>&#125;</span><br><span class="line">&#125; LogCategoryName;</span><br></pre></td></tr></table></figure>
<p>其实就是继承自 <code>FLogCategory</code> 的一个类定义，并且 <strong> 声明 </strong> 了一个 <code>LogCategoryName</code> 的对象。<br>注意，这里只是声明，还需要定义，不然在编译时会有未定义错误，所以就需要在 cpp 里写代码进行定义，UE 也提供了一个宏：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">DEFINE_LOG_CATEGORY</span>(LogCategoryName);</span><br></pre></td></tr></table></figure>
<p>它的定义就很简单了，只是定义一个对象而已：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * A macro to define a logging category, usually paired with DECLARE_LOG_CATEGORY_EXTERN from the header.</span></span><br><span class="line"><span class="comment"> * @param CategoryName, category to define</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFINE_LOG_CATEGORY(CategoryName) FLogCategory###CategoryName CategoryName;</span></span><br></pre></td></tr></table></figure>
<p>对象经过定义之后就可以在 <code>UE_LOG</code> 使用了。<br>这种分离声明和定义的方式可以用在暴露给外部使用的情况，别的文件或者模块只需要包含具有声明的头文件即可。</p>
<h3 id="DECLARE-LOG-CATEGORY-CLASS"><a href="#DECLARE-LOG-CATEGORY-CLASS" class="headerlink" title="DECLARE_LOG_CATEGORY_CLASS"></a>DECLARE_LOG_CATEGORY_CLASS</h3><p><code>DECLARE_LOG_CATEGORY_CLASS</code>宏的实现就比 <code>DECLARE_LOG_CATEGORY_EXTERN</code> 多做了一些操作，它定义了一个结构并 <strong> 创建出一个 static 对象 </strong>，不需要自己再使用<code>DEFINE_LOG_CATEGRORY</code> 进行定义。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * A macro to define a logging category as a C++ &quot;static&quot;. This should ONLY be declared in a source file. Only accessible in that single file.</span></span><br><span class="line"><span class="comment"> * @param CategoryName, category to declare</span></span><br><span class="line"><span class="comment"> * @param DefaultVerbosity, default run time verbosity</span></span><br><span class="line"><span class="comment"> * @param CompileTimeVerbosity, maximum verbosity to compile into the code</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFINE_LOG_CATEGORY_STATIC(CategoryName, DefaultVerbosity, CompileTimeVerbosity) \</span></span><br><span class="line"><span class="meta">static struct FLogCategory###CategoryName : public FLogCategory<span class="meta-string">&lt;ELogVerbosity::DefaultVerbosity, ELogVerbosity::CompileTimeVerbosity&gt;</span> \</span></span><br><span class="line"><span class="meta">&#123; \</span></span><br><span class="line"><span class="meta">  FORCEINLINE FLogCategory###CategoryName() : FLogCategory(TEXT(#CategoryName)) &#123;&#125; \</span></span><br><span class="line"><span class="meta">&#125; CategoryName;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * A macro to declare a logging category as a C++ &quot;class static&quot; </span></span><br><span class="line"><span class="comment"> * @param CategoryName, category to declare</span></span><br><span class="line"><span class="comment"> * @param DefaultVerbosity, default run time verbosity</span></span><br><span class="line"><span class="comment"> * @param CompileTimeVerbosity, maximum verbosity to compile into the code</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_LOG_CATEGORY_CLASS(CategoryName, DefaultVerbosity, CompileTimeVerbosity) \</span></span><br><span class="line"><span class="meta">  DEFINE_LOG_CATEGORY_STATIC(CategoryName, DefaultVerbosity, CompileTimeVerbosity)</span></span><br></pre></td></tr></table></figure>
<p>它的声明会展开为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">FLogCategoryLogCategoryName</span> :</span> <span class="keyword">public</span> FLogCategory&lt;ELogVerbosity::All, ELogVerbosity::All&gt;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function">FORCEINLINE <span class="title">FLogCategoryLogCategoryName</span><span class="params">()</span> : FLogCategory(TEXT(<span class="string">&quot;LogCategoryName&quot;</span>)) &#123;</span>&#125;</span><br><span class="line">&#125; LogCategoryName;</span><br></pre></td></tr></table></figure>
<p>可以看到，和 <code>DECLARE_LOG_CATEGORY_EXTERN</code> 的区别在于：</p>
<ol>
<li>去掉了 <code>extern</code> 修饰符</li>
<li>增加了 static 修饰符，定义对象</li>
</ol>
<p>使用这个宏的用途一般直接写在.cpp 文件中，只供当前的翻译单元使用。</p>
<h3 id="DECLARE-LOG-CATEGORY-EXTERN-HELPER"><a href="#DECLARE-LOG-CATEGORY-EXTERN-HELPER" class="headerlink" title="DECLARE_LOG_CATEGORY_EXTERN_HELPER"></a>DECLARE_LOG_CATEGORY_EXTERN_HELPER</h3><p><code>DECLARE_LOG_CATEGORY_EXTERN_HELPER</code>这个宏只是 <code>DECLARE_LOG_CATEGORY_EXTERN</code> 的封装，并没有自己做什么特别的事情，和 <code>DECLARE_LOG_CATEGORY_EXTERN</code> 的用法完全一致。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Platform specific logs, set here to make it easier to use them from anywhere</span></span><br><span class="line"><span class="comment">// need another layer of macro to help using a define in a define</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_LOG_CATEGORY_EXTERN_HELPER(A,B,C) DECLARE_LOG_CATEGORY_EXTERN(A,B,C)</span></span><br></pre></td></tr></table></figure>

<h3 id="后记"><a href="# 后记" class="headerlink" title="后记"></a>后记 </h3><p><code>DECLARE_LOG_CATEGORY_EXTERN</code> 也可以通过 <code>XXXX_API</code> 的方式修饰并导出符号，使其可以在外部模块中使用。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
      </categories>
  </entry>
  <entry>
    <title>UE 代码分析：GConfig 的加载</title>
    <url>/wiki/2386/</url>
    <content><![CDATA[<p>UE4 中提供了一套非常成熟的 INI 文件配置机制，引擎中也使用了 ini 作为引擎和项目的配置文件。本篇文章来简单分析一下引擎中 GConfig 的加载。</p>
<span id="more"></span>

<p>UE 中定义了一堆的全局 ini：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime/Core/Private/Misc/CoreGlobals.cpp</span></span><br><span class="line">FString       GEngineIni;                         <span class="comment">/* Engine ini filename */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** Editor ini file locations - stored per engine version (shared across all projects). Migrated between versions on first run. */</span></span><br><span class="line">FString       GEditorIni;                         <span class="comment">/* Editor ini filename */</span></span><br><span class="line">FString       GEditorKeyBindingsIni;                    <span class="comment">/* Editor Key Bindings ini file */</span></span><br><span class="line">FString       GEditorLayoutIni;                     <span class="comment">/* Editor UI Layout ini filename */</span></span><br><span class="line">FString       GEditorSettingsIni;                     <span class="comment">/* Editor Settings ini filename */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** Editor per-project ini files - stored per project. */</span></span><br><span class="line">FString       GEditorPerProjectIni;                   <span class="comment">/* Editor User Settings ini filename */</span></span><br><span class="line"></span><br><span class="line">FString       GCompatIni;</span><br><span class="line">FString       GLightmassIni;                        <span class="comment">/* Lightmass settings ini filename */</span></span><br><span class="line">FString       GScalabilityIni;                      <span class="comment">/* Scalability settings ini filename */</span></span><br><span class="line">FString       GHardwareIni;                       <span class="comment">/* Hardware ini filename */</span></span><br><span class="line">FString       GInputIni;                          <span class="comment">/* Input ini filename */</span></span><br><span class="line">FString       GGameIni;                         <span class="comment">/* Game ini filename */</span></span><br><span class="line">FString       GGameUserSettingsIni;                   <span class="comment">/* User Game Settings ini filename */</span></span><br></pre></td></tr></table></figure>
<p>但是并没有直接硬编码指定 ini 是在哪里的，其加载的过程为：在 <code>FEngineLoop::AppInit</code>(LaunchEngineLoop.cpp) 中通过调用 <code>FConfigCacheIni::InitializeConfigSystem</code> 来执行加载 ini 文件，其定义在<code>ConfigCacheIni.cpp</code>：</p>
<h3 id="FConfigCacheIni-InitializeConfigSystem"><a href="#FConfigCacheIni-InitializeConfigSystem" class="headerlink" title="FConfigCacheIni::InitializeConfigSystem"></a>FConfigCacheIni::InitializeConfigSystem</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// --------------------------------</span></span><br><span class="line"><span class="comment">// # FConfigCacheIni::InitializeConfigSystem declaration</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates GConfig, loads the standard global ini files (Engine, Editor, etc),</span></span><br><span class="line"><span class="comment"> * fills out GEngineIni, etc. and marks GConfig as ready for use</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">InitializeConfigSystem</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// --------------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FConfigCacheIni::InitializeConfigSystem</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// Perform any upgrade we need before we load any configuration files</span></span><br><span class="line">  FConfigManifest::<span class="built_in">UpgradeFromPreviousVersions</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// create GConfig</span></span><br><span class="line">  GConfig = <span class="keyword">new</span> <span class="built_in">FConfigCacheIni</span>(EConfigCacheType::DiskBacked);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// load the main .ini files (unless we&#x27;re running a program or a gameless UE4Editor.exe, DefaultEngine.ini is required).</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">bool</span> bIsGamelessExe = !FApp::<span class="built_in">HasProjectName</span>();</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">bool</span> bDefaultEngineIniRequired = !bIsGamelessExe &amp;&amp; (GIsGameAgnosticExe || FApp::<span class="built_in">IsProjectNameEmpty</span>());</span><br><span class="line">  <span class="keyword">bool</span> bEngineConfigCreated = FConfigCacheIni::<span class="built_in">LoadGlobalIniFile</span>(GEngineIni, <span class="built_in">TEXT</span>(<span class="string">&quot;Engine&quot;</span>), <span class="literal">nullptr</span>, bDefaultEngineIniRequired);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!bIsGamelessExe)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Now check and see if our game is correct if this is a game agnostic binary</span></span><br><span class="line">    <span class="keyword">if</span> (GIsGameAgnosticExe &amp;&amp; !bEngineConfigCreated)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">const</span> FText AbsolutePath = FText::<span class="built_in">FromString</span>(IFileManager::<span class="built_in">Get</span>().<span class="built_in">ConvertToAbsolutePathForExternalAppForRead</span>(*FPaths::<span class="built_in">GetPath</span>(GEngineIni)) );</span><br><span class="line">      <span class="comment">//@todo this is too early to localize</span></span><br><span class="line">      <span class="keyword">const</span> FText Message = FText::<span class="built_in">Format</span>(<span class="built_in">NSLOCTEXT</span>(<span class="string">&quot;Core&quot;</span>, <span class="string">&quot;FirstCmdArgMustBeGameName&quot;</span>, <span class="string">&quot;&#x27;&#123;0&#125;&#x27; must exist and contain a DefaultEngine.ini.&quot;</span>), AbsolutePath );</span><br><span class="line">      <span class="keyword">if</span> (!GIsBuildMachine)</span><br><span class="line">      &#123;</span><br><span class="line">        FMessageDialog::<span class="built_in">Open</span>(EAppMsgType::Ok, Message);</span><br><span class="line">      &#125;</span><br><span class="line">      FApp::<span class="built_in">SetProjectName</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>)); <span class="comment">// this disables part of the crash reporter to avoid writing log files to a bogus directory</span></span><br><span class="line">      <span class="keyword">if</span> (!GIsBuildMachine)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">UE_LOG</span>(LogInit, Fatal,<span class="built_in">TEXT</span>(<span class="string">&quot;%s&quot;</span>), *Message.<span class="built_in">ToString</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  FConfigCacheIni::<span class="built_in">LoadGlobalIniFile</span>(GGameIni, <span class="built_in">TEXT</span>(<span class="string">&quot;Game&quot;</span>));</span><br><span class="line">  FConfigCacheIni::<span class="built_in">LoadGlobalIniFile</span>(GInputIni, <span class="built_in">TEXT</span>(<span class="string">&quot;Input&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">  <span class="comment">// load some editor specific .ini files</span></span><br><span class="line"></span><br><span class="line">  FConfigCacheIni::<span class="built_in">LoadGlobalIniFile</span>(GEditorIni, <span class="built_in">TEXT</span>(<span class="string">&quot;Editor&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Upgrade editor user settings before loading the editor per project user settings</span></span><br><span class="line">  FConfigManifest::<span class="built_in">MigrateEditorUserSettings</span>();</span><br><span class="line">  FConfigCacheIni::<span class="built_in">LoadGlobalIniFile</span>(GEditorPerProjectIni, <span class="built_in">TEXT</span>(<span class="string">&quot;EditorPerProjectUserSettings&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Project agnostic editor ini files</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> FString EditorSettingsDir = FPaths::<span class="built_in">Combine</span>(*FPaths::<span class="built_in">GameAgnosticSavedDir</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;Config&quot;</span>)) + <span class="built_in">TEXT</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">  FConfigCacheIni::<span class="built_in">LoadGlobalIniFile</span>(GEditorSettingsIni, <span class="built_in">TEXT</span>(<span class="string">&quot;EditorSettings&quot;</span>), <span class="literal">nullptr</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">true</span>, *EditorSettingsDir);</span><br><span class="line">  FConfigCacheIni::<span class="built_in">LoadGlobalIniFile</span>(GEditorLayoutIni, <span class="built_in">TEXT</span>(<span class="string">&quot;EditorLayout&quot;</span>), <span class="literal">nullptr</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">true</span>, *EditorSettingsDir);</span><br><span class="line">  FConfigCacheIni::<span class="built_in">LoadGlobalIniFile</span>(GEditorKeyBindingsIni, <span class="built_in">TEXT</span>(<span class="string">&quot;EditorKeyBindings&quot;</span>), <span class="literal">nullptr</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">true</span>, *EditorSettingsDir);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_DESKTOP</span></span><br><span class="line">  <span class="comment">// load some desktop only .ini files</span></span><br><span class="line">  FConfigCacheIni::<span class="built_in">LoadGlobalIniFile</span>(GCompatIni, <span class="built_in">TEXT</span>(<span class="string">&quot;Compat&quot;</span>));</span><br><span class="line">  FConfigCacheIni::<span class="built_in">LoadGlobalIniFile</span>(GLightmassIni, <span class="built_in">TEXT</span>(<span class="string">&quot;Lightmass&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Load scalability settings.</span></span><br><span class="line">  FConfigCacheIni::<span class="built_in">LoadGlobalIniFile</span>(GScalabilityIni, <span class="built_in">TEXT</span>(<span class="string">&quot;Scalability&quot;</span>));</span><br><span class="line">  <span class="comment">// Load driver blacklist</span></span><br><span class="line">  FConfigCacheIni::<span class="built_in">LoadGlobalIniFile</span>(GHardwareIni, <span class="built_in">TEXT</span>(<span class="string">&quot;Hardware&quot;</span>));</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Load user game settings .ini, allowing merging. This also updates the user .ini if necessary.</span></span><br><span class="line">  FConfigCacheIni::<span class="built_in">LoadGlobalIniFile</span>(GGameUserSettingsIni, <span class="built_in">TEXT</span>(<span class="string">&quot;GameUserSettings&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// now we can make use of GConfig</span></span><br><span class="line">  GConfig-&gt;bIsReadyForUse = <span class="literal">true</span>;</span><br><span class="line">  FCoreDelegates::ConfigReadyForUse.<span class="built_in">Broadcast</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="FConfigCacheIni-LoadGlobalIniFile"><a href="#FConfigCacheIni-LoadGlobalIniFile" class="headerlink" title="FConfigCacheIni::LoadGlobalIniFile"></a>FConfigCacheIni::LoadGlobalIniFile</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// --------------------------------</span></span><br><span class="line"><span class="comment">// # FConfigCacheIni::LoadGlobalIniFile declaration</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Loads and generates a destination ini file and adds it to GConfig:</span></span><br><span class="line"><span class="comment"> *   - Looking on commandline for override source/dest .ini filenames</span></span><br><span class="line"><span class="comment"> *   - Generating the name for the engine to refer to the ini</span></span><br><span class="line"><span class="comment"> *   - Loading a source .ini file hierarchy</span></span><br><span class="line"><span class="comment"> *   - Filling out an FConfigFile</span></span><br><span class="line"><span class="comment"> *   - Save the generated ini</span></span><br><span class="line"><span class="comment"> *   - Adds the FConfigFile to GConfig</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param FinalIniFilename The output name of the generated .ini file (in Game\Saved\Config)</span></span><br><span class="line"><span class="comment"> * @param BaseIniName The &quot;base&quot; ini name, with no extension (ie, Engine, Game, etc)</span></span><br><span class="line"><span class="comment"> * @param Platform The platform to load the .ini for (if NULL, uses current)</span></span><br><span class="line"><span class="comment"> * @param bForceReload If true, the destination .in will be regenerated from the source, otherwise this will only process if the dest isn&#x27;t in GConfig</span></span><br><span class="line"><span class="comment"> * @param bRequireDefaultIni If true, the Default*.ini file is required to exist when generating the final ini file.</span></span><br><span class="line"><span class="comment"> * @param bAllowGeneratedIniWhenCooked If true, the engine will attempt to load the generated/user INI file when loading cooked games</span></span><br><span class="line"><span class="comment"> * @param GeneratedConfigDir The location where generated config files are made.</span></span><br><span class="line"><span class="comment"> * @return true if the final ini was created successfully.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">LoadGlobalIniFile</span><span class="params">(FString&amp; FinalIniFilename, <span class="keyword">const</span> TCHAR* BaseIniName, <span class="keyword">const</span> TCHAR* Platform=<span class="literal">NULL</span>, <span class="keyword">bool</span> bForceReload=<span class="literal">false</span>, <span class="keyword">bool</span> bRequireDefaultIni=<span class="literal">false</span>, <span class="keyword">bool</span> bAllowGeneratedIniWhenCooked=<span class="literal">true</span>, <span class="keyword">const</span> TCHAR* GeneratedConfigDir = *FPaths::GeneratedConfigDir())</span></span>;</span><br><span class="line"><span class="comment">// --------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FConfigCacheIni::LoadGlobalIniFile</span><span class="params">(FString&amp; FinalIniFilename, <span class="keyword">const</span> TCHAR* BaseIniName, <span class="keyword">const</span> TCHAR* Platform, <span class="keyword">bool</span> bForceReload, <span class="keyword">bool</span> bRequireDefaultIni, <span class="keyword">bool</span> bAllowGeneratedIniWhenCooked, <span class="keyword">const</span> TCHAR* GeneratedConfigDir)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// figure out where the end ini file is</span></span><br><span class="line">  FinalIniFilename = <span class="built_in">GetDestIniFilename</span>(BaseIniName, Platform, GeneratedConfigDir);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Start the loading process for the remote config file when appropriate</span></span><br><span class="line">  <span class="keyword">if</span> (FRemoteConfig::<span class="built_in">Get</span>()-&gt;<span class="built_in">ShouldReadRemoteFile</span>(*FinalIniFilename))</span><br><span class="line">  &#123;</span><br><span class="line">    FRemoteConfig::<span class="built_in">Get</span>()-&gt;<span class="built_in">Read</span>(*FinalIniFilename, BaseIniName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  FRemoteConfigAsyncIOInfo* RemoteInfo = FRemoteConfig::<span class="built_in">Get</span>()-&gt;<span class="built_in">FindConfig</span>(*FinalIniFilename);</span><br><span class="line">  <span class="keyword">if</span> (RemoteInfo &amp;&amp; (!RemoteInfo-&gt;bWasProcessed || !FRemoteConfig::<span class="built_in">Get</span>()-&gt;<span class="built_in">IsFinished</span>(*FinalIniFilename)))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Defer processing this remote config file to until it has finish its IO operation</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// need to check to see if the file already exists in the GConfigManager&#x27;s cache</span></span><br><span class="line">  <span class="comment">// if it does exist then we are done, nothing else to do</span></span><br><span class="line">  <span class="keyword">if</span> (!bForceReload &amp;&amp; GConfig-&gt;<span class="built_in">FindConfigFile</span>(*FinalIniFilename) != <span class="literal">nullptr</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">//UE_LOG(LogConfig, Log,  TEXT( &quot;Request to load a config file that was already loaded: %s&quot;), GeneratedIniFile );</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// make a new entry in GConfig (overwriting what&#x27;s already there)</span></span><br><span class="line">  FConfigFile&amp; NewConfigFile = GConfig-&gt;<span class="built_in">Add</span>(FinalIniFilename, <span class="built_in">FConfigFile</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">LoadExternalIniFile</span>(NewConfigFile, BaseIniName, *FPaths::<span class="built_in">EngineConfigDir</span>(), *FPaths::<span class="built_in">SourceConfigDir</span>(), <span class="literal">true</span>, Platform, bForceReload, <span class="literal">true</span>, bAllowGeneratedIniWhenCooked, GeneratedConfigDir);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="FConfigCacheIni-LoadLocalIniFile"><a href="#FConfigCacheIni-LoadLocalIniFile" class="headerlink" title="FConfigCacheIni::LoadLocalIniFile"></a>FConfigCacheIni::LoadLocalIniFile</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// --------------------------------</span></span><br><span class="line"><span class="comment">// # FConfigCacheIni::LoadLocalIniFile declaration</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Load an ini file directly into an FConfigFile, and nothing is written to GConfig or disk. </span></span><br><span class="line"><span class="comment"> * The passed in .ini name can be a &quot;base&quot; (Engine, Game) which will be modified by platform and/or commandline override,</span></span><br><span class="line"><span class="comment"> * or it can be a full ini filenname (ie WrangleContent) loaded from the Source config directory</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param ConfigFile The output object to fill</span></span><br><span class="line"><span class="comment"> * @param IniName Either a Base ini name (Engine) or a full ini name (WrangleContent). NO PATH OR EXTENSION SHOULD BE USED!</span></span><br><span class="line"><span class="comment"> * @param bIsBaseIniName true if IniName is a Base name, which can be overridden on commandline, etc.</span></span><br><span class="line"><span class="comment"> * @param Platform The platform to use for Base ini names, NULL means to use the current platform</span></span><br><span class="line"><span class="comment"> * @param bForceReload force reload the ini file from disk this is required if you make changes to the ini file not using the config system as the hierarchy cache will not be updated in this case</span></span><br><span class="line"><span class="comment"> * @return true if the ini file was loaded successfully</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">LoadLocalIniFile</span><span class="params">(FConfigFile&amp; ConfigFile, <span class="keyword">const</span> TCHAR* IniName, <span class="keyword">bool</span> bIsBaseIniName, <span class="keyword">const</span> TCHAR* Platform=<span class="literal">NULL</span>, <span class="keyword">bool</span> bForceReload=<span class="literal">false</span>)</span></span>;</span><br><span class="line"><span class="comment">// --------------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FConfigCacheIni::LoadLocalIniFile</span><span class="params">(FConfigFile&amp; ConfigFile, <span class="keyword">const</span> TCHAR* IniName, <span class="keyword">bool</span> bIsBaseIniName, <span class="keyword">const</span> TCHAR* Platform, <span class="keyword">bool</span> bForceReload )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">DECLARE_SCOPE_CYCLE_COUNTER</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;FConfigCacheIni::LoadLocalIniFile&quot;</span> ), STAT_FConfigCacheIni_LoadLocalIniFile, STATGROUP_LoadTime );</span><br><span class="line"></span><br><span class="line">  FString EngineConfigDir = FPaths::<span class="built_in">EngineConfigDir</span>();</span><br><span class="line">  FString SourceConfigDir = FPaths::<span class="built_in">SourceConfigDir</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bIsBaseIniName)</span><br><span class="line">  &#123;</span><br><span class="line">    FConfigFile* BaseConfig = GConfig-&gt;<span class="built_in">FindConfigFileWithBaseName</span>(IniName);</span><br><span class="line">    <span class="comment">// If base ini, try to use an existing GConfig file to set the config directories instead of assuming defaults</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (BaseConfig)</span><br><span class="line">    &#123;</span><br><span class="line">      FIniFilename* EngineFilename = BaseConfig-&gt;SourceIniHierarchy.<span class="built_in">Find</span>(EConfigFileHierarchy::EngineDirBase);</span><br><span class="line">      <span class="keyword">if</span> (EngineFilename)</span><br><span class="line">      &#123;</span><br><span class="line">        EngineConfigDir = FPaths::<span class="built_in">GetPath</span>(EngineFilename-&gt;Filename) + <span class="built_in">TEXT</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      FIniFilename* GameFilename = BaseConfig-&gt;SourceIniHierarchy.<span class="built_in">Find</span>(EConfigFileHierarchy::GameDirDefault);</span><br><span class="line">      <span class="keyword">if</span> (GameFilename)</span><br><span class="line">      &#123;</span><br><span class="line">        SourceConfigDir = FPaths::<span class="built_in">GetPath</span>(GameFilename-&gt;Filename) + <span class="built_in">TEXT</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">LoadExternalIniFile</span>(ConfigFile, IniName, *EngineConfigDir, *SourceConfigDir, bIsBaseIniName, Platform, bForceReload, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="FConfigCacheIni-LoadExternalIniFile"><a href="#FConfigCacheIni-LoadExternalIniFile" class="headerlink" title="FConfigCacheIni::LoadExternalIniFile"></a>FConfigCacheIni::LoadExternalIniFile</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// --------------------------------</span></span><br><span class="line"><span class="comment">// # FConfigCacheIni::LoadExternalIniFile declaration</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Load an ini file directly into an FConfigFile from the specified config folders, optionally writing to disk. </span></span><br><span class="line"><span class="comment"> * The passed in .ini name can be a &quot;base&quot; (Engine, Game) which will be modified by platform and/or commandline override,</span></span><br><span class="line"><span class="comment"> * or it can be a full ini filenname (ie WrangleContent) loaded from the Source config directory</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param ConfigFile The output object to fill</span></span><br><span class="line"><span class="comment"> * @param IniName Either a Base ini name (Engine) or a full ini name (WrangleContent). NO PATH OR EXTENSION SHOULD BE USED!</span></span><br><span class="line"><span class="comment"> * @param EngineConfigDir Engine config directory.</span></span><br><span class="line"><span class="comment"> * @param SourceConfigDir Game config directory.</span></span><br><span class="line"><span class="comment"> * @param bIsBaseIniName true if IniName is a Base name, which can be overridden on commandline, etc.</span></span><br><span class="line"><span class="comment"> * @param Platform The platform to use for Base ini names</span></span><br><span class="line"><span class="comment"> * @param bForceReload force reload the ini file from disk this is required if you make changes to the ini file not using the config system as the hierarchy cache will not be updated in this case</span></span><br><span class="line"><span class="comment"> * @param bWriteDestIni write out a destination ini file to the Saved folder, only valid if bIsBaseIniName is true</span></span><br><span class="line"><span class="comment"> * @param bAllowGeneratedIniWhenCooked If true, the engine will attempt to load the generated/user INI file when loading cooked games</span></span><br><span class="line"><span class="comment"> * @param GeneratedConfigDir The location where generated config files are made.</span></span><br><span class="line"><span class="comment"> * @return true if the ini file was loaded successfully</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">LoadExternalIniFile</span><span class="params">(FConfigFile&amp; ConfigFile, <span class="keyword">const</span> TCHAR* IniName, <span class="keyword">const</span> TCHAR* EngineConfigDir, <span class="keyword">const</span> TCHAR* SourceConfigDir, <span class="keyword">bool</span> bIsBaseIniName, <span class="keyword">const</span> TCHAR* Platform=<span class="literal">NULL</span>, <span class="keyword">bool</span> bForceReload=<span class="literal">false</span>, <span class="keyword">bool</span> bWriteDestIni=<span class="literal">false</span>, <span class="keyword">bool</span> bAllowGeneratedIniWhenCooked = <span class="literal">true</span>, <span class="keyword">const</span> TCHAR* GeneratedConfigDir = *FPaths::GeneratedConfigDir())</span></span>;</span><br><span class="line"><span class="comment">// --------------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FConfigCacheIni::LoadExternalIniFile</span><span class="params">(FConfigFile&amp; ConfigFile, <span class="keyword">const</span> TCHAR* IniName, <span class="keyword">const</span> TCHAR* EngineConfigDir, <span class="keyword">const</span> TCHAR* SourceConfigDir, <span class="keyword">bool</span> bIsBaseIniName, <span class="keyword">const</span> TCHAR* Platform, <span class="keyword">bool</span> bForceReload, <span class="keyword">bool</span> bWriteDestIni, <span class="keyword">bool</span> bAllowGeneratedIniWhenCooked, <span class="keyword">const</span> TCHAR* GeneratedConfigDir)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// if bIsBaseIniName is false, that means the .ini is a ready-to-go .ini file, and just needs to be loaded into the FConfigFile</span></span><br><span class="line">  <span class="keyword">if</span> (!bIsBaseIniName)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// generate path to the .ini file (not a Default ini, IniName is the complete name of the file, without path)</span></span><br><span class="line">    FString SourceIniFilename = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%s/%s.ini&quot;</span>), SourceConfigDir, IniName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// load the .ini file straight up</span></span><br><span class="line">    <span class="built_in">LoadAnIniFile</span>(*SourceIniFilename, ConfigFile);</span><br><span class="line"></span><br><span class="line">    ConfigFile.Name = IniName;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    FString DestIniFilename = <span class="built_in">GetDestIniFilename</span>(IniName, Platform, GeneratedConfigDir);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">GetSourceIniHierarchyFilenames</span>(IniName, Platform, EngineConfigDir, SourceConfigDir, ConfigFile.SourceIniHierarchy, <span class="literal">false</span> );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bForceReload)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">ClearHierarchyCache</span>(IniName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Keep a record of the original settings</span></span><br><span class="line">    ConfigFile.SourceConfigFile = <span class="keyword">new</span> <span class="built_in">FConfigFile</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// now generate and make sure it&#x27;s up to date (using IniName as a Base for an ini filename)</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> bAllowGeneratedINIs = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">bool</span> bNeedsWrite = <span class="built_in">GenerateDestIniFile</span>(ConfigFile, DestIniFilename, ConfigFile.SourceIniHierarchy, bAllowGeneratedIniWhenCooked, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    ConfigFile.Name = IniName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// don&#x27;t write anything to disk in cooked builds - we will always use re-generated INI files anyway.</span></span><br><span class="line">    <span class="keyword">if</span> (bWriteDestIni &amp;&amp; (!FPlatformProperties::<span class="built_in">RequiresCookedData</span>() || bAllowGeneratedIniWhenCooked)</span><br><span class="line">      <span class="comment">// We shouldn&#x27;t save config files when in multiprocess mode,</span></span><br><span class="line">      <span class="comment">// otherwise we get file contention in XGE shader builds.</span></span><br><span class="line">      &amp;&amp; !FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;Multiprocess&quot;</span>)))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// Check the config system for any changes made to defaults and propagate through to the saved.</span></span><br><span class="line">      ConfigFile.<span class="built_in">ProcessSourceAndCheckAgainstBackup</span>();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (bNeedsWrite)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// if it was dirtied during the above function, save it out now</span></span><br><span class="line">        ConfigFile.<span class="built_in">Write</span>(DestIniFilename);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// GenerateDestIniFile returns true if nothing is loaded, so check if we actually loaded something</span></span><br><span class="line">  <span class="keyword">return</span> ConfigFile.<span class="built_in">Num</span>() &gt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数中最重要的部分就是调用了<code>GetSourceIniHierarchyFilenames</code>，它把当前传入的 baseName 的 ini 在 Engine 和项目下的所有 ini 文件都收集了起来。</p>
<p>这就是为什么我们看到其实 GConfig 中很多都是 <code>Saved/Config</code> 下的 ini，里面内容是空的，但是我们怎么查到项目里的设置的呢？这是因为 UE 把这么多个 ini 合并了：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/2386/ue4-gather-ini-source-ini-hierachy.webp"></p>
<p>这些 ini 的的内容都会加载进来。</p>
<h3 id="GetDestIniFilename"><a href="#GetDestIniFilename" class="headerlink" title="GetDestIniFilename"></a>GetDestIniFilename</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime/Source/Core/Private/Misc/ConfigCacheIni.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Calculates the name of a dest (generated) .ini file for a given base (ie Engine, Game, etc)</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param IniBaseName Base name of the .ini (Engine, Game)</span></span><br><span class="line"><span class="comment"> * @param PlatformName Name of the platform to get the .ini path for (nullptr means to use the current platform)</span></span><br><span class="line"><span class="comment"> * @param GeneratedConfigDir The base folder that will contain the generated config files.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @return Standardized .ini filename</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> FString <span class="title">GetDestIniFilename</span><span class="params">(<span class="keyword">const</span> TCHAR* BaseIniName, <span class="keyword">const</span> TCHAR* PlatformName, <span class="keyword">const</span> TCHAR* GeneratedConfigDir)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// figure out what to look for on the commandline for an override</span></span><br><span class="line">  FString CommandLineSwitch = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%sINI=&quot;</span>), BaseIniName);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// if it&#x27;s not found on the commandline, then generate it</span></span><br><span class="line">  FString IniFilename;</span><br><span class="line">  <span class="keyword">if</span> (FParse::<span class="built_in">Value</span>(FCommandLine::<span class="built_in">Get</span>(), *CommandLineSwitch, IniFilename) == <span class="literal">false</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function">FString <span class="title">Name</span><span class="params">(PlatformName ? PlatformName : ANSI_TO_TCHAR(FPlatformProperties::PlatformName()))</span></span>;</span><br><span class="line"></span><br><span class="line">    FString BaseIniNameString = BaseIniName;</span><br><span class="line">    <span class="keyword">if</span> (BaseIniNameString.<span class="built_in">Contains</span>(GeneratedConfigDir))</span><br><span class="line">    &#123;</span><br><span class="line">      IniFilename = BaseIniNameString;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// put it all together</span></span><br><span class="line">      IniFilename = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%s%s/%s.ini&quot;</span>), GeneratedConfigDir, *Name, BaseIniName);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// standardize it!</span></span><br><span class="line">  FPaths::<span class="built_in">MakeStandardFilename</span>(IniFilename);</span><br><span class="line">  <span class="keyword">return</span> IniFilename;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而 <code>FPaths::GeneratedConfigDir</code> 获取的路径是当前项目的 <code>Saved</code> 下的 Config：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Paths.cpp</span></span><br><span class="line"><span class="function">FString <span class="title">FPaths::GeneratedConfigDir</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_MAC</span></span><br><span class="line">  <span class="keyword">return</span> FPlatformProcess::<span class="built_in">UserPreferencesDir</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">return</span> FPaths::<span class="built_in">ProjectSavedDir</span>() + <span class="built_in">TEXT</span>(<span class="string">&quot;Config/&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>即在 Windows 平台上项目启动时创建的全局 <code>G*Ini</code> 文件读取的都是 <code>Saved/Config/Windows</code> 下的 <code>.ini</code>。<br> 而且在 <code>GetDestIniFilename</code> 的实现中也可以看到，<code>G*Ini</code>的配置也是可以从 CommandLine 传入的，可以替换掉默认的 <code>Saved/Config/Platform</code> 下的 ini:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">// 使用指定的 Engine.ini</span><br><span class="line">UE4Editor.exe uprojectPath -EngineINI=<span class="string">&quot;D:\\CustomEngine.ini&quot;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/2386/ue-pass-custom-globalconfig-by-commandline.webp"><br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/2386/ue-pass-custom-globalconfig-by-commandline-2.webp"></p>
<p><strong>扩展阅读</strong></p>
<ul>
<li><a href="https://docs.unrealengine.com/en-US/Programming/Basics/ConfigurationFiles/index.html">ConfigurationFiles</a></li>
<li><a href="https://wiki.unrealengine.com/Config_Files,_Read_%26_Write_to_Config_Files">Config Files, Read &amp; Write to Config Files</a></li>
<li><a href="https://blog.ch-wind.com/ue4-config-usage/">UE4 中 Config 的使用</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
      </categories>
      <tags>
        <tag>Engine</tag>
        <tag>GConfig</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 模块的加载与启动分析</title>
    <url>/wiki/24007/</url>
    <content><![CDATA[<p>UE 是模块化的架构，Engine/Game Project/StandaloneApplication/Plugins 都是 Module(<a href="http://api.unrealengine.com/INT/API/index.html">Unreal Engine API Reference</a>列出了 Engine 提供的 Module 列表)，本篇文章从 <code>FModuleManager</code> 的代码来分析一下 UE 的 Module 是如何通过 <code>FModuleManager::LoadModule</code> 加载和启动的。</p>
<span id="more"></span>
<h2 id="Forward"><a href="#Forward" class="headerlink" title="Forward"></a>Forward</h2><blockquote>
<p>本文的 UE 代码引用均为 4.21 版本。</p>
</blockquote>
<p><strong>注意 </strong>：本文中说的<code>IS_MONOLITHIC</code> 是模块使用者的 <code>*.target.cs</code> 中的 <code>LinkType</code>, 可以使用<code>TargetLinkType.Monolithic</code> 来指定。</p>
<ul>
<li>TargetLinkType.Monolithic(单片模式)的含义是将所有的代码放到一个单独的可执行文件中，编译时使用实现包含或者静态链接等方式，不依赖其他 Module 的 DLL。</li>
</ul>
<p><strong>Module API Specifiers</strong>详见：<a href="https://docs.unrealengine.com/en-US/Programming/Modules/API">Programming/ModulesModule API Specifiers</a></p>
<blockquote>
<p><code>FModuleManager::LoadModule</code>或者 <code>FModuleManager::LoadModuleWithFailureReason</code> 的调用会执行被加载 Module 的<code>StartupModule</code>.</p>
</blockquote>
<h2 id="Module-Implementation"><a href="#Module-Implementation" class="headerlink" title="Module Implementation"></a>Module Implementation</h2><p>在 UE 中，项目的宏是 <code>IMPLEMENT_PRIMARY_GAME_MODULE</code>，在创建项目后它一般是在<code>ProjectName.cpp</code> 中定义：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">IMPLEMENT_PRIMARY_GAME_MODULE</span>(FDefaultGameModuleImpl, VRExpansion, <span class="string">&quot;VRExpansion&quot;</span> );</span><br></pre></td></tr></table></figure>
<p><code>FDefaultGameModuleImpl</code>是一个继承自 <code>FDefaultModuleImpl</code> 又间接继承自 <code>IModuleInterface</code> 的类，没有重写 <code>IModuleInterface</code> 的任何函数，仅作为一层封装的默认实现 (游戏项目的启动也不需要通过 Module 的 StartupModule 驱动)。在 Module 中可以传入自己继承自<code>IModuleInterface</code> 的类，重写其中的接口，就可以在 Module 加载时做特定的行为了 (<code>IModuleInterface</code> 的接口列在后面)。</p>
<p><code>IMPLEMENT_PRIMARY_GAME_MODULE</code>宏首先替换到 <code>IMPLEMENT_GAME_MODULE</code> 然后又继续替换到的也是 <code>IMPLEMENT_MODULE</code>.<br> 在目前的引擎实现里看，这三个宏没有区别：</p>
<ul>
<li>IMPLEMENT_PRIMARY_GAME_MODULE</li>
<li>IMPLEMENT_GAME_MODULE</li>
<li>IMPLEMENT_MODULE</li>
</ul>
<p>一般插件中使用的都是 <code>IMPLEMENT_MODULE</code>(该宏定义在<code>Runtime\Core\Public\Modules\ModuleManger.h</code> 中):</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> IS_MONOLITHIC</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// If we&#x27;re linking monolithically we assume all modules are linked in with the main binary.</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> IMPLEMENT_MODULE(ModuleImplClass, ModuleName) \</span></span><br><span class="line"><span class="meta">    <span class="comment">/** Global registrant object for this module when linked statically */</span> \</span></span><br><span class="line"><span class="meta">    static FStaticallyLinkedModuleRegistrant<span class="meta-string">&lt; ModuleImplClass &gt;</span> ModuleRegistrant##ModuleName(#ModuleName); \</span></span><br><span class="line"><span class="meta">    <span class="comment">/** Implement an empty function so that if this module is built as a statically linked lib, */</span> \</span></span><br><span class="line"><span class="meta">    <span class="comment">/** static initialization for this lib can be forced by referencing this symbol */</span> \</span></span><br><span class="line"><span class="meta">    void EmptyLinkFunctionForStaticInitialization##ModuleName()&#123;&#125; \</span></span><br><span class="line"><span class="meta">    PER_MODULE_BOILERPLATE_ANYLINK(ModuleImplClass, ModuleName)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> IMPLEMENT_MODULE(ModuleImplClass, ModuleName) \</span></span><br><span class="line"><span class="meta">    \</span></span><br><span class="line"><span class="meta">    <span class="comment">/**/</span> \</span></span><br><span class="line"><span class="meta">    <span class="comment">/* InitializeModule function, called by module manager after this module&#x27;s DLL has been loaded */</span> \</span></span><br><span class="line"><span class="meta">    <span class="comment">/**/</span> \</span></span><br><span class="line"><span class="meta">    <span class="comment">/* @return  Returns an instance of this module */</span> \</span></span><br><span class="line"><span class="meta">    <span class="comment">/**/</span> \</span></span><br><span class="line"><span class="meta">    extern <span class="meta-string">&quot;C&quot;</span> DLLEXPORT IModuleInterface* InitializeModule() \</span></span><br><span class="line"><span class="meta">    &#123; \</span></span><br><span class="line"><span class="meta">      return new ModuleImplClass(); \</span></span><br><span class="line"><span class="meta">    &#125; \</span></span><br><span class="line"><span class="meta">    PER_MODULE_BOILERPLATE \</span></span><br><span class="line"><span class="meta">    PER_MODULE_BOILERPLATE_ANYLINK(ModuleImplClass, ModuleName)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">//IS_MONOLITHIC</span></span></span><br></pre></td></tr></table></figure>
<p>这个宏的含义是定义和导出一个通用的模块接口，供外部来驱动这个 Module 启动 / 停止或者其他，这个宏是必须的，有这个宏才能被 UE 的模块机制驱动。</p>
<h2 id="IS-MONOLITHIC"><a href="#IS-MONOLITHIC" class="headerlink" title="IS_MONOLITHIC"></a>IS_MONOLITHIC</h2><p>在编译目标的 <code>target.cs</code> 中<code>LinkType</code>是 <code>TargetLinkType.Monolithic</code> 的情况下，则编译时使用的时 <code>IS_MONOLITHIC</code> 逻辑。这种模式下 Module 的 <code>IMPLEMENT_MODULE</code> 宏则是构造了一个 <code>FStaticallyLinkedModuleRegistrant&lt;ModuleImplClass&gt;</code> 的 static 对象，在它的构造函数中会调用 <code>FModuleManager::RegisterStaticallyLinkedModule</code> 来将其添加到一个 TMap 对象 (<code>FModuleManager::StaticallyLinkedModuleInitializers</code>) 中，供后续 LoadModule 时查找:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt; <span class="class"><span class="keyword">class</span> <span class="title">ModuleClass</span> &gt;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FStaticallyLinkedModuleRegistrant</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Explicit constructor that registers a statically linked module</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="built_in">FStaticallyLinkedModuleRegistrant</span>(<span class="keyword">const</span> ANSICHAR* InModuleName )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Create a delegate to our InitializeModule method</span></span><br><span class="line">    FModuleManager::FInitializeStaticallyLinkedModule InitializerDelegate = FModuleManager::FInitializeStaticallyLinkedModule::<span class="built_in">CreateRaw</span>(</span><br><span class="line">        <span class="keyword">this</span>, &amp;FStaticallyLinkedModuleRegistrant&lt;ModuleClass&gt;::InitializeModule );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register this module</span></span><br><span class="line">    FModuleManager::<span class="built_in">Get</span>().<span class="built_in">RegisterStaticallyLinkedModule</span>(</span><br><span class="line">      <span class="built_in">FName</span>(InModuleName),  <span class="comment">// Module name</span></span><br><span class="line">      InitializerDelegate );  <span class="comment">// Initializer delegate</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Creates and initializes this statically linked module.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * The module manager calls this function through the delegate that was created</span></span><br><span class="line"><span class="comment">   * in the @see FStaticallyLinkedModuleRegistrant constructor.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @return A pointer to a new instance of the module.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">IModuleInterface* <span class="title">InitializeModule</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">ModuleClass</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FModuleManager</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">RegisterStaticallyLinkedModule</span><span class="params">(<span class="keyword">const</span> FName InModuleName, <span class="keyword">const</span> FInitializeStaticallyLinkedModule&amp; InInitializerDelegate )</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    StaticallyLinkedModuleInitializers.<span class="built_in">Add</span>(InModuleName, InInitializerDelegate);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">/** Map of module names to a delegate that can initialize each respective statically linked module */</span></span><br><span class="line">  <span class="keyword">typedef</span> TMap&lt; FName, FInitializeStaticallyLinkedModule &gt; FStaticallyLinkedModuleInitializerMap;</span><br><span class="line">  FStaticallyLinkedModuleInitializerMap StaticallyLinkedModuleInitializers;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>IS_MONOLITHIC</code>的情况下，函数 <strong>FModuleManager::LoadModuleWithFailureReason</strong>(调用<code>FModuleManager::LoadModule</code> 实现上也是转发到这里)通过对 TMap<code>ModuleName-InitializerDelegate</code>(<strong>FStaticallyLinkedModuleRegistrant<ModuleClass>::InitializeModule</strong>)的查找，可以得到一个指定模块的 <code>IModuleInterface</code> 接口。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// FModuleManager::LoadModuleWithFailureReason (Runtime\Core\Private\Modules\ModuleManager.cpp)</span></span><br><span class="line"><span class="function">IModuleInterface* <span class="title">FModuleManager::LoadModuleWithFailureReason</span><span class="params">(<span class="keyword">const</span> FName InModuleName, EModuleLoadResult&amp; OutFailureReason)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// something....</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Make sure this isn&#x27;t a module that we had previously loaded, and then unloaded at shutdown time.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// If this assert goes off, your trying to load a module during the shutdown phase that was already</span></span><br><span class="line">  <span class="comment">// cleaned up.  The easiest way to fix this is to change your code to query for an already-loaded</span></span><br><span class="line">  <span class="comment">// module instead of trying to load it directly.</span></span><br><span class="line">  <span class="built_in">checkf</span>((!ModuleInfo-&gt;bWasUnloadedAtShutdown), <span class="built_in">TEXT</span>(<span class="string">&quot;Attempted to load module &#x27;%s&#x27; that was already unloaded at shutdown.  FModuleManager::LoadModule() was called to load a module that was previously loaded, and was unloaded at shutdown time.  If this assert goes off, your trying to load a module during the shutdown phase that was already cleaned up.  The easiest way to fix this is to change your code to query for an already-loaded module instead of trying to load it directly.&quot;</span>), *InModuleName.<span class="built_in">ToString</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if we&#x27;re statically linked with the module.  Those modules register with the module manager using a static variable,</span></span><br><span class="line">  <span class="comment">// so hopefully we already know about the name of the module and how to initialize it.</span></span><br><span class="line">  <span class="keyword">const</span> FInitializeStaticallyLinkedModule* ModuleInitializerPtr = StaticallyLinkedModuleInitializers.<span class="built_in">Find</span>(InModuleName);</span><br><span class="line">  <span class="keyword">if</span> (ModuleInitializerPtr != <span class="literal">nullptr</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function"><span class="keyword">const</span> FInitializeStaticallyLinkedModule&amp; <span class="title">ModuleInitializer</span><span class="params">(*ModuleInitializerPtr)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize the module!</span></span><br><span class="line">    ModuleInfo-&gt;Module = TUniquePtr&lt;IModuleInterface&gt;(ModuleInitializer.<span class="built_in">Execute</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ModuleInfo-&gt;Module.<span class="built_in">IsValid</span>())</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">// Startup the module</span></span><br><span class="line">    ModuleInfo-&gt;Module-&gt;<span class="built_in">StartupModule</span>();</span><br><span class="line">    <span class="comment">// The module might try to load other dependent modules in StartupModule. In this case, we want those modules shut down AFTER this one because we may still depend on the module at shutdown.</span></span><br><span class="line">    ModuleInfo-&gt;LoadOrder = FModuleInfo::CurrentLoadOrder++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Module was started successfully!  Fire callbacks.</span></span><br><span class="line">    ModulesChangedEvent.<span class="built_in">Broadcast</span>(InModuleName, EModuleChangeReason::ModuleLoaded);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the return parameter</span></span><br><span class="line">    LoadedModule = ModuleInfo-&gt;Module.<span class="built_in">Get</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="built_in">UE_LOG</span>(LogModuleManager, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;ModuleManager: Unable to load module &#x27;%s&#x27; because InitializeModule function failed (returned nullptr.)&quot;</span>), *InModuleName.<span class="built_in">ToString</span>());</span><br><span class="line">    OutFailureReason = EModuleLoadResult::FailedToInitialize;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> IS_MONOLITHIC</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Monolithic builds that do not have the initializer were *not found* during the build step, so return FileNotFound</span></span><br><span class="line">    <span class="comment">// (FileNotFound is an acceptable error in some case - ie loading a content only project)</span></span><br><span class="line">    <span class="built_in">UE_LOG</span>(LogModuleManager, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;ModuleManager: Module &#x27;%s&#x27; not found - its StaticallyLinkedModuleInitializers function is null.&quot;</span>), *InModuleName.<span class="built_in">ToString</span>());</span><br><span class="line">    OutFailureReason = EModuleLoadResult::FileNotFound;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">// something....</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="IS-MONOLITHIC-1"><a href="#IS-MONOLITHIC-1" class="headerlink" title="!IS_MONOLITHIC"></a>!IS_MONOLITHIC</h2><p>在 <code>!IS_MONOLITHIC</code> 的情况下，它是导出了一个 <code>IModuleInterface* InitializeModule()</code> 的符号 (在<code>target.cs</code> 中没有指定为 <code>LinkType.Monolithic</code>(<code>IS_MONOLITHIC</code>) 的情况下每个 Module 是单独的链接库 (lib/dll))。<br> 在使用 <code>FModuleManager::LoadModuleWithFailureReason</code> 来加载指定 Module 时，首先通过 <code>FModuleManager::FindModulePaths</code> 来获取 Module 的链接库 (DLL) 路径：<br>它会依次查找:</p>
<ul>
<li>FPlatformProcess::GetModulesDirectory</li>
<li>EngineBinariesDirectories</li>
<li>GameBinariesDirectories</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !IS_MONOLITHIC</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FModuleManager::FindModulePaths</span><span class="params">(<span class="keyword">const</span> TCHAR* NamePattern, TMap&lt;FName, FString&gt; &amp;OutModulePaths, <span class="keyword">bool</span> bCanUseCache <span class="comment">/*= true*/</span>)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!ModulePathsCache)</span><br><span class="line">  &#123;</span><br><span class="line">    ModulePathsCache.<span class="built_in">Emplace</span>();</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> bCanUseCacheWhileGeneratingIt = <span class="literal">false</span>;</span><br><span class="line">    <span class="built_in">FindModulePaths</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;*&quot;</span>), ModulePathsCache.<span class="built_in">GetValue</span>(), bCanUseCacheWhileGeneratingIt);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bCanUseCache)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Try to use cache first</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">const</span> FString* ModulePathPtr = ModulePathsCache-&gt;<span class="built_in">Find</span>(NamePattern))</span><br><span class="line">    &#123;</span><br><span class="line">      OutModulePaths.<span class="built_in">Add</span>(<span class="built_in">FName</span>(NamePattern), *ModulePathPtr);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Wildcard for all items</span></span><br><span class="line">    <span class="keyword">if</span> (FCString::<span class="built_in">Strcmp</span>(NamePattern, <span class="built_in">TEXT</span>(<span class="string">&quot;*&quot;</span>)) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      OutModulePaths = ModulePathsCache.<span class="built_in">GetValue</span>();</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Wildcard search</span></span><br><span class="line">    <span class="keyword">if</span> (FCString::<span class="built_in">Strchr</span>(NamePattern, <span class="built_in">TEXT</span>(<span class="string">&#x27;*&#x27;</span>)) || FCString::<span class="built_in">Strchr</span>(NamePattern, <span class="built_in">TEXT</span>(<span class="string">&#x27;?&#x27;</span>)))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">bool</span> bFoundItems = <span class="literal">false</span>;</span><br><span class="line">      <span class="function">FString <span class="title">NamePatternString</span><span class="params">(NamePattern)</span></span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> TPair&lt;FName, FString&gt;&amp; CacheIt : ModulePathsCache.<span class="built_in">GetValue</span>())</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (CacheIt.Key.<span class="built_in">ToString</span>().<span class="built_in">MatchesWildcard</span>(NamePatternString))</span><br><span class="line">        &#123;</span><br><span class="line">          OutModulePaths.<span class="built_in">Add</span>(CacheIt.Key, *CacheIt.Value);</span><br><span class="line">          bFoundItems = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (bFoundItems)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Search through the engine directory</span></span><br><span class="line">  <span class="built_in">FindModulePathsInDirectory</span>(FPlatformProcess::<span class="built_in">GetModulesDirectory</span>(), <span class="literal">false</span>, NamePattern, OutModulePaths);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Search any engine directories</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> Idx = <span class="number">0</span>; Idx &lt; EngineBinariesDirectories.<span class="built_in">Num</span>(); Idx++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">FindModulePathsInDirectory</span>(EngineBinariesDirectories[Idx], <span class="literal">false</span>, NamePattern, OutModulePaths);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Search any game directories</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> Idx = <span class="number">0</span>; Idx &lt; GameBinariesDirectories.<span class="built_in">Num</span>(); Idx++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">FindModulePathsInDirectory</span>(GameBinariesDirectories[Idx], <span class="literal">true</span>, NamePattern, OutModulePaths);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FModuleManager::FindModulePathsInDirectory</span><span class="params">(<span class="keyword">const</span> FString&amp; InDirectoryName, <span class="keyword">bool</span> bIsGameDirectory, <span class="keyword">const</span> TCHAR* NamePattern, TMap&lt;FName, FString&gt; &amp;OutModulePaths)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// Figure out the BuildId if it&#x27;s not already set.</span></span><br><span class="line">  <span class="keyword">if</span> (!BuildId.<span class="built_in">IsSet</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    FString FileName = FModuleManifest::<span class="built_in">GetFileName</span>(FPlatformProcess::<span class="built_in">GetModulesDirectory</span>(), <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    FModuleManifest Manifest;</span><br><span class="line">    <span class="keyword">if</span> (!FModuleManifest::<span class="built_in">TryRead</span>(FileName, Manifest))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">UE_LOG</span>(LogModuleManager, Fatal, <span class="built_in">TEXT</span>(<span class="string">&quot;Unable to read module manifest from &#x27;%s&#x27;. Module manifests are generated at build time, and must be present to locate modules at runtime.&quot;</span>), *FileName)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BuildId = Manifest.BuildId;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Find all the directories to search through, including the base directory</span></span><br><span class="line">  TArray&lt;FString&gt; SearchDirectoryNames;</span><br><span class="line">  IFileManager::<span class="built_in">Get</span>().<span class="built_in">FindFilesRecursive</span>(SearchDirectoryNames, *InDirectoryName, <span class="built_in">TEXT</span>(<span class="string">&quot;*&quot;</span>), <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">  SearchDirectoryNames.<span class="built_in">Insert</span>(InDirectoryName, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Enumerate the modules in each directory</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">const</span> FString&amp; SearchDirectoryName: SearchDirectoryNames)</span><br><span class="line">  &#123;</span><br><span class="line">    FModuleManifest Manifest;</span><br><span class="line">    <span class="keyword">if</span> (FModuleManifest::<span class="built_in">TryRead</span>(FModuleManifest::<span class="built_in">GetFileName</span>(SearchDirectoryName, bIsGameDirectory), Manifest) &amp;&amp; Manifest.BuildId == BuildId.<span class="built_in">GetValue</span>())</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> TPair&lt;FString, FString&gt;&amp; Pair : Manifest.ModuleNameToFileName)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (Pair.Key.<span class="built_in">MatchesWildcard</span>(NamePattern))</span><br><span class="line">        &#123;</span><br><span class="line">          OutModulePaths.<span class="built_in">Add</span>(<span class="built_in">FName</span>(*Pair.Key), *FPaths::<span class="built_in">Combine</span>(*SearchDirectoryName, *Pair.Value));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>得到链接库的路径之后就通过 <code>FPlatformProcess::GetDllExport</code> 来获取 DLL 中的 <code>IModuleInterface::InitializeModule</code> 函数指针，然后调用 <code>IModuleInterface::StartupModule</code> 启动这个模块。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// FModuleManager::LoadModuleWithFailureReason (Runtime\Core\Private\Modules\ModuleManager.cpp)</span></span><br><span class="line"><span class="function">IModuleInterface* <span class="title">FModuleManager::LoadModuleWithFailureReason</span><span class="params">(<span class="keyword">const</span> FName InModuleName, EModuleLoadResult&amp; OutFailureReason)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// something....</span></span><br><span class="line"><span class="comment">// Make sure that any UObjects that need to be registered were already processed before we go and</span></span><br><span class="line"><span class="comment">// load another module.  We just do this so that we can easily tell whether UObjects are present</span></span><br><span class="line"><span class="comment">// in the module being loaded.</span></span><br><span class="line"><span class="keyword">if</span> (bCanProcessNewlyLoadedObjects)</span><br><span class="line">&#123;</span><br><span class="line">  ProcessLoadedObjectsCallback.<span class="built_in">Broadcast</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Try to dynamically load the DLL</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">UE_LOG</span>(LogModuleManager, Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;ModuleManager: Load Module &#x27;%s&#x27; DLL &#x27;%s&#x27;&quot;</span>), *InModuleName.<span class="built_in">ToString</span>(), *ModuleInfo-&gt;Filename);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ModuleInfo-&gt;Filename.<span class="built_in">IsEmpty</span>() || !FPaths::<span class="built_in">FileExists</span>(ModuleInfo-&gt;Filename))</span><br><span class="line">&#123;</span><br><span class="line">  TMap&lt;FName, FString&gt; ModulePathMap;</span><br><span class="line">  <span class="built_in">FindModulePaths</span>(*InModuleName.<span class="built_in">ToString</span>(), ModulePathMap);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ModulePathMap.<span class="built_in">Num</span>() != <span class="number">1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">UE_LOG</span>(LogModuleManager, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;ModuleManager: Unable to load module &#x27;%s&#x27;  - %d instances of that module name found.&quot;</span>), *InModuleName.<span class="built_in">ToString</span>(), ModulePathMap.<span class="built_in">Num</span>());</span><br><span class="line">    OutFailureReason = EModuleLoadResult::FileNotFound;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ModuleInfo-&gt;Filename = <span class="built_in">MoveTemp</span>(TMap&lt;FName, FString&gt;::<span class="built_in">TIterator</span>(ModulePathMap).<span class="built_in">Value</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Determine which file to load for this module.</span></span><br><span class="line"><span class="keyword">const</span> FString ModuleFileToLoad = FPaths::<span class="built_in">ConvertRelativePathToFull</span>(ModuleInfo-&gt;Filename);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Clear the handle and set it again below if the module is successfully loaded</span></span><br><span class="line">ModuleInfo-&gt;Handle = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Skip this check if file manager has not yet been initialized</span></span><br><span class="line"><span class="keyword">if</span> (FPaths::<span class="built_in">FileExists</span>(ModuleFileToLoad))</span><br><span class="line">&#123;</span><br><span class="line">  ModuleInfo-&gt;Handle = FPlatformProcess::<span class="built_in">GetDllHandle</span>(*ModuleFileToLoad);</span><br><span class="line">  <span class="keyword">if</span> (ModuleInfo-&gt;Handle != <span class="literal">nullptr</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// First things first.  If the loaded DLL has UObjects in it, then their generated code&#x27;s</span></span><br><span class="line">    <span class="comment">// static initialization will have run during the DLL loading phase, and we&#x27;ll need to</span></span><br><span class="line">    <span class="comment">// go in and make sure those new UObject classes are properly registered.</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">// Sometimes modules are loaded before even the UObject systems are ready.  We need to assume</span></span><br><span class="line">    <span class="comment">// these modules aren&#x27;t using UObjects.</span></span><br><span class="line">    <span class="keyword">if</span> (bCanProcessNewlyLoadedObjects)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// OK, we&#x27;ve verified that loading the module caused new UObject classes to be</span></span><br><span class="line">      <span class="comment">// registered, so we&#x27;ll treat this module as a module with UObjects in it.</span></span><br><span class="line">      ProcessLoadedObjectsCallback.<span class="built_in">Broadcast</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find our &quot;InitializeModule&quot; global function, which must exist for all module DLLs</span></span><br><span class="line">    FInitializeModuleFunctionPtr InitializeModuleFunctionPtr =</span><br><span class="line">(FInitializeModuleFunctionPtr)FPlatformProcess::<span class="built_in">GetDllExport</span>(ModuleInfo-&gt;Handle, <span class="built_in">TEXT</span>(<span class="string">&quot;InitializeModule&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span> (InitializeModuleFunctionPtr != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (ModuleInfo-&gt;Module.<span class="built_in">IsValid</span>())</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// Assign the already loaded module into the return value, otherwise the return value gives the impression the module failed load!</span></span><br><span class="line">        LoadedModule = ModuleInfo-&gt;Module.<span class="built_in">Get</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// Initialize the module!</span></span><br><span class="line">        ModuleInfo-&gt;Module = TUniquePtr&lt;IModuleInterface&gt;(<span class="built_in">InitializeModuleFunctionPtr</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ModuleInfo-&gt;Module.<span class="built_in">IsValid</span>())</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">// Startup the module</span></span><br><span class="line">          ModuleInfo-&gt;Module-&gt;<span class="built_in">StartupModule</span>();</span><br><span class="line">          <span class="comment">// The module might try to load other dependent modules in StartupModule. In this case, we want those modules shut down AFTER this one because we may still depend on the module at shutdown.</span></span><br><span class="line">          ModuleInfo-&gt;LoadOrder = FModuleInfo::CurrentLoadOrder++;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Module was started successfully!  Fire callbacks.</span></span><br><span class="line">          ModulesChangedEvent.<span class="built_in">Broadcast</span>(InModuleName, EModuleChangeReason::ModuleLoaded);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Set the return parameter</span></span><br><span class="line">          LoadedModule = ModuleInfo-&gt;Module.<span class="built_in">Get</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">UE_LOG</span>(LogModuleManager, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;ModuleManager: Unable to load module &#x27;%s&#x27; because InitializeModule function failed (returned nullptr.)&quot;</span>), *ModuleFileToLoad);</span><br><span class="line"></span><br><span class="line">          FPlatformProcess::<span class="built_in">FreeDllHandle</span>(ModuleInfo-&gt;Handle);</span><br><span class="line">          ModuleInfo-&gt;Handle = <span class="literal">nullptr</span>;</span><br><span class="line">          OutFailureReason = EModuleLoadResult::FailedToInitialize;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">UE_LOG</span>(LogModuleManager, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;ModuleManager: Unable to load module &#x27;%s&#x27; because InitializeModule function was not found.&quot;</span>), *ModuleFileToLoad);</span><br><span class="line"></span><br><span class="line">      FPlatformProcess::<span class="built_in">FreeDllHandle</span>(ModuleInfo-&gt;Handle);</span><br><span class="line">      ModuleInfo-&gt;Handle = <span class="literal">nullptr</span>;</span><br><span class="line">      OutFailureReason = EModuleLoadResult::FailedToInitialize;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">UE_LOG</span>(LogModuleManager, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;ModuleManager: Unable to load module &#x27;%s&#x27; because the file couldn&#x27;t be loaded by the OS.&quot;</span>), *ModuleFileToLoad);</span><br><span class="line">    OutFailureReason = EModuleLoadResult::CouldNotBeLoadedByOS;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">UE_LOG</span>(LogModuleManager, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;ModuleManager: Unable to load module &#x27;%s&#x27; because the file &#x27;%s&#x27; was not found.&quot;</span>), *InModuleName.<span class="built_in">ToString</span>(), *ModuleFileToLoad);</span><br><span class="line">  OutFailureReason = EModuleLoadResult::FileNotFound;</span><br><span class="line">&#125;</span><br><span class="line">  <span class="comment">// something....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="IModuleInterface"><a href="#IModuleInterface" class="headerlink" title="IModuleInterface"></a>IModuleInterface</h2><p>不论是通过 <code>IS_MONOLITHIC</code> 还是 <code>!IS_MONOLITHIC</code> 的方式，最终得到的都是 Module 的 <strong>IModuleInterface</strong>(<em>Runtime\Core\Public\Modules\ModuleInterface.h</em>) 接口，它里面声明了通用的 Module 接口：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IModuleInterface</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// Note: Even though this is an interface class we need a virtual destructor here because modules are deleted via a pointer to this interface</span></span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">IModuleInterface</span>()&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Called right after the module DLL has been loaded and the module object has been created</span></span><br><span class="line">  <span class="comment">// Load dependent modules here, and they will be guaranteed to be available during ShutdownModule. ie:</span></span><br><span class="line">  <span class="comment">// FModuleManager::Get().LoadModuleChecked(TEXT(&quot;HTTP&quot;));</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">StartupModule</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Called before the module has been unloaded</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PreUnloadCallback</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Called after the module has been reloaded</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PostLoadCallback</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Called before the module is unloaded, right before the module object is destroyed.</span></span><br><span class="line">  <span class="comment">// During normal shutdown, this is called in reverse order that modules finish StartupModule().</span></span><br><span class="line">  <span class="comment">// This means that, as long as a module references dependent modules in it&#x27;s StartupModule(), it</span></span><br><span class="line">  <span class="comment">// can safely reference those dependencies in ShutdownModule() as well.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ShutdownModule</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Override this to set whether your module is allowed to be unloaded on the fly</span></span><br><span class="line">  <span class="comment">// @return  Whether the module supports shutdown separate from the rest of the engine.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">SupportsDynamicReloading</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="literal">true</span>;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Override this to set whether your module would like cleanup on application shutdown</span></span><br><span class="line">  <span class="comment">// @return  Whether the module supports shutdown on application exit</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">SupportsAutomaticShutdown</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="literal">true</span>;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Returns true if this module hosts gameplay code</span></span><br><span class="line">  <span class="comment">// @return True for &quot;gameplay modules&quot;, or false for engine code modules, plugins, etc.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">IsGameModule</span><span class="params">()</span> <span class="keyword">const</span></span>&#123;<span class="keyword">return</span> <span class="literal">false</span>;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Load-Modules-when-the-Engine-Launch"><a href="#Load-Modules-when-the-Engine-Launch" class="headerlink" title="Load Modules when the Engine Launch"></a>Load Modules when the Engine Launch</h2><p>前面提到，UE 是模块化的架构，引擎的实现就是靠各个模块组合驱动的，所以在引擎启动的时候会启动各种相应的模块。<br>引擎的启动入口是在 <a href="http://api.unrealengine.com/INT/API/Runtime/Launch/index.html">Launch</a> 模块中，由各个平台的 <code>main</code> 函数转发到 <code>GuardedMain</code>(Engine\Source\Runtime\Launch\Private\Launch.cpp) 中。<br>在 <code>GuardedMain</code> 中依次执行 <code>GEngineLoop.PreInit(CmdLine)</code> 和<code>GEngineLoop.Init()</code></p>
<p>在 <code>FEngingLoop::PreInit</code> 中，通过依次调用 <code>FEngineLoop::LoadCoreModules</code>(<a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/Launch/Private/LaunchEngineLoop.cpp#L1480">LaunchEngineLoop.cpp#L1480</a>) 和<code>FEngineLoop::LoadPreInitModules</code>(<a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/Launch/Private/LaunchEngineLoop.cpp#L1572">LaunchEngineLoop.cpp#L1572</a>)来加载引擎启动所必须的模块，模块的加载顺序如下：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// LaunchEngineLoop.cpp</span></span><br><span class="line">FEngineLoop::<span class="built_in">PreInit</span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="comment">// L1480</span></span><br><span class="line">	<span class="comment">// Load Core modules required for everything else to work (needs to be loaded before InitializeRenderingCVarsCaching)</span></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">LoadCoreModules</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">UE_LOG</span>(LogInit, Error, <span class="built_in">TEXT</span>(<span class="string">&quot;Failed to load Core modules.&quot;</span>));</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// L1572</span></span><br><span class="line">	<span class="built_in">LoadPreInitModules</span>();</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// L2015</span></span><br><span class="line">  <span class="comment">// note: Since 4.20 add ELoadingPhase::PreEarlyLoadingScreen Support.</span></span><br><span class="line">	<span class="comment">// Load up all modules that need to hook into the loading screen</span></span><br><span class="line">	<span class="keyword">if</span> (!IProjectManager::<span class="built_in">Get</span>().<span class="built_in">LoadModulesForProject</span>(ELoadingPhase::PreEarlyLoadingScreen) || !IPluginManager::<span class="built_in">Get</span>().<span class="built_in">LoadModulesForEnabledPlugins</span>(ELoadingPhase::PreEarlyLoadingScreen))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// L2202</span></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">LoadStartupCoreModules</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// At least one startup module failed to load, return 1 to indicate an error</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// L2211</span></span><br><span class="line">  <span class="comment">// Load up all modules that need to hook into the loading screen</span></span><br><span class="line">  <span class="keyword">if</span> (!IProjectManager::<span class="built_in">Get</span>().<span class="built_in">LoadModulesForProject</span>(ELoadingPhase::PreLoadingScreen) || !IPluginManager::<span class="built_in">Get</span>().<span class="built_in">LoadModulesForEnabledPlugins</span>(ELoadingPhase::PreLoadingScreen))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// L2310</span></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">LoadStartupModules</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// At least one startup module failed to load, return 1 to indicate an error</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// L2457</span></span><br><span class="line">  <span class="comment">// Load all the post-engine init modules</span></span><br><span class="line">  <span class="built_in">ensure</span>(IProjectManager::<span class="built_in">Get</span>().<span class="built_in">LoadModulesForProject</span>(ELoadingPhase::PostEngineInit));</span><br><span class="line">  <span class="built_in">ensure</span>(IPluginManager::<span class="built_in">Get</span>().<span class="built_in">LoadModulesForEnabledPlugins</span>(ELoadingPhase::PostEngineInit));</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// L3044</span></span><br><span class="line">  <span class="comment">// Load all the post-engine init modules</span></span><br><span class="line">  <span class="keyword">if</span> (!IProjectManager::<span class="built_in">Get</span>().<span class="built_in">LoadModulesForProject</span>(ELoadingPhase::PostEngineInit) || !IPluginManager::<span class="built_in">Get</span>().<span class="built_in">LoadModulesForEnabledPlugins</span>(ELoadingPhase::PostEngineInit))</span><br><span class="line">  &#123;</span><br><span class="line">    GIsRequestingExit = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// L4279</span></span><br><span class="line">  <span class="comment">// Load &quot;pre-init&quot; plugin modules</span></span><br><span class="line">  <span class="keyword">if</span> (!ProjectManager.<span class="built_in">LoadModulesForProject</span>(ELoadingPhase::PostConfigInit) || !PluginManager.<span class="built_in">LoadModulesForEnabledPlugins</span>(ELoadingPhase::PostConfigInit))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EnginePreInit 时加载 Module 的几个函数实现：</p>
<h3 id="FEngineLoop-LoadCoreModules"><a href="#FEngineLoop-LoadCoreModules" class="headerlink" title="FEngineLoop::LoadCoreModules"></a>FEngineLoop::LoadCoreModules</h3><ul>
<li><a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/Launch/Private/LaunchEngineLoop.cpp#L2679">FEngineLoop::LoadCoreModules</a></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// LaunchEngineLoop.cpp#L2679</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FEngineLoop::LoadCoreModules</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// Always attempt to load CoreUObject. It requires additional pre-init which is called from its module&#x27;s StartupModule method.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_COREUOBJECT</span></span><br><span class="line">  <span class="keyword">return</span> FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;CoreUObject&quot;</span>)) != <span class="literal">nullptr</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="FEngineLoop-LoadPreInitModules"><a href="#FEngineLoop-LoadPreInitModules" class="headerlink" title="FEngineLoop::LoadPreInitModules"></a>FEngineLoop::LoadPreInitModules</h3><ul>
<li><a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/Launch/Private/LaunchEngineLoop.cpp#L2690">FEngineLoop::LoadPreInitModules</a></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// LaunchEngineLoop.cpp#L2690</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FEngineLoop::LoadPreInitModules</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">DECLARE_SCOPE_CYCLE_COUNTER</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Loading PreInit Modules&quot;</span>), STAT_PreInitModules, STATGROUP_LoadTime);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// GGetMapNameDelegate is initialized here</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_ENGINE</span></span><br><span class="line">  FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Engine&quot;</span>));</span><br><span class="line"></span><br><span class="line">  FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Renderer&quot;</span>));</span><br><span class="line"></span><br><span class="line">  FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AnimGraphRuntime&quot;</span>));</span><br><span class="line"></span><br><span class="line">  FPlatformApplicationMisc::<span class="built_in">LoadPreInitModules</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !UE_SERVER</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">IsRunningDedicatedServer</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (!GUsingNullRHI)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// This needs to be loaded before InitializeShaderTypes is called</span></span><br><span class="line">      FModuleManager::<span class="built_in">Get</span>().LoadModuleChecked&lt;ISlateRHIRendererModule&gt;(<span class="string">&quot;SlateRHIRenderer&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Landscape&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize ShaderCore before loading or compiling any shaders,</span></span><br><span class="line">  <span class="comment">// But after Renderer and any other modules which implement shader types.</span></span><br><span class="line">  FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ShaderCore&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITORONLY_DATA</span></span><br><span class="line">  <span class="comment">// Load the texture compressor module before any textures load. They may</span></span><br><span class="line">  <span class="comment">// compress asynchronously and that can lead to a race condition.</span></span><br><span class="line">  FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;TextureCompressor&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// WITH_ENGINE</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (WITH_EDITOR &amp;&amp; !(UE_BUILD_SHIPPING || UE_BUILD_TEST))</span></span><br><span class="line">  <span class="comment">// Load audio editor module before engine class CDOs are loaded</span></span><br><span class="line">  FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AudioEditor&quot;</span>));</span><br><span class="line">  FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AnimationModifiers&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="FPlatformApplicationMisc-LoadPreInitModules"><a href="#FPlatformApplicationMisc-LoadPreInitModules" class="headerlink" title="FPlatformApplicationMisc::LoadPreInitModules"></a>FPlatformApplicationMisc::LoadPreInitModules</h4><ul>
<li><a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/ApplicationCore/Private/Windows/WindowsPlatformApplicationMisc.cpp#L22">FPlatformApplicationMisc::LoadPreInitModules</a></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// FPlatformApplicationMisc::LoadPreInitModules</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FWindowsPlatformApplicationMisc::LoadPreInitModules</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// D3D11 is not supported on WinXP, so in this case we use the OpenGL RHI</span></span><br><span class="line">  <span class="keyword">if</span>(FWindowsPlatformMisc::<span class="built_in">VerifyWindowsVersion</span>(<span class="number">6</span>, <span class="number">0</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">//#todo-rco: Only try on Win10</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> bForceD3D12 = FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;d3d12&quot;</span>)) || FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;dx12&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span> (bForceD3D12)</span><br><span class="line">    &#123;</span><br><span class="line">      FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;D3D12RHI&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;D3D11RHI&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;OpenGLDrv&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="FEngineLoop-LoadStartupCoreModules"><a href="#FEngineLoop-LoadStartupCoreModules" class="headerlink" title="FEngineLoop::LoadStartupCoreModules"></a>FEngineLoop::LoadStartupCoreModules</h3><ul>
<li><a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/Launch/Private/LaunchEngineLoop.cpp#L2739">FEngineLoop::LoadStartupCoreModules</a></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// LaunchEngineLoop.cpp#L2739</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FEngineLoop::LoadStartupCoreModules</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="function">FScopedSlowTask <span class="title">SlowTask</span><span class="params">(<span class="number">100</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">DECLARE_SCOPE_CYCLE_COUNTER</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Loading Startup Modules&quot;</span>), STAT_StartupModules, STATGROUP_LoadTime);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">bool</span> bSuccess = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Load all Runtime modules</span></span><br><span class="line">  SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">10</span>);</span><br><span class="line">  &#123;</span><br><span class="line">    FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Core&quot;</span>));</span><br><span class="line">    FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Networking&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">10</span>);</span><br><span class="line">  FPlatformApplicationMisc::<span class="built_in">LoadStartupModules</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// initialize messaging</span></span><br><span class="line">  SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">10</span>);</span><br><span class="line">  <span class="keyword">if</span> (FPlatformProcess::<span class="built_in">SupportsMultithreading</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    FModuleManager::LoadModuleChecked&lt;IMessagingModule&gt;(<span class="string">&quot;Messaging&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Init Scene Reconstruction support</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !UE_SERVER</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">IsRunningDedicatedServer</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    FModuleManager::LoadModuleChecked&lt;IMRMeshModule&gt;(<span class="string">&quot;MRMesh&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">10</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">    FModuleManager::LoadModuleChecked&lt;IEditorStyleModule&gt;(<span class="string">&quot;EditorStyle&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">//WITH_EDITOR</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Load UI modules</span></span><br><span class="line">  SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">10</span>);</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">IsRunningDedicatedServer</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="string">&quot;Slate&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !UE_BUILD_SHIPPING</span></span><br><span class="line">    <span class="comment">// Need to load up the SlateReflector module to initialize the WidgetSnapshotService</span></span><br><span class="line">    FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="string">&quot;SlateReflector&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// !UE_BUILD_SHIPPING</span></span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">  <span class="comment">// In dedicated server builds with the editor, we need to load UMG/UMGEditor for compiling blueprints.</span></span><br><span class="line">  <span class="comment">// UMG must be loaded for runtime and cooking.</span></span><br><span class="line">  FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="string">&quot;UMG&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">IsRunningDedicatedServer</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// UMG must be loaded for runtime and cooking.</span></span><br><span class="line">    FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="string">&quot;UMG&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">//WITH_EDITOR</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Load all Development modules</span></span><br><span class="line">  SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">20</span>);</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">IsRunningDedicatedServer</span>())</span><br><span class="line">  &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_UNREAL_DEVELOPER_TOOLS</span></span><br><span class="line">    FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="string">&quot;MessageLog&quot;</span>);</span><br><span class="line">    FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="string">&quot;CollisionAnalyzer&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">//WITH_UNREAL_DEVELOPER_TOOLS</span></span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_UNREAL_DEVELOPER_TOOLS</span></span><br><span class="line">    FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="string">&quot;FunctionalTesting&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">//WITH_UNREAL_DEVELOPER_TOOLS</span></span></span><br><span class="line"></span><br><span class="line">  SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">30</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (WITH_EDITOR &amp;&amp; !(UE_BUILD_SHIPPING || UE_BUILD_TEST))</span></span><br><span class="line">  <span class="comment">// <span class="doctag">HACK:</span> load BT editor as early as possible for statically initialized assets (non cooked BT assets needs it)</span></span><br><span class="line">  <span class="comment">// cooking needs this module too</span></span><br><span class="line">  FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;BehaviorTreeEditor&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Ability tasks are based on GameplayTasks, so we need to make sure that module is loaded as well</span></span><br><span class="line">  FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;GameplayTasksEditor&quot;</span>));</span><br><span class="line"></span><br><span class="line">  IAudioEditorModule* AudioEditorModule = &amp;FModuleManager::LoadModuleChecked&lt;IAudioEditorModule&gt;(<span class="string">&quot;AudioEditor&quot;</span>);</span><br><span class="line">  AudioEditorModule-&gt;<span class="built_in">RegisterAssetActions</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Load the StringTableEditor module to register its asset actions</span></span><br><span class="line">  FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="string">&quot;StringTableEditor&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!<span class="built_in">IsRunningDedicatedServer</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// VREditor needs to be loaded in non-server editor builds early, so engine content Blueprints can be loaded during DDC generation</span></span><br><span class="line">    FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;VREditor&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// -----------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">HACK:</span> load EQS editor as early as possible for statically initialized assets (non cooked EQS assets needs it)</span></span><br><span class="line">  <span class="comment">// cooking needs this module too</span></span><br><span class="line">  <span class="keyword">bool</span> bEnvironmentQueryEditor = <span class="literal">false</span>;</span><br><span class="line">  GConfig-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;EnvironmentQueryEd&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;EnableEnvironmentQueryEd&quot;</span>), bEnvironmentQueryEditor, GEngineIni);</span><br><span class="line">  <span class="keyword">if</span> (bEnvironmentQueryEditor</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">    || GetDefault&lt;UEditorExperimentalSettings&gt;()-&gt;bEQSEditor</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// WITH_EDITOR</span></span></span><br><span class="line">    )</span><br><span class="line">  &#123;</span><br><span class="line">    FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;EnvironmentQueryEditor&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We need this for blueprint projects that have online functionality.</span></span><br><span class="line">  <span class="comment">//FModuleManager::Get().LoadModule(TEXT(&quot;OnlineBlueprintSupport&quot;));</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">IsRunningCommandlet</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;IntroTutorials&quot;</span>));</span><br><span class="line">    FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Blutility&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">//(WITH_EDITOR &amp;&amp; !(UE_BUILD_SHIPPING || UE_BUILD_TEST))</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_ENGINE</span></span><br><span class="line">  <span class="comment">// Load runtime client modules (which are also needed at cook-time)</span></span><br><span class="line">  <span class="keyword">if</span>(!<span class="built_in">IsRunningDedicatedServer</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Overlay&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;MediaAssets&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ClothingSystemRuntime&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">  FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ClothingSystemEditor&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;PacketHandler&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> bSuccess;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="FPlatformApplicationMisc-LoadStartupModules"><a href="#FPlatformApplicationMisc-LoadStartupModules" class="headerlink" title="FPlatformApplicationMisc::LoadStartupModules"></a>FPlatformApplicationMisc::LoadStartupModules</h4><ul>
<li><a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/ApplicationCore/Private/Windows/WindowsPlatformApplicationMisc.cpp#L38">FPlatformApplicationMisc::LoadStartupModules</a></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// FPlatformApplicationMisc::LoadStartupModules</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FWindowsPlatformApplicationMisc::LoadStartupModules</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !UE_SERVER</span></span><br><span class="line">  FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;XAudio2&quot;</span>));</span><br><span class="line">  FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;HeadMountedDisplay&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// !UE_SERVER</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">  FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;SourceCodeAccess&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">//WITH_EDITOR</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="FEngineLoop-LoadStartupModules"><a href="#FEngineLoop-LoadStartupModules" class="headerlink" title="FEngineLoop::LoadStartupModules"></a>FEngineLoop::LoadStartupModules</h3><ul>
<li><a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/Launch/Private/LaunchEngineLoop.cpp#L2884">FEngineLoop::LoadStartupModules</a></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// LaunchEngineLoop.cpp#L2884</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FEngineLoop::LoadStartupModules</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="function">FScopedSlowTask <span class="title">SlowTask</span><span class="params">(<span class="number">3</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">  SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="comment">// Load any modules that want to be loaded before default modules are loaded up.</span></span><br><span class="line">  <span class="keyword">if</span> (!IProjectManager::<span class="built_in">Get</span>().<span class="built_in">LoadModulesForProject</span>(ELoadingPhase::PreDefault) || !IPluginManager::<span class="built_in">Get</span>().<span class="built_in">LoadModulesForEnabledPlugins</span>(ELoadingPhase::PreDefault))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="comment">// Load modules that are configured to load in the default phase</span></span><br><span class="line">  <span class="keyword">if</span> (!IProjectManager::<span class="built_in">Get</span>().<span class="built_in">LoadModulesForProject</span>(ELoadingPhase::Default) || !IPluginManager::<span class="built_in">Get</span>().<span class="built_in">LoadModulesForEnabledPlugins</span>(ELoadingPhase::Default))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="comment">// Load any modules that want to be loaded after default modules are loaded up.</span></span><br><span class="line">  <span class="keyword">if</span> (!IProjectManager::<span class="built_in">Get</span>().<span class="built_in">LoadModulesForProject</span>(ELoadingPhase::PostDefault) || !IPluginManager::<span class="built_in">Get</span>().<span class="built_in">LoadModulesForEnabledPlugins</span>(ELoadingPhase::PostDefault))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以从上面的代码看到引擎 <code>PreInit</code> 启动的模块，以及启动的插件的模块(根据插件的 LoadingPhase 来决定启动时机)。</p>
<h2 id="Load-Plugin-Modules"><a href="#Load-Plugin-Modules" class="headerlink" title="Load Plugin Modules"></a>Load Plugin Modules</h2><p>在上文中整理的代码中可以看到，项目的插件 Module 也是在 <code>FEngineLoop::PreInit</code> 中加载的。<br>写过 UE 的插件的都知道，UE 的插件配置 (<strong>.uplugin</strong>) 里面有两个选项：<code>Type</code>和<code>LoadingPhase</code>:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;FileVersion&quot;</span>: <span class="number">3</span>,</span><br><span class="line">  <span class="string">&quot;Version&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="string">&quot;VersionName&quot;</span>: <span class="string">&quot;1.0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;FriendlyName&quot;</span>: <span class="string">&quot;TaskTools&quot;</span>,</span><br><span class="line">  <span class="string">&quot;Description&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;Category&quot;</span>: <span class="string">&quot;Other&quot;</span>,</span><br><span class="line">  <span class="string">&quot;CreatedBy&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;CreatedByURL&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;DocsURL&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;MarketplaceURL&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;SupportURL&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;CanContainContent&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;IsBetaVersion&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;Installed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;Modules&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;TaskTools&quot;</span>,</span><br><span class="line">      <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;Runtime&quot;</span>,</span><br><span class="line">      <span class="string">&quot;LoadingPhase&quot;</span>: <span class="string">&quot;Default&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中的 Modules 下的 <code>Type</code> 和<code>LoadingPhase</code>决定了引擎启动时该 Plugin 下的 Module 是否加载以及加载的时机。<br>Type 是必要参数，LadingPhase 是可选参数，默认是 Default.</p>
<ul>
<li>Type：决定了在不同运行环境的项目是否加载 Module</li>
<li>LoadingPhase：决定了该 Module 的加载时机</li>
</ul>
<h3 id="Plugin-Type-Required"><a href="#Plugin-Type-Required" class="headerlink" title="Plugin:Type(Required)"></a>Plugin:Type(Required)</h3><blockquote>
<p>Sets the type of Module. Valid options are <code>Runtime</code>, <code>RuntimeNoCommandlet</code>, <code>Developer</code>, <code>Editor</code>, <code>EditorNoCommandlet</code>, and <code>Program</code>. This type determines which types of applications this Plugin’s Module is suitable for loading in. For example, some plugins may include modules that are only designed to be loaded when the editor is running. Runtime modules will be loaded in all cases, even in shipped games. Developer modules will only be loaded in development runtime or editor builds, but never in shipping builds. Editor modules will only be loaded when the editor is starting up. Your Plugin can use a combination of modules of different types.</p>
</blockquote>
<p>Type 可选的项如下 (在<code>FModuleDescriptor::Read</code> 从 json 中读入)：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> EHostType</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">enum</span> <span class="title">Type</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="comment">// Any target using the UE4 runtime</span></span><br><span class="line">    Runtime,</span><br><span class="line">    <span class="comment">// Any target except for commandlet</span></span><br><span class="line">    RuntimeNoCommandlet,</span><br><span class="line">    <span class="comment">// Any target or program</span></span><br><span class="line">    RuntimeAndProgram,</span><br><span class="line">    <span class="comment">// Loaded only in cooked builds</span></span><br><span class="line">    CookedOnly,</span><br><span class="line">    <span class="comment">// Loaded only when the engine has support for developer tools enabled</span></span><br><span class="line">    Developer,</span><br><span class="line">    <span class="comment">// Loaded only by the editor</span></span><br><span class="line">    Editor,</span><br><span class="line">    <span class="comment">// Loaded only by the editor, except when running commandlets</span></span><br><span class="line">    EditorNoCommandlet,</span><br><span class="line">    <span class="comment">// Loaded only by programs</span></span><br><span class="line">    Program,</span><br><span class="line">    <span class="comment">// Loaded only by servers</span></span><br><span class="line">    ServerOnly,</span><br><span class="line">    <span class="comment">// Loaded only by clients</span></span><br><span class="line">    ClientOnly,</span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> If you add a new value, make sure to update the ToString() method below!</span></span><br><span class="line"></span><br><span class="line">    Max</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Plugin-LoadingPhase-Optional"><a href="#Plugin-LoadingPhase-Optional" class="headerlink" title="Plugin:LoadingPhase(Optional)"></a>Plugin:LoadingPhase(Optional)</h3><p><code>.uplugin</code> Module LoadingPhase Descriptors.</p>
<blockquote>
<p>If specified, controls when the plugin is loaded at start-up. This is an advanced option that should not normally be required. The valid options are <code>Default</code>(which is used when no LoadingPhase is specified), <code>PreDefault</code>, and <code>PostConfigInit</code>. <code>PostConfigInit</code> enables the module to be loaded before the engine has finished starting up key subsystems. <code>PreDefault</code> loads just before the normal phase. Typically, this is only needed if you expect game modules to depend directly on content within your plugin, or types declared within the plugin’s code.</p>
</blockquote>
<p>如果 <code>.upugin</code> 中没有指定 <code>LoadingPhase</code> 项，则默认是<code>Default</code>，LoadingPhase 的可选项如下:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> ELoadingPhase</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">enum</span> <span class="title">Type</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="comment">/** Loaded before the engine is fully initialized, immediately after the config system has been initialized.  Necessary only for very low-level hooks */</span></span><br><span class="line">    PostConfigInit,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Loaded before the engine is fully initialized for modules that need to hook into the loading screen before it triggers */</span></span><br><span class="line">    PreLoadingScreen,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Right before the default phase */</span></span><br><span class="line">    PreDefault,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Loaded at the default loading point during startup (during engine init, after game modules are loaded.) */</span></span><br><span class="line">    Default,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Right after the default phase */</span></span><br><span class="line">    PostDefault,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** After the engine has been initialized */</span></span><br><span class="line">    PostEngineInit,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Do not automatically load this module */</span></span><br><span class="line">    None,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> If you add a new value, make sure to update the ToString() method below!</span></span><br><span class="line">    Max</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="FProjectManager-LoadModulesForProject"><a href="#FProjectManager-LoadModulesForProject" class="headerlink" title="FProjectManager::LoadModulesForProject"></a>FProjectManager::LoadModulesForProject</h3><p><code>FEngineLoop::PreInit</code>中通过对 <code>IProjectManager::Get().LoadModulesForProject</code> 的调用来加载指定 LoadingPhase 的插件 Module：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime\Project\Private\ModuleDescriptor.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FProjectManager::LoadModulesForProject</span><span class="params">(<span class="keyword">const</span> ELoadingPhase::Type LoadingPhase )</span></span></span><br></pre></td></tr></table></figure>
<p>它里面将 Module 的加载转发到了 FModuleDescriptor::LoadModulesForPhase，并对调用的结果做了错误检测(平常见到的插件的编译失败就是在这一步提示的)：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FProjectManager::LoadModulesForProject</span><span class="params">(<span class="keyword">const</span> ELoadingPhase::Type LoadingPhase )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">DECLARE_SCOPE_CYCLE_COUNTER</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Loading Game Modules&quot;</span>), STAT_GameModule, STATGROUP_LoadTime);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">bool</span> bSuccess = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (CurrentProject.<span class="built_in">IsValid</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    TMap&lt;FName, EModuleLoadResult&gt; ModuleLoadFailures;</span><br><span class="line">    FModuleDescriptor::<span class="built_in">LoadModulesForPhase</span>(LoadingPhase, CurrentProject-&gt;Modules, ModuleLoadFailures);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ModuleLoadFailures.<span class="built_in">Num</span>() &gt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      FText FailureMessage;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">auto</span> FailureIt = ModuleLoadFailures.<span class="built_in">CreateConstIterator</span>(); FailureIt; ++FailureIt)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">const</span> EModuleLoadResult FailureReason = FailureIt.<span class="built_in">Value</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(FailureReason != EModuleLoadResult::Success)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">const</span> FText TextModuleName = FText::<span class="built_in">FromName</span>(FailureIt.<span class="built_in">Key</span>());</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (FailureReason == EModuleLoadResult::FileNotFound)</span><br><span class="line">          &#123;</span><br><span class="line">            FailureMessage = FText::<span class="built_in">Format</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;PrimaryGameModuleNotFound&quot;</span>, <span class="string">&quot;The game module &#x27;&#123;0&#125;&#x27; could not be found. Please ensure that this module exists and that it is compiled.&quot;</span>), TextModuleName );</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (FailureReason == EModuleLoadResult::FileIncompatible)</span><br><span class="line">          &#123;</span><br><span class="line">            FailureMessage = FText::<span class="built_in">Format</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;PrimaryGameModuleIncompatible&quot;</span>, <span class="string">&quot;The game module &#x27;&#123;0&#125;&#x27; does not appear to be up to date. This may happen after updating the engine. Please recompile this module and try again.&quot;</span>), TextModuleName );</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (FailureReason == EModuleLoadResult::FailedToInitialize)</span><br><span class="line">          &#123;</span><br><span class="line">            FailureMessage = FText::<span class="built_in">Format</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;PrimaryGameModuleFailedToInitialize&quot;</span>, <span class="string">&quot;The game module &#x27;&#123;0&#125;&#x27; could not be successfully initialized after it was loaded.&quot;</span>), TextModuleName );</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (FailureReason == EModuleLoadResult::CouldNotBeLoadedByOS)</span><br><span class="line">          &#123;</span><br><span class="line">            FailureMessage = FText::<span class="built_in">Format</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;PrimaryGameModuleCouldntBeLoaded&quot;</span>, <span class="string">&quot;The game module &#x27;&#123;0&#125;&#x27; could not be loaded. There may be an operating system error or the module may not be properly set up.&quot;</span>), TextModuleName );</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> </span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">ensure</span>(<span class="number">0</span>);  <span class="comment">// If this goes off, the error handling code should be updated for the new enum values!</span></span><br><span class="line">            FailureMessage = FText::<span class="built_in">Format</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;PrimaryGameModuleGenericLoadFailure&quot;</span>, <span class="string">&quot;The game module &#x27;&#123;0&#125;&#x27; failed to load for an unspecified reason.  Please report this error.&quot;</span>), TextModuleName );</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Just report the first error</span></span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      FMessageDialog::<span class="built_in">Open</span>(EAppMsgType::Ok, FailureMessage);</span><br><span class="line">      bSuccess = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> bSuccess;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="FModuleDescriptor-LoadModulesForPhase"><a href="#FModuleDescriptor-LoadModulesForPhase" class="headerlink" title="FModuleDescriptor::LoadModulesForPhase"></a>FModuleDescriptor::LoadModulesForPhase</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime\Project\Private\ModuleDescriptor.cpp</span></span><br><span class="line"><span class="comment">// LoadingPhase - is want load Module LoadingPhase Descriptor</span></span><br><span class="line"><span class="comment">// Modules - is current project all modoules(CurrentProject-&gt;Modules)</span></span><br><span class="line"><span class="comment">// ModuleLoadErrors - is module-moduleLoadError mapping</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FModuleDescriptor::LoadModulesForPhase</span><span class="params">(ELoadingPhase::Type LoadingPhase, <span class="keyword">const</span> TArray&lt;FModuleDescriptor&gt;&amp; Modules, TMap&lt;FName, EModuleLoadResult&gt;&amp; ModuleLoadErrors)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="function">FScopedSlowTask <span class="title">SlowTask</span><span class="params">(Modules.Num())</span></span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> Idx = <span class="number">0</span>; Idx &lt; Modules.<span class="built_in">Num</span>(); Idx++)</span><br><span class="line">  &#123;</span><br><span class="line">    SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">const</span> FModuleDescriptor&amp; Descriptor = Modules[Idx];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Don&#x27;t need to do anything if this module is already loaded</span></span><br><span class="line">    <span class="keyword">if</span> (!FModuleManager::<span class="built_in">Get</span>().<span class="built_in">IsModuleLoaded</span>(Descriptor.Name))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (LoadingPhase == Descriptor.LoadingPhase &amp;&amp; Descriptor.<span class="built_in">IsLoadedInCurrentConfiguration</span>())</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// @todo plugin: DLL search problems.  Plugins that statically depend on other modules within this plugin may not be found?  Need to test this.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> Loading this module may cause other modules to become loaded, both in the engine or game, or other modules </span></span><br><span class="line">        <span class="comment">//       that are part of this project or plugin.  That&#x27;s totally fine.</span></span><br><span class="line">        EModuleLoadResult FailureReason;</span><br><span class="line">        IModuleInterface* ModuleInterface = FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModuleWithFailureReason</span>(Descriptor.Name, FailureReason);</span><br><span class="line">        <span class="keyword">if</span> (ModuleInterface == <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">// The module failed to load. Note this in the ModuleLoadErrors list.</span></span><br><span class="line">          ModuleLoadErrors.<span class="built_in">Add</span>(Descriptor.Name, FailureReason);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该函数的实现就是对当前项目的所有模块进行一次遍历，当遍历 Module 的 <code>LoadingPhase</code> 匹配传入的 <code>LoadingPhase</code> 参数以及该 Module 的 <code>Type</code> 符合当前的运行环境 (通过<strong>FModuleDescriptor::IsLoadedInCurrentConfiguration</strong> 来判断)，则加载 Module.</p>
<h3 id="FModuleDescriptor-IsLoadedInCurrentConfiguration"><a href="#FModuleDescriptor-IsLoadedInCurrentConfiguration" class="headerlink" title="FModuleDescriptor::IsLoadedInCurrentConfiguration"></a>FModuleDescriptor::IsLoadedInCurrentConfiguration</h3><p><code>FModuleDescriptor::IsLoadedInCurrentConfiguration</code>的作用就是根据当前的模块的 <code>Type</code> 判断与当前的运行环境是否相匹配，从而返回 bool 决定是否加载 Module。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FModuleDescriptor::IsLoadedInCurrentConfiguration</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// Check that the module is built for this configuration</span></span><br><span class="line">  <span class="keyword">if</span>(!<span class="built_in">IsCompiledInCurrentConfiguration</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check that the runtime environment allows it to be loaded</span></span><br><span class="line">  <span class="built_in"><span class="keyword">switch</span></span> (Type)</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">case</span> EHostType::RuntimeAndProgram:</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> (WITH_ENGINE || WITH_PLUGIN_SUPPORT)</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> EHostType::Runtime:</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> (WITH_ENGINE || WITH_PLUGIN_SUPPORT) &amp;&amp; !IS_PROGRAM</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">case</span> EHostType::RuntimeNoCommandlet:</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> (WITH_ENGINE || WITH_PLUGIN_SUPPORT)  &amp;&amp; !IS_PROGRAM</span></span><br><span class="line">      <span class="keyword">if</span>(!<span class="built_in">IsRunningCommandlet</span>()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> EHostType::CookedOnly:</span><br><span class="line">    <span class="keyword">return</span> FPlatformProperties::<span class="built_in">RequiresCookedData</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> EHostType::Developer:</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> WITH_UNREAL_DEVELOPER_TOOLS</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> EHostType::Editor:</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">      <span class="keyword">if</span>(GIsEditor) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> EHostType::EditorNoCommandlet:</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">      <span class="keyword">if</span>(GIsEditor &amp;&amp; !<span class="built_in">IsRunningCommandlet</span>()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> EHostType::Program:</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> WITH_PLUGIN_SUPPORT &amp;&amp; IS_PROGRAM</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> EHostType::ServerOnly:</span><br><span class="line">    <span class="keyword">return</span> !FPlatformProperties::<span class="built_in">IsClientOnly</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> EHostType::ClientOnly:</span><br><span class="line">    <span class="keyword">return</span> !<span class="built_in">IsRunningDedicatedServer</span>();</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此，引擎启动时加载的引擎 Module 和项目的插件 Module 都启动完毕了。</p>
<h2 id="ChangeLog"><a href="#ChangeLog" class="headerlink" title="ChangeLog"></a>ChangeLog</h2><ul>
<li><strong>2019-03-20 16:24:32</strong> 增加引擎启动时加载模块的内容</li>
<li><strong>2019-03-21 12:41:52</strong> 增加插件 Module 启动的内容</li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
      </categories>
      <tags>
        <tag>Module</tag>
        <tag>Engine</tag>
      </tags>
  </entry>
  <entry>
    <title>UObject 的 FObjectInitializer 构造函数的调用</title>
    <url>/wiki/34882/</url>
    <content><![CDATA[<blockquote>
<p>注意：只有 GENERATED_UCLASS_BODY 才可以实现 <code>FObjectInitializer</code> 的构造函数。</p>
</blockquote>
<p>在继承自 UObject 的类中，都可以自己写一个接收 <code>const FObjectInitializer&amp;</code> 参数的构造函数，在创建对象时会被调用：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">UMyObject::<span class="built_in">UMyObject</span>(<span class="keyword">const</span> FObjectInitializer&amp; Initializer)&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>在类中的 <code>GENERATED_UCLASS_BODY</code> 中默认声明这样一个构造函数。并且，在 UHT 生成的代码中通过宏还定义了一个函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">DEFINE_DEFAULT_OBJECT_INITIALIZER_CONSTRUCTOR_CALL</span>(UMyObject) </span><br></pre></td></tr></table></figure>

<p>这个宏经过展开之后就是这样的:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __DefaultConstructor(<span class="keyword">const</span> FObjectInitializer&amp; X) &#123; <span class="keyword">new</span>((EInternal*)X.<span class="built_in">GetObj</span>())<span class="built_in">UMyObject</span>(X); &#125;</span><br></pre></td></tr></table></figure>

<p>为当前的对象类型 <code>UMyObject</code> 定义了一个 <code>__DefaultConstructor</code> 函数，作用是在当前 <code>FObjectInitializer</code> 传入的参数的 Object 上调用 <code>FObjectInitializer</code> 的构造函数。</p>
<p><strong>注意 </strong>：如果是<code>GENERATED_BODY</code> 则不会声明这个构造函数，使用的就是另一个宏：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">DEFINE_DEFAULT_CONSTRUCTOR_CALL</span>(UMyObject)</span><br></pre></td></tr></table></figure>

<p>展开之后是这样的：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __DefaultConstructor(<span class="keyword">const</span> FObjectInitializer&amp; X) &#123; <span class="keyword">new</span>((EInternal*)X.<span class="built_in">GetObj</span>())UMyObject; &#125;</span><br></pre></td></tr></table></figure>

<p>是通过 <code>GANERATED_BODY</code> 和<code>GENERATED_UCLASS_BODY</code>来定义了两种 <code>__DefaultConstructor</code> 的实现，一种是调用 <code>FObjectInitializer</code> 的构造函数，另一种是调用类的默认构造函数。</p>
<blockquote>
<p>所以，默认情况下 FObjectInitializer 的构造函数和 UObject 的默认构造函数在调用时只会走一个。</p>
</blockquote>
<p>那么它是如何被调用到的呢？</p>
<p>在 <code>NewObject</code> 中调用的 <code>StaticConstructObject_Internal</code> 中有以下代码：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">bool</span> bRecycledSubobject = <span class="literal">false</span>;	</span><br><span class="line">Result = <span class="built_in">StaticAllocateObject</span>(InClass, InOuter, InName, InFlags, InternalSetFlags, bCanRecycleSubobjects, &amp;bRecycledSubobject);</span><br><span class="line"><span class="built_in">check</span>(Result != <span class="literal">NULL</span>);</span><br><span class="line"><span class="comment">// Don&#x27;t call the constructor on recycled subobjects, they haven&#x27;t been destroyed.</span></span><br><span class="line"><span class="keyword">if</span> (!bRecycledSubobject)</span><br><span class="line">&#123;		</span><br><span class="line">	<span class="built_in">STAT</span>(FScopeCycleCounterUObject <span class="built_in">ConstructorScope</span>(InClass, <span class="built_in">GET_STATID</span>(STAT_ConstructObject)));</span><br><span class="line">	(*InClass-&gt;ClassConstructor)(<span class="built_in">FObjectInitializer</span>(Result, InTemplate, bCopyTransientsFromClassDefaults, <span class="literal">true</span>, InInstanceGraph) );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过传入进来的 UClass 对象获取其中的 <code>ClassConstructor</code> 函数指针，并构造出一个 <code>FObjectInitializer</code> 作为参数传递。</p>
<p>在之前的笔记 (<a href="https://imzlp.com/notes/ue/#StaticClass%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9A%E4%B9%89%E7%9A%84">StaticClass 是如何定义的</a>) 中，写到了，通过 <code>GetPrivateStaticClass</code> 获取到当前 UObject 类的 UClass 实例会实例化出一个当前类的 <code>InternalConstructor</code> 函数（注意这个模板参数 T 是 UObject 的类）：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// class.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Helper template to call the default constructor for a class</span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;class T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InternalConstructor</span><span class="params">(<span class="keyword">const</span> FObjectInitializer&amp; X )</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">	T::__DefaultConstructor(X);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>就将其转发到了上面讲到的 <code>__DefaultConstructor</code> 函数上，然后它里面又转发到了所传入 <code>FObjectInitializer</code> 对象上的 <code>const FObjectInitializer&amp;</code> 构造函数上（或者默认构造函数上）。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-call-FObjectInitializer-ctor.webp"></p>
<p>创建对象并调用 <code>const FObjectInitializer&amp;</code> 构造函数的调用流程为：</p>
<ol>
<li>通过调用 <code>StaticAllocateObject</code> 根据传入的 UClass 创建出对象</li>
<li>通过传入的 UClass 对象内的 ClassConstructor 函数指针调用所创建 UObject 类的 <code>InternalConstructor</code> 函数</li>
<li><code>UMyObject::InternalConstructor</code>会转发到<code>UMyObject::__DefaultConstructor</code></li>
<li><code>UMyObject::__DefaultConstructor</code>会从接收到的 <code>FObjectInitializer</code> 对象上获取到通过 <code>StaticAllocateObject</code> 创建的对象，然后通过 <code>placement-new</code> 的方式，在这块内存上调用 <code>UMyObject</code> 类的 <code>const FObjectInitializer&amp;</code> 构造函数。</li>
</ol>
<p>通过以上的流程就实现了 <code>NewObject</code> 时会自动调用到它的 <code>FObjectInitializer</code> 构造函数。</p>
<blockquote>
<p>注意：在 CDO 的构造上有点区别，CDO 的构造是通过 <code>UClass::GetDefaultObject</code> 中实现上述流程的。</p>
</blockquote>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
      </categories>
      <tags>
        <tag>UObject</tag>
        <tag>ObjectInitializer</tag>
      </tags>
  </entry>
  <entry>
    <title>引擎版本获取</title>
    <url>/wiki/52783345/</url>
    <content><![CDATA[<p>有些需求工程中需要检测引擎版本，如在支持多个引擎版本的插件，在引擎中包含不同的模块，引擎版本之间 API 的差异等。</p>
<h3 id="C- 获取引擎版本"><a href="#C- 获取引擎版本" class="headerlink" title="C++ 获取引擎版本"></a>C++ 获取引擎版本 </h3><p><code>Runtime/Launch/Resources/Version.h</code> 中有版本宏定义：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/Launch/Resources/Version.h</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">// newer than a 4.11.* version, regardless of the changelist that it was built with)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ENGINE_MAJOR_VERSION	4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ENGINE_MINOR_VERSION	26</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ENGINE_PATCH_VERSION	2</span></span><br></pre></td></tr></table></figure>
<p>在代码中通过预处理指令即可使用。</p>
<h3 id="从 TargetRules 获取引擎版本"><a href="# 从 TargetRules 获取引擎版本" class="headerlink" title="从 TargetRules 获取引擎版本"></a>从 TargetRules 获取引擎版本 </h3><p><code>TargetRules</code> 中具有 <code>Version</code>(ReadOnlyBuildVersion)成员，它是 <code>BuildVersion</code> 的类型，定义在 <a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Programs/UnrealBuildTool/System/BuildVersion.cs">Programs\UnrealBuildTool\System\BuildVersion.cs</a> 中。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTools/System/BuildVersion.cs</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">UnrealBuildTool</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> Holds information about the current engine version</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	[<span class="meta">Serializable</span>]</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BuildVersion</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> The major engine version (4 for UE4)</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">int</span> MajorVersion;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> The minor engine version</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">int</span> MinorVersion;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> The hotfix/patch version</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">int</span> PatchVersion;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> The changelist that the engine is being built from</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">int</span> Changelist;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> The changelist that the engine maintains compatibility with</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">int</span> CompatibleChangelist;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> Whether the changelist numbers are a licensee changelist</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">bool</span> IsLicenseeVersion;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> Whether the current build is a promoted build, that is, built strictly from a clean sync of the given changelist</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">bool</span> IsPromotedBuild;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> Name of the current branch, with &#x27;/&#x27; characters escaped as &#x27;+&#x27;</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">string</span> BranchName;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> The current build id. This will be generated automatically whenever engine binaries change if not set in the default Engine/Build/Build.version.</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">string</span> BuildId;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> The build version string</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">string</span> BuildVersionString;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">   	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中的 <code>MajorVersion</code>/<code>MinorVersion</code>/<code>PatchVersion</code> 分别对应 X.XX.X。</p>
<p>在 UE4.19 版本之前从 UBT 获取引擎版本比较麻烦：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">BuildVersion Version;</span><br><span class="line"><span class="keyword">if</span> (BuildVersion.<span class="built_in">TryRead</span>(BuildVersion.<span class="built_in">GetDefaultFileName</span>(), out Version))</span><br><span class="line">&#123;</span><br><span class="line">    System.Console.<span class="built_in">WriteLine</span>(Version.MajorVersion);</span><br><span class="line">    System.Console.<span class="built_in">WriteLine</span>(Version.MinorVersion);</span><br><span class="line">    System.Console.<span class="built_in">WriteLine</span>(Version.PatchVersion);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 UE4.19 及以后的引擎版本，可以通过 <code>ReadOnlyTargetRules.Version</code> 来获得，它是 <code>ReadOnlyBuildVersion</code> 类型，包裹了一个 <code>BuildVersion</code> 类。</p>
<p>可以在 <code>Target.cs</code> 或者 <code>Build.cs</code> 里通过 <code>Target.Version</code> 来访问引擎版本，可以根据不同的引擎版本来使用不同的库。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
      </categories>
      <tags>
        <tag>Engine</tag>
      </tags>
  </entry>
  <entry>
    <title>打包时路径过长的错误</title>
    <url>/wiki/491e08f5/</url>
    <content><![CDATA[<p>在打包的时候遇到这个错误：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Couldn&#x27;t save package,filename is too long</span><br></pre></td></tr></table></figure>
<p>是因为某些资源在 Windows 上的绝对路径长度超过了 260 个字符，这是 NTFS 的限制。<br>所以，将项目路径移动到磁盘根目录，或者减少目录层级即可。<br>引擎中相关的代码在：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Source/Editor/UnrealEd/Private/CookOnTheFlyServer.cpp(UE4.18.3)</span></span><br><span class="line"><span class="comment">// need to subtract 32 because the SavePackage code creates temporary files with longer file names then the one we provide</span></span><br><span class="line"><span class="comment">// projects may ignore this restriction if desired</span></span><br><span class="line"><span class="keyword">const</span> int32 CompressedPackageFileLengthRequirement = bConsiderCompressedPackageFileLengthRequirements ? <span class="number">32</span> : <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const</span> FString FullFilename = FPaths::<span class="built_in">ConvertRelativePathToFull</span>(PlatFilename);</span><br><span class="line"><span class="keyword">if</span> (FullFilename.<span class="built_in">Len</span>() &gt;= (PLATFORM_MAX_FILEPATH_LENGTH - CompressedPackageFileLengthRequirement))</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">LogCookerMessage</span>(FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Couldn&#x27;t save package, filename is too long: %s&quot;</span>), *PlatFilename), EMessageSeverity::Error);</span><br><span class="line">  <span class="built_in">UE_LOG</span>(LogCook, Error, <span class="built_in">TEXT</span>(<span class="string">&quot;Couldn&#x27;t save package, filename is too long :%s&quot;</span>), *PlatFilename);</span><br><span class="line">  Result = ESavePackageResult::Error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而各个平台的 <code>PLATFORM_MAX_FILEPATH_LENGTH</code> 均定义在 <code>Runtime/Core/Public</code> 相关的平台下。<br>Windows 是使用的另一个宏<code>WINDOWS_MAX_PATH</code>：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">D:\UnrealEngine\Offical_Source\<span class="number">4.18</span>\Engine\Source\Runtime\Core\Public\Windows\WIndowsPlatform.h:</span><br><span class="line">   <span class="number">57</span>  <span class="meta">#<span class="meta-keyword">define</span> PLATFORM_HAS_BSD_TIME                0</span></span><br><span class="line">   <span class="number">58</span>  <span class="meta">#<span class="meta-keyword">define</span> PLATFORM_USE_PTHREADS                0</span></span><br><span class="line">   <span class="number">59</span>: <span class="meta">#<span class="meta-keyword">define</span> PLATFORM_MAX_FILEPATH_LENGTH           WINDOWS_MAX_PATH</span></span><br><span class="line">   <span class="number">60</span>  <span class="meta">#<span class="meta-keyword">define</span> PLATFORM_HAS_BSD_SOCKET_FEATURE_WINSOCKETS     1</span></span><br><span class="line">   <span class="number">61</span>  <span class="meta">#<span class="meta-keyword">define</span> PLATFORM_USES_MICROSOFT_LIBC_FUNCTIONS       1</span></span><br></pre></td></tr></table></figure>
<p><code>WINDOWS_MAX_PATH</code>这个宏定义在 <code>Runtime/Core/Private/Windows/MinimalWindowsApi.h</code> 中：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WINDOWS_MAX_PATH 260</span></span><br></pre></td></tr></table></figure>
<p>显然 UE 并没有使用 Windows 提供的 <code>MAX_PATH</code> 宏，硬编码为了 260，即在 UE 中 Windows 上的文件路径最大长度为 260 个字符 (在启用<code>bConsiderCompressedPackageFileLengthRequirements</code> 时还要减去 32 个字符)，虽然 Windows10 要 [移除 260 字符的限制](Microsoft removes 260 character limit for NTFS Path in new Windows 10 Insider Preview)，<del> 但是貌似 UE 没有跟进的打算 </del>(<a href="https://www.unrealengine.com/en-US/blog/unreal-engine-4-22-released">UE4.22 Released</a> 支持了长文件名的特性 (实验性))。<br><code>bConsiderCompressedPackageFileLengthRequirements</code> 选项可以加在 <code>Saved/Config/Windows/Engine.ini</code> 下（默认为<code>true</code>）：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[CookSettings]</span></span><br><span class="line"><span class="attr">bConsiderCompressedPackageFileLengthRequirements</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>这个配置是在 Cook 时会被加载用来判断是否考虑引擎生成的文件名长度：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Source/Editor/UnrealEd/Private/CookOnTheFlyServer.cpp(UE4.18.3)</span></span><br><span class="line"><span class="comment">// need to subtract 32 because the SavePackage code creates temporary files with longer file names then the one we provide</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UCookOnTheFlyServer::ShouldConsiderCompressedPackageFileLengthRequirements</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">bool</span> bConsiderCompressedPackageFileLengthRequirements = <span class="literal">true</span>;</span><br><span class="line">  GConfig-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;CookSettings&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bConsiderCompressedPackageFileLengthRequirements&quot;</span>), bConsiderCompressedPackageFileLengthRequirements, GEditorIni);</span><br><span class="line">  <span class="keyword">return</span> bConsiderCompressedPackageFileLengthRequirements;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>UCookOnTheFlyServer::SaveCookedPackage</code> 中需要通过它来决定将系统支持的 <code>MAX_PATH</code> 减去 32 之后的结果，用来判断资源路径是否超出限制。</p>
<p>外部阅读：</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/fileio/naming-a-file">Naming Files, Paths, and Namespaces</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
      </categories>
      <tags>
        <tag>DS</tag>
      </tags>
  </entry>
  <entry>
    <title>检测是否为安装版引擎的方法</title>
    <url>/wiki/33066/</url>
    <content><![CDATA[<p>在 EpicGameLauncher 安装的引擎版本是不能通过 <code>UnrealBuildTool.exe -ProjectFiles &quot;ProgramProjectName&quot;</code> 来创建 Target<code>Program</code>的项目的，会提示下列错误：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ERROR: UnrealBuildTool Exception: A game project path was not specified, which is required when generating project files using an installed build or passing -game on the command line</span><br></pre></td></tr></table></figure>
<p>这个异常在 UBT 里的相关代码在<code>ProjectFileGenreator.cs</code>：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ProjectFileGenreator.cs</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ConfigureProjectFileGeneration</span>(<span class="params"> String[] Arguments, <span class="keyword">ref</span> <span class="built_in">bool</span> IncludeAllPlatforms </span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">switch</span>(CurArgument.ToUpperInvariant() )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;-GAME&quot;</span>:</span><br><span class="line">			<span class="comment">// Generates project files for a single game</span></span><br><span class="line">			bGeneratingGameProjectFiles = <span class="literal">true</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(bGeneratingGameProjectFiles || UnrealBuildTool.IsEngineInstalled() )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (OnlyGameProject == <span class="literal">null</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">&quot;A game project path was not specified, which is required when generating project files using an installed build or passing -game on the command line&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		GameProjectName = OnlyGameProject.GetFileNameWithoutExtension();</span><br><span class="line">		<span class="keyword">if</span> (String.IsNullOrEmpty(GameProjectName))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">&quot;A valid game project was not found in the specified location (&quot;</span> + OnlyGameProject.Directory.FullName + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">bool</span> bInstalledEngineWithSource = UnrealBuildTool.IsEngineInstalled() &amp;&amp; DirectoryReference.Exists(UnrealBuildTool.EngineSourceDirectory);</span><br><span class="line"></span><br><span class="line">		bIncludeEngineSource = bAlwaysIncludeEngineModules || bInstalledEngineWithSource;</span><br><span class="line">		bIncludeDocumentation = <span class="literal">false</span>;</span><br><span class="line">		bIncludeBuildSystemFiles = <span class="literal">false</span>;</span><br><span class="line">		bIncludeShaderSource = <span class="literal">true</span>;</span><br><span class="line">		bIncludeTemplateFiles = <span class="literal">false</span>;</span><br><span class="line">		bIncludeConfigFiles = <span class="literal">true</span>;</span><br><span class="line">		IncludeEnginePrograms = bAlwaysIncludeEngineModules;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，<code>if</code>这里如果传递给 UBT<code>-game</code>参数并且是引擎是安装版本 (EpicGameLauncher) 时会检测有没有传入 <code>project</code> 参数，如果没有就会抛异常。<br>正常的 UBT 调用命令：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">UnrelBuildTool.exe -ProjectFiles -project=&quot;D:\UnrealProjects\UEProject.uproject&quot; -game</span><br></pre></td></tr></table></figure>
<p>这种普通的 Game 参数在 UBT 里面是不会抛异常的。但是用生成 Program 的命令来调用 UBT，安装版引擎就会抛异常：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">UnrelBuildTool.exe -ProjectFiles ProgramName</span><br></pre></td></tr></table></figure>
<p>根据上面 <code>ProjectFileGenreator.cs</code> 的检测代码，我们要做到的是把 <code>UnrealBuildTool.IsEngineInstalled()</code> 获取的结果变为 false.<br>继续跟代码：<code>UnrealBuildTool.IsEngineInstalled()</code>获得的是 <code>UnrealBuildTool</code> 中的一个 bool 变量<code>bIsEngineInstalled</code>：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTool.cs</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">IsEngineInstalled</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (!bIsEngineInstalled.HasValue)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">&quot;IsEngineInstalled() called before being initialized.&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> bIsEngineInstalled.Value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查找引用发现在 <code>GuardedMain</code> 里有设置 <code>bIsEngineInstalled</code> 这个变量的地方：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTool.cs</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">GuardedMain</span>(<span class="params"><span class="built_in">string</span>[] Arguments</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		<span class="keyword">foreach</span> (<span class="built_in">string</span> Argument <span class="keyword">in</span> Arguments)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">string</span> LowercaseArg = Argument.ToLowerInvariant();</span><br><span class="line">			<span class="keyword">if</span> (LowercaseArg == <span class="string">&quot;-installed&quot;</span> || LowercaseArg == <span class="string">&quot;-installedengine&quot;</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				bIsEngineInstalled = <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (LowercaseArg == <span class="string">&quot;-notinstalledengine&quot;</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				bIsEngineInstalled = <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!bIsEngineInstalled.HasValue)</span><br><span class="line">		&#123;</span><br><span class="line">			bIsEngineInstalled = FileReference.Exists(FileReference.Combine(RootDirectory, <span class="string">&quot;Engine&quot;</span>, <span class="string">&quot;Build&quot;</span>, <span class="string">&quot;InstalledBuild.txt&quot;</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从代码可以看到，UBT 对是不是安装版引擎的检测有三种方法：</p>
<ol>
<li>传入参数是否有 <code>-installled</code> 和<code>-installedengine</code></li>
<li>传入参数是否有<code>-notinstallengine</code></li>
<li>判断引擎路径 <code>Engine\Build</code> 下是否具有 <code>InstalledBuild.txt</code> 文件</li>
</ol>
<p>(说是三种其实也就是两种，就算指定了 <code>-notinstallengine</code> 也是要判断存不存在 <code>Engine\Build\InstalledBuild.txt</code> 这个文件)<br>而且检测的顺序是这样的:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-installled &gt; -installedengine &gt; -notinstalledengine &gt; Engine\Build\InstalledBuild.txt</span><br></pre></td></tr></table></figure>
<p>所以，当我想要让 UBT 认为我的引擎版本不是安装版，有两种办法：</p>
<ol>
<li>对 UBT 的调用传入 <code>-notinstalledengine</code> 参数，并且删掉 <code>Engine\Build</code> 目录下的 <code>InstalledBuild.txt</code> 文件</li>
<li>对 UBT 的调用不传入 <code>-installled</code> 和<code>-installedengine</code>参数，并且删掉 <code>Engine\Build</code> 目录下的 <code>InstalledBuild.txt</code> 文件</li>
</ol>
<p><strong>注</strong>：UBT 里还有下面两种检测：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTools.cs</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">IsEnterpriseInstalled</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(!bIsEnterpriseInstalled.HasValue)</span><br><span class="line">	&#123;</span><br><span class="line">		bIsEnterpriseInstalled = FileReference.Exists(FileReference.Combine(EnterpriseDirectory, <span class="string">&quot;Build&quot;</span>, <span class="string">&quot;InstalledBuild.txt&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> bIsEnterpriseInstalled.Value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">IsProjectInstalled</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (!bIsProjectInstalled.HasValue)</span><br><span class="line">	&#123;</span><br><span class="line">		bIsProjectInstalled = FileReference.Exists(FileReference.Combine(RootDirectory, <span class="string">&quot;Engine&quot;</span>, <span class="string">&quot;Build&quot;</span>, <span class="string">&quot;InstalledProjectBuild.txt&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> bIsProjectInstalled.Value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
      </categories>
      <tags>
        <tag>UBT</tag>
        <tag>Build System</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 导入图集：TexturePacker</title>
    <url>/wiki/28513/</url>
    <content><![CDATA[<p>在开发游戏时，会使用到大量的图片资源，使用图集的作用在于减少 DrawCall，提高性能。在 UE 中没有图集的打包工具，比较流行的方案是使用第三方的图集打包工具 <a href="https://www.codeandweb.com/texturepacker">TexturePacker</a>。新版本的 TexturePacker 支持直接导出 UE4 的 Sprite，并且可以在引擎中直接导入。在之前的版本中可以使用<a href="https://github.com/ufna/VaTexAtlas">VaTexAtlas</a> 通过 Json Array 的数据导入，不过与 TexturePacker 直接导出 UE 的 Sprite 相比，VaTexAtlas 并没有优势，UE 的 Sprite 还可以直接预览，VaTexAtlas 则不可以，在官方已经支持的情况下不建议再使用 VaTexAtlas 作为 UE 导入图集的方式。</p>
<p>本篇文章主要内容是记录 TexturePacker 图集生成文件的分析、导入 UE、选项介绍、以及记录在 UE 中使用遇到的问题。</p>
<h2 id="图集文件结构和导入 UE"><a href="# 图集文件结构和导入 UE" class="headerlink" title="图集文件结构和导入 UE"></a>图集文件结构和导入 UE</h2><p>TexturePacker 的项目文件格式为<code>*.tps</code>，在使用 TexturePacker 导出 UE 的图集会产生两个文件（以 Icons 项目为例）：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">icons.tps</span><br><span class="line">icons.paper2dsprites</span><br><span class="line">icons.webp</span><br></pre></td></tr></table></figure>
<p>其中 <code>icons.webp</code> 是导出的 Texture。<br><code>icons.paper2dsprites</code>是当前图集的描述文件，使用 json 格式，用于描述图集中包含的每个 Sprite 的信息：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;frames&quot;</span>: </span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;BackIcon.webp&quot;</span>:</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;frame&quot;</span>: &#123;<span class="attr">&quot;x&quot;</span>:<span class="number">49</span>,<span class="attr">&quot;y&quot;</span>:<span class="number">1</span>,<span class="attr">&quot;w&quot;</span>:<span class="number">36</span>,<span class="attr">&quot;h&quot;</span>:<span class="number">36</span>&#125;,</span><br><span class="line">      <span class="attr">&quot;rotated&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;trimmed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;spriteSourceSize&quot;</span>: &#123;<span class="attr">&quot;x&quot;</span>:<span class="number">0</span>,<span class="attr">&quot;y&quot;</span>:<span class="number">0</span>,<span class="attr">&quot;w&quot;</span>:<span class="number">36</span>,<span class="attr">&quot;h&quot;</span>:<span class="number">36</span>&#125;,</span><br><span class="line">      <span class="attr">&quot;sourceSize&quot;</span>: &#123;<span class="attr">&quot;w&quot;</span>:<span class="number">36</span>,<span class="attr">&quot;h&quot;</span>:<span class="number">36</span>&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;Cross_12x.webp&quot;</span>:</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;frame&quot;</span>: &#123;<span class="attr">&quot;x&quot;</span>:<span class="number">251</span>,<span class="attr">&quot;y&quot;</span>:<span class="number">53</span>,<span class="attr">&quot;w&quot;</span>:<span class="number">12</span>,<span class="attr">&quot;h&quot;</span>:<span class="number">12</span>&#125;,</span><br><span class="line">      <span class="attr">&quot;rotated&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;trimmed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;spriteSourceSize&quot;</span>: &#123;<span class="attr">&quot;x&quot;</span>:<span class="number">0</span>,<span class="attr">&quot;y&quot;</span>:<span class="number">0</span>,<span class="attr">&quot;w&quot;</span>:<span class="number">12</span>,<span class="attr">&quot;h&quot;</span>:<span class="number">12</span>&#125;,</span><br><span class="line">      <span class="attr">&quot;sourceSize&quot;</span>: &#123;<span class="attr">&quot;w&quot;</span>:<span class="number">12</span>,<span class="attr">&quot;h&quot;</span>:<span class="number">12</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;meta&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;app&quot;</span>: <span class="string">&quot;https://www.codeandweb.com/texturepacker&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;1.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;target&quot;</span>: <span class="string">&quot;paper2d&quot;</span>, </span><br><span class="line">    <span class="attr">&quot;image&quot;</span>: <span class="string">&quot;icons.webp&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;RGBA8888&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;size&quot;</span>: &#123;<span class="attr">&quot;w&quot;</span>:<span class="number">288</span>,<span class="attr">&quot;h&quot;</span>:<span class="number">120</span>&#125;,</span><br><span class="line">    <span class="attr">&quot;scale&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;smartupdate&quot;</span>: <span class="string">&quot;$TexturePacker:SmartUpdate:25f0f996e96d501a04346c8b7185b520:81c127855f3c19ba3f655bd8ca6a90ac:7e03caed8675e493d8b522094ff94bba$&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将 <code>icons.paper2dsprite</code> 文件拖入 UE 的 Content Browser 窗口会创建出下面这些资源：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/28513/TexturePacker/ue4-import-image-set-by-texture-packer.webp"></p>
<ul>
<li>Frames 目录下是当前图集中的每个 Sprite，原始导入的资源关系均是软引用（Sprite-&gt;Sprite 以及 Sprite-&gt;Texture），但是有些 Sprite 会硬引用 <code>/Paper2D/TranslucentUnlitSpriteMaterial</code> 这个<code>Material Instance</code></li>
<li>Texture 目录中具有一个当前图集的完整 Texture，该资源的原始路径依赖为硬盘中的 png 文件，图集中的 Sprite 对该 Texture 的资源引用关系是软引用。</li>
<li>SpriteSheet 这个资源则是导入 <code>*.paper2dsprite</code> 文件创建的资源，该资源的原始路径依赖为 <code>*.paper2dsprite</code> 文件，该资源对图集的完整 Texture 是硬引用，对图集中的 Sprite 是软引用。</li>
</ul>
<h2 id="Texture-Settings"><a href="#Texture-Settings" class="headerlink" title="Texture Settings"></a>Texture Settings</h2><p>主界面：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/28513/TexturePacker/texture-packer-main-ui.webp"></p>
<p>参数说明。</p>
<h3 id="Data"><a href="#Data" class="headerlink" title="Data"></a>Data</h3><ul>
<li>Data Format：选择 Publish 时生成的格式，支持 UE</li>
<li>Trim sprite names：是否裁剪 Sprite 的名字，在 false 的情况下，Sprite 的名字会包含后缀如<code>BackIcon.webp</code>，导入引擎时名字为 BackIcon_png，为 true 时则把后缀裁剪掉。</li>
<li>Prepend Folder name：导出的 Sprite 是否包含目录名字，若为 false，则所有的 Sprite 都按照原本的名字，若为 true，导出的 <code>*.paper2dsprite</code> 文件中对 <code>sprite</code> 的描述中会包含路径信息（如 Icons/BackIcon.webp，导入引擎中的名字就为 Icons_BackIcon_png）</li>
<li>TexturePatth：指定要导出的 Texture 路径</li>
</ul>
<h3 id="Texture"><a href="#Texture" class="headerlink" title="Texture"></a>Texture</h3><ul>
<li>Texture format：导出图集的 Texture 的格式，默认<code>PNG-32</code></li>
<li>Texture file：导出的 Texture 的文件名</li>
<li>Png Opt Level：PNG 文件的优化，所有的优化都是有损压缩，0 为 32 位 png 文件.（0 always write 32 bit png files、1write indexed (8 bit) png files if possible、2..7 optimize packing, high values might be slow）</li>
<li>Pixel format：像素格式：默认<code>RGB8888</code></li>
</ul>
<p>所有支持的格式：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/28513/TexturePacker/texture-package-image-format.webp"></p>
<ul>
<li>Transparency Handling：使用何种方式处理 Alpha 透明像素的颜色值，支持四种模式，默认选项为<code>Clear Transparent pixel</code>，该模式节省磁盘空间。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/28513/TexturePacker/texture-package-texture-alpha-handling.webp"></li>
</ul>
<h3 id="Layout"><a href="#Layout" class="headerlink" title="Layout"></a>Layout</h3><ul>
<li><p>Max Sise：图集的最大尺寸</p>
</li>
<li><p>Fixes Size: 手动指定图集的大小，为空则让 TexturePacker 确定图集大小</p>
</li>
<li><p>Size Contraints：图集的大小约束，默认选项是 Any Size。在 UE 中导入的 Texture 要求是 2 次幂的，否则在 IOS 上会有显示问题，如果非 2 次幂，在 UE 中可以设置填充，不填充也可以，要把 Compression-Compression Settings 设置为 USerInterface2D，但是非 2 次幂的 Texture 会有性能问题。（之前遇到的问题：<a href="https://imzlp.com/notes/#UE4-IOS%E8%B4%B4%E5%9B%BE%E9%9D%9E2%E6%AC%A1%E5%B9%82%E7%9A%84%E6%98%BE%E7%A4%BA%E9%97%AE%E9%A2%98">UE4：IOS 贴图非 2 次幂的显示问题</a>）<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/28513/TexturePacker/texture-package-layout-size-constraints.webp"></p>
</li>
<li><p>Forces squared：强制 Texture 具有 2 次幂大小，勾选后(Max Size 和 Fixes Size 被锁定为单个值)。</p>
</li>
<li><p>Scaling variants：缩放变体的设置</p>
</li>
<li><p>Scale：缩放</p>
</li>
<li><p>Scale Mode：缩放模式，默认为<code>Smooth</code>。</p>
</li>
<li><p>Algorithm：Sprite 的排列算法，默认是 <code>MaxRects</code>，大小混排，也可以使用<code>Grid/Strip</code> 使用最大 Sprite 的格子布局。选择不同的算法，可以控制的选项不一样。</p>
<ul>
<li>Basic：<code>Sort by</code>/<code>Sort order</code>/<code>Pack</code>，用于控制 Sprite 的排列规则</li>
<li>Grid/Strip：按照最大的 Sprite 为基本格子单位</li>
<li>MaxRects：<code>Heuristics</code>/<code>Pack</code>，其中 Heuristics 又控制着几种模式<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/28513/TexturePacker/texture-package-layout-algotithm.webp"></li>
</ul>
</li>
<li><p>Multipack：如果不想要把所有的 Sprite 打包到单个 Texture 里，可以使用此选项打包出多个 Texture 和数据文件，默认 false<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/28513/TexturePacker/texture-packer-multipack.webp"></p>
</li>
<li><p>Allow rotation：是否允许旋转 Sprite，能够使生成的 Texture 贴合的更好，开启后可以将他们顺时针或者逆时针旋转 90 度（在有些引擎中可能会不支持，在 UE 中测试没有问题），默认为 true</p>
</li>
<li><p>Detect identical sprites：自动别名相同的图片只在 Texture 中存储一次，但是数据文件中包含多份，相当于一个 Texture 中包含了一个 Sprite 的图，但是数据中可以存储两个 Sprite 的信息，在导入引擎时就会生成两个 Sprite，但原始的 Texture 中只有一份图像数据，可以节省空间。</p>
</li>
</ul>
<h3 id="Sprites"><a href="#Sprites" class="headerlink" title="Sprites"></a>Sprites</h3><ul>
<li><p>Trim mode：可以裁剪 Sprite 边界的透明像素，由于不需要处理透明像素，因此可以缩小 Sprite 的尺寸，可以使图集排布的更加紧密，并加快渲染速度。有四种模式<code>None</code>/<code>Trim</code>/<code>Crop,keep Pos</code>/<code>Crop,flush Pos</code>。</p>
<ul>
<li>None：不裁剪，保持 Sprite 原始大小，保持原有的透明像素，在此种模式下在 UE 中使用该 Sprite 与原图相同。</li>
<li>Trim：移除 Sprite 周围的透明度，在使用时，应该具有原有大小，但该选项并非在所有框架中都可用。实际测试时在 UE 中使用 Sprite 比例与原图不同，没有原图中的周围透明像素。</li>
<li>Crop,keep Pos：导入 UE 中与 <code>Trim</code> 看起来相同，目前还没发现其他的区别。</li>
<li>Crop,flush Pos：导入 UE 中与 <code>Trim</code> 以及 <code>Crop,flush Pos</code> 看起来相同。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/28513/TexturePacker/texture-package-trim-mode.webp"></li>
</ul>
</li>
<li><p>Trim margin：当开启裁剪时，裁剪算法会尽可能多地删除边界的透明像素，设置 <code>Trim margin</code> 可以指定保留边界的像素。</p>
</li>
<li><p>Transparency Threshold：值范围为 1~255，默认值为 1。当开启裁剪时，低于此值的 alpha 值将被视为透明，对于边界几乎不可见的 alpha 像素的 Sprite 可以起到裁剪的作用。</p>
</li>
<li><p>Extrude：默认值为 1，用于指定拉伸 Sprite 边界重复的像素，Sprite 的大小保持不变。但设置之后在 UE 中 Sprite 的中心位置发生了变化。当 Extruct 设置为 10，之前和之后的区别：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/28513/TexturePacker/texture-package-sprite-extrude-10-diff.webp"></p>
</li>
<li><p>Border padding：填充图集 Texture 边缘为透明像素（边缘的位置不放置 Sprite）</p>
</li>
<li><p>Shape padding：设置 Sprite 之间的填充，默认为 2，填充的像素不会添加到 sprite 中，在使用 OpenGL 渲染时应至少设置为 2.</p>
</li>
<li><p>Common divisor：扩展 Sprite 的大小使其能被设置的值整除，扩展的 Sprite 会透明，默认值为 1，表示 Sprite 大小不变，最大为 2048。用途为强制设置大小相同的 Sprite，在多个缩放因子上强制相同的布局。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/28513/TexturePacker/texture-package-sprite-common-disvisor.webp"></p>
</li>
</ul>
<h3 id="Normal-maps"><a href="#Normal-maps" class="headerlink" title="Normal maps"></a>Normal maps</h3><ul>
<li>Pack with same layout：Sprite 图像和他们的法线贴图使用相同的布局打包在单独的 Sprite sheets 上。</li>
</ul>
<h2 id="UE4 使用图集的问题"><a href="#UE4 使用图集的问题" class="headerlink" title="UE4 使用图集的问题"></a>UE4 使用图集的问题</h2><h3 id="UMG 中使用的问题"><a href="#UMG 中使用的问题" class="headerlink" title="UMG 中使用的问题"></a>UMG 中使用的问题</h3><p>UMG 里使用 TexturePacker 图集，在 UImage 空间中使用 Sprit，用 Draw As=Image ,Tiling=Horizontal，发现整个图集都被平铺出来了。</p>
<p>在 <code>Tiling</code> 为<code>No Tile</code>的模式下是正常的，但是在其他的模式下都会有问题。<br>应该是引擎支持不够的问题，只能暂时先不用这种方式，有时间具体分析一下原因。</p>
<h3 id="Reimport 问题"><a href="#Reimport 问题" class="headerlink" title="Reimport 问题"></a>Reimport 问题</h3><p>reimport 图集有一个坑，可能会出现 uv 混乱，出现 UV 不对的问题。</p>
<p>避免问题的操作流程是：</p>
<ol>
<li>保证没有打开使用到该图集的 UMG</li>
<li>删掉图集和所有 sprite 重新拖进来一次</li>
</ol>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Gameplay</category>
      </categories>
      <tags>
        <tag>TexturePacker</tag>
        <tag>图集</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 接入 SteamSDK 及相关资料</title>
    <url>/wiki/3231/</url>
    <content><![CDATA[<p>游戏上架 <a href="https://store.steampowered.com/">Steam</a> 必须要接入 <a href="https://partner.steamgames.com/doc/sdk">SteamSDK</a>，本篇文章简单介绍一下在 UE4 中接入<a href="https://partner.steamgames.com/doc/sdk">SteamSDK</a> 的方法，后续与接入 Steam 平台服务相关的内容也会放到这篇文章中。</p>
<blockquote>
<p>SteamSDK 的接入可以使游戏与 Steam 的社区整合，Steam 拥有很好的社区生态，这一点是 Epic 刚出的 <a href="https://www.epicgames.com/store/e/en-US/">Epic Games Store</a> 目前比不了的~(当然我是支持市场竞争的。</p>
</blockquote>
<span id="more"></span>
<p>废话不多说，首先，检查引擎目录下:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Engine\Binaries\ThirdParty\Steamworks\Steamv139</span><br></pre></td></tr></table></figure>
<p>该目录下是否有 <code>Win32</code>/<code>Win64</code> 文件夹，以及其中是否具有以下几个文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">steam_api.dll  steamclient.dll  tier0_s.dll  vstdlib_s.dll</span><br></pre></td></tr></table></figure>
<p>如果没有可以从 Steam 的安装目录拷贝过来。</p>
<p>之后打开项目，打开<code>Plugins</code> - <code>Online Platfrom</code>，确保启用以下三个插件：</p>
<ul>
<li>Online Subsystem NULL</li>
<li>Online Subsystem Steam</li>
<li>Online Subsystem Utils</li>
</ul>
<p>打开项目的 <code>*.target.cs</code> 文件，加入<code>bUsesSteam = true;</code>:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> UnrealBuildTool;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SanguoWarriorsTarget</span> : <span class="title">TargetRules</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">SanguoWarriorsTarget</span>(<span class="params">TargetInfo Target</span>) : <span class="title">base</span>(<span class="params">Target</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    Type = TargetType.Game;</span><br><span class="line">    bUsesSteam = <span class="literal">true</span>;</span><br><span class="line">    ExtraModuleNames.AddRange(<span class="keyword">new</span> <span class="built_in">string</span>[] &#123; <span class="string">&quot;SanguoWarriors&quot;</span> &#125; );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打开项目的<code>*.build.cs</code>，额外添加 OnlineSubsystem 的模块依赖：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">PublicDependencyModuleNames.AddRange(</span><br><span class="line">        <span class="keyword">new</span> <span class="built_in">string</span>[] &#123;</span><br><span class="line">            <span class="string">&quot;OnlineSubsystem&quot;</span>,</span><br><span class="line">            <span class="string">&quot;OnlineSubsystemUtils&quot;</span>,</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">PrivateDependencyModuleNames.AddRange(</span><br><span class="line">            <span class="keyword">new</span> <span class="built_in">string</span>[] &#123;</span><br><span class="line">                <span class="string">&quot;OnlineSubsystem&quot;</span>,</span><br><span class="line">                <span class="string">&quot;OnlineSubsystemUtils&quot;</span></span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>

<p>打开项目目录下的 <code>Config/DefaultEngine.ini</code>，加入(或编辑) 以下内容：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[/Script/Engine.Engine]</span></span><br><span class="line">!<span class="attr">NetDriverDefinitions</span>=ClearArray</span><br><span class="line">+<span class="attr">NetDriverDefinitions</span>=(DefName=<span class="string">&quot;GameNetDriver&quot;</span>,DriverClassName=<span class="string">&quot;/Script/OnlineSubsystemSteam.SteamNetDriver&quot;</span>,DriverClassNameFallback=<span class="string">&quot;/Script/OnlineSubsystemUtils.IpNetDriver&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="section">[OnlineSubsystem]</span></span><br><span class="line"><span class="attr">DefaultPlatformService</span>=Steam</span><br><span class="line"><span class="attr">PollingIntervalInMs</span>=<span class="number">20</span></span><br><span class="line"></span><br><span class="line"><span class="section">[OnlineSubsystemSteam]</span></span><br><span class="line"><span class="attr">bEnabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">SteamDevAppId</span>=<span class="number">480</span></span><br><span class="line"><span class="attr">GameServerQueryPort</span>=<span class="number">27015</span></span><br><span class="line"><span class="attr">bRelaunchInSteam</span>=<span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>注意修改 SteamDevAppId 项为你自己的 Steam 内容的 AppID.<br>上面的操作完毕之后，打开 Steam(必须启动 Steam 才可以在游戏中使用 <code>Shift+Tab</code>) 唤出 Steam 的界面。</p>
<p>然后可以使用 <code>Standalone</code> 模式运行游戏，进入游戏后按下 <code>Shift+Tab</code> 如果可以唤出 Steam，即为成功。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/3231/SteamSDK/Use-SteamSdk-in-UE4.webp"></p>
<p>如果日志中出现这样的警告：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[2019.03.18-06.02.22:971][186]LogOnline: Warning: STEAM: Steamworks: SteamUtils() failed!</span><br><span class="line">[2019.03.18-06.02.22:971][186]LogOnline: Warning: STEAM: Steamworks: SteamUser() failed!</span><br><span class="line">[2019.03.18-06.02.22:972][186]LogOnline: Warning: STEAM: Steamworks: SteamFriends() failed!</span><br><span class="line">[2019.03.18-06.02.22:972][186]LogOnline: Warning: STEAM: Steamworks: SteamRemoteStorage() failed!</span><br><span class="line">[2019.03.18-06.02.22:973][186]LogOnline: Warning: STEAM: Steamworks: SteamUserStats() failed!</span><br><span class="line">[2019.03.18-06.02.22:973][186]LogOnline: Warning: STEAM: Steamworks: SteamMatchmakingServers() failed!</span><br><span class="line">[2019.03.18-06.02.22:973][186]LogOnline: Warning: STEAM: Steamworks: SteamApps() failed!</span><br><span class="line">[2019.03.18-06.02.22:973][186]LogOnline: Warning: STEAM: Steamworks: SteamNetworking() failed!</span><br><span class="line">[2019.03.18-06.02.22:974][186]LogOnline: Warning: STEAM: Steamworks: SteamMatchmaking() failed!</span><br><span class="line">[2019.03.18-06.02.22:974][186]LogOnline: Display: STEAM: OnlineSubsystemSteam::Shutdown()</span><br><span class="line">[2019.03.18-06.02.22:975][186]LogOnline: Warning: STEAM: Steam API failed to initialize!</span><br><span class="line">[2019.03.18-06.02.22:975][186]LogOnline: Display: STEAM: OnlineSubsystemSteam::Shutdown()</span><br></pre></td></tr></table></figure>
<p>这是因为启动游戏时，没有打开 Steam，先启动 Steam 再启动游戏即可。</p>
<p>打包需要注意的事情：<br>使用 Shipping 模式打包，打包完成后在打包输出的 $ProjectName\Binaries\Win64 下新建文件 steam_appid.txt，将你的 AppID 填入其中即可（如 480(Steam 的测试 AppID)）。</p>
<p><strong>外部资料</strong></p>
<ul>
<li><a href="https://partner.steamgames.com/doc/sdk">Steamworks 文献库</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Gameplay</category>
      </categories>
      <tags>
        <tag>Steam</tag>
        <tag>SteamSDK</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 集成 WWise：概念与代码分析</title>
    <url>/wiki/9809/</url>
    <content><![CDATA[<p><a href="https://www.audiokinetic.com/zh/products/wwise/">WWise</a>是 Audiokinetic 的跨平台音频引擎，可以与游戏引擎很好地进行交互，负责音频的同事可以只在 WWise 中处理音频，把游戏业务和音频的制作与管理分离，提供事件和参数给游戏引擎使用，实现与业务的解耦和对音频更精确的控制。<br>本篇文章主要介绍 WWise 与 UE4 的集成、远程构建、资源分析、文档收录，WWise 与 UE 的控制交互以及 Bank 生成的代码分析。</p>
<h2 id="集成至 UE4"><a href="# 集成至 UE4" class="headerlink" title="集成至 UE4"></a>集成至 UE4</h2><p>WWise 是全平台支持的，对 Linux/Lumin/PS4/Switch/XboxOne/Windows/Android/iOS/Mac 都支持。<br>但是多数游戏不需要支持这么多平台，WWise 链接库很大，所以我在官方版本支持的多平台基础上做了裁剪，去掉了以下平台的支持：</p>
<ul>
<li>Linux</li>
<li>Lumin</li>
<li>PS4</li>
<li>Switch</li>
<li>XboxOne</li>
</ul>
<p>对 Android 和 Windows 平台做了以下裁剪：</p>
<ul>
<li>移除 arm64-v8a 和 android_x86/x86_64 的链接库支持</li>
<li>移除 Win32 的所有链接库 / 移除 vc140/vc150 的支持</li>
</ul>
<p>对 iOS 做了以下裁剪：</p>
<ul>
<li>移除所有的 iphonesimulator，节省空间 2.31G</li>
</ul>
<p>对 Mac 的支持：</p>
<p>目前的项目是不需要支持 Mac 的（使用 iOS 远程出包），但是为了避免想要在 Mac 上跑工程编译不过的问题，保留了 Mac 链接库和模块支持，保留它不会对 Android/iOS 的打包有任何影响。</p>
<h3 id="链接库"><a href="# 链接库" class="headerlink" title="链接库"></a>链接库 </h3><p> 我在裁剪版本中支持以下平台：</p>
<ul>
<li>Android_armabi_v7a</li>
<li>iOS</li>
<li>Mac</li>
<li>Win vc160</li>
</ul>
<p>每个平台均支持 <code>Debug</code>/<code>Profile</code>/<code>Release</code> 的支持，分别对应 UE 的 <code>Debug</code>/<code>Development</code>/<code>Shipping</code> 的 Configuration 配置。</p>
<p>在打包 Android Development 的配置下，包含 WWise 的链接库，APK 增大约 30M.</p>
<h3 id="WWise 版本的问题"><a href="#WWise 版本的问题" class="headerlink" title="WWise 版本的问题"></a>WWise 版本的问题</h3><blockquote>
<p>Wwise 版本为 Wwise 2019.1.9.7221</p>
</blockquote>
<p>在 <code>AkAudio_Android.build.cs</code> 中对 Android 的的链接库支持在 <code>UE_4_25_OR_LATER</code> 下路径错误。</p>
<p>原始路径:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">Path.Combine(ThirdPartyFolder, <span class="string">&quot;Android&quot;</span>, <span class="string">&quot;armeabi-v7a&quot;</span>, akConfigurationDir, <span class="string">&quot;lib&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>实际的路径：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">Path.Combine(ThirdPartyFolder, <span class="string">&quot;Android_armeabi-v7a&quot;</span>, akConfigurationDir, <span class="string">&quot;lib&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>但是这样的修改会造成同时支持 armv7 和 arm64 时具有链接错误，解决方案看下节。</p>
<h3 id="Android 支持 armv7 和 arm64"><a href="#Android 支持 armv7 和 arm64" class="headerlink" title="Android 支持 armv7 和 arm64"></a>Android 支持 armv7 和 arm64</h3><p>当在 UE 的项目设置中为 Android 同时支持 <code>arm64</code> 和<code>armb7</code>时，上面的修改会具有链接错误，需要变动 WWise 中链接库的路径，具体的方法可以看我这篇笔记：<a href="https://imzlp.com/notes/ue/#%E5%90%8C%E6%97%B6%E6%94%AF%E6%8C%81armv7%E5%92%8Carm64%E7%9A%84%E9%93%BE%E6%8E%A5%E5%BA%93">同时支持 armv7 和 arm64 的链接库</a>。</p>
<h3 id="Android 链接库的拷贝"><a href="#Android 链接库的拷贝" class="headerlink" title="Android 链接库的拷贝"></a>Android 链接库的拷贝</h3><p>WWise 的 SDK 中同时使用 UPL 和 RuntimeDependencies 添加了链接库，造成了重复，所以可以把 RuntimeDependencies 中针对移动平台去掉：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AkAudio</span>(<span class="params">ReadOnlyTargetRules Target</span>) : <span class="title">base</span>(<span class="params">Target</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> (Target.Platform == UnrealTargetPlatform.Win64)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">foreach</span>(<span class="keyword">var</span> RuntimeDependency <span class="keyword">in</span> AkUEPlatformInstance.GetRuntimeDependencies())</span><br><span class="line">		&#123;</span><br><span class="line">			RuntimeDependencies.Add(RuntimeDependency);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="远程构建 iOS"><a href="# 远程构建 iOS" class="headerlink" title="远程构建 iOS"></a>远程构建 iOS</h3><p>在我之前的笔记中写到过，远程构建 iOS 实际就是要把文件上传的 Mac 上执行编译，但是这就有一个问题，如果需要参与编译的文件没有被上传到 Mac 上，就会出现错误，很不巧在 WWise 中就会出现这个问题，解决的办法自然是要把编译 WWise 依赖的文件给上传到 Mac 上。</p>
<p>因为 UE 使用 <code>RSync</code> 来同步构建机和本地的文件传输，在我之前的文章 <a href="https://imzlp.com/posts/1948/#%E9%85%8D%E7%BD%AE%E8%BF%9C%E7%A8%8B%E6%9E%84%E5%BB%BA">UE4 开发笔记：Mac/iOS 篇 #配置远程构建</a> 有讲到，可以创建 <code>&lt;ProjectDir&gt;/Build/Rsync/RsyncProject.txt</code> 文件，来写入 RSync 的文件同步规则，把需要的文件上传到 Mac 中。</p>
<p>WWise 需要的规则如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+ /Plugins/Wwise/ThirdParty/include/**</span><br><span class="line">+ /Plugins/Wwise/ThirdParty/iOS/**</span><br></pre></td></tr></table></figure>
<p>其实就是指定 WWise 的链接库和 Include 目录全上传到 Mac 上。</p>
<h2 id="WWise 资源"><a href="#WWise 资源" class="headerlink" title="WWise 资源"></a>WWise 资源 </h2><p>WWise 在 UE 中有两种资源格式，一种是<code>UAkAudioEvent</code> 用来执行 WWise 中指定的 Event，还有一种是<code>UAkAudioBank</code>，用来记录 Bank 中包含哪些 Event，用在生成时标记把属于相同 Bank 的 Event 打包到一起。</p>
<h3 id="UAkAudioEvent"><a href="#UAkAudioEvent" class="headerlink" title="UAkAudioEvent"></a>UAkAudioEvent</h3><ul>
<li><a href="https://www.audiokinetic.com/zh/library/edge/?source=SDK&id=concept_events.html">AudioEvent</a></li>
</ul>
<p><code>UAkAudioEvent</code>：主要作用是指定当前 Event 的 Bank，它唯一的函数就是 <code>LoadBank</code> 来加载当前 Event 所指定的 Bank（看到有用到的地方就是获取它的名字），WWise 集成到 UE 的插件也是通过拿到 <code>UAkAudioEvent</code> 对象的名字来与 <code>UAkAudioBank</code> 做绑定之后去 <code>WWise</code> 端生成 bnk 等文件的，这也是要求 UE 中资源的命名要和 WWise 中 Event 的命名完全一致的原因。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UCLASS</span>(meta=(BlueprintSpawnableComponent))</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AKAUDIO_API</span> <span class="title">UAkAudioEvent</span> :</span> <span class="keyword">public</span> UObject</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_UCLASS_BODY</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">/** Bank to which this event should be added. */</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditAnywhere, BlueprintReadWrite, Category=<span class="string">&quot;Bank&quot;</span>)</span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">UAkAudioBank</span> * <span class="title">RequiredBank</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Maximum attenuation radius for this event */</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(BlueprintReadOnly, Category=<span class="string">&quot;AkAudioEvent&quot;</span>)</span><br><span class="line">	<span class="keyword">float</span> MaxAttenuationRadius;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Whether this event is infinite (looping) or finite (duration parameters are valid) */</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(BlueprintReadOnly, Category = <span class="string">&quot;AkAudioEvent&quot;</span>)</span><br><span class="line">	<span class="keyword">bool</span> IsInfinite;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Minimum duration */</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(BlueprintReadOnly, Category = <span class="string">&quot;AkAudioEvent&quot;</span>)</span><br><span class="line">	<span class="keyword">float</span> MinimumDuration;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Maximum duration */</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(BlueprintReadOnly, Category = <span class="string">&quot;AkAudioEvent&quot;</span>)</span><br><span class="line">	<span class="keyword">float</span> MaximumDuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> CPP</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Load the required bank.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @return true if the bank was loaded, otherwise false</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">LoadBank</span><span class="params">()</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>通过获取 Event 的名字再传递给更深层次的 PostEvent：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">int32 <span class="title">UAkGameplayStatics::PostEvent</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	  class UAkAudioEvent* AkEvent</span></span></span><br><span class="line"><span class="params"><span class="function">	, class AActor* Actor</span></span></span><br><span class="line"><span class="params"><span class="function">	, int32 CallbackMask</span></span></span><br><span class="line"><span class="params"><span class="function">	, <span class="keyword">const</span> FOnAkPostEventCallback&amp; PostEventCallback</span></span></span><br><span class="line"><span class="params"><span class="function">	, <span class="keyword">const</span> TArray&lt;FAkExternalSourceInfo&gt;&amp; ExternalSources</span></span></span><br><span class="line"><span class="params"><span class="function">	, <span class="keyword">bool</span> bStopWhenAttachedToDestroyed</span></span></span><br><span class="line"><span class="params"><span class="function">	, FString EventName</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (AkEvent == <span class="literal">NULL</span> &amp;&amp; EventName.<span class="built_in">IsEmpty</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">UE_LOG</span>(LogScript, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;UAkGameplayStatics::PostEvent: No Event specified!&quot;</span>));</span><br><span class="line">		<span class="keyword">return</span> AK_INVALID_PLAYING_ID;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (Actor == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">UE_LOG</span>(LogScript, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;UAkGameplayStatics::PostEvent: NULL Actor specified!&quot;</span>));</span><br><span class="line">		<span class="keyword">return</span> AK_INVALID_PLAYING_ID;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">AkDeviceAndWorld <span class="title">DeviceAndWorld</span><span class="params">(Actor)</span></span>;</span><br><span class="line">	<span class="keyword">if</span> (DeviceAndWorld.<span class="built_in">IsValid</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		AkCallbackType AkCallbackMask = AkCallbackTypeHelpers::<span class="built_in">GetCallbackMaskFromBlueprintMask</span>(CallbackMask);</span><br><span class="line">		<span class="keyword">if</span> (ExternalSources.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="function">FAkSDKExtrernalSourceArray <span class="title">SDKExternalSrcInfo</span><span class="params">(ExternalSources)</span></span>;</span><br><span class="line">			<span class="keyword">return</span> DeviceAndWorld.AkAudioDevice-&gt;<span class="built_in">PostEvent</span>(<span class="built_in">GET_AK_EVENT_NAME</span>(AkEvent, EventName), Actor, PostEventCallback, AkCallbackMask, <span class="literal">false</span>, SDKExternalSrcInfo.ExternalSourceArray);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> DeviceAndWorld.AkAudioDevice-&gt;<span class="built_in">PostEvent</span>(<span class="built_in">GET_AK_EVENT_NAME</span>(AkEvent, EventName), Actor, PostEventCallback, AkCallbackMask);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> AK_INVALID_PLAYING_ID;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="UAkAudioBank"><a href="#UAkAudioBank" class="headerlink" title="UAkAudioBank"></a>UAkAudioBank</h3><p><code>UAkAudioBank</code>的作用是用来调用 <code>AkAudioDevice</code> 来加载 Bank，如果在 UE 中开启了 AutoLoad，则在 UObejct 的 <code>PostLoad</code> 中就会去执行加载。</p>
<p>官方的对于 SoundBank 的介绍：<a href="https://www.audiokinetic.com/zh/library/edge/?source=SDK&id=concept_banks.html">SoundBank</a></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Called after load process is complete.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UAkAudioBank::PostLoad</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Super::<span class="built_in">PostLoad</span>();</span><br><span class="line">	<span class="keyword">if</span> (AutoLoad &amp;&amp; !<span class="built_in">HasAnyFlags</span>(RF_ClassDefaultObject))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">Load</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Loads an AkBank.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return Returns true if the laod was successful, otherwise false</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UAkAudioBank::Load</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">IsRunningCommandlet</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		FAkAudioDevice * AudioDevice = FAkAudioDevice::<span class="built_in">Get</span>();</span><br><span class="line">		<span class="keyword">if</span> (AudioDevice)</span><br><span class="line">		&#123;</span><br><span class="line">			AkBankID BankID;</span><br><span class="line">			AKRESULT eResult = AudioDevice-&gt;<span class="built_in">LoadBank</span>(<span class="keyword">this</span>, AK_DEFAULT_POOL_ID, BankID);</span><br><span class="line">			<span class="keyword">return</span> (eResult == AK_Success) ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而且 LoadBank 我看到使用的也是和 <code>AkAudioEvent</code> 类似，也是通过获取它的名字传递给<code>FAkAudioDevices</code>。</p>
<h3 id="Bank 的生成分析"><a href="#Bank 的生成分析" class="headerlink" title="Bank 的生成分析"></a>Bank 的生成分析 </h3><p> 那么 <code>AkAudioEvent</code> 是如何与 <code>SoundBank</code> 进行关联起来的呢？因为我在代码里只看到使用之前需要<code>LoadBank</code>，但是没有看到在 UE 资源里 SounkBnak 和 Event 进行关联起来的地方，而且，SoundBank 的命名与在 WWise 中也没有关系。</p>
<p>答案就在通过 <code>AkSoundBank</code> 生成的文件上，在对 <code>AkSoundBank</code> 资源进行 <code>Generate Selected SoundBank</code> 时：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9809/ue-generate-wwise-bank.webp"></p>
<p>会在项目设置中的 <code>WwiseSoundBankFolder</code> 目录下创建出以下文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\WWise\WwiseDemoGame\Content\WwiseAudio\Windows&gt;tree /a /f</span><br><span class="line">D:.</span><br><span class="line">|   Init.bnk</span><br><span class="line">|   Init.json</span><br><span class="line">|   Init.txt</span><br><span class="line">|   Init.xml</span><br><span class="line">|   PluginInfo.json</span><br><span class="line">|   PluginInfo.xml</span><br><span class="line">|   SoundbanksInfo.json</span><br><span class="line">|   SoundbanksInfo.xml</span><br><span class="line">|   SwitchBank.bnk</span><br><span class="line">|   SwitchBank.json</span><br><span class="line">|   SwitchBank.txt</span><br><span class="line">|   SwitchBank.xml</span><br><span class="line">|   VelocityBank.bnk</span><br><span class="line">|   VelocityBank.json</span><br><span class="line">|   VelocityBank.txt</span><br><span class="line">|   VelocityBank.xml</span><br></pre></td></tr></table></figure>

<p>其中 <code>Init.*</code> 相关的四个文件是必备的 Init 的 Bank 的内容。每个 Bank 都会生成 <code>.bnk</code>/<code>.json</code>/<code>.txt</code>/<code>.xml</code> 四个文件，UE 加载 bank 需要用到的就是 <code>.bnk</code> 文件，经过测试，删掉其他的几个文件也没什么问题。</p>
<ul>
<li>bnk：数据文件，*.<strong>Bnk</strong>可以存储事件的详细信息、音频、其他插件所需要的数据结构。可以简单理解为是一个 数据存放的容器。该文件可以在运行中自由的控制加、卸载。</li>
<li>json：描述文件，用于记录当前的 bank 中有哪些数据、哪些 Event 等等，以及对应的 Event 在 WWise 工程中的路径。</li>
</ul>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;SoundBanksInfo&quot;</span>: &#123;</span><br><span class="line">  <span class="attr">&quot;Platform&quot;</span>: <span class="string">&quot;Windows&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;BasePlatform&quot;</span>: <span class="string">&quot;Windows&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;SchemaVersion&quot;</span>: <span class="string">&quot;11&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;SoundbankVersion&quot;</span>: <span class="string">&quot;134&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;RootPaths&quot;</span>: &#123;</span><br><span class="line">   <span class="attr">&quot;ProjectRoot&quot;</span>: <span class="string">&quot;C:\\Users\\lipengzha\\Desktop\\WWise\\WwiseDemoGame\\UnrealWwiseDemo\\&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;SourceFilesRoot&quot;</span>: <span class="string">&quot;C:\\Users\\lipengzha\\Desktop\\WWise\\WwiseDemoGame\\UnrealWwiseDemo\\.cache\\Windows\\&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;SoundBanksRoot&quot;</span>: <span class="string">&quot;C:\\Users\\lipengzha\\Desktop\\WWise\\WwiseDemoGame\\Content\\WwiseAudio\\Windows\\&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;ExternalSourcesInputFile&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;ExternalSourcesOutputRoot&quot;</span>: <span class="string">&quot;C:\\Users\\lipengzha\\Desktop\\WWise\\WwiseDemoGame\\UnrealWwiseDemo\\GeneratedSoundBanks\\Windows&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;SoundBanks&quot;</span>: [</span><br><span class="line">   &#123;</span><br><span class="line">    <span class="attr">&quot;Id&quot;</span>: <span class="string">&quot;2001541346&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;Language&quot;</span>: <span class="string">&quot;SFX&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;ObjectPath&quot;</span>: <span class="string">&quot;\\SoundBanks\\Default Work Unit\\VelocityBank&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;ShortName&quot;</span>: <span class="string">&quot;VelocityBank&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;VelocityBank.bnk&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;IncludedEvents&quot;</span>: [</span><br><span class="line">     &#123;</span><br><span class="line">      <span class="attr">&quot;Id&quot;</span>: <span class="string">&quot;2099597577&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Name&quot;</span>: <span class="string">&quot;PlayRederenceSoundTest&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;ObjectPath&quot;</span>: <span class="string">&quot;\\Events\\Default Work Unit\\PlayRederenceSoundTest&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;DurationType&quot;</span>: <span class="string">&quot;OneShot&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;DurationMin&quot;</span>: <span class="string">&quot;1.338833&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;DurationMax&quot;</span>: <span class="string">&quot;1.338833&quot;</span></span><br><span class="line">     &#125;,</span><br><span class="line">     &#123;</span><br><span class="line">      <span class="attr">&quot;Id&quot;</span>: <span class="string">&quot;3368745218&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Name&quot;</span>: <span class="string">&quot;VelocityLoop&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;ObjectPath&quot;</span>: <span class="string">&quot;\\Events\\Default Work Unit\\VelocityLoop&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;DurationType&quot;</span>: <span class="string">&quot;Infinite&quot;</span></span><br><span class="line">     &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;IncludedMemoryFiles&quot;</span>: [</span><br><span class="line">     &#123;</span><br><span class="line">      <span class="attr">&quot;Id&quot;</span>: <span class="string">&quot;386490851&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Language&quot;</span>: <span class="string">&quot;SFX&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;ShortName&quot;</span>: <span class="string">&quot;Shotgun_Fire_01.wav&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;SFX\\Shotgun_Fire_01_A07A4AEB.wem&quot;</span></span><br><span class="line">     &#125;</span><br><span class="line">    ]</span><br><span class="line">   &#125;</span><br><span class="line">  ]</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>xml：描述文件，与 json 表示的内容相同</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SoundBanksInfo</span> <span class="attr">Platform</span>=<span class="string">&quot;Windows&quot;</span> <span class="attr">BasePlatform</span>=<span class="string">&quot;Windows&quot;</span> <span class="attr">SchemaVersion</span>=<span class="string">&quot;11&quot;</span> <span class="attr">SoundbankVersion</span>=<span class="string">&quot;134&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">RootPaths</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">ProjectRoot</span>&gt;</span>C:\Users\lipengzha\Desktop\WWise\WwiseDemoGame\UnrealWwiseDemo\<span class="tag">&lt;/<span class="name">ProjectRoot</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">SourceFilesRoot</span>&gt;</span>C:\Users\lipengzha\Desktop\WWise\WwiseDemoGame\UnrealWwiseDemo\.cache\Windows\<span class="tag">&lt;/<span class="name">SourceFilesRoot</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">SoundBanksRoot</span>&gt;</span>C:\Users\lipengzha\Desktop\WWise\WwiseDemoGame\Content\WwiseAudio\Windows\<span class="tag">&lt;/<span class="name">SoundBanksRoot</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">ExternalSourcesInputFile</span>&gt;</span><span class="tag">&lt;/<span class="name">ExternalSourcesInputFile</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">ExternalSourcesOutputRoot</span>&gt;</span>C:\Users\lipengzha\Desktop\WWise\WwiseDemoGame\UnrealWwiseDemo\GeneratedSoundBanks\Windows<span class="tag">&lt;/<span class="name">ExternalSourcesOutputRoot</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">RootPaths</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">SoundBanks</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">SoundBank</span> <span class="attr">Id</span>=<span class="string">&quot;2001541346&quot;</span> <span class="attr">Language</span>=<span class="string">&quot;SFX&quot;</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">ObjectPath</span>&gt;</span>\SoundBanks\Default Work Unit\VelocityBank<span class="tag">&lt;/<span class="name">ObjectPath</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">ShortName</span>&gt;</span>VelocityBank<span class="tag">&lt;/<span class="name">ShortName</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">Path</span>&gt;</span>VelocityBank.bnk<span class="tag">&lt;/<span class="name">Path</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">IncludedEvents</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">Event</span> <span class="attr">Id</span>=<span class="string">&quot;2099597577&quot;</span> <span class="attr">Name</span>=<span class="string">&quot;PlayRederenceSoundTest&quot;</span> <span class="attr">ObjectPath</span>=<span class="string">&quot;\Events\Default Work Unit\PlayRederenceSoundTest&quot;</span> <span class="attr">DurationType</span>=<span class="string">&quot;OneShot&quot;</span> <span class="attr">DurationMin</span>=<span class="string">&quot;1.338833&quot;</span> <span class="attr">DurationMax</span>=<span class="string">&quot;1.338833&quot;</span>/&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">Event</span> <span class="attr">Id</span>=<span class="string">&quot;3368745218&quot;</span> <span class="attr">Name</span>=<span class="string">&quot;VelocityLoop&quot;</span> <span class="attr">ObjectPath</span>=<span class="string">&quot;\Events\Default Work Unit\VelocityLoop&quot;</span> <span class="attr">DurationType</span>=<span class="string">&quot;Infinite&quot;</span>/&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">IncludedEvents</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">IncludedMemoryFiles</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">File</span> <span class="attr">Id</span>=<span class="string">&quot;386490851&quot;</span> <span class="attr">Language</span>=<span class="string">&quot;SFX&quot;</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">ShortName</span>&gt;</span>Shotgun_Fire_01.wav<span class="tag">&lt;/<span class="name">ShortName</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">Path</span>&gt;</span>SFX\Shotgun_Fire_01_A07A4AEB.wem<span class="tag">&lt;/<span class="name">Path</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">File</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">IncludedMemoryFiles</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">SoundBank</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">SoundBanks</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">SoundBanksInfo</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>txt：也是描述文件，但和 json 和 xml 中的内容相比少了一些（不过基础的 Event ID、EventName、）。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Event	ID	Name			Wwise Object Path	Notes</span><br><span class="line">	2099597577	PlayRederenceSoundTest			\Default Work Unit\PlayRederenceSoundTest	</span><br><span class="line">	3368745218	VelocityLoop			\Default Work Unit\VelocityLoop	</span><br><span class="line"></span><br><span class="line">Game Parameter	ID	Name			Wwise Object Path	Notes</span><br><span class="line">	3519441192	Velocity			\Default Work Unit\Velocity	</span><br><span class="line"></span><br><span class="line">Source plug-ins	ID	Name	Type		Wwise Object Path	Notes</span><br><span class="line">	778067245	Wwise Tone Generator	Wwise Tone Generator		\Actor-Mixer Hierarchy\RTPCDemo\VelocityLoop\Wwise Tone Generator	</span><br><span class="line"></span><br><span class="line">In Memory Audio	ID	Name	Audio source file		Wwise Object Path	Notes	Data Size</span><br><span class="line">	386490851	RederenceSound	C:\Users\lipengzha\Desktop\WWise\WwiseDemoGame\UnrealWwiseDemo\.cache\Windows\SFX\Shotgun_Fire_01_A07A4AEB.wem		\Actor-Mixer Hierarchy\Default Work Unit\RederenceSound		257120</span><br></pre></td></tr></table></figure>

<p><code>UAkGameplayStatics</code>中的类似 <code>Post*</code> 传递 Actor 的作用是获取 World，并且在从该 Actor 上获取<code>AkComponent</code>（若没有就创建，并 Attach 到该 Actor 的 RootComponent 上）：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AkDeviceAndWorld</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	FAkAudioDevice* AkAudioDevice;</span><br><span class="line">	UWorld* CurrentWorld;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">AkDeviceAndWorld</span>(AActor* in_pActor) :</span><br><span class="line">		<span class="built_in">AkAudioDevice</span>(FAkAudioDevice::<span class="built_in">Get</span>()),</span><br><span class="line">		<span class="built_in">CurrentWorld</span>(in_pActor ? in_pActor-&gt;<span class="built_in">GetWorld</span>() : <span class="literal">nullptr</span>)</span><br><span class="line">	&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">AkDeviceAndWorld</span>(UObject* in_pWorldContextObject) :</span><br><span class="line">		<span class="built_in">AkAudioDevice</span>(FAkAudioDevice::<span class="built_in">Get</span>()),</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UE_4_17_OR_LATER</span></span><br><span class="line">		<span class="built_in">CurrentWorld</span>(GEngine-&gt;<span class="built_in">GetWorldFromContextObject</span>(in_pWorldContextObject, EGetWorldErrorMode::ReturnNull))</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		<span class="built_in">CurrentWorld</span>(GEngine-&gt;<span class="built_in">GetWorldFromContextObject</span>(in_pWorldContextObject))</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// UE_4_17_OR_LATER</span></span></span><br><span class="line">	&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">IsValid</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> (CurrentWorld &amp;&amp; CurrentWorld-&gt;<span class="built_in">AllowAudioPlayback</span>() &amp;&amp; AkAudioDevice); &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通过 Event 来指定 SoundBank，然后对 SoundBank 执行<code>Generated  Selected Bank</code>，流程如下:</p>
<ol>
<li>根据所选择的 SoundBank 得到 SoundBank 的名字列表</li>
<li>获取引擎中所有的 UAkAudioEvent 对象，通过分析 AkSoundEvent 中 <code>RequireBank</code> 的名字与第一步中获取的 SoundBank 中的名字是否匹配，从而得到 SoundBank 中所有的<code>AkAudioEvent</code>；</li>
<li>根据以上两步分析的结果生成<code>SoundBankDefinitionFile</code>，存储在 UE 的项目目录下，名字为<code>TempDifinitionFile.txt</code></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">VelocityBank	&quot;PlayRederenceSoundTest&quot;</span><br><span class="line">VelocityBank	&quot;VelocityLoop&quot;</span><br><span class="line">ExtSrcBnk	&quot;Play_MyExtSrc&quot;</span><br><span class="line">AmbientBank	&quot;AmbientNoise_NotSpatialized&quot;</span><br><span class="line">AmbientBank	&quot;AmbientNoise_Spatialized&quot;</span><br><span class="line">ReverbBank	&quot;Fire_Weapon&quot;</span><br><span class="line">MatineeBank	&quot;Closed_Hi_Hat&quot;</span><br><span class="line">MatineeBank	&quot;Kick&quot;</span><br><span class="line">MatineeBank	&quot;Snare&quot;</span><br><span class="line">SubtitleBank	&quot;Play_Subtitles&quot;</span><br><span class="line">SwitchBank	&quot;Play_Tone&quot;</span><br></pre></td></tr></table></figure>

<p>里面记录了 UE 里的 SoundBank 对象与其关联的 <code>Event</code> 以及 <code>Bus</code> 的名字，通过 <code>-ImportDefinitionFile</code> 参数传递给 <code>WwiseCLI.exe</code>，从而让 WWise 端知道 UE 侧 SoundBank 和<code>Event</code> 之间的对应关系。</p>
<ol start="4">
<li>WWise 端根据传入进来的 <code>ImportDefinitionFile</code> 文件，根据 WWise 工程里的 Event 以及 Bus 等匹配，产生出来包含指定 Event 的 SoundBank，并生成 <code>json</code>/<code>xml</code>/<code>txt</code> 等描述文件。</li>
</ol>
<p>UE 通过 <code>LoadBank</code> 的加载流程应该是：</p>
<ol>
<li>通过 Bank 对象拿到 Bank 的名字</li>
<li>根据 Bank 名字去 <code>WwiseSoundBankFolder</code> 目录下查找同名的 bnk 文件</li>
<li>拿到 bnk 文件，进行加载</li>
</ol>
<h2 id="UE 与 WWise 的交互"><a href="#UE 与 WWise 的交互" class="headerlink" title="UE 与 WWise 的交互"></a>UE 与 WWise 的交互 </h2><p> 在 UE 中可以使用 WWise 的 API 来播放和控制声音的一些介绍。</p>
<h3 id="PlaySoundAtLocation"><a href="#PlaySoundAtLocation" class="headerlink" title="PlaySoundAtLocation"></a>PlaySoundAtLocation</h3><p>API 均在<code>UAkGameplayStatics</code>：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** Posts a Wwise Event at the specified location. This is a fire and forget sound, created on a temporary Wwise Game Object. Replication is also not handled at this point.</span></span><br><span class="line"><span class="comment"> * @param AkEvent - Wwise Event to post.</span></span><br><span class="line"><span class="comment"> * @param Location - Location from which to post the Wwise Event.</span></span><br><span class="line"><span class="comment"> * @param Orientation - Orientation of the event.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">UFUNCTION</span>(BlueprintCallable, BlueprintCosmetic, Category=<span class="string">&quot;Audiokinetic&quot;</span>, meta=(WorldContext=<span class="string">&quot;WorldContextObject&quot;</span>, AdvancedDisplay = <span class="string">&quot;3&quot;</span>))</span><br><span class="line"><span class="function"><span class="keyword">static</span> int32 <span class="title">PostEventAtLocation</span><span class="params">(class UAkAudioEvent* AkEvent, FVector Location, FRotator Orientation, <span class="keyword">const</span> FString&amp; EventName, UObject* WorldContextObject )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Posts a Wwise Event by name at the specified location. This is a fire and forget sound, created on a temporary Wwise Game Object. Replication is also not handled at this point.</span></span><br><span class="line"><span class="comment"> * @param AkEvent - Wwise Event to post.</span></span><br><span class="line"><span class="comment"> * @param Location - Location from which to post the Wwise Event.</span></span><br><span class="line"><span class="comment"> * @param Orientation - Orientation of the event.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">UFUNCTION</span>(BlueprintCallable, BlueprintCosmetic, Category=<span class="string">&quot;Audiokinetic&quot;</span>, meta=(WorldContext=<span class="string">&quot;WorldContextObject&quot;</span>, DeprecatedFunction, DeprecationMessage = <span class="string">&quot;Please use the \&quot;Event Name\&quot; field of PostEventAtLocation&quot;</span>))</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">PostEventAtLocationByName</span><span class="params">(<span class="keyword">const</span> FString&amp; EventName, FVector Location, FRotator Orientation, UObject* WorldContextObject )</span></span>;</span><br></pre></td></tr></table></figure>

<p>这两个 API 可以通过传递 <code>AkAudioEvent</code> 的资源或者 Event 的名字来在指定的位置播放声音。<code>PostEventAtLocationByName</code>是 <code>UAkGameplatStatics::PostEventAtLocation</code> 的封装版本，AkAudioEvent 为 NULL。</p>
<h3 id="PostEvent"><a href="#PostEvent" class="headerlink" title="PostEvent"></a>PostEvent</h3><p>发送给定 Actor 的根组件绑定和控制的 Wwise Event。如果传递进来的 Actor 上没有挂载 AkComponent，会在 PostEvent 上创建出来一个组件，并默认 Attach 到该 Actor 的 RootComponent。</p>
<p>在 PostEvent 之后，如果后续需要控制 Event 的值，如 RTPC 或者 Switch 等，要传入对应的 Actor（因为 PostEvent 本质上是要通过<code>AkComponent</code>）：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">AkPlayingID <span class="title">FAkAudioDevice::PostEvent</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">const</span> FString&amp; in_EventName,</span></span></span><br><span class="line"><span class="params"><span class="function">	UAkComponent* in_pComponent,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">const</span> FOnAkPostEventCallback&amp; PostEventCallback,</span></span></span><br><span class="line"><span class="params"><span class="function">	AkUInt32 in_uFlags, <span class="comment">/*= 0*/</span></span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">const</span> TArray&lt;AkExternalSourceInfo&gt;&amp; in_ExternalSources <span class="comment">/*= TArray&lt;AkExternalSourceInfo&gt;()*/</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">PostEvent</span>(in_EventName, in_pComponent, in_ExternalSources, [PostEventCallback, in_uFlags, <span class="keyword">this</span>](AkGameObjectID gameObjID) &#123;</span><br><span class="line">		<span class="keyword">return</span> CallbackManager-&gt;<span class="built_in">CreateCallbackPackage</span>(PostEventCallback, in_uFlags, gameObjID);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>目前我的理解为：传入进去的 Actor(上的 AkComponent)是 WWise 播放声音的上下文，通过这个上下文可以在另外的操作中去控制指定的 Event.</p>
<p>而 PostEvent 还具有多种类型的回调函数，控制其的方式是传递进去的 Mask 值，它由 EAkCallbackType 枚举值控制(bitmask)：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> int32 <span class="title">PostEvent</span><span class="params">(class UAkAudioEvent* AkEvent, </span></span></span><br><span class="line"><span class="params"><span class="function">						class AActor* Actor, </span></span></span><br><span class="line"><span class="params"><span class="function">						UPARAM(meta = (Bitmask, BitmaskEnum = EAkCallbackType)) int32 CallbackMask,</span></span></span><br><span class="line"><span class="params"><span class="function">						<span class="keyword">const</span> FOnAkPostEventCallback&amp; PostEventCallback,</span></span></span><br><span class="line"><span class="params"><span class="function">						<span class="keyword">const</span> TArray&lt;FAkExternalSourceInfo&gt;&amp; ExternalSources,</span></span></span><br><span class="line"><span class="params"><span class="function">						<span class="keyword">bool</span> bStopWhenAttachedToDestroyed = <span class="literal">false</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">						FString EventName = FString(<span class="string">&quot;&quot;</span>))</span></span>;</span><br></pre></td></tr></table></figure>

<p>EAkCallbackType 的可选值：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/// Type of callback. Used as a bitfield in methods AK::SoundEngine::PostEvent() and AK::SoundEngine::DynamicSequence::Open().</span></span><br><span class="line"><span class="built_in">UENUM</span>(BlueprintType, meta = (Bitmask))</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="title">EAkCallbackType</span> :</span> uint8</span><br><span class="line">&#123;</span><br><span class="line">	EndOfEvent = <span class="number">0</span>			<span class="built_in">UMETA</span>(ToolTip = <span class="string">&quot;Callback triggered when reaching the end of an event. AkCallbackInfo can be cast to AkEventCallbackInfo.&quot;</span>),</span><br><span class="line">	Marker = <span class="number">2</span>				<span class="built_in">UMETA</span>(ToolTip = <span class="string">&quot;Callback triggered when encountering a marker during playback. AkCallbackInfo can be cast to AkMarkerCallbackInfo.&quot;</span>),</span><br><span class="line">	Duration = <span class="number">3</span>			<span class="built_in">UMETA</span>(ToolTip = <span class="string">&quot;Callback triggered when the duration of the sound is known by the sound engine. AkCallbackInfo can be cast to AkDurationCallbackInfo.&quot;</span>),</span><br><span class="line"></span><br><span class="line">	Starvation = <span class="number">5</span>			<span class="built_in">UMETA</span>(ToolTip = <span class="string">&quot;Callback triggered when playback skips a frame due to stream starvation. AkCallbackInfo can be cast to AkEventCallbackInfo.&quot;</span>),</span><br><span class="line">	</span><br><span class="line">	MusicPlayStarted = <span class="number">7</span>	<span class="built_in">UMETA</span>(ToolTip = <span class="string">&quot;Callback triggered when a Play or Seek command has been executed (Seek commands are issued from AK::SoundEngine::SeekOnEvent()). Applies to objects of the Interactive-Music Hierarchy only. AkCallbackInfo can be cast to AkEventCallbackInfo.&quot;</span>),</span><br><span class="line"></span><br><span class="line">	MusicSyncBeat = <span class="number">8</span>		<span class="built_in">UMETA</span>(ToolTip = <span class="string">&quot;Enable notifications on Music Beat. AkCallbackInfo can be cast to AkMusicSyncCallbackInfo.&quot;</span>),</span><br><span class="line">	MusicSyncBar = <span class="number">9</span>		<span class="built_in">UMETA</span>(ToolTip = <span class="string">&quot;Enable notifications on Music Bar. AkCallbackInfo can be cast to AkMusicSyncCallbackInfo.&quot;</span>),</span><br><span class="line">	MusicSyncEntry = <span class="number">10</span>		<span class="built_in">UMETA</span>(ToolTip = <span class="string">&quot;Enable notifications on Music Entry Cue. AkCallbackInfo can be cast to AkMusicSyncCallbackInfo.&quot;</span>),</span><br><span class="line">	MusicSyncExit = <span class="number">11</span>		<span class="built_in">UMETA</span>(ToolTip = <span class="string">&quot;Enable notifications on Music Exit Cue. AkCallbackInfo can be cast to AkMusicSyncCallbackInfo.&quot;</span>),</span><br><span class="line">	MusicSyncGrid = <span class="number">12</span>		<span class="built_in">UMETA</span>(ToolTip = <span class="string">&quot;Enable notifications on Music Grid. AkCallbackInfo can be cast to AkMusicSyncCallbackInfo.&quot;</span>),</span><br><span class="line">	MusicSyncUserCue = <span class="number">13</span>	<span class="built_in">UMETA</span>(ToolTip = <span class="string">&quot;Enable notifications on Music Custom Cue. AkCallbackInfo can be cast to AkMusicSyncCallbackInfo.&quot;</span>),</span><br><span class="line">	MusicSyncPoint = <span class="number">14</span>		<span class="built_in">UMETA</span>(ToolTip = <span class="string">&quot;Enable notifications on Music switch transition synchronization point. AkCallbackInfo can be cast to AkMusicSyncCallbackInfo.&quot;</span>),</span><br><span class="line"></span><br><span class="line">	MIDIEvent = <span class="number">16</span>			<span class="built_in">UMETA</span>(ToolTip = <span class="string">&quot;Enable notifications for MIDI events. AkCallbackInfo can be cast to AkMIDIEventCallbackInfo.&quot;</span>),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>EndOfEvent：事件结束时触发回调；能够转换到 AkEventCallbackInfo</li>
<li>Marker：遇到标记时触发回调；能够转换到 AkMarkerCallbackInfo</li>
<li>Duration：当 Sound Engine 知道当前声音的持续时间时触发回调；能够转换到 AkDurationCallbackInfo</li>
<li>Starvation：当播放由于流不足而跳过下一帧时触发回调；能够转换到 AkEventCallbackInfo</li>
<li>MusicPlayStarted：当执行 Play 或者 Seek 时触发（从 AK::SoundEngine::SeekOnEvent 发出搜索命令），只适用于交互音乐层次结构的对象。能够转换到 AkEventCallbackInfo</li>
<li>MusicSyncBeat：在 Music beat 上启用通知；能够转换到 AkMusicSyncCallbackInfo</li>
<li>MusicSyncBar：在 Music Bar 上启用通知；能够转换到 AkMusicSyncCallbackInfo</li>
<li>MusicSyncEntry：在 Music Entry 上启用通知；能够转换到 AkMusicSyncCallbackInfo</li>
<li>MusicSyncExit：在 Music Exit 上启用通知；能够转换到 AkMusicSyncCallbackInfo</li>
<li>MusicSyncGrid：在 Music Grid 上启用通知；能够转换到 AkMusicSyncCallbackInfo</li>
<li>MusicSyncPoint：在 Music switch transition synchronization point 上启用通知；能够转换到 AkMusicSyncCallbackInfo</li>
<li>MIDIEvent：为 MIDI 事件启用通知；能够转换到 AkMIDIEventCallbackInfo</li>
</ul>
<h3 id="Marker"><a href="#Marker" class="headerlink" title="Marker"></a>Marker</h3><p>在 WWise 编辑器中添加的 <code>Sound VFX</code> 里添加的 Audio 可以通过编辑来添加 Marker，Marker 可以在 UE 调用 <code>UAkGameplayStatics::PostEvent</code> 时将 <code>CallbakMask</code> 参数设置为<code>EAkCallbackType::Marker</code>，这样可以在回调函数中接收每次播放到 WWise 中添加 Marker 的位置，用于在游戏逻辑中做一些事情，比如显示音频对应的字幕。</p>
<p>UE 中监听：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9809/ue-wwise-callbak-marker.webp"></p>
<p>而且 <code>Identifier</code> 也是从 0 开始的：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9809/ue-wwise-callbak-marker-print.webp"></p>
<p>WWise 中添加 Marker：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9809/Wwise-edit-marker.webp"></p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9809/Wwise-edit-marker2.webp"></p>
<p>在 UE 里 <code>PostEvent</code> 时可以把 <code>CallbackMask</code> 的值添加上<code>Marker</code>，就可以在绑定的事件中接收播放过程中每次遇到的 Marker 了。可以用在播放的过程中监听显示字幕。</p>
<h3 id="RTPC"><a href="#RTPC" class="headerlink" title="RTPC"></a>RTPC</h3><blockquote>
<p>Real-time Parameter Controls（实时参数控制，RTPC）用于根据游戏中发生的实时参数变化，实时控制各种 Wwise 对象（包括音效对象、容器、总线、效果器等）的特定属性。</p>
</blockquote>
<p>RTPC 可以由程序端传递值给 WWiese 端，WWise 端可以根据 传入的值控制声音。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9809/ue-wwise-SetRTPCValue.webp"></p>
<p>在 WWise 中 RTPC：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9809/WWise-RTPC-view.webp"></p>
<h3 id="Switch"><a href="#Switch" class="headerlink" title="Switch"></a>Switch</h3><p>使用 Switch 可以在引擎中切换不同的模式，比如玩家走在不同地面上的声音。</p>
<ul>
<li><a href="https://www.audiokinetic.com/zh/library/edge/?source=SDK&id=concept_switch.html">概念：Switch</a></li>
</ul>
<p>在 <code>PostEvent</code> 一个 <code>AkEvent</code> 之后，可以通过 <code>SetSwitch</code> 传入 <code>SwitchGroup</code> 和<code>SwitchState</code>以及 PostEvent 时传递的 Actor.</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9809/ue-wwise-post-event.webp"></p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9809/Wwise-Switch-view.webp"></p>
<h3 id="Sequencer"><a href="#Sequencer" class="headerlink" title="Sequencer"></a>Sequencer</h3><ul>
<li><a href="https://www.audiokinetic.com/zh/library/2017.2.10_6745/?source=UE4&id=using__features__sequencer.html">Level Sequencer</a></li>
</ul>
<p>WWise 提供了在 Sequence 中使用的支持，可以在 Sequence 中使用 <code>AkAudioEvenes</code> 和<code>AkAudioRTPC</code>，从而实现在 Sequence 中来播放和控制 Event.</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9809/ue-wwise-in-sequencer.webp"></p>
<h3 id="Animation"><a href="#Animation" class="headerlink" title="Animation"></a>Animation</h3><ul>
<li><a href="https://www.audiokinetic.com/zh/library/2017.2.10_6745/?source=UE4&id=using__features__anim.html">Animation</a></li>
</ul>
<p>并且可以使用在动画通知中：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9809/ue-add-wwise-ak-notifity-in-animation.webp"></p>
<p>给该通知指定 Event：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9809/ue-add-wwise-ak-notifity-in-animation-event.webp"></p>
<h2 id="CommandLet"><a href="#CommandLet" class="headerlink" title="CommandLet"></a>CommandLet</h2><p>WWise 提供了 UE 中的 Commandlet，用于处理批量生成 Bank 的功能。</p>
<p>使用介绍：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Commandlet allowing to generate Wwise SoundBanks.</span><br><span class="line">Usage: &lt;Editor.exe&gt; &lt;path_to_uproject&gt; -run=GenerateSoundBanks [-platforms=listOfPlatforms] [-banks=listOfBanks] [-wwiseCliPath=pathToWwiseCli]</span><br><span class="line">Parameters:</span><br><span class="line">   - platforms: (Optional) Comma separated list of platforms for which SoundBanks will be generated, as specified in the Wwise project. If not specified, SoundBanks will be generated for all platforms.</span><br><span class="line">   - banks: (Optional) Comma separated list of SoundBanks to generate. Bank names must correspond to a UAkAudioBank asset in the project. If now specified, all SoundBanks found in project will be generated.</span><br><span class="line">   - wwiseCliPath: (Optional) Full path to the Wwise command-line application to use to generate the SoundBanks. If not specified, the path found in the Wwise settings will be used.</span><br><span class="line">   - help: (Optional) Print this help message. This will quit the commandlet immediately.</span><br><span class="line">For more information, see https://www.audiokinetic.com/library/edge/?source=UE4&amp;id=using_features_generatecommandlet.html</span><br></pre></td></tr></table></figure>

<p>生成 SoundBank 的 Commandle 为：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Engine/Binaries/Win64/UE4Editor.exe <span class="string">&quot;D:/WwiseDemoGame.uproject&quot;</span> -run=GenerateSoundBanks -platforms=Windows,Android,iOS -<span class="built_in">wait</span></span><br></pre></td></tr></table></figure>

<p><code>-wait</code>参数是我加在 CommandLet 中的，可以用来控制执行完毕后等待用户输入，避免执行窗口一闪而过的情况。<br>当没有指定生成哪些 SoundBank 时，会把项目中所有定义的 SoundBank 生成，如果想要自己指定，则可以使用 <code>-banks=aaa,bbb,ccc</code> 等形式来指定。</p>
<p>最终的执行命令为（可以看到 <code>-ImportDefinitionFile</code> 参数）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;C:\Program Files (x86)\Audiokinetic\Wwise 2019.1.9.7221\Authoring\x64\Release\bin\WwiseCLI.exe&quot;  &quot;D:/WwiseDemoGame/UnrealWwiseDemo/UnrealDemo.wproj&quot; -GenerateSoundBanks -Bank ExtSrcBnk -Bank AmbientBank -Bank ReverbBank -Bank VelocityBank -Bank MatineeBank -Bank SubtitleBank -Bank SwitchBank -ImportDefinitionFile &quot;D:/WwiseDemoGame/TempDefinitionFile.txt&quot; -Platform Windows -SoundBankPath Windows &quot;D:\WwiseDemoGame\Content\WwiseAudio\Windows&quot; -Platform Android -SoundBankPath Android &quot;D:\WwiseDemoGame\Content\WwiseAudio\Android&quot; -Platform iOS -SoundBankPath iOS &quot;D:\WwiseDemoGame\Content\WwiseAudio\iOS&quot;</span><br></pre></td></tr></table></figure>
<p>拆分命令来看：</p>
<ol>
<li>WWiseCLI.exe 的路径</li>
<li><code>-GenerateSoundBanks</code>：传递给 WWiseCLI.exe 标识用于生成 SoundBank</li>
<li><code>-Bank</code>：指定 Bank 的名字</li>
<li><code>-ImportDefinitionFile</code>：指定 <code>TempDefinitionFile.txt</code> 文件</li>
<li><code>-Platform</code>：指定平台</li>
<li><code>-SoundBankPath</code>：指定生成平台保存到的目录</li>
</ol>
<h2 id="命令行参数"><a href="# 命令行参数" class="headerlink" title="命令行参数"></a>命令行参数</h2><ul>
<li><code>-nosound</code>：关闭 WWise 的声音。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FAkAudioDevice::EnsureInitialized</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// We don&#x27;t want sound in those cases.</span></span><br><span class="line">	<span class="keyword">if</span> (FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;nosound&quot;</span>)) || FApp::<span class="built_in">IsBenchmarking</span>() || <span class="built_in">IsRunningDedicatedServer</span>() || <span class="built_in">IsRunningCommandlet</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="全局暂停音乐"><a href="# 全局暂停音乐" class="headerlink" title="全局暂停音乐"></a>全局暂停音乐</h2><ul>
<li><a href="https://www.audiokinetic.com/zh/library/edge/?source=SDK&id=workingwithsdks_system_calls.html">处理系统专用事件</a></li>
</ul>
<p>可以通过以下代码实现：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// on enter backgraound</span></span><br><span class="line">AK::SoundEngine::<span class="built_in">Suspend</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// on enter foreground</span></span><br><span class="line">AK::SoundEngine::<span class="built_in">WakeupFromSuspend</span>();</span><br><span class="line">AK::SoundEngine::<span class="built_in">RenderAudio</span>();</span><br></pre></td></tr></table></figure>

<h2 id="热更 WWise 的 Bank"><a href="# 热更 WWise 的 Bank" class="headerlink" title="热更 WWise 的 Bank"></a>热更 WWise 的 Bank</h2><p>根据上面的分析可以看到， WWise 在生成 Bank 时以平台为单位生成，每个平台都会生成对应的文件夹。<br>这要求我们在热更时需要根据不同的平台包含不同的外部文件，<a href="https://github.com/hxhb/HotPatcher">HotPatcher</a>已经支持了这个特性，可以实现特定平台包含特殊的文件。</p>
<h2 id="WWise 集成至 UE 的缺点"><a href="#WWise 集成至 UE 的缺点" class="headerlink" title="WWise 集成至 UE 的缺点"></a>WWise 集成至 UE 的缺点 </h2><p> 官方提供的 Event 导入和指定 Bank 的流程太繁琐了，每个 Event 都需要拖到 Content Browser 里才可以创建出 UE 的 Event 资源，然后还需要打开手动指定 RequireBank，十分的麻烦。其实 WWise 编辑器中本身包含了 Bank 的编辑功能，但是在 UE 中官方没有提供方法可以批量地生成 UE 里的 Event 和 Bank 资源，这个可以作为业余扩展开发的点，自己搞一个批量导入的功能，不过是后话了，有时间再来搞。</p>
<h2 id="文档"><a href="# 文档" class="headerlink" title="文档"></a>文档</h2><ul>
<li>WWise 中的概念概述：<a href="https://www.audiokinetic.com/zh/library/edge/?source=SDK&id=conceptsandterminology.html">Wwise 概念概述</a></li>
<li><a href="https://www.audiokinetic.com/zh/library/edge/?source=Help&id=dlc_considerations_and_limitations">DLC 注意事项及限制</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Gameplay</category>
      </categories>
      <tags>
        <tag>Music</tag>
        <tag>Wwise</tag>
      </tags>
  </entry>
  <entry>
    <title>跨关卡传递 Actor 实例</title>
    <url>/wiki/19376/</url>
    <content><![CDATA[<p>因为 UnrealEngine 在切换关卡 (<code>OpenLevel</code>) 时会把当前关卡的所有对象全部销毁，但是常常我们需要保存某些对象到下一关卡中，今天读了一下相关的代码，本篇文章讲一下如何来实现。<br>其实 Unreal 的文档是有说明的(<a href="https://docs.unrealengine.com/en-us/Gameplay/Networking/Travelling">Travelling in Multiplayer</a>)，实现起来也并不麻烦，但是 UE 文档的一贯风格是资料是不详细的，中文资料更是十分匮乏(多是机翻，而且版本很老)，在搜索中也没有查到相关的靠谱的东西，我自己在读代码实现的过程中就随手记了一下，就当做笔记了。</p>
<span id="more"></span>

<p>UE 在 C++ 中提供了这些功能，需要在 <code>GameMode</code> 中开启 <code>bUseSeamlessTravel=true</code>, 然后使用<code>GetSeamlessTravelActorList</code> 来获取需要保存的 Actor 列表的。<br><strong>但是 </strong>，请注意，直接使用<code>UGameplayStatics::OpenLevel</code> 是不行的，因为 OpenLevel 调用的是 <code>GEngine-&gt;SetClientTravel(World,*Cmd,TravelType)</code>，所以不会执行<code>AGameMode::GetSeamlessTravelActorList</code> 去获取要留存到下一关卡的 Actor。<br>在 UE 文档的 <a href="https://docs.unrealengine.com/en-us/Gameplay/Networking/Travelling">Travelling in Multiplayer</a> 中的 <strong>Persisting Actors across Seamless Travel</strong> 有写到只有 <code>ServerOnly</code> 的 GameMode 才会调用 <code>AGameModeAGameMode::GetSeamlessTravelActorList</code>，所以要使用<code>UWorld::ServerTravel</code> 来进行关卡切换。但 UE 并没有把 <code>UWorld::ServerTravel</code> 暴露给蓝图，所以我在测试代码中加了个暴露给蓝图的包裹函数 <code>ACppGameMode::Z_ServerTravel</code>,<code>AGameMode::GetSeamlessTravelActorList</code> 也同理，也有一个暴露给蓝图的包裹函数 <code>ACppGameMode::GetSaveToNextLevelActors</code>。<br> 读了一下 <code>UWorld::ServerTravel</code> 的代码，其调用栈为:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">UWorld::ServerTravel -&gt; AGameModeBase::ProcessServerTravel -&gt;　UWorld::SeamlessTravel -&gt; SeamlessTravelHandler::Tick</span><br></pre></td></tr></table></figure>
<p>最终保留 Actor 的操作是在 <code>FSeamlessTravelHandler::Tick</code> 中做的，相关代码如下(前后均有省略)：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">UWorld* <span class="title">FSeamlessTravelHandler::Tick</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// ......</span></span><br><span class="line">	<span class="comment">// mark actors we want to keep</span></span><br><span class="line">	FUObjectAnnotationSparseBool KeepAnnotation;</span><br><span class="line">	TArray&lt;AActor*&gt; KeepActors;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (AGameModeBase* AuthGameMode = CurrentWorld-&gt;<span class="built_in">GetAuthGameMode</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		AuthGameMode-&gt;<span class="built_in">GetSeamlessTravelActorList</span>(!bSwitchedToDefaultMap, KeepActors);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">bool</span> bIsClient = (CurrentWorld-&gt;<span class="built_in">GetNetMode</span>() == NM_Client);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// always keep Controllers that belong to players</span></span><br><span class="line">	<span class="keyword">if</span> (bIsClient)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span> (FLocalPlayerIterator <span class="built_in">It</span>(GEngine, CurrentWorld); It; ++It)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (It-&gt;PlayerController != <span class="literal">nullptr</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				KeepAnnotation.<span class="built_in">Set</span>(It-&gt;PlayerController);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span>(FConstControllerIterator Iterator = CurrentWorld-&gt;<span class="built_in">GetControllerIterator</span>(); Iterator; ++Iterator)</span><br><span class="line">		&#123;</span><br><span class="line">			AController* Player = Iterator-&gt;<span class="built_in">Get</span>();</span><br><span class="line">			<span class="keyword">if</span> (Player-&gt;PlayerState || Cast&lt;APlayerController&gt;(Player) != <span class="literal">nullptr</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				KeepAnnotation.<span class="built_in">Set</span>(Player);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ask players what else we should keep</span></span><br><span class="line">	<span class="keyword">for</span> (FLocalPlayerIterator <span class="built_in">It</span>(GEngine, CurrentWorld); It; ++It)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (It-&gt;PlayerController != <span class="literal">nullptr</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			It-&gt;PlayerController-&gt;<span class="built_in">GetSeamlessTravelActorList</span>(!bSwitchedToDefaultMap, KeepActors);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// mark all valid actors specified</span></span><br><span class="line">	<span class="keyword">for</span> (AActor* KeepActor : KeepActors)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (KeepActor != <span class="literal">nullptr</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			KeepAnnotation.<span class="built_in">Set</span>(KeepActor);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	TArray&lt;AActor*&gt; ActuallyKeptActors;</span><br><span class="line">	ActuallyKeptActors.<span class="built_in">Reserve</span>(KeepAnnotation.<span class="built_in">Num</span>());</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Rename dynamic actors in the old world&#x27;s PersistentLevel that we want to keep into the new world</span></span><br><span class="line">	<span class="keyword">auto</span> ProcessActor = [<span class="keyword">this</span>, &amp;KeepAnnotation, &amp;ActuallyKeptActors, NetDriver](AActor* TheActor) -&gt; <span class="keyword">bool</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">const</span> FNetworkObjectInfo* NetworkObjectInfo = NetDriver ? NetDriver-&gt;<span class="built_in">GetNetworkObjectInfo</span>(TheActor) : <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">bool</span> bIsInCurrentLevel	= TheActor-&gt;<span class="built_in">GetLevel</span>() == CurrentWorld-&gt;PersistentLevel;</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">bool</span> bManuallyMarkedKeep	= KeepAnnotation.<span class="built_in">Get</span>(TheActor);</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">bool</span> bDormant				= NetworkObjectInfo &amp;&amp; NetDriver &amp;&amp; NetDriver-&gt;ServerConnection &amp;&amp; NetworkObjectInfo-&gt;DormantConnections.<span class="built_in">Contains</span>(NetDriver-&gt;ServerConnection);</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">bool</span> bKeepNonOwnedActor	= TheActor-&gt;Role &lt; ROLE_Authority &amp;&amp; !bDormant &amp;&amp; !TheActor-&gt;<span class="built_in">IsNetStartupActor</span>();</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">bool</span> bForceExcludeActor	= TheActor-&gt;<span class="built_in">IsA</span>(ALevelScriptActor::<span class="built_in">StaticClass</span>());</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Keep if it&#x27;s in the current level AND it isn&#x27;t specifically excluded AND it was either marked as should keep OR we don&#x27;t own this actor</span></span><br><span class="line">		<span class="keyword">if</span> (bIsInCurrentLevel &amp;&amp; !bForceExcludeActor &amp;&amp; (bManuallyMarkedKeep || bKeepNonOwnedActor))</span><br><span class="line">		&#123;</span><br><span class="line">			ActuallyKeptActors.<span class="built_in">Add</span>(TheActor);</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (bManuallyMarkedKeep)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">UE_LOG</span>(LogWorld, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Actor &#x27;%s&#x27; was indicated to be kept but exists in level &#x27;%s&#x27;, not the persistent level.  Actor will not travel.&quot;</span>), *TheActor-&gt;<span class="built_in">GetName</span>(), *TheActor-&gt;<span class="built_in">GetLevel</span>()-&gt;<span class="built_in">GetOutermost</span>()-&gt;<span class="built_in">GetName</span>());</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			TheActor-&gt;<span class="built_in">RouteEndPlay</span>(EEndPlayReason::LevelTransition);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// otherwise, set to be deleted</span></span><br><span class="line">			KeepAnnotation.<span class="built_in">Clear</span>(TheActor);</span><br><span class="line">			<span class="comment">// close any channels for this actor</span></span><br><span class="line">			<span class="keyword">if</span> (NetDriver != <span class="literal">nullptr</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				NetDriver-&gt;<span class="built_in">NotifyActorLevelUnloaded</span>(TheActor);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是我写的测试用的 <code>GameMode</code> 的代码：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// CppGameMode.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;UnrealString.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Engine/World.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Kismet/KismetSystemLibrary.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;GameFramework/GameMode.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CppGameMode.generated.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">UCLASS</span>()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ACppGameMode</span> :</span> <span class="keyword">public</span> AGameMode</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line">		<span class="built_in">ACppGameMode</span>();</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">GetSeamlessTravelActorList</span><span class="params">(<span class="keyword">bool</span> bToTransition, TArray&lt;AActor*&gt;&amp; ActorList)</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">		<span class="built_in">UFUNCTION</span>(BlueprintNativeEvent, BlueprintCallable,Category=<span class="string">&quot;GameCore|GameMode|SeamlessTravel&quot;</span>)</span><br><span class="line">			<span class="function"><span class="keyword">void</span> <span class="title">GetSaveToNextLevelActors</span><span class="params">(TArray&lt;AActor*&gt;&amp; ActorList)</span></span>;</span><br><span class="line">		<span class="built_in">UFUNCTION</span>(BlueprintNativeEvent, BlueprintCallable,Category=<span class="string">&quot;GameCore|GameMode|SeamlessTravel&quot;</span>)</span><br><span class="line">			<span class="function"><span class="keyword">bool</span> <span class="title">Z_ServerTravel</span><span class="params">(<span class="keyword">const</span> FString&amp; FURL, <span class="keyword">bool</span> bAbsolute, <span class="keyword">bool</span> bShouldSkipGameNotify)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CppGameMode.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CppGameMode.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">ACppGameMode::<span class="built_in">ACppGameMode</span>()</span><br><span class="line">&#123;</span><br><span class="line">	bUseSeamlessTravel = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ACppGameMode::GetSeamlessTravelActorList</span><span class="params">(<span class="keyword">bool</span> bToTransition, TArray&lt;AActor*&gt;&amp; ActorList)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">GetSaveToNextLevelActors</span>(ActorList);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ACppGameMode::GetSaveToNextLevelActors_Implementation</span><span class="params">(TArray&lt;AActor*&gt;&amp; ActorList)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UKismetSystemLibrary::<span class="built_in">PrintString</span>(<span class="keyword">this</span>,<span class="built_in">FString</span>(<span class="string">&quot;ACppGameMode::GetSaveToNextLevelActors&quot;</span>),<span class="literal">false</span>,<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ACppGameMode::Z_ServerTravel_Implementation</span><span class="params">(<span class="keyword">const</span> FString&amp; FURL, <span class="keyword">bool</span> bAbsolute, <span class="keyword">bool</span> bShouldSkipGameNotify)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UWorld* WorldObj = <span class="built_in">GetWorld</span>();</span><br><span class="line">	<span class="keyword">return</span> WorldObj-&gt;<span class="built_in">ServerTravel</span>(FURL, bAbsolute, bShouldSkipGameNotify);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后就可以在继承自 <code>ACppGameMode</code> 的 Blueprint 中 <code>Override Function</code> 里重写 <code>GetSaveToNextLevelActors</code> 来在蓝图中指定哪些 Actor 可以保留到下一关卡。<br>记得一定要在原始关卡 (切换之前的关卡) 中选择继承并实现了 <code>GetSaveToNextLevelActors</code> 的<code>GameMode</code>。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/19376/Z_ServerTravel.webp"><br>最终就可以在蓝图中使用 <code>Z_ServerTravel</code> 来替代 <code>OpenLevel</code> 来切换关卡了(上图)，从而实现在 UE 中切换关卡时传递 Actor 到目标关卡。</p>
<p>相关链接：</p>
<ul>
<li><a href="https://docs.unrealengine.com/en-us/Gameplay/Networking/Travelling">Travelling in Multiplayer</a></li>
<li><a href="https://forums.unrealengine.com/development-discussion/c-gameplay-programming/3582-keeping-actors-between-levels?3435-Keeping-Actors-Between-Levels=">Keeping Actors Between Levels</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Gameplay</category>
      </categories>
      <tags>
        <tag>Seamless travel</tag>
      </tags>
  </entry>
  <entry>
    <title>联机烘培光照</title>
    <url>/wiki/41871/</url>
    <content><![CDATA[<p>在 UE 编辑器中构建光照时，会拉起一个 SwarmAgent 进程在后台执行光照构建任务。<br>UE 提供了多台机器联机构建光照的支持，通过配置 <code>SwarmCoordinator</code> 与<code>SwarmAgent</code>作为 C/S 的方式来下发构建任务，实现联机烘培的效果。官方文档：<a href="https://docs.unrealengine.com/en-US/RenderingAndGraphics/Lightmass/UnrealSwarmOverview/index.html">Unreal Swarm</a>。</p>
<p>要求：</p>
<ol>
<li>在局域网内需要一台设备当作调度器（Coordinator），该机器上需要具有完整的引擎，并且该机器需要开放 TCP 的 8008/8009 端口的 in/out，不然无法连接。</li>
<li>其余的机器上不要求安装引擎，但是需要运行 SwarmAgent。</li>
</ol>
<p><code>SwarmAgent</code>可以从引擎的 <code>Engine\Binaries\DotNET</code> 目录下提取以下文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">C:\build_agent\workspace\SwarmAgent&gt;tree /a /f</span><br><span class="line">C:.</span><br><span class="line">    AgentInterface.dll</span><br><span class="line">    SwarmAgent.DeveloperOptions.xml</span><br><span class="line">    SwarmAgent.exe</span><br><span class="line">    SwarmAgent.exe.config</span><br><span class="line">    SwarmAgent.Options.xml</span><br><span class="line">    SwarmCommonUtils.dll</span><br><span class="line">    SwarmCoordinator.exe</span><br><span class="line">    SwarmCoordinator.exe.config</span><br><span class="line">    SwarmCoordinatorInterface.dll</span><br><span class="line">    SwarmInterface.dll</span><br><span class="line">    UnrealControls.dll</span><br></pre></td></tr></table></figure>
<p>其中 <code>SwarmAgent.Options.xml</code> 与<code>SwarmAgent.DeveloperOptions.xml</code>是配置文件。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210413161531.webp"></p>
<p>需要关注的参数：</p>
<ul>
<li><code>CacheFolder</code>：注意该目录需要有读写权限，因为 <code>SwarmAgent</code> 可以脱离引擎单独运行，默认的引擎目录不适合，建议设置为<code>C:\tmp\SwarmCache</code>。</li>
<li><code>AllowedRemoteAgentNames</code>：允许远程 Agent 分配任务到本地的名字，如果不做分组的情况，可以用通配符 <code>*</code> 允许所有的 Agent</li>
<li><code>CoordinatorRemotingHost</code>：局域网中运行 SwarmCoordinator 机器的 IP 地址（注意该机器需要开放 TCP 8008/8009 端口）</li>
<li><code>AvoidLocalExecution</code>：只允许从本地分发任务，但本地不执行任务。</li>
<li><code>EnableStandaloneMode</code>：SwarmAgent 的独立模式，不允许传入任务，也不向其他机器分发任务。</li>
<li><code>ShowDeveloperMenu</code>：显示 DeveloperSettings 菜单。</li>
</ul>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210413162440.webp"></p>
<p>在 DevelopSettings 中可以控制超时时间、核心数等。<br>当配置完之后把 SwarmAgent 运行在其余设备上，在 Coordinator 的机器上就可以看到以下连接：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210413162441.webp"></p>
<p>展示了连接的机器数，工作状态（如果 SwarmCoordinator 进程关闭，重启后会自动连接 Agent）。<br>在任意启动了 Agent 的机器上可以开启 UE 启动光照构建任务（注意一定要先单独启动被配置完成的 SwarmAgent，如果使用引擎自动拉起 SwarmAgent 则会使用一份额外的配置文件），就能在本地 SwarmAgent 进程中看到以下任务分配：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210413162442.webp"></p>
<p>在 SwarmCoordinator 中可以看到任务分配情况：<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210413163213.webp"></p>
<p><strong>注意</strong>：不一定所有的任务都会被分配至其他的 Agent 执行，取决于任务数量、Agent 的负载情况等。</p>
<p>当 Agent 处于 Busy 状态时，Coordinator 不会给其分配任务：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210413164503.webp"><br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210413164502.webp"></p>
<p>其他资料：</p>
<ul>
<li><a href="https://wiki.vg/Unreal:Swarm_Agent_Troubleshooting#General_Tips_for_using_Lightmass_in_Unreal_Engine_4">Unreal:Swarm Agent Troubleshooting</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Lightmass</category>
      </categories>
      <tags>
        <tag>Lightmass</tag>
        <tag>Swarm Agent</tag>
      </tags>
  </entry>
  <entry>
    <title>Log Timestamp</title>
    <url>/wiki/85196df3/</url>
    <content><![CDATA[<p>引擎默认的 Log 时间是 UTC，与国内的有差别，可以修改配置实现：</p>
<figure class="highlight ini"><figcaption><span>BaseEngine.ini</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="section">[LogFiles]</span></span><br><span class="line"><span class="attr">PurgeLogsDays</span>=<span class="number">5</span></span><br><span class="line"><span class="attr">MaxLogFilesOnDisk</span>=<span class="number">10</span></span><br><span class="line"><span class="attr">LogTimes</span>=<span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p>通过控制 <code>LogTimes</code> 项的值可以设置不同的时区，可选项为<code>None</code>/<code>UTC</code>/<code>SinceStart</code>/<code>Local</code>/<code>Timecode</code>/(<code>Ture</code>/<code>Flase</code>(UTC))：</p>
<figure class="highlight cpp"><figcaption><span>Launch/Private/LaunchEngineLoop.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CheckForPrintTimesOverride</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// Determine whether to override the default setting for including timestamps in the log.</span></span><br><span class="line">	FString LogTimes;</span><br><span class="line">	<span class="keyword">if</span> (GConfig-&gt;<span class="built_in">GetString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;LogFiles&quot;</span> ), <span class="built_in">TEXT</span>(<span class="string">&quot;LogTimes&quot;</span> ), LogTimes, GEngineIni ))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (LogTimes == <span class="built_in">TEXT</span>(<span class="string">&quot;None&quot;</span> ))</span><br><span class="line">		&#123;</span><br><span class="line">			CVarLogTimestamp-&gt;<span class="built_in">Set</span>((<span class="keyword">int</span>)ELogTimes::None, ECVF_SetBySystemSettingsIni);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (LogTimes == <span class="built_in">TEXT</span>(<span class="string">&quot;UTC&quot;</span> ))</span><br><span class="line">		&#123;</span><br><span class="line">			CVarLogTimestamp-&gt;<span class="built_in">Set</span>((<span class="keyword">int</span>)ELogTimes::UTC, ECVF_SetBySystemSettingsIni);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (LogTimes == <span class="built_in">TEXT</span>(<span class="string">&quot;SinceStart&quot;</span> ))</span><br><span class="line">		&#123;</span><br><span class="line">			CVarLogTimestamp-&gt;<span class="built_in">Set</span>((<span class="keyword">int</span>)ELogTimes::SinceGStartTime, ECVF_SetBySystemSettingsIni);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (LogTimes == <span class="built_in">TEXT</span>(<span class="string">&quot;Local&quot;</span> ))</span><br><span class="line">		&#123;</span><br><span class="line">			CVarLogTimestamp-&gt;<span class="built_in">Set</span>((<span class="keyword">int</span>)ELogTimes::Local, ECVF_SetBySystemSettingsIni);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (LogTimes == <span class="built_in">TEXT</span>(<span class="string">&quot;Timecode&quot;</span> ))</span><br><span class="line">		&#123;</span><br><span class="line">			CVarLogTimestamp-&gt;<span class="built_in">Set</span>((<span class="keyword">int</span>)ELogTimes::Timecode, ECVF_SetBySystemSettingsIni);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Assume this is a bool for backward compatibility</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (FCString::<span class="built_in">ToBool</span>(*LogTimes))</span><br><span class="line">		&#123;</span><br><span class="line">			CVarLogTimestamp-&gt;<span class="built_in">Set</span>((<span class="keyword">int</span>)ELogTimes::UTC, ECVF_SetBySystemSettingsIni);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;LOGTIMES&quot;</span> ) ))</span><br><span class="line">	&#123;</span><br><span class="line">		CVarLogTimestamp-&gt;<span class="built_in">Set</span>((<span class="keyword">int</span>)ELogTimes::UTC, ECVF_SetByCommandline);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;UTCLOGTIMES&quot;</span> ) ))</span><br><span class="line">	&#123;</span><br><span class="line">		CVarLogTimestamp-&gt;<span class="built_in">Set</span>((<span class="keyword">int</span>)ELogTimes::UTC, ECVF_SetByCommandline);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;NOLOGTIMES&quot;</span> ) ))</span><br><span class="line">	&#123;</span><br><span class="line">		CVarLogTimestamp-&gt;<span class="built_in">Set</span>((<span class="keyword">int</span>)ELogTimes::None, ECVF_SetByCommandline);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;LOGTIMESINCESTART&quot;</span> ) ))</span><br><span class="line">	&#123;</span><br><span class="line">		CVarLogTimestamp-&gt;<span class="built_in">Set</span>((<span class="keyword">int</span>)ELogTimes::SinceGStartTime, ECVF_SetByCommandline);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;LOCALLOGTIMES&quot;</span> ) ))</span><br><span class="line">	&#123;</span><br><span class="line">		CVarLogTimestamp-&gt;<span class="built_in">Set</span>((<span class="keyword">int</span>)ELogTimes::Local, ECVF_SetByCommandline);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;LOGTIMECODE&quot;</span> )))</span><br><span class="line">	&#123;</span><br><span class="line">		CVarLogTimestamp-&gt;<span class="built_in">Set</span>((<span class="keyword">int</span>)ELogTimes::Timecode, ECVF_SetByCommandline);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Logging</category>
      </categories>
      <tags>
        <tag>Logging</tag>
        <tag>Log Timestamp</tag>
      </tags>
  </entry>
  <entry>
    <title>App 版本号</title>
    <url>/wiki/36762/</url>
    <content><![CDATA[<h3 id="IOS"><a href="#IOS" class="headerlink" title="IOS"></a>IOS</h3><p> 在 IOS 包的 plist 中可以通过控制以下两个值：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">key</span>&gt;</span>CFBundleShortVersionString<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">string</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">key</span>&gt;</span>CFBundleVersion<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">string</span>&gt;</span>0.1<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><a href="https://developer.apple.com/documentation/bundleresources/information_property_list/cfbundleshortversionstring">CFBundleShortVersionString</a></li>
<li><a href="https://developer.apple.com/documentation/bundleresources/information_property_list/cfbundleversion">CFBundleVersion</a></li>
<li><a href="https://beginor.github.io/2014/07/22/ios-cfbundleshortversionstring-vs-cfbundleversion.html">iOS 中的 CFBundleShortVersionString 与 CFBundleVersion</a></li>
</ul>
<p> 一般使用 CFBundleVersion 来作为游戏版本号，在 UE 中可以通过 UPL 来控制 plist。</p>
<h3 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h3><p>Android 通过控制以下值：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[/Script/AndroidRuntimeSettings.AndroidRuntimeSettings]</span></span><br><span class="line"><span class="attr">VersionDisplayName</span>=<span class="number">1.0</span>.<span class="number">0</span></span><br><span class="line"><span class="attr">StoreVersion</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Mobile</tag>
        <tag>IOS</tag>
      </tags>
  </entry>
  <entry>
    <title>修改 LaunchScreen 视频比例</title>
    <url>/wiki/39224/</url>
    <content><![CDATA[<p>当使用 <code>Project Settings</code>-<code>Project</code>-<code>Movies</code> 中来为游戏启动时播放视频时，默认情况下是锁定视频的长宽比的，在全面屏流行的现在，长宽比为 2.x 的比比皆是，锁定视频比例会导致两侧有黑边，所以希望视频能够拉伸来适应屏幕的大小。<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201009210924.webp"><br>需要修改引擎的代码：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/MoviePlayer/Private/DefaultGameMoviePlayer.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function">FVector2D <span class="title">FDefaultGameMoviePlayer::GetMovieSize</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> FVector2D ScreenSize = MainWindow.<span class="built_in">Pin</span>()-&gt;<span class="built_in">GetClientSizeInScreen</span>();</span><br><span class="line">	<span class="comment">// if (MovieStreamingIsPrepared() &amp;&amp; ActiveMovieStreamer.IsValid())</span></span><br><span class="line">	<span class="comment">// &#123;</span></span><br><span class="line">	<span class="comment">// 	const float MovieAspectRatio = ActiveMovieStreamer-&gt;GetAspectRatio();</span></span><br><span class="line">	<span class="comment">// 	const float ScreenAspectRatio = ScreenSize.X / ScreenSize.Y;</span></span><br><span class="line">	<span class="comment">// 	if (MovieAspectRatio &lt; ScreenAspectRatio)</span></span><br><span class="line">	<span class="comment">// 	&#123;</span></span><br><span class="line">	<span class="comment">// 		return FVector2D(ScreenSize.Y * MovieAspectRatio, ScreenSize.Y);</span></span><br><span class="line">	<span class="comment">// 	&#125;</span></span><br><span class="line">	<span class="comment">// 	else</span></span><br><span class="line">	<span class="comment">// 	&#123;</span></span><br><span class="line">	<span class="comment">// 		return FVector2D(ScreenSize.X, ScreenSize.X / MovieAspectRatio);</span></span><br><span class="line">	<span class="comment">// 	&#125;</span></span><br><span class="line">	<span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// No movie, so simply return the size of the window</span></span><br><span class="line">	<span class="keyword">return</span> ScreenSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>把 <code>FDefaultGameMoviePlayer::GetMovieSize()</code> 修改为上面的代码，其实就是把从视频获取长宽的代码去掉，强制使用窗口的大小。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
      </categories>
      <tags>
        <tag>Mobile</tag>
        <tag>Video</tag>
      </tags>
  </entry>
  <entry>
    <title>移动端息屏控制</title>
    <url>/wiki/14280/</url>
    <content><![CDATA[<h2 id="息屏控制"><a href="# 息屏控制" class="headerlink" title="息屏控制"></a>息屏控制</h2><p>UE 中封装了通用的接口来控制，可以使用以下函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">UKismetSystemLibrary::<span class="built_in">ControlScreensaver</span>(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>
<p>它会调用到对应平台的 <code>F*ApplicationMisc</code> 中的同名函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// for Android</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FAndroidApplicationMisc::ControlScreensaver</span><span class="params">(EScreenSaverAction Action)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_ANDROID_JNI</span></span><br><span class="line">  <span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">AndroidThunkCpp_KeepScreenOn</span><span class="params">(<span class="keyword">bool</span> Enable)</span></span>;</span><br><span class="line">  <span class="built_in"><span class="keyword">switch</span></span> (Action)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> EScreenSaverAction::Disable:</span><br><span class="line">      <span class="comment">// Prevent display sleep.</span></span><br><span class="line">      <span class="built_in">AndroidThunkCpp_KeepScreenOn</span>(<span class="literal">true</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> EScreenSaverAction::Enable:</span><br><span class="line">      <span class="comment">// Stop preventing display sleep now that we are done.</span></span><br><span class="line">      <span class="built_in">AndroidThunkCpp_KeepScreenOn</span>(<span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// for IOS</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FIOSPlatformApplicationMisc::ControlScreensaver</span><span class="params">(EScreenSaverAction Action)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  IOSAppDelegate* AppDelegate = [IOSAppDelegate GetDelegate];</span><br><span class="line">  [AppDelegate EnableIdleTimer : (Action == FGenericPlatformApplicationMisc::Enable)];</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h3><p>在 UE 的 <code>GameActivity.java.template</code> 文件中有以下函数：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AndroidThunkJava_KeepScreenOn</span><span class="params">(<span class="keyword">boolean</span> Enable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  bKeepScreenOn = Enable;</span><br><span class="line">  <span class="keyword">if</span> (Enable)</span><br><span class="line">  &#123;</span><br><span class="line">    _activity.runOnUiThread(<span class="keyword">new</span> Runnable()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                Log.debug(<span class="string">&quot;==============&gt; [JAVA] AndroidThunkJava_KeepScreenOn(true) - Disabled screen saver&quot;</span>);</span><br><span class="line">                _activity.getWindow().addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    _activity.runOnUiThread(<span class="keyword">new</span> Runnable()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                Log.debug(<span class="string">&quot;==============&gt; [JAVA] AndroidThunkJava_KeepScreenOn(false) - Enabled screen saver&quot;</span>);</span><br><span class="line">                _activity.getWindow().clearFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 GameActivity 的 <code>OnResume</code> 函数中会调用，是否开启的值为<code>bKeepScreenOn</code>。</p>
<p>可以通过 UPL、或者运行时的 JNI 调用来控制 Android 是否息屏。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">gameActivityOnCreateFinalAdditions</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">insert</span>&gt;</span></span><br><span class="line">      AndroidThunkJava_KeepScreenOn(true);</span><br><span class="line">  <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">gameActivityOnCreateFinalAdditions</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="IOS"><a href="#IOS" class="headerlink" title="IOS"></a>IOS</h3><p>在引擎中有由下代码控制：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/ApplicationCore/Private/IOS/IOSAppDelegate.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line">-(<span class="keyword">void</span>)InitIdleTimerSettings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">float</span> TimerDuration = <span class="number">0.0F</span>;</span><br><span class="line">  GConfig-&gt;<span class="built_in">GetFloat</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;/Script/IOSRuntimeSettings.IOSRuntimeSettings&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;IdleTimerEnablePeriod&quot;</span>), TimerDuration, GEngineIni);</span><br><span class="line">    IdleTimerEnablePeriod = TimerDuration;</span><br><span class="line">  self.IdleTimerEnableTimer = nil;</span><br><span class="line">  <span class="keyword">bool</span> bEnableTimer = YES;</span><br><span class="line">  GConfig-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;/Script/IOSRuntimeSettings.IOSRuntimeSettings&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bEnableIdleTimer&quot;</span>), bEnableTimer, GEngineIni);</span><br><span class="line">  [self EnableIdleTimer : bEnableTimer];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以从 <code>GEngineIni</code> 中读取两个配置：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[/Script/IOSRuntimeSettings.IOSRuntimeSettings]</span></span><br><span class="line"><span class="attr">IdleTimerEnablePeriod</span>=<span class="number">0.0</span></span><br><span class="line"><span class="attr">bEnableIdleTimer</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>当<code>bEnableIdleTimer=false</code>，在游戏运行时就不会息屏。</p>
<p>运行时设置需要调用 OC 的代码：</p>
<figure class="highlight cpp"><figcaption><span>Runtime\ApplicationCore\Private\IOS\IOSAppDelegate.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line">-(<span class="keyword">void</span>)EnableIdleTimer:(<span class="keyword">bool</span>)bEnabled</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">dispatch_async</span>(<span class="built_in">dispatch_get_main_queue</span>(),^</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (bEnabled)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// Nothing needs to be done, if the enable timer is already running.</span></span><br><span class="line">      <span class="keyword">if</span> (self.IdleTimerEnableTimer == nil)</span><br><span class="line">      &#123;</span><br><span class="line">        self.IdleTimerEnableTimer = [NSTimer scheduledTimerWithTimeInterval:IdleTimerEnablePeriod target:self selector:@<span class="built_in">selector</span>(DeferredEnableIdleTimer) userInfo:nil repeats:NO];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// Ensure pending attempts to enable the idle timer are cancelled.</span></span><br><span class="line">      <span class="keyword">if</span> (self.IdleTimerEnableTimer != nil)</span><br><span class="line">      &#123;</span><br><span class="line">        [self.IdleTimerEnableTimer invalidate];</span><br><span class="line">        self.IdleTimerEnableTimer = nil;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      [UIApplication sharedApplication].idleTimerDisabled = NO;</span><br><span class="line">      [UIApplication sharedApplication].idleTimerDisabled = YES;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用 <code>EnableIdleTimer</code> 传入 false 会关闭游戏运行时息屏。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
      </categories>
  </entry>
  <entry>
    <title>移动端指定启动参数</title>
    <url>/wiki/26262/</url>
    <content><![CDATA[<p>UE4 打出来的 Windows 包可以使用 <code>XXXX.exe -Params</code> 等方式来传递给游戏参数，但是移动平台 (IOS/Android) 打包出来的怎么传递参数呢？</p>
<h3 id="Android 启动参数"><a href="#Android 启动参数" class="headerlink" title="Android 启动参数"></a>Android 启动参数 </h3><p> 看了一下引擎里的代码，在 <code>Launch</code> 模块下 <code>Launch\Private\Android\LaunchAndroid.cpp</code> 中有 <code>InitCommandLine</code> 函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Launch\Private\Android\LaunchAndroid.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">InitCommandLine</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> uint32 CMD_LINE_MAX = <span class="number">16384u</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// initialize the command line to an empty string</span></span><br><span class="line">  FCommandLine::<span class="built_in">Set</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">  AAssetManager* AssetMgr = <span class="built_in">AndroidThunkCpp_GetAssetManager</span>();</span><br><span class="line">  AAsset* asset = <span class="built_in">AAssetManager_open</span>(AssetMgr, <span class="built_in">TCHAR_TO_UTF8</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UE4CommandLine.txt&quot;</span>)), AASSET_MODE_BUFFER);</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> != asset)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">void</span>* FileContents = <span class="built_in">AAsset_getBuffer</span>(asset);</span><br><span class="line">    int32 FileLength = <span class="built_in">AAsset_getLength</span>(asset);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> CommandLine[CMD_LINE_MAX];</span><br><span class="line">    FileLength = (FileLength &lt; CMD_LINE_MAX - <span class="number">1</span>) ? FileLength : CMD_LINE_MAX - <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(CommandLine, FileContents, FileLength);</span><br><span class="line">    CommandLine[FileLength] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">AAsset_close</span>(asset);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// chop off trailing spaces</span></span><br><span class="line">    <span class="keyword">while</span> (*CommandLine &amp;&amp; <span class="built_in">isspace</span>(CommandLine[<span class="built_in">strlen</span>(CommandLine) - <span class="number">1</span>]))</span><br><span class="line">    &#123;</span><br><span class="line">      CommandLine[<span class="built_in">strlen</span>(CommandLine) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FCommandLine::<span class="built_in">Append</span>(<span class="built_in">UTF8_TO_TCHAR</span>(CommandLine));</span><br><span class="line">    FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;APK Commandline: %s&quot;</span>), FCommandLine::<span class="built_in">Get</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// read in the command line text file from the sdcard if it exists</span></span><br><span class="line">  FString CommandLineFilePath = GFilePathBase + <span class="built_in">FString</span>(<span class="string">&quot;/UE4Game/&quot;</span>) + (!FApp::<span class="built_in">IsProjectNameEmpty</span>() ? FApp::<span class="built_in">GetProjectName</span>() : FPlatformProcess::<span class="built_in">ExecutableName</span>()) + <span class="built_in">FString</span>(<span class="string">&quot;/UE4CommandLine.txt&quot;</span>);</span><br><span class="line">  FILE* CommandLineFile = <span class="built_in">fopen</span>(<span class="built_in">TCHAR_TO_UTF8</span>(*CommandLineFilePath), <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(CommandLineFile == <span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// if that failed, try the lowercase version</span></span><br><span class="line">    CommandLineFilePath = CommandLineFilePath.<span class="built_in">Replace</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UE4CommandLine.txt&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;ue4commandline.txt&quot;</span>));</span><br><span class="line">    CommandLineFile = <span class="built_in">fopen</span>(<span class="built_in">TCHAR_TO_UTF8</span>(*CommandLineFilePath), <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(CommandLineFile)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">char</span> CommandLine[CMD_LINE_MAX];</span><br><span class="line">    <span class="built_in">fgets</span>(CommandLine, <span class="built_in">ARRAY_COUNT</span>(CommandLine) - <span class="number">1</span>, CommandLineFile);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fclose</span>(CommandLineFile);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// chop off trailing spaces</span></span><br><span class="line">    <span class="keyword">while</span> (*CommandLine &amp;&amp; <span class="built_in">isspace</span>(CommandLine[<span class="built_in">strlen</span>(CommandLine) - <span class="number">1</span>]))</span><br><span class="line">    &#123;</span><br><span class="line">      CommandLine[<span class="built_in">strlen</span>(CommandLine) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// initialize the command line to an empty string</span></span><br><span class="line">    FCommandLine::<span class="built_in">Set</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    FCommandLine::<span class="built_in">Append</span>(<span class="built_in">UTF8_TO_TCHAR</span>(CommandLine));</span><br><span class="line">    FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Override Commandline: %s&quot;</span>), FCommandLine::<span class="built_in">Get</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !UE_BUILD_SHIPPING</span></span><br><span class="line">  <span class="keyword">if</span> (FString* ConfigRulesCmdLineAppend = FAndroidMisc::<span class="built_in">GetConfigRulesVariable</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;cmdline&quot;</span>)))</span><br><span class="line">  &#123;</span><br><span class="line">    FCommandLine::<span class="built_in">Append</span>(**ConfigRulesCmdLineAppend);</span><br><span class="line">    FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ConfigRules appended: %s&quot;</span>), **ConfigRulesCmdLineAppend);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单来说就是在 <code>UE4Game/ProjectName/ue4commandline.txt</code> 中把启动参数写到里面，引擎启动的时候会从这个文件去读，然后添加到 FCommandLine 中。</p>
<h3 id="IOS 启动参数"><a href="#IOS 启动参数" class="headerlink" title="IOS 启动参数"></a>IOS 启动参数 </h3><p> 与 Android 的做法相同，IOS 的参数传递是在 <code>main</code> 函数中调用<code>FIOSCommandLineHelper::InitCommandArgs(FString());</code>，不过路径和 Android 不一样：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">InitCommandArgs</span><span class="params">(FString AdditionalCommandArgs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// initialize the commandline</span></span><br><span class="line">  FCommandLine::<span class="built_in">Set</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">  FString CommandLineFilePath = <span class="built_in">FString</span>([[NSBundle mainBundle] bundlePath]) + <span class="built_in">TEXT</span>(<span class="string">&quot;/ue4commandline.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// read in the command line text file (coming from UnrealFrontend) if it exists</span></span><br><span class="line">  FILE* CommandLineFile = <span class="built_in">fopen</span>(<span class="built_in">TCHAR_TO_UTF8</span>(*CommandLineFilePath), <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(CommandLineFile)</span><br><span class="line">  &#123;</span><br><span class="line">    FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Found ue4commandline.txt file&quot;</span>) LINE_TERMINATOR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> CommandLine[CMD_LINE_MAX] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span>* DataExists = <span class="built_in">fgets</span>(CommandLine, <span class="built_in">ARRAY_COUNT</span>(CommandLine) - <span class="number">1</span>, CommandLineFile);</span><br><span class="line">    <span class="keyword">if</span> (DataExists)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// chop off trailing spaces</span></span><br><span class="line">      <span class="keyword">while</span> (*CommandLine &amp;&amp; <span class="built_in">isspace</span>(CommandLine[<span class="built_in">strlen</span>(CommandLine) - <span class="number">1</span>]))</span><br><span class="line">      &#123;</span><br><span class="line">        CommandLine[<span class="built_in">strlen</span>(CommandLine) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      FCommandLine::<span class="built_in">Append</span>(<span class="built_in">UTF8_TO_TCHAR</span>(CommandLine));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;No ue4commandline.txt [%s] found&quot;</span>) LINE_TERMINATOR, *CommandLineFilePath);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!AdditionalCommandArgs.<span class="built_in">IsEmpty</span>() &amp;&amp; !FChar::<span class="built_in">IsWhitespace</span>(AdditionalCommandArgs[<span class="number">0</span>]))</span><br><span class="line">  &#123;</span><br><span class="line">    FCommandLine::<span class="built_in">Append</span>(<span class="built_in">TEXT</span>(<span class="string">&quot; &quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  FCommandLine::<span class="built_in">Append</span>(*AdditionalCommandArgs);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// now merge the GSavedCommandLine with the rest</span></span><br><span class="line">  FCommandLine::<span class="built_in">Append</span>(*GSavedCommandLine);</span><br><span class="line"></span><br><span class="line">  FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Combined iOS Commandline: %s&quot;</span>) LINE_TERMINATOR, FCommandLine::<span class="built_in">Get</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键就是 <code>[[NSBundle mainBundle] bundlePath]</code> 这一句，它获取的是 App 的包路径，所以把 UE4CommandLine.txt 放到包路径下就可以了，可以使用 iMaZing 或者爱思助手之类的工具访问 App 的数据目录，放入 ue4commandline.txt 即可。</p>
<ul>
<li><a href="https://www.cnblogs.com/xiaodao/archive/2012/07/03/2574703.html">NSBundle</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
      </categories>
      <tags>
        <tag>Mobile</tag>
      </tags>
  </entry>
  <entry>
    <title>移动端相对到绝对路径转换</title>
    <url>/wiki/17479/</url>
    <content><![CDATA[<h3 id="IOS 相对到绝对路径转换"><a href="#IOS 相对到绝对路径转换" class="headerlink" title="IOS 相对到绝对路径转换"></a>IOS 相对到绝对路径转换 </h3><p> 在接入的一些库中，需要传递文件的绝对路径，可以通过下面的方式进行转换： </p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">IFileManager::<span class="built_in">Get</span>().<span class="built_in">ConvertToAbsolutePathForExternalAppForRead</span>(*InRelatePath);; </span><br></pre></td></tr></table></figure>
<p>它是定义在 <code>IFileManager</code> 接口中的一个虚函数，应该在各个平台的 PlatformFile 中均有自己的实现，但是在 Android 中依然是相对路径的，不知道 UE 是不是忘了实现了。  </p>
<p>IOS：<a href="https://github.com/EpicGames/UnrealEngine/blob/df84cb430f38ad08ad831f31267d8702b2fefc3e/Engine/Source/Runtime/Core/Public/IOS/IOSPlatformFile.h#L38">Runtime/Core/Public/IOS/IOSPlatformFile.h</a>  </p>
<p>Android 上相对路径转换成绝对路径的方式在之前的笔记中有写。</p>
<h3 id="Android 相对路径转绝对路径"><a href="#Android 相对路径转绝对路径" class="headerlink" title="Android 相对路径转绝对路径"></a>Android 相对路径转绝对路径 </h3><p> 有些需求需要把 <code>FPaths::ProjectDir()</code> 等路径转换为移动设备上的绝对路径，可以参考 <a href="https://github.com/EpicGames/UnrealEngine/blob/2bf1a5b83a7076a0fd275887b373f8ec9e99d431/Engine/Source/Runtime/Core/Private/Android/AndroidPlatformFile.cpp#L126">Core/Private/Android/AndroidPlatformFile.cpp#L126</a> 中的实现：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Constructs the base path for any files which are not in OBB/pak data</span></span><br><span class="line"><span class="function"><span class="keyword">const</span> FString &amp;<span class="title">GetFileBasePath</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">static</span> FString BasePath = GFilePathBase + <span class="built_in">FString</span>(FILEBASE_DIRECTORY) + FApp::<span class="built_in">GetProjectName</span>() + <span class="built_in">FString</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> BasePath;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">FString <span class="title">AndroidRelativeToAbsolutePath</span><span class="params">(<span class="keyword">bool</span> bUseInternalBasePath, FString RelPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (RelPath.<span class="built_in">StartsWith</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;../&quot;</span>), ESearchCase::CaseSensitive))</span><br><span class="line">  &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      RelPath.<span class="built_in">RightChopInline</span>(<span class="number">3</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125; <span class="keyword">while</span> (RelPath.<span class="built_in">StartsWith</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;../&quot;</span>), ESearchCase::CaseSensitive));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (bUseInternalBasePath ? GInternalFilePath : <span class="built_in">GetFileBasePath</span>()) / RelPath;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> RelPath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Mobile</tag>
        <tag>IOS</tag>
      </tags>
  </entry>
  <entry>
    <title>Export Recast Navigation Data from UE4</title>
    <url>/wiki/20203/</url>
    <content><![CDATA[<blockquote>
<p>最新版本已支持 UE5，详见 github 的 UE5.0 分支：<a href="https://github.com/hxhb/ue4-export-nav-data/tree/UE5.0">ue4-export-nav-data/tree/UE5.0</a>。</p>
</blockquote>
<p><a href="https://github.com/recastnavigation/recastnavigation">Recast Navigation</a>是一个开源的游戏导航 / 寻路引擎，可以为游戏中的 AI 提供寻路计算。UE 和 Unity 都是集成了 RecastNavigation 来为游戏提供导航和寻路计算 (当然是修改过的版本)，UE 的模块<code>NavigationSystem</code> 以及 <code>NavMesh</code> 中可以看到相关的代码实现。<br>最近有个需求是要将客户端的地图信息导出给非 UE 网络架构的服务端，用于在服务器上对玩家位置的校验，想到可以把客户端的生成的导航数据导出作为客户端世界的 <strong> 地图 </strong>，所以折腾了一下写了一个 UE 的插件（开源在 Github 上：**<a href="https://github.com/hxhb/ue4-export-nav-data">ue4-export-nav-data</a><strong>）实现了</strong> 直接 ** 将 UE 生成的导航数据导出，有兴趣的可以直接去看具体的代码。<br>根据导出的导航数据可以完整地在非 UE 网络架构的服务端上实现基于 <a href="https://github.com/recastnavigation/recastnavigation">Recast Navigation</a> 的寻路计算，而且与 UE 无缝衔接。</p>
<blockquote>
<p>**2019.12.04 Update:** 本插件已上架虚幻商城，购买链接<a href="https://unrealengine.com/marketplace/en-US/slug/exportnavigation">ExportNavigation</a>，为了程序员情怀支持开源，所以该项目在 Github 上的开源仓库不会关闭，但基本不会更新，如果该插件对你有用，欢迎在商城购买支持作者。</p>
</blockquote>
<span id="more"></span>

<h2 id="Recast-Navigation"><a href="#Recast-Navigation" class="headerlink" title="Recast Navigation"></a>Recast Navigation</h2><p>首先，先来简单介绍一下编译 Recast 的 github 开源版本，UE 引擎中使用的 recast 就是基于该开源版本修改的，截止到 <code>UE_4.22.3</code>，UE 使用的 recast 版本为<code>v1.4</code>(可以从<code>Source/Runtime/Navmesh/Recast-Readme.txt</code> 中查看不同引擎版本使用的 recast 版本信息)。<br>RecastNavigation 在 Github 上的源码地址：<a href="https://github.com/recastnavigation/recastnavigation">recastnavigation</a>.<br><a href="https://github.com/recastnavigation/recastnavigation">recastnavigation</a>的代码中提供了导航网格生成与计算寻路的工具<code>RecastDemo</code>，可以作为在项目中集成 RecastNavigation 的案例。</p>
<p><code>README.md</code>里面写了各个平台的编译流程，我在这里详细展开一下 Windows 下编译流程。</p>
<ol>
<li>首先下载<a href="https://premake.github.io/download.html">premake5</a>，并将其添加到系统 PATH 路径</li>
<li>clone RecastNavigation 的代码</li>
<li>下载 <a href="https://www.libsdl.org/download-2.0.php">SDL2</a>（选择 Development Libraries），并将其解压到<code>recastnavigation\RecastDemo\Contrib</code> 目录下，将文件夹改名为<code>SDL</code>，目录结构为：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">D:\recastnavigation\RecastDemo\Contrib\SDL&gt;tree /a</span><br><span class="line">+---docs</span><br><span class="line">+---include</span><br><span class="line">\---lib</span><br><span class="line">    +---x64</span><br><span class="line">    \---x86</span><br></pre></td></tr></table></figure>
<ol start="4">
<li><p>在 <code>recastnavigation\RecastDemo</code> 目录下执行命令 <code>premake5 vs2017</code>(vs201x 取决于你当前系统中安装的版本)，它会在<code>RecastDemo</code> 目录下创建 <code>build/vs2017</code> 目录，里面是 VS 项目的解决方案。<br> <img src="https://img.imzlp.com/imgs/zlp/blog/posts/20203/recast-premake-generate-vs-solution.webp"></p>
</li>
<li><p>打开<code>RecastDemo\Build\vs2017\recastnavigation.sln</code>，编译即可。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/20203/build-recastnavigation.webp"></p>
</li>
<li><p>编译出来 <code>RecastDemo.exe</code> 位置在<code>RecastDemo\Bin</code>。</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">C:\Users\imzlp\<span class="built_in">source</span>\repos\recastnavigation\RecastDemo\Bin&gt;tree /a /f</span><br><span class="line">文件夹 PATH 列表 </span><br><span class="line"> 卷序列号为 000002D0 ECDB:6872</span><br><span class="line">C:.</span><br><span class="line">|   .gitignore</span><br><span class="line">|   DroidSans.ttf</span><br><span class="line">|   RecastDemo.exe</span><br><span class="line">|   RecastDemo.pdb</span><br><span class="line">|   SDL2.dll</span><br><span class="line">|   Tests.exe</span><br><span class="line">|   Tests.pdb</span><br><span class="line">|</span><br><span class="line">+---Meshes</span><br><span class="line">|       dungeon.obj</span><br><span class="line">|       nav_test.obj</span><br><span class="line">|       undulating.obj</span><br><span class="line">|</span><br><span class="line">\---TestCases</span><br><span class="line">        movement_test.txt</span><br><span class="line">        nav_mesh_test.txt</span><br><span class="line">        raycast_test.txt</span><br></pre></td></tr></table></figure>

<p>其中关键的几个文件：<code>DroidSans.ttf</code>/<code>RecastDemo.exe</code>/<code>SDL2.dll</code>/<code>Meshs/</code>。</p>
<blockquote>
<p>注意：必须把 obj 文件放到 <code>Meshs/</code> 目录下才可以被 <code>RecastDemo</code> 识别。</p>
</blockquote>
<p>之后就可以打开 <code>RecastDemo.exe</code> 在默认提供的三个 <code>obj</code> 的模型上进行导航数据生成的测试了，通过 <code>Build</code> 生成，然后 Save 保存会在 <code>RecastDemo.exe</code> 所在的目录产生一个 <code>.bin</code> 文件，即使用 recast 生成的导航数据。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/20203/recast-navigation-RecastDemo.webp"></p>
<p><strong>注意 </strong>：从 UE 导出 Navmesh 的含义是，把 UE 寻路范围内的模型导出，再通过<code>RecastDemo</code> 在该模型的基础上生成寻路数据。这也导致了在 UE 中添加影响寻路的框，导出 Navmesh 在 <code>RecastDemo</code> 生成时无法生效。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/20203/diff-ue-nav-and-recastdemo-nav.webp"></p>
<h2 id="Plugin-ue-export-nav-data"><a href="#Plugin-ue-export-nav-data" class="headerlink" title="Plugin:  ue-export-nav-data"></a>Plugin:  ue-export-nav-data</h2><p>该插件是从 UE 中导出 RecastNavigation 的工具，分为两个模块：<code>ExportNavRuntime</code>与 <code>ExportNavEditor</code>，编辑器模块提供了 UE 中编辑器<code>ToolBar</code> 的按钮，在编辑器中导出导航数据。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/20203/ue-export-nav-plugin-button.webp"></p>
<p>点击之后选择路径，会在选择的路径下生成两个文件：<code>.bin</code>与<code>obj</code>，在 Windows 下会自动在资源管理器中打开导出目录。</p>
<ul>
<li>bin：UE 构建完成的导航数据，给外部服务器使用。</li>
<li>obj：UE 中放置寻路的 Mesh，可以从 RecastDemo 中生成 bin 文件。</li>
</ul>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/20203/ue-export-nav-plugin-button-2.webp"><br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/20203/ue-export-nav-plugin-button-3.webp"></p>
<p>另外，我提供了 <code>NavData</code> 可以在运行时导出，但是 <code>NavMesh</code> 不支持，因为 UE 的导航是预计算的，具体可以看 <code>UFlibExportNavData</code> 中提供的方法。</p>
<p>我在 C++ 和蓝图中也提供了从导出的 bin 中验证位置是否是合法的寻路位置的两种方法：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UFlibExportNavData::IsValidNavigationPointInNavbin</span><span class="params">(<span class="keyword">const</span> FString&amp; InNavBinPath, <span class="keyword">const</span> FVector&amp; Point, <span class="keyword">const</span> FVector InExtern = FVector::ZeroVector)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UFlibExportNavData::IsValidNavigationPointInNavObj</span><span class="params">(class UdtNavMeshWrapper* InDtNavObject ,<span class="keyword">const</span> FVector&amp; Point, <span class="keyword">const</span> FVector InExtern = FVector::ZeroVector)</span></span>;</span><br></pre></td></tr></table></figure>
<p>可以与 UE 中提供的 <code>UNavigationSystemV1::ProjectPointToNavigation</code> 来对比验证导出数据是否匹配。</p>
<p>还有一个传入起始点来获取导航路径点的方法：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FindDetourPathByNavMesh</span><span class="params">(dtNavMesh* InNavMesh ,<span class="keyword">const</span> FVector3&amp; InStart, <span class="keyword">const</span> FVector3&amp; InEnd, std::vector&lt;FVector3&gt;&amp; OutPaths)</span></span>;</span><br></pre></td></tr></table></figure>

<p>可以与引擎中 <code>UNavigationSystemV1::FindPathToLocationSynchrously</code> 的结果一致，传入游戏中的世界坐标，函数内部有转换，返回的也是世界坐标。</p>
<p>该插件其优点为：</p>
<ul>
<li>并非先从 UE 导出 NavMesh 的 <code>.obj</code> 再使用 <code>RecastDemo</code> 生成，而是直接从 UE 导出<code>bin</code>，当然我也保留了导出 NavMesh 为<code>obj</code>；</li>
<li>因为是直接从 UE 生成之后的导航数据导出，所以是所见即所得，解决导出 NavMesh 再 RecastDemo 生成导航网格时无法避免某些区域不生成寻路，以及避免 UE 与 RecastDemo 各种寻路参数的不一致产生的寻路数据不一致；</li>
<li>额外抽取出 ue 的 ue-detour 版本，可以无缝集成到外部服务器中，客户端坐标与服务端坐标无需转换(当然 UE 的坐标与 Recast 的坐标需要转换，但是内部已经处理，使用时不需要手动转换)。</li>
</ul>
<p>UE 的坐标系与 Recast 的坐标系之间的转换可以使用 <code>UE4RecastHelper</code> 的两个函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> UE4RecastHelper</span><br><span class="line">&#123;</span><br><span class="line">	<span class="function">FCustomVector <span class="title">Recast2UnrealPoint</span><span class="params">(<span class="keyword">const</span> FCustomVector&amp; Vector)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">FCustomVector</span>(-Vector.X, -Vector.Z, Vector.Y);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">FCustomVector <span class="title">Unreal2RecastPoint</span><span class="params">(<span class="keyword">const</span> FCustomVector&amp; Vector)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">FCustomVector</span>(-Vector.X, Vector.Z, -Vector.Y);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Library-ue-recast-detour"><a href="#Library-ue-recast-detour" class="headerlink" title="Library: ue-recast-detour"></a>Library: ue-recast-detour</h2><p>这个是我从 UE 代码中抽取出的 recast detour 库，在 UE 源码的路径下为<code>Runtime/Navmesh/Detour</code>，主要目的是保证 UE 客户端与外部服务器的验证方法一致。</p>
<p>因为在 github 上的 <a href="https://github.com/recastnavigation/recastnavigation">RecastNavigation</a> 要高于 UE 使用的版本，而且前面提到 UE 在 recast 的基础上做了不少改动，为了防止代码的差异造成的不同结果，我将 ue 使用 (以及魔改) 过的版本抽出来供外部使用，这样可以确保客户端和服务端的结果是一致的。</p>
<p>代码放在了 github：<a href="https://github.com/hxhb/ue4-recast-detour">ue4-recast-detour</a>，该仓库的 <code>Detour/</code> 目录下为 Detour 的库的全部代码。<br>其余的代码是我实现的与 UE 进行验证和 UE 与 Recast 坐标转换的库 <code>UE4RecastHelper</code> 类以及实现的一个简单的命令行程序，用来测试 UE 中的世界位置是否在 bin 中的寻路数据中合法。</p>
<p><code>UE4RecastHelper</code>目前 (2019.11.01) 提供了 <code>dtNavMesh</code> 与<code>bin</code>文件之间 <code>serialize</code>/<code>deserialize</code> 的方法；以及与 UE 中函数 <code>UNavigationSystemV1::ProjectPointToNavigation</code> 实现方法相同的函数<code>UE4RecastHelper::dtIsValidNavigationPoint</code>，用来验证点是否是合法的寻路点，保证了 UE 客户端与外部服务器的验证方法一致。</p>
<p><code>Detour</code>所支持的操作都可以在服务器上实现(因为已经从 UE 里拿到了导航数据)，可以根据需求扩展。</p>
<p>再简单说一下 <code>ue-detour.exe</code> 这个工具怎么用，直接在命令行启动 <code>ue4-detour.exe</code> 会提示用法。<br>首先，要先从 UE 中将导航数据导出，这里需要用到的只有 <code>.bin</code> 文件，如生成在 <code>D:\NavData</code>。<br> 然后找到 <code>ue4-detour.exe</code> 就可以使用下列命令了：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">D:\&gt;ue4-detour.exe</span><br><span class="line">Usage:</span><br><span class="line">        ue4-detour.exe dtNavMesh.bin Loc.X Loc.Y,loc.Z Extren.X Extern.Y Extren.Z</span><br><span class="line">PS:&#123;Extern.X Extern.Y Extern.Z&#125; can be ignored,default is &#123;10.f 10.f 10.f&#125;</span><br><span class="line">For Example:</span><br><span class="line">        ue4-detour.exe dtNavMesh.bin -770.003 -593.709 130.267 10.0 10.0 10.0</span><br></pre></td></tr></table></figure>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/20203/verify-ue-location-in-nav-data.webp"><br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/20203/verify-ue-location-in-nav-data-1.webp"></p>
<p>在蓝图中也可以直接加载 <code>.bin</code> 进行测试：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/20203/verify-ue-location-in-nav-data-in-blueprint.webp"></p>
<h2 id="End"><a href="#End" class="headerlink" title="End"></a>End</h2><p>本篇文章用到的开源仓库：</p>
<ul>
<li><a href="https://github.com/recastnavigation/recastnavigation">Recast Navigation</a></li>
<li><a href="https://github.com/hxhb/ue4-export-nav-data">ue4-export-nav-data</a></li>
<li><a href="https://github.com/hxhb/ue4-recast-detour">ue4-recast-detour</a></li>
</ul>
<h2 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h2><p><strong>2021.05.27 Update</strong>：</p>
<ul>
<li>插件支持 UE5，支持导出 UE5 的 NavMesh 数据及导航网格</li>
<li>数据与 ue-detour 验证成功</li>
</ul>
<p><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210527144337.webp"><br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210527144040.webp"></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>NavMesh</category>
      </categories>
      <tags>
        <tag>Recast</tag>
        <tag>NavMesh</tag>
        <tag>Navigation</tag>
      </tags>
  </entry>
  <entry>
    <title>Navmesh bounds are too large</title>
    <url>/wiki/12781/</url>
    <content><![CDATA[<p>当地图相当大，在生成导航时会有以下提示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">LogNavigation: Error: Navmesh bounds are too large! Limiting requested tiles count (5472000) to: (1048576) for RecastNavMesh /Game/Level/Map.Map:PersistentLevel.RecastNavMesh-Default</span><br></pre></td></tr></table></figure>
<p>这是因为地图太大，超出了 Tile 的数量限制。<br>引擎中默认 Tile 的最大数量为 <code>1&lt;&lt;20</code> 也就是 1048576，这个值可以修改配置，但不能大于<code>1&lt;&lt;30</code>(因为它用 int32 存储)。</p>
<figure class="highlight cpp"><figcaption><span>Source/Runtime/NavigationSystem/Public/NavMesh/RecastNavMesh.h</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="built_in">UCLASS</span>(config=Engine, defaultconfig, hidecategories=(Input,Rendering,Tags,<span class="string">&quot;Utilities|Transformation&quot;</span>,Actor,Layers,Replication), notplaceable)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NAVIGATIONSYSTEM_API</span> <span class="title">ARecastNavMesh</span> :</span> <span class="keyword">public</span> ANavigationData</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">/** Absolute hard limit to number of navmesh tiles. Be very, very careful while modifying it while</span></span><br><span class="line"><span class="comment">   *  having big maps with navmesh. A single, empty tile takes 176 bytes and empty tiles are</span></span><br><span class="line"><span class="comment">   *  allocated up front (subject to change, but that&#x27;s where it&#x27;s at now)</span></span><br><span class="line"><span class="comment">   *  @note TileNumberHardLimit is always rounded up to the closest power of 2 */</span></span><br><span class="line">  <span class="built_in">UPROPERTY</span>(EditAnywhere, Category = Generation, config, meta = (ClampMin = <span class="string">&quot;1&quot;</span>, UIMin = <span class="string">&quot;1&quot;</span>), AdvancedDisplay)</span><br><span class="line">  int32 TileNumberHardLimit;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>以及使用：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/NavigationSystem/Private/NavMesh/RecastNavMesh.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line">FRecastNavMeshGenerationProperties::<span class="built_in">FRecastNavMeshGenerationProperties</span>()</span><br><span class="line">&#123;</span><br><span class="line">  TilePoolSize = <span class="number">1024</span>;</span><br><span class="line">  TileSizeUU = <span class="number">988.f</span>;</span><br><span class="line">  CellSize = <span class="number">19</span>;</span><br><span class="line">  CellHeight = <span class="number">10</span>;</span><br><span class="line">  AgentRadius = <span class="number">34.f</span>;</span><br><span class="line">  AgentHeight = <span class="number">144.f</span>;</span><br><span class="line">  AgentMaxSlope = <span class="number">44.f</span>;</span><br><span class="line">  AgentMaxStepHeight = <span class="number">35.f</span>;</span><br><span class="line">  MinRegionArea = <span class="number">0.f</span>;</span><br><span class="line">  MergeRegionSize = <span class="number">400.f</span>;</span><br><span class="line">  MaxSimplificationError = <span class="number">1.3f</span>;  <span class="comment">// from RecastDemo</span></span><br><span class="line">  TileNumberHardLimit = <span class="number">1</span> &lt;&lt; <span class="number">20</span>;</span><br><span class="line">  RegionPartitioning = ERecastPartitioning::Watershed;</span><br><span class="line">  LayerPartitioning = ERecastPartitioning::Watershed;</span><br><span class="line">  RegionChunkSplits = <span class="number">2</span>;</span><br><span class="line">  LayerChunkSplits = <span class="number">2</span>;</span><br><span class="line">  bSortNavigationAreasByCost = <span class="literal">false</span>;</span><br><span class="line">  bPerformVoxelFiltering = <span class="literal">true</span>;</span><br><span class="line">  bMarkLowHeightAreas = <span class="literal">false</span>;</span><br><span class="line">  bUseExtraTopCellWhenMarkingAreas = <span class="literal">true</span>;</span><br><span class="line">  bFilterLowSpanSequences = <span class="literal">false</span>;</span><br><span class="line">  bFilterLowSpanFromTileCache = <span class="literal">false</span>;</span><br><span class="line">  bFixedTilePoolSize = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FRecastNavMeshGenerationProperties::<span class="built_in">FRecastNavMeshGenerationProperties</span>(<span class="keyword">const</span> ARecastNavMesh&amp; RecastNavMesh)</span><br><span class="line">&#123;</span><br><span class="line">  TilePoolSize = RecastNavMesh.TilePoolSize;</span><br><span class="line">  TileSizeUU = RecastNavMesh.TileSizeUU;</span><br><span class="line">  CellSize = RecastNavMesh.CellSize;</span><br><span class="line">  CellHeight = RecastNavMesh.CellHeight;</span><br><span class="line">  AgentRadius = RecastNavMesh.AgentRadius;</span><br><span class="line">  AgentHeight = RecastNavMesh.AgentHeight;</span><br><span class="line">  AgentMaxSlope = RecastNavMesh.AgentMaxSlope;</span><br><span class="line">  AgentMaxStepHeight = RecastNavMesh.AgentMaxStepHeight;</span><br><span class="line">  MinRegionArea = RecastNavMesh.MinRegionArea;</span><br><span class="line">  MergeRegionSize = RecastNavMesh.MergeRegionSize;</span><br><span class="line">  MaxSimplificationError = RecastNavMesh.MaxSimplificationError;</span><br><span class="line">  TileNumberHardLimit = RecastNavMesh.TileNumberHardLimit;</span><br><span class="line">  RegionPartitioning = RecastNavMesh.RegionPartitioning;</span><br><span class="line">  LayerPartitioning = RecastNavMesh.LayerPartitioning;</span><br><span class="line">  RegionChunkSplits = RecastNavMesh.RegionChunkSplits;</span><br><span class="line">  LayerChunkSplits = RecastNavMesh.LayerChunkSplits;</span><br><span class="line">  bSortNavigationAreasByCost = RecastNavMesh.bSortNavigationAreasByCost;</span><br><span class="line">  bPerformVoxelFiltering = RecastNavMesh.bPerformVoxelFiltering;</span><br><span class="line">  bMarkLowHeightAreas = RecastNavMesh.bMarkLowHeightAreas;</span><br><span class="line">  bUseExtraTopCellWhenMarkingAreas = RecastNavMesh.bUseExtraTopCellWhenMarkingAreas;</span><br><span class="line">  bFilterLowSpanSequences = RecastNavMesh.bFilterLowSpanSequences;</span><br><span class="line">  bFilterLowSpanFromTileCache = RecastNavMesh.bFilterLowSpanFromTileCache;</span><br><span class="line">  bFixedTilePoolSize = RecastNavMesh.bFixedTilePoolSize;</span><br><span class="line">&#125;</span><br><span class="line">ARecastNavMesh::<span class="built_in">ARecastNavMesh</span>(<span class="keyword">const</span> FObjectInitializer&amp; ObjectInitializer)</span><br><span class="line">  : <span class="built_in">Super</span>(ObjectInitializer)</span><br><span class="line">  , <span class="built_in">bDrawFilledPolys</span>(<span class="literal">true</span>)</span><br><span class="line">  , <span class="built_in">bDrawNavMeshEdges</span>(<span class="literal">true</span>)</span><br><span class="line">  , <span class="built_in">bDrawNavLinks</span>(<span class="literal">true</span>)</span><br><span class="line">  , <span class="built_in">bDrawOctreeDetails</span>(<span class="literal">true</span>)</span><br><span class="line">  , <span class="built_in">bDrawMarkedForbiddenPolys</span>(<span class="literal">false</span>)</span><br><span class="line">  , <span class="built_in">bDistinctlyDrawTilesBeingBuilt</span>(<span class="literal">true</span>)</span><br><span class="line">  , <span class="built_in">DrawOffset</span>(<span class="number">10.f</span>)</span><br><span class="line">  , <span class="built_in">TilePoolSize</span>(<span class="number">1024</span>)</span><br><span class="line">  , <span class="built_in">MaxSimplificationError</span>(<span class="number">1.3f</span>)  <span class="comment">// from RecastDemo</span></span><br><span class="line">  , <span class="built_in">DefaultMaxSearchNodes</span>(RECAST_MAX_SEARCH_NODES)</span><br><span class="line">  , <span class="built_in">DefaultMaxHierarchicalSearchNodes</span>(RECAST_MAX_SEARCH_NODES)</span><br><span class="line">  , <span class="built_in">bPerformVoxelFiltering</span>(<span class="literal">true</span>)  </span><br><span class="line">  , <span class="built_in">bMarkLowHeightAreas</span>(<span class="literal">false</span>)</span><br><span class="line">  , <span class="built_in">bUseExtraTopCellWhenMarkingAreas</span>(<span class="literal">true</span>)</span><br><span class="line">  , <span class="built_in">bFilterLowSpanSequences</span>(<span class="literal">false</span>)</span><br><span class="line">  , <span class="built_in">bFilterLowSpanFromTileCache</span>(<span class="literal">false</span>)</span><br><span class="line">  , <span class="built_in">bStoreEmptyTileLayers</span>(<span class="literal">false</span>)</span><br><span class="line">  , <span class="built_in">bUseVirtualFilters</span>(<span class="literal">true</span>)</span><br><span class="line">  , <span class="built_in">bAllowNavLinkAsPathEnd</span>(<span class="literal">false</span>)</span><br><span class="line">  , <span class="built_in">TileSetUpdateInterval</span>(<span class="number">1.0f</span>)</span><br><span class="line">  , <span class="built_in">NavMeshVersion</span>(NAVMESHVER_LATEST) </span><br><span class="line">  , <span class="built_in">RecastNavMeshImpl</span>(<span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  HeuristicScale = <span class="number">0.999f</span>;</span><br><span class="line">  RegionPartitioning = ERecastPartitioning::Watershed;</span><br><span class="line">  LayerPartitioning = ERecastPartitioning::Watershed;</span><br><span class="line">  RegionChunkSplits = <span class="number">2</span>;</span><br><span class="line">  LayerChunkSplits = <span class="number">2</span>;</span><br><span class="line">  MaxSimultaneousTileGenerationJobsCount = <span class="number">1024</span>;</span><br><span class="line">  bDoFullyAsyncNavDataGathering = <span class="literal">false</span>;</span><br><span class="line">  TileNumberHardLimit = <span class="number">1</span> &lt;&lt; <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> RECAST_ASYNC_REBUILDING</span></span><br><span class="line">  BatchQueryCounter = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// RECAST_ASYNC_REBUILDING</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">HasAnyFlags</span>(RF_ClassDefaultObject) == <span class="literal">false</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">INC_DWORD_STAT_BY</span>(STAT_NavigationMemory, <span class="built_in"><span class="keyword">sizeof</span></span>(*<span class="keyword">this</span>) );</span><br><span class="line"></span><br><span class="line">    FindPathImplementation = FindPath;</span><br><span class="line">    FindHierarchicalPathImplementation = FindPath;</span><br><span class="line"></span><br><span class="line">    TestPathImplementation = TestPath;</span><br><span class="line">    TestHierarchicalPathImplementation = TestHierarchicalPath;</span><br><span class="line"></span><br><span class="line">    RaycastImplementation = NavMeshRaycast;</span><br><span class="line"></span><br><span class="line">    RecastNavMeshImpl = <span class="keyword">new</span> <span class="built_in">FPImplRecastNavMesh</span>(<span class="keyword">this</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// add predefined areas up front</span></span><br><span class="line">    SupportedAreas.<span class="built_in">Add</span>(<span class="built_in">FSupportedAreaData</span>(UNavArea_Null::<span class="built_in">StaticClass</span>(), RECAST_NULL_AREA));</span><br><span class="line">    SupportedAreas.<span class="built_in">Add</span>(<span class="built_in">FSupportedAreaData</span>(UNavArea_LowHeight::<span class="built_in">StaticClass</span>(), RECAST_LOW_AREA));</span><br><span class="line">    SupportedAreas.<span class="built_in">Add</span>(<span class="built_in">FSupportedAreaData</span>(UNavArea_Default::<span class="built_in">StaticClass</span>(), RECAST_DEFAULT_AREA));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>TileNumberHardLimit</code>的值可以通过配置文件进行设置：</p>
<figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="section">[/Script/NavigationSystem.RecastNavMesh]</span></span><br><span class="line"><span class="attr">bDrawPolyEdges</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">bDistinctlyDrawTilesBeingBuilt</span>=<span class="literal">True</span></span><br><span class="line"><span class="attr">DrawOffset</span>=<span class="number">10.000000</span></span><br><span class="line"><span class="attr">bFixedTilePoolSize</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">TilePoolSize</span>=<span class="number">1024</span></span><br><span class="line"><span class="attr">TileSizeUU</span>=<span class="number">1000.000000</span></span><br><span class="line"><span class="attr">CellSize</span>=<span class="number">19.000000</span></span><br><span class="line"><span class="attr">CellHeight</span>=<span class="number">10.000000</span></span><br><span class="line"><span class="attr">AgentRadius</span>=<span class="number">34.000000</span></span><br><span class="line"><span class="attr">AgentHeight</span>=<span class="number">144.000000</span></span><br><span class="line"><span class="attr">AgentMaxHeight</span>=<span class="number">160.000000</span></span><br><span class="line"><span class="attr">AgentMaxSlope</span>=<span class="number">44.000000</span></span><br><span class="line"><span class="attr">AgentMaxStepHeight</span>=<span class="number">35.000000</span></span><br><span class="line"><span class="attr">MinRegionArea</span>=<span class="number">0.000000</span></span><br><span class="line"><span class="attr">MergeRegionSize</span>=<span class="number">400.000000</span></span><br><span class="line"><span class="attr">MaxSimplificationError</span>=<span class="number">1.300000</span></span><br><span class="line"><span class="attr">MaxSimultaneousTileGenerationJobsCount</span>=<span class="number">1024</span></span><br><span class="line"><span class="attr">TileNumberHardLimit</span>=<span class="number">1048576</span></span><br><span class="line"><span class="attr">DefaultDrawDistance</span>=<span class="number">5000.000000</span></span><br><span class="line"><span class="attr">DefaultMaxSearchNodes</span>=<span class="number">2048.000000</span></span><br><span class="line"><span class="attr">DefaultMaxHierarchicalSearchNodes</span>=<span class="number">2048.000000</span></span><br><span class="line"><span class="attr">RegionPartitioning</span>=Watershed</span><br><span class="line"><span class="attr">LayerPartitioning</span>=Watershed</span><br><span class="line"><span class="attr">RegionChunkSplits</span>=<span class="number">2</span></span><br><span class="line"><span class="attr">LayerChunkSplits</span>=<span class="number">2</span></span><br><span class="line"><span class="attr">bSortNavigationAreasByCost</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">bPerformVoxelFiltering</span>=<span class="literal">True</span></span><br><span class="line"><span class="attr">bMarkLowHeightAreas</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">bDoFullyAsyncNavDataGathering</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">bUseBetterOffsetsFromCorners</span>=<span class="literal">True</span></span><br><span class="line"><span class="attr">bUseVirtualFilters</span>=<span class="literal">True</span></span><br><span class="line"><span class="attr">bUseVoxelCache</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">TileSetUpdateInterval</span>=<span class="number">1.000000</span></span><br><span class="line"><span class="attr">HeuristicScale</span>=<span class="number">0.999000</span></span><br><span class="line"><span class="attr">VerticalDeviationFromGroundCompensation</span>=<span class="number">0.000000</span></span><br><span class="line"><span class="attr">bForceRebuildOnLoad</span>=<span class="literal">True</span></span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>NavMesh</category>
      </categories>
      <tags>
        <tag>NavMesh</tag>
        <tag>Navigation</tag>
      </tags>
  </entry>
  <entry>
    <title>使用 HTTP 请求下载文件的坑和技巧</title>
    <url>/wiki/42238/</url>
    <content><![CDATA[<p>使用 HTTP 可以请求下载文件，response 的结果就是文件的内容。<br>在下载一个文件之前可以先使用 <code>HEAD</code> 请求来只获取头，可以从 <code>Content-Length</code> 头获取到文件的大小。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// head request</span></span><br><span class="line">TSharedRef&lt;IHttpRequest&gt; HttpHeadRequest = FHttpModule::<span class="built_in">Get</span>().<span class="built_in">CreateRequest</span>();</span><br><span class="line">HttpHeadRequest-&gt;<span class="built_in">OnHeaderReceived</span>().<span class="built_in">BindUObject</span>(<span class="keyword">this</span>, &amp;UDownloadProxy::OnRequestHeadHeaderReceived);</span><br><span class="line">HttpHeadRequest-&gt;<span class="built_in">OnProcessRequestComplete</span>().<span class="built_in">BindUObject</span>(<span class="keyword">this</span>, &amp;UDownloadProxy::OnRequestHeadComplete);</span><br><span class="line">HttpHeadRequest-&gt;<span class="built_in">SetURL</span>(InternalDownloadFileInfo.URL);</span><br><span class="line">HttpHeadRequest-&gt;<span class="built_in">SetVerb</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;HEAD&quot;</span>));</span><br><span class="line">HttpHeadRequest-&gt;<span class="built_in">ProcessRequest</span>();</span><br></pre></td></tr></table></figure>
<p>在 UE 中需要通过监听 HTTP 请求的 <code>OnHeaderReceived</code> 派发来获得想要的头数据：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UDownloadProxy::OnRequestHeadHeaderReceived</span><span class="params">(FHttpRequestPtr RequestPtr, <span class="keyword">const</span> FString&amp; InHeaderName, <span class="keyword">const</span> FString&amp; InNewHeaderValue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (InHeaderName.<span class="built_in">Equals</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Content-Length&quot;</span>)))</span><br><span class="line">	&#123;</span><br><span class="line">		InternalDownloadFileInfo.Size = UKismetStringLibrary::<span class="built_in">Conv_StringToInt</span>(InNewHeaderValue);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后就可以用 <code>Get</code> 方法来请求文件了：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// get request</span></span><br><span class="line">TSharedRef&lt;IHttpRequest&gt; HttpRequest = FHttpModule::<span class="built_in">Get</span>().<span class="built_in">CreateRequest</span>();</span><br><span class="line">HttpRequest-&gt;<span class="built_in">OnRequestProgress</span>().<span class="built_in">BindUObject</span>(<span class="keyword">this</span>, &amp;UDownloadProxy::OnDownloadProcess, bIsSlice?EDownloadType::Slice:EDownloadType::Start);</span><br><span class="line">HttpRequest-&gt;<span class="built_in">OnProcessRequestComplete</span>().<span class="built_in">BindUObject</span>(<span class="keyword">this</span>, &amp;UDownloadProxy::OnDownloadComplete);</span><br><span class="line">HttpRequest-&gt;<span class="built_in">SetURL</span>(InternalDownloadFileInfo.URL);</span><br><span class="line">HttpRequest-&gt;<span class="built_in">SetVerb</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;GET&quot;</span>));</span><br><span class="line">RangeArgs = <span class="built_in">TEXT</span>(<span class="string">&quot;bytes=0-&quot;</span>)+FString::<span class="built_in">FromInt</span>(FileTotalByte);</span><br><span class="line">HttpRequest-&gt;<span class="built_in">SetHeader</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Range&quot;</span>), RangeArgs);</span><br><span class="line">HttpRequest-&gt;<span class="built_in">ProcessRequest</span>();</span><br></pre></td></tr></table></figure>
<p>其中 Range 头的格式为：<code>Byte=0-</code>指请求整个文件的大小，<code>Byte=0-99</code>则是请求前 100byte，<strong>注意请求的范围不要超过文件大小 </strong>，不然会有 400 错误。<br> 通过控制 HTTP 请求的 <code>Range</code> 头，我们可以指定下载文件的任意部分，可以实现暂停继续 / 分片下载。</p>
<blockquote>
<p>在 UE 中使用 HTTP 请求一个大文件的时候，如果该请求没有结束就去拿 response 的结果一定要注意一个问题：那就是 Response 的 Content 数据 <code>Payload</code> 是一个 <code>TArray</code> 动态数组，当 Content 的内容不断地被写入，会导致容器的 <code>Reserve</code> 也就是内存重新分配，获取该数组的内存地址是非常危险的。</p>
</blockquote>
<p>所以建议在 HTTP 请求时先对 response 的 Content 的 <code>Payload</code> 进行 <code>Reserve</code> 使其能够容纳足够数量的数据，缺点就是会一次性占用整个文件的内存。<br>解决内存占用的办法就是通过 <code>Http</code> 请求的 <code>Range</code> 来实现分片下载（也就是把一个大文件分成数个小块，一块一块地下载），从而降低内存占用，</p>
<p>当下载文件后，通常还有进行文件校验的操作，等文件下载完之后再执行校验（如 MD5 计算）时间会很长，所以要解决校验的时间问题，想过开一个线程去计算，但是开线程只解决了不阻塞主线程，不会加速 MD5 的计算过程，后来想到 <code>MD5</code> 是摘要计算，进而联想到可不可以边下边进行 MD5 计算，根据 <strong> 没有全新的轮子定理 </strong>（我瞎掰的），我查到了 OpenSSL 中的 MD5 实现支持使用<code>MD5_Update</code> 来增量计算，所以这个问题就迎刃而解了，具体看我前面的笔记<a href="https://imzlp.com/notes/ue/#MD5%E7%9A%84%E5%88%86%E7%89%87%E6%A0%A1%E9%AA%8C">MD5 的分片校验</a>。</p>
<p>基于上面这些内容，可以实现一个简陋的下载器功能了，可作为游戏中的下载组件，虽然看似简单，但是设计一个合理的结构和没有 bug 的版本还是要花点功夫的。<br>我把上面介绍的内容写成了一个插件：<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-download-proxy-plugin-ui.webp"></p>
<p>HTTP 的分片请求在服务端的 Log:<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/use-http-request-download-file-server-info.webp"></p>
<p>资料文档：</p>
<ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Range_requests">从服务器端请求特定的范围</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Network</category>
      </categories>
      <tags>
        <tag>Network</tag>
      </tags>
  </entry>
  <entry>
    <title>Texture 的压缩和 Profiling</title>
    <url>/wiki/16943/</url>
    <content><![CDATA[<h3 id="ASTC-Compression-Quality-By-Size"><a href="#ASTC-Compression-Quality-By-Size" class="headerlink" title="ASTC Compression Quality By Size"></a>ASTC Compression Quality By Size</h3><p>在项目的 DefaultEngine.ini 中的 <code>[/Script/UnrealEd.CookerSettings]</code> 中通过 <code>DefaultASTCQualityBySize</code> 设置（0-4）： </p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[/Script/UnrealEd.CookerSettings]</span> </span><br><span class="line"><span class="attr">DefaultASTCQualityBySize</span>=<span class="number">2</span>  </span><br><span class="line"><span class="attr">DefaultASTCQualityBySpeed</span>=<span class="number">3</span> </span><br></pre></td></tr></table></figure>
<p>0-4 分别对应以下压缩级别：  </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0=12x12 </span><br><span class="line">1=10x10 </span><br><span class="line">2=8x8 </span><br><span class="line">3=6x6 </span><br><span class="line">4=4x4 </span><br></pre></td></tr></table></figure>

<ul>
<li><a href="https://forums.unrealengine.com/development-discussion/vr-ar-development/91476-custom-astc-compression-format">Custom ASTC compression format</a> </li>
<li><a href="https://developer.nvidia.com/astc-texture-compression-for-game-assets">Using ASTC Texture Compression for Game Assets</a> </li>
</ul>
<h3 id="Texture 的压缩"><a href="#Texture 的压缩" class="headerlink" title="Texture 的压缩"></a>Texture 的压缩 </h3><p> 之前的笔记中，提到过可以在 <code>Project Settings</code>-<code>Cooker</code>-<code>Texture</code>-<code>ASTC Compression vs Size</code> 可以设置默认的资源质量和大小的级别： </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0=12x12 </span><br><span class="line">1=10x10 </span><br><span class="line">2=8x8 </span><br><span class="line">3=6x6 </span><br><span class="line">4=4x4 </span><br></pre></td></tr></table></figure>
<p>在 Texture 的资源编辑中也可以针对某个 Texture 单独设置： </p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210112154624.webp">  </p>
<p>Lowest-&gt;Hightest 对应着 <code>0-4</code> 的值，使用 Default 则使用项目设置中的配置。  </p>
<p>并且，设置 <code>Compression Settings</code> 的类型也会对资源压缩的类型有差别，Default 则是项目设置中的参数，如果设置成 NormalMap 的类型会是 <code>ASTC_4x4</code> 的。 </p>
<ul>
<li><a href="https://developer.nvidia.com/astc-texture-compression-for-game-assets#_Toc398571904">Using ASTC Texture Compression for Game Assets</a> </li>
<li><a href="https://docs.unrealengine.com/en-US/RenderingAndGraphics/Textures/TextureCompressionSettings/index.html">Texture Compression Settings</a> </li>
</ul>
<h3 id="listtextures"><a href="#listtextures" class="headerlink" title="listtextures"></a>listtextures</h3><p>控制台命令 <code>listtextures</code> 可以列出已被加载过的 Texture 的信息。  </p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Optimization</category>
      </categories>
      <tags>
        <tag>Optimization</tag>
        <tag>Texture</tag>
        <tag>Profiling</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 项目优化：PSO Caching</title>
    <url>/wiki/24336/</url>
    <content><![CDATA[<p>UE 中具有 PSO Caching 机制，全称 Pipeline State Object Caching，用于预先记录和构建出运行时所使用的材质依赖的 Shader 信息，当项目首次使用这些 Shader 时，该列表可以加速 Shader 的加载 / 编译过程。PSO Caching 会把渲染状态、顶点声明、Primitive 类型、RenderTarget 像素格式等数据保存到文件中，提升 Shader 的加载效率。<br>本篇文章主要介绍 PSO Caching 的启用及构建流程，并会分析 PSO Cache 在引擎中的加载流程以及实现热更 PSO 方式、错误处理等，PSO Caching 的原理有时间再进行详细分析。</p>
<span id="more"></span>

<p>PSO Caching 的官方文档：<a href="https://docs.unrealengine.com/en-US/SharingAndReleasing/PSOCaching/index.html">PSO Caching</a>。</p>
<p>PSO Cache 构建流程概览：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/24336/PSO_Caching_Digramh.webp"></p>
<p>PSO Caching 的部署和使用大致分为以下几个步骤：</p>
<ol>
<li>为项目开启 PSO Cahche 和 ShaderStableKeys，打包后可以从 <code>Metadata/PipelineCaches</code> 目录下获得<code>ShaderStableInfo*.scl.csv</code></li>
<li>添加 <code>logPSO</code> 参数启动游戏，用于在运行时记录 PSO 数据（<code>*.scl.upipelinecache</code>）</li>
<li>通过 <code>ShaderStableInfo*.scl.csv</code> 和<code>*.scl.upipelinecache</code>生成<code>*.stablepc.csv</code></li>
<li>再次执行 Cook，通过 <code>*.stablepc.csv</code> 生成 <code>upipelinecache</code> 文件，打至包内；</li>
<li>启动游戏，引擎自动加载<code>*.stable.upipelinecache</code>，编译 Shader 时使用 PSO Caching</li>
</ol>
<p>本篇文章的内容顺序也遵循着几个步骤。</p>
<h3 id="启用 ShaderStableKeys"><a href="# 启用 ShaderStableKeys" class="headerlink" title="启用 ShaderStableKeys"></a>启用 ShaderStableKeys</h3><p>首先需要为项目开启<code>ShaderStableKeys</code>，在执行 Cook 时生成稳定的 ShaderKey，作为记录 Shader 的凭据。</p>
<p>在<code>DefaultEngine.ini</code>（或平台相关如 AndroidEngine.ini）中添加以下值：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[DevOptions.Shaders]</span></span><br><span class="line"><span class="attr">NeedsShaderStableKeys</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>添加之后再执行打包（Cook），会创建以下目录：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Saved/Cooked/PLATFORM_NAME/PROJECT_NAME/Metadata/PipelineCaches</span><br></pre></td></tr></table></figure>
<p>并且会在该目录下生成两个文件（分别对应项目、引擎）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ShaderStableInfo-PROJECT_NAME-GLSL_ES3_1_ANDROID.scl.csv</span><br><span class="line">ShaderStableInfo-Global-GLSL_ES3_1_ANDROID.scl.csv</span><br></pre></td></tr></table></figure>
<p>Cook 过程中会有以下 log，表明生成了这两个文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">LogCook: Display: Saved scl.csv D:/PSOExample/Saved/Cooked/Android_ASTC/PSOExample/Metadata/PipelineCaches/ShaderStableInfo-Global-GLSL_ES3_1_ANDROID.scl.csv for platform Android_ASTC</span><br><span class="line">LogCook: Display: Saved scl.csv D:/PSOExample/Saved/Cooked/Android_ASTC/PSOExample/Metadata/PipelineCaches/ShaderStableInfo-PSOExample-GLSL_ES3_1_ANDROID.scl.csv for platform Android_ASTC</span><br></pre></td></tr></table></figure>

<p>可以使用它们通过 <code>-run=ShaderPipelineCacheTools</code> 这个 Commandlet 来生成<code>*.stablepc.csv</code>。</p>
<p><code>*.scl.csv</code>文件的内容：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/24336/20210422200532.webp"></p>
<h3 id="运行时捕获 PSO 数据"><a href="# 运行时捕获 PSO 数据" class="headerlink" title="运行时捕获 PSO 数据"></a>运行时捕获 PSO 数据 </h3><p> 启动游戏时加入 <code>-logPSO</code> 参数或者在 <code>DefaultEngine.ini</code> 中加入以下配置：</p>
<figure class="highlight ini"><figcaption><span>Config/DefaultEngine.ini</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="section">[ConsoleVariables]</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.Enabled</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.LogPSO</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.SaveBoundPSOLog</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>也可以在 <code>Devices Profile</code> 中设置：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/24336/20210420172045.webp"></p>
<p>这两个参数在以下代码中使用：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/RHI/Private/PipelineFileCache.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FPipelineFileCache::IsPipelineFileCacheEnabled</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">bool</span> bOnce = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">bool</span> bCmdLineForce = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (!bOnce)</span><br><span class="line">  &#123;</span><br><span class="line">    bOnce = <span class="literal">true</span>;</span><br><span class="line">    bCmdLineForce = FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;psocache&quot;</span>));</span><br><span class="line">    <span class="built_in">UE_CLOG</span>(bCmdLineForce, LogRHI, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;****************************** Forcing PSO cache from command line&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> FileCacheEnabled &amp;&amp; (bCmdLineForce || CVarPSOFileCacheEnabled.<span class="built_in">GetValueOnAnyThread</span>() == <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FPipelineFileCache::LogPSOtoFileCache</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">bool</span> bOnce = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">bool</span> bCmdLineForce = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (!bOnce)</span><br><span class="line">  &#123;</span><br><span class="line">    bOnce = <span class="literal">true</span>;</span><br><span class="line">    bCmdLineForce = FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;logpso&quot;</span>));</span><br><span class="line">    <span class="built_in">UE_CLOG</span>(bCmdLineForce, LogRHI, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;****************************** Forcing logging of PSOs from command line&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (bCmdLineForce || CVarPSOFileCacheLogPSO.<span class="built_in">GetValueOnAnyThread</span>() == <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行游戏时会有 log:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">LogConfig: Applying CVar settings from Section [ConsoleVariables] File [../../../FGame/Saved/Config/Android/Engine.ini]</span><br><span class="line">LogConfig: Setting CVar [[r.ShaderPipelineCache.Enabled:1]]</span><br><span class="line">LogConfig: Setting CVar [[r.ShaderPipelineCache.LogPSO:1]]</span><br><span class="line">LogConfig: Setting CVar [[r.ShaderPipelineCache.SaveBoundPSOLog:1]]</span><br><span class="line">...</span><br><span class="line">LogRHI: Base name for record PSOs is ../../../FGame/Saved/CollectedPSOs/++UE4+Release-4.25-CL-0-FGame_GLSL_ES3_1_ANDROID_00084A4308D90436AC0F652223AA8D4F.rec.upipelinecache</span><br><span class="line">LogRHI: Could not open FPipelineCacheFile: ../../../FGame/Content/PipelineCaches/Android/FGame_GLSL_ES3_1_ANDROID.upipelinecache</span><br><span class="line">...</span><br><span class="line">LogRHI: Display: Encountered a new graphics PSO: 3478445130</span><br><span class="line">LogRHI: Display: New Graphics PSO (3478445130) Description: 416F798F22743F626513A16205A15ECB135C3791,0000000000000000000000000000000000000000,0000000000000000000000000000000000000000,0000000000000000000000000000000000000000,0000000000000000000000000000000000000000,&lt;0 1 0 0 1 0 0 0 1 0 0 1 0 15 0 1 0 0 1 0 15 0 1 0 0 1 0 15 0 1 0 0 1 0 15 0 1 0 0 1 0 15 0 1 0 0 1 0 15 0 1 0 0 1 0 15 0&gt;,&lt;0.000000 0.000000 2 1 0 0&gt;,&lt;0 3 0 7 0 0 0 0 7 0 0 0 255 255&gt;,1,11,1051148,2,2,0,0,0,4,10,1114633,0,0,18,2569,0,0,37,1051145,0,0,37,2585,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,15360,15391,1055,1027,1025,0,0,0,0,1,&lt;0 0 3 0 12 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;</span><br><span class="line">LogRHI: Display: Encountered a new graphics PSO: 898510125</span><br><span class="line">LogRHI: Display: New Graphics PSO (898510125) Description: 432A3E5557E9ED8328AC7E6CDA5AA6FC2F0B2439,0FED48EC019CFDD251488DE33D563DCFFD7E69DA,0000000000000000000000000000000000000000,0000000000000000000000000000000000000000,0000000000000000000000000000000000000000,&lt;0 1 0 0 1 0 7 0 1 0 0 1 0 0 0 1 0 0 1 0 0 0 1 0 0 1 0 0 0 1 0 0 1 0 15 0 1 0 0 1 0 15 0 1 0 0 1 0 15 0 1 0 0 1 0 15 0&gt;,&lt;0.000000 0.000000 2 0 0 0&gt;,&lt;0 7 0 7 0 0 0 0 7 0 0 0 255 255&gt;,1,11,1051148,2,2,0,0,0,4,10,1114633,0,0,18,2569,0,0,37,1051145,0,0,37,2585,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,15360,15391,1055,1027,1025,0,0,0,2,2,&lt;0 0 4 0 32 0&gt;,&lt;0 16 2 1 32 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;</span><br></pre></td></tr></table></figure>
<p>并会在 <code>Saved/CoolectedPSOs</code> 中创建以下文件：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/24336/20210420185534.webp"></p>
<h3 id="生成 -stablepc-csv"><a href="# 生成 -stablepc-csv" class="headerlink" title="生成 *.stablepc.csv"></a>生成 *.stablepc.csv</h3><p>使用以下 commandlet：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Engine/Binaries/Win64/UE4Editor-Cmd.exe</span><br><span class="line">D:/Client/Client.uproject</span><br><span class="line">-run=ShaderPipelineCacheTools expand</span><br><span class="line">D:/PSOCache/*.rec.upipelinecache</span><br><span class="line">D:/PSOCache/*.scl.csv</span><br><span class="line">D:/PSOCache/Client_GLSL_ES3_1_ANDROID.stablepc.csv</span><br></pre></td></tr></table></figure>
<p>以上命令会在引擎的 Binaries/Win64 下生成 <code>Client_GLSL_ES3_1_ANDROID.stablepc.csv</code> 文件，注意一定要匹配 <code>&#123;PROJECTNAME&#125;_&#123;SHADER_FORMART_NAME&#125;.stablepc.csv</code> 这个命名规则。</p>
<p>Android 的命名为：Client_GLSL_ES3_1_ANDROID.stablepc.csv<br>IOS 的命名为：Client_SF_METAL.stablepc.csv</p>
<p>生成时具有以下 Log：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\PSOCache&gt;&quot;C:\Program Files\Epic Games\UE_4.25\Engine\Binaries\Win64\UE4Editor-Cmd.exe&quot; &quot;D:\PSOExample\PSOExample.uproject&quot; -run=ShaderPipelineCacheTools expand D:/PSOCache/*.rec.upipelinecache D:/PSOCache/*.scl.csv D:/PSOCache/PSOExample_GLSL_ES3_1_ANDROID.stablepc.csv</span><br><span class="line">[2021.04.22-08.57.39:623][0]LogTargetPlatformManager: Display: Building Assets For Windows</span><br><span class="line">[2021.04.22-08.57.39:648][0]LogAudioDebug: Display: Lib vorbis DLL was dynamically loaded.</span><br><span class="line">[2021.04.22-08.57.39:841][0]LogShaderCompilers: Display: Using Local Shader Compiler.</span><br><span class="line">[2021.04.22-08.57.40:492][0]LogDerivedDataCache: Display: Max Cache Size: 512 MB</span><br><span class="line">[2021.04.22-08.57.40:523][0]LogDerivedDataCache: Display: Loaded Boot cache: C:/Users/lipengzha/AppData/Local/UnrealEngine/4.25/DerivedDataCache/Boot.ddc</span><br><span class="line">[2021.04.22-08.57.40:533][0]LogDerivedDataCache: Display: Pak cache opened for reading ../../../Engine/DerivedDataCache/Compressed.ddp.</span><br><span class="line">[2021.04.22-08.57.44:616][0]LogAudioCaptureCore: Display: No Audio Capture implementations found. Audio input will be silent.</span><br><span class="line">[2021.04.22-08.57.44:616][0]LogAudioCaptureCore: Display: No Audio Capture implementations found. Audio input will be silent.</span><br><span class="line">[2021.04.22-08.57.45:274][0]LogShaderPipelineCacheTools: Display: Loading D:/PSOCache/ShaderStableInfo-Global-GLSL_ES3_1_ANDROID.scl.csv...</span><br><span class="line">[2021.04.22-08.57.45:275][0]LogShaderPipelineCacheTools: Display: Loading D:/PSOCache/ShaderStableInfo-PSOExample-GLSL_ES3_1_ANDROID.scl.csv...</span><br><span class="line">[2021.04.22-08.57.45:280][0]LogShaderPipelineCacheTools: Display: Loaded 548 shader info lines from D:/PSOCache/ShaderStableInfo-Global-GLSL_ES3_1_ANDROID.scl.csv.</span><br><span class="line">[2021.04.22-08.57.45:287][0]LogShaderPipelineCacheTools: Display: Loaded 5707 shader info lines from D:/PSOCache/ShaderStableInfo-PSOExample-GLSL_ES3_1_ANDROID.scl.csv.</span><br><span class="line">[2021.04.22-08.57.45:287][0]LogShaderPipelineCacheTools: Display: Loaded 6255 unique shader info lines total.</span><br><span class="line">[2021.04.22-08.57.45:289][0]LogShaderPipelineCacheTools: Display: Loading D:/PSOCache/++UE4+Release-4.25-CL-13942748-PSOExample_GLSL_ES3_1_ANDROID_000843BC08D905AF09E24614C6A6086F.rec.upipelinecache....</span><br><span class="line">[2021.04.22-08.57.45:293][0]LogShaderPipelineCacheTools: Display: Loaded 105 PSOs</span><br><span class="line">[2021.04.22-08.57.45:297][0]LogShaderPipelineCacheTools: Display: Loaded 105 PSOs total [Usage Mask Merged = 0].</span><br><span class="line">[2021.04.22-08.57.45:325][0]LogShaderPipelineCacheTools: Display: Generated 478 stable PSOs total</span><br><span class="line">[2021.04.22-08.57.45:344][0]LogShaderPipelineCacheTools: Display: Wrote stable PSOs, 479 lines (541.8 KB) to D:/PSOCache/PSOExample_GLSL_ES3_1_ANDROID.stablepc.csv</span><br><span class="line">[2021.04.22-08.57.45:346][0]LogInit: Display:</span><br><span class="line">[2021.04.22-08.57.45:349][0]LogInit: Display: Success - 0 error(s), 0 warning(s)</span><br><span class="line">[2021.04.22-08.57.45:353][0]LogInit: Display:</span><br><span class="line">Execution of commandlet took:  0.08 seconds</span><br><span class="line">[2021.04.22-08.57.45:408][0]LogShaderCompilers: Display: Shaders left to compile 0</span><br><span class="line">[2021.04.22-08.57.45:621][0]LogContentStreaming: Display: There are 1 unreleased StreamingManagers</span><br></pre></td></tr></table></figure>

<p>最终 PSO 所需要的所有文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\PSOCache&gt;tree /a /f</span><br><span class="line">卷 Data 的文件夹 PATH 列表 </span><br><span class="line"> 卷序列号为 004B-E876</span><br><span class="line">D:.</span><br><span class="line">    ++UE4+Release-4.25-CL-13942748-PSOExample_GLSL_ES3_1_ANDROID_000843BC08D905AF09E24614C6A6086F.rec.upipelinecache</span><br><span class="line">    PSOExample_GLSL_ES3_1_ANDROID.stablepc.csv</span><br><span class="line">    ShaderStableInfo-Global-GLSL_ES3_1_ANDROID.scl.csv</span><br><span class="line">    ShaderStableInfo-PSOExample-GLSL_ES3_1_ANDROID.scl.csv</span><br></pre></td></tr></table></figure>
<p>我把测试工程生成的文件备份了一份：<a href="PSOCache.7z">PSOCache.7z</a>，可以查看每个文件中的内容。</p>
<h3 id="生成 -stable-upipelinecache"><a href="# 生成 -stable-upipelinecache" class="headerlink" title="生成 *.stable.upipelinecache"></a>生成 *.stable.upipelinecache</h3><p>把生成的 <code>*stablepc.csv</code> 放到 <code>Build/Android/PipelineCaches</code> 目录下，注意 <code>Build/PLATFORM</code> 这个 Platform 是编译平台，不是 Cook 的资源平台，Android 的包就是 <code>Android</code> 而不是 <code>Android_ASTC</code> 等。<br>之后重新打包即可。</p>
<p>引擎在 Cook 时通过 <code>stavlepc.csv</code> 创建 PipelineCache 的代码：</p>
<figure class="highlight cpp"><figcaption><span>Editor\UnrealEd\Private\CookOnTheFlyServer.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UCookOnTheFlyServer::CreatePipelineCache</span><span class="params">(<span class="keyword">const</span> ITargetPlatform* TargetPlatform, <span class="keyword">const</span> FString&amp; LibraryName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// make sure we have a registry generated for all the platforms </span></span><br><span class="line">  <span class="keyword">const</span> FString TargetPlatformName = TargetPlatform-&gt;<span class="built_in">PlatformName</span>();</span><br><span class="line">  TArray&lt;FString&gt;* SCLCSVPaths = OutSCLCSVPaths.<span class="built_in">Find</span>(<span class="built_in">FName</span>(TargetPlatformName));</span><br><span class="line">  <span class="keyword">if</span> (SCLCSVPaths &amp;&amp; SCLCSVPaths-&gt;<span class="built_in">Num</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    TArray&lt;FName&gt; ShaderFormats;</span><br><span class="line">    TargetPlatform-&gt;<span class="built_in">GetAllTargetedShaderFormats</span>(ShaderFormats);</span><br><span class="line">    <span class="keyword">for</span> (FName ShaderFormat : ShaderFormats)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// *stablepc.csv or *stablepc.csv.compressed</span></span><br><span class="line">      <span class="keyword">const</span> FString Filename = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;*%s_%s.stablepc.csv&quot;</span>), *LibraryName, *ShaderFormat.<span class="built_in">ToString</span>());</span><br><span class="line">      <span class="keyword">const</span> FString StablePCPath = FPaths::<span class="built_in">ProjectDir</span>() / <span class="built_in">TEXT</span>(<span class="string">&quot;Build&quot;</span>) / TargetPlatform-&gt;<span class="built_in">IniPlatformName</span>() / <span class="built_in">TEXT</span>(<span class="string">&quot;PipelineCaches&quot;</span>) / Filename;</span><br><span class="line">      <span class="keyword">const</span> FString StablePCPathCompressed = StablePCPath + <span class="built_in">TEXT</span>(<span class="string">&quot;.compressed&quot;</span>);</span><br><span class="line"></span><br><span class="line">      TArray&lt;FString&gt; ExpandedFiles;</span><br><span class="line">      IFileManager::<span class="built_in">Get</span>().<span class="built_in">FindFilesRecursive</span>(ExpandedFiles, *FPaths::<span class="built_in">GetPath</span>(StablePCPath), *FPaths::<span class="built_in">GetCleanFilename</span>(StablePCPath), <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">      IFileManager::<span class="built_in">Get</span>().<span class="built_in">FindFilesRecursive</span>(ExpandedFiles, *FPaths::<span class="built_in">GetPath</span>(StablePCPathCompressed), *FPaths::<span class="built_in">GetCleanFilename</span>(StablePCPathCompressed), <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">if</span> (!ExpandedFiles.<span class="built_in">Num</span>())</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogCook, Display, <span class="built_in">TEXT</span>(<span class="string">&quot;---- NOT Running UShaderPipelineCacheToolsCommandlet for platform %s  shader format %s, no files found at %s&quot;</span>), *TargetPlatformName, *ShaderFormat.<span class="built_in">ToString</span>(), *StablePCPath);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogCook, Display, <span class="built_in">TEXT</span>(<span class="string">&quot;---- Running UShaderPipelineCacheToolsCommandlet for platform %s  shader format %s&quot;</span>), *TargetPlatformName, *ShaderFormat.<span class="built_in">ToString</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> FString OutFilename = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%s_%s.stable.upipelinecache&quot;</span>), *LibraryName, *ShaderFormat.<span class="built_in">ToString</span>());</span><br><span class="line">        <span class="keyword">const</span> FString PCUncookedPath = FPaths::<span class="built_in">ProjectDir</span>() / <span class="built_in">TEXT</span>(<span class="string">&quot;Content&quot;</span>) / <span class="built_in">TEXT</span>(<span class="string">&quot;PipelineCaches&quot;</span>) / TargetPlatform-&gt;<span class="built_in">IniPlatformName</span>() / OutFilename;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (IFileManager::<span class="built_in">Get</span>().<span class="built_in">FileExists</span>(*PCUncookedPath))</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">UE_LOG</span>(LogCook, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Deleting %s, cooked data doesn&#x27;t belong here.&quot;</span>), *PCUncookedPath);</span><br><span class="line">          IFileManager::<span class="built_in">Get</span>().<span class="built_in">Delete</span>(*PCUncookedPath, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> FString PCCookedPath = <span class="built_in">ConvertToFullSandboxPath</span>(*PCUncookedPath, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">const</span> FString PCPath = PCCookedPath.<span class="built_in">Replace</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;[Platform]&quot;</span>), *TargetPlatformName);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function">FString <span class="title">Args</span><span class="params">(TEXT(<span class="string">&quot;build &quot;</span>))</span></span>;</span><br><span class="line">        Args += <span class="built_in">TEXT</span>(<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">        Args += StablePCPath;</span><br><span class="line">        Args += <span class="built_in">TEXT</span>(<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        int32 NumMatched = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (int32 Index = <span class="number">0</span>; Index &lt; SCLCSVPaths-&gt;<span class="built_in">Num</span>(); Index++)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (!(*SCLCSVPaths)[Index].<span class="built_in">Contains</span>(ShaderFormat.<span class="built_in">ToString</span>()))</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          NumMatched++;</span><br><span class="line">          Args += <span class="built_in">TEXT</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">          Args += <span class="built_in">TEXT</span>(<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">          Args += (*SCLCSVPaths)[Index];</span><br><span class="line">          Args += <span class="built_in">TEXT</span>(<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!NumMatched)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">UE_LOG</span>(LogCook, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Shader format %s for platform %s had this file %s, but no .scl.csv files.&quot;</span>), *ShaderFormat.<span class="built_in">ToString</span>(), *TargetPlatformName, *StablePCPath);</span><br><span class="line">          <span class="keyword">for</span> (int32 Index = <span class="number">0</span>; Index &lt; SCLCSVPaths-&gt;<span class="built_in">Num</span>(); Index++)</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">UE_LOG</span>(LogCook, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;    .scl.csv file: %s&quot;</span>), *((*SCLCSVPaths)[Index]));</span><br><span class="line">          &#125;              </span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Args += <span class="built_in">TEXT</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">        Args += <span class="built_in">TEXT</span>(<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">        Args += PCPath;</span><br><span class="line">        Args += <span class="built_in">TEXT</span>(<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogCook, Display, <span class="built_in">TEXT</span>(<span class="string">&quot;  With Args: %s&quot;</span>), *Args);</span><br><span class="line"></span><br><span class="line">        int32 Result = UShaderPipelineCacheToolsCommandlet::<span class="built_in">StaticMain</span>(Args);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Result)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">LogCookerMessage</span>(FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UShaderPipelineCacheToolsCommandlet failed %d&quot;</span>), Result), EMessageSeverity::Error);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">UE_LOG</span>(LogCook, Display, <span class="built_in">TEXT</span>(<span class="string">&quot;---- Done running UShaderPipelineCacheToolsCommandlet for platform %s&quot;</span>), *TargetPlatformName);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>实际使用 <code>stablepc.csv</code> 的地方就是用它来执行 <code>ShaderPipelineCacheTools</code> 这个 commandlet 生成 upipelinecache 文件并打至包内。</p>
<p>ShaderPipelineCacheToolsCommandlet 的执行命令为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Engine\Binaries\Win64\UE4Editor-Cmd.exe</span><br><span class="line">D:\PSOExample\PSOExample.uproject</span><br><span class="line">-run=ShaderPipelineCacheTools build</span><br><span class="line">&quot;D:\PSOExample/Build/Android/PipelineCaches/*PSOExample_GLSL_ES3_1_ANDROID.stablepc.csv&quot;</span><br><span class="line">&quot;D:\PSOExample/Saved/Cooked/Android_ASTC/PSOExample/Metadata/PipelineCaches/ShaderStableInfo-Global-GLSL_ES3_1_ANDROID.scl.csv&quot;</span><br><span class="line">&quot;D:\PSOExample/Saved/Cooked/Android_ASTC/PSOExample/Metadata/PipelineCaches/ShaderStableInfo-PSOExample-GLSL_ES3_1_ANDROID.scl.csv&quot;</span><br><span class="line">&quot;D:\PSOExample/Saved/Cooked/Android_ASTC/PSOExample/Content/PipelineCaches/Android/PSOExample_GLSL_ES3_1_ANDROID.stable.upipelinecache&quot;</span><br></pre></td></tr></table></figure>

<p>生成 <code>*.stable.upipelinecache</code> 文件的包内路径为<code>Content\PipelineCaches\Android</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\PSOExample\Saved\Cooked\Android_ASTC\PSOExample\Content\PipelineCaches&gt;tree /a /f</span><br><span class="line">卷 Windows 的文件夹 PATH 列表 </span><br><span class="line"> 卷序列号为 0C49-9EA3</span><br><span class="line">C:.</span><br><span class="line">\---Android</span><br><span class="line">        PSOExample_GLSL_ES3_1_ANDROID.stable.upipelinecache</span><br></pre></td></tr></table></figure>
<p>因为它是位于 Content 下并会打包进 pak 的文件，我们也可以对其进行热更。</p>
<p>当安装了包含 <code>upipelinecache</code> 的包，在运行时就会有以下 log：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">LogShaderLibrary: Display: Using ../../../PSOExample/Content/ShaderArchive-PSOExample-GLSL_ES3_1_ANDROID.ushaderbytecode for material shader code. Total 3053 unique shaders.</span><br><span class="line">LogShaderLibrary: Display: Cooked Context: Using Shared Shader Library PSOExample</span><br><span class="line">LogRHI: Display: Opened pipeline cache after state change and enqueued 0 of 0 tasks for precompile.</span><br><span class="line">LogRHI: Base name for record PSOs is ../../../PSOExample/Saved/CollectedPSOs/++UE4+Release-4.25-CL-13942748-PSOExample_GLSL_ES3_1_ANDROID_00087B4B08D905BBC5A827F40CA03A0C.rec.upipelinecache</span><br><span class="line">LogRHI: FPipelineCacheFile Header Game ue_version: 13942748</span><br><span class="line">LogRHI: FPipelineCacheFile Header Engine Data ue_version: 17</span><br><span class="line">LogRHI: FPipelineCacheFile Header TOC Offset: 38155</span><br><span class="line">LogRHI: FPipelineCacheFile File Size: 51011 Bytes</span><br><span class="line">LogRHI: Opened FPipelineCacheFile: ../../../PSOExample/Content/PipelineCaches/Android/PSOExample_GLSL_ES3_1_ANDROID.stable.upipelinecache (GUID: 00000000000000000000000000000000) with 102 entries.</span><br><span class="line">LogRHI: Scanning Binary program cache, using Shader Pipeline Cache version 6988202F47BA858F3F0DE483D7DB0606</span><br><span class="line">LogRHI: AndroidEGL:SwapBuffers eglGetCompositorTimingANDROID EGL_COMPOSITE_DEADLINE_ANDROID=2718926192606265, EGL_COMPOSITE_INTERVAL_ANDROID=16559027, EGL_COMPOSITE_TO_PRESENT_LATENCY_ANDROID=14559027</span><br></pre></td></tr></table></figure>
<h3 id="PSO-Cache 的加载与热更"><a href="#PSO-Cache 的加载与热更" class="headerlink" title="PSO Cache 的加载与热更"></a>PSO Cache 的加载与热更 </h3><p> 与<code>ShaderCode</code>类似，引擎在启动时也是会自动加载 PSO Cache 的，在 <code>FEngineLoop</code> 中通过调用 <code>FPipelineCacheFile::OpenPipelineFileCache</code> 读取 <code>*.stable.upipelinecache</code> 的。</p>
<p>在 <code>PreInitPreStartupScreen</code> 中加载 PSO 的代码：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/Launch/Private/LaunchEngineLoop.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function">int32 <span class="title">FEngineLoop::PreInitPreStartupScreen</span><span class="params">(<span class="keyword">const</span> TCHAR* CmdLine)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">bool</span> bUseCodeLibrary = FPlatformProperties::<span class="built_in">RequiresCookedData</span>() || GAllowCookedDataInEditorBuilds;</span><br><span class="line">    <span class="keyword">if</span> (bUseCodeLibrary)</span><br><span class="line">    &#123;</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;FShaderCodeLibrary::InitForRuntime&quot;</span>);</span><br><span class="line">        <span class="comment">// Will open material shader code storage if project was packaged with it</span></span><br><span class="line">        <span class="comment">// This only opens the Global shader library, which is always in the content dir.</span></span><br><span class="line">        FShaderCodeLibrary::<span class="built_in">InitForRuntime</span>(GMaxRHIShaderPlatform);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">if</span> !UE_EDITOR</span></span><br><span class="line">      <span class="comment">// Cooked data only - but also requires the code library - game only</span></span><br><span class="line">      <span class="keyword">if</span> (FPlatformProperties::<span class="built_in">RequiresCookedData</span>())</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;FShaderPipelineCache::Initialize&quot;</span>);</span><br><span class="line">        <span class="comment">// Initialize the pipeline cache system. Opening is deferred until the manual call to</span></span><br><span class="line">        <span class="comment">// OpenPipelineFileCache below, after content pak&#x27;s ShaderCodeLibraries are loaded.</span></span><br><span class="line">        FShaderPipelineCache::<span class="built_in">Initialize</span>(GMaxRHIShaderPlatform);</span><br><span class="line">      &#125;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">//!UE_EDITOR</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">//Handle opening shader library after our EarlyLoadScreen</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">LLM_SCOPE</span>(ELLMTag::Shaders);</span><br><span class="line">    <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;FShaderCodeLibrary::OpenLibrary&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Open the game library which contains the material shaders.</span></span><br><span class="line">    FShaderCodeLibrary::<span class="built_in">OpenLibrary</span>(FApp::<span class="built_in">GetProjectName</span>(), FPaths::<span class="built_in">ProjectContentDir</span>());</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> FString&amp; RootDir : FPlatformMisc::<span class="built_in">GetAdditionalRootDirectories</span>())</span><br><span class="line">    &#123;</span><br><span class="line">      FShaderCodeLibrary::<span class="built_in">OpenLibrary</span>(FApp::<span class="built_in">GetProjectName</span>(), FPaths::<span class="built_in">Combine</span>(RootDir, FApp::<span class="built_in">GetProjectName</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;Content&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now our shader code main library is opened, kick off the precompile, if already initialized</span></span><br><span class="line">    FShaderPipelineCache::<span class="built_in">OpenPipelineFileCache</span>(GMaxRHIShaderPlatform);</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>FShaderPipelineCache::OpenPipelineFileCache</code>有两个重载版本：</p>
<figure class="highlight cpp"><figcaption><span>Runtime\RenderCore\Private\ShaderPipelineCache.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FShaderPipelineCache::OpenPipelineFileCache</span><span class="params">(EShaderPlatform Platform)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">bool</span> bFileOpen = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (GConfig)</span><br><span class="line">  &#123;</span><br><span class="line">    FString LastOpenedName;</span><br><span class="line">    <span class="keyword">if</span> ((GConfig-&gt;<span class="built_in">GetString</span>(FShaderPipelineCacheConstants::SectionHeading, FShaderPipelineCacheConstants::LastOpenedKey, LastOpenedName, *GGameUserSettingsIni) || GConfig-&gt;<span class="built_in">GetString</span>(FShaderPipelineCacheConstants::SectionHeading, FShaderPipelineCacheConstants::LastOpenedKey, LastOpenedName, *GGameIni)) &amp;&amp; LastOpenedName.<span class="built_in">Len</span>())</span><br><span class="line">    &#123;</span><br><span class="line">      bFileOpen = <span class="built_in">OpenPipelineFileCache</span>(LastOpenedName, Platform);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!bFileOpen)</span><br><span class="line">  &#123;</span><br><span class="line">    bFileOpen = <span class="built_in">OpenPipelineFileCache</span>(FApp::<span class="built_in">GetProjectName</span>(), Platform);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> bFileOpen;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FShaderPipelineCache::OpenPipelineFileCache</span><span class="params">(FString <span class="keyword">const</span>&amp; Name, EShaderPlatform Platform)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (ShaderPipelineCache)</span><br><span class="line">    <span class="keyword">return</span> ShaderPipelineCache-&gt;<span class="built_in">Open</span>(Name, Platform);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>引擎启动的时候默认读取的就是 <code>OpenPipelineFileCache(FApp::GetProjectName(), Platform)</code>，也就是<code>PSOExample_GLSL_ES3_1_ANDROID.stable.upipelinecache</code>，Platform 参数可以通过传递全局对象<code>GMaxRHIShaderPlatform</code> 来获取当前运行的平台。</p>
<p>UE 也提供了一个 <code>console</code> 命令可以指定加载<code>stable.upipelinecache</code>：<code>r.ShaderPipelineCache.Open</code>，还有几个其他控制 PSO 的 console 命令：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/RenderCore/Private/ShaderPipelineCache.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> FAutoConsoleCommand <span class="title">LoadPipelineCacheCmd</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  TEXT(<span class="string">&quot;r.ShaderPipelineCache.Open&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">  TEXT(<span class="string">&quot;Takes the desired filename to open and then loads the pipeline file cache.&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">  FConsoleCommandWithArgsDelegate::CreateStatic(ConsoleCommandLoadPipelineFileCache)</span></span></span><br><span class="line"><span class="params"><span class="function">  )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> FAutoConsoleCommand <span class="title">SavePipelineCacheCmd</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  TEXT(<span class="string">&quot;r.ShaderPipelineCache.Save&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">  TEXT(<span class="string">&quot;Save the current pipeline file cache.&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">  FConsoleCommandDelegate::CreateStatic(ConsoleCommandSavePipelineFileCache)</span></span></span><br><span class="line"><span class="params"><span class="function">  )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> FAutoConsoleCommand <span class="title">ClosePipelineCacheCmd</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  TEXT(<span class="string">&quot;r.ShaderPipelineCache.Close&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">  TEXT(<span class="string">&quot;Close the current pipeline file cache.&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">  FConsoleCommandDelegate::CreateStatic(ConsoleCommandClosePipelineFileCache)</span></span></span><br><span class="line"><span class="params"><span class="function">  )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> FAutoConsoleCommand <span class="title">SwitchModePipelineCacheCmd</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  TEXT(<span class="string">&quot;r.ShaderPipelineCache.SetBatchMode&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">  TEXT(<span class="string">&quot;Sets the compilation batch mode, which should be one of:\n\tPause: Suspend precompilation.\n\tBackground: Low priority precompilation.\n\tFast: High priority precompilation.&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">  FConsoleCommandWithArgsDelegate::CreateStatic(ConsoleCommandSwitchModePipelineCacheCmd)</span></span></span><br><span class="line"><span class="params"><span class="function">  )</span></span>;</span><br></pre></td></tr></table></figure>

<p>这样只需要在热更包中包含最新的 <code>*.stable.upipelinecache</code>，之后调用<code>OpenPipelineFileCache</code> 加载最新的 PSO Cache 即可，可以与 ShaderCode 的热更流程保持一致。</p>
<p>生成新的 PSO Cache 需要关键的两种数据：</p>
<ol>
<li>运行时捕获的 PSO 数据（upipelinecache）</li>
<li>ShaderStableInfo（位于 Metadata 目录下）</li>
</ol>
<p>因为 ShaderCode 是可以热更的，而 <code>ShaderStableInfo</code> 可以通过 Cook 最新的工程获得，所以 PSO Cache 也是可以通过热更 Shader 并不断地捕获最新的 PSO 数据进行迭代更新的。<br>准备有时间给 <a href="https://github.com/hxhb/HotPatcher">HotPacther</a> 中增加 PSO Caching 的热更功能，这样也可以把 PSO Caching 的部署和打包集成至自动化地热更流程，先挖个坑。</p>
<p>因为当开启了 <code>r.ShaderPipelineCache.Enabled=1</code>，在引擎启动时就会自动加载项目的 PSO Cache，而引擎中做了限制，只能够加载一次，后续调用<code>OpenPipelineFileCache</code> 的都不会被加载：</p>
<figure class="highlight cpp"><figcaption><span>Runtime\RHI\Private\PipelineFileCache.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FPipelineFileCache::OpenPipelineFileCache</span><span class="params">(FString <span class="keyword">const</span>&amp; Name, EShaderPlatform Platform, FGuid&amp; OutGameFileGuid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">bool</span> bOk = <span class="literal">false</span>;</span><br><span class="line">  OutGameFileGuid = <span class="built_in">FGuid</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">IsPipelineFileCacheEnabled</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function">FRWScopeLock <span class="title">Lock</span><span class="params">(FileCacheLock, SLT_Write)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(FileCache == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      FileCache = <span class="keyword">new</span> <span class="built_in">FPipelineCacheFile</span>();</span><br><span class="line">      </span><br><span class="line">      bOk = FileCache-&gt;<span class="built_in">OpenPipelineFileCache</span>(Name, Platform, OutGameFileGuid);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// File Cache now exists - these caches should be empty for this file otherwise will have false positives from any previous file caching - if not something has been caching when it should not be</span></span><br><span class="line">      <span class="built_in">check</span>(NewPSOs.<span class="built_in">Num</span>() == <span class="number">0</span>);</span><br><span class="line">      <span class="built_in">check</span>(NewPSOHashes.<span class="built_in">Num</span>() == <span class="number">0</span>);</span><br><span class="line">      <span class="built_in">check</span>(RunTimeToPSOUsage.<span class="built_in">Num</span>() == <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> bOk;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当引擎默认加载执行之后 <code>FileCache</code> 就不为 <code>nullptr</code> 了，后续所有的加载调用都会直接返回 <code>false</code>，解决办法就是，让引擎启动时不自动加载 PSO Cache，等到运行时热更之后由我们手动加载，翻了下代码，可以从这个<code>IsPipelineFileCacheEnabled</code> 检测中做：</p>
<figure class="highlight cpp"><figcaption><span>Runtime\RHI\Private\PipelineFileCache.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FPipelineFileCache::IsPipelineFileCacheEnabled</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">bool</span> bOnce = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">bool</span> bCmdLineForce = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (!bOnce)</span><br><span class="line">  &#123;</span><br><span class="line">    bOnce = <span class="literal">true</span>;</span><br><span class="line">    bCmdLineForce = FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;psocache&quot;</span>));</span><br><span class="line">    <span class="built_in">UE_CLOG</span>(bCmdLineForce, LogRHI, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;****************************** Forcing PSO cache from command line&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> FileCacheEnabled &amp;&amp; (bCmdLineForce || CVarPSOFileCacheEnabled.<span class="built_in">GetValueOnAnyThread</span>() == <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它的返回值依赖了两个值：<code>FileCacheEnabled</code>以及<code>CVarPSOFileCacheEnabled</code>。</p>
<p><code>FileCacheEnabled</code>在 <code>FPipelineFileCache::Initialize</code> 中被赋值，IOS 之外的平台总是 <code>true</code>，IOS 则依赖于<code>FPipelineFileCache::ShouldEnableFileCache</code> 的结果。</p>
<p><code>CVarPSOFileCacheEnabled</code>是一个控制台变量，用来控制 <code>r.ShaderPipelineCache.Enabled</code> 的值：</p>
<figure class="highlight cpp"><figcaption><span>Runtime\RHI\Private\PipelineFileCache.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> TAutoConsoleVariable&lt;int32&gt; <span class="title">CVarPSOFileCacheEnabled</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">                               TEXT(<span class="string">&quot;r.ShaderPipelineCache.Enabled&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">                               PIPELINE_CACHE_DEFAULT_ENABLED,</span></span></span><br><span class="line"><span class="params"><span class="function">                               TEXT(<span class="string">&quot;1 Enables the PipelineFileCache, 0 disables it.&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">                               ECVF_Default | ECVF_RenderThreadSafe</span></span></span><br><span class="line"><span class="params"><span class="function">                               )</span></span>;</span><br></pre></td></tr></table></figure>
<p>我们需要做的有三步：</p>
<ol>
<li>引擎默认启动时 <code>CVarPSOFileCacheEnabled</code> 的值为 false</li>
<li>运行时手动修改 <code>CVarPSOFileCacheEnabled</code> 值，开启 PSO Cache</li>
<li>加载 PSO Cache</li>
</ol>
<p>具体实现流程：</p>
<ol>
<li>在 <code>DefaultEngine.ini</code> 中将 <code>r.ShaderPipelineCache.Enabled=0</code> 并打包</li>
</ol>
<figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="section">[ConsoleVariables]</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.Enabled</span>=<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>然后写两个函数在运行时开启和加载 PSO：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ShaderPipelineCache.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;RHIShaderFormatDefinitions.inl&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;HAL/IConsoleManager.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UFlibShaderPipelineCacheHelper::EnableShaderPipelineCache</span><span class="params">(<span class="keyword">bool</span> bEnable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">UE_LOG</span>(LogHotPatcher,Display,<span class="built_in">TEXT</span>(<span class="string">&quot;EnableShaderPipelineCache %s&quot;</span>),bEnable?<span class="built_in">TEXT</span>(<span class="string">&quot;true&quot;</span>):<span class="built_in">TEXT</span>(<span class="string">&quot;false&quot;</span>));</span><br><span class="line">  <span class="keyword">auto</span> Var =  IConsoleManager::<span class="built_in">Get</span>().<span class="built_in">FindConsoleVariable</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;r.ShaderPipelineCache.Enabled&quot;</span>));</span><br><span class="line">  <span class="keyword">if</span>(Var)</span><br><span class="line">  &#123;</span><br><span class="line">    Var-&gt;<span class="built_in">Set</span>(bEnable ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> !!Var;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UFlibShaderPipelineCacheHelper::LoadShaderPipelineCache</span><span class="params">(<span class="keyword">const</span> FString&amp; Name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">UE_LOG</span>(LogHotPatcher,Display,<span class="built_in">TEXT</span>(<span class="string">&quot;Load Shader pipeline cache %s for platform %d&quot;</span>),*Name,*<span class="built_in">ShaderPlatformToShaderFormatName</span>(GMaxRHIShaderPlatform).<span class="built_in">ToString</span>());</span><br><span class="line">  <span class="keyword">return</span> FShaderPipelineCache::<span class="built_in">OpenPipelineFileCache</span>(Name,GMaxRHIShaderPlatform);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样即可实现 PSO Cache 的延迟加载，手动加载时机在热更之后加载即可。</p>
<h3 id="延迟采集和存储"><a href="# 延迟采集和存储" class="headerlink" title="延迟采集和存储"></a>延迟采集和存储 </h3><p> 因为采集和存储 PSO Cache 具有额外的性能消耗，所以可以把采集和存储 PSO 数据关闭，根据需求在运行时再开启。<br>在 <code>DefaultEngine.ini</code> 中关闭 <code>LogPSO</code> 和<code>SaveBoundPSOLog</code>，打基础包时就不会自动采集和自动存储了：</p>
<figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="section">[ConsoleVariables]</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.LogPSO</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.SaveBoundPSOLog</span>=<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>然后在运行时开启：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UENUM</span>(BlueprintType)</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="title">EPSOSaveMode</span> :</span> uint8</span><br><span class="line">&#123;</span><br><span class="line">	Incremental = <span class="number">0</span>, <span class="comment">// Fast(er) approach which saves new entries incrementally at the end of the file, replacing the table-of-contents, but leaves everything else alone.</span></span><br><span class="line">	BoundPSOsOnly = <span class="number">1</span>, <span class="comment">// Slower approach which consolidates and saves all PSOs used in this run of the program, removing any entry that wasn&#x27;t seen, and sorted by the desired sort-mode.</span></span><br><span class="line">	SortedBoundPSOs = <span class="number">2</span> <span class="comment">// Slow save consolidates all PSOs used on this device that were never part of a cache file delivered in game-content, sorts entries into the desired order and will thus read-back from disk.</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UFlibShaderPipelineCacheHelper::SavePipelineFileCache</span><span class="params">(EPSOSaveMode Mode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> FShaderPipelineCache::<span class="built_in">SavePipelineFileCache</span>((FPipelineFileCache::SaveMode)Mode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UFlibShaderPipelineCacheHelper::EnableLogPSO</span><span class="params">(<span class="keyword">bool</span> bEnable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">UE_LOG</span>(LogHotPatcher,Display,<span class="built_in">TEXT</span>(<span class="string">&quot;EnableLogPSO %s&quot;</span>),bEnable?<span class="built_in">TEXT</span>(<span class="string">&quot;true&quot;</span>):<span class="built_in">TEXT</span>(<span class="string">&quot;false&quot;</span>));</span><br><span class="line">	<span class="keyword">auto</span> Var =  IConsoleManager::<span class="built_in">Get</span>().<span class="built_in">FindConsoleVariable</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;r.ShaderPipelineCache.LogPSO&quot;</span>));</span><br><span class="line">	<span class="keyword">if</span>(Var)</span><br><span class="line">	&#123;</span><br><span class="line">		Var-&gt;<span class="built_in">Set</span>(bEnable ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> !!Var;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UFlibShaderPipelineCacheHelper::EnableSaveBoundPSOLog</span><span class="params">(<span class="keyword">bool</span> bEnable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">UE_LOG</span>(LogHotPatcher,Display,<span class="built_in">TEXT</span>(<span class="string">&quot;EnableSaveBoundPSOLog %s&quot;</span>),bEnable?<span class="built_in">TEXT</span>(<span class="string">&quot;true&quot;</span>):<span class="built_in">TEXT</span>(<span class="string">&quot;false&quot;</span>));</span><br><span class="line">	<span class="keyword">auto</span> Var =  IConsoleManager::<span class="built_in">Get</span>().<span class="built_in">FindConsoleVariable</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;r.ShaderPipelineCache.SaveBoundPSOLog&quot;</span>));</span><br><span class="line">	<span class="keyword">if</span>(Var)</span><br><span class="line">	&#123;</span><br><span class="line">		Var-&gt;<span class="built_in">Set</span>(bEnable ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> !!Var;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>开启 <code>SaveBoundPSOLog</code> 后会自动存储采集的 PSO 数据，可以不开启自动存储，在运行时通过调用 <code>FShaderPipelineCache::SavePipelineFileCache</code> 手动存储。</p>
<h3 id="错误处理"><a href="# 错误处理" class="headerlink" title="错误处理"></a>错误处理 </h3><h4 id="Cook 没有生成 -scl-csv"><a href="#Cook 没有生成 -scl-csv" class="headerlink" title="Cook 没有生成.scl.csv"></a>Cook 没有生成.scl.csv</h4><p> 注意，一定要为项目开启<code>ShaderStableKeys</code>，不然不会生成.scl.csv 文件。</p>
<h4 id="运行时没有生成 upipelinecache 文件"><a href="# 运行时没有生成 upipelinecache 文件" class="headerlink" title="运行时没有生成 upipelinecache 文件"></a>运行时没有生成 upipelinecache 文件 </h4><p> 请严格按照 <a href="https://imzlp.com/posts/24336/#%E8%BF%90%E8%A1%8C%E6%97%B6%E6%8D%95%E8%8E%B7PSO%E6%95%B0%E6%8D%AE"> 运行时捕获 PSO 数据 </a> 中的步骤执行。</p>
<ol>
<li>确认是否开启<code>r.ShaderPipelineCache.Enabled</code>（DefaultEngine.ini 或 DeviceProfile）。</li>
<li>在 ue4commandline.txt 中添加 <code>-logPSO</code> 参数。</li>
</ol>
<h4 id="Bad-PSO"><a href="#Bad-PSO" class="headerlink" title="Bad PSO"></a>Bad PSO</h4><p>如果使用公版引擎，上述流程就是完整的流程，但是有时项目需要修改引擎支持一些渲染特性，如添加 Multi-subpasshint 支持：</p>
<figure class="highlight cpp"><figcaption><span>Runtime\RHI\Public\PipelineFileCache.h</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">RHI_API</span> <span class="title">FPipelineCacheFileFormatPSO</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">RHI_API</span> <span class="title">GraphicsDescriptor</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="comment">// uint8 SubpassHint; to SubpassHint[8];</span></span><br><span class="line">    uint8 SubpassHint[<span class="number">8</span>];  </span><br><span class="line">    uint8 SubpassIndex;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这处变动需要同时修改 <code>GraphicsDescriptor::StateToString()</code> 与<code>GraphicsDescriptor::StateFromString()</code>两个函数，加入 multi-subpasshint 的序列化支持。</p>
<p>但是，修改之后使用 <code>-run=ShaderPipelineCacheTools</code> 生成 <code>*.stablepc.csv</code> 时有以下报错的 Log：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">LogShaderPipelineCacheTools: Expanding matched    1 files: D:\PipelineCaches\*.rec.upipelinecache</span><br><span class="line">LogShaderPipelineCacheTools:                              : D:\PipelineCaches\++UE4+Release-4.25-CL-0-PSOCaching_GLSL_ES3_1_ANDROID_0008BF4D08D9069169A7B6820601243D.rec.upipelinecache</span><br><span class="line">LogShaderPipelineCacheTools: Expanding matched    2 files: D:\PipelineCaches\*.scl.csv</span><br><span class="line">LogShaderPipelineCacheTools:                              : D:\PipelineCaches\ShaderStableInfo-Global-GLSL_ES3_1_ANDROID.scl.csv</span><br><span class="line">LogShaderPipelineCacheTools:                              : D:\PipelineCaches\ShaderStableInfo-PSOCaching-GLSL_ES3_1_ANDROID.scl.csv</span><br><span class="line">LogShaderPipelineCacheTools: Display: Loading D:\PipelineCaches\ShaderStableInfo-Global-GLSL_ES3_1_ANDROID.scl.csv...</span><br><span class="line">LogShaderPipelineCacheTools: Display: Loading D:\PipelineCaches\ShaderStableInfo-PSOCaching-GLSL_ES3_1_ANDROID.scl.csv...</span><br><span class="line">LogShaderPipelineCacheTools: Display: Loaded 926 shader info lines from D:\PipelineCaches\ShaderStableInfo-Global-GLSL_ES3_1_ANDROID.scl.csv.</span><br><span class="line">LogShaderPipelineCacheTools: Display: Loaded 9266 shader info lines from D:\PipelineCaches\ShaderStableInfo-PSOCaching-GLSL_ES3_1_ANDROID.scl.csv.</span><br><span class="line">LogShaderPipelineCacheTools: Display: Loaded 10192 unique shader info lines total.</span><br><span class="line">LogShaderPipelineCacheTools: Display: Loading D:\PipelineCaches\++UE4+Release-4.25-CL-0-PSOCaching_GLSL_ES3_1_ANDROID_0008BF4D08D9069169A7B6820601243D.rec.upipelinecache....</span><br><span class="line">LogShaderPipelineCacheTools: Display: Loaded 115 PSOs</span><br><span class="line">LogShaderPipelineCacheTools: Warning: Bad PSO found discarding [Invertibility=FAIL Verify=PASS in: D:\PipelineCaches\++UE4+Release-4.25-CL-0-PSOCaching_GLSL_ES3_1_ANDROID_0008BF4D08D9069169A7B6820601243D.rec.upipelinecache]</span><br><span class="line">LogShaderPipelineCacheTools: Warning: Bad PSO found discarding [Invertibility=FAIL Verify=PASS in: D:\PipelineCaches\++UE4+Release-4.25-CL-0-PSOCaching_GLSL_ES3_1_ANDROID_0008BF4D08D9069169A7B6820601243D.rec.upipelinecache]</span><br><span class="line">LogShaderPipelineCacheTools: Warning: Bad PSO found discarding [Invertibility=FAIL Verify=PASS in: D:\PipelineCaches\++UE4+Release-4.25-CL-0-PSOCaching_GLSL_ES3_1_ANDROID_0008BF4D08D9069169A7B6820601243D.rec.upipelinecache]</span><br><span class="line">LogShaderPipelineCacheTools: Warning: Bad PSO found discarding [Invertibility=FAIL Verify=PASS in: D:\PipelineCaches\++UE4+Release-4.25-CL-0-PSOCaching_GLSL_ES3_1_ANDROID_0008BF4D08D9069169A7B6820601243D.rec.upipelinecache]</span><br><span class="line">LogShaderPipelineCacheTools: Warning: Bad PSO found discarding [Invertibility=FAIL Verify=PASS in: D:\PipelineCaches\++UE4+Release-4.25-CL-0-PSOCaching_GLSL_ES3_1_ANDROID_0008BF4D08D9069169A7B6820601243D.rec.upipelinecache]</span><br><span class="line">LogShaderPipelineCacheTools: Warning: Bad PSO found discarding [Invertibility=FAIL Verify=PASS in: D:\PipelineCaches\++UE4+Release-4.25-CL-0-PSOCaching_GLSL_ES3_1_ANDROID_0008BF4D08D9069169A7B6820601243D.rec.upipelinecache]</span><br><span class="line">LogShaderPipelineCacheTools: Warning: Bad PSO found discarding [Invertibility=FAIL Verify=PASS in: D:\PipelineCaches\++UE4+Release-4.25-CL-0-PSOCaching_GLSL_ES3_1_ANDROID_0008BF4D08D9069169A7B6820601243D.rec.upipelinecache]</span><br><span class="line">LogShaderPipelineCacheTools: Warning: Bad PSO found discarding [Invertibility=FAIL Verify=PASS in: D:\PipelineCaches\++UE4+Release-4.25-CL-0-PSOCaching_GLSL_ES3_1_ANDROID_0008BF4D08D9069169A7B6820601243D.rec.upipelinecache]</span><br><span class="line">LogShaderPipelineCacheTools: Warning: Bad PSO found discarding [Invertibility=FAIL Verify=PASS in: D:\PipelineCaches\++UE4+Release-4.25-CL-0-PSOCaching_GLSL_ES3_1_ANDROID_0008BF4D08D9069169A7B6820601243D.rec.upipelinecache]</span><br><span class="line">LogShaderPipelineCacheTools: Warning: Bad PSO found discarding [Invertibility=FAIL Verify=PASS in: D:\PipelineCaches\++UE4+Release-4.25-CL-0-PSOCaching_GLSL_ES3_1_ANDROID_0008BF4D08D9069169A7B6820601243D.rec.upipelinecache]</span><br></pre></td></tr></table></figure>

<p>这是因为 PSO 数据从 String 的可逆性验证失败了：</p>
<figure class="highlight cpp"><figcaption><span>Editor\UnrealEd\Private\Commandlets\ShaderPipelineCacheToolsCommandlet.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">CheckPSOStringInveribility</span><span class="params">(<span class="keyword">const</span> FPipelineCacheFileFormatPSO&amp; Item)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="function">FPipelineCacheFileFormatPSO <span class="title">TempItem</span><span class="params">(Item)</span></span>;</span><br><span class="line">  TempItem.Hash = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  FString StringRep;</span><br><span class="line">  <span class="keyword">if</span> (Item.Type == FPipelineCacheFileFormatPSO::DescriptorType::Compute)</span><br><span class="line">  &#123;</span><br><span class="line">    StringRep = TempItem.ComputeDesc.<span class="built_in">ToString</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    StringRep = TempItem.GraphicsDesc.<span class="built_in">ToString</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  FPipelineCacheFileFormatPSO DupItem;</span><br><span class="line">  FMemory::<span class="built_in">Memzero</span>(DupItem.GraphicsDesc);</span><br><span class="line">  DupItem.Type = Item.Type;</span><br><span class="line">  DupItem.UsageMask = Item.UsageMask;</span><br><span class="line">  <span class="keyword">if</span> (Item.Type == FPipelineCacheFileFormatPSO::DescriptorType::Compute)</span><br><span class="line">  &#123;</span><br><span class="line">    DupItem.ComputeDesc.<span class="built_in">FromString</span>(StringRep);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    DupItem.GraphicsDesc.<span class="built_in">FromString</span>(StringRep);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">UE_LOG</span>(LogShaderPipelineCacheTools, Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;CheckPSOStringInveribility: %s&quot;</span>), *StringRep);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (DupItem == TempItem) &amp;&amp; (<span class="built_in">GetTypeHash</span>(DupItem) == <span class="built_in">GetTypeHash</span>(TempItem));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关键部分在于 <code>DupItem.GraphicsDesc.FromString(StringRep);</code> 这行代码中 <code>GraphicsDesc</code> 的数据没有恢复成功。</p>
<p>经过调试发现，引擎中具有记录 PipelineCacheGraphicsDesc 的字符串中可被解析元素的数量，也就是生成的 <code>*.stablepc.csv</code> 中第二列中数据的数量，公版引擎中默认是 63 个，使用 <code>FPipelineCacheGraphicsDescPartsNum</code> 记录：</p>
<figure class="highlight cpp"><figcaption><span>Runtime\RHI\Private\PipelineFileCache.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> int32  FPipelineCacheGraphicsDescPartsNum = <span class="number">63</span>; <span class="comment">// parser will expect this number of parts in a description string</span></span><br></pre></td></tr></table></figure>
<p>生成的 <code>*.stablepc.csv</code> 中各项状态和数据如下：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/24336/20210424_114130.webp"></p>
<p>刚好是 63 个。需要注意的是，在 <code>GraphicsDescriptor::StateFromString</code> 对数据的数量做了检测，FromString 的数据数量要与 <code>FPipelineCacheGraphicsDescPartsNum</code> 的值一致：</p>
<figure class="highlight cpp"><figcaption><span>Runtime\RHI\Private\PipelineFileCache.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">bool</span> FPipelineCacheFileFormatPSO::GraphicsDescriptor::<span class="built_in">StateFromString</span>(<span class="keyword">const</span> FStringView&amp; Src)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">constexpr</span> int32 PartCount = FPipelineCacheGraphicsDescPartsNum;</span><br><span class="line"></span><br><span class="line">  TArray&lt;FStringView, TInlineAllocator&lt;PartCount&gt;&gt; Parts;</span><br><span class="line">  UE::String::<span class="built_in">ParseTokens</span>(Src.<span class="built_in">TrimStartAndEnd</span>(), <span class="built_in">TEXT</span>(<span class="string">&#x27;,&#x27;</span>), [&amp;Parts](FStringView Part) &#123; Parts.<span class="built_in">Add</span>(Part); &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// check if we have expected number of parts</span></span><br><span class="line">  <span class="keyword">if</span> (Parts.<span class="built_in">Num</span>() != PartCount)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// instead of crashing let caller handle this case</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/24336/20210424115803.webp"></p>
<p>因为我们增加了 multi-subpasshint 支持，把 <code>SubpassHint</code> 从<code>uint8</code>改成了 <code>uint8[8]</code>，增加了 7 个数据，所以与之对应的<code>FPipelineCacheGraphicsDescPartsNum</code> 也要加 7，改为 70，上面 <code>StateFromString</code> 验证才能够通过。</p>
<p>修改之后再通过 <code>-run=ShaderPipelineCacheTools</code> 生成 <code>*.stablepc.csv</code> 就没有 <code>Bas PSO</code> 的错误了。</p>
<h3 id="使用与配置"><a href="# 使用与配置" class="headerlink" title="使用与配置"></a>使用与配置</h3><ul>
<li><a href="https://docs.unrealengine.com/en-US/SharingAndReleasing/PSOCaching/CompilingUsingPSOCachingData/index.html">Compiling &amp; Using PSO Caching Data</a></li>
</ul>
<p>可以通过 <code>FShaderPipelineCache</code> 的函数在运行时控制构建 PSO 数据：</p>
<figure class="highlight cpp"><figcaption><span>Runtime\RenderCore\Public\ShaderPipelineCache.h</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">/** Pauses precompilation. */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">PauseBatching</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">/** Resumes precompilation batching. */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ResumeBatching</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">/** Returns the number of pipelines waiting for precompilation. */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> uint32 <span class="title">NumPrecompilesRemaining</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">/** Returns the number of pipelines actively being precompiled this frame. */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> uint32 <span class="title">NumPrecompilesActive</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">/** Sets the precompilation batching mode. */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SetBatchMode</span><span class="params">(BatchMode Mode)</span></span>;</span><br></pre></td></tr></table></figure>
<p>官方建议的做法是在加载屏幕时等待 PSO 构建完毕，再把 LoadingScreen 隐藏：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(FShaderPipelineCache::<span class="built_in">NumPrecompilesRemaining</span>() &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (OutDebugReason != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        *OutDebugReason = <span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;PC: PSO cache still compiling&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也可以在打开 UI、过场动画、暂停菜单时构建，通过以下三个函数组合处理：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 暂停 PSO 缓存编译</span></span><br><span class="line">FShaderPipelineCache::<span class="built_in">PauseBatching</span>();</span><br><span class="line"><span class="comment">// 设置 PSO 的处理模式</span></span><br><span class="line"><span class="comment">// enum class BatchMode</span></span><br><span class="line"><span class="comment">// &#123; </span></span><br><span class="line"><span class="comment">//   Background, // The maximum batch size is defined by r.ShaderPipelineCache.BackgroundBatchSize</span></span><br><span class="line"><span class="comment">//   Fast, // The maximum batch size is defined by r.ShaderPipelineCache.BatchSize</span></span><br><span class="line"><span class="comment">//   Precompile // The maximum batch size is defined by r.ShaderPipelineCache.PrecompileBatchSize</span></span><br><span class="line"><span class="comment">// &#125;;</span></span><br><span class="line">FShaderPipelineCache::<span class="built_in">SetBatchMode</span>(FShaderPipelineCache::BatchMode::Background);</span><br><span class="line"><span class="comment">// 恢复编译 PSO</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ResumeBatching</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p>也可以使用配置在游戏启动时自动构建，修改 <code>DefaultEngine.ini</code> 中<code>[ConsoleVariables]</code>的配置，它们否时定义在 <code>Runtime\RenderCore\Private\ShaderPipelineCache.cpp</code> 中的<code>ConsoleVariable</code>，可以根据自己的需要在运行时或配置文件中进行修改：</p>
<p>PSO 引擎默认配置:</p>
<figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="section">[ConsoleVariables]</span></span><br><span class="line"><span class="comment">;Sets the startup mode for the PSO cache, determining what the cache does after initialisation:</span></span><br><span class="line"><span class="comment">;0: Precompilation is paused and nothing will compile until a call to ResumeBatching().</span></span><br><span class="line"><span class="comment">;1: Precompilation is enabled in the &#x27;Fast&#x27; mode.</span></span><br><span class="line"><span class="comment">;2: Precompilation is enabled in the &#x27;Background&#x27; mode.</span></span><br><span class="line"><span class="comment">;Default is 1.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.StartupMode</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the number of PipelineStateObjects to compile in a single batch operation when compiling takes priority. Defaults to a maximum of 50 per frame, due to async. file IO it is less in practice.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.BackgroundBatchSize</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the number of PipelineStateObjects to compile in a single batch operation when pre-optimizing the cache. Defaults to a maximum of 50 per frame, due to async. file IO it is less in practice.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.PrecompileBatchSize</span>=<span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;The target time (in ms) to spend precompiling each frame when in the background or 0.0 to disable. When precompiling is faster the batch size will grow and when slower will shrink to attempt to occupy the full amount. Defaults to 0.0 (off).</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.BackgroundBatchTime</span>=<span class="number">0.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;The target time (in ms) to spend precompiling each frame when compiling takes priority or 0.0 to disable. When precompiling is faster the batch size will grow and when slower will shrink to attempt to occupy the full amount. Defaults to 16.0 (max. ms per-frame of precompilation).</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.BatchTime</span>=<span class="number">16.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;The target time (in ms) to spend precompiling each frame when cpre-optimizing or 0.0 to disable. When precompiling is faster the batch size will grow and when slower will shrink to attempt to occupy the full amount. Defaults to 10.0 (off).</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.PrecompileBatchTime</span>=<span class="number">0.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the number of PipelineStateObjects to log before automatically saving. 0 will disable automatic saving. Shipping defaults to 0, otherwise default is 100.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.SaveAfterPSOsLogged</span>=<span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the time where any logged PSO&#x27;s will be saved if the number is &lt; r.ShaderPipelineCache.SaveAfterPSOsLogged. Disabled when r.ShaderPipelineCache.SaveAfterPSOsLogged is 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the time where any logged PSO&#x27;s will be saved if the number is &lt; r.ShaderPipelineCache.SaveAfterPSOsLogged. Disabled when r.ShaderPipelineCache.SaveAfterPSOsLogged is 0</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.AutoSaveTime</span>=<span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Mask used to precompile the cache. Defaults to all PSOs (-1)</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.PreCompileMask</span>=-<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the time where any logged PSO&#x27;s will be saved when -logpso is on the command line.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.AutoSaveTimeBoundPSO</span>=<span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;If &gt; 0 then a log of all bound PSOs for this run of the program will be saved to a writable user cache file. Defaults to 0 but is forced on with -logpso.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.SaveBoundPSOLog</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set non zero to use GameFileMask during PSO precompile - recording should always save out the usage masks to make that data availble when needed.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.GameFileMaskEnabled</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set non zero to PreOptimize PSOs - this allows some PSOs to be compiled in the foreground before going in to game</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.PreOptimizeEnabled</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;The minimum bind count to allow a PSO to be precompiled.  Changes to this value will not affect PSOs that have already been removed from consideration.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.MinBindCount</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;The maximum time to allow a PSO to be precompiled.  if greather than 0, the amount of wall time we will allow pre-compile of PSOs and then switch to background processing.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.MaxPrecompileTime</span>=<span class="number">0.0</span></span><br></pre></td></tr></table></figure>
<p>我修改的配置:</p>
<figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="section">[ConsoleVariables]</span></span><br><span class="line"><span class="comment">;Sets the startup mode for the PSO cache, determining what the cache does after initialisation:</span></span><br><span class="line"><span class="comment">;0: Precompilation is paused and nothing will compile until a call to ResumeBatching().</span></span><br><span class="line"><span class="comment">;1: Precompilation is enabled in the &#x27;Fast&#x27; mode.</span></span><br><span class="line"><span class="comment">;2: Precompilation is enabled in the &#x27;Background&#x27; mode.</span></span><br><span class="line"><span class="comment">;Default is 1.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.StartupMode</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the number of PipelineStateObjects to compile in a single batch operation when compiling takes priority. Defaults to a maximum of 50 per frame, due to async. file IO it is less in practice.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.BatchSize</span>=<span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;The target time (in ms) to spend precompiling each frame when compiling takes priority or 0.0 to disable. When precompiling is faster the batch size will grow and when slower will shrink to attempt to occupy the full amount. Defaults to 16.0 (max. ms per-frame of precompilation).</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.BatchTime</span>=<span class="number">16.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the number of PipelineStateObjects to compile in a single batch operation when compiling takes priority. Defaults to a maximum of 50 per frame, due to async. file IO it is less in practice.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.BackgroundBatchSize</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the number of PipelineStateObjects to compile in a single batch operation when pre-optimizing the cache. Defaults to a maximum of 50 per frame, due to async. file IO it is less in practice.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.PrecompileBatchSize</span>=<span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;The target time (in ms) to spend precompiling each frame when in the background or 0.0 to disable. When precompiling is faster the batch size will grow and when slower will shrink to attempt to occupy the full amount. Defaults to 0.0 (off).</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.BackgroundBatchTime</span>=<span class="number">11.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;The target time (in ms) to spend precompiling each frame when cpre-optimizing or 0.0 to disable. When precompiling is faster the batch size will grow and when slower will shrink to attempt to occupy the full amount. Defaults to 10.0 (off).</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.PrecompileBatchTime</span>=<span class="number">10.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the number of PipelineStateObjects to log before automatically saving. 0 will disable automatic saving. Shipping defaults to 0, otherwise default is 100.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.SaveAfterPSOsLogged</span>=<span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the time where any logged PSO&#x27;s will be saved if the number is &lt; r.ShaderPipelineCache.SaveAfterPSOsLogged. Disabled when r.ShaderPipelineCache.SaveAfterPSOsLogged is 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the time where any logged PSO&#x27;s will be saved if the number is &lt; r.ShaderPipelineCache.SaveAfterPSOsLogged. Disabled when r.ShaderPipelineCache.SaveAfterPSOsLogged is 0</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.AutoSaveTime</span>=<span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Mask used to precompile the cache. Defaults to all PSOs (-1)</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.PreCompileMask</span>=-<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the time where any logged PSO&#x27;s will be saved when -logpso is on the command line.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.AutoSaveTimeBoundPSO</span>=<span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set non zero to use GameFileMask during PSO precompile - recording should always save out the usage masks to make that data availble when needed.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.GameFileMaskEnabled</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set non zero to PreOptimize PSOs - this allows some PSOs to be compiled in the foreground before going in to game</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.PreOptimizeEnabled</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;The minimum bind count to allow a PSO to be precompiled.  Changes to this value will not affect PSOs that have already been removed from consideration.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.MinBindCount</span>=<span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;The maximum time to allow a PSO to be precompiled.  if greather than 0, the amount of wall time we will allow pre-compile of PSOs and then switch to background processing.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.MaxPrecompileTime</span>=<span class="number">33</span></span><br></pre></td></tr></table></figure>

<p>开启了启动时自动构建 PSO 数据，会有以下 log：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">LogRHI: Base name for record PSOs is ../../../FGame/Saved/CollectedPSOs/++UE4+Release-4.25-CL-0-FGame_SF_METAL_8F3222B7964FE2A89C849E90E0000736.rec.upipelinecache</span><br><span class="line">LogRHI: FPipelineCacheFile Header Game ue_version: 0</span><br><span class="line">LogRHI: FPipelineCacheFile Header Engine Data ue_version: 17</span><br><span class="line">LogRHI: FPipelineCacheFile Header TOC Offset: 293853</span><br><span class="line">LogRHI: FPipelineCacheFile File Size: 380497 Bytes</span><br><span class="line">LogRHI: Opened FPipelineCacheFile: ../../../FGame/Content/PipelineCaches/IOS/FGame_SF_METAL.stable.upipelinecache (GUID: 00000000000000000000000000000000) with 690 entries.</span><br><span class="line">LogRHI: Display: Opened pipeline cache and enqueued 441 of 441 tasks for precompile with BatchSize 50 and BatchTime 10.000000.</span><br></pre></td></tr></table></figure>

<p>也可以在 <code>DefaultGameUserSettings.ini</code> 中设置 PSO 的<code>SortOrder</code>：</p>
<figure class="highlight ini"><figcaption><span>DefaultGameUserSettings.ini</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="section">[ShaderPipelineCache.CacheFile]</span></span><br><span class="line"><span class="comment">;default is 0</span></span><br><span class="line"><span class="comment">;Default = 0, // Whatever order they are already in.</span></span><br><span class="line"><span class="comment">;FirstToLatestUsed = 1, // Start with the PSOs with the lowest first-frame used and work toward those with the highest.</span></span><br><span class="line"><span class="comment">;MostToLeastUsed = 2 // Start with the most often used PSOs working toward the least.</span></span><br><span class="line"><span class="attr">SortOrder</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="参考资料"><a href="# 参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul>
<li><a href="https://docs.unrealengine.com/en-US/SharingAndReleasing/PSOCaching/index.html">PSO Caching</a>。</li>
<li><a href="https://www.youtube.com/watch?v=0tzrsEm6V9Q&ab_channel=StephenMaloney">Unreal Engine 4: PSO Caching (Pipeline State Object) to Reduce Load Times/Hitches</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/72768828">UE4 渲染引擎模块简介(2)</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Optimization</category>
      </categories>
      <tags>
        <tag>Optimization</tag>
        <tag>PSO Caching</tag>
      </tags>
  </entry>
  <entry>
    <title>裁剪不必要的引擎模块</title>
    <url>/wiki/10845/</url>
    <content><![CDATA[<p>可以根据项目需求可以裁剪以下的引擎模块支持，降低编译的可执行文件、包体大小：</p>
<h3 id="APEX"><a href="#APEX" class="headerlink" title="APEX"></a>APEX</h3><p>如果不适用 Nvidia 的 APEX 破碎系统，可以在编译引擎时去掉 APEX 的支持。</p>
<p>可以在 BuildSetting 或者 TargetRules 设置<code>bCompileAPEX=true</code>。</p>
<h3 id="Recast-NavMesh"><a href="#Recast-NavMesh" class="headerlink" title="Recast(NavMesh)"></a>Recast(NavMesh)</h3><p>如果客户端在运行时不需要 Recast 的支持，并且不需要客户端本地进行 NavMesh 寻路操作，可以运行时裁剪掉 NavMesh 的支持。<br>可以在 BuildSetting 或者 TargetRules 设置<code>bCompileRecast=true</code>。</p>
<h3 id="FreeType"><a href="#FreeType" class="headerlink" title="FreeType"></a>FreeType</h3><p>是否需要 FreeType 字库支持，可以在 BuildSetting 或者 TargetRules 设置<code>bCompileFreeType=true</code>。</p>
<h3 id="ICU-unicode-i18n"><a href="#ICU-unicode-i18n" class="headerlink" title="ICU(unicode/i18n)"></a>ICU(unicode/i18n)</h3><p>引擎 Core 模块中对 unicode/i18n 的支持，可以在 BuildSetting 或者 TargetRules 设置<code>bCompileICU=true</code>。</p>
<h3 id="CompileForSize"><a href="#CompileForSize" class="headerlink" title="CompileForSize"></a>CompileForSize</h3><p>UE 提供的优化选项，可以控制编译时严格控制大小，但是会牺牲性能。<br>可以在 BuildSetting 或者 TargetRules 设置<code>bCompileForSize=true</code>。</p>
<h3 id="CEF3"><a href="#CEF3" class="headerlink" title="CEF3"></a>CEF3</h3><p>可选是否支持 <code>Chromium Embedded Framework</code>，Google 的嵌入式浏览器支持。<br> 可以在 BuildSetting 或者 TargetRules 设置<code>bCompileCEF3=true</code>。</p>
<h3 id="Audio 模块"><a href="#Audio 模块" class="headerlink" title="Audio 模块"></a>Audio 模块 </h3><p> 因为项目使用 WWise 作为音频播放接口，如果完全不需要引擎中内置的 Audio 模块，该部分功能是冗余的，在后续的优化中可以裁剪掉。</p>
<h3 id="国际化模块"><a href="# 国际化模块" class="headerlink" title="国际化模块"></a>国际化模块 </h3><p> 如果游戏的多语言支持不依赖 UE 的文本采集和翻译功能，可以裁剪掉该模块。</p>
<h3 id="Steam"><a href="#Steam" class="headerlink" title="Steam"></a>Steam</h3><p>游戏不需要 Steam 的支持，可以去掉，在 TargetRules 中通过 <code>bUsesSteam</code> 控制。</p>
<h3 id="SpeedTree"><a href="#SpeedTree" class="headerlink" title="SpeedTree"></a>SpeedTree</h3><p>如果游戏中不需要使用 SpeedTree 进行植被建模，可以关闭编译 SpeedTree，通过 TargetRules 中的 <code>bOverrideCompileSpeedTree</code> 控制。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Optimization</category>
      </categories>
      <tags>
        <tag>Optimization</tag>
      </tags>
  </entry>
  <entry>
    <title>PixelStreaming：基本概念与上手初探</title>
    <url>/wiki/614690b4/</url>
    <content><![CDATA[<p>PixelStreaming 是 UE_4.21 开始支持的一项技术，简单来说就是能够将游戏跑在服务器上，你可以通过浏览器来玩，玩家端不需要额外操作，只需要一个浏览器，所有的逻辑处理和渲染都在“云”端执行。它不仅仅只是一个插件 (虽然有 PixelStreamingPlugin 这个插件，但它只是<strong>PixelStreaming</strong> 实现中的一环)，其实现具有一套独立与 UE 游戏的设计和组织方式。<br>本篇文章主要介绍 PixelStreaming 中的基本概念和使用 PixelStreaming 的 Demo 的实际体验。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9455/pixelstreaming-cloud-simplified.webp"></p>
<p>来看一下 UE 自己的介绍：</p>
<blockquote>
<p>Run your Unreal Engine application on a server in the cloud, and stream its rendered frames and audio to browsers and mobile devices over WebRTC.</p>
</blockquote>
<p>PixelStreaming 的数据传输使用的是<a href="https://webrtc.org/">WebRTC</a>，P2P 的连接延迟更低。</p>
<blockquote>
<p>注意：本文所描述内容的测试引擎为 UE_4.22.3，目前 PixelStreaming 只能运行在 Windows 平台 (依赖于模块<code>D3DX11</code> 和<code>NvVideoEncoder</code>库)。</p>
</blockquote>
<p>UE 提供的 PixelStreaming 展示案例的代码分成了几个部分：</p>
<ul>
<li><strong>PixelStreamingPlugin</strong>：提供渲染帧与音频数据的捕获与编码，并创建一个链接将音频和渲染帧的数据传递给 WebRTC 服务器，使用的是 UE 的插件方式编写和使用。</li>
<li><strong>WebRTCProxy</strong>：应用 / 游戏与 WebServer 交流的中间层，作用是将游戏内编码好的渲染帧数据 (.h264) 与音频数据传递给 WebServer，并从 WebServer 上接收到的用户输入再传递给应用 / 游戏，从而可以从浏览器上控制游戏。使用 UE 的 Program 方式编写。</li>
<li><strong>WebServer</strong>：PixelStreaming 设计的组织方式中，<strong>WebServer</strong>是由两个模块组成：<a href="https://github.com/EpicGames/UnrealEngine/tree/4.22/Engine/Source/Programs/PixelStreaming/WebServers/SignallingWebServer">SignalingWebServer</a>与<a href="https://github.com/EpicGames/UnrealEngine/tree/4.22/Engine/Source/Programs/PixelStreaming/WebServers/Matchmaker">Matchmaker</a>，使用的是 nodejs 编写。</li>
<li><strong>SignallingWebServer</strong>：启动一个 HTTP 服务，从 WebRTC 接收渲染帧和音频数据传递给浏览器客户端，并接收远程用户的输入 (键盘、鼠标等) 再传递给 WebRTC。</li>
<li><strong>MatchMakerServer</strong>：如果只是启动一个游戏实例和单个的 <strong>SignallingWebServer</strong>，那么使用浏览器访问的玩家操作的都是同一个游戏实例，他们的键盘和鼠标操作都会相互干扰。解决这个的问题的办法使用<strong>MatchMakerServer</strong>，但是这种方式也是需要启动多套<strong> 游戏实例 </strong>/<strong>WebRTCProxy</strong> 以及<strong>SignallingWebServer</strong>，供外部用户每个人访问不同的游戏实例，使每个浏览器访问的客户端具有不同的连接。</li>
</ul>
<p>用户访问单个实例的流程如下图：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9455/pixel-streaming-flow.webp"></p>
<p>后续我会逐个分析一下它们各自的代码实现(上周末的简单分析了一下 PixelStreamingPlugin 的实现)，这篇文章的目的是介绍基本概念和简单的 PixelStreamingDemo 上手。</p>
<p>本篇文章的参考资料主要是 UE 文档库中对于 <a href="https://docs.unrealengine.com/en-US/Platforms/PixelStreaming/index.html">PixelStreaming</a> 的介绍，以及我读代码了解到的实现方式，目前官方文档页面的描述不是特别详细，有些细节和可以用的参数命令没有提及，还是看代码靠谱。</p>
<h2 id="PixelStreamingDemo"><a href="#PixelStreamingDemo" class="headerlink" title="PixelStreamingDemo"></a>PixelStreamingDemo</h2><p>基本概念介绍完毕，下面进入实际的上手环节。</p>
<h3 id="Launch-Game"><a href="#Launch-Game" class="headerlink" title="Launch Game"></a>Launch Game</h3><p>首先创建一个 C++ 项目，我选择了一个第三人称模板：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9455/create-pixelstreaming.webp"></p>
<p>创建完成之后，打开 <code>Edit</code>-<code>Plugins</code> 搜索启用<code>PixelStreaming</code>:</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9455/enable-pixel-streaming-plugin.webp"></p>
<p>然后重启编辑器。</p>
<p>与 UE 的官网介绍 (<a href="https://docs.unrealengine.com/en-US/Platforms/PixelStreaming/PixelStreamingIntro/index.html">Getting Started with Pixel Streaming</a>) 的需要打包不同，只要使用 Standalone 模式启动项目就可以加载 <code>PixelStreamingPlugin</code>，这样可以省去每次都要打包的麻烦。<br> 为了方便添加启动参数，可以使用我之前写的一个工具：<a href="https://github.com/hxhb/UE4Launcher">UE4 Launcher</a><br>并为其添加启动参数<code>-game</code>/<code>-log</code>/<code>-AudioMixer</code>(PixelStreamingPlugin 需要这个参数):<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9455/launch-pixel-streaming-project-by-standalone.webp"></p>
<blockquote>
<p>注:PixelStreamingPlugin 支持启动时指定要连接的 WebRTCProxy 的地址与端口，可以在上面的启动参数列表中添加。</p>
<ul>
<li><code>-PixelStreamingIP=&lt;value&gt;</code>：指定 WebRTCProxy 服务器的地址，默认为<code>0.0.0.0</code>.</li>
<li><code>-PixelStreamingPort=&lt;value&gt;</code>：指定 WebRTCProxy 服务器的端口，默认为<code>8124</code>.</li>
</ul>
</blockquote>
<p>然后点击 <code>Launch Configuration</code> 即可以 Standalone 模式启动项目。</p>
<p>启动之后可以从 Log 窗口中看到 PixelStreaming 的 Log 输出：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9455/launch-pixel-streaming-project-by-standalone-log.webp"></p>
<h3 id="WebRTCProxy"><a href="#WebRTCProxy" class="headerlink" title="WebRTCProxy"></a>WebRTCProxy</h3><p>经过上面的操作游戏启动完成之后，可以启动 WebRTC 了，打开引擎目录：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Engine\Source\Programs\PixelStreaming\WebRTCProxy\bin</span><br></pre></td></tr></table></figure>

<p>可以看到目录下有五个文件：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">2019/07/29  01:21               110 Start_AWS_WebRTCProxy.bat</span><br><span class="line">2019/07/29  01:21               473 Start_AWS_WebRTCProxy.ps1</span><br><span class="line">2019/07/29  01:21                38 Start_WebRTCProxy.bat</span><br><span class="line">2019/07/29  01:21        18,032,016 WebRTCProxy.exe</span><br><span class="line">2019/07/29  01:21        15,511,552 WebRTCProxy.pdb</span><br></pre></td></tr></table></figure>

<p>需要做的只有双击 <code>Start_WebRTCProxy.bat</code> 启动(它里面也仅仅只是启动了<strong>WebRTCProxy.exe</strong>).</p>
<p>启动之后可以看到连接信息：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9455/Launch-WebRTCProxy-log.webp"></p>
<p>此时在打开游戏项目的 Log 窗口可以看到如下内容：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[2019.07.30-08.18.49:324][758]PixelStreamingNet: Accepted connection from WebRTC Proxy: 127.0.0.1:2703</span><br></pre></td></tr></table></figure>

<p>表明 PixelStreamingPlugin 与 WebRTCProxy 已经连接成功了。</p>
<p><strong>WebRTCProxy</strong>也可以指定游戏内 <strong>PixelStreamingPlugin</strong> 设定的端口，以及 <strong>SignallingWebServer</strong> 的地址 / 端口，可以通过 <code>-help</code> 参数来查看 WebRTCProxy 支持的参数（这部分的实现代码在 <a href="https://github.com/EpicGames/UnrealEngine/blob/4.22/Engine/Source/Programs/PixelStreaming/WebRTCProxy/src/WebRTCProxy.cpp">Engine/Source/Programs/PixelStreaming/WebRTCProxy/src/WebRTCProxy.cpp</a> 中）：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">E:\UnrealEngine\Epic\UE_4.22\Engine\Source\Programs\PixelStreaming\WebRTCProxy\bin&gt;WebRTCProxy.exe -<span class="built_in">help</span></span><br><span class="line">WebRTCProxy</span><br><span class="line">Copyright 1998-2019 Epic Games, Inc. All Rights Reserved.</span><br><span class="line"></span><br><span class="line">Parameters:</span><br><span class="line"></span><br><span class="line">-<span class="built_in">help</span></span><br><span class="line">Shows this <span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">-Cirrus=&lt;IP:Port&gt;</span><br><span class="line">The Cirrus server to connect to. If not specified. it defaults to 127.0.0.1:8888</span><br><span class="line"></span><br><span class="line">-StunServer=&lt;IP:Port&gt;</span><br><span class="line">Stun server to use.</span><br><span class="line"></span><br><span class="line">-UE4Port=&lt;Port&gt;</span><br><span class="line">The port UE4 is listening on</span><br><span class="line"></span><br><span class="line">-AutoSetBitrate</span><br><span class="line">If specified, it forcibly sends a bitrate request to UE4 once a client gets</span><br><span class="line">quality control ownership</span><br><span class="line"></span><br><span class="line">-PlanB</span><br><span class="line">If specified, it will use PlanB sdp semantics. Default is UnifiedPlan.</span><br><span class="line"></span><br><span class="line">-dbgwindow=[Proxy|WebRTC|All|None]</span><br><span class="line">If running under the debugger (e.g: Visual Studio), it specifies what logs to</span><br><span class="line">send to the Output Window.</span><br><span class="line">        Proxy - Only logs from WebRTCProxy itself will be displayed.</span><br><span class="line">        WebRTC - Only logs from WebRTC internals will be displayed.</span><br><span class="line">        All - (Default) Both WebRTCProxy and WebRTC internal logs are displayed.</span><br><span class="line">        None - No logs sent to the Output Window</span><br><span class="line"></span><br><span class="line">-LocalTime</span><br><span class="line">If specified, it will use <span class="built_in">local</span> time <span class="keyword">in</span> logging, instead of UTC.</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li><code>-Cirrus=&lt;IP:Port&gt;</code>用来指定与 <strong>SignallingWebServer</strong> 通信的端口(默认为<code>127.0.0.1:8888</code>).</li>
<li><code>-UEPort=&lt;Port&gt;</code>：用来指定与该 WebRTCProxy 关联的 UE 应用的端口(PixelStreamingPlugin 中的连接端口，默认为<code>127.0.0.1:8124</code>)</li>
</ul>
<h3 id="SignallingWebServer"><a href="#SignallingWebServer" class="headerlink" title="SignallingWebServer"></a>SignallingWebServer</h3><p>当游戏与 <strong>WebRTCProxy</strong> 都启动完毕之后，需要开始启动真正供浏览器可访问的 HTTP 服务器了。</p>
<p>首先需要安装 <a href="https://nodejs.org/zh-cn/">node</a>，下载安装之后将其添加到系统的 PATH 路径，通过命令<code>node -v</code> 与<code>npm -v</code>测试是否安装成功：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">C:\Users\imzlp\Desktop&gt;node -v</span><br><span class="line">v10.16.0</span><br><span class="line">C:\Users\imzlp\Desktop&gt;npm -v</span><br><span class="line">6.9.0</span><br></pre></td></tr></table></figure>

<p>如上图则没有问题，可以启动 <strong>SignallingWebServer</strong> 了，打开引擎目录：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Engine\Source\Programs\PixelStreaming\WebServers\SignallingWebServer</span><br></pre></td></tr></table></figure>

<p>里面有一堆的文件，需要启动的是 <code>run.bat</code> 或者 <code>runNoSetup.bat</code>(他们两个唯一的区别为是否执行<code>npm install</code>)，如果你是第一次打开，则<strong> 以管理员权限 </strong> 启动<code>run.bat</code>，后续直接启动<code>runNoSetup.bat 即可</code>。</p>
<p>经过一堆的 npm 包的下载与安装之后，启动成功：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9455/Launch-SignallingWebServer-runbat.webp"></p>
<p>此时打开 <strong>WebRTCProxy</strong> 的窗口界面，可以看到以下内容：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9455/WebRTCProxy-connected-to-Cirrus.webp"></p>
<p>此时所有需要启动的服务都已启动完毕。</p>
<blockquote>
<p>注：<strong>SignallingWebServer</strong>默认连接 <code>127.0.0.1:8888</code> 的 WebRTCProxy，并开启一个 80 端口的 HTTP 服务。</p>
<ul>
<li>使用 <code>--proxyPort &lt;Port&gt;</code> 可以修改监听的 WebRTCProxy 端口，或者写在 <code>SignallingWebSerber/config.json</code> 配置下。</li>
<li>使用 <code>--httpPort &lt;Port&gt;</code> 可以修改启动的 HTTP 服务器的端口。</li>
</ul>
</blockquote>
<p>打开浏览器输入 <a href="http://127.0.0.1/">http://127.0.0.1</a>(使用的是默认端口 80，不然需要指定端口号<a href="http://127.0.0.1:xxxx">https://127.0.0.1:xxxx</a>) 就可以看到以下界面：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9455/webbrowser-127-0-0-1.webp"></p>
<p>鼠标点击即可进入游戏画面：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9455/Final-Browser-view.webp"></p>
<p>其他的移动设备如果在同一个网段，也是可以直接连接的：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9455/mobile-webbrowser-view.webp"></p>
<p>我也录了一个简单的视频(在 ipad 上操作)：</p>
<div class="video-container"><iframe src="https://www.youtube.com/embed/ag9wdNOge-8" frameborder="0" loading="lazy" allowfullscreen></iframe></div>

<h3 id="MatchMakerServer"><a href="#MatchMakerServer" class="headerlink" title="MatchMakerServer"></a>MatchMakerServer</h3><p>在文章的最开始，我简单说明了一下 <strong>MatchMakerServer</strong> 的用途，下面简单说一下如何做。</p>
<p>先来看 UE 对 <strong>MatchMakerServer</strong> 的职责图：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9455/Matchmaker-cloud-multi-server.webp"></p>
<p>用法为：在启动单个的 <strong>SignallingWebServer</strong> 时，指定参数启用<code>Matchmaker</code>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">runNoSetup.bat --UseMatchmaker --matchmakeAddress 127.0.0.1 --matchmakerPort 9999</span><br></pre></td></tr></table></figure>
<p>然后启动<strong>MatchmakerServer</strong>，找到以下路径：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Engine\Source\Programs\PixelStreaming\WebServers\Matchmaker</span><br></pre></td></tr></table></figure>
<p>直接启动 <code>run.bat</code> 的默认 <code>httpPort</code> 为 90,<code>matchmakerPort</code>为 9999，即上面运行 <strong>SignallingWebServer</strong> 时指定的<code>--matchmakerPort 9999</code>，可以自己使用参数替换。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">run.bat --httpPort 88 --matchmakerPort 9988</span><br></pre></td></tr></table></figure>

<p>下面使用的是默认的 <code>httpPort</code>/<code>matchmakePort</code> 端口</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9455/matchmaker-and-signllingServer.webp"></p>
<p>然后访问 <a href="http://127.0.0.1:90/">http:127.0.0.1:90</a>，可以看到与单独启动的<strong>SignallingWebServer</strong> 一样，但是不允许其他的客户端再加入到当前的会话中来，会提示<code>WARNING: No empty Cirrus servers are available</code>。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9455/matchmaker-warrning-no-empty-signallingwebserver.webp"></p>
<p>除非同时运行多套 <strong> 游戏 </strong>/<strong>WebRTCProxy</strong>/<strong>SignallingWebServer</strong>，使每个玩家独占一套不相互干扰，这也是<strong>MatchmakerServer</strong> 的作用所在。</p>
<h2 id="结语"><a href="# 结语" class="headerlink" title="结语"></a>结语</h2><p>Pixel Streaming 这种“云”游戏的思路很好，但是目前的硬件环境和带宽瓶颈还是很大的问题，在我测试体验的过程中，局域网连接比较流畅，在设定最高 60fps 的情况下可以跑到满帧，但是也是会出现偶尔掉帧的情况。</p>
<p>Google 也推出了云游戏平台<a href="https://stadia.dev/">Stadia</a>，但是离真的可以落地还很远，但是目前做一些行业应用还是可以的（比如雪佛兰的汽车展示<a href="https://visualizer-west.chevrolet.com/ui?carline=corvette&modelyear=2020&brand=chevrolet&language=en&country=US&channel=b2c&fbclid=IwAR2bCJCcZe7GjggAemV6ht4RhqoPZF3cLlf643KTJd_7W_FlzXl1kVCVSL0">2020 CORVETTE STINGRAY</a>）。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>PixelStreaming</category>
      </categories>
      <tags>
        <tag>PixelStreaming</tag>
      </tags>
  </entry>
  <entry>
    <title>upluginmanifest</title>
    <url>/wiki/16649/</url>
    <content><![CDATA[<p>项目打包时会根据项目启用的插件生成一个 <code>PROJECT_NAME.upluginmanifest</code> 文件，其中记录了每个启用的插件的 <code>uplugin</code> 的路径和内容信息，该文件也会打包到 pak 中。</p>
<p>Mount Point 为：<code>../../../PROJECT_NAME/Plugins/PROJECT_NAME.upluginmanifest</code></p>
<p>在 Editor 下运行时不会读取这个文件，通过扫描引擎和项目以及 <code>Mods</code> 目录下的 Plugin 目录来查找插件的，相关的逻辑在 <code>Runtime/Projects/Private/PluginManager.cpp</code> 的<code>ReadAllPlugins</code>函数中。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !WITH_EDITOR</span></span><br><span class="line">  <span class="keyword">if</span> (Project != <span class="literal">nullptr</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">FindPluginManifestsInDirectory</span>(*FPaths::<span class="built_in">ProjectPluginsDir</span>(), ManifestFileNames);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// !WITH_EDITOR</span></span></span><br></pre></td></tr></table></figure>
<p>在非 Editor 下通过加载 upluginmanifest 文件来确定当前工程中有哪些插件的（upluginmanifest 文件可以有多个，只要放在 <code>../../../PROJECT_NAME/Plugins</code> 目录下即可），如果一个插件在基础包中不存在，但是热更时新建了一个 Content Only 插件打包资源，需要把该插件添加至 upluginmanifest 中并且也需要把该插件的 uplugin 打包至 pak 中。</p>
<p>upluginmanifest 文件在 AutomationTool 中被创建，在 <code>CopyBuildToStagingDirectory.Automation.cs</code> 中有 <code>CreatePluginManifest</code> 函数。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Plugins</category>
      </categories>
      <tags>
        <tag>Plugins</tag>
        <tag>Manifest</tag>
      </tags>
  </entry>
  <entry>
    <title>Insight Profiling in lua</title>
    <url>/wiki/351387851/</url>
    <content><![CDATA[<p>想要是用 Unreal Insight Profile lua 端的调用，可以把 <code>SCOPED_NAMED_EVENT</code> 封装到 Lua 端，但是因为 Lua 没有 C++ 的 RAII 机制，无法实时地检测离开作用域时机，所以只能通过在起始和结尾位置添加标记：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">TimerMgr:UpdateTimer</span><span class="params">(DeltaTime)</span></span></span><br><span class="line">    <span class="keyword">local</span> profile_tag = UE4.FProfileTag(<span class="string">&quot;TimerMgr_UpdateTimer&quot;</span>)</span><br><span class="line">    <span class="comment">-- dosomething...</span></span><br><span class="line">    profile_tag:End()</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>在 C++ 端的实现：</p>
<figure class="highlight cpp"><figcaption><span>ProfileTag.h</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ProfileTag.generated.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">USTRUCT</span>()</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FProfileTag</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="built_in">GENERATED_BODY</span>()</span><br><span class="line">    <span class="built_in">FProfileTag</span>()&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Begin</span><span class="params">(<span class="keyword">const</span> FString&amp; Name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(bInit) <span class="keyword">return</span>;</span><br><span class="line">        <span class="built_in">StaticBegin</span>(Name);</span><br><span class="line">        bInit = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">End</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(bInit)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">StaticEnd</span>();</span><br><span class="line">            bInit = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ~<span class="built_in">FProfileTag</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">End</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">StaticBegin</span><span class="params">(<span class="keyword">const</span> FString&amp; Name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_IMPLEMENTS_BeginNamedEventStatic</span></span><br><span class="line">        FPlatformMisc::<span class="built_in">BeginNamedEventStatic</span>(FColor::Yellow, *Name);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        FPlatformMisc::<span class="built_in">BeginNamedEvent</span>(FColor::Yellow, *Name);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">StaticEnd</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        FPlatformMisc::<span class="built_in">EndNamedEvent</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">bool</span> bInit = <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>暴露给 Lua 端：</p>
<figure class="highlight cpp"><figcaption><span>Lualib_ProfileTag.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;UnLuaEx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;LuaCore.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ProfileTag.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">static</span> int32 <span class="title">FProfileTag_New</span><span class="params">(lua_State *L)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	int32 NumParams = <span class="built_in">lua_gettop</span>(L);</span><br><span class="line">	<span class="keyword">if</span> (NumParams &lt; <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">UE_LOG</span>(LogUnLua, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;%s: Invalid parameters!&quot;</span>), <span class="built_in">ANSI_TO_TCHAR</span>(__FUNCTION__));</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> *Userdata = <span class="built_in">NewTypedUserdata</span>(L, FProfileTag);</span><br><span class="line">	FProfileTag *V = <span class="built_in"><span class="keyword">new</span></span>(Userdata) <span class="built_in">FProfileTag</span>();</span><br><span class="line">	<span class="keyword">if</span> (NumParams &gt; <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		FString Name = <span class="built_in">ANSI_TO_TCHAR</span>((<span class="keyword">char</span>*)<span class="built_in">lua_tostring</span>(L,<span class="number">2</span>));</span><br><span class="line">		V-&gt;<span class="built_in">Begin</span>(Name);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> int32 <span class="title">FProfileTag_Begin</span><span class="params">(lua_State *L)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	int32 NumParams = <span class="built_in">lua_gettop</span>(L);</span><br><span class="line">	<span class="keyword">if</span> (NumParams &lt; <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">UE_LOG</span>(LogUnLua, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;%s: Invalid parameters!&quot;</span>), <span class="built_in">ANSI_TO_TCHAR</span>(__FUNCTION__));</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FProfileTag *V = (FProfileTag*)<span class="built_in">GetCppInstanceFast</span>(L, <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (!V)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">UE_LOG</span>(LogUnLua, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;%s: Invalid FProfileTag!&quot;</span>), <span class="built_in">ANSI_TO_TCHAR</span>(__FUNCTION__));</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	FString Name = <span class="built_in">ANSI_TO_TCHAR</span>((<span class="keyword">char</span>*)<span class="built_in">lua_tostring</span>(L,<span class="number">2</span>));</span><br><span class="line">	V-&gt;<span class="built_in">Begin</span>(Name);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> int32 <span class="title">FProfileTag_End</span><span class="params">(lua_State *L)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	int32 NumParams = <span class="built_in">lua_gettop</span>(L);</span><br><span class="line">	<span class="keyword">if</span> (NumParams &lt; <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">UE_LOG</span>(LogUnLua, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;%s: Invalid parameters!&quot;</span>), <span class="built_in">ANSI_TO_TCHAR</span>(__FUNCTION__));</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FProfileTag *V = (FProfileTag*)<span class="built_in">GetCppInstanceFast</span>(L, <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (!V)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">UE_LOG</span>(LogUnLua, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;%s: Invalid FProfileTag!&quot;</span>), <span class="built_in">ANSI_TO_TCHAR</span>(__FUNCTION__));</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	V-&gt;<span class="built_in">End</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> luaL_Reg FProfileTagLib[] =</span><br><span class="line">&#123;</span><br><span class="line">	&#123;<span class="string">&quot;__call&quot;</span>,FProfileTag_New&#125;,</span><br><span class="line">	&#123; <span class="string">&quot;Begin&quot;</span>, FProfileTag_Begin &#125;,</span><br><span class="line">	&#123; <span class="string">&quot;End&quot;</span>, FProfileTag_End &#125;,</span><br><span class="line">	&#123; <span class="literal">nullptr</span>, <span class="literal">nullptr</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">BEGIN_EXPORT_REFLECTED_CLASS</span>(FProfileTag)</span><br><span class="line">	<span class="built_in">ADD_STATIC_FUNCTION_EX</span>(<span class="string">&quot;StaticBegin&quot;</span>,<span class="keyword">void</span>,StaticBegin,<span class="keyword">const</span> FString&amp;)</span><br><span class="line">	<span class="built_in">ADD_STATIC_FUNCTION_EX</span>(<span class="string">&quot;StaticEnd&quot;</span>,<span class="keyword">void</span>,StaticEnd)</span><br><span class="line">	<span class="built_in">ADD_LIB</span>(FProfileTagLib)</span><br><span class="line"><span class="built_in">END_EXPORT_CLASS</span>()</span><br><span class="line"><span class="built_in">IMPLEMENT_EXPORTED_CLASS</span>(FProfileTag)</span><br></pre></td></tr></table></figure>
<p>然后即可在 Lua 中使用，并且能够在 Unreal Insight 中查看 Lua 端代码执行的消耗：<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210622110706.webp"></p>
<p>提供了三种使用方式：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- using 1</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">TimerMgr:UpdateTimer</span><span class="params">(DeltaTime)</span></span></span><br><span class="line">    <span class="keyword">local</span> profile_tag = UE4.FProfileTag(<span class="string">&quot;TimerMgr_UpdateTimer&quot;</span>)</span><br><span class="line">    <span class="comment">-- dosomething...</span></span><br><span class="line">    profile_tag:End()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- using 2</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">TimerMgr:UpdateTimer</span><span class="params">(DeltaTime)</span></span></span><br><span class="line">    <span class="keyword">local</span> profile_tag = UE4.FProfileTag()</span><br><span class="line">    profile_tag:Begin((<span class="string">&quot;TimerMgr_UpdateTimer&quot;</span>))</span><br><span class="line">    <span class="comment">-- dosomething...</span></span><br><span class="line">    profile_tag:End()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- using 3</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">TimerMgr:UpdateTimer</span><span class="params">(DeltaTime)</span></span></span><br><span class="line">    UE4.FProfileTag.StaticBegin((<span class="string">&quot;TimerMgr_UpdateTimer&quot;</span>))</span><br><span class="line">    <span class="comment">-- dosomething...</span></span><br><span class="line">    UE4.FProfileTag.StaticEnd()</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>建议使用创建对象的方式使用，因为创建的对象，如果漏掉 End，在 lua 对象被销毁时也会调用 End，不会造成 Insight 的数据采集问题，使用 <code>StaticBegin/StaticEnd</code> 则一定要保证所有的代码分支能执行到 <code>StaticEnd</code>。<br> 可以组合 lua 的 <code>debug.getinfo(1).name</code> 获取函数名字在 Insight 中显示：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">TimerMgr:UpdateTimer</span><span class="params">(DeltaTime)</span></span></span><br><span class="line">    <span class="keyword">local</span> profile_tag = UE4.FProfileTag(<span class="built_in">debug</span>.<span class="built_in">getinfo</span>(<span class="number">1</span>).name)</span><br><span class="line">    <span class="comment">-- dosomething...</span></span><br><span class="line">    profile_tag:End()</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Profiling</category>
      </categories>
      <tags>
        <tag>Profiling</tag>
        <tag>UnLua</tag>
        <tag>lua</tag>
        <tag>Unreal Insight</tag>
      </tags>
  </entry>
  <entry>
    <title>Profiling for UE</title>
    <url>/wiki/24066/</url>
    <content><![CDATA[<h2 id="Editor"><a href="#Editor" class="headerlink" title="Editor"></a>Editor</h2><p>在 <code>UE4Editor.exe</code> 启动项目时添加 <code>-Trace=CPU -tracehost=127.0.0.1</code> 参数：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">UE4Editor.exe Client.uproject -Trace=CPU -tracehost=127.0.0.1</span><br></pre></td></tr></table></figure>
<p>Insight 中就会自动捕获：<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210712170846.webp"></p>
<h2 id="Unreal-Insights 实时分析"><a href="#Unreal-Insights 实时分析" class="headerlink" title="Unreal Insights 实时分析"></a>Unreal Insights 实时分析</h2><ul>
<li><a href="https://medium.com/realities-io/oculus-quest-performance-tools-in-unreal-engine-2210f2581c8f">Oculus Quest Performance Tools in Unreal Engine</a> </li>
<li><a href="https://docs.unrealengine.com/en-US/TestingAndOptimization/PerformanceAndProfiling/UnrealInsights/Overview/index.html">Unreal Insights Overview</a> </li>
</ul>
<p>上一节提到了使用 <code>SessionFrontEnd</code> 实时分析 Android 的方法，在实际的测试当中发现不太稳定，会造成游戏的 Crash，UE 在新的引擎版本中也提供了新的性能分析工具 Unreal Insights，可以更方便和直观地进行 Profile。<br>文档：</p>
<ul>
<li><a href="https://docs.unrealengine.com/en-US/TestingAndOptimization/PerformanceAndProfiling/UnrealInsights/index.html">Unreal Insights</a></li>
<li><a href="https://docs.unrealengine.com/en-US/TestingAndOptimization/PerformanceAndProfiling/UnrealInsights/Reference/index.html">Unreal Insights Reference</a></li>
</ul>
<p>同样也需要端口映射，需要把 PC 的 1980 端口映射到设备上： </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">adb reverse tcp:1980 tcp:1980 </span><br></pre></td></tr></table></figure>
<p>然后需要给 Android 设备添加启动命令： </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">../../../FGame/FGame.uproject -Messaging -SessionOwner=&quot;lipengzha&quot; -SessionName=&quot;Launch On Android Device&quot; -iterative -tracehost=127.0.0.1 -Trace=CPU </span><br></pre></td></tr></table></figure>

<p>在 PC 上开启 Unreal Insights，在手机上启动游戏，即可实时捕获：  </p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210112171826.webp">  </p>
<p>Unreal Insights 也可以实时捕获 PIE 的数据，需要在 Editor 启动时添加 <code>-trace</code> 参数：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UE4Editor.exe PROJECT_NAME.uproject -trace=counters,cpu,frame,bookmark,gpu</span><br></pre></td></tr></table></figure>
<p>在启动游戏后在 Unreal Insights 里通过 <code>New Connection</code> 监听 127.0.0.1 即可。</p>
<h2 id="SessionFrontEnd 实时分析"><a href="#SessionFrontEnd 实时分析" class="headerlink" title="SessionFrontEnd 实时分析"></a>SessionFrontEnd 实时分析 </h2><p> 有几个条件：  </p>
<ol>
<li>需要 USB 连接 PC 和手机 </li>
<li>需要安装 adb  </li>
</ol>
<p>首先需要映射端口，因为 <code>SessionFrontEnd</code> 是通过监听端口的方式来与游戏内通信的，手机和 PC 并不在同一个网段，所以需要以 adb 的形式把 PC 的监听端口转发给手机的端口。 </p>
<p>SessionFrontEnd 的监听端口可以通过对 <code>UE4Editor.exe</code> 的端口分析获取：  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">C:\Users\lipengzha&gt;netstat -ano | findstr <span class="string">&quot;231096&quot;</span>  </span><br><span class="line">  TCP    0.0.0.0:1985           0.0.0.0:0              LISTENING       231096 </span><br><span class="line">  TCP    0.0.0.0:3961           0.0.0.0:0              LISTENING       231096 </span><br><span class="line">  TCP    0.0.0.0:3963           0.0.0.0:0              LISTENING       231096 </span><br><span class="line">  TCP    127.0.0.1:4014         127.0.0.1:12639        ESTABLISHED     231096 </span><br><span class="line">  TCP    127.0.0.1:4199         127.0.0.1:12639        ESTABLISHED     231096 </span><br><span class="line">  UDP    0.0.0.0:6666           *:*                                    231096 </span><br><span class="line">  UDP    0.0.0.0:24024          *:*                                    231096 </span><br><span class="line">  UDP    0.0.0.0:58101          *:*                                    231096 </span><br></pre></td></tr></table></figure>
<p>需要把 PC 的 1985 端口映射到 Android 的 1985 端口，这样手机上 APP 启动时，连接 <code>0.0.0.0</code> 的<code>1985</code>端口就可以连接到 PC 上的端口。 </p>
<p>通过 adb 命令来执行： </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb reverse tcp:1985 tcp:1985 </span><br></pre></td></tr></table></figure>
<p>然后需要给手机上 App 指定启动参数：  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">../../../FGame/FGame.uproject -Messaging -SessionOwner=<span class="string">&quot;lipengzha&quot;</span> -SessionName=<span class="string">&quot;Launch On Android Device&quot;</span>  </span><br></pre></td></tr></table></figure>
<p>把这些文本保存为 <code>UE4Commandline.txt</code> 文件，放到项目的数据目录下即可，具体路径为：  </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/sdcard/UE4Game/PROJECT_NAME/ </span><br></pre></td></tr></table></figure>
<p>之后直接启动 App，在 PC 上的 <code>SessionFrontEnd</code> 中就可以看到设备的数据了。 </p>
<p><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210521165056.webp"></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Profiling</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Profiling</tag>
        <tag>Unreal Insight</tag>
        <tag>UnrealFrontEnd</tag>
      </tags>
  </entry>
  <entry>
    <title>Profiling Commands</title>
    <url>/wiki/34049/</url>
    <content><![CDATA[<p><strong>显示 FPS</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">stat</span> FPS</span><br></pre></td></tr></table></figure>
<p><strong>显示统计单元</strong>(每帧的总时间，逻辑线程 / 渲染线程和 GPU 的时间消耗)：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">stat</span> Unit</span><br></pre></td></tr></table></figure>
<p><strong>显示渲染线程中的各种参数值</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Stat SceneRendering</span><br></pre></td></tr></table></figure>

<p><strong>显示渲染线程命令的消耗</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">stat</span> RenderThreadCommands</span><br></pre></td></tr></table></figure>

<p><strong>显示游戏线程上的参数</strong>(AI/ 物理 / 动画 / 蓝图 / 内存分配等)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">stat</span> game</span><br></pre></td></tr></table></figure>

<p><strong>显示剔除所需的时间和效率数据</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Stat InitViews</span><br></pre></td></tr></table></figure>

<p><strong>显示照明和着色所需的渲染时间</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Stat LightRendering</span><br></pre></td></tr></table></figure>

<p><strong>抓取当前帧的 GPU 信息</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ProfileGPU</span><br></pre></td></tr></table></figure>
<p>会弹出 <code>GPU Data Bisualizer</code> 的<code>GPU Visualizer</code>显示抓取帧的数据。</p>
<p><strong>抓取 Profiling 信息(CPU/GPU)</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">stat</span> StartFile</span><br><span class="line"><span class="built_in">stat</span> StopFile</span><br></pre></td></tr></table></figure>
<p>会在项目的 <code>Saved/Profiling/UnrealStats</code> 下产生 <code>*.ue4stats</code> 文件，可以使用 UnrealFornted 打开。</p>
<p><strong>UE 网络分析</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 打开和关闭录制</span></span><br><span class="line">netprofile</span><br><span class="line"><span class="comment"># 如果尚未录制则开始录制</span></span><br><span class="line">netprofile <span class="built_in">enable</span></span><br><span class="line"><span class="comment"># 如果当前正在录制，则停止录制</span></span><br><span class="line">netprofile <span class="built_in">disable</span></span><br></pre></td></tr></table></figure>
<p>捕获的数据保存在 <code>Saved/Profiling</code> 下，后缀名为 <code>*.nprof</code>。<br>UE 网络分析(Network Profiler) 工具的文档<a href="https://docs.unrealengine.com/en-us/Gameplay/Tools/NetworkProfiler">Network Profiler</a>.</p>
<p>链接：</p>
<ul>
<li><a href="https://docs.unrealengine.com/en-us/Engine/Performance">Performance and Profiling</a></li>
<li><a href="https://docs.unrealengine.com/en-us/Engine/Performance/GPU">GPU Profiling</a></li>
<li><a href="https://docs.unrealengine.com/en-us/Engine/Performance/StatCommands">Stat Commands</a></li>
<li><a href="https://software.intel.com/en-us/articles/vr-developer-tutorial-testing-and-profiling-the-premium-vr-game">VR Developer Tutorial: Testing and Profiling the Premium VR Game</a></li>
<li><a href="https://docs.unrealengine.com/en-us/Gameplay/Tools/NetworkProfiler">Network Profiler</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Profiling</category>
      </categories>
      <tags>
        <tag>Profiling</tag>
      </tags>
  </entry>
  <entry>
    <title>Zlib/Oodle/ZSTD 压缩算法性能对比</title>
    <url>/wiki/30732/</url>
    <content><![CDATA[<p>之前我写了一篇文章，在 UE 中集成了 ZSTD 压缩算法：<a href="https://imzlp.com/posts/8470/">ModularFeature：为 UE4 集成 ZSTD 压缩算法</a>，并且把 UE5 中的 Oodle 的压缩算法库提取出来，可以在 UE4 中使用：<a href="https://imzlp.com/notes/ue5/#Oodle-Compression">Oodle Compression</a>。最近分析了一下他们的压缩性能，分别测试了 WindowsNoEditor/Android_ASTC/IOS 三个平台。</p>
<p>打包和测试方法：</p>
<ol>
<li>打出默认的 zlib 基础包，不包含任何资源</li>
<li>基础包内包含 oodle/zstd 等代码，在启动时可指定压缩器和 compresslevel</li>
<li>使用 HotPatcher 打包 StarterContent，每次打包三个平台，打包时通过命令指定使用的压缩算法、压缩器、压缩级别</li>
<li>运行时使用 Perfdog 和 stat compression 查看数据</li>
</ol>
<p>使用不同的压缩算法打包 StarterContent 的大小（单位 MB）：<br>以下数据中，Oodle 默认使用 <code>Fast</code> 压缩级别，区别是 compressor 的不同。</p>
<table>
<thead>
<tr>
<th align="center">-</th>
<th align="center">ZLIB</th>
<th align="center">OODLE(Kraken)</th>
<th align="center">OODLE(Leviathan)</th>
<th align="center">Oodle(Hydra)</th>
<th align="center">ZSTD(Level22)</th>
</tr>
</thead>
<tbody><tr>
<td align="center">WindowsNoEditor</td>
<td align="center">295.93</td>
<td align="center">284</td>
<td align="center">273.18</td>
<td align="center">278.40</td>
<td align="center">286</td>
</tr>
<tr>
<td align="center">Android_ASTC</td>
<td align="center">177</td>
<td align="center">170</td>
<td align="center">165</td>
<td align="center">167</td>
<td align="center">171</td>
</tr>
<tr>
<td align="center">IOS</td>
<td align="center">174</td>
<td align="center">162</td>
<td align="center">155</td>
<td align="center">158</td>
<td align="center">163</td>
</tr>
</tbody></table>
<p>在 Oodle 的 <code>Fast</code> 模式下，打包 StarterContent 为 <code>Android_ASTC</code>/<code>IOS</code>/<code>WindowsNoEditor</code> 三个平台，只是打包 Pak 的耗时，总共约 35 秒。</p>
<p>在压缩级别开到最高的<code>Optimal5</code>，压缩速度明显降低，但压缩率明显提升，三个平台约<code>+00:06:55.764</code>，大约七分钟。</p>
<table>
<thead>
<tr>
<th align="center">-</th>
<th align="center">Leviathan(Fast)</th>
<th align="center">Leviathan(Optimal5)</th>
<th align="center">Leviathan(Optimal2)</th>
<th align="center">ZSTD Level 22</th>
</tr>
</thead>
<tbody><tr>
<td align="center">WindowsNoEditor</td>
<td align="center">273.18  (13.54s)</td>
<td align="center">263 (180.63s)</td>
<td align="center">266 (41.69s)</td>
<td align="center">286(31.24s)</td>
</tr>
<tr>
<td align="center">Android_ASTC</td>
<td align="center">165    (8.39s.)</td>
<td align="center">152  (95.59s)</td>
<td align="center">157 (23.19s)</td>
<td align="center">171(19.86s)</td>
</tr>
<tr>
<td align="center">IOS</td>
<td align="center">155     (10.38s)</td>
<td align="center">147   (138.13s)</td>
<td align="center">150 (34.96s)</td>
<td align="center">163(20.43s)</td>
</tr>
</tbody></table>
<p>Kraken 使用不同压缩级别的对比（文末有运行时对比数据）：</p>
<table>
<thead>
<tr>
<th align="center">-</th>
<th align="center">Kraken(Fast)</th>
<th align="center">Kraken(Optimal5)</th>
<th align="center">Kraken(Optimal2)</th>
</tr>
</thead>
<tbody><tr>
<td align="center">WindowsNoEditor</td>
<td align="center">283  (5.83s)</td>
<td align="center">273 (82.24)</td>
<td align="center">276 (41.69s)</td>
</tr>
<tr>
<td align="center">Android_ASTC</td>
<td align="center">170    (3.52s.)</td>
<td align="center">161  (49.88s)</td>
<td align="center">166 (23.19s)</td>
</tr>
<tr>
<td align="center">IOS</td>
<td align="center">161     (4.01s)</td>
<td align="center">152   (57.34s)</td>
<td align="center">155 (34.96s)</td>
</tr>
</tbody></table>
<p>使用 stat 组合 PerfDog 分析各种压缩算法的效率，测试方法，加载不同压缩算法打包的 Pak，进入相同的地图（<code>/Game/StarterContent/Maps/StarterMap</code>），开启<code>stat compression</code>, 游览整个场景三分钟后的性能数据（移动端会开启 PerfDog 分析，会有一定的性能影响，但移动端所有的测试均使用相同的操作和流程，数据对比准确性还是 OK 的）。</p>
<h3 id="WindowsNoEditor"><a href="#WindowsNoEditor" class="headerlink" title="WindowsNoEditor"></a>WindowsNoEditor</h3><ol>
<li>zlib<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210706145640.webp"></li>
<li>oodle(Kraken+fast)<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210706145710.webp"></li>
<li>oodle(Hydra+fast)<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210706145734.webp"></li>
<li>oodle(Leviathan+fast)<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210706145757.webp"></li>
<li>zstd(level22)<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210706145810.webp"></li>
</ol>
<h3 id="Android-ASTC"><a href="#Android-ASTC" class="headerlink" title="Android_ASTC"></a>Android_ASTC</h3><ol>
<li><p>zlib<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210706155907.webp"><br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210706170919.jpg"></p>
</li>
<li><p>oodle(Kraken+fast)<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210706160903.webp"><br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210706162028.webp"><br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210706163848.jpg"><br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210706171339.jpg"></p>
</li>
<li><p>oodle(Hydra+fast)<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210706165138.jpg"></p>
</li>
<li><p>oodle(Leviathan+fast)<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210706165848.jpg"></p>
</li>
<li><p>zstd(level22)<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210706170408.jpg"></p>
</li>
</ol>
<h3 id="IOS"><a href="#IOS" class="headerlink" title="IOS"></a>IOS</h3><ol>
<li><p>zlib<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210706193150.webp"><br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210706193235.webp"></p>
</li>
<li><p>oodle(Kraken+fast)<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210706193720.webp"><br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210706193833.webp"></p>
</li>
<li><p>oodle(Hydra+fast)<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210706194525.webp"><br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210706194616.webp"></p>
</li>
<li><p>oodle(Leviathan+fast)<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210706195016.webp"><br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210706195116.webp"></p>
</li>
<li><p>zstd(level22)<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210706195511.webp"><br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210706195651.webp"></p>
</li>
</ol>
<h3 id="Kraken 不同压缩级别对比"><a href="#Kraken 不同压缩级别对比" class="headerlink" title="Kraken 不同压缩级别对比"></a>Kraken 不同压缩级别对比 </h3><p> 测试包与 perfdog 环境与上文相同。</p>
<h4 id="WindowsNoEditor-1"><a href="#WindowsNoEditor-1" class="headerlink" title="WindowsNoEditor"></a>WindowsNoEditor</h4><ol>
<li><p>Fast<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210707170131.webp"></p>
</li>
<li><p>Optimal2<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210707165332.webp"></p>
</li>
<li><p>Optimal5<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210707165751.webp"></p>
</li>
</ol>
<h4 id="Android-ASTC-1"><a href="#Android-ASTC-1" class="headerlink" title="Android_ASTC"></a>Android_ASTC</h4><ol>
<li><p>Fast<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210707163633.webp"><br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210707163728.jpg"></p>
</li>
<li><p>Optimal2<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210707160226.webp"><br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210707160426.jpg"></p>
</li>
<li><p>Optimal5<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210707160947.webp"><br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210707161026.jpg"></p>
</li>
</ol>
<h4 id="IOS-1"><a href="#IOS-1" class="headerlink" title="IOS"></a>IOS</h4><ol>
<li><p>Fast<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210706193720.webp"><br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210706193833.webp"></p>
</li>
<li><p>Optimal2<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210707162017.webp"><br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210707162106.webp"></p>
</li>
<li><p>Optimal5<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210707162710.webp"><br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210707162746.webp"></p>
</li>
</ol>
<h3 id="总结"><a href="# 总结" class="headerlink" title="总结"></a>总结 </h3><p> 压缩率和解压性能，是一个相互取舍的因素，从对比数据来看，不管是 Oodle/ZSTD，都在保持压缩率的同时，解压效率都远超 Zlib。<br>从对比数据看，ZSTD 的 22 级别性能与 Oodle 的 Leviathan 相近，Kraken 则在解压速度上更胜一筹，所以在游戏中使用 Kraken+fast 是比较合理的方案。<br>虽然选用其他的 <code>CompressLevel</code> 如<code>Optimal2</code>/<code>Optimal5</code>，但是会增加数倍的压缩时间，在项目资源量巨大的情况下，有些得不偿失。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Profiling</category>
      </categories>
      <tags>
        <tag>压缩算法</tag>
      </tags>
  </entry>
  <entry>
    <title>网络质量测试</title>
    <url>/wiki/12589/</url>
    <content><![CDATA[<p>可以使用几个命令参数模拟比较差的网络环境，从而测试 UE 联机的网络质量和 bug 检测。</p>
<table>
<thead>
<tr>
<th>Setting</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><strong>PktLag</strong></td>
<td>Delays the sending of a packet by the amount of time specified in milliseconds</td>
</tr>
<tr>
<td><strong>PktLagVariance</strong></td>
<td>Provides some randomness to the amount of time a packet is delayed, +/- the amount specified in milliseconds</td>
</tr>
<tr>
<td><strong>PktLoss</strong></td>
<td>Specifies a percentage chance of an outbound packet being discarded to simulate packet loss</td>
</tr>
<tr>
<td><strong>PktDup</strong></td>
<td>Specifies a percentage chance to send a duplicate packet</td>
</tr>
<tr>
<td><strong>PktOrder</strong></td>
<td>Sends packets out of order when enabled (1 = enabled, 0 = disabled)</td>
</tr>
</tbody></table>
<p>可以通过三种不同的方式来控制：命令行参数、控制台命令以及引擎 ini 配置。</p>
<p>在命令行启动：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SettingName=Value</span><br></pre></td></tr></table></figure>

<p>在控制台设置：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Net SettingName=Value</span><br></pre></td></tr></table></figure>

<p>以及在引擎配置 (<code>DefaultEngine.ini</code>) 中：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[PacketSimulationSettings]</span></span><br><span class="line"><span class="attr">PktLag</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">PktLagVariance</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">PktLoss</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">PktOrder</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">PktDup</span>=<span class="number">0</span></span><br></pre></td></tr></table></figure>

<ul>
<li><a href="https://www.unrealengine.com/en-US/blog/finding-network-based-exploits?sessionInvalidated=true">Finding Network-based Exploits</a></li>
<li><a href="https://docs.unrealengine.com/en-US/Gameplay/Tools/NetworkProfiler/index.html">Network Profiler</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Profiling</category>
      </categories>
      <tags>
        <tag>DS</tag>
        <tag>Network</tag>
        <tag>Profiling</tag>
      </tags>
  </entry>
  <entry>
    <title>资源调试命令</title>
    <url>/wiki/11937/</url>
    <content><![CDATA[<p>可以在 Console 中使用以下命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">obj list</span><br></pre></td></tr></table></figure>
<p>会列出当前的资源加载信息：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">                          Class    Count      NumKB      MaxKB   ResExcKB  ResExcDedSysKB  ResExcShrSysKB  ResExcDedVidKB  ResExcShrVidKB     ResExcUnkKB</span><br><span class="line">                          Class     4331   10240.85   12969.37       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                       FontFace        9    9498.02    9498.02    9495.54         9495.54            0.00            0.00            0.00            0.00</span><br><span class="line">                       MetaData      732    8441.93    8441.93       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                   ScriptStruct     2165    3923.20    5156.56       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                   SkeletalMesh        1    3988.86    3989.04    1974.06           30.55            0.00            0.00            0.00         1943.52</span><br><span class="line">                       Function     7928    2012.63    2457.73       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                        Package      732    1316.65    1453.87       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                           Enum     1275     312.38     760.76       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                  DeviceProfile       85     409.36     661.37       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                       Material      103     418.41     467.83    4722.42         4722.42            0.00            0.00            0.00            0.00</span><br><span class="line">                       ToolMenu       36     193.83     466.16       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">               DelegateFunction      652     165.51     185.93       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                      Texture2D      146     111.05     111.05   56192.00            0.00            0.00        56192.00            0.00            0.00</span><br><span class="line">     MaterialExpressionMultiply      194      66.84      98.67       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                     StaticMesh       29      77.02      98.41    2055.31           23.56            0.00            0.00            0.00         2031.75</span><br><span class="line">MaterialExpressionTextureSample       61      44.87      79.66       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">       MaterialExpressionCustom       68      59.53      70.68       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">        MaterialInstanceDynamic       32      53.74      65.76      16.45           16.45            0.00            0.00            0.00            0.00</span><br><span class="line">                 GameNetworkMgr        1      64.43      64.43       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                      BodySetup       41      42.91      62.30    1158.44         1158.44            0.00            0.00            0.00            0.00</span><br><span class="line">     MaterialExpressionConstant      153      36.16      61.26       0.00            0.00            0.00            0.00            0.00            0.00</span><br></pre></td></tr></table></figure>

<p>还有下列相关的命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Mem FromReport</span><br><span class="line">obj list -alphasort</span><br><span class="line">rhi.DumpMemory</span><br><span class="line">LogOutStatLevels</span><br><span class="line">ListSpawnedActors</span><br><span class="line">DumpParticleMem</span><br><span class="line">ConfigMem</span><br><span class="line">r.DumpRenderTargetPoolMemory</span><br><span class="line">ListTextures -alphasort</span><br><span class="line">ListSounds -alphasort</span><br><span class="line">ListParticleSystems -alphasort</span><br><span class="line">obj list class=SoundWave -alphasort</span><br><span class="line">obj list class=SkeletalMesh -alphasort</span><br><span class="line">obj list class=StaticMesh -alphasort</span><br><span class="line">obj list class=Level -alphasort</span><br></pre></td></tr></table></figure>
<p>也可以使用 <code>memreport</code> 来进行详细的分析：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">memreport -full</span><br></pre></td></tr></table></figure>
<p>会在 <code>Saved/Profiling/MemReports</code> 下创建 <code>.memreport</code> 文件。</p>
<ul>
<li><a href="https://www.unrealengine.com/en-US/blog/debugging-and-optimizing-memory">Debugging and Optimizing Memory</a></li>
<li><a href="https://pzurita.wordpress.com/2015/02/10/limitations-of-memory-tracking-features-in-unreal-engine-4/">Limitations of memory tracking features in Unreal Engine 4</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Profiling</category>
      </categories>
      <tags>
        <tag>Profiling</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 集成 Protobuf</title>
    <url>/wiki/37488/</url>
    <content><![CDATA[<p>我之前的文章 <a href="https://imzlp.com/posts/9903/">Build protobuf with MSVC on Windows</a> 中介绍了在 Windows 上使用 MSVC 编译 Protobuf，最近的项目中有用到 Protobuf，就把 Protobuf 集成 UE4 做了一个插件，无需在系统和项目设置中添加任何环境变量以及文件包含，也不需要考虑 <code>protobuf</code> 的<code>lib</code>的链接，方便在项目中使用，并且对 UE 不兼容 cc 格式写了编辑器插件，<code>.pb.cc</code>都会被转换为<code>pb.cpp</code>。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/protobuf-protoc-toolbar.webp"></p>
<p>代码我放在了 github 上：<a href="https://github.com/hxhb/ue4-protobuf">hxhb/ue4-protobuf</a></p>
<p>下面是简单的使用介绍：</p>
<h3 id="What-is-this"><a href="#What-is-this" class="headerlink" title="What is this?"></a>What is this?</h3><p>This is an Unreal Engine 4 plugin that integrates <a href="https://github.com/protocolbuffers/protobuf">Protobuf</a> into the project without requiring you to add system PATH or anything else.</p>
<h3 id="How-do-use"><a href="#How-do-use" class="headerlink" title="How do use?"></a>How do use?</h3><ol>
<li>add the plugin to the project and enable it.</li>
<li>add the following property to <code>build.cs</code> of the project :</li>
</ol>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">PublicDependencyModuleNames.Add(<span class="string">&quot;Protobuf&quot;</span>);</span><br><span class="line">bEnableUndefinedIdentifierWarnings = <span class="literal">false</span>;</span><br><span class="line">bUseRTTI = <span class="literal">true</span>;</span><br><span class="line">bEnableExceptions = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Create <code>.proto</code> file into project source code folder </li>
<li>Launch the Project in Editor, Click the <code>Protoc</code> button.</li>
</ol>
<h3 id="Protobuf-Version"><a href="#Protobuf-Version" class="headerlink" title="Protobuf Version"></a>Protobuf Version</h3><ul>
<li>Protobuf v3.9.1 build with MSVC 15 64bit (Visual Studio 2017).</li>
</ul>
<h3 id="protoc 处理目录中的 -proto 文件"><a href="#protoc 处理目录中的 -proto 文件" class="headerlink" title="protoc 处理目录中的.proto 文件"></a>protoc 处理目录中的.proto 文件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ protoc --proto_path=PROTO_FILE_PATH PROTO_FILE --cpp_out=OUT_FILE_PATH PROTO_FILE_PATH\*.proto</span><br></pre></td></tr></table></figure>
<p>如：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ protoc --proto_path=<span class="string">&quot;d:\protoc&quot;</span> MyName.proto --cpp_out=<span class="string">&quot;d:\&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Was-only-expecting-C-files-to-have-CachedCPPEnvironments"><a href="#Was-only-expecting-C-files-to-have-CachedCPPEnvironments" class="headerlink" title="Was only expecting C++ files to have CachedCPPEnvironments!"></a>Was only expecting C++ files to have CachedCPPEnvironments!</h3><p>写了个插件在 UE 中使用 protobuf，在从 <code>proto</code> 文件生成 <code>.cc</code>/<code>.h</code> 之后编译报这个错误，分析了一下是 UBT 的代码文件类型不支持<code>.cc</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1&gt;------ Build started: Project: GWorld, Configuration: Development x64 ------</span><br><span class="line">1&gt;Using &#x27;git status&#x27; to determine working set for adaptive non-unity build (C:\Users\imzlp\Documents\Unreal Projects\GWorld).</span><br><span class="line">1&gt;UnrealBuildTool : error : Was only expecting C++ files to have CachedCPPEnvironments!</span><br><span class="line">1&gt;(see ../Programs/UnrealBuildTool/Log.txt for full exception trace)</span><br></pre></td></tr></table></figure>

<p>在引擎中搜索代码，发现这个错误是在 <code>UnrealBuildTools\System\ActionGraph.cs</code> 中<code>IsActionOutdated</code>里的：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">IsActionOutdated</span>(<span class="params">BuildConfiguration BuildConfiguration, UEBuildTarget Target, CPPHeaders Headers, Action RootAction, <span class="built_in">bool</span> bIsAssemblingBuild, <span class="built_in">bool</span> bNeedsFullCPPIncludeRescan, Dictionary&lt;Action, <span class="built_in">bool</span>&gt; OutdatedActionDictionary, ActionHistory ActionHistory, Dictionary&lt;UEBuildTarget, List&lt;FileItem&gt;&gt; TargetToOutdatedPrerequisitesMap</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">	<span class="comment">// @todo ubtmake: we may be scanning more files than we need to here -- indirectly outdated files are bIsOutdated=true by this point (for example basemost includes when deeper includes are dirty)</span></span><br><span class="line">	<span class="keyword">if</span> (bIsOutdated &amp;&amp; RootAction.ActionType == ActionType.Compile)<span class="comment">// @todo ubtmake: Does this work with RC files?  See above too.</span></span><br><span class="line">	&#123;</span><br><span class="line">	  Log.TraceVerbose(<span class="string">&quot;Outdated action: &#123;0&#125;&quot;</span>, RootAction.StatusDescription);</span><br><span class="line">	  <span class="keyword">foreach</span> (FileItem PrerequisiteItem <span class="keyword">in</span> RootAction.PrerequisiteItems)</span><br><span class="line">	  &#123;</span><br><span class="line">	    <span class="keyword">if</span> (PrerequisiteItem.CachedIncludePaths != <span class="literal">null</span>)</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="keyword">if</span> (!IsCPPFile(PrerequisiteItem))</span><br><span class="line">	      &#123;</span><br><span class="line">	        <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">&quot;Was only expecting C++ files to have CachedCPPEnvironments!&quot;</span>);</span><br><span class="line">	      &#125;</span><br><span class="line">	      Log.TraceVerbose(<span class="string">&quot;  -&gt; DEEP include scan: &#123;0&#125;&quot;</span>, PrerequisiteItem.AbsolutePath);</span><br><span class="line"></span><br><span class="line">	      List&lt;FileItem&gt; OutdatedPrerequisites;</span><br><span class="line">	      <span class="keyword">if</span> (!TargetToOutdatedPrerequisitesMap.TryGetValue(Target, <span class="keyword">out</span> OutdatedPrerequisites))</span><br><span class="line">	      &#123;</span><br><span class="line">	        OutdatedPrerequisites = <span class="keyword">new</span> List&lt;FileItem&gt;();</span><br><span class="line">	        TargetToOutdatedPrerequisitesMap.Add(Target, OutdatedPrerequisites);</span><br><span class="line">	      &#125;</span><br><span class="line"></span><br><span class="line">	      OutdatedPrerequisites.Add(PrerequisiteItem);</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">else</span> <span class="keyword">if</span> (IsCPPImplementationFile(PrerequisiteItem) || IsCPPResourceFile(PrerequisiteItem))</span><br><span class="line">	    &#123;</span><br><span class="line">	      Log.TraceVerbose(<span class="string">&quot;  -&gt; WARNING: No CachedCPPEnvironment: &#123;0&#125;&quot;</span>, PrerequisiteItem.AbsolutePath);</span><br><span class="line">	    &#125;</span><br><span class="line">	  &#125;</span><br><span class="line">	&#125;    </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重点就是 <code>IsCPPFile</code> 这个函数，报这个错误是因为 UBT 检测到了项目中不能识别的文件。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/// &lt;summary&gt;</span></span><br><span class="line"><span class="comment">/// Checks if the specified file is a C++ source file</span></span><br><span class="line"><span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line"><span class="comment">/// &lt;param name=&quot;FileItem&quot;&gt;The file to check&lt;/param&gt;</span></span><br><span class="line"><span class="comment">/// &lt;returns&gt;True if this is a C++ source file&lt;/returns&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsCPPFile</span><span class="params">(FileItem FileItem)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">IsCPPImplementationFile</span>(FileItem) || <span class="built_in">IsCPPIncludeFile</span>(FileItem) || <span class="built_in">IsCPPResourceFile</span>(FileItem);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// &lt;summary&gt;</span></span><br><span class="line"><span class="comment">/// Checks if the specified file is a C++ source implementation file (e.g., .cpp)</span></span><br><span class="line"><span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line"><span class="comment">/// &lt;param name=&quot;FileItem&quot;&gt;The file to check&lt;/param&gt;</span></span><br><span class="line"><span class="comment">/// &lt;returns&gt;True if this is a C++ source file&lt;/returns&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsCPPImplementationFile</span><span class="params">(FileItem FileItem)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (FileItem.AbsolutePath.<span class="built_in">EndsWith</span>(<span class="string">&quot;.cpp&quot;</span>, StringComparison.InvariantCultureIgnoreCase) ||</span><br><span class="line">			FileItem.AbsolutePath.<span class="built_in">EndsWith</span>(<span class="string">&quot;.c&quot;</span>, StringComparison.InvariantCultureIgnoreCase) ||</span><br><span class="line">			FileItem.AbsolutePath.<span class="built_in">EndsWith</span>(<span class="string">&quot;.mm&quot;</span>, StringComparison.InvariantCultureIgnoreCase));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// &lt;summary&gt;</span></span><br><span class="line"><span class="comment">/// Checks if the specified file is a C++ source header file (e.g., .h or .inl)</span></span><br><span class="line"><span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line"><span class="comment">/// &lt;param name=&quot;FileItem&quot;&gt;The file to check&lt;/param&gt;</span></span><br><span class="line"><span class="comment">/// &lt;returns&gt;True if this is a C++ source file&lt;/returns&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsCPPIncludeFile</span><span class="params">(FileItem FileItem)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (FileItem.AbsolutePath.<span class="built_in">EndsWith</span>(<span class="string">&quot;.h&quot;</span>, StringComparison.InvariantCultureIgnoreCase) ||</span><br><span class="line">	FileItem.AbsolutePath.<span class="built_in">EndsWith</span>(<span class="string">&quot;.hpp&quot;</span>, StringComparison.InvariantCultureIgnoreCase) ||</span><br><span class="line">	FileItem.AbsolutePath.<span class="built_in">EndsWith</span>(<span class="string">&quot;.inl&quot;</span>, StringComparison.InvariantCultureIgnoreCase));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// &lt;summary&gt;</span></span><br><span class="line"><span class="comment">/// Checks if the specified file is a C++ resource file (e.g., .rc)</span></span><br><span class="line"><span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line"><span class="comment">/// &lt;param name=&quot;FileItem&quot;&gt;The file to check&lt;/param&gt;</span></span><br><span class="line"><span class="comment">/// &lt;returns&gt;True if this is a C++ source file&lt;/returns&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsCPPResourceFile</span><span class="params">(FileItem FileItem)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (FileItem.AbsolutePath.<span class="built_in">EndsWith</span>(<span class="string">&quot;.rc&quot;</span>, StringComparison.InvariantCultureIgnoreCase));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，UBT 只认下列几种文件：</p>
<ul>
<li><strong>IsCPPImplementationFile</strong>：<code>.cpp</code>/<code>.c</code>/<code>.m</code></li>
<li><strong>IsCPPIncludeFile</strong>：<code>.h</code>/<code>.hpp</code>/<code>.inl</code></li>
<li><strong>IsCPPResourceFile</strong>：<code>.rc</code></li>
</ul>
<p>因为 Protobuf 产生的是 <code>.cc</code> 文件，所以就会报开头的错误。</p>
<p>既然问题找到了。那么解决办法有两个：</p>
<ol>
<li>改 UBT 的代码，让其支持<code>.cc</code></li>
<li>改 protobuf 产生的 <code>.cc</code> 为<code>.cpp</code></li>
</ol>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>ThirdParty</category>
      </categories>
      <tags>
        <tag>Protobuf</tag>
      </tags>
  </entry>
  <entry>
    <title>添加外部库的注意事项</title>
    <url>/wiki/39738/</url>
    <content><![CDATA[<p>在添加外部的代码库时，需要关注以下几个问题：</p>
<ol>
<li>纯代码的库，要测试是否具有平台相关的写法，需要同时支持 Win/Android/IOS/Mac 四个平台</li>
<li>对于 Android 的 so 要同时支持 arm64/armv7，打包时 so 文件的拷贝需要使用 UPL 执行</li>
<li>ios 的 <code>.a</code> 要同时具有 <code>bitcode</code> 和非 <code>bitcode</code> 版本，不然在 shipping 时如果开启了 bitcode，链接不支持 bitcode 的库会有链接错误的问题。</li>
</ol>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201117095535.webp"></p>
<p>检测当前构建是否支持 bitcode 的流程：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (Target.IOSPlatform.bShipForBitcode)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// add support bitcode lib</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// add not-support bitcode lib</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>Target.cs</code> 中可以直接通过 <code>IOSPlatform</code> 获取当前构建是否支持 bitcode，在其他的 Module 中，可以通过 <code>target.cs</code> 中的 <code>Target.IOSPlatform</code> 获取。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>ThirdParty</category>
      </categories>
      <tags>
        <tag>ThirdParty</tag>
      </tags>
  </entry>
  <entry>
    <title>集成第三方压缩算法</title>
    <url>/wiki/10054/</url>
    <content><![CDATA[<p>使用 ModularFeature 集成第三方压缩算法，以 ZSTD 为例。</p>
<p>在 UE 中如果想要自己添加一个压缩算法的实现则需要自己实现一个继承自 <code>ICompressionFormat</code> 的类，然后注册给<code>IModulelarFeatures</code>，那么以 ZSTD 为例，来示范一下怎么真实地添加一个压缩算法。</p>
<p>首先还是要来介绍一下 <code>ICompressionFormat</code> 中提供的四个接口函数的语义要求：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ICompressionFormat</span> :</span> <span class="keyword">public</span> IModularFeature, <span class="keyword">public</span> IModuleInterface</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 获取当前实现的压缩算法的名字</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> FName <span class="title">GetCompressionFormatName</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// 执行压缩</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Compress</span><span class="params">(<span class="keyword">void</span>* CompressedBuffer, int32&amp; CompressedSize, <span class="keyword">const</span> <span class="keyword">void</span>* UncompressedBuffer, int32 UncompressedSize, int32 CompressionData)</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// 执行解压</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Uncompress</span><span class="params">(<span class="keyword">void</span>* UncompressedBuffer, int32&amp; UncompressedSize, <span class="keyword">const</span> <span class="keyword">void</span>* CompressedBuffer, int32 CompressedSize, int32 CompressionData)</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// 获取压缩算法可以执行压缩的数据大小</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> int32 <span class="title">GetCompressedBufferSize</span><span class="params">(int32 UncompressedSize, int32 CompressionData)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>然后开干，集成 ZSTD 首先需要去 <a href="https://github.com/facebook/zstd/">facebook/zstd</a> 上把代码拉取下来，然后把代码提取出来（Lib 目录下除了 <code>dll</code> 目录外都可以拷贝过来），放到插件的 <code>Souce/ThirdParty</code> 下，并在插件的 <code>*.build.cs</code> 中将其添加至 <code>PublicIncludePaths</code> 中。</p>
<p>首先先要对 <code>ZSTD</code> 的代码进行修改，因为 UE 的编译环境和警告等级的关系是没办法把代码拷过来就可以直接编译过的，常见的操作为忽略某些警告，但是 <code>ZSTD</code> 有一点特别的地方在于它里面具有 <code>XXHash</code> 的代码在编译时会与 <code>LiveCoding</code> 中的有冲突会有重定义错误，所以需要对 <code>ZSTD</code> 代码中的 <code>XXHash</code> 进行改名。</p>
<p>当把 ZSTD 的代码在 UE 中能够顺利的编译过的时候可以进入下一个流程，创建并实现 <code>ZSTD</code> 的<code>ICompressionFormat</code>实现。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FZstdCompressionFormat</span> :</span> <span class="keyword">public</span> ICompressionFormat</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> FName <span class="title">GetCompressionFormatName</span><span class="params">()</span><span class="keyword">override</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Compress</span><span class="params">(<span class="keyword">void</span>* CompressedBuffer, int32&amp; CompressedSize, <span class="keyword">const</span> <span class="keyword">void</span>* UncompressedBuffer, int32 UncompressedSize, int32 CompressionData)</span><span class="keyword">override</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Uncompress</span><span class="params">(<span class="keyword">void</span>* UncompressedBuffer, int32&amp; UncompressedSize, <span class="keyword">const</span> <span class="keyword">void</span>* CompressedBuffer, int32 CompressedSize, int32 CompressionData)</span><span class="keyword">override</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> int32 <span class="title">GetCompressedBufferSize</span><span class="params">(int32 UncompressedSize, int32 CompressionData)</span><span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> int32 Level;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>只是继承了 <code>ICompressionFormat</code> 然后添加了一个 <code>Level</code> 的 static 数据成员，用于记录在 ZSTD 中使用哪个压缩级别。</p>
<p>剩下的事情就是从 ZSTD 的代码里找到能够实现 <code>ICompressionFormat</code> 接口语义的函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">ZSTDLIB_API <span class="keyword">size_t</span> <span class="title">ZSTD_compress</span><span class="params">(<span class="keyword">void</span>* dst, <span class="keyword">size_t</span> dstCapacity,<span class="keyword">const</span> <span class="keyword">void</span>* src, <span class="keyword">size_t</span> srcSize,<span class="keyword">int</span> compressionLevel)</span></span>;</span><br><span class="line"><span class="function">ZSTDLIB_API <span class="keyword">size_t</span> <span class="title">ZSTD_decompress</span><span class="params">(<span class="keyword">void</span>* dst, <span class="keyword">size_t</span> dstCapacity,<span class="keyword">const</span> <span class="keyword">void</span>* src, <span class="keyword">size_t</span> compressedSize)</span></span>;</span><br><span class="line"><span class="function">ZSTDLIB_API <span class="keyword">size_t</span>      <span class="title">ZSTD_compressBound</span><span class="params">(<span class="keyword">size_t</span> srcSize)</span></span>; <span class="comment">/*!&lt; maximum compressed size in worst case single-pass scenario */</span></span><br></pre></td></tr></table></figure>

<p>通过查看 ZSTD 的代码可以发现这三个函数组合起来就可以实现 <code>ICompressionFormat</code> 中的所有功能，比较简单，都是转发调用：<br>PS: 通过实现 <code>GetCompressionFormatName</code> 来指定该压缩 Feature 的名字，我这里给了<code>zstd</code>，在项目设置里指定的时候就要使用这个名字。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">FName <span class="title">FZstdCompressionFormat::GetCompressionFormatName</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">TEXT</span>(<span class="string">&quot;zstd&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FZstdCompressionFormat::Compress</span><span class="params">(<span class="keyword">void</span>* CompressedBuffer, int32&amp; CompressedSize, <span class="keyword">const</span> <span class="keyword">void</span>* UncompressedBuffer, int32 UncompressedSize, int32 CompressionData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">UE_LOG</span>(LogTemp, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;FZstdCompressionFormat::Compress level is %d&quot;</span>), FZstdCompressionFormat::Level);</span><br><span class="line">  int32 Result = <span class="built_in">ZSTD_compress</span>(CompressedBuffer, CompressedSize, UncompressedBuffer, UncompressedSize, FZstdCompressionFormat::Level);</span><br><span class="line">  <span class="keyword">if</span> (Result &gt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (Result &gt; <span class="built_in">GetCompressedBufferSize</span>(UncompressedSize, CompressionData))</span><br><span class="line">    &#123;</span><br><span class="line">      FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%d &lt; %d&quot;</span>), Result, <span class="built_in">GetCompressedBufferSize</span>(UncompressedSize, CompressionData));</span><br><span class="line">      <span class="comment">// we cannot safely go over the BufferSize needed!</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    CompressedSize = Result;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FZstdCompressionFormat::Uncompress</span><span class="params">(<span class="keyword">void</span>* UncompressedBuffer, int32&amp; UncompressedSize, <span class="keyword">const</span> <span class="keyword">void</span>* CompressedBuffer, int32 CompressedSize, int32 CompressionData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  int32 Result = <span class="built_in">ZSTD_decompress</span>(UncompressedBuffer, UncompressedSize, CompressedBuffer, CompressedSize);</span><br><span class="line">  <span class="keyword">if</span> (Result &gt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    UncompressedSize = Result;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">int32 <span class="title">FZstdCompressionFormat::GetCompressedBufferSize</span><span class="params">(int32 UncompressedSize, int32 CompressionData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ZSTD_compressBound</span>(UncompressedSize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这里 <code>ZSTD</code> 的的集成工作就完毕了，只剩下最后一步，那就是把这个 Feature 添加到 <code>IModularFeatures</code> 中，可以供引擎使用。</p>
<p>因为我是创建了一个插件，所以可以把注册的逻辑写到模块的 <code>StartupModule</code> 中，反之卸载模块时取消注册。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZSTD_LEVEL_OPTION_STRING TEXT(<span class="meta-string">&quot;-ZstdLevel=&quot;</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FlibzstdModule::StartupModule</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FString CommandLine = FCommandLine::<span class="built_in">Get</span>();</span><br><span class="line">  <span class="keyword">if</span> (CommandLine.<span class="built_in">Contains</span>(ZSTD_LEVEL_OPTION_STRING, ESearchCase::IgnoreCase))</span><br><span class="line">  &#123;</span><br><span class="line">    int32 level;</span><br><span class="line">    FParse::<span class="built_in">Value</span>(FCommandLine::<span class="built_in">Get</span>(), *<span class="built_in">FString</span>(ZSTD_LEVEL_OPTION_STRING).<span class="built_in">ToLower</span>(), level);</span><br><span class="line">    FZstdCompressionFormat::Level = FMath::<span class="built_in">Clamp</span>(level, <span class="built_in">ZSTD_minCLevel</span>(),<span class="built_in">ZSTD_maxCLevel</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ZstdCompressionFormat = <span class="keyword">new</span> <span class="built_in">FZstdCompressionFormat</span>();</span><br><span class="line">  IModularFeatures::<span class="built_in">Get</span>().<span class="built_in">RegisterModularFeature</span>(COMPRESSION_FORMAT_FEATURE_NAME, ZstdCompressionFormat);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FlibzstdModule::ShutdownModule</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  IModularFeatures::<span class="built_in">Get</span>().<span class="built_in">UnregisterModularFeature</span>(COMPRESSION_FORMAT_FEATURE_NAME, ZstdCompressionFormat);</span><br><span class="line">  <span class="keyword">delete</span> ZstdCompressionFormat;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与前面讲的注册方法一致，我这里还添加了一个引擎启动时的命令行参数 <code>-ZstdLevel=</code> 可以用来传递使用 <code>ZSTD</code> 进行压缩的的压缩等级。</p>
<p>打包 Pak 使用 <code>ZSTD</code> 算法，使用我的 <a href="https://github.com/hxhb/HotPatcher">HotPatcher</a> 可以在 <code>UnrealPakOptions</code> 中添加 <code>-compressionformats=zstd,zlib</code> 参数：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/8470/ue-hotpatcher-compressionformats.webp"></p>
<p>使用 <code>UnrealPak</code> 检测压缩格式：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/8470/ue4-zstd-compression.webp"></p>
<blockquote>
<p>注意，因为没有编译引擎，所以是不能直接通过 <code>UnrealPak.exe</code> 来解压使用 <code>ZSTD</code> 压缩的 Pak 的。</p>
</blockquote>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>ThirdParty</category>
      </categories>
      <tags>
        <tag>压缩算法</tag>
        <tag>ZSTD</tag>
        <tag>ModularFeature</tag>
      </tags>
  </entry>
  <entry>
    <title>EpicVerse：UE5 新的脚本语言</title>
    <url>/wiki/21436/</url>
    <content><![CDATA[<h2 id="UE5 可能的脚本语言简介"><a href="#UE5 可能的脚本语言简介" class="headerlink" title="UE5 可能的脚本语言简介"></a>UE5 可能的脚本语言简介 </h2><p> 在 Epic 的 <a href="https://www.twitch.tv/videos/840713360?t=1h6m20s">Inside Unreal:2020 Year In Review</a> 中介绍了一个全新的脚本语言，有可能被称作<code>Epic Verse</code>。</p>
<p>reddit 上关于该脚本语言的讨论：<a href="https://www.reddit.com/r/unrealengine/comments/kf8z27/epic_showed_off_their_new_unreal_verse_scripting/">Epic showed off their new Unreal Verse scripting language that will probably end up in UE5</a></p>
<p>UE4 的蓝图极大地降低了非专业开发者的上手门槛，图形化编程的方式从线性角度很容易理解，但是也会造成混乱。上了一定规模的项目还是需要文本化的脚本语言的，主要解决以下几个问题：</p>
<ol>
<li>文本化方便协同开发，不会造成资源的冲突（BP 是资源）</li>
<li>方便直观地进行 diff</li>
<li>方便迁移引擎版本，而没有资源的升 / 降级问题</li>
</ol>
<p>而且我认为，脚本语言最好是强类型语言，写惯了 C++ 这种静态强类型语言，其实对 Lua 这种弱类型语言还是挺不习惯的，之前有一种语言叫做 <a href="https://www.angelcode.com/">AngelScript</a> 的静态强类型脚本语言，和 C++ 非常像，被第三方集成到了 UE 中，但是目前只支持 PC 和主机平台，不支持移动端。</p>
<p>对于 UE4 中目前在手游开发中主流的脚本语言支持，为腾讯开源的 <a href="">UnLua</a> 和<a href="">SLua</a>两款插件，都是以反射形式集成的，有一些实现上的缺点和社区支持不够，希望 Epic 能出一款官方支持的脚本工具，原本以为 Python 有比较大的可能，因为 UE 在编辑器下对 Python 的支持已经挺好了，而且 Python 有比较大的用户群体，上手难度也不高。</p>
<p>如果引入一门新的脚本语言，在 UE 中可以使用的编程方式：</p>
<ol>
<li>C++</li>
<li>蓝图</li>
<li>Python（编辑器）</li>
<li>Epic Verse</li>
</ol>
<p>处理不同的需求有不同的语言，有些过于复杂了。</p>
<p>目前还不知道 UE 出的这个新脚本具体表现和语法形式怎么样，其实新增一门语言大大增加了用户的学习成本，也不知道 UE 是如何设计 BP 和新脚本语言的关联的，等最新的消息再看。</p>
<p>两年前 Tim 在 Reddit 上有一些相关的回复和讨论：<a href="https://www.reddit.com/r/unrealengine/comments/aezhdv/it_seems_people_at_epic_are_considering_adding/edxha25/">It seems people at Epic are considering adding some intermediate script language between C++ and Blueprints</a></p>
<h2 id="Epic-Verse- 语法介绍"><a href="#Epic-Verse- 语法介绍" class="headerlink" title="Epic Verse 语法介绍"></a>Epic Verse 语法介绍 </h2><p> 认真看了一下 <a href="https://www.twitch.tv/videos/840713360?t=1h6m20s">Inside Unreal:2020 Year In Review</a> 里展示的 Epic Verse 代码，看起来新的脚本语言很像 <code>pascal</code> 和<code>Python</code>的结合体，而且还有点 ruby 味，Verse 具有静态类型，某些语法与 <a href="https://skookumscript.com/docs/v3.0/#ojb-id-potential-reference">SkookumScript</a> 非常像。</p>
<p>2019 年初 Epic 收购了<a href="https://skookumscript.com/blog/2019/01-23-epic-aquires-agog/">Agog Labs (and SkookumScript)</a>，应该是要来打造 UE5 的脚本语言，所以 UE5 的语法结构和 SkookumScript 比较像应该是比较合理的，根据视频里的展示情况，我认为 UE5 的脚本语言应该就是 Agog Labs 做的。</p>
<p>但是这场展示中并没有展示该脚本语言如何与引擎进行交互，也没有展示引擎中的符号信息，与 C++ 的交互方式目前只能观望。目前介绍一下视频里有展示的语言内容。</p>
<p>视频展示的代码如下：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue5/index/epicverse/0.webp"><br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue5/index/epicverse/1.webp"><br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue5/index/epicverse/2.webp"><br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue5/index/epicverse/3.webp"></p>
<p>手敲了遍文本：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># This is a BoxFight prototype game.</span></span><br><span class="line">BoxFight=<span class="class"><span class="keyword">class</span>(<span class="params">FortGameScriptBase</span>):</span></span><br><span class="line">    GameStarted^: <span class="built_in">bool</span>=false </span><br><span class="line">    GameEnded^: <span class="built_in">bool</span>=false </span><br><span class="line">    CurrentRound^: <span class="built_in">int</span>=<span class="number">0</span></span><br><span class="line">    RunGame()</span><br><span class="line">        <span class="comment"># Pause until all players in the matchmaking session</span></span><br><span class="line">        <span class="comment"># have connected to the server.</span></span><br><span class="line">        MaitForPlayersToJoin()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Start the game.</span></span><br><span class="line">        GameStarted := true </span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">1.</span>.NumberofRounds):</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Perform round setup.</span></span><br><span class="line">            currentRound := i</span><br><span class="line">            EnableBarriers()</span><br><span class="line">            SetBuildingDisallowed()</span><br><span class="line">            <span class="keyword">if</span>(!SetupPlayersAndSpawnPoints()?):</span><br><span class="line"></span><br><span class="line">                <span class="comment"># We hit an error and are unable to start the round.</span></span><br><span class="line">                ShutdownGame()</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># Begin the round start countdown.</span></span><br><span class="line">                Players.PutAllInStasisAllowEmotes()</span><br><span class="line">                Players.SetAllInvulnerable(true)</span><br><span class="line">                SimpleUI.ShowcountDown(<span class="number">7</span>)</span><br><span class="line">                Wait(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Enable building at the end of the countdown.</span></span><br><span class="line">                SimpleUI.ShowMessage(<span class="string">&quot;Building Enabled&quot;</span>)</span><br><span class="line">                SetBuildingAllowed()</span><br><span class="line">                Players.RemoveAllFromStasis()</span><br><span class="line">                Players.SetAllInRound()</span><br><span class="line">                <span class="comment"># Wait for the start countdown to complete.</span></span><br><span class="line">                Wait(<span class="number">4.7</span>)</span><br><span class="line">                SimpleUI.HideMessage()</span><br><span class="line">                <span class="comment"># Begin combat and initialize the storm.</span></span><br><span class="line"></span><br><span class="line">                Players.SetAllInvulnerable(false)</span><br><span class="line">                DisableBarriers()</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Hide the round start after it&#x27;s had a second to display.</span></span><br><span class="line">                Wait(<span class="number">1.3</span>)</span><br><span class="line">                simpleUI.HideCountDown()</span><br><span class="line">                Storm.Startstorm(<span class="number">60.0</span>, CurrentRound^)</span><br><span class="line"></span><br><span class="line">                <span class="comment">#Wait for the round end conditions </span></span><br><span class="line">                <span class="keyword">if</span>(IsSoloGame()?):</span><br><span class="line">                    race:</span><br><span class="line">                        <span class="comment">#Setup Solo specific end conditions for testing</span></span><br><span class="line">                        WaitForZeroRemaining()</span><br><span class="line">                        WaitForRoundTimeout()</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    race:</span><br><span class="line">                        <span class="comment"># Setup Solo specific end conditions for testing</span></span><br><span class="line">                        WaitForOneRemaining()</span><br><span class="line">                        WaitForZeroRemaining()</span><br><span class="line">                        WaitForRoundTimeout()</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># Handle round complete.</span></span><br><span class="line">                <span class="comment"># Give everyone a quick completion message.</span></span><br><span class="line">                SimpleUI.ShowMessage(<span class="string">&quot;Round Complete&quot;</span>)</span><br><span class="line">                Wait(<span class="number">2.0</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Disable combat and the storm.</span></span><br><span class="line">                SimpleUI.HideMessage()</span><br><span class="line">                Players.PutAllInstasisAllowEmotes()</span><br><span class="line">                Players.SetAllInvulnerable(true)</span><br><span class="line">                SetBuildingDisallowed()</span><br><span class="line">                Storm.stopstorm()</span><br><span class="line">                Players.SetAllEndRound()</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># Display the scoreboard.</span></span><br></pre></td></tr></table></figure>

<h3 id="class 定义"><a href="#class 定义" class="headerlink" title="class 定义"></a>class 定义 </h3><p> 首先是 class 定义（暂且标记为继承形式）：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">BoxFight = <span class="built_in">class</span>(FortGameScriptBase):</span><br></pre></td></tr></table></figure>

<h3 id="变量声明"><a href="# 变量声明" class="headerlink" title="变量声明"></a>变量声明</h3><blockquote>
<p>具有静态类型，并且无需<code>;</code></p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">GameStarted^: <span class="keyword">bool</span> = <span class="literal">false</span></span><br><span class="line">CurrentRound^: <span class="keyword">int</span> = <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="变量赋值"><a href="# 变量赋值" class="headerlink" title="变量赋值"></a>变量赋值</h3><blockquote>
<p>类似与 <code>pascal</code> 语言（SkookumScript 也是如此）</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">GameStarted := <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="代码块"><a href="# 代码块" class="headerlink" title="代码块"></a>代码块 </h3><p> 类似于 Python 的缩进，需要使用 <code>:</code> 标识：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="built_in">SetupPlayerAndSpwanPoints</span>()?):</span><br><span class="line">    <span class="built_in">ShutdownGame</span>()</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    Players.<span class="built_in">PutAllInStasisAllowEmotes</span>()</span><br><span class="line">    Players.<span class="built_in">SetAllInvulnerable</span>(<span class="literal">true</span>)</span><br><span class="line">    SimpleUI.<span class="built_in">ShowcountDown</span>(<span class="number">7</span>)</span><br><span class="line">    <span class="built_in">Wait</span>(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p><code>?</code>在 SkookumScript 是谓词，只能够应用到 <code>boolean</code> 的对象。在 SkookumScript 的文档中介绍是可选的，用于标识返回值为布尔类型：</p>
<blockquote>
<p>Optional ‘?’ used as convention to indicate predicate variable or method of return type Boolean (true or false). </p>
</blockquote>
<h3 id="循环语句"><a href="# 循环语句" class="headerlink" title="循环语句"></a>循环语句 </h3><p> 整型迭代：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span>(i = <span class="number">1.</span>.NumberOfRounds):</span><br></pre></td></tr></table></figure>
<p>这个形式有点类似于 ruby 语言里的 for：</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..<span class="number">100</span> <span class="keyword">do</span></span><br></pre></td></tr></table></figure>

<h3 id="函数调用"><a href="# 函数调用" class="headerlink" title="函数调用"></a>函数调用 </h3><p> 使用 <code>.</code> 来调用成员函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">Players.<span class="built_in">SetAllInRound</span>()</span><br></pre></td></tr></table></figure>

<h3 id="具有类似协程的形式"><a href="# 具有类似协程的形式" class="headerlink" title="具有类似协程的形式"></a>具有类似协程的形式</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="built_in">IsSoloGame</span>()?):</span><br><span class="line">    race:</span><br><span class="line">        <span class="built_in">WaitForZeroRemaining</span>()</span><br><span class="line">        <span class="built_in">WairForRoundTimeout</span>()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    race:</span><br><span class="line">        <span class="built_in">WaitForOntRemaining</span>()</span><br><span class="line">        <span class="built_in">WaitForZeroRemaining</span>()</span><br><span class="line">        <span class="built_in">WaitForRoundTimeout</span>()</span><br></pre></td></tr></table></figure>
<p>这里代码的含义上类似于 UE 的行为树中的 <code>Sequences</code> 的节点，只有当它的所有子节点都执行成功（完毕）了，它才执行成功。</p>
<p>这门脚本语言看起来更像是以 <a href="https://skookumscript.com/docs/v3.0/#ojb-id-potential-reference">SkookumScript</a> 为基础，糅合了数种编程语言的集合体，目前展示的代码还太少，不好说具体的上手表现怎么样，持续关注。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>UE5</category>
      </categories>
      <tags>
        <tag>EpicVerse</tag>
        <tag>Script Language</tag>
        <tag>UE5</tag>
      </tags>
  </entry>
  <entry>
    <title>Oodle 压缩算法</title>
    <url>/wiki/21435/</url>
    <content><![CDATA[<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue5/index/oodle.webp"></p>
<p>和我当初预想的一样，2021.04.01 的 Feeds：Epic 把 Oodle 集成到 UE4.27 和 UE5 中了。</p>
<ul>
<li><a href="https://www.unrealengine.com/en-US/blog/oodle-now-free-to-use-in-unreal-engine-via-github">Oodle now free to use in Unreal Engine via GitHub</a></li>
<li><a href="https://forums.unrealengine.com/development-discussion/rendering/1876442-rad-game-tools%E2%80%99-oodle%E2%80%94cross-platform-data-compression-solutions">RAD Game Tools’ Oodle—cross-platform data compression solutions</a></li>
</ul>
<p>他们会提供四种 Oodle 系列的压缩算法：</p>
<ul>
<li>Oodle Data Compression：最快和最高压缩比的压缩算法，可以用于数据压缩、打包压缩等。</li>
<li>Oodle Texture：用来压缩 Texture，可以压缩 BC1-BC7Texture，能够减少 50% 的 Texture 大小（官方数据）。</li>
<li>Oodle Network Compression：压缩 TCP/UDP 数据，降低与服务器传输占用的带宽。</li>
<li>Oodle Lossless Image Compression：无损图像压缩算法，比 png 小很多且具有非常高的解压速度。</li>
</ul>
<p>目前（2021.04.05）可以拉取 UE 的 <code>master</code> 分支，下载依赖之后在以下目录下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">E:\UnrealEngine\Source\UnrealEngine\Engine\Plugins\Compression</span><br><span class="line">E:\UnrealEngine\Source\UnrealEngine\Engine\Plugins\Developer\TextureFormatOodle</span><br></pre></td></tr></table></figure>
<p>具有 <code>OodleData</code> 和<code>OodleNetwork</code>、<code>TextureFormatOodle</code>三个插件，注意必须要下载依赖。不然代码中只有 <code>.h</code> 接口，并没有各个平台的链接库。</p>
<p>比较遗憾的是在更早的引擎版本中不支持，我从 UE 的开发分支把这部分代码抽离了出来，放到了单独的仓库中：<a href="https://github.com/hxhb/oodle-compression">oodle-compression</a>，看了代码并没有依赖新版本引擎相关的东西，但是直接在低版本引擎启用会有编译错误，我已修复。插件中的实现也是通过 SDK 把 Oodle 添加到了 UE 的 Compression 的 Modular Feature 中，同样可以按照我之前这篇文章的介绍中的方法使用：<a href="https://imzlp.com/posts/8470/">ModularFeature：为 UE4 集成 ZSTD 压缩算法</a>。</p>
<p>当使用 IOS 远程构建时还需要加上 Sdks 的 Rsync 的上传规则：</p>
<figure class="highlight plaintext"><figcaption><span>Build/Rsync/RsyncProject.txt</span></figcaption><table><tr><td class="code"><pre><span class="line">+ /Plugins/Compression/oodle-compression/OodleData/Sdks/2.9.0/include/**</span><br><span class="line">+ /Plugins/Compression/oodle-compression/OodleData/Sdks/2.9.0/lib/IOS/**</span><br><span class="line">+ /Plugins/Compression/oodle-compression/OodleNetwork/Sdks/2.9.0/include/**</span><br><span class="line">+ /Plugins/Compression/oodle-compression/OodleNetwork/Sdks/2.9.0/lib/IOS/**</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：如果默认打包时想要启用 Oodle 需要将插件放入 <code>Engine/Plugins/Runtime</code> 下，并给 <code>Oodle</code> 插件的 <code>uplugin</code> 添加 <code>&quot;SupportedPrograms&quot; : [&quot;UnrealPak&quot;]</code>，在 UnrealPak 启动时会加载<code>Oodle</code> 插件。</p>
</blockquote>
<p><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210713190212.webp"></p>
<p>通过在项目设置中配置 Oodle，会传递给 UnrealPak 命令行参数 <code>-compressionformats=Oodle</code> 来指定使用 Oodle，以及 <code>-compresslevel=fast</code> 来指定压缩级别。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UATHelper: Packaging (iOS): Output from: &quot;D:\UE4\Blank\Blank.uproject&quot; &quot;D:\UE4\Blank\Saved\StagedBuilds\IOS\cookeddata\Blank\content\paks\Blank-ios.pak&quot; -create=C:\build_agent\workspace\FGameEngine\Engine\Engine\Programs\AutomationTool\Sav</span><br><span class="line">ed\Logs\PakList_Blank-ios.txt -cryptokeys=&quot;D:\UE4\Blank\Saved\Cooked\IOS\Blank\Metadata\Crypto.json&quot; -order=&quot;D:\UE4\Blank\Build\IOS\FileOpenOrder\CookerOpenOrder.log&quot; -platform=IOS -AlignForMemoryMapping=16384 -compressionformats=Oodle,Zlib  -multi</span><br><span class="line">process -abslog=C:\build_agent\workspace\FGameEngine\Engine\Engine\Programs\AutomationTool\Saved\Logs\UnrealPak-Blank-ios-2021.07.13-18.43.29.txt -compressmethod=Kraken -compresslevel=fast</span><br><span class="line">UATHelper: Packaging (iOS):   OodleCompression: Display: Oodle v2.9.0 initializing with method=Kraken, level=3=Fast</span><br><span class="line">UATHelper: Packaging (iOS):   LogPakFile: Display: Parsing crypto keys from a crypto key cache file</span><br><span class="line">UATHelper: Packaging (iOS):   LogPakFile: Display: Loading response file C:\build_agent\workspace\FGameEngine\Engine\Engine\Programs\AutomationTool\Saved\Logs\PakList_Blank-ios.txt</span><br><span class="line">UATHelper: Packaging (iOS):   LogPakFile: Display: Added 2255 entries to add to pak file.</span><br><span class="line">UATHelper: Packaging (iOS):   LogPakFile: Display: Loading pak order file D:\UE4\Blank\Build\IOS\FileOpenOrder\CookerOpenOrder.log...</span><br><span class="line">UATHelper: Packaging (iOS):   LogPakFile: Display: Finished loading pak order file D:\UE4\Blank\Build\IOS\FileOpenOrder\CookerOpenOrder.log.</span><br><span class="line">UATHelper: Packaging (iOS):   LogPakFile: Display: Collecting files to add to pak file...</span><br><span class="line">UATHelper: Packaging (iOS):   LogPakFile: Display: Collected 2255 files in 0.01s.</span><br><span class="line">UATHelper: Packaging (iOS):   LogPakFile: Display: Creating pak D:\UE4\Blank\Saved\StagedBuilds\IOS\cookeddata\Blank\content\paks\Blank-ios.pak.</span><br><span class="line">UATHelper: Packaging (iOS):   LogPakFile: Display: ENABLING pak file index freezing</span><br><span class="line">UATHelper: Packaging (iOS):   LogPakFile: Display: Added 2255 files, 123452947 bytes total, time 2.17s.</span><br><span class="line">UATHelper: Packaging (iOS):   LogPakFile: Display: Compression summary: 43.30% of original size. Compressed Size 69209450 bytes, Original Size 159833025 bytes.</span><br><span class="line">UATHelper: Packaging (iOS):   LogPakFile: Display: Used compression formats (in priority order) &#x27;Oodle, Zlib, &#x27;</span><br><span class="line">UATHelper: Packaging (iOS):   LogPakFile: Display: Encryption - DISABLED</span><br><span class="line">UATHelper: Packaging (iOS):   LogPakFile: Display: Unreal pak executed in 2.233311 seconds</span><br><span class="line">UATHelper: Packaging (iOS): UnrealPak terminated with exit code 0</span><br></pre></td></tr></table></figure>
<p><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210713190121.webp"></p>
<p>经过测试，一个使用 zlib 压缩之后有 295M 的 pak 文件使用 Oodle 压缩降低到了 282M，但是 Oodle 的解压速度完胜 zlib。<br>Oodle 的压缩性能在 RAD 网站上有对比数据：<a href="http://www.radgametools.com/oodle.htm">Oodle Compression</a></p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue5/index/oodle_typical_vbar.webp"><br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue5/index/oodle260_typical_combined.webp"></p>
<p>其他的对比数据：</p>
<ul>
<li><a href="https://cbloomrants.blogspot.com/2016/05/ps4-battle-lz4-vs-lzsse-vs-oodle.html">PS4 Battle : LZ4 vs LZSSE vs Oodle</a></li>
</ul>
<p>压缩算法的选择就是要在压缩率 / 解压速度上来做一个权衡，就是压缩率最低的 <code>Selkie</code> 也比 zlib 要强一点点，但是 decompress 速度比 zlib 高了十几倍，对于游戏而言解压速度非常直观地影响到游戏性能，这应该也是 UE 选择收购 RAD 的原因吧。</p>
<p>其他资料：</p>
<ul>
<li><a href="https://cbloomrants.blogspot.com/2020/09/how-oodle-kraken-and-oodle-texture.html">How Oodle Kraken and Oodle Texture supercharge the IO system of the Sony PS5</a></li>
<li><a href="https://cbloomrants.blogspot.com/">cbloom rants</a></li>
<li><a href="https://encode.su/threads/3426-Oodle-Texture-compression">Oodle Texture compression</a></li>
<li><a href="https://wccftech.com/ps5-io-system-to-be-supercharged-by-oodle-texture-bandwidth-goes-up-to-17-38gb-s/">PS5 IO System to Be ‘Supercharged’ by Oodle Texture, Bandwidth Goes Up to 17.38GB/s</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>UE5</category>
      </categories>
      <tags>
        <tag>压缩算法</tag>
        <tag>UE5</tag>
        <tag>Oodle</tag>
      </tags>
  </entry>
  <entry>
    <title>UE5：新一代虚幻引擎初探</title>
    <url>/wiki/8724/</url>
    <content><![CDATA[<p>终于，在 2021 年的五月底，UE5 终于要推出第一个预览版本了，<a href="https://mp.weixin.qq.com/s/W0e79uhqOyxLKXeC9MwnDg">虚幻引擎 5——将于中国时间 5 月 26 日周三晚 10 点开启抢先体验计划！</a>。<br>对 UE5 期待许久，去年 Nanite 和 lumen 一石激起千层浪，时隔一年，终于能够实际体验到了。<br>过去一年，关于 UE5 的技术消息不多，我做过了一些 Epic 披露的关于 UE5 相关的信息总结和分析，有兴趣的可以移步 <a href="https://imzlp.com/notes/ue5/">notes/ue5</a> 中查看。本篇文章会记录上手 UE5 的一些体验，相较于 UE4 开发方式的变动，为 UE4 到 UE5 的过渡，以及将 UE5 应用到生产环境做一个技术预研，近期会持续更新。</p>
<p>UE5 官方资料：</p>
<ul>
<li><a href="https://www.unrealengine.com/zh-CN/unreal-engine-5?lang=zh-CN">虚幻引擎 5 抢鲜体验</a></li>
<li><a href="https://docs.unrealengine.com/5.0/en-US/">Unreal Engine 5 Early Access Documentation</a></li>
<li><a href="https://docs.unrealengine.com/5.0/en-US/ReleaseNotes/">Unreal Engine 5 Early Access Release Notes</a></li>
<li><a href="https://docs.unrealengine.com/5.0/en-US/API">Unreal Engine C++ API Reference</a></li>
</ul>
<p>发布的演示视频：<br><a href="https://www.bilibili.com/video/BV1V64y1k73g"><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210527103357.webp"></a></p>
<p>最值得关注的点当然是 Lumin/Nanite，并且引擎集成了 Quixel Bridge，可以直接导入资源，场景编辑流程变化很大。<br>增加强大的动画支持，在引擎中直接编辑和复用动画资源更方便了，能够根据场景自适应动画，非常 Amazing 啊！<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210527131045.webp"><br>GamePlay 方面增加了一种叫做 <code>Game Feature</code> 的机制，支持使用模块化的方式创建和发布游戏内容，对于资产管理和打包的流程相较于 UE4 也有变动，从热更新的角度来看，估计需要增加支持 <code>Game Feature</code> 作为资产包的功能支持，准备近期有时间先把 HotPatcher 目前的版本升级到 UE5。<br>准备近期有时间对 UE5 中的新机制做个功能预研然后写几篇文章。</p>
<p>可以在 EpicLauncher 里安装二进制版本：<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210527000154.webp"></p>
<blockquote>
<p>UE5 预览版源码 github 地址：<a href="https://github.com/EpicGames/UnrealEngine/tree/ue5-main">ue5-main</a>，需要下载的依赖 ue4-gitdeps 与 UE4 的版本有相同的部分，可以拷贝到 UE5 代码的 <code>.git/ue4-gitdeps</code> 目录下，在 <code>Setup.bat</code> 时可以减少下载的内容。<br>并且，Epic 随 UE5 一起放出了 <a href="com.epicgames.launcher://ue/ue5ea"> 古代山谷 </a> 项目，可以点击连接从 Epic Launcher 下载，文档：<a href="https://docs.unrealengine.com/5.0/en-US/ContentAndSamples/ValleyOfTheAncient/">Valley of the Ancient Sample</a>。</p>
</blockquote>
<!-- 我 VPS 下载压缩后的分流地址：[ue5-main.tar.gz](https://stusdnueducn-my.sharepoint.com/:u:/g/personal/2017020625_stu_sdnu_edu_cn/ESdsjvLXbYlJlfSuCn3cnrIB_YV2yF8lnE3uqXFqigz89Q?e=D0HwCk)以及[ue5-early-access.tar.gz](https://stusdnueducn-my.sharepoint.com/:u:/g/personal/2017020625_stu_sdnu_edu_cn/EUtG94BZfkBJm-B3j75oMhIBSCGGM5Etp9Vui5QYDtcM0g?e=kKlVea)。 -->

<hr>
<p>我的博客中在发布之前关于 UE5 的分析笔记（<a href="https://imzlp.com/notes/ue5/">notes/ue5</a>）：</p>
<ul>
<li><a href="https://imzlp.com/notes/ue5/#Oodle-Compression">Oodle Compression</a></li>
<li><a href="https://imzlp.com/notes/ue5/#Epic-Verse-%E8%AF%AD%E6%B3%95%E4%BB%8B%E7%BB%8D">Epic Verse 语法介绍</a></li>
<li><a href="https://imzlp.com/notes/ue5/#Epic%E6%94%B6%E8%B4%ADRAD-Game-Tools">Epic 收购 RAD Game Tools</a></li>
<li><a href="https://imzlp.com/notes/ue5/#UE5%E5%8F%AF%E8%83%BD%E7%9A%84%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80">UE5 可能的脚本语言</a></li>
<li><a href="https://imzlp.com/notes/ue5/#UE5%E7%9A%84PS5%E7%9C%9F%E6%9C%BA%E8%A7%86%E9%A2%91">UE5 的 PS5 真机视频</a></li>
</ul>
<p>附 Epic 中国直播的 UE 开发路线图视频：</p>
<ul>
<li><a href="https://www.bilibili.com/video/BV1wA411H7h3">[中文直播]第 29 期｜解析虚幻引擎开发路线图(上集) | Epic 王祢 马骥 孙丹璐</a></li>
<li><a href="https://www.bilibili.com/video/BV1iK411P7QD">[中文直播]第 29 期｜解析虚幻引擎开发路线图(下集) | Epic 王祢 马骥 孙丹璐</a></li>
</ul>
<hr>
<blockquote>
<p><strong>注意</strong>：本次发布的预览版并不包含新的脚本语言 Epic Verse，估计还需要挺长一段时间的更新才会支持。</p>
</blockquote>
<h2 id="Platform-Support"><a href="#Platform-Support" class="headerlink" title="Platform Support"></a>Platform Support</h2><p>UE5 已经抛弃支持 32 位平台，并已支持 Apple Silicon 设备（M1），但 Editor 非 Arm 原生，仍需要 Rosetta 转译执行。<br>Lumen 和 Nanite 不支持移动平台、上一代主机平台。<br>建议设备：GTX 1080+。</p>
<p>引擎中增加了<a href="https://docs.unrealengine.com/5.0/en-US/PerformanceAndPlatformFeatures/Turnkey/">Unreal Trunkey</a>，相较于 UE4，可以非常方便地在团队之间统一配置平台 SDK。<br>UE5 集成的各 SDK 版本： <a href="https://docs.unrealengine.com/5.0/en-US/ReleaseNotes/">New: Platform SDK Upgrades</a>。<br>Windows 编译器版本最低支持 VS2019 v16.4 及以上的版本 ，不再支持 VS2015 和 VS2017。</p>
<h2 id="Engine-Code"><a href="#Engine-Code" class="headerlink" title="Engine Code"></a>Engine Code</h2><p>Github 上提供了两个 UE5 的代码分支：<a href="https://github.com/EpicGames/UnrealEngine/tree/ue5-main">ue5-main</a>和<a href="https://github.com/EpicGames/UnrealEngine/tree/ue5-early-access">ue5-early-access</a>。</p>
<p>两者的区别是：</p>
<ul>
<li>ue5-early-access：与 Epic Lacunher 相同的源码分支</li>
<li>ue5-main：Epic 的开发分支</li>
</ul>
<p>引擎代码的组织方式相较于 UE4 没有变动，目前看到 Module 的代码基本与 UE4 保持一致，所以 UE4 代码升级到 UE5 应该问题不大，需要解决的应该是以下几点：</p>
<ol>
<li>原先依赖的模块代码组织变动</li>
<li><code>BuildSettingsVersion</code>被设置为 <code>Latest</code> 带来的警告等级的变化</li>
<li><code>CppStandardVersion</code>默认为 Cpp17（Latst 为 Cpp20）</li>
<li>检测引擎版本的代码，如 <code>ENGINE_MAJOR_VERSION</code> 变为 <code>5</code>，<code>ENGINE_MINOR_VERSION</code> 变为 0</li>
</ol>
<p>在 TargetRules 中增加了一些新的编译选项：</p>
<ul>
<li>DefaultWarningLevel</li>
<li>DeprecationWarningLevel</li>
<li>bWarningsAsErrors</li>
<li>bEnableCppModules</li>
</ul>
<p>Nvdia 的组件则从 UE4 的默认开启变成了默认关闭（不确定是否为了兼容 UE4 项目升级保留，有可能后面会移除，这一点 UE5 的文档中也有写），物理系统在 UE5 中默认使用 Chaos：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">bCompilePhysX = <span class="literal">false</span>;</span><br><span class="line">bCompileAPEX = <span class="literal">false</span>;</span><br><span class="line">bCompileNvCloth = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
<p>引擎中 ModuleRules 的几乎没有变动，没有新加的参数，只是针对 <code>bEnableCppModules</code> 做了检测。<br>UE5 的编译系统可以看作是 UE4 的常规升级，有时间我会先把我开源的插件升级到 UE5 进行测试。</p>
<p>同时，UE5 相较于 UE4.25，引擎中增加了几个新的 Programs：</p>
<ol>
<li>BaseTextureBuildWorker</li>
<li>ChaosVisualDebugger</li>
<li>DerivedDataBuildWorker</li>
<li>EpicWebHelper</li>
<li>HeadlessChaosPerf</li>
<li>Horde</li>
<li>InterchangeWorker</li>
<li>EpicGames.Core/Jupiter/MongoDB/Perforce/Perforce.Managed</li>
<li>SwitchboardListener</li>
<li>TextureShare</li>
<li>UnrealBuildToolTests</li>
<li>UnrealObjectPtrTool</li>
<li>VirtualProduction</li>
</ol>
<p>有时间再来具体分析作用。</p>
<h2 id="Editor"><a href="#Editor" class="headerlink" title="Editor"></a>Editor</h2><p>UE5 新 Editor 的文档介绍：<a href="https://docs.unrealengine.com/5.0/en-US/EditorImprovements/">Navigating the New Unreal Editor Interface</a></p>
<p>启动界面<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210527082837.webp"></p>
<p>个人觉得相对于 UE4 的拟物化 UI 风格更耐看一些。<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210527013216.webp"><br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210527082945.webp"></p>
<p>可以在 Launcher 界面选择启动 UE4 项目：<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210527013255.webp"></p>
<p>项目设置与编辑器设置，与 UE4 的分类保持一致，也可以使用 Rider 作为开发 IDE 并刷新工程。</p>
<p>具有比 UE4 更好的本地化语言支持：<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210527083915.webp"><br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210527083954.webp"></p>
<h2 id="Project"><a href="#Project" class="headerlink" title="Project"></a>Project</h2><p>UE5 创建项目组织基本与 UE4 保持一致，代码开发流程与 UE4 没有区别。</p>
<p>对开发硬件要求更高了，我的机器位 10606G，在 ThirdPersion 项目 Editor 只能跑到 80fps：<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210527084406.webp"><br>估计在我的机器上打包之后最多只能跑 30fps。</p>
<h3 id="Data-Drived-CVars"><a href="#Data-Drived-CVars" class="headerlink" title="Data Drived CVars"></a>Data Drived CVars</h3><p>UE5 中还增加了 <code>Data Driven CVars</code> 的支持，可以在项目设置中配置 <code>Console Variables</code>：<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210527152722.webp"><br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210527152745.webp"><br> 可以在 <code>IConsoleManager::Get()</code> 获取，相较于 UE4，无需在代码中创建 <code>TAutoConsoleVariable</code> 对象，更为方便，它被存储在 <code>DefaultEngine.ini</code> 中：</p>
<figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="section">[/Script/Engine.DataDrivenConsoleVariableSettings]</span></span><br><span class="line">+<span class="attr">CVarsArray</span>=(Type=CVarInt,Name=<span class="string">&quot;t.testvar&quot;</span>,ToolTip=<span class="string">&quot;&quot;</span>,DefaultValueFloat=<span class="number">0.000000</span>,DefaultValueInt=<span class="number">123</span>,DefaultValueBool=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Cook-for-Platform"><a href="#Cook-for-Platform" class="headerlink" title="Cook for Platform"></a>Cook for Platform</h3><p>UE5 终于支持在编辑器中 Cook 非本地平台了（其实就是为平台默认增加了 Cook 按钮，在 UE4 中 HotPatcher 中也已支持同时 Cook 多个平台）。<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210527153537.webp"></p>
<h3 id="GamePlay"><a href="#GamePlay" class="headerlink" title="GamePlay"></a>GamePlay</h3><p>UE5 带来的 Game Play 的变动较多，如 Game Feature 等，准备有时间再进行详细的分析和使用。</p>
<h2 id="Plugins"><a href="#Plugins" class="headerlink" title="Plugins"></a>Plugins</h2><p>UE5 创建插件和 UE4 的组织方式和 Build.cs 代码也没有变动，我把我之前开源的 <a href="https://github.com/hxhb/ue4-export-nav-data"><a href="https://github.com/hxhb/ue4-export-nav-data">ue4-export-nav-data</a></a> 插件放到 UE5 工程里，出现的错误也只是符号找不到，是引擎内实现有变动，通过简单的修改可以直接编译通过，但 UE4 的代码模块是直接可以拿到 UE5 编译的，需要处理对应的符号查找错误。</p>
<p>我已经把 ue4-export-nav-data 插件升级支持 UE5 了，并且在 UE5 上导出数据与 <code>detour</code> 验证通过，详情请看之前的文章：<a href="https://imzlp.com/posts/20203/">Export Recast Navigation Data from UE4</a>，仓库地址为：<a href="https://github.com/hxhb/ue4-export-nav-data/tree/UE5.0">ue4-export-nav-data</a>。</p>
<h2 id="Assets"><a href="#Assets" class="headerlink" title="Assets"></a>Assets</h2><p>UE5 资源管理的变动，新特性支持了 <code>Game Feature</code> 机制，能够模块化构建游戏内容，开启之后可以在项目设置的 <code>Asset Manager</code> 中看到 <code>GameFeatureData</code> 的选项，说明 GameFeature 是已经兼容了打包的方式的，有时间做个详细的分析。</p>
<p>UE5 同样支持 PrimaryAssetLable 机制来标记资产，与 UE4 中没有区别，同时编辑器选项中增加了 <code> 允许 ChunkID 指定 </code> 功能，开启之后可以在资源右键中看到以下菜单：<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210527121535.webp"></p>
<h2 id="Package"><a href="#Package" class="headerlink" title="Package"></a>Package</h2><blockquote>
<p>蓝图项目对 Apple Silicon 的支持位仅限通过 Rosetta2 运行，C++ 项目支持本地 Apple Silicon 打包。</p>
</blockquote>
<p>UE5 中的打包选项移动到了以下位置：<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210527120359.webp"></p>
<p>打包时同样使用 UAT 执行，命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cmd.exe /c &quot;</span><br><span class="line">&quot;C:/Program Files/Epic Games/UE_5.0ea/Engine/Build/BatchFiles/RunUAT.bat&quot; </span><br><span class="line">-ScriptsForProject=&quot;C:/Users/lipengzha/Documents/Unreal Projects/ThirdPerson_UE5/ThirdPerson_UE5.uproject&quot; </span><br><span class="line">Turnkey </span><br><span class="line">-command=VerifySdk </span><br><span class="line">-platform=Win64 </span><br><span class="line">-UpdateIfNeeded </span><br><span class="line">-EditorIO </span><br><span class="line">-project=&quot;C:/Users/lipengzha/Documents/Unreal Projects/ThirdPerson_UE5/ThirdPerson_UE5.uproject&quot; </span><br><span class="line">BuildCookRun </span><br><span class="line">-nop4 </span><br><span class="line">-utf8output </span><br><span class="line">-nocompileeditor </span><br><span class="line">-cook</span><br><span class="line">-project=&quot;C:/Users/lipengzha/Documents/Unreal Projects/ThirdPerson_UE5/ThirdPerson_UE5.uproject&quot; </span><br><span class="line">-ue4exe=&quot;C:\Program Files\Epic Games\UE_5.0ea\Engine\Binaries\Win64\UnrealEditor-Cmd.exe&quot; </span><br><span class="line">-platform=Win64 </span><br><span class="line">-ddc=InstalledDerivedDataBackendGraph </span><br><span class="line">-installed </span><br><span class="line">-stage </span><br><span class="line">-archive </span><br><span class="line">-package </span><br><span class="line">-build </span><br><span class="line">-iostore </span><br><span class="line">-pak </span><br><span class="line">-prereqs </span><br><span class="line">-archivedirectory=&quot;C:/Users/lipengzha/Documents/Unreal Projects/ThirdPerson_UE5/Package&quot; </span><br><span class="line">-nodebuginfo </span><br><span class="line">-clientconfig=Development</span><br><span class="line">-nocompil</span><br><span class="line">&quot;</span><br></pre></td></tr></table></figure>

<p>代码的编译命令与 UE4 也没有区别：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">C:\Program Files\Epic Games\UE_5.0ea\Engine\Binaries\DotNET\UnrealBuildTool\UnrealBuildTool.exe </span><br><span class="line">ThirdPerson_UE5 Win64 Development </span><br><span class="line">-Project=<span class="string">&quot;C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson_UE5\ThirdPerson_UE5.uproject&quot;</span> <span class="string">&quot;C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson_UE5\ThirdPerson_UE5.uproject&quot;</span> </span><br><span class="line">-NoUBTMakefiles  </span><br><span class="line">-remoteini=<span class="string">&quot;C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson_UE5&quot;</span> </span><br><span class="line">-skipdeploy </span><br><span class="line">-Manifest=<span class="string">&quot;C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson_UE5\Intermediate\Build\Manifest.xml&quot;</span> </span><br><span class="line">-NoHotReload </span><br><span class="line">-<span class="built_in">log</span>=<span class="string">&quot;C:\Users\lipengzha\AppD</span></span><br><span class="line"><span class="string">ata\Roaming\Unreal Engine\AutomationTool\Logs\C+Program+Files+Epic+Games+UE_5.0ea\UBT-ThirdPerson_UE5-Win64-Development.txt&quot;</span></span><br></pre></td></tr></table></figure>
<p>Cook 命令也相同：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">C:\Program Files\Epic Games\UE_5.0ea\Engine\Binaries\Win64\UnrealEditor-Cmd.exe </span><br><span class="line"><span class="string">&quot;C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson_UE5\ThirdPerson_UE5.uproject&quot;</span> </span><br><span class="line">-run=Cook  </span><br><span class="line">-TargetPlatform=Windows </span><br><span class="line">-fileopenlog </span><br><span class="line">-ddc=InstalledDerivedDataBackendGraph </span><br><span class="line">-unversioned </span><br><span class="line">-abslog=<span class="string">&quot;C:\Program Files\Epic Games\UE_5.0ea\Engine\Programs\AutomationTool\Saved\Cook-2021.05.27-12.04.09.txt&quot;</span> </span><br><span class="line">-stdout </span><br><span class="line">-CrashForUA</span><br></pre></td></tr></table></figure>
<p>测试打包 ThirdPerson 非常慢。打包之后的目录结构与 UE4 相同：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">C:.</span><br><span class="line">|   Manifest_NonUFSFiles_Win64.txt</span><br><span class="line">|   ThirdPerson_UE5.exe</span><br><span class="line">|</span><br><span class="line">+---Engine</span><br><span class="line">|   +---Binaries</span><br><span class="line">|   |   \---ThirdParty</span><br><span class="line">\---ThirdPerson_UE5</span><br><span class="line">    +---Binaries</span><br><span class="line">    |   \---Win64</span><br><span class="line">    |           ThirdPerson_UE5.exe</span><br><span class="line">    |           turbojpeg.dll</span><br><span class="line">    |</span><br><span class="line">    \---Content</span><br><span class="line">        \---Paks</span><br><span class="line">                global.ucas</span><br><span class="line">                global.utoc</span><br><span class="line">                ThirdPerson_UE5-Windows.pak</span><br><span class="line">                ThirdPerson_UE5-Windows.ucas</span><br><span class="line">                ThirdPerson_UE5-Windows.utoc</span><br></pre></td></tr></table></figure>
<p>但是除了 pak 之外多了两种类型的文件 <code>ucas</code> 与<code>utoc</code>两种文件，在运行时 Mount pak 时也会 mount 它们，看了下代码在 UE4.25/26 就中存在，有时间详细地分析下它们的作用和加载流程。</p>
<h2 id="Open-UE4-Project"><a href="#Open-UE4-Project" class="headerlink" title="Open UE4 Project"></a>Open UE4 Project</h2><p>UE5 的文档中写道：支持 UE4.26 及之前的引擎版本项目升级到 UE5，UE5 会和 UE4.27 并行存在，不会保证与 4.26 之后的版本保持兼容。并且，UE5 项目无法降级到 UE4。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210527083223.webp"></p>
<p>但是就目前的情况而言，把 4.26 的工程升级到 UE5 还是有不少的错误，但这些错误基本都是上面介绍的那几点中的情况，花些心思适配即可。</p>
<h2 id="其他兼容性问题补充"><a href="# 其他兼容性问题补充" class="headerlink" title="其他兼容性问题补充"></a>其他兼容性问题补充</h2><p>UE5 的其他的兼容性问题补充：</p>
<ol>
<li><code>UE4Editor*.exe</code>更名为 <code>UnrealEngine*.exe</code>，原先依赖<code>UE4Editor*.exe</code> 路径的需要修改；</li>
<li><code>UnrealBuildTool</code>从 UE4 中 <code>Binaries/DoNET</code> 移动到 <code>Binaries/DoNET/AutomationTool</code> 目录下，会导致 UE4 的 UnrealVersionSelector 生成 sln 失败；<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210531112724.webp"></li>
</ol>
<p>平台名的变化：</p>
<ol>
<li>去掉了一些资源平台，新加了一些</li>
<li>如 <code>WindowsNoEditor</code>/<code>MacNoEditor</code> 等统一去掉了 <code>NoEditor</code> 后缀<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210615103320.webp"></li>
</ol>
<script src="https://gist.github.com/imzlp/1181f5330713ed02cb7c880b449531f8.js"></script>

<h2 id="总结"><a href="# 总结" class="headerlink" title="总结"></a>总结 </h2><p> 总的来说，UE5 的核心更新在 Lumen 和 Nanite 带来的美术资源与场景编辑流程的革新，以及对引擎内对数据驱动动画的强大支持。UE5 相较于 UE4 在编程方面没有非常大的变化，较新版本的 UE4 工程代码和插件能够比较轻松地升级到 UE5，之前有消息的新脚本语言 Epic Verse 没有同步发布，对这个还是非常期待的。<br>编辑器的整体操作习惯还是遵循了 UE4，不过主界面布局和 UI 风格变化比较大，熟悉之后倒也没有什么障碍，UE5 提供了更方便的平台 SDK 支持。基本上 UE4 资源管理和工程实践的积累也能在 UE5 中直接用，打包流程与 UE4 也基本相同，不过目前打包速度相较于 UE4 变慢了很多。<br>作为下一个世代的游戏引擎，非常期待 UE5 在主机平台上的效果，但是目前 Lumen 和 Nanite 并不支持 Mobile 平台，短期内无法作为生产环境，期待正式版本在移动端上的表现。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>UE5</category>
      </categories>
      <tags>
        <tag>UE5</tag>
      </tags>
  </entry>
  <entry>
    <title>HTC Vive Tracker Developer Guide</title>
    <url>/wiki/2125/</url>
    <content><![CDATA[<p>HTC 发布的 Vive 配件 <a href="https://www.vive.com/us/vive-tracker/">Vive Tracker</a> 可以用来扩展与 SteamVR 连接的设备。而且还具有 Pogo 引脚，可以自己 DIY 出特殊功能的配件，最近看到了一些使用 <a href="https://www.vive.com/us/vive-tracker/">Vive Tracker</a> 来实现的非常棒的创意。相关的资料和技术细节在本篇文章里整理辑录。</p>
<h3 id="HTC-Vive-Tacker"><a href="#HTC-Vive-Tacker" class="headerlink" title="HTC Vive Tacker"></a>HTC Vive Tacker</h3><p>一些使用 <a href="https://www.vive.com/us/vive-tracker/">Vive Tracker</a> 来实现的非常棒的创意：<br>使用 <a href="https://www.vive.com/us/vive-tracker/">Vive Tracker</a> 来为移动手机加入位置追踪，使手机可以加入 VR 游戏以及为 Daydream 增加位置追踪：</p>
<div class="video-container"><iframe src="https://www.youtube.com/embed/xDawcQiptZA" frameborder="0" loading="lazy" allowfullscreen></iframe></div>
<ul>
<li><a href="https://masterofshapes.com/work/cover-me/#projectinfo">MOBILE ROOM SCALE</a></li>
<li><a href="https://uploadvr.com/vive-tracker-google-daydream-room-scale/">Vive Tracker Powers Google Daydream Wireless Room Scale Hack</a></li>
<li><a href="https://masterofshapes.com/thelab/mobile-room-scale-experiences-with-vive-tracker/">Mobile Room Scale Experiences with Vive Tracker</a></li>
</ul>
<blockquote>
<p>注：它的实现实际上是 PC 创建房间并作为 Server，让移动设备通过网络加入游戏并具有 Camera，然后在 Server 上将追踪到的 <code>Tracker</code> 位置信息同步到移动设备上并修改 Camera 的位置，移动设备上的画面就是 Camera 修改后的，使其看起来像手机具有位置追踪，很鸡贼的一个做法(我预计使用 Tracker 为 DayDream 增加位置追踪也是相同的做法)。</p>
</blockquote>
<p>使用 <a href="https://www.vive.com/us/vive-tracker/">Vive Tracker</a> 的引脚扩展，做出特殊功能的硬件设备(喷雾罐)：</p>
<ul>
<li><a href="https://masterofshapes.com/thelab/spray-paint-in-vr-with-vive-tracker/">Virtual Graffiti by Master of Shapes:</a></li>
</ul>
<p>HTC 也开源了一个使用三个 Tracker 进行全身 IK 的实现：<a href="https://github.com/JamesBear/vive_ik_demo">vive_ik_demo</a><br>VIVE Tracker 官方推荐的案例教程：<a href="https://blog.vive.com/us/2017/04/19/new-project-code-and-tutorials-released-for-vive-tracker/">New Project Code and Tutorials Released for VIVE Tracker</a><br>HTC Vive Tracker 的指南 v1.6：</p>


	<div class="row">
    <embed src="https://img.imzlp.com/imgs/zlp/blog/posts/2125/HTC_Vive_Tracker_Developer_Guidelines_v1.6.pdf" width="100%" height="1000px" type="application/pdf">
	</div>




<p>相关资讯：<a href="https://blog.vive.com/us/2017/03/27/vive-tracker-now-available-for-developer-purchase/">Vive Tracker Now Available for Developer Purchase</a></p>
<h3 id="Set-Vive-Controller-Tracker-Type"><a href="#Set-Vive-Controller-Tracker-Type" class="headerlink" title="Set Vive Controller/Tracker Type"></a>Set Vive Controller/Tracker Type</h3><p>Vive Tracker 可以用来追踪位置，但是它并不仅仅只能用来追踪位置那么简单。正常情况下 Tracker 识别后的默认类型是<code>tracker</code>，但是再某些情况下希望用 tracker 来代替手柄实现操作，如：</p>
<ul>
<li>将 Tracker 当作 MR 的第三个摄像机，替代需要的第三只手柄</li>
<li>用 Tracker 或者 Tracker 做的外设来替代手柄玩游戏</li>
</ul>
<p>实现上面两个目标需要将 Tacker 的类型修改为 <code>controller</code>，让基站认为 Tracker 是 Controller。HTC 曾经提供过一个工具用来修改 Tracker 的类型:<a href="https://drive.google.com/file/d/0B1q70buPZSZhaXVsS29pTHRrUWM/view?usp=sharing">Vive Tracker Role Changer</a>(这个版本是 v0.8 的，最新的是 v1.0，但是由于<a href="https://community.viveport.com/t5/Developer-Support/Vive-Tracker-Role-Changer-current-version-1-0/td-p/18263"> 一些原因 </a>HTC 停止了这个软件的下载)。<br> 不使用这个工具，也可以实现相同的功能 (我这里演示的是将 Controller 修改为 Tracker 做示例)，方法如下。<br> 首先，拔掉电脑上的其他任何 VR 设备，然后使用 USB 线将 Controller/Tracker 连接到计算机。<br>打开 Steam 的安装路径(SteamVR)：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Steam\steamapps\common\SteamVR\tools\lighthouse\bin\win64</span><br></pre></td></tr></table></figure>
<p>找到<code>lighthouse_console.exe</code>，在控制台中运行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">C:\Program Files (x86)\Steam\steamapps\common\SteamVR\tools\lighthouse\bin\win64&gt;lighthouse_console.exe</span><br><span class="line">ue_version:  lighthouse_console.exe (buildbot_vortex-windows_steamvr_rel_win64@vortex-windows)  04924513</span><br><span class="line">Attached lighthouse receiver devices: 3</span><br><span class="line">        LHR-AE438993</span><br><span class="line">lighthouse_console: Connected to receiver LHR-AE438993</span><br><span class="line">Attempting HID Open IMU: LHR-AE438993</span><br><span class="line">Lighthouse IMU HID opened</span><br><span class="line">LHR-AE438993: Firmware Version 1518829406 watchman@runner-watchman 2018-02-17 FPGA 531(2.19/0/2) BL 1517470641</span><br><span class="line">Data request is out of range</span><br><span class="line">Request Starting:0x0</span><br><span class="line">Ending:0x18</span><br><span class="line">Max Address is:0x3</span><br><span class="line">LHR-AE438993: Successfully fetched gyro/accelerometer range modes from the device. GyroRangeMode:3 AccelRangeMode:2</span><br><span class="line">Attempting HID Open Optical: LHR-AE438993</span><br><span class="line">Lighthouse Optical HID opened</span><br><span class="line">Attempting HID Open VrController: LHR-AE438993</span><br><span class="line">Lighthouse VrController HID opened</span><br><span class="line">LHR-AE438993: Read config of 2214 bytes from [vid:28de, pid:2300] (LHR-AE438993) and inflated to 9317 bytes</span><br><span class="line"></span><br><span class="line">lh&gt;</span><br></pre></td></tr></table></figure>
<p>会检测到当前插入的设备 <code>LHR-AE438993</code> 并进入 <code>lh</code> 的控制台。<br>在 <code>lh</code> 控制台里输入命令:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lh&gt; downloadconfig</span><br><span class="line">LHR-AE438993: Read config of 2214 bytes from [vid:28de, pid:2300] (LHR-AE438993) and inflated to 9317 bytes</span><br><span class="line">Wrote 9317 bytes to LHR-AE438993.json</span><br></pre></td></tr></table></figure>
<p>会在当前目录下产生一个 <code>LHR-*.json</code> 文件，其中内容如下：<br><strong>一代手柄</strong>：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;acc_bias&quot;</span>: [</span><br><span class="line">        <span class="number">-0.163</span>,</span><br><span class="line">        <span class="number">0.08808</span>,</span><br><span class="line">        <span class="number">-0.2593</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;acc_scale&quot;</span>: [</span><br><span class="line">        <span class="number">1</span>,</span><br><span class="line">        <span class="number">1</span>,</span><br><span class="line">        <span class="number">0.9959</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;device_class&quot;</span>: <span class="string">&quot;controller&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;device_pid&quot;</span>: <span class="number">8210</span>,</span><br><span class="line">    <span class="attr">&quot;device_serial_number&quot;</span>: <span class="string">&quot;LHR-F7099945&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;device_vid&quot;</span>: <span class="number">10462</span>,</span><br><span class="line">    <span class="attr">&quot;gyro_bias&quot;</span>: [</span><br><span class="line">        <span class="number">0.01332</span>,</span><br><span class="line">        <span class="number">-0.003239</span>,</span><br><span class="line">        <span class="number">0.01065</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;gyro_scale&quot;</span>: [</span><br><span class="line">        <span class="number">1.0</span>,</span><br><span class="line">        <span class="number">1.0</span>,</span><br><span class="line">        <span class="number">1.0</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>二代手柄</strong>：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;device_class&quot;</span>: <span class="string">&quot;controller&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;device_pid&quot;</span>: <span class="number">8960</span>,</span><br><span class="line">    <span class="attr">&quot;device_serial_number&quot;</span>: <span class="string">&quot;LHR-AE438993&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;device_vid&quot;</span>: <span class="number">10462</span>,</span><br><span class="line">    <span class="attr">&quot;firmware_config&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;bwd_config&quot;</span>: <span class="string">&quot;0x392B&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;charge_current_low_temp_ma&quot;</span>: <span class="number">256</span>,</span><br><span class="line">        <span class="attr">&quot;charge_current_ma&quot;</span>: <span class="number">512</span>,</span><br><span class="line">        <span class="attr">&quot;charge_current_nominal_ac_ma&quot;</span>: <span class="number">768</span>,</span><br><span class="line">        <span class="attr">&quot;charge_current_nominal_usb_ma&quot;</span>: <span class="number">512</span>,</span><br><span class="line">        <span class="attr">&quot;charge_term_current_ma&quot;</span>: <span class="number">128</span>,</span><br><span class="line">        <span class="attr">&quot;charge_voltage_limit_mv&quot;</span>: <span class="number">4400</span>,</span><br><span class="line">        <span class="attr">&quot;charging_low_temp_threshold_c&quot;</span>: <span class="number">10</span>,</span><br><span class="line">        <span class="attr">&quot;mode&quot;</span>: <span class="string">&quot;controller&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;radio&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">&quot;recharge_voltage_mv&quot;</span>: <span class="number">100</span>,</span><br><span class="line">        <span class="attr">&quot;sensor_env_on_pin_a&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;spi_flash&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">&quot;sys_min_voltage_mv&quot;</span>: <span class="number">3500</span>,</span><br><span class="line">        <span class="attr">&quot;trackpad&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">&quot;trigger&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">&quot;trigger_adc_max&quot;</span>: <span class="number">3900</span>,</span><br><span class="line">        <span class="attr">&quot;trigger_adc_min&quot;</span>: <span class="number">300</span>,</span><br><span class="line">        <span class="attr">&quot;trigger_adc_zero&quot;</span>: <span class="number">400</span>,</span><br><span class="line">        <span class="attr">&quot;vrc&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到 <code>device_class</code> 标识着当前设备的类型。<br>可以将其值改为<code>controller</code>/<code>generic_tracker</code>(我这里是将 controller 变成 tracker，反过来也同理):</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;device_class&quot;</span>: <span class="string">&quot;generic_tracker&quot;</span>,</span><br></pre></td></tr></table></figure>
<p>保存并关闭文件，回到 <code>lh</code> 控制台的命令行窗口，输入以下命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lh&gt;uploadconfig</span><br></pre></td></tr></table></figure>
<p>完成之后输入 <code>exit</code> 退出 <code>lh</code>(不要直接关闭窗口)，重启 SteamVR, 然后它的设备类型就变成的<code>Tracker</code>.<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/2125/steam-change-vive-controller-to-vive-tracker.webp"><br> 相关链接：</p>
<ul>
<li><a href="https://community.viveport.com/t5/Developer-Support/Vive-Tracker-Role-Changer-current-version-1-0/td-p/18263">Vive Tracker Role Changer (current ue_version: 1.0)</a></li>
<li><a href="https://www.reddit.com/r/vive_vr/comments/aw2sor/need_vive_tracker_role_changer_10_could_someone/">Need Vive tracker role changer 1.0, could someone reupload?</a></li>
</ul>
<h3 id="SteamVR 多驱动支持"><a href="#SteamVR 多驱动支持" class="headerlink" title="SteamVR 多驱动支持"></a>SteamVR 多驱动支持 </h3><p> 需要修改 <code>Steam</code> 目录下的 <code>config/steamvr.vrsetting</code> 文件，在这个 json 格式的文件中的 <code>steamvr</code> 项下增加<code>activateMultipleDrivers</code>：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;steamvr&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;lastVersionNotice&quot;</span> : <span class="string">&quot;1.3.20&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;lastVersionNoticeDate&quot;</span> : <span class="string">&quot;1553731712&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;activateMultipleDrivers&quot;</span> : <span class="literal">true</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>保存之后重启 <code>SteamVR</code> 即可。</p>
<p>在拍摄 MR 视频时使用第三只 Controller 来作为虚拟摄像机，但是如果没有第三只 Controller 可以用一个工具来虚拟出一个 Controller:<a href="https://github.com/SecondReality/VirtualControllerDriver">VirtualControllerDriver</a>，需要启动 SteamVR 的多驱动支持。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>VirtualReality</category>
      </categories>
      <tags>
        <tag>HTC Vive</tag>
        <tag>Vive Tracker</tag>
        <tag>VR</tag>
      </tags>
  </entry>
  <entry>
    <title>Instanced Stereo Rendering</title>
    <url>/wiki/6e35506b/</url>
    <content><![CDATA[<p> 在 UE4.11 中引入了 <a href="https://docs.unrealengine.com/en-us/Platforms/VR/VRPerformance">Instanced Stereo Rendering</a>, 其原理是通过单次 draw call 来绘制双眼，进而来缩短渲染线程的时间和提高 GPU 的性能。</p>
<div class="video-container"><iframe src="https://www.youtube.com/embed/uTUwKC7GXjo" frameborder="0" loading="lazy" allowfullscreen></iframe></div>

<p> 开启方式 (<code>ProjectSetting</code>-<code>Engine</code>-<code>Rending</code>)：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/25331/UE4-EnableInstancedStereo.webp"></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>VirtualReality</category>
      </categories>
      <tags>
        <tag>VirtualReality</tag>
      </tags>
  </entry>
  <entry>
    <title>Oculus Quest Development with UE4</title>
    <url>/wiki/30042/</url>
    <content><![CDATA[<p><a href="https://www.oculus.com/quest/">Oculus Quest</a>是 Oculus 发布的新一代支持 6DoF 的 VR 一体机设备，不需要连接 PC 以及额外的定位基站，而且支持 Guardian，当戴着头显走出定位边界时，头显中会立即显示现实中的画面，防止玩家误碰出现意外情况。<br><a href="https://www.oculus.com/quest/">Oculus Quest</a>使用两个 <code>Pentile OLED</code> 的屏幕，单眼分辨率为 <code>1440x1600</code>，刷新率为<code>72Hz</code>，使用的是<code>arm</code> 架构的高通骁龙 835 处理器，与两年前的 Android 旗舰级的处理器相同 (如小米 6、三星 S8)。<br>Quest 使用的是<code>Oculus Insight</code>(inside-out tracing) 定位方案，使用四枚摄像头进行位置追踪，分别位于头显面板的四角。<br>发布会时对 Oculus Insight 的介绍：<a href="https://www.youtube.com/watch?v=2jY3B_F3GZk">Oculus Insight VR Positional Tracking System (Sep 2018)</a></p>
<p>以及国外的一个老哥对 Quest 追踪范围的测试视频：<a href="https://drive.google.com/file/d/1-bqNmwUi8J57yykxLP6szgiLeU3IgdgL/view">Quest Distance Test</a>.</p>
<p><code>Oculus Quest</code>64G 存储版本的售价为 399 刀，128G 的为 499 刀，不计税的价格大概是 3500；相比较 HTC 的同类新产品 (HTC Vive Focus) 是便宜了不少，与 PC-Base VR 相比那就更具优势了，还不需要一台高性能的主机，我觉得 6DoF 的 VR 一体机设备一定是未来的趋势！</p>
<blockquote>
<p>国庆前的 OC6，Oculus 发布了 Oculus Link 和 finger tracking 两项技术，十分厉害，十分看好。</p>
</blockquote>
<p>整套 Quest 设备的大小与 <code>10.5</code> 寸的 iPad 差不多，提个小包就能带走：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/30042/20190925000314.webp"></p>
<p>Quest 设备的参数细节不再多说，本篇文章的主要内容是使用 UE 来开发 Quest 项目时的环境部署、开发文档、调试工具以及额外的注意事项，会持续更新。</p>
<span id="more"></span>
<p>首先想要在 Quest 上打包测试应用需要先打开 Quest 的开发者模式。</p>
<p>首先用一根 Type-C 的数据线将 Quest 连接至电脑，在头显中会提示是否允许 USB 调试，勾选允许。<br>之后就可以在 PC 上用 <a href="https://developer.android.com/studio/command-line/adb">Adb</a> 连接到 Quest 了，Quest 上的系统也是基于 Android 的，可以使用 <a href="https://developer.android.com/studio/command-line/adb">Adb</a> 进行调试。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb shell</span><br></pre></td></tr></table></figure>
<p>就可以连接到 Quest 设备了，可以查看 <code>/system/build.props</code> 查看设备信息。我导出了一份：<a href="https://gist.github.com/hxhb/0c72c436044e97f3f11ea44ad7f92912">build.props</a>。</p>
<p>也可以直接使用 adb 来安装 apk：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb install xxxx.apk</span><br></pre></td></tr></table></figure>

<p>另外可以使用 <a href="https://github.com/the-expanse/SideQuest">SideQuest</a> 这个开源工具在 PC 上管理基于 Android 的 VR 设备，当然 Quest 也适用，可以安装或者卸载软件。</p>
<h3 id="Oculus-Developer-Mode"><a href="#Oculus-Developer-Mode" class="headerlink" title="Oculus Developer Mode"></a>Oculus Developer Mode</h3><p>在进行真正的开发环境设置之前，需要将 Quest 开启 <strong> 开发者模式 </strong>，设置开发者模式的前提是需要在<a href="https://dashboard.oculus.com/">Oculus Dashboard</a> 上加入或者 <a href="https://dashboard.oculus.com/organizations/create/"> 创建 </a> 开发者组织。</p>
<p>然后使用具有开发者组织的 Oculus 账号登陆移动端的<code>Oculus</code>App：</p>
<ul>
<li>iOS 版本的可以从 App Store 安装：<a href="https://apps.apple.com/us/app/oculus/id1366478176">Oculus for iOS</a></li>
<li>Android 可以从 Google Play 安装：<a href="https://play.google.com/store/apps/details?id=com.oculus.twilight&hl=en_US">Oculus for Android</a>，国内没有 GMS 环境的可以从我下载的 apk 直接安装:<a href="https://stusdnueducn-my.sharepoint.com/:u:/g/personal/2017020625_stu_sdnu_edu_cn/EY8fEpU2L1VBk2EbDnQJKywBIzPBmRMIzySCX85MXFZ_IA?e=rtDrIQ">下载地址</a>.</li>
</ul>
<p>安装之后，登录账号，找到与账号关联的 Quest 设备，选择 <strong> 更多设置 </strong>：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/30042/oculus-quest-enable-advance-setting.webp"><br> 然后找到 <strong> 开发者模式</strong>，启用即可。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/30042/oculus-quest-enable-development-mode.webp"></p>
<p>启用之后就可以在 Quest 里的 <code>Library</code> 下看到<code>Unknow Source</code>，也就是未知来源应用了(后续测试安装的都在这个分类下)。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/30042/oculus-quest-vr-view-unkonw-source.webp"></p>
<h3 id="NVIDIA-CodeWorks-for-Android"><a href="#NVIDIA-CodeWorks-for-Android" class="headerlink" title="NVIDIA CodeWorks for Android"></a>NVIDIA CodeWorks for Android</h3><p>因为本质上 Quest 跑的就是 Android 系统，所以我们打包的游戏就是安卓上的 apk，那么为了能顺利打包成功 apk，则需要安装 Android 的开发环境。<br>我们需要安装 <code>android-sdk</code>/<code>jdk</code>/<code>android-ndk</code>/<code>gradle</code>/<code>apache-ant</code> 等一系列环境，不过一个好消息是，NVIDIA 有一个 <a href="https://developer.nvidia.com/codeworks-android">NVIDIA CodeWorks for Android</a> 能够极大简化安装 Android 开发环境的流程。</p>
<p>各个平台的 <code>CodeWorks for Android</code> 安装包可以从 UE 引擎的下列目录找到：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UE_4.23_Source\Engine\Extras\AndroidWorks\Win64</span><br></pre></td></tr></table></figure>
<p>也可以从 NVIDIA 的 <a href="https://developer.nvidia.com/gameworksdownload#?dn=codeworks-for-android-1r8">Download Center</a> 下载。<br>启动安装，选择 <code> 安装目录 </code> 和<code>下载目录</code>：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/30042/preinstall-nvidia-codeworks-for-android.webp"></p>
<p>安装完成之后打开安装路径(默认在<code>C:\NVPACK\</code>)，启动<code>Chooser.exe</code>：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/30042/install-nvidia-codeworks-for-android.webp"></p>
<p>选择 <code>Standard</code> 之后点击右下角的 <code>Next</code> 即可开始下载并安装。<br>鉴于国内的网络环境实在太差，有些库确实下载不下来，我把 <code>Standard</code> 下所有的都下载下来了，下载地址：<a href="https://stusdnueducn-my.sharepoint.com/:f:/g/personal/2017020625_stu_sdnu_edu_cn/ErTM0Ov4H6FOoCoPKb1IaLoBevJ1J_M3vRqwEFNSUtTGZQ?e=If69z7">CodeWorks_1R7</a>，下载之后将其放到安装 <code>CodeWorks</code> 时选择的下载目录中，然后重新启动 <code>Chooser.exe</code>，点击<code>Next</code> 它会自己验证并且安装。</p>
<blockquote>
<p>如果不想安装 CodeWorks，则可以仅仅只下载 Android 环境：<a href="https://stusdnueducn-my.sharepoint.com/:u:/g/personal/2017020625_stu_sdnu_edu_cn/EbE_rZl0OVpOrfyNOZ9DlGsBX0q-AcZHGvKhCz9JwBS5RA?e=pTGgQf">NVPACK_1R7u1_20190923</a>，然后把下面的环境变量添加进系统中。</p>
</blockquote>
<p>安装完成之后会在系统中自动添加下列环境变量：</p>
<table>
<thead>
<tr>
<th>Environment var NAME</th>
<th>Value</th>
</tr>
</thead>
<tbody><tr>
<td>ANDROID_HOME</td>
<td>C:\NVPACK\android-sdk-windows</td>
</tr>
<tr>
<td>ANDROID_NDK_ROOT</td>
<td>C:\NVPACK\android-ndk-r14b</td>
</tr>
<tr>
<td>ANT_HOME</td>
<td>C:\NVPACK\apache-ant-1.8.2</td>
</tr>
<tr>
<td>GRADLE_HOME</td>
<td>C:\NVPACK\gradle-4.1</td>
</tr>
<tr>
<td>JAVA_HOME</td>
<td>C:\NVPACK\jdk1.8.0_77</td>
</tr>
<tr>
<td>NDK_ROOT</td>
<td>C:\NVPACK\android-ndk-r14b</td>
</tr>
<tr>
<td>NDKROOT</td>
<td>C:\NVPACK\android-ndk-r14b</td>
</tr>
<tr>
<td>NVPACK_NDK_TOOL_VERSION</td>
<td>4.9</td>
</tr>
<tr>
<td>NVPACK_NDK_VERSION</td>
<td>android-ndk-r14b</td>
</tr>
<tr>
<td>NVPACK_ROOT</td>
<td>D:\NVPACK</td>
</tr>
</tbody></table>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/30042/system-environment-variable.webp"><br>这些环境变量在 UE 项目的 <code>Project Setting</code>-<code>Android SDK</code> 中被用到。</p>
<blockquote>
<p>注意：最好确保环境变量的路径中没有特殊字符，纯数字 + 字母最好的。</p>
</blockquote>
<h3 id="Create-Quest-Project-with-UE4"><a href="#Create-Quest-Project-with-UE4" class="headerlink" title="Create Quest Project with UE4"></a>Create Quest Project with UE4</h3><p>首先启动 Unreal Engine，我使用是从 EpicLauncher 安装的 UE_4.21.2 版本。<br>为了方便测试，我创建了一个 VR Template 项目，注意 <code>Target</code> 选为<code>Mobile</code>：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/30042/ue4-create-quest-project.webp"></p>
<ol start="0">
<li><p>创建完成启动 UE Editor 之后，先检查 <code>Oculus VR</code> 插件有没有启用。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/30042/ue-editor-enable-oculus-vr-plugin.webp"></p>
</li>
<li><p>打开 <code>Project Setting</code>-<code>Engin</code>-<code>Input</code> 确认 <code>Mobile</code>-<code>Default Touch Interface</code> 是<code>none</code>：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/30042/ue4-project-setting-Engine-Input.webp"></p>
</li>
<li><p>打开 <code>Project Setting</code>-<code>Engine</code>-<code>Rending</code> 确认 <code>Mobile HDR</code> 是关闭的：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/30042/ue4-project-setting-engine-rending.webp"></p>
</li>
<li><p>打开 <code>Project Setting</code>-<code>Platform</code>-<code>Android SDK</code><br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/30042/ue4-project-setting-android-sdk.webp"><br> 这里主要是设置 Android 开发环境的路径，如 SDK/NDK/JDK，可以看上图的提示，如果不指定就会从系统中查找指定 NAME 的环境变量，因为我们安装 CodeWorks 时它已经帮我们添加了，此处可以忽略，如果是自己安装的环境则需要在这里指定或者直接添加到系统的环境变量。</p>
</li>
<li><p>打开 <code>Priject Setting</code>-<code>Platform</code>-<code>Android</code><br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/30042/ue4-project-setting-android.webp"><br> 分别执行 <code>Configure Now</code> 和<code>Accept SDK License</code>。</p>
<blockquote>
<p>注意：如果不执行 <code>Accept SDK License</code> 会在 Launch 时遇到 <code>License not accepted</code> 错误。</p>
</blockquote>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">License not accepted. SDK License must be accepted <span class="keyword">in</span> the Android project settings to deploy your app to the device.  </span><br></pre></td></tr></table></figure>
<p>将 <code>Minimum SDK Version</code> 设置为 <code>25</code>，<code>Target SDK Version</code> 设置为<code>26</code>。<br> 以及启用 <code>Enable FullScreen Immersive on KitKat and above device</code>。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/30042/ue4-setting-android-seted.webp"><br> 之后向下滚动找到<code>Advanced APK Packing</code>，并启用下列两项：</p>
<ul>
<li><code>Configure the AndroidManifest for deployment to Oculus Mobile</code></li>
<li><code>Rmove Oculus Signature File From Distribution APK</code></li>
</ul>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/30042/ue4-setting-android-remove-oculus-signature-and-configuration-androidManifest.webp"></p>
<ol start="5">
<li>打开 <code>Priject Setting</code>-<code>Project</code>-<code>Supported Platforms</code> 启用<code>Android</code>；</li>
<li>将该 VR 模板项目的 <code>Editor Startup Map</code> 以及 <code>Game Default Map</code> 改为<code>MotionControllerMap</code>；</li>
<li>使用 Type-C 的 USB 线将 Quest 连接至 PC；</li>
<li>关闭 Editor，重启项目；</li>
</ol>
<p>重启项目之后即可在编辑器工具栏的 <code>Launch</code> 下找到 <code>Quest</code>：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/30042/ue4-editor-launnch-quest.webp"><br> 启动即可开始编译并在 Quest 中测试当前项目 (会被自动安装到 Quest 中，在<code>Unknow Source</code> 下)。</p>
<p>如果在 Launch 或者打包时遇到 <code>:app:assembleDebug</code> 错误，则将 <code>Project Setting</code>-<code>Platform</code>-<code>Android</code> 下的 <code>Enable Grade instead of Ant</code> 关闭即可；如果非要用 <code>grade</code> 则检查 <code>JAVE_HOME</code> 环境变量设置的路径中是否含有特殊字符，最好只有数字 + 字母。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/30042/ue4-package-android-error-assdebug.webp"></p>
<blockquote>
<p>如果想要使用 Vulkan，则需要将 UE 升级到 4.22.2+.</p>
</blockquote>
<h3 id="解决 Quest 只追踪一只手柄"><a href="# 解决 Quest 只追踪一只手柄" class="headerlink" title="解决 Quest 只追踪一只手柄"></a>解决 Quest 只追踪一只手柄 </h3><p> 在第一次启动之后测试发现，在游戏中同一时刻只有一只手柄可以被控制，无法同时使用两只手柄。本来以为是 bug，查了一些资料后发现，这是因为没有在打包时强制指定要求 6DoF，详见文档：<a href="https://developers.google.com/vr/develop/android/3dof-to-6dof">Enabling 6DoF head tracking</a>。<br>项目中默认的是没有指定 <code>3DoF</code> 还是 <code>6DoF</code>，默认是<code>3DoF</code> 的，所以只有一只手柄能够追踪。</p>
<p>解决的办法是在 <code>Intermediate/Android/APK/AndroidManifest.xml</code> 中添添加：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-feature</span></span></span><br><span class="line"><span class="tag"> <span class="attr">android:name</span>=<span class="string">&quot;android.hardware.vr.headtracking&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">android:version</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">android:required</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>但是，因为 <code>AndroidManifest.xml</code> 是被生成出来的，我们直接修改文件也会被覆盖，所以应该添加到项目的设置中：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/30042/ue4-project-setting-android-extra-permissions.webp"></p>
<p>看介绍，也可以编辑在 <code>Build/Android/ManifestRequirementsOverride.txt</code>(若不存在，手动创建)，它会<strong> 替换 </strong> 生成的 <code>AndroidManifest.xml</code> 中的 <code>Requirements</code> 部分，所以需要把已经生成的 <code>AndroidManifest.xml</code> 的<code>Requirements</code>部分加上强制启用 <code>6DoF</code> 的<code>user-feature</code>保存到 <code>Build/Android/ManifestRequirementsOverride.txt</code> 中：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Requirements --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-sdk</span> <span class="attr">android:minSdkVersion</span>=<span class="string">&quot;25&quot;</span> <span class="attr">android:targetSdkVersion</span>=<span class="string">&quot;25&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-feature</span> <span class="attr">android:name</span>=<span class="string">&quot;android.hardware.vr.headtracking&quot;</span> <span class="attr">android:version</span>=<span class="string">&quot;1&quot;</span> <span class="attr">android:required</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-feature</span> <span class="attr">android:glEsVersion</span>=<span class="string">&quot;0x00020000&quot;</span> <span class="attr">android:required</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.ACCESS_NETWORK_STATE&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.WAKE_LOCK&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;com.android.vending.CHECK_LICENSE&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.ACCESS_WIFI_STATE&quot;</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Supported texture compression formats (cooked) --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">supports-gl-texture</span> <span class="attr">android:name</span>=<span class="string">&quot;GL_KHR_texture_compression_astc_ldr&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.READ_EXTERNAL_STORAGE&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-feature</span> <span class="attr">android:name</span>=<span class="string">&quot;android.hardware.usb.host&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>重新运行或打包即可。</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=SCl75YIUyAU">How to Fix Only One Controller Tracking on Oculus Quest (after the v7 update - using UE 4.22)</a></li>
</ul>
<h3 id="Package-and-Install"><a href="#Package-and-Install" class="headerlink" title="Package and Install"></a>Package and Install</h3><p>在 UE 中打包 Android 程序时有这个几个不同的可选 Texture 格式，目的是针对不同的硬件使用不同格式的压缩纹理：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/30042/ue4-package-android-texture-format.webp"></p>
<blockquote>
<p>Not all Android devices are made the same. In particular, there are 4 different kinds of rendering hardware. They each support different formats of compressed textures.</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">Format</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>ETC1</strong></td>
<td>Supported by all Android based devices but cannot compress alpha textures (they are stored uncompressed). Recommend using an RGB and a separate alpha texture if need alpha to get better compression.</td>
</tr>
<tr>
<td align="center"><strong>ETC2</strong></td>
<td>Supported by all OpenGL 3.x class devices and supports alpha compression.</td>
</tr>
<tr>
<td align="center"><strong>ATC</strong></td>
<td>Supported by Qualcomm Adreno GPUs and supports alpha compression.</td>
</tr>
<tr>
<td align="center"><strong>DXT</strong></td>
<td>Supported by Nvidia Tegra GPUs and supports alpha compression.</td>
</tr>
<tr>
<td align="center"><strong>PVRTC</strong></td>
<td>supported by PowerVR GPUs and supports alpha compression.</td>
</tr>
<tr>
<td align="center"><strong>ASTC</strong></td>
<td>Latest Texture compression format allowing more quality control by specifying block size and supports alpha compression. Available on some devices at this point and will be required for Vulkan Level 1.</td>
</tr>
</tbody></table>
<p>UE 文档的详细介绍：<a href="https://docs.unrealengine.com/en-US/Platforms/Mobile/Android/Reference/index.html">Android Development Reference</a></p>
<p>因为 Quest 使用的是 <strong> 高通骁龙 835</strong>，所以打包时选择 <code>ATC</code> 即可。</p>
<p>打包完成之后在 <code>Binaries/Android</code> 目录下会有如下文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+---Binaries</span><br><span class="line">|   \---Android</span><br><span class="line">|           Install_QuestTemp-armv7-es2.bat</span><br><span class="line">|           main.1.com.imzlp.QuestTemp.obb</span><br><span class="line">|           QuestTemp-armv7-es2.apk</span><br><span class="line">|           Uninstall_QuestTemp-armv7-es2.bat</span><br></pre></td></tr></table></figure>

<p>其中的 <code>apk</code> 与<code>obb</code>就是我们打包出来的游戏程序和数据包。<br>可以使用 <code>adb</code> 命令来安装 apk 和拷贝 obb 数据包。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb install QuestTemp-armv7-es2.apk</span><br><span class="line">20002 KB/s (47579881 bytes <span class="keyword">in</span> 2.322s)</span><br><span class="line">Success</span><br></pre></td></tr></table></figure>

<p>然后将数据包拷贝到 <code>/sdcard/Android/obb/com.imzlp.QuestTemp/</code> 目录下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb push main.1.com.imzlp.QuestTemp.obb /sdcard/Android/obb/com.imzlp.QuestTemp/main.1.com.imzlp.QuestTemp.obb</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当然直接执行 <code>Install_QuestTemp-armv7-es2.bat</code> 也是可以的，它里面也是执行了这么几条指令。</p>
</blockquote>
<h3 id="VR-Template-Video"><a href="#VR-Template-Video" class="headerlink" title="VR Template Video"></a>VR Template Video</h3><p>我简单录了一个这个 VR Template 在 Quest 上运行的一个视频：<a href="https://youtu.be/BbS-6PywD-g">Oculus Quest Template</a>，可以看到定位还是十分稳定的。</p>
<div class="video-container"><iframe src="https://www.youtube.com/embed/BbS-6PywD-g" frameborder="0" loading="lazy" allowfullscreen></iframe></div>

<h3 id="PC-View"><a href="#PC-View" class="headerlink" title="PC View"></a>PC View</h3><p>不同于 PC VR 在测试时可以直接把 VR 视角显示在 PC 显示器上，Quest 的视角想要在 PC 上实时预览 Quest 的视角除了投屏之外可以使用 <a href="https://github.com/Genymobile/scrcpy">scrcpy</a> 这个开源工具，它是专门用于显示和控制 Android 设备的，我经常用它来控制手机，需要使用数据线连接设备，使用 adb 连接。<a href="https://github.com/Genymobile/scrcpy">scrcpy</a>在对 Quest 使用时显示的是双眼视角：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/30042/scrpcy-quest-view.webp"></p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/30042/scrpcy-quest-view-2.webp"></p>
<h3 id="Debug-and-Performance"><a href="#Debug-and-Performance" class="headerlink" title="Debug and Performance"></a>Debug and Performance</h3><p>那么我们怎么查看在 Quest 运行的程序的参数呢，比如帧率、机器的负载情况。<br>可以使用 Android 的 Debug 工具 <code>adb</code> 与<code>logcat</code>命令来查看：<a href="https://developer.oculus.com/documentation/mobilesdk/latest/concepts/book-anddebug/">Android Debugging</a>，以及 <code>logcat</code> 支持的参数：<a href="https://developer.android.com/studio/command-line/logcat?hl=zh-cn">Logcat 命令行工具</a>。</p>
<p>首先，将 Quest 使用 USB 连接 PC，启动游戏，然后在 cmd 的窗口中输入以下命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb logcat -s VrApi</span><br></pre></td></tr></table></figure>
<p>之后就会看到一堆的输出：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">C:\Users\visionsmile&gt;adb logcat -s VrApi</span><br><span class="line">--------- beginning of system</span><br><span class="line">--------- beginning of main</span><br><span class="line">09-28 23:00:12.250 18371 18386 D VrApi   : targetSDKVersion 25</span><br><span class="line">09-28 23:00:12.256 18371 18386 I VrApi   : DEVICE MODEL NUMBER = Quest</span><br><span class="line">09-28 23:00:12.256 18371 18386 I VrApi   : DEVICE HARDWARE = monterey</span><br><span class="line">09-28 23:00:12.256 18371 18386 I VrApi   : DEVICE BUILD NAME = user-358570.9320.0</span><br><span class="line">09-28 23:00:12.256 18371 18386 I VrApi   : DEVICE BUILD TYPE = user</span><br><span class="line">09-28 23:00:12.256 18371 18386 I VrApi   : DEVICE OS VERSION = 7.1.1</span><br><span class="line">09-28 23:00:12.256 18371 18386 I VrApi   : VRAPI VERSION = 1.1.25.0-171385671-171385671 Sep  7 2019 04:35:06 Development RELEASE</span><br><span class="line">09-28 23:00:12.256 18371 18386 I VrApi   : VRAPI LOADER VERSION = 1.1.16.0</span><br><span class="line">09-28 23:00:12.256 18371 18386 I VrApi   : VRDRIVER VERSION = 8.0.0.148.626</span><br><span class="line">09-28 23:00:12.256 18371 18386 I VrApi   : APP NAME = QuestTemp</span><br><span class="line">09-28 23:00:12.256 18371 18386 I VrApi   : APP VERSION = 1.0 versionCode 1 internalVersionName &lt;none&gt;</span><br><span class="line">09-28 23:00:12.256 18371 18386 I VrApi   : APP VR TYPE = vr_only</span><br><span class="line">09-28 23:00:12.256 18371 18386 I VrApi   : APP PACKAGE NAME = com.imzlp.QuestTemp</span><br><span class="line">09-28 23:00:12.256 18371 18386 I VrApi   : APP ACTIVITY CLASS = com.epicgames.ue4.GameActivity</span><br><span class="line">09-28 23:00:12.256 18371 18386 I VrApi   : ovrModeParms::VRAPI_MODE_FLAG_ALLOW_POWER_SAVE = 1</span><br><span class="line">09-28 23:00:12.256 18371 18386 I VrApi   : ovrModeParms::VRAPI_MODE_FLAG_RESET_WINDOW_FULLSCREEN = 1</span><br><span class="line">09-28 23:00:12.256 18371 18386 I VrApi   : ovrModeParms::VRAPI_MODE_FLAG_NATIVE_WINDOW = 1</span><br><span class="line">09-28 23:00:12.256 18371 18386 I VrApi   : ovrModeParms::VRAPI_MODE_FLAG_FRONT_BUFFER_PROTECTED = 0</span><br><span class="line">09-28 23:00:12.256 18371 18386 I VrApi   : ovrModeParms::VRAPI_MODE_FLAG_FRONT_BUFFER_565 = 0</span><br><span class="line">09-28 23:00:12.256 18371 18386 I VrApi   : ovrModeParms::VRAPI_MODE_FLAG_FRONT_BUFFER_SRGB = 0</span><br><span class="line">09-28 23:00:12.256 18371 18386 I VrApi   : ovrModeParms::VRAPI_MODE_FLAG_CREATE_CONTEXT_NO_ERROR = 0</span><br><span class="line">09-28 23:00:12.256 18371 18386 I VrApi   : HMD sensor attached.</span><br><span class="line">09-28 23:00:12.264 18371 18386 I VrApi   : Client side frame sync enabled</span><br><span class="line">09-28 23:00:12.276 18371 18386 I VrApi   : OVR::Stats thread started</span><br><span class="line">09-28 23:00:12.287 18371 18386 I VrApi   : System brightness = 255</span><br><span class="line">09-28 23:00:12.295 18371 18519 D VrApi   : targetSDKVersion 25</span><br><span class="line">09-28 23:00:12.300 18371 18386 I VrApi   : Set brightness to 255</span><br><span class="line">09-28 23:00:12.303 18371 18386 I VrApi   : Set DND mode to true</span><br><span class="line">09-28 23:00:12.329 18371 18386 I VrApi   : System DND mode = true</span><br><span class="line">09-28 23:00:12.329 18371 18386 I VrApi   : ---------- vrapi_EnterVrMode [end] ----------</span><br><span class="line">09-28 23:00:12.365 18371 18520 I VrApi   : ovr_HandleHmdEvents: HMT was mounted</span><br><span class="line">09-28 23:00:13.532 18371 18519 I VrApi   : FPS=23,Prd=47ms,Tear=0,Early=0,Stale=1,VSnc=1,Lat=1,Fov=0,CPU4/GPU=3/3,1958/515MHz,OC=FF,TA=0/E0/E0,SP=N/F/F,Mem=1804MHz,Free=1588MB,PSM=0,PLS=0,Temp=28.0C/0.0C,TW=3.40ms,App=10.26ms,GD=3.30ms,CPU&amp;GPU=9.47ms,LCnt=1,GPU%=0.62,CPU%=0.29(W0.33)</span><br><span class="line">09-28 23:00:14.341 18371 18519 I VrApi   : FPS=72,Prd=45ms,Tear=1,Early=62,Stale=10,VSnc=1,Lat=1,Fov=0,CPU4/GPU=3/3,1958/515MHz,OC=FF,TA=0/E0/E0,SP=N/F/F,Mem=1804MHz,Free=1592MB,PSM=0,PLS=0,Temp=28.0C/0.0C,TW=3.75ms,App=8.58ms,GD=0.00ms,CPU&amp;GPU=9.06ms,LCnt=1,GPU%=0.76,CPU%=0.27(W0.32)</span><br><span class="line">09-28 23:00:15.341 18371 18519 I VrApi   : FPS=72,Prd=45ms,Tear=0,Early=69,Stale=0,VSnc=1,Lat=1,Fov=0,CPU4/GPU=2/3,1651/515MHz,OC=FF,TA=0/E0/E0,SP=N/F/F,Mem=1804MHz,Free=1593MB,PSM=0,PLS=0,Temp=28.0C/0.0C,TW=2.96ms,App=9.17ms,GD=0.65ms,CPU&amp;GPU=9.24ms,LCnt=1,GPU%=0.77,CPU%=0.27(W0.33)</span><br></pre></td></tr></table></figure>
<p>可以看到 <code>VrApi</code> 输出的内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">FPS=72,Prd=45ms,Tear=0,Early=69,Stale=0,VSnc=1,Lat=1,Fov=0,CPU4/GPU=2/3,1651/515MHz,OC=FF,TA=0/E0/E0,SP=N/F/F,Mem=1804MHz,Free=1593MB,PSM=0,PLS=0,Temp=28.0C/0.0C,TW=2.96ms,App=9.17ms,GD=0.65ms,CPU&amp;GPU=9.24ms,LCnt=1,GPU%=0.77,CPU%=0.27(W0.33)</span><br></pre></td></tr></table></figure>
<p>这是当前 Quest 中的跑游戏时设备的各种参数。<br>这些参数的含义可以从 Oculus Quest 的文档中查看：</p>
<ul>
<li><a href="https://developer.oculus.com/documentation/mobilesdk/latest/concepts/mobile-logcat-perf-stats/">Basic Performance Stats through Logcat</a></li>
</ul>
<h3 id="Capture-video-for-Quest"><a href="#Capture-video-for-Quest" class="headerlink" title="Capture video for Quest"></a>Capture video for Quest</h3><p>Oculus 的 CTO 是游戏开发界的传奇人物——<a href="https://zh.wikipedia.org/zh-hans/%E7%B4%84%E7%BF%B0%C2%B7%E5%8D%A1%E9%A6%AC%E5%85%8B">约翰·卡马克 (john camark)</a>，他近期(2019.10.18) 在 twitter 提到了在 Go/Quest 中满帧录屏的一个方法：</p>
<blockquote>
<p><a href="https://twitter.com/ID_AA_Carmack/status/1184970761410351105">twitter link</a>：If you want to capture full 60/72 fps video on Go/Quest instead of half rate, you can ‘adb shell setprop debug.oculus.fullRateCapture 1’.</p>
</blockquote>
<p>即使用 adb 命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ adb shell setprop debug.oculus.fullRateCapture 1</span><br></pre></td></tr></table></figure>

<h3 id="Documents-and-Tutorial"><a href="#Documents-and-Tutorial" class="headerlink" title="Documents and Tutorial"></a>Documents and Tutorial</h3><p>Oculus Quest 的开发文档：</p>
<ul>
<li><a href="https://developer.oculus.com/documentation/quest/latest/concepts/unreal-engine/">Oculus Quest - Unreal</a></li>
<li><a href="https://developer.oculus.com/documentation/mobilesdk/latest/concepts/book-perfanalysis/">Application Performance Analysis</a></li>
<li><a href="https://developer.oculus.com/distribute/latest/concepts/publish-quest-req/">Quest Virtual Reality Check (VRC) Guidelines</a></li>
</ul>
<p>UE 的 Android 开发文档：</p>
<ul>
<li><a href="https://docs.unrealengine.com/en-US/Platforms/Mobile/Android/Reference/index.html">Android Development Reference</a></li>
</ul>
<p>视频教程：</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=hEtu-ciPc7g">Using UE4 to Develop for Oculus Rift and Oculus Quest | Unreal Fest Europe 2019 | Unreal Engine</a></li>
<li><a href="https://www.youtube.com/watch?v=jlcj4HB9LX8">How to Build for Oculus Quest using Unreal Engine</a></li>
<li><a href="https://www.youtube.com/watch?v=SCl75YIUyAU">How to Fix Only One Controller Tracking on Oculus Quest (after the v7 update - using UE 4.22)</a></li>
<li><a href="https://www.youtube.com/watch?v=N7UfYFq2Xq4">Oculus Quest Performance Profiling and Performance Optimization</a></li>
</ul>
<h3 id="Assets-Download"><a href="#Assets-Download" class="headerlink" title="Assets Download"></a>Assets Download</h3><p>本文内所有的资源：</p>
<ul>
<li><a href="https://stusdnueducn-my.sharepoint.com/:f:/g/personal/2017020625_stu_sdnu_edu_cn/ErTM0Ov4H6FOoCoPKb1IaLoBevJ1J_M3vRqwEFNSUtTGZQ?e=If69z7">CodeWorks_1R7</a></li>
<li><a href="https://stusdnueducn-my.sharepoint.com/:u:/g/personal/2017020625_stu_sdnu_edu_cn/EbE_rZl0OVpOrfyNOZ9DlGsBX0q-AcZHGvKhCz9JwBS5RA?e=pTGgQf">NVPACK_1R7u1_20190923</a></li>
<li><a href="https://github.com/the-expanse/SideQuest/releases">SideQuest</a></li>
<li><a href="https://github.com/Genymobile/scrcpy">scrcpy</a></li>
<li><a href="https://github.com/hxhb/oculus-quest-template">Oculus Quest VR Template Project：QuestTemp</a></li>
<li>打包出来的 QuestTemp：<a href="https://stusdnueducn-my.sharepoint.com/:u:/g/personal/2017020625_stu_sdnu_edu_cn/ERiJmF8KLLBJuKQ8yLKswUgBk2_oChRqC_nEvH-A31_Xug?e=J6fdGx">QuestTemp-armv7-es2.7z</a></li>
</ul>
<h3 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h3><p><strong>Not-PC based VR</strong>:</p>
<ul>
<li><a href="https://developers.google.com/vr">Google VR</a></li>
<li><a href="https://developer.oculus.com/quest/">Oculus Quest</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>VirtualReality</category>
      </categories>
      <tags>
        <tag>VR</tag>
        <tag>Oculus Quest</tag>
        <tag>Oculus</tag>
      </tags>
  </entry>
  <entry>
    <title>VR 硬件适配与调试经验</title>
    <url>/wiki/92565514/</url>
    <content><![CDATA[<h3 id="UE 适配不同 VR 设备的高度问题"><a href="#UE 适配不同 VR 设备的高度问题" class="headerlink" title="UE 适配不同 VR 设备的高度问题"></a>UE 适配不同 VR 设备的高度问题 </h3><p> 在 UE 适配 Oculus Rift 和 HTC Vive 时注意把 <code>TrackingOrigin</code>(<a href="http://api.unrealengine.com/INT/API/Runtime/Engine/Kismet/EHMDTrackingOrigin__Type/index.html">EHMDTrackingOrigin::Type</a>) 改为<code>Floor</code>，不然默认的追踪起源是在眼睛位置，导致头盔位置在游戏场景中高度不对。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/3380/UE-Adaptive-OculusRift-And-Vive-Stracking-Origin-Setting.webp"></p>
<p>还有一个问题是，使用 <code>PlayerStart</code> 放置时，<code>PlayerStart</code>是有高度的，所以高度可能是不对的 (取决于你的 Pawn 是怎么写的)，解决的办法是可以重写<code>AGameModeBase</code> 的<code>SpawnDefaultPawnAtTransform</code>，来指定高度。</p>
<h3 id="UE 中游戏启动 VR 头显初始化"><a href="#UE 中游戏启动 VR 头显初始化" class="headerlink" title="UE 中游戏启动 VR 头显初始化"></a>UE 中游戏启动 VR 头显初始化</h3><p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/3380/unreal-vr-glass-init.webp"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Stereo On/Off</span><br><span class="line">Notice: Enables or Disables stereo rendering for Head Mounted Display (HMD) devices.</span><br></pre></td></tr></table></figure>

<h3 id="重置 VR 头显旋转和位置"><a href="# 重置 VR 头显旋转和位置" class="headerlink" title="重置 VR 头显旋转和位置"></a>重置 VR 头显旋转和位置 </h3><p> 因为 VR 头显默认的朝向 X 轴是与房间设置的定位有关的，所以，当我们初始就与定位时的朝向偏离时，进入游戏就会偏离我们设定让玩家看到的东西，所以需要进行修正。<br>可以使用以下函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Resets orientation by setting roll and pitch to 0, assuming that current yaw is forward direction and assuming</span></span><br><span class="line"><span class="comment"> * current position as a &#x27;zero-point&#x27; (for positional tracking). </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param Yaw				(in) the desired yaw to be set after orientation reset.</span></span><br><span class="line"><span class="comment"> * @param Options			(in) specifies either position, orientation or both should be reset.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="built_in">UFUNCTION</span>(BlueprintCallable, Category=<span class="string">&quot;Input|HeadMountedDisplay&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ResetOrientationAndPosition</span><span class="params">(<span class="keyword">float</span> Yaw = <span class="number">0.f</span>, EOrientPositionSelector::Type Options = EOrientPositionSelector::OrientationAndPosition)</span></span>;</span><br></pre></td></tr></table></figure>
<p>蓝图中也是同名的节点。</p>
<h3 id="在 UE 中使用 Oculus-Rift"><a href="# 在 UE 中使用 Oculus-Rift" class="headerlink" title="在 UE 中使用 Oculus Rift"></a>在 UE 中使用 Oculus Rift</h3><p>在 Oculus Rift 设备安装完成之后需要在 Oculus 商店中启用<code>Unknow Source</code>，不然无法在 UE 中使用 Oculus Rift 预览。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/3380/oculus-rift-setting.webp"></p>
<p>Unreal 的文档中适配 Oculus Rift 的页面：<a href="https://docs.unrealengine.com/latest/INT/Platforms/Oculus/index.html">Developing for Oculus Rift</a>.</p>
<p>Oculus 官方提供的按键操作介绍：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/3380/Oculus-touch-controller-map.webp"></p>
<p>以及 Oculus Rift 在 UE 中的按键映射：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/3380/oculus-rift-key-mapping-on-ue4.webp"></p>
<h3 id="HTC-Vive 的按键映射"><a href="#HTC-Vive 的按键映射" class="headerlink" title="HTC Vive 的按键映射"></a>HTC Vive 的按键映射 </h3><p> 与上面的 Oculus Rift 作为对比，附一张 HTC Vive 的按键映射：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/3380/htc-vive-key-mapping-on-ue4.webp"></p>
<h3 id="HTC-VIVE 设备设置"><a href="#HTC-VIVE 设备设置" class="headerlink" title="HTC VIVE 设备设置"></a>HTC VIVE 设备设置</h3><p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/3380/Vive-Setting-01.webp"><br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/3380/Vive-Setting-02.webp"><br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/3380/Vive-Setting-03.webp"></p>
<ul>
<li><a href="https://support.steampowered.com/steamvr/HTC_Vive/">SteamVR Support - HTC Vive 安装指南</a></li>
</ul>
<h3 id="SteamVR-2-0 定位基站"><a href="#SteamVR-2-0 定位基站" class="headerlink" title="SteamVR 2.0 定位基站"></a>SteamVR 2.0 定位基站 </h3><p>HTC Vive Pro 支持的定位器是 SteamVR 2.0，支持 150°和 7 米的追踪范围，而且支持基站串联(最多 16 个) 实现大空间定位方案。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/3380/SteamVR/SteamVR2.0.webp"><br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/3380/SteamVR/SteamVR2.0-station-channel-configuration.webp"></p>
<p>注意：二代基站不支持一代 HTC Vive 头显。</p>
<h3 id="使用 Proxifier 让 Oculus 走 SS 代理"><a href="# 使用 Proxifier 让 Oculus 走 SS 代理" class="headerlink" title="使用 Proxifier 让 Oculus 走 SS 代理"></a>使用 Proxifier 让 Oculus 走 SS 代理 </h3><p> 昨天公司买了台 Oculus Rift 设备，在安装设备时需要全局代理，在 Windows 下我使用的是 Proxifier 来让 Oculus 相关软件走代理。<br>首先先添加 Proxifier 的代理：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/3380/proxifier-add-proxy-serves.webp"><br>测试连接成功之后即可执行下列操作。</p>
<p>上面连接成功后可以添加一个代理规则，而 Oculus 程序相关的进程如下，我们需要做的是让下列的进程走 SS 的代理：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">OculusSetup.exe;OculusClient.exe;OVRServiceLauncher.exe;OVRServer_x64.exe;OculusVR.exe;OculusCompatCheck.exe;CompatToolCommandLine.exe;OculusLogGatherer.exe;OVRLibrarian.exe;oculus-driver.exe;OVRLibraryService.exe;oculus-overlays.exe;OVRRedistributableInstaller.exe;</span><br></pre></td></tr></table></figure>
<p>将上面的内容填入 <code> 应用程序 </code> 文本框内之后，选择走 SS 的本地代理端口就可以了。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/3380/proxifier-ocukus-proxy-setting.webp"></p>
<p>其他的程序(如外服游戏、Steam 等)，如果需要强制走 SS 代理也是同样的方法。</p>
<h3 id="VR 画面模糊的问题"><a href="#VR 画面模糊的问题" class="headerlink" title="VR 画面模糊的问题"></a>VR 画面模糊的问题 </h3><p> 因为 UE 项目中默认的 <a href="https://docs.unrealengine.com/en-us/Resources/ContentExamples/PostProcessing/1_13">Screen Percentage</a> 值是很低的，所以会感觉很模糊，但直接调高之后会有严重的帧率下降问题。<br>一般设置为 200 以内画面质量就不错了，下面列有 UE 的建议值(理想值)。然后需要美术在此基础上对场景进行优化，保证接近满帧的帧率。</p>
<p>在 4.19 之前 (不含 4.19)，VR HMD 建议的理想值(<strong>r.ScreenPercentage</strong>) 为：</p>
<table>
<thead>
<tr>
<th align="center">DeviceType</th>
<th align="center">r.ScreenPercentage</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Oculus Rift</td>
<td align="center">133</td>
</tr>
<tr>
<td align="center">HTC Vive</td>
<td align="center">140</td>
</tr>
<tr>
<td align="center">PSVR</td>
<td align="center">140</td>
</tr>
<tr>
<td align="center">GearVR</td>
<td align="center">120</td>
</tr>
<tr>
<td align="center">GoogleVR</td>
<td align="center">120</td>
</tr>
</tbody></table>
<p>在 4.19 之后 UE 增加了 <code>vr.PixelDensity</code>，在<code>r.ScreenPercentage</code> 保持为 100 时，就可以在不同平台的设备上使用标准化的值:</p>
<table>
<thead>
<tr>
<th align="center">DeviceType</th>
<th align="center">r.ScreenPercentage</th>
<th align="center">vr.PixelDensity</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Oculus Rift</td>
<td align="center">100</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">HTC Vive</td>
<td align="center">100</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">PSVR</td>
<td align="center">100</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">GearVR</td>
<td align="center">100</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">GoogleVR</td>
<td align="center">100</td>
<td align="center">1</td>
</tr>
</tbody></table>
<blockquote>
<p>Lower values will perform faster but will be undersampled (more blurry) while values over 1 will perform slower and will supersample (extra sharp).</p>
</blockquote>
<p>这样就可以通过控制 <code>vr.PixelDensity</code> 这个标准化的值来控制显示质量。<br>具体介绍链接：<a href="https://www.unrealengine.com/en-US/blog/significant-changes-coming-to-vr-resolution-settings-in-4-19">Significant Changes Coming To VR Resolution Settings in 4.19</a></p>
<h3 id="HTC-VIVE 定位器故障 -03- 的解决办法"><a href="#HTC-VIVE 定位器故障 -03- 的解决办法" class="headerlink" title="HTC VIVE 定位器故障 (03) 的解决办法"></a>HTC VIVE 定位器故障 (03) 的解决办法 </h3><p> 如果定位器面板上闪红灯且 SteamVR 显示 ** 定位器故障 (03)**，请试着手动烧录定位器(基站) 固件。步骤如下:<br>固件路径在 Steam 的安装路径下：<code>Steam\steamapps\common\SteamVR\tools\lighthouse\firmware\lighthouse_tx\archive\htc_2.0</code>，找到以下两个文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">* lighthouse_tx_htc_2_0-calibration-rescue-244.bin</span><br><span class="line">* lighthouse_tx_htc_2_0-244-2016-03-12.bin</span><br></pre></td></tr></table></figure>
<ol>
<li>在定位器 (基站) 未通电情况下，将其通过 micro-B USB 传输线连接到电脑。</li>
<li>按住定位器 (基站) 背后的模式键并插入电源线.</li>
<li>一旦电脑端确认为 USB 大容量存储设备(USB mass storage device)，才可以释放模式键。</li>
<li>被连接的定位器 (基站) 储存设备名为“CRP_DISABLED”，打开后包含一个文件“firmware.bin”，删除它。</li>
<li>将“lighthouse_tx_htc_2_0-calibration-rescue-244.bin”文件复制到基站的储存空间上。</li>
<li>复制完成后，拔掉电源线。</li>
<li>等几秒，然后再次插上电源。在此过程中不要按模式键。几秒后定位器 (基站) 应该会快速的闪烁绿灯或者红灯。绿灯表示修复成功。</li>
<li>如果它闪烁红灯，这表示不能自动修复，请您送修。</li>
<li>再次拔下电源。</li>
<li>重复步骤 1 到 7，但第 5 步复制文件改为“lighthouse_tx_htc_2_0-244-2016-03-12.bin”。</li>
<li>完整后定位器 (基站) 就恢复正常了，讲其频道设置为“A”并单独跟踪（另一个基站不通电）来确认运行情况。一旦确认工作正常，再打开另一个基站。</li>
</ol>
<p>如果出现闪烁绿灯无法正常使用，重复步骤 1 到 7，但在第五步清除”CRP_DISABLED”中所有文件，只复制 “lighthouse_tx_htc_2_0-244-2016-03-12.bin” 即可。</p>
<ul>
<li>如果手动烧录定位器 (基站) 固件和校准文还是无效，请使用手机拍照确定下列两个雷射点是否正常（不能用 iphone/ipad 雷射点拍不出來），如果这两个雷射点任一个没有显示，代表雷射损坏，请送客服检查。</li>
</ul>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/3380/using-burn-bin-fix-htc-vive-red-light-flicker.webp"><br>参考链接：<a href="https://www.vive.com/cn/forum/2632">定位器故障(03)</a></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>VirtualReality</category>
      </categories>
      <tags>
        <tag>HTC Vive</tag>
        <tag>VR</tag>
        <tag>Oculus</tag>
      </tags>
  </entry>
  <entry>
    <title>使用 Unreal Engine 4 采集 360°全景视频</title>
    <url>/wiki/64044/</url>
    <content><![CDATA[<p>本文部分内容摘自 Unreal Engine 的官方博客文章：<a href="https://www.unrealengine.com/zh-CN/blog/capturing-stereoscopic-360-screenshots-videos-movies-unreal-engine-4">从虚幻 4 中采集 360 度立体电影</a>，其余部分为修正该文章错误和提供一个现成可行的解决方案。</p>
<span id="more"></span>
<h3 id="采集单帧双眼图像"><a href="# 采集单帧双眼图像" class="headerlink" title="采集单帧双眼图像"></a>采集单帧双眼图像 </h3><p> 首先，我们需要确保启用了相应的插件。</p>
<p>在编辑器打开的情况下，转到 <code> 编辑（Edit）</code>-&gt; <code>插件（Plugins）</code>，然后选择左边的 <code> 电影采集（Movie Capture）</code>设置，确保对 <code> 立体全景电影采集（Stereo Panoramic Movie Capture）</code>选择 <code> 启用（Enabled）</code>。<br>然后重新启动场景编辑器。</p>
<p>注：您可能还需要再次快速 <code> 构建 (Build)</code>，具体取决于您是否在分支中获得了本地更改，因为工具附带的插件 dll 可能已经<strong> 陈旧</strong>。</p>
<p>当编辑器重新启动后，再次转到 <code> 编辑器（Editor）</code>-&gt; <code>插件（Plugins）</code>-&gt;<code> 电影采集（Movie Capture）</code>，并再次检查其是否已启用。</p>
<p>打开关卡蓝图 (level Blueprint)，新建<code>Event BeginPlay</code> 事件，然后再新建数个 (具体依据需求而定)<code>Execute Console Command</code> 节点来存放我们需要执行的命令。<br>我们可以先来一次采集测试，将下面这两条命令放入 <code>Execute Console Command</code> 节点中：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SP.OutputDir F:/StereoCaptureFrames</span><br><span class="line">// 采集单帧</span><br><span class="line">SP.PanoramicScreenshot</span><br></pre></td></tr></table></figure>
<p>如图：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/64044/EventBeginPlayExecuteConsoleCommand.webp"></p>
<p>然后就可以 <code> 启动 (Play)</code> 项目了，此时系统可能会长时间无响应（估计有一分钟左右），然后将会有两帧影像存储到您在先前用 <code>SP.OutputDir</code> 指定的目录中（其实是在该目录中的一个日期与时间目录下），一个是左眼图像，另一个是右眼图像。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/64044/1.webp"></p>
<h3 id="将左右眼图像自动组合成单一图像"><a href="# 将左右眼图像自动组合成单一图像" class="headerlink" title="将左右眼图像自动组合成单一图像"></a>将左右眼图像自动组合成单一图像 </h3><p> 这部分是我依据上面提到的官方文章修改的，也是上述文章中错误最多的部分。<br>在执行下列步骤之前首先需要保证你使用官方插件采集全景时可以成功导出左右眼图像。</p>
<p>首先先将引擎中的全景采集插件 (Stereo Panoramic Movie Capture) 目录剪切 (注意是 cut 而不是 copy) 出来，一是供我们修改，二是防止和我们自己编译的有冲突。Unreal 引擎中的插件在路径 \4.12\Engine\Plugins 下，在这里我们需要将其中的 <strong>StereoPanorama</strong>(\Engine\Plugins\Experimental\StereoPanorama) 剪切出来。</p>
<p>然后打开你要采集全景视频的项目文件夹，在项目文件夹的根目录下新建一个 <strong>Plugins</strong> 文件夹，将上一步剪切的 <strong>StereoPanorama</strong> 文件夹粘贴到这里。<br>此时该项目的文件结构应该是这样的(碍于篇幅只列出必要文件):<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/64044/ProjectFolderList.webp"></p>
<p>后面我会着重讲到修改 SceneCapturer.cpp 中的代码来实现我们想要的功能。</p>
<p>现在，打开你想要采集全景视频的项目。<br>在场景编辑器中依次打开 <strong>Edit-&gt;Plugins-&gt;Project-&gt;MovieCapture</strong> 启用 <code>Stereo Panoramic Movie Capture</code> 然后重启场景编辑器。<br>再次检查 <code>Stereo Panoramic Movie Capture</code> 是否被启用。<br>如果上面都 OK，那么下面就开始正式开搞。</p>
<p>首先，打开 \YouProjectFolder\Plugins\StereoPanorama\Source\StereoPanorama\Private\SceneCapturer.cpp，大概八九百行代码的样子，而且我用 diff 对比了一下引擎版本 4.11 和 4.12 两个引擎版本的 SceneCapturer.cpp 区别，其实没有实质性的改变，就是修改了一些不合规范 (随意) 的变量命名，所以这份教程在 4.11 和 4.12 中都是通用的。</p>
<p>为了使我们能够方便地控制合成的开关，我们需要定义一个 bool 常量在文件的头部，这样，在我们不需要开启合并的时候修改该常量的值即可，不必再修改其余的代码。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Newly inserted code.Defined a const bool</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">bool</span> CombineAtlasesOnOutput = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>现在我们需要在代码中有条件地禁用每只眼睛的输出 (通过上面定义的<code>CombineAtlasesOnOutput</code> 来控制)。<br>然后找到 <code>USceneCapturer::SaveAtlas()</code> 的底部，找到这样一段代码：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">IImageWrapperPtr ImageWrapper = ImageWrapperModule.<span class="built_in">CreateImageWrapper</span>(EImageFormat::PNG);</span><br><span class="line">ImageWrapper-&gt;<span class="built_in">SetRaw</span>(SphericalAtlas.<span class="built_in">GetData</span>(), SphericalAtlas.<span class="built_in">GetAllocatedSize</span>(), SphericalAtlasWidth, SphericalAtlasHeight, ERGBFormat::BGRA, <span class="number">8</span>);</span><br><span class="line"><span class="keyword">const</span> TArray&lt;uint8&gt;&amp; PNGData = ImageWrapper-&gt;<span class="built_in">GetCompressed</span>(<span class="number">100</span>);</span><br><span class="line">FFileHelper::<span class="built_in">SaveArrayToFile</span>(PNGData, *AtlasName);</span><br></pre></td></tr></table></figure>
<p>这几行代码就是控制左右眼输出的，如果我们定义的 <code>CombineAtlasesOnOutput</code> 为<code>true</code>，就意味这我们需要合并两张眼睛的图像，那么我们就需要禁掉它 (左右单独输出)，如果为<code>false</code> 则我们需要输出左右眼的单独序列帧，所以就需要执行它。<br>综上，可以写一个 if 语句来判断 <code>CombineAtlasesOnOutput</code> 的值：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">IImageWrapperPtr ImageWrapper = ImageWrapperModule.<span class="built_in">CreateImageWrapper</span>(EImageFormat::PNG);</span><br><span class="line"><span class="keyword">if</span> (!CombineAtlasesOnOutput)</span><br><span class="line">&#123;</span><br><span class="line">	ImageWrapper-&gt;<span class="built_in">SetRaw</span>(SphericalAtlas.<span class="built_in">GetData</span>(), SphericalAtlas.<span class="built_in">GetAllocatedSize</span>(), SphericalAtlasWidth, SphericalAtlasHeight, ERGBFormat::BGRA, <span class="number">8</span>);</span><br><span class="line">	<span class="keyword">const</span> TArray&lt;uint8&gt;&amp; PNGData = ImageWrapper-&gt;<span class="built_in">GetCompressed</span>(<span class="number">100</span>);</span><br><span class="line">	FFileHelper::<span class="built_in">SaveArrayToFile</span>(PNGData, *AtlasName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样会导致一个错误，因为 <code>PNGData</code> 是在 if 的作用域内定义的，如果执行到了 if 后 (被释放掉) 或者根本没有执行到 (if 判断为 false(<code>!true</code>)) 就会导致后面对 <code>PNGData</code> 的使用造成错误。<br>在上面 if 语句之后的代码块中对 <code>PNGData</code> 的使用处为:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (FStereoPanoramaManager::GenerateDebugImages-&gt;<span class="built_in">GetInt</span>() != <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    FString FrameStringUnprojected = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%s_%05d_Unprojected.webp&quot;</span>), *Folder, CurrentFrameCount);</span><br><span class="line">    FString AtlasNameUnprojected = OutputDir / Timestamp / FrameStringUnprojected;</span><br><span class="line"></span><br><span class="line">    ImageWrapper-&gt;<span class="built_in">SetRaw</span>(SurfaceData.<span class="built_in">GetData</span>(), SurfaceData.<span class="built_in">GetAllocatedSize</span>(), UnprojectedAtlasWidth, UnprojectedAtlasHeight, ERGBFormat::BGRA, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">const</span> TArray&lt;uint8&gt;&amp; PNGDataUnprojected = ImageWrapper-&gt;<span class="built_in">GetCompressed</span>(<span class="number">100</span>);</span><br><span class="line">    <span class="comment">// 原来的代码为 FFileHelper::SaveArrayToFile(PNGData, *AtlasNameUnprojected);</span></span><br><span class="line">    FFileHelper::<span class="built_in">SaveArrayToFile</span>(PNGDataUnprojected, *AtlasNameUnprojected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>diff</strong>:<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/64044/diffcode01.webp"></p>
<p>对禁用左右眼单帧输出部分，如果只写这部分代码，现在再执行采集是不会有任何有意义图像输出的(因为现在已经把左右眼输出禁用了)。下面继续搞将两张合并到一块的方法。</p>
<p>官方博文中给出了这部分代码，但是不知道是什么原因，模板类 (<code>TArray&lt;T&gt;</code>) 的所有参数都不见了，这样直接粘贴到代码里是无论如何也编译不过的。<br>官方提供的代码：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">TArraySphericalLeftEyeAtlas = <span class="built_in">SaveAtlas</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Left&quot;</span> ), UnprojectedLeftEyeAtlas );</span><br><span class="line">TArraySphericalRightEyeAtlas = <span class="built_in">SaveAtlas</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Right&quot;</span>), UnprojectedRightEyeAtlas);</span><br><span class="line"></span><br><span class="line"><span class="comment">//*NEW* - Begin</span></span><br><span class="line"><span class="keyword">if</span> (CombineAtlasesOnOutput)</span><br><span class="line">&#123;</span><br><span class="line">	TArrayCombinedAtlas;</span><br><span class="line">	CombinedAtlas.<span class="built_in">Append</span>(SphericalLeftEyeAtlas);</span><br><span class="line">	CombinedAtlas.<span class="built_in">Append</span>(SphericalRightEyeAtlas);</span><br><span class="line">	IImageWrapperPtr ImageWrapper = ImageWrapperModule.<span class="built_in">CreateImageWrapper</span>(EImageFormat::JPEG);</span><br><span class="line">	ImageWrapper-&gt;<span class="built_in">SetRaw</span>(CombinedAtlas.<span class="built_in">GetData</span>(), CombinedAtlas.<span class="built_in">GetAllocatedSize</span>(), SphericalAtlasWidth, SphericalAtlasHeight * <span class="number">2</span>, ERGBFormat::BGRA, <span class="number">8</span>);</span><br><span class="line">	<span class="keyword">const</span> TArray&amp; PNGData = ImageWrapper-&gt;<span class="built_in">GetCompressed</span>(<span class="number">100</span>);</span><br><span class="line">	<span class="comment">// Generate name</span></span><br><span class="line">	FString FrameString = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Frame_%05d.webp&quot;</span>), CurrentFrameCount);</span><br><span class="line">	FString AtlasName = OutputDir / Timestamp / FrameString;</span><br><span class="line">	FFileHelper::<span class="built_in">SaveArrayToFile</span>(PNGData, *AtlasName);</span><br><span class="line">	ImageWrapper.<span class="built_in">Reset</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//*NEW* - END</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Dump out how long the process took</span></span><br><span class="line">FDateTime EndTime = FDateTime::<span class="built_in">UtcNow</span>();</span><br><span class="line">FTimespan Duration = EndTime - StartTime;</span><br><span class="line"><span class="built_in">UE_LOG</span>(LogStereoPanorama, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;Duration:%g seconds for frame %d&quot;</span> ), Duration.<span class="built_in">GetTotalSeconds</span>(), CurrentFrameCount);</span><br><span class="line">StartTime = EndTime;</span><br></pre></td></tr></table></figure>

<p>真是满腹槽点，因为之前没读过 Unreal 引擎的代码，我还以为是我自己搞错了，后来读了相关的代码 (自己对了一下上面代码的语法) 才发现是官方代码写错了…</p>
<p>上面所有的 <code>TArray</code> 的模板参数都没有了，正确的用法是 <code>TArray&lt;T&gt;</code>，模板类的类型推导是在编译时计算的，而现在的问题是怎么通过现有的代码逆推回去<code>TArray</code> 该有的模板参数。<br>没办法(其实有，看后面)，来一点一点分析下吧。</p>
<p>首先，我们可以通过以下两行代码可以确定 <code>SphericalLeftEyeAtlas</code> 和<code>SphericalRightEyeAtlas</code>是同一种类型(废话)</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">TArraySphericalLeftEyeAtlas = <span class="built_in">SaveAtlas</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Left&quot;</span> ), UnprojectedLeftEyeAtlas );</span><br><span class="line">TArraySphericalRightEyeAtlas = <span class="built_in">SaveAtlas</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Right&quot;</span>), UnprojectedRightEyeAtlas);</span><br></pre></td></tr></table></figure>

<p>现在我们可以通过查看引擎中已有的代码 (<code>SaveAtlas()</code> 的定义)来获取 <code>SphericalLeftEyeAtlas</code> 和<code>SphericalRightEyeAtlas</code>应该是什么类型，就是看下调用 <code>SaveAtlas()</code> 的返回类型是什么。</p>
<p>引擎中定义的 <code>SaveAtlas()</code> 返回类型为<code>TArray&lt;FColor&gt;</code></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">TArray&lt;FColor&gt; <span class="title">USceneCapturer::SaveAtlas</span><span class="params">(FString Folder, <span class="keyword">const</span> TArray&lt;FColor&gt;&amp; SurfaceData)</span></span></span><br></pre></td></tr></table></figure>

<p>OK 现在可以确定 <code>SphericalLeftEyeAtlas</code> 和<code>SphericalRightEyeAtlas</code>都是 <code>TArray&lt;FColor&gt;</code> 了。</p>
<p>而后面 <code>CombinedAtlas</code> 的类型可以通过 <code>SphericalLeftEyeAtlas</code> 和<code>SphericalRightEyeAtlas</code>推导出来：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">TArrayCombinedAtlas;</span><br><span class="line">CombinedAtlas.<span class="built_in">Append</span>(SphericalLeftEyeAtlas);</span><br><span class="line">CombinedAtlas.<span class="built_in">Append</span>(SphericalRightEyeAtlas);</span><br></pre></td></tr></table></figure>

<p>成员函数 <code>append()</code> 从其函数名可以看出来其是在用容器 <code>TArray</code> 定义的一个实例中添加一个元素，所以我们可以确定 <code>CombinedAtlas</code> 的类型和 <code>SphericalLeftEyeAtlas</code> 和<code>SphericalRightEyeAtlas</code>一样，即<code>TArray&lt;FColor&gt;</code>。</p>
<p>剩余的代码中用到 <code>TArray&lt;T&gt;</code> 的就只有 <code>PNGData</code> 了:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> TArray&amp; PNGData = ImageWrapper-&gt;<span class="built_in">GetCompressed</span>(<span class="number">100</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>方法同上，我们查看一下 <code>GetCompressed()</code> 的定义就可以得到 <code>PNGData</code> 真正的类型。</p>
<p><code>GetCompressed()</code>是 <code>FImageWrapperBase</code> 类中的成员：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> TArray&lt;uint8&gt;&amp; <span class="title">FImageWrapperBase::GetCompressed</span><span class="params">(int32 Quality)</span></span></span><br></pre></td></tr></table></figure>

<p>即得到 PNGData 真正的类型为<code>TArray&lt;uint8&gt;&amp;</code></p>
<p>修改完的代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">TArray&lt;FColor&gt; SphericalLeftEyeAtlas  = <span class="built_in">SaveAtlas</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Left&quot;</span> ), UnprojectedLeftEyeAtlas );</span><br><span class="line">TArray&lt;FColor&gt; SphericalRightEyeAtlas = <span class="built_in">SaveAtlas</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Right&quot;</span>), UnprojectedRightEyeAtlas);</span><br><span class="line"></span><br><span class="line"><span class="comment">//*NEW* - Begin</span></span><br><span class="line"><span class="keyword">if</span> (CombineAtlasesOnOutput)</span><br><span class="line">&#123;</span><br><span class="line">	TArray&lt;FColor&gt; CombinedAtlas;</span><br><span class="line">	CombinedAtlas.<span class="built_in">Append</span>(SphericalLeftEyeAtlas);</span><br><span class="line">	CombinedAtlas.<span class="built_in">Append</span>(SphericalRightEyeAtlas);</span><br><span class="line">	IImageWrapperPtr ImageWrapper = ImageWrapperModule.<span class="built_in">CreateImageWrapper</span>(EImageFormat::JPEG);</span><br><span class="line">	ImageWrapper-&gt;<span class="built_in">SetRaw</span>(CombinedAtlas.<span class="built_in">GetData</span>(), CombinedAtlas.<span class="built_in">GetAllocatedSize</span>(), SphericalAtlasWidth, SphericalAtlasHeight * <span class="number">2</span>, ERGBFormat::BGRA, <span class="number">8</span>);</span><br><span class="line">	<span class="keyword">const</span> TArray&lt;uint8&gt;&amp; PNGData = ImageWrapper-&gt;<span class="built_in">GetCompressed</span>(<span class="number">100</span>);</span><br><span class="line">	<span class="comment">// Generate name</span></span><br><span class="line">	FString FrameString = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Frame_%05d.webp&quot;</span>), CurrentFrameCount);</span><br><span class="line">	FString AtlasName = OutputDir / Timestamp / FrameString;</span><br><span class="line">	FFileHelper::<span class="built_in">SaveArrayToFile</span>(PNGData, *AtlasName);</span><br><span class="line">	ImageWrapper.<span class="built_in">Reset</span>();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//*NEW* - END</span></span><br></pre></td></tr></table></figure>

<p>我修改好的 <code>SceneCapturer.cpp</code> 可以 <a href="http://pan.baidu.com/s/1cBT0HC"> 点此下载</a>。</p>
<p>此时再编译这个插件然后再启动项目就会采集并将左右眼合并成一张图片了。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/64044/2.webp"></p>
<p>其实修复上面的代码还有一个更简单的方法：在 C++11 中，其实可以不用上面写得这么麻烦去翻定义来查返回类型是什么，在定义新对象来接收调用返回的对象的时候都可以用 <code>auto</code> 关键字来定义，这样编译器就会自动给我们推导出所要接收的对象真正的类型。</p>
<p>如，上面的代码可以写为:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">auto</span> SphericalLeftEyeAtlas  = <span class="built_in">SaveAtlas</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Left&quot;</span> ), UnprojectedLeftEyeAtlas );</span><br><span class="line"><span class="keyword">auto</span> SphericalRightEyeAtlas = <span class="built_in">SaveAtlas</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Right&quot;</span>), UnprojectedRightEyeAtlas);</span><br><span class="line"></span><br><span class="line"><span class="comment">//*NEW* - Begin</span></span><br><span class="line"><span class="keyword">if</span> (CombineAtlasesOnOutput)</span><br><span class="line">&#123;</span><br><span class="line">  	<span class="comment">// 此处不可以用 auto，auto 定义的变量必须有初始值，因为若没有编译器无法推导其类型</span></span><br><span class="line">	TArray&lt;FColor&gt; CombinedAtlas;</span><br><span class="line">	CombinedAtlas.<span class="built_in">Append</span>(SphericalLeftEyeAtlas);</span><br><span class="line">	CombinedAtlas.<span class="built_in">Append</span>(SphericalRightEyeAtlas);</span><br><span class="line">	IImageWrapperPtr ImageWrapper = ImageWrapperModule.<span class="built_in">CreateImageWrapper</span>(EImageFormat::JPEG);</span><br><span class="line">	ImageWrapper-&gt;<span class="built_in">SetRaw</span>(CombinedAtlas.<span class="built_in">GetData</span>(), CombinedAtlas.<span class="built_in">GetAllocatedSize</span>(), SphericalAtlasWidth, SphericalAtlasHeight * <span class="number">2</span>, ERGBFormat::BGRA, <span class="number">8</span>);</span><br><span class="line">	<span class="keyword">auto</span> PNGData = ImageWrapper-&gt;<span class="built_in">GetCompressed</span>(<span class="number">100</span>);</span><br><span class="line">	<span class="comment">// Generate name</span></span><br><span class="line">	FString FrameString = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Frame_%05d.webp&quot;</span>), CurrentFrameCount);</span><br><span class="line">	FString AtlasName = OutputDir / Timestamp / FrameString;</span><br><span class="line">	FFileHelper::<span class="built_in">SaveArrayToFile</span>(PNGData, *AtlasName);</span><br><span class="line">	ImageWrapper.<span class="built_in">Reset</span>();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//*NEW* - END</span></span><br></pre></td></tr></table></figure>
<p>是不是方便了很多！但是这样写以后如果要重构的话…那画面太美。俗话说的好，动态类型一时爽，代码重构火葬场。虽然具有了 <code>auto</code> 的 C++ 仍然是静态类型语言，但是在编译期的类型推导足够让程序猿们造成依赖 (主要是懒) 了。</p>
<p>C++11 中有很多很多好用的新特性，而且我翻看 UnrealEngine 的代码也发现其中大规模运用了 C++11 的特性，所以还是要好好补充一下 C++11 特性的知识比较好。</p>
<p>更多 C++11 的内容可以看我这篇博文：<a href="https://imzlp.com/2016/05/12/cpp11-new-features/">C++11 的语法糖</a></p>
<h3 id="采集连续的序列帧"><a href="# 采集连续的序列帧" class="headerlink" title="采集连续的序列帧"></a>采集连续的序列帧 </h3><p> 通过上面的几个步骤我们可以顺利地采集出合并左右眼睛的单帧，但是我们终究还是需要采集连续帧然后来合并这些序列帧生成视频的。</p>
<p>我们可以通过这个命令来采集连续的序列帧：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 采集多个连续帧数 (一段视频) 可以用 SP.PanoramicMovie，其后应该有两个参数 startime 和 endtime</span></span><br><span class="line"><span class="comment">// startime 和 endtime 皆为帧数</span></span><br><span class="line"><span class="comment">// 假如我要采集 1s 的视频，且已经在工程中设置其 fps 为 30，我们就可以采集从第 0 帧到第 29 帧的图像(1s)</span></span><br><span class="line">SP.PanoramicMovie <span class="number">0</span> <span class="number">29</span></span><br></pre></td></tr></table></figure>

<p>但是直接这样做会有问题，假如你项目中设置 FPS 为 30，(单独)直接加这一条命令 (<code>SP.PanoramicMovie 0 29</code>) 会导致你采集的帧数 30 帧并不是实际项目 1s 的帧数，如果这样采集出来合成视频的话，大概等同于快进了 4-5 倍，所以说直接这样会导致采集掉帧。其实就是因为采集视频的时候引擎不是按固定步长时间运行的。</p>
<p>在采集电影时，首先 <strong> 一定要记住 </strong> 的最重要的事情是：要按固定的时间步长运行。</p>
<p>假如我们需要采集一秒 30 帧的图像，我们必须要告诉引擎必须按固定的时间步长使时间流逝，除非你希望 2 秒钟的视频只有两个输出帧。</p>
<p>你需要依次做以下几步：</p>
<ol>
<li><p>在 <code> 场景编辑器 (UE4Editor)</code>-&gt;<code> 编辑 (Edit)</code>-&gt; <code> 项目设置 (Projects settings)</code>-&gt;<code> 引擎 (Engine)</code>-&gt;<code> 一般设置 (General Settings)</code>-&gt;<code>Framerate</code> 中勾选上 <code>Fixed Frame Rate</code> 并设置为<code>30</code>(依据你想要采集的 FPS)<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/64044/framerate.webp"></p>
</li>
<li><p>在启动引擎时添加参数。<br>我们可以在引擎启动时添加 <code>-usefixedtimestep -fps=</code> 来让引擎以固定的步长时间流逝。<br>可以在 UE4Editor 快捷方式中添加该指令:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">X:\Unreal\4.12\Engine\Binaries\Win64\UE4Editor.exe -usefixedtimestep -fps=30 -notexturestreaming</span><br></pre></td></tr></table></figure>
<p><code>-notexturestreaming</code>参数的作用是关闭 <code> 纹理流</code>。</p>
</li>
</ol>
<p>执行上面两步之后再使用 <code>SP.PanoramicMovie</code> 来采集就不会出现丢帧的效果了。</p>
<h3 id="合并采集的图像序列为全景视频"><a href="# 合并采集的图像序列为全景视频" class="headerlink" title="合并采集的图像序列为全景视频"></a>合并采集的图像序列为全景视频 </h3><p> 通过上面几个步骤以及再参照官方文档的部分教程，我们可以顺利地得到一些序列帧。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/64044/3.webp"></p>
<p>如何将这些序列帧合并为可以播放的全景视频是当前的任务，官方那篇博文推荐的是 <strong>ffmpeg(we tend to just use ffmpeg.)</strong><br> 你可以自己去 <a href="https://ffmpeg.org/">ffmpeg 官网</a> 下载，或者 <a href="http://pan.baidu.com/s/1sl8GZRf"> 在此下载 </a> 我离线的版本。</p>
<p>使用方法就是，将上一步下载下来的 <code>ffmpeg.exe</code> 放在导出全景图的目录, 然后打开 CMD 跳转到该目录后执行以下命令:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ffmpeg -y -r 30 -i Frame_%05d.webp -vcodec mpeg4 -qscale 0.01 video.mp4</span><br></pre></td></tr></table></figure>
<p><code>-r</code>是帧率 (FPS)，更多的参数可以看 ffmpeg 的文档——<a href="https://ffmpeg.org/ffmpeg.html">ffmpeg Documentation</a><br> 执行完毕就会在当前目录下生成一个 video.mp4 文件。</p>
<p>或者要是实在不想动手也可以用下面的批处理命令(注意: 不要把 ffmpeg 和该批处理放在和图片的同级的目录)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="built_in">set</span> /p fps=Please input FPS(1-60):</span><br><span class="line"><span class="built_in">set</span> /p  quality=Please input video quality(0.01-255).The smaller number more clarity:</span><br><span class="line">ffmpeg -y -r %fps% -i ../Frame_%%05d.webp -vcodec mpeg4 -qscale %quality% ../video.mp4</span><br></pre></td></tr></table></figure>

<p>你的目录结构应该是下面这样的，才可以执行<code>ConvertImagesToVideo.bat</code><br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/64044/ImagesFolderList.webp"></p>
<p>含有 <code>ConvertImagesToVideo.bat</code> 的 ffmpeg 压缩包可以 <a href="http://pan.baidu.com/s/1jH7tiFO"> 点此下载</a>。</p>
<h3 id="资源整理"><a href="# 资源整理" class="headerlink" title="资源整理"></a>资源整理 </h3><p> 如果不想动手改代码且懒得编译的话可以 <a href="http://pan.baidu.com/s/1c1CVdzM"> 点此下载 </a> 我修改并编译好的版本，使用方法类似上面。将官方的插件文件夹中的 <code>StereoPanorama</code> 删掉 (或者自己留存) 之后，将前面下载的插件压缩包解压到你需要采集的项目的根目录(或者直接替换掉官方的插件)。</p>
<p>此时该项目的文件结构应该是这样的(碍于篇幅只列出必要文件):<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/64044/projectList.webp"></p>
<p>然后启动项目，在场景编辑器里启用 (并添加好采集节点) 就可以开始采集全景序列帧了。</p>
<p>另附其他工具：</p>
<ol>
<li>修改并编译好的<a href="http://pan.baidu.com/s/1c1CVdzM">StereoPanorama</a></li>
<li>修改好的<a href="http://pan.baidu.com/s/1c3LVJo">SceneCapturer.cpp</a></li>
<li><a href="http://pan.baidu.com/s/1eRGoLhw">ffmpeg(There is no bat)</a></li>
<li><a href="http://pan.baidu.com/s/1jH7tiFO">ffmpeg and bat</a></li>
</ol>
<h3 id="参考文章"><a href="# 参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><ol>
<li><a href="https://www.unrealengine.com/zh-CN/blog/capturing-stereoscopic-360-screenshots-videos-movies-unreal-engine-4">从虚幻 4 中采集 360 度立体电影</a></li>
<li><a href="https://ffmpeg.org/ffmpeg.html">ffmpeg Documentation</a></li>
<li><a href="https://imzlp.com/2016/05/12/cpp11-new-features/">C++11 的语法糖</a></li>
</ol>
<h3 id="结语"><a href="# 结语" class="headerlink" title="结语"></a>结语 </h3><p> 其实写了这么多，总共精要的部分是没有多少的，主要是记录了一下 <code>debug</code> 的方式…<br>另外，还是要多读引擎的代码以及不盲目的相信官方才行。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>VirtualReality</category>
      </categories>
      <tags>
        <tag>VR</tag>
        <tag>C++</tag>
      </tags>
  </entry>
  <entry>
    <title>Enum 反射实现分析</title>
    <url>/wiki/33168/</url>
    <content><![CDATA[<h3 id="UHT 为 Enum 生成的代码"><a href="#UHT 为 Enum 生成的代码" class="headerlink" title="UHT 为 Enum 生成的代码"></a>UHT 为 Enum 生成的代码 </h3><p> 在 UE 中，当我们声明一个枚举类型时可以像 UClass 一样地形式为其添加 <code>UENUM</code> 标记，指导 UHT 为其生成反射代码：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UENUM</span>(BlueprintType)</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="title">ETypeName</span> :</span>uint8</span><br><span class="line">&#123;</span><br><span class="line">	None,</span><br><span class="line">	Int,</span><br><span class="line">	Float</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>经过 UHT 之后就变成了：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// generated.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FOREACH_ENUM_ETYPENAME(op) \</span></span><br><span class="line"><span class="meta">	op(ETypeName::None) \</span></span><br><span class="line"><span class="meta">	op(ETypeName::Int) \</span></span><br><span class="line"><span class="meta">	op(ETypeName::Float) </span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="title">ETypeName</span> :</span> uint8;</span><br><span class="line"><span class="keyword">template</span>&lt;&gt; TOPDOWNEXAMPLE_API UEnum* StaticEnum&lt;ETypeName&gt;();</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// .gen.cpp</span></span><br><span class="line"><span class="comment">// End Cross Module References</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> UEnum* <span class="title">ETypeName_StaticEnum</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">static</span> UEnum* Singleton = <span class="literal">nullptr</span>;</span><br><span class="line">		<span class="keyword">if</span> (!Singleton)</span><br><span class="line">		&#123;</span><br><span class="line">			Singleton = <span class="built_in">GetStaticEnum</span>(Z_Construct_UEnum_TopdownExample_ETypeName, <span class="built_in">Z_Construct_UPackage__Script_TopdownExample</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;ETypeName&quot;</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> Singleton;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">template</span>&lt;&gt; TOPDOWNEXAMPLE_API UEnum* StaticEnum&lt;ETypeName&gt;()</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">ETypeName_StaticEnum</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> FCompiledInDeferEnum <span class="title">Z_CompiledInDeferEnum_UEnum_ETypeName</span><span class="params">(ETypeName_StaticEnum, TEXT(<span class="string">&quot;/Script/TopdownExample&quot;</span>), TEXT(<span class="string">&quot;ETypeName&quot;</span>), <span class="literal">false</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line">	<span class="function">uint32 <span class="title">Get_Z_Construct_UEnum_TopdownExample_ETypeName_Hash</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">2221805252U</span>; &#125;</span><br><span class="line">	<span class="function">UEnum* <span class="title">Z_Construct_UEnum_TopdownExample_ETypeName</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">		UPackage* Outer = <span class="built_in">Z_Construct_UPackage__Script_TopdownExample</span>();</span><br><span class="line">		<span class="keyword">static</span> UEnum* ReturnEnum = <span class="built_in">FindExistingEnumIfHotReloadOrDynamic</span>(Outer, <span class="built_in">TEXT</span>(<span class="string">&quot;ETypeName&quot;</span>), <span class="number">0</span>, <span class="built_in">Get_Z_Construct_UEnum_TopdownExample_ETypeName_Hash</span>(), <span class="literal">false</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		<span class="keyword">static</span> UEnum* ReturnEnum = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// WITH_HOT_RELOAD</span></span></span><br><span class="line">		<span class="keyword">if</span> (!ReturnEnum)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FEnumeratorParam Enumerators[] = &#123;</span><br><span class="line">				&#123; <span class="string">&quot;ETypeName::None&quot;</span>, (int64)ETypeName::None &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETypeName::Int&quot;</span>, (int64)ETypeName::Int &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETypeName::Float&quot;</span>, (int64)ETypeName::Float &#125;,</span><br><span class="line">			&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">			<span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Enum_MetaDataParams[] = &#123;</span><br><span class="line">				&#123; <span class="string">&quot;BlueprintType&quot;</span>, <span class="string">&quot;true&quot;</span> &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;MyK2Node.h&quot;</span> &#125;,</span><br><span class="line">			&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">			<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FEnumParams EnumParams = &#123;</span><br><span class="line">				(UObject*(*)())Z_Construct_UPackage__Script_TopdownExample,</span><br><span class="line">				<span class="literal">nullptr</span>,</span><br><span class="line">				<span class="string">&quot;ETypeName&quot;</span>,</span><br><span class="line">				<span class="string">&quot;ETypeName&quot;</span>,</span><br><span class="line">				Enumerators,</span><br><span class="line">				<span class="built_in">ARRAY_COUNT</span>(Enumerators),</span><br><span class="line">				RF_Public|RF_Transient|RF_MarkAsNative,</span><br><span class="line">				UE4CodeGen_Private::EDynamicType::NotDynamic,</span><br><span class="line">				(uint8)UEnum::ECppForm::EnumClass,</span><br><span class="line">				<span class="built_in">METADATA_PARAMS</span>(Enum_MetaDataParams, <span class="built_in">ARRAY_COUNT</span>(Enum_MetaDataParams))</span><br><span class="line">			&#125;;</span><br><span class="line">			UE4CodeGen_Private::<span class="built_in">ConstructUEnum</span>(ReturnEnum, EnumParams);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> ReturnEnum;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>UEnum 的构造思路和 UClass 差不多，通过 UHT 生成 Enum 的反射代码，记录枚举类型的名字、枚举值的名字、元数据等等，通过 <code>UE4CodeGen_Private::ConstructUEnum</code> 把这些反射数据构造出 UEnum。</p>
<p>同样也是通过 <strong> 延迟注册 </strong> 的方式把 UEnum 构造出来。</p>
<h3 id="运行时访问 UEnum"><a href="# 运行时访问 UEnum" class="headerlink" title="运行时访问 UEnum"></a>运行时访问 UEnum</h3><p>如果要获取一个 <code>UENMU</code> 的 UEnum* 可以通过 <code>StaticEnum&lt;ETypeName&gt;()</code> 或者通过 <code>UEnum* const MethodEnum = FindObjectChecked&lt;UEnum&gt;(ANY_PACKAGE, TEXT(&quot;ETypeName&quot;), true);</code> 来拿。</p>
<p>在 UE4.22+ 的版本中可以使用下列方法：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> UEnum* TypeEnum = StaticEnum&lt;EnumType&gt;();</span><br></pre></td></tr></table></figure>
<p>在 4.21 及之前的版本就要麻烦一点：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> UEnum* TypeEnum = FindObject&lt;UEnum&gt;(ANY_PACKAGE, <span class="built_in">TEXT</span>(<span class="string">&quot;EnumType&quot;</span>), <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<p>注意上面的 <code>TEXT(&quot;EnumType&quot;)</code> 其中要填想要获取的枚举类型名字。</p>
<h3 id="根据枚举名字获取枚举值"><a href="# 根据枚举名字获取枚举值" class="headerlink" title="根据枚举名字获取枚举值"></a>根据枚举名字获取枚举值</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// get enum value by name</span></span><br><span class="line">&#123;</span><br><span class="line">	FString EnumTypeName = <span class="built_in">TEXT</span>(<span class="string">&quot;ETargetPlatform&quot;</span>);</span><br><span class="line">    FString EnumName = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%s::%s&quot;</span>),*EnumTypeName,<span class="built_in">TEXT</span>(<span class="string">&quot;Int&quot;</span>))</span><br><span class="line"></span><br><span class="line">    UEnum* ETargetPlatformEnum = FindObject&lt;UEnum&gt;(ANY_PACKAGE, *EnumTypeName, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    int32 EnumIndex = ETargetPlatformEnum-&gt;<span class="built_in">GetIndexByName</span>(<span class="built_in">FName</span>(*EnumName));</span><br><span class="line">    <span class="keyword">if</span> (EnumIndex != INDEX_NONE)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">UE_LOG</span>(LogTemp, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;FOUND ENUM INDEX SUCCESS&quot;</span>));</span><br><span class="line">      int32 EnumValue = ETargetPlatformEnum-&gt;<span class="built_in">GetValueByIndex</span>(EnumIndex);</span><br><span class="line">      ETargetPlatform CurrentEnum = (ETargetPlatform)EnumValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果也想再封装一层模板类，让枚举名字也可以自动获取，则需要用得到 C++ 的 RTTI 特性：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> std::string <span class="title">GetCPPTypeName</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::string result;</span><br><span class="line">    std::string type_name = <span class="built_in"><span class="keyword">typeid</span></span>(T).<span class="built_in">name</span>();</span><br><span class="line"></span><br><span class="line">    std::for_each(type_name.<span class="built_in">begin</span>(),type_name.<span class="built_in">end</span>(),[&amp;result](<span class="keyword">const</span> <span class="keyword">char</span>&amp; character)&#123;<span class="keyword">if</span>(!std::<span class="built_in">isdigit</span>(character)) result.<span class="built_in">push_back</span>(character);&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="枚举值与字符串的互相转换"><a href="# 枚举值与字符串的互相转换" class="headerlink" title="枚举值与字符串的互相转换"></a>枚举值与字符串的互相转换 </h3><p> 有些需要序列化枚举值的需要，虽然我们可以通过 <code>FindObject&lt;UEnum&gt;</code> 传入枚举名字拿到 <code>UEnum*</code>，再通过<code>GetNameByValue</code> 拿到名字，但是这样需要针对每个枚举都要单独写，我写了模板函数来做这个事情：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 同时支持 4.21- 和 4.21+ 版本引擎</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;typeinfo&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cctype&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> std::string <span class="title">GetCPPTypeName</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::string result;</span><br><span class="line">    std::string type_name = <span class="built_in"><span class="keyword">typeid</span></span>(T).<span class="built_in">name</span>();</span><br><span class="line"></span><br><span class="line">    std::for_each(type_name.<span class="built_in">begin</span>(),type_name.<span class="built_in">end</span>(),[&amp;result](<span class="keyword">const</span> <span class="keyword">char</span>&amp; character)&#123;<span class="keyword">if</span>(!std::<span class="built_in">isdigit</span>(character)) result.<span class="built_in">push_back</span>(character);&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> ENUM_TYPE&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> FString <span class="title">GetEnumNameByValue</span><span class="params">(ENUM_TYPE InEnumValue, <span class="keyword">bool</span> bFullName = <span class="literal">false</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FString result;</span><br><span class="line">    &#123;</span><br><span class="line">      FString TypeName;</span><br><span class="line">      FString ValueName;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ENGINE_MINOR_VERSION &gt; 21</span></span><br><span class="line">        UEnum* FoundEnum = StaticEnum&lt;ENUM_TYPE&gt;();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        FString EnumTypeName = <span class="built_in">ANSI_TO_TCHAR</span>(GetCPPTypeName&lt;ENUM_TYPE&gt;().<span class="built_in">c_str</span>());</span><br><span class="line">        UEnum* FoundEnum = FindObject&lt;UEnum&gt;(ANY_PACKAGE, *EnumTypeName, <span class="literal">true</span>); </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">      <span class="keyword">if</span> (FoundEnum)</span><br><span class="line">      &#123;</span><br><span class="line">        result = FoundEnum-&gt;<span class="built_in">GetNameByValue</span>((int64)InEnumValue).<span class="built_in">ToString</span>();</span><br><span class="line">        result.<span class="built_in">Split</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;::&quot;</span>), &amp;TypeName, &amp;ValueName, ESearchCase::CaseSensitive, ESearchDir::FromEnd);</span><br><span class="line">        <span class="keyword">if</span> (!bFullName)</span><br><span class="line">        &#123;</span><br><span class="line">          result = ValueName;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以及从字符串获取枚举值：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> ENUM_TYPE&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">GetEnumValueByName</span><span class="params">(<span class="keyword">const</span> FString&amp; InEnumValueName, ENUM_TYPE&amp; OutEnumValue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">bool</span> bStatus = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ENGINE_MINOR_VERSION &gt;22</span></span><br><span class="line">        UEnum* FoundEnum = StaticEnum&lt;ENUM_TYPE&gt;();</span><br><span class="line">        FString EnumTypeName = FoundEnum-&gt;CppType;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        FString EnumTypeName = *GetCPPTypeName&lt;ENUM_TYPE&gt;();</span><br><span class="line">        UEnum* FoundEnum = FindObject&lt;UEnum&gt;(ANY_PACKAGE, *EnumTypeName, <span class="literal">true</span>); </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (FoundEnum)</span><br><span class="line">    &#123;</span><br><span class="line">      FString EnumValueFullName = EnumTypeName + <span class="built_in">TEXT</span>(<span class="string">&quot;::&quot;</span>) + InEnumValueName;</span><br><span class="line">      int32 EnumIndex = FoundEnum-&gt;<span class="built_in">GetIndexByName</span>(<span class="built_in">FName</span>(*EnumValueFullName));</span><br><span class="line">      <span class="keyword">if</span> (EnumIndex != INDEX_NONE)</span><br><span class="line">      &#123;</span><br><span class="line">        int32 EnumValue = FoundEnum-&gt;<span class="built_in">GetValueByIndex</span>(EnumIndex);</span><br><span class="line">        ENUM_TYPE ResultEnumValue = (ENUM_TYPE)EnumValue;</span><br><span class="line">        OutEnumValue = ResultEnumValue;</span><br><span class="line">        bStatus = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bStatus;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>反射</category>
      </categories>
      <tags>
        <tag>反射</tag>
        <tag>UEnum</tag>
      </tags>
  </entry>
  <entry>
    <title>StaticClass 实现分析</title>
    <url>/wiki/40612/</url>
    <content><![CDATA[<h3 id="StaticClass 和 GetClass 的区别"><a href="#StaticClass 和 GetClass 的区别" class="headerlink" title="StaticClass 和 GetClass 的区别"></a>StaticClass 和 GetClass 的区别 </h3><p><code>StaticClass</code> 是继承自 UObject 类的 static 函数，<code>GetClass</code>是 <code>UObjectBase</code> 的成员函数。</p>
<p><code>UObjectBase</code>的 <code>GetClass</code> 获取到的 UClass 就是在 NewObject 时传递进来的 UClass.（代码在 <code>UObject\UObjectGlobal.cpp</code> 中）</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-static-class-and-getclass-difference.webp"></p>
<p>用途不一样，<code>StaticClass</code>是在获取具体类型的 UClass，而 <code>GetClass</code> 是获取到当前对象的真实 UClass。</p>
<h3 id="StaticClass 是如何定义的"><a href="#StaticClass 是如何定义的" class="headerlink" title="StaticClass 是如何定义的"></a>StaticClass 是如何定义的 </h3><p> 在 UE 中可以对 UObject 的类执行 <code>UXXX::StaticClass</code> 方法来获取到它的 UClass 对象。</p>
<p>但是它是如何定义的？首先要看我们声明对象的 <code>MyActor.generated.h</code> 中（以 AMyActor 类为例）：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;&gt; MICROEND_423_API UClass* StaticClass&lt;<span class="class"><span class="keyword">class</span> <span class="title">AMyActor</span>&gt;</span>();</span><br></pre></td></tr></table></figure>

<p>为 AMyActor 类特化了 <code>StaticClass</code> 的版本。再去 <code>MyActor.gen.cpp</code> 中找以下它的实现：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">IMPLEMENT_CLASS</span>(AMyActor, <span class="number">31943282</span>);</span><br><span class="line"><span class="keyword">template</span>&lt;&gt; MICROEND_423_API UClass* StaticClass&lt;AMyActor&gt;()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> AMyActor::<span class="built_in">StaticClass</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从这里看也就只是转发调用而已，但是关键点隐藏在其他地方。<br>首先 <code>AMyActor::StaticClass</code> 类的定义是在 <code>AMyActor.generated.h</code> 的<code>DECLARE_CLASS</code>宏中（该宏定义在 <a href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L1524">ObjectMacros.h#L1524</a>），返回的是<code>GetPrivateStaticClass</code> 的调用。</p>
<p>而 <code>GetPrivateStaticClass</code> 则在 <code>AMyAcotr.gen.cpp</code> 中的 <a href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L1673">IMPLEMENT_CLASS</a> 实现。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime/CoreUObject/Public/UObject/ObjectMacros.h</span></span><br><span class="line"><span class="comment">// Register a class at startup time.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMPLEMENT_CLASS(TClass, TClassCrc) \</span></span><br><span class="line"><span class="meta">	static TClassCompiledInDefer<span class="meta-string">&lt;TClass&gt;</span> AutoInitialize###TClass(TEXT(#TClass), sizeof(TClass), TClassCrc); \</span></span><br><span class="line"><span class="meta">	UClass* TClass::GetPrivateStaticClass() \</span></span><br><span class="line"><span class="meta">	&#123; \</span></span><br><span class="line"><span class="meta">		static UClass* PrivateStaticClass = NULL; \</span></span><br><span class="line"><span class="meta">		<span class="meta-keyword">if</span> (!PrivateStaticClass) \</span></span><br><span class="line"><span class="meta">		&#123; \</span></span><br><span class="line"><span class="meta">			<span class="comment">/* this could be handled with templates, but we want it external to avoid code bloat */</span> \</span></span><br><span class="line"><span class="meta">			GetPrivateStaticClassBody(\</span></span><br><span class="line"><span class="meta">				StaticPackage(), \</span></span><br><span class="line"><span class="meta">				(TCHAR*)TEXT(#TClass) + 1 + ((StaticClassFlags &amp; CLASS_Deprecated) ? 11 : 0), \</span></span><br><span class="line"><span class="meta">				PrivateStaticClass, \</span></span><br><span class="line"><span class="meta">				StaticRegisterNatives###TClass, \</span></span><br><span class="line"><span class="meta">				sizeof(TClass), \</span></span><br><span class="line"><span class="meta">				alignof(TClass), \</span></span><br><span class="line"><span class="meta">				(EClassFlags)TClass::StaticClassFlags, \</span></span><br><span class="line"><span class="meta">				TClass::StaticClassCastFlags(), \</span></span><br><span class="line"><span class="meta">				TClass::StaticConfigName(), \</span></span><br><span class="line"><span class="meta">				(UClass::ClassConstructorType)InternalConstructor<span class="meta-string">&lt;TClass&gt;</span>, \</span></span><br><span class="line"><span class="meta">				(UClass::ClassVTableHelperCtorCallerType)InternalVTableHelperCtorCaller<span class="meta-string">&lt;TClass&gt;</span>, \</span></span><br><span class="line"><span class="meta">				&amp;TClass::AddReferencedObjects, \</span></span><br><span class="line"><span class="meta">				&amp;TClass::Super::StaticClass, \</span></span><br><span class="line"><span class="meta">				&amp;TClass::WithinClass::StaticClass \</span></span><br><span class="line"><span class="meta">			); \</span></span><br><span class="line"><span class="meta">		&#125; \</span></span><br><span class="line"><span class="meta">		return PrivateStaticClass; \</span></span><br><span class="line"><span class="meta">	&#125;</span></span><br></pre></td></tr></table></figure>
<p>可以看到 <code>GetPrivateStaticClass</code> 其实就是通过这些元数据构造出 UClass 的。</p>
<p>如下面的代码：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">IMPLEMENT_CLASS</span>(AMyActor, <span class="number">3240835608</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 宏展开之后</span></span><br><span class="line"><span class="keyword">static</span> TClassCompiledInDefer &lt; AMyActor &gt; <span class="built_in">AutoInitializeAMyActor</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AMyActor&quot;</span>), <span class="built_in"><span class="keyword">sizeof</span></span>(AMyActor), <span class="number">3240835608</span>);</span><br><span class="line"><span class="function">UClass * <span class="title">AMyActor::GetPrivateStaticClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> UClass * PrivateStaticClass = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">if</span> (!PrivateStaticClass) &#123;</span><br><span class="line">    <span class="built_in">GetPrivateStaticClassBody</span>(</span><br><span class="line">    	<span class="built_in">StaticPackage</span>(), </span><br><span class="line">    	(TCHAR*)<span class="built_in">TEXT</span>(<span class="string">&quot;AMyActor&quot;</span>) + <span class="number">1</span> + ((StaticClassFlags &amp; CLASS_Deprecated) ? <span class="number">11</span> : <span class="number">0</span>), </span><br><span class="line">    	PrivateStaticClass, </span><br><span class="line">    	StaticRegisterNativesAMyActor, </span><br><span class="line">    	<span class="built_in"><span class="keyword">sizeof</span></span>(AMyActor), </span><br><span class="line">    	<span class="built_in"><span class="keyword">alignof</span></span>(AMyActor), </span><br><span class="line">    	(EClassFlags) AMyActor::StaticClassFlags, </span><br><span class="line">    	AMyActor::<span class="built_in">StaticClassCastFlags</span>(), </span><br><span class="line">    	AMyActor::<span class="built_in">StaticConfigName</span>(), </span><br><span class="line">    	(UClass::ClassConstructorType) InternalConstructor&lt;AMyActor&gt;,</span><br><span class="line">    	(UClass::ClassVTableHelperCtorCallerType) InternalVTableHelperCtorCaller&lt;AMyActor&gt;,</span><br><span class="line">    	&amp;AMyActor::AddReferencedObjects,</span><br><span class="line">    	&amp;AMyActor::Super::StaticClass, </span><br><span class="line">    	&amp;AMyActor::WithinClass::StaticClass</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> PrivateStaticClass;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="UClass 中的函数指针"><a href="#UClass 中的函数指针" class="headerlink" title="UClass 中的函数指针"></a>UClass 中的函数指针 </h4><p> 上面代码中比较关键的点为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">(UClass::ClassConstructorType)InternalConstructor&lt;TClass&gt;, \</span><br><span class="line">(UClass::ClassVTableHelperCtorCallerType)InternalVTableHelperCtorCaller&lt;TClass&gt;, \</span><br></pre></td></tr></table></figure>

<p>这两行是模板实例化出了两个函数并转换成函数指针传递给<code>GetPrivateStaticClassBody</code>：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// class.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Helper template to call the default constructor for a class</span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;class T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InternalConstructor</span><span class="params">(<span class="keyword">const</span> FObjectInitializer&amp; X )</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">	T::__DefaultConstructor(X);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Helper template to call the vtable ctor caller for a class</span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;class T&gt;</span></span><br><span class="line"><span class="function">UObject* <span class="title">InternalVTableHelperCtorCaller</span><span class="params">(FVTableHelper&amp; Helper)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> T::__VTableCtorCaller(Helper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>就是对 <code>__DefaultConstructor</code> 这样函数的的转发调用。</p>
<p><code>UClass::ClassConstructorType</code>与 <code>UClass::ClassVTableHelperCtorCallerType</code> 这两个 <code>typedef</code> 为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span>		<span class="params">(*ClassConstructorType)</span>				<span class="params">(<span class="keyword">const</span> FObjectInitializer&amp;)</span></span>;</span><br><span class="line"><span class="keyword">typedef</span> UObject*	(*ClassVTableHelperCtorCallerType)	(FVTableHelper&amp; Helper);</span><br></pre></td></tr></table></figure>

<h4 id="GetPrivateStaticClassBody"><a href="#GetPrivateStaticClassBody" class="headerlink" title="GetPrivateStaticClassBody"></a>GetPrivateStaticClassBody</h4><p>其中的 <code>GetPrivateStaticClassBody</code> 函数是定义在 <a href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Private/UObject/Class.cpp">Runtime\CoreUObject\Private\UObject\Class.cpp</a> 中的。</p>
<p>原型为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GetPrivateStaticClassBody</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">const</span> TCHAR* PackageName,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">const</span> TCHAR* Name,</span></span></span><br><span class="line"><span class="params"><span class="function">	UClass*&amp; ReturnClass,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">void</span>(*RegisterNativeFunc)(),</span></span></span><br><span class="line"><span class="params"><span class="function">	uint32 InSize,</span></span></span><br><span class="line"><span class="params"><span class="function">	uint32 InAlignment,</span></span></span><br><span class="line"><span class="params"><span class="function">	EClassFlags InClassFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">	EClassCastFlags InClassCastFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">const</span> TCHAR* InConfigName,</span></span></span><br><span class="line"><span class="params"><span class="function">	UClass::ClassConstructorType InClassConstructor,</span></span></span><br><span class="line"><span class="params"><span class="function">	UClass::ClassVTableHelperCtorCallerType InClassVTableHelperCtorCaller,</span></span></span><br><span class="line"><span class="params"><span class="function">	UClass::ClassAddReferencedObjectsType InClassAddReferencedObjects,</span></span></span><br><span class="line"><span class="params"><span class="function">	UClass::StaticClassFunctionType InSuperClassFn,</span></span></span><br><span class="line"><span class="params"><span class="function">	UClass::StaticClassFunctionType InWithinClassFn,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">bool</span> bIsDynamic <span class="comment">/*= false*/</span></span></span></span><br><span class="line"><span class="params"><span class="function">	)</span></span>;</span><br></pre></td></tr></table></figure>

<p>其中第四个参数是传入注册 Native 函数的函数指针，该函数在 <code>MyActor.gen.cpp</code> 中生成，也可以通过在 UFUNCTION 中添加 <code>CustomThunk</code> 函数来自己实现，UnLua 的覆写 C++ 函数就是基于替换 thunk 函数做的。</p>
<p><code>GetPrivateStaticClassBody</code>中通过 <code>(UClass*)GUObjectAllocator.AllocateUObject</code> 来分配出 UClass 的内存，因为所有的 UClass 结构都一致。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// MyActor.gen.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AMyActor::StaticRegisterNativesAMyActor</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UClass* Class = AMyActor::<span class="built_in">StaticClass</span>();</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> FNameNativePtrPair Funcs[] = &#123;</span><br><span class="line">		&#123; <span class="string">&quot;ReceiveBytes&quot;</span>, &amp;AMyActor::execReceiveBytes &#125;,</span><br><span class="line">		&#123; <span class="string">&quot;TESTFUNC&quot;</span>, &amp;AMyActor::execTESTFUNC &#125;,</span><br><span class="line">	&#125;;</span><br><span class="line">	FNativeFunctionRegistrar::<span class="built_in">RegisterFunctions</span>(Class, Funcs, <span class="built_in">ARRAY_COUNT</span>(Funcs));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实就是把 Native 的函数通过 <code>AddNativeFunction</code> 添加到 UClass 中：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime\CoreUObject\Private\UObject\Class.cpp </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FNativeFunctionRegistrar::RegisterFunctions</span><span class="params">(class UClass* Class, <span class="keyword">const</span> FNameNativePtrPair* InArray, int32 NumFunctions)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (; NumFunctions; ++InArray, --NumFunctions)</span><br><span class="line">	&#123;</span><br><span class="line">		Class-&gt;<span class="built_in">AddNativeFunction</span>(<span class="built_in">UTF8_TO_TCHAR</span>(InArray-&gt;NameUTF8), InArray-&gt;Pointer);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>反射</category>
      </categories>
      <tags>
        <tag>反射</tag>
        <tag>UClass</tag>
      </tags>
  </entry>
  <entry>
    <title>Struct 反射实现分析</title>
    <url>/wiki/33475/</url>
    <content><![CDATA[<p>前面讲到了 Class/function/property 的反射，UE 还支持结构体的反射，其实从 C++ 的标准语义来说并没有区分“结构”和“类”，关键字 <code>struct</code> 和<code>class</code>的区别只在于默认的访问权限。</p>
<p>在 UE 里面，支持反射的结构提只能使用<code>struct</code>，并且不能包含任何 UFUNCTION 的函数，命名必须以 F 开头。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">USTRUCT</span>(BlueprintType)</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FTestStruct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="built_in">GENERATED_USTRUCT_BODY</span>()</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditAnywhere)</span><br><span class="line">	int32 ival;</span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditAnywhere)</span><br><span class="line">	UTexture2D* Texture;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>UE 的标记语法和 Class 的类似，不过 UHT 为 Struct 生成的代码要简单许多，因为没有 UFUNCTION 也没有继承 UObject。</p>
<p><code>GENERATED_USTRUCT_BODY</code>这个标记 UHT 会展开生成一个真正的 C++ 宏(在 genreated.h 中)：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// generated.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HotPatcherExample_Source_HotPatcherExample_TestStruct_h_11_GENERATED_BODY \</span></span><br><span class="line"><span class="meta">	friend struct Z_Construct_UScriptStruct_FTestStruct_Statics; \</span></span><br><span class="line"><span class="meta">	HOTPATCHEREXAMPLE_API static class UScriptStruct* StaticStruct();</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt; HOTPATCHEREXAMPLE_API UScriptStruct* StaticStruct&lt;<span class="class"><span class="keyword">struct</span> <span class="title">FTestStruct</span>&gt;</span>();</span><br></pre></td></tr></table></figure>

<p>把 UHT 生成的用于记录当前 struct 反射数据的结构 <code>Z_Construct_UScriptStruct_FTestStruct_Statis</code> 声明为当前 struct 类的友元，可以让它访问到自己的私有成员。而且还声明了当前 Struct 的 static 成员函数 <code>StaticStruct</code> 和全局模板函数<code>StaticStruct&lt;FTestStruct&gt;</code>。</p>
<p>对 Struct 生成的反射数；</p>
<p>据的结构与 class 的类似，只有 Property 的反射信息。</p>
<p><code>gen.cpp</code>中有以下内容：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">class UScriptStruct* <span class="title">FTestStruct::StaticStruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UScriptStruct</span>* <span class="title">Singleton</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">if</span> (!Singleton)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="function"><span class="keyword">extern</span> HOTPATCHEREXAMPLE_API uint32 <span class="title">Get_Z_Construct_UScriptStruct_FTestStruct_Hash</span><span class="params">()</span></span>;</span><br><span class="line">		Singleton = <span class="built_in">GetStaticStruct</span>(Z_Construct_UScriptStruct_FTestStruct, <span class="built_in">Z_Construct_UPackage__Script_HotPatcherExample</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;TestStruct&quot;</span>), <span class="built_in"><span class="keyword">sizeof</span></span>(FTestStruct), <span class="built_in">Get_Z_Construct_UScriptStruct_FTestStruct_Hash</span>());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> Singleton;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span>&lt;&gt; HOTPATCHEREXAMPLE_API UScriptStruct* StaticStruct&lt;FTestStruct&gt;()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> FTestStruct::<span class="built_in">StaticStruct</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> FCompiledInDeferStruct <span class="title">Z_CompiledInDeferStruct_UScriptStruct_FTestStruct</span><span class="params">(FTestStruct::StaticStruct, TEXT(<span class="string">&quot;/Script/HotPatcherExample&quot;</span>), TEXT(<span class="string">&quot;TestStruct&quot;</span>), <span class="literal">false</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">FScriptStruct_HotPatcherExample_StaticRegisterNativesFTestStruct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="built_in">FScriptStruct_HotPatcherExample_StaticRegisterNativesFTestStruct</span>()</span><br><span class="line">	&#123;</span><br><span class="line">		UScriptStruct::<span class="built_in">DeferCppStructOps</span>(<span class="built_in">FName</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;TestStruct&quot;</span>)),<span class="keyword">new</span> UScriptStruct::TCppStructOps&lt;FTestStruct&gt;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125; ScriptStruct_HotPatcherExample_StaticRegisterNativesFTestStruct;</span><br><span class="line"></span><br><span class="line"><span class="function">UScriptStruct* <span class="title">Z_Construct_UScriptStruct_FTestStruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">	<span class="function"><span class="keyword">extern</span> uint32 <span class="title">Get_Z_Construct_UScriptStruct_FTestStruct_Hash</span><span class="params">()</span></span>;</span><br><span class="line">	UPackage* Outer = <span class="built_in">Z_Construct_UPackage__Script_HotPatcherExample</span>();</span><br><span class="line">	<span class="keyword">static</span> UScriptStruct* ReturnStruct = <span class="built_in">FindExistingStructIfHotReloadOrDynamic</span>(Outer, <span class="built_in">TEXT</span>(<span class="string">&quot;TestStruct&quot;</span>), <span class="built_in"><span class="keyword">sizeof</span></span>(FTestStruct), <span class="built_in">Get_Z_Construct_UScriptStruct_FTestStruct_Hash</span>(), <span class="literal">false</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="keyword">static</span> UScriptStruct* ReturnStruct = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">if</span> (!ReturnStruct)</span><br><span class="line">	&#123;</span><br><span class="line">		UE4CodeGen_Private::<span class="built_in">ConstructUScriptStruct</span>(ReturnStruct, Z_Construct_UScriptStruct_FTestStruct_Statics::ReturnStructParams);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ReturnStruct;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">uint32 <span class="title">Get_Z_Construct_UScriptStruct_FTestStruct_Hash</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">4266809061U</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码包含了从 UHT 生成的反射信息中构造出 <code>UStructSctruct</code> 以及延迟注册的方法，和 Class 的方式类似。</p>
<p>还包含生成的结构 <code>Z_Construct_UScriptStruct_STRUCTNAME_Statics</code> 如下：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Z_Construct_UScriptStruct_FTestStruct_Statics</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Struct_MetaDataParams[];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span>* <span class="title">NewStructOps</span><span class="params">()</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam NewProp_Texture_MetaData[];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FObjectPropertyParams NewProp_Texture;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam NewProp_ival_MetaData[];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FIntPropertyParams NewProp_ival;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase* <span class="keyword">const</span> PropPointers[];</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FStructParams ReturnStructParams;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Z_Construct_UScriptStruct_FTestStruct_Statics::Struct_MetaDataParams[] = &#123;</span><br><span class="line">	&#123; <span class="string">&quot;BlueprintType&quot;</span>, <span class="string">&quot;true&quot;</span> &#125;,</span><br><span class="line">	&#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;TestStruct.h&quot;</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">Z_Construct_UScriptStruct_FTestStruct_Statics::NewStructOps</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (UScriptStruct::ICppStructOps*)<span class="keyword">new</span> UScriptStruct::TCppStructOps&lt;FTestStruct&gt;();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_Texture_MetaData[] = &#123;</span><br><span class="line">	&#123; <span class="string">&quot;Category&quot;</span>, <span class="string">&quot;TestStruct&quot;</span> &#125;,</span><br><span class="line">	&#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;TestStruct.h&quot;</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FObjectPropertyParams Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_Texture = &#123; </span><br><span class="line">	<span class="string">&quot;Texture&quot;</span>, </span><br><span class="line">	<span class="literal">nullptr</span>, </span><br><span class="line">	(EPropertyFlags)<span class="number">0x0010000000000001</span>, </span><br><span class="line">	UE4CodeGen_Private::EPropertyGenFlags::Object, </span><br><span class="line">	RF_Public|RF_Transient|RF_MarkAsNative, </span><br><span class="line">	<span class="number">1</span>, </span><br><span class="line">	<span class="built_in">STRUCT_OFFSET</span>(FTestStruct, Texture), </span><br><span class="line">	Z_Construct_UClass_UTexture2D_NoRegister, </span><br><span class="line">	<span class="built_in">METADATA_PARAMS</span>(Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_Texture_MetaData, </span><br><span class="line">	<span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_Texture_MetaData)) </span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_ival_MetaData[] = &#123;</span><br><span class="line">	&#123; <span class="string">&quot;Category&quot;</span>, <span class="string">&quot;TestStruct&quot;</span> &#125;,</span><br><span class="line">	&#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;TestStruct.h&quot;</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FIntPropertyParams Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_ival = &#123; </span><br><span class="line">	<span class="string">&quot;ival&quot;</span>, </span><br><span class="line">	<span class="literal">nullptr</span>, </span><br><span class="line">	(EPropertyFlags)<span class="number">0x0010000000000001</span>, </span><br><span class="line">	UE4CodeGen_Private::EPropertyGenFlags::Int, </span><br><span class="line">	RF_Public|RF_Transient|RF_MarkAsNative, </span><br><span class="line">	<span class="number">1</span>, </span><br><span class="line">	<span class="built_in">STRUCT_OFFSET</span>(FTestStruct, ival), </span><br><span class="line">	<span class="built_in">METADATA_PARAMS</span>(Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_ival_MetaData, </span><br><span class="line">	<span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_ival_MetaData)) </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase* <span class="keyword">const</span> Z_Construct_UScriptStruct_FTestStruct_Statics::PropPointers[] = &#123;</span><br><span class="line">	(<span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase*)&amp;Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_Texture,</span><br><span class="line">	(<span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase*)&amp;Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_ival,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FStructParams Z_Construct_UScriptStruct_FTestStruct_Statics::ReturnStructParams = &#123;</span><br><span class="line">	(UObject* (*)())Z_Construct_UPackage__Script_HotPatcherExample,</span><br><span class="line">	<span class="literal">nullptr</span>,</span><br><span class="line">	&amp;NewStructOps,</span><br><span class="line">	<span class="string">&quot;TestStruct&quot;</span>,</span><br><span class="line">	<span class="built_in"><span class="keyword">sizeof</span></span>(FTestStruct),</span><br><span class="line">	<span class="built_in"><span class="keyword">alignof</span></span>(FTestStruct),</span><br><span class="line">	Z_Construct_UScriptStruct_FTestStruct_Statics::PropPointers,</span><br><span class="line">	<span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UScriptStruct_FTestStruct_Statics::PropPointers),</span><br><span class="line">	RF_Public|RF_Transient|RF_MarkAsNative,</span><br><span class="line">	<span class="built_in">EStructFlags</span>(<span class="number">0x00000001</span>),</span><br><span class="line">	<span class="built_in">METADATA_PARAMS</span>(Z_Construct_UScriptStruct_FTestStruct_Statics::Struct_MetaDataParams, <span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UScriptStruct_FTestStruct_Statics::Struct_MetaDataParams))</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可以看到 Struct 的每个属性也是通过 <code>FPropertyParamsBase</code> 来存储的，与 Class 一致。</p>
<p>区别在于，Struct 使用 <code>UE4CodeGen_Private::FStructParams</code> 来存储当前结构的反射信息，其声明如下(<a href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Public/UObject/UObjectGlobals.h#L2603">CoreUObject/Public/UObject/UObjectGlobals.h</a>)：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// CoreUObject/Public/UObject/UObjectGlobals.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FStructParams</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	UObject*                          (*OuterFunc)();	</span><br><span class="line">	UScriptStruct*                    (*SuperFunc)();</span><br><span class="line">	<span class="keyword">void</span>*                             (*StructOpsFunc)(); <span class="comment">// really returns UScriptStruct::ICppStructOps*</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>*                         NameUTF8;</span><br><span class="line">	SIZE_T                              SizeOf;</span><br><span class="line">	SIZE_T                              AlignOf;</span><br><span class="line">	<span class="keyword">const</span> FPropertyParamsBase* <span class="keyword">const</span>*   PropertyArray;</span><br><span class="line">	int32                               NumProperties;</span><br><span class="line">	EObjectFlags                        ObjectFlags;</span><br><span class="line">	uint32                              StructFlags; <span class="comment">// EStructFlags</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">const</span> FMetaDataPairParam*           MetaDataArray;</span><br><span class="line">	int32                               NumMetaData;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这个结构中比较特殊的一点是 <code>StructOpsFunc</code> 是一个函数指针，用来管理 C++ 结构的构造和析构，使用的也是 placement-new 的方式，<code>TCppStructOps&lt;&gt;</code>模板定义在<a href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Public/UObject/Class.h#L1122">CoreUObject/Public/UObject/Class.h</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>反射</category>
      </categories>
      <tags>
        <tag>反射</tag>
        <tag>UStruct</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 反射实现分析：C++ 特性</title>
    <url>/wiki/23694/</url>
    <content><![CDATA[<p>在前一篇文章中，介绍了 UE 的反射的基础概念，这篇文章开始研究 UE 的反射机制的具体实现。</p>
<p>在介绍 UE 的代码之前，需要先要介绍一些 C++ 特性，虽然 UE 的反射实现是大量依赖 UHT 的代码生成的，但是也需要 C++ 的语法特性支持，只有把这些特性还有它们背后的含义了解清楚，才能够更好地理解 UE 的反射机制。</p>
<p>本篇文章中介绍的 C++ 的特性和标准描述均基于<code>ISO/IEC 14882:2014</code>，也就是 C++14 标准。</p>
<span id="more"></span>

<p>要介绍的实现反射依赖的 C++ 特性，就是把 C++ 中类型的信息通过什么样的方式存储下来供运行时访问。</p>
<h2 id="class-struct"><a href="#class-struct" class="headerlink" title="class/struct"></a>class/struct</h2><p>对于 C++ 的类而言，需要着重关注的是内存布局，因为类实例本质就是一块内存，而如何解释这块内存，需要通过类的类型信息来确定。<br>在 C++ 中 <code>struct</code> 和<code>class</code>来定义类，只有默认的访问控制权限有差别，在 UE 中则不同，USTRUCT 和 UCLASS 则进行了严格的区分，USTRUCT 不能具有反射函数。</p>
<h3 id="数据成员"><a href="# 数据成员" class="headerlink" title="数据成员"></a>数据成员 </h3><p> 因为兼容 C 的以及语言特性的实现，C++ 还有 POD 的概念。而介绍 POD 则又先要介绍 C++ 标准中的<code>standard-layout class</code>（[ISO/IEC 14882:2014 9.1.7]）：<br>A standard-layout class is a class that:</p>
<ul>
<li>has no non-static data members of type non-standard-layout class (or array of such types) or reference,</li>
<li>has no virtual functions (10.3) and no virtual base classes (10.1),</li>
<li>has the same access control (Clause 11) for all non-static data members,</li>
<li>has no non-standard-layout base classes,</li>
<li>either has no non-static data members in the most derived class and at most one base class with<br>non-static data members, or has no base classes with non-static data members, and</li>
<li> has no base classes of the same type as the ﬁrst non-static data member.</li>
</ul>
<p>因为 C++ 在实现特性的时候会往原始的内存布局中插入或调整成员顺序，所以 C++ 标准中对 <code>standard-layout class</code> 做了上述限定。</p>
<p>可以把 POD 理解为只有数据的类，并且数据成员的排列顺序是固定的（不能包含多个不同的访问控制权限，因为编译器 <strong> 有可能 </strong> 会混排，标准中没有做保证），除了内存对齐外，不会被插入额外的内存。</p>
<p>在我之前的一篇文章：<a href="https://imzlp.com/posts/61962/">结构体成员内存对齐问题 </a> 里介绍了内存对齐。因为内存对其的存在，类内数据成员并不是严格的一个挨着一个存放的，内存布局中会有一些空隙，这样会有两个问题：</p>
<ol>
<li>数据成员在类内的偏移地址是依赖于内存对齐的</li>
<li>不同的声明顺序会导致类布局的变化（编译器也有可能对不同的访问控制权限进行重排）</li>
</ol>
<p>为了获取数据成员在类内的偏移值，而不用考虑上面一堆的东西，C++ 引入了一个特性：<strong>Pointers to members</strong>，翻译过来就叫做 <strong> 指向成员的指针 </strong>，这部分内容的详细描述在<code>ISO/IEC 14882:2014 §8.3.3</code> 中。</p>
<p>在我之前的一篇文章中，也对指向成员的指针做过比较详细的介绍：<a href="https://imzlp.com/posts/27615/">C++ 中指向类成员的指针并非指针</a>。</p>
<p>指向类成员的指针，重点就是来获取数据成员、函数相对于类型的描述信息，比如数据成员在类布局中的偏移，成员函数的 this 偏移值、成员函数的原始函数指针，得到了这些信息才能通过类实例访问到具体的成员。</p>
<p>如以下类：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassExample</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  	<span class="keyword">bool</span> bBoolean;</span><br><span class="line">  	<span class="keyword">int</span> ival;</span><br><span class="line">  	<span class="keyword">double</span> dval;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span>)</span></span>&#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>来获取它三个成员的内部偏移值：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">bool</span> ClassExample::*bBoolean = &amp;ClassExample::bBoolean;</span><br><span class="line"><span class="keyword">int</span> ClassExample::*ival = &amp;ClassExample::ival;</span><br><span class="line"><span class="keyword">double</span> ClassExample::*dval = &amp;ClassExample::dval;</span><br></pre></td></tr></table></figure>

<p>通过 LLVM-IR 翻译之后可以更直观地看到：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">store i64 <span class="number">0</span>, i64* %<span class="number">1</span>, align <span class="number">8</span></span><br><span class="line">store i64 <span class="number">4</span>, i64* %<span class="number">2</span>, align <span class="number">8</span></span><br><span class="line">store i64 <span class="number">8</span>, i64* %<span class="number">3</span>, align <span class="number">8</span></span><br></pre></td></tr></table></figure>

<p>如果把类定义中的 <code>func</code> 改成 <code>virtual</code> 呢？</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">store i64 <span class="number">8</span>, i64* %<span class="number">1</span>, align <span class="number">8</span></span><br><span class="line">store i64 <span class="number">12</span>, i64* %<span class="number">2</span>, align <span class="number">8</span></span><br><span class="line">store i64 <span class="number">16</span>, i64* %<span class="number">3</span>, align <span class="number">8</span></span><br></pre></td></tr></table></figure>

<p>可以看到内存布局的变化，这是因为类中有了虚函数，往类布局中插入了虚表指针，占用了 8 个字节。</p>
<p>小结一下：通过成员函数指针等特性，可以在编译时就确定数据成员在类布局中的偏移，通过 <strong> 该偏移 </strong>+<strong> 数据成员的类型大小</strong>（<code>sizeof</code>），就可以正确地访问到指定的成员所在的内存了。</p>
<p>但是，C++ 中也有一个限制，就是不能对位域取地址：</p>
<blockquote>
<p>The address-of operator &amp; shall not be applied to a bit-ﬁeld, so there are no pointers to bit-ﬁelds. </p>
</blockquote>
<p>位域在 UE 中被广泛地应用于 bool 值，C++ 中对该用法有保证：</p>
<blockquote>
<p>A bool value can successfully be stored in a bit-ﬁeld of any nonzero size.</p>
</blockquote>
<p>并且，位域的分配和对齐是实现定义的：</p>
<blockquote>
<p>[ISO/IEC 14882:2014 9.6 Bit-ﬁelds]Allocation of bit-ﬁelds within a class object is implementation-deﬁned. Alignment of bit-ﬁelds is implementation-deﬁned.</p>
</blockquote>
<p>因为不能对位域进行取地址，所以在反射实现中需要对 <code>uint8 bEnable:1;</code> 做一些特殊处理，要能得到位域中的位。</p>
<p>以 <code>FBoolProperty</code> 中获取 bool 值的实现为例：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">FORCEINLINE <span class="keyword">bool</span> <span class="title">GetPropertyValue</span><span class="params">(<span class="keyword">void</span> <span class="keyword">const</span>* A)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">check</span>(FieldSize != <span class="number">0</span>);</span><br><span class="line">	uint8* ByteValue = (uint8*)A + ByteOffset;</span><br><span class="line">	<span class="keyword">return</span> !!(*ByteValue &amp; FieldMask);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同时兼容了 <code>NativeBool</code> 和<code>bit-field</code>。</p>
<p>对于 <code>uint8 bit_field:1;</code> 和<code>bool native_bool;</code>两种反射信息的生成，以反射信息中的 <code>UE4CodeGen_Private::EPropertyGenFlags::NativeBool</code> 来区别，具有该 flag 的是<code>bool native_bool;</code>。</p>
<h3 id="成员函数"><a href="# 成员函数" class="headerlink" title="成员函数"></a>成员函数</h3><p>UE 的反射函数都是成员函数，并且需要继承自 UObject。</p>
<p>UE 中成员函数实现反射，并没有依赖 C++ 的指向成员函数的指针，它完全依赖 UHT 生成了一个统一原型的 Thunk 函数，在 Thunk 函数中调用真正执行的函数（包括从栈上取数据等操作）。</p>
<p>并且会为反射的函数生成用于传递给 <code>ProcessEvent</code> 函数的参数结构，以及每个参数、返回值生成属性的反射信息（它们的内存偏移都是相对于 UHT 生成的参数结构的）。</p>
<p>如以下函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UFUNCTION</span>()</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">func</span><span class="params">(int32 InIval)</span></span>;</span><br></pre></td></tr></table></figure>

<p>UHT 生成的 Thunk 函数为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">DEFINE_FUNCTION</span>(URefObject::execfunc)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">P_GET_PROPERTY</span>(FIntProperty,Z_Param_InIval);</span><br><span class="line">    P_FINISH;</span><br><span class="line">    P_NATIVE_BEGIN;</span><br><span class="line">    *(<span class="keyword">bool</span>*)Z_Param__Result=P_THIS-&gt;<span class="built_in">func</span>(Z_Param_InIval);</span><br><span class="line">    P_NATIVE_END;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用这种方式，统一了所有的反射函数的调用原型为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">execfunc</span><span class="params">(UObject* Context, FFrame&amp; Stack, RESULT_DECL)</span></span></span><br></pre></td></tr></table></figure>

<p>每个反射的函数都可以从这个原型中获取自己的参数，从而执行真正的函数调用行为（或者执行蓝图字节码）。</p>
<h2 id="enum"><a href="#enum" class="headerlink" title="enum"></a>enum</h2><p>枚举值不是整数，但是它可以被提升为整数类型。</p>
<blockquote>
<p>[ISO/IEC 14882:2014]Therefore, enumerations (7.2) are not integral; however, enumerations can be promoted to integral types as speciﬁed in 4.5.</p>
</blockquote>
<p>在 UE 的 UEnum 中枚举值使用 int64 来存储，所以，只要我们知道了枚举的名字，还有它名字所对应的整数值，就可以在名字和整数值以及枚举之间进行相互转换了。</p>
<p>UHT 会给添加了 UENUM 的枚举生成这些信息，并在运行时构造出 UEnum 实例存储这些信息。</p>
<p>UE 中的 Enum 写法：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UENUM</span>()</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="title">EClassEnum</span>:</span> uint8</span><br><span class="line">&#123;</span><br><span class="line">	A =<span class="number">0</span>,</span><br><span class="line">	B,</span><br><span class="line">	C = <span class="number">11</span>,</span><br><span class="line">	D</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>UHT 生成的部分反射代码：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FEnumeratorParam Enumerators[] = &#123;</span><br><span class="line">    &#123; <span class="string">&quot;EClassEnum::A&quot;</span>, (int64)EClassEnum::A &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;EClassEnum::B&quot;</span>, (int64)EClassEnum::B &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;EClassEnum::C&quot;</span>, (int64)EClassEnum::C &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;EClassEnum::D&quot;</span>, (int64)EClassEnum::D &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>基于反射 UEnum 进行字符串、枚举值的转换：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> ENUM_TYPE&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">GetEnumValueByName</span><span class="params">(<span class="keyword">const</span> FString&amp; InEnumValueName, ENUM_TYPE&amp; OutEnumValue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">bool</span> bStatus = <span class="literal">false</span>;</span><br><span class="line">    UEnum* FoundEnum = StaticEnum&lt;ENUM_TYPE&gt;();</span><br><span class="line">    FString EnumTypeName = FoundEnum-&gt;CppType;</span><br><span class="line">    <span class="keyword">if</span> (FoundEnum)</span><br><span class="line">    &#123;</span><br><span class="line">        FString EnumValueFullName = EnumTypeName + <span class="built_in">TEXT</span>(<span class="string">&quot;::&quot;</span>) + InEnumValueName;</span><br><span class="line">        int32 EnumIndex = FoundEnum-&gt;<span class="built_in">GetIndexByName</span>(<span class="built_in">FName</span>(*EnumValueFullName));</span><br><span class="line">        <span class="keyword">if</span> (EnumIndex != INDEX_NONE)</span><br><span class="line">        &#123;</span><br><span class="line">            int32 EnumValue = FoundEnum-&gt;<span class="built_in">GetValueByIndex</span>(EnumIndex);</span><br><span class="line">            ENUM_TYPE ResultEnumValue = (ENUM_TYPE)EnumValue;</span><br><span class="line">            OutEnumValue = ResultEnumValue;</span><br><span class="line">            bStatus = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bStatus;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而且也可以访问蓝图中的 Enum：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">FString <span class="title">UFlibAppHelper::GetEnumNameByValue</span><span class="params">(TSoftObjectPtr&lt;UUserDefinedEnum&gt; EnumPath, int32 value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FString result;</span><br><span class="line">    UUserDefinedEnum* Enumer = LoadObject&lt;UUserDefinedEnum&gt;(<span class="literal">nullptr</span>, *EnumPath.<span class="built_in">ToString</span>());</span><br><span class="line">    <span class="keyword">if</span> (Enumer)</span><br><span class="line">    &#123;</span><br><span class="line">        result = Enumer-&gt;<span class="built_in">GetDisplayNameTextByValue</span>(value).<span class="built_in">ToString</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/23694/20201203212055.webp"></p>
<h3 id="scoped-enum"><a href="#scoped-enum" class="headerlink" title="scoped enum"></a>scoped enum</h3><p>随便写一点点番外，C++ 的 scoped enum。</p>
<p>C++11 引入了 <code>scoped enum</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">enum class EClassEnum&#123;</span><br><span class="line">	A = 0,</span><br><span class="line">	B,</span><br><span class="line">	C</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>为什么要引入这么语法呢？因为 C++11 之前的 enum，其枚举值得定义是位于整个所属名字空间的。C++ 标准中的描述：</p>
<blockquote>
<p>[ISO/IEC 14882:2014 §7.2]The enumeration type declared with an enum-key of only enum is an unscoped enumeration, and its enumerators are unscoped enumerators.</p>
</blockquote>
<p>下面代码就会出现重定义错误：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">enum ENormalEnum&#123;</span><br><span class="line">	A = 0</span><br><span class="line">&#125;;</span><br><span class="line">enum EOtherEnum&#123;</span><br><span class="line">	A = 0</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>所以在一般写代码时会加上 namespace 来人为地区分枚举的名字空间：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">namespace ENamespaceEnum</span><br><span class="line">&#123;</span><br><span class="line">  enum Type</span><br><span class="line">  &#123;</span><br><span class="line">    A = 0,</span><br><span class="line">    B,</span><br><span class="line">    C</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>因为上面 <code>Type</code> 的枚举值是位于当前 namespace 的，所以就可以以下面这种形式来使用：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ENamespaceEnum::A;</span><br><span class="line">ENamespaceEnum::B;</span><br><span class="line">ENamespaceEnum::C;</span><br></pre></td></tr></table></figure>

<p>这其实是一种弱类型枚举，枚举本身并不是一个类型。所以 C++11 引入了 <code>Scoped Enum</code>，可以理解为强类型枚举：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">enum class EScopedEnum&#123;</span><br><span class="line">	A = 0,</span><br><span class="line">	B,</span><br><span class="line">	C</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>使用它可以具有与上面 <code>namespace</code> 形式一样的效果。</p>
<p>Scoped Enumeration 的值也是可以显式转换为数值类型的：</p>
<blockquote>
<p>[ISO/IEC 14882:2014 §5.2.9]A value of a scoped enumeration type (7.2) can be explicitly converted to an integral type.</p>
</blockquote>
<p>而且，如果 scoped enum 的基础类型没有被显式指定的话，它的默认基础类型是 int:</p>
<blockquote>
<p>[ISO/IEC 14882:2014 §7.2]Each enumeration also has an underlying type. The underlying type can be explicitly speciﬁed using enum-base; if not explicitly speciﬁed, the underlying type of a scoped enumeration type is int.</p>
</blockquote>
<p>在 LLVM 中，对 Scoped enum 的处理是在编译器前端做的，下列代码生成的 IR 代码：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">enum ENormalEnum&#123;</span><br><span class="line">	A = 0,</span><br><span class="line">	B,</span><br><span class="line">	C</span><br><span class="line">&#125;;</span><br><span class="line">enum class EScopedEnum&#123;</span><br><span class="line">	A = 0,</span><br><span class="line">	B,</span><br><span class="line">	C</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">	printf(&quot;A:%d,B:%d,C:%d\n&quot;,A,B,C);</span><br><span class="line">	printf(&quot;A:%d,B:%d,C:%d\n&quot;,EScopedEnum::A,EScopedEnum::B,EScopedEnum::C);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>main 函数的 LLVM-IR：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; Function Attrs: uwtable</span><br><span class="line">define i32 @main() #3 &#123;</span><br><span class="line">entry:</span><br><span class="line">  %call = call i32 (i8*, ...) @_Z6printfPKcz(i8* getelementptr inbounds ([16 x i8], [16 x i8]* @.str, i32 0, i32 0), i32 0, i32 1, i32 2)</span><br><span class="line">  %call1 = call i32 (i8*, ...) @_Z6printfPKcz(i8* getelementptr inbounds ([16 x i8], [16 x i8]* @.str, i32 0, i32 0), i32 0, i32 1, i32 2)</span><br><span class="line">  ret i32 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在生成 IR 时就没有符号信息，只剩常量了。</p>
<h2 id="static 的构造时机"><a href="#static 的构造时机" class="headerlink" title="static 的构造时机"></a>static 的构造时机 </h2><p>UE 里的反射技术也依赖了 C++ 的 static 构造时机，如<code>gen.cpp</code> 中的：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> FCompiledInDefer <span class="title">Z_CompiledInDefer_UClass_URefObject</span><span class="params">(Z_Construct_UClass_URefObject, &amp;URefObject::StaticClass, TEXT(<span class="string">&quot;/Script/RefExample&quot;</span>), TEXT(<span class="string">&quot;URefObject&quot;</span>), <span class="literal">false</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>C++ 标准中对 static 的构造时机介绍：</p>
<blockquote>
<p>It is implementation-defined whether the dynamic initialization of a non-local variable with static storage duration is done before the first statement of main.</p>
</blockquote>
<p>虽然标准里写的 <code>implementation-defined</code> 行为，但是几乎用到的编译器都是这么干的。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>反射</category>
      </categories>
      <tags>
        <tag>反射</tag>
        <tag>C++</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 反射实现分析：基础概念</title>
    <url>/wiki/12624/</url>
    <content><![CDATA[<p><strong>反射</strong>，是指程序在运行时进行自检的的能力，在编辑器的属性面板、序列化、GC 等方面非常有用。但是 C++ 语言本身不支持反射特性，UE 在 C++ 的语法基础上通过 UHT 实现了反射信息的生成，从而实现了运行时的反射的目的。</p>
<p>在之前的文章中，有一些涉及到 UE 的构建系统和反射相关的内容。</p>
<p>涉及了 UE 的构建系统文章：</p>
<ul>
<li><a href="https://imzlp.com/posts/6362/">Build flow of the Unreal Engine4 project</a></li>
<li><a href="https://img.imzlp.com/imgs/zlp/blog/posts/16643/">UE4 Build System: Target and Module</a></li>
<li><a href="https://imzlp.com/posts/20425/">UEC++ 与标准 C++ 的区别与联系</a></li>
</ul>
<p>基于 UE 的反射机制来做一些奇淫巧技的文章：</p>
<ul>
<li><a href="https://imzlp.com/posts/15049/">UE4：Hook UObject</a></li>
</ul>
<p>UE 的反射实现是依赖于构建系统中 UHT 来执行代码生成的，本篇文章对 UE 的反射做一个基础概念介绍，后续会花几篇文章完整地介绍 UE 里反射的实现机制。</p>
<span id="more"></span>

<p>UE 的反射可以实现 Enum 的反射 (<code>UEnum</code>)、类反射(<code>UClass</code>)、结构反射(<code>UStruct</code>)、数据成员反射(<code>UProperty</code>/<code>FProperty</code>)、成员函数反射(<code>UFunction</code>)，可以在运行时访问到它们，其实反射被称作<strong> 属性系统 </strong> 应该更合适。</p>
<p>可以根据这些反射信息来获取它们的类型信息，本篇文章以类反射为例子介绍一下 UE 的反射。</p>
<p>如以下纯 C++ 代码：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassRef</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    int32 ival = <span class="number">666</span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">func</span><span class="params">(int32 InIval)</span></span>&#123; <span class="keyword">return</span> <span class="literal">false</span>;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>想要在运行时获取 <code>ClassRef</code> 类有哪些数据成员、函数，要如何操作？</p>
<p>C++ 原生并没有提供这样的能力，相同的需求在 UE 中创建的类是以下形式：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;RefObject.generated.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">UCLASS</span>()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">REF_API</span> <span class="title">URefObject</span> :</span> <span class="keyword">public</span> UObject</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">UPROPERTY</span>()</span><br><span class="line">	int32 ival = <span class="number">666</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">func</span><span class="params">(int32 InIval)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">    	<span class="built_in">UE_LOG</span>(LogTemp,Log,<span class="built_in">TEXT</span>(<span class="string">&quot;Function func: %d&quot;</span>),InIval);</span><br><span class="line">    	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中关键需要注意的点：</p>
<ol>
<li><code>RefObject.generated.h</code>文件</li>
<li>UCLASS 标记</li>
<li>GENERATED_BODY 标记</li>
<li>UPROPERTY 标记</li>
<li>UFUNCTION 标记</li>
</ol>
<p>本文不对它们的具体含义做过多的介绍，后续的文章会做详细的分析。</p>
<p><code>UCLASS</code>/<code>USTRUCT</code>/<code>UFUNCTION</code>/<code>UPROPERTY</code>等可以在 <code>()</code> 中添加很多的标记值以及 meta 参数，用于指导 UHT 来生成对应的反射代码，它们支持的参数可以在 UE 的文档中查看：</p>
<ul>
<li><a href="https://docs.unrealengine.com/en-US/Programming/UnrealArchitecture/Reference/Classes/Specifiers">Class Specifiers</a></li>
<li><a href="https://docs.unrealengine.com/en-US/ProgrammingAndScripting/GameplayArchitecture/Structs/Specifiers/index.html">Struct Specifiers</a></li>
<li><a href="https://docs.unrealengine.com/en-us/Programming/UnrealArchitecture/Reference/Functions/Specifiers">Function Specifiers</a></li>
<li><a href="https://docs.unrealengine.com/en-US/ProgrammingAndScripting/GameplayArchitecture/Properties/Specifiers/index.html">Property Specifiers</a></li>
<li><a href="https://docs.unrealengine.com/en-US/ProgrammingAndScripting/GameplayArchitecture/Metadata/index.html">Metadata Specifiers</a></li>
</ul>
<p>这种通过添加的 <strong> 代码标记 </strong> 来告诉 UE 的构建系统，由 UHT 来生成反射的代码，反射的代码保存在 <code>gen.cpp</code> 中，注意这些反射标记 <strong> 只是 </strong> 用来告诉 UHT 来生成代码的，在经过 C++ 的预处理阶段后它们大多都是空宏（有些是真的 C++ 宏），这也导致 UE 的反射标记有一个缺点：无法使用 C++ 的宏来包裹 UE 的反射标记，因为它们先于 <strong> 预处理 </strong> 执行。</p>
<blockquote>
<p>而且，UHT 只是简单粗暴的关键字匹配硬扫描，限制很大。</p>
</blockquote>
<p>对于继承自 UObject 的类而言，它的反射信息被创建出了一个 UClass 对象，可以通过这个对象在运行时获取对象类型的信息。并且，类内部的 <strong> 反射数据成员 </strong> 和<strong>反射成员函数 </strong>，都会给生成对应的<code>FProperty</code> 和<code>UFunction</code>对象，用来运行时访问到它们。</p>
<p>UClass 的继承关系：</p>
<pre><code>UObjectBase
  UObjectBaseUtility
    UObject
      UField
        UStruct
          UClass
</code></pre>
<p>针对继承自 UObject 的类，可以通过 <code>GetClass()</code> 来获取 UClass 实例，但是如果想直接获取某个类型的 UClass，则可以通过 <code>StaticClass&lt;UObject&gt;</code> 或者 <code>UObject::StaticClass()</code> 来获取。</p>
<p>UClass 中记录这类的继承关系、实现的接口、各种 Flag 等等，具体可以直接查阅 UClass 的类定义，通过它可以访问到该 UObject 的 C++ 类型中的信息。</p>
<p>而且，在运行时可以通过 <code>TFieldIterator</code> 来遍历 UClass 中的反射属性：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">URefObject::<span class="built_in">URefObject</span>(<span class="keyword">const</span> FObjectInitializer&amp; Initializer):<span class="built_in">Super</span>(Initializer)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>(TFieldIterator&lt;FProperty&gt; <span class="built_in">PropertyIter</span>(<span class="built_in">GetClass</span>());PropertyIter;++PropertyIter)</span><br><span class="line">    &#123;</span><br><span class="line">        FProperty* PropertyIns = *PropertyIter;</span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogTemp,Log,<span class="built_in">TEXT</span>(<span class="string">&quot;Property Name: %s&quot;</span>),*PropertyIns-&gt;<span class="built_in">GetName</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(TFieldIterator&lt;UFunction&gt; <span class="built_in">PropertyIter</span>(<span class="built_in">GetClass</span>());PropertyIter;++PropertyIter)</span><br><span class="line">    &#123;</span><br><span class="line">        UFunction* PropertyIns = *PropertyIter;</span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogTemp,Log,<span class="built_in">TEXT</span>(<span class="string">&quot;Function Name: %s&quot;</span>),*PropertyIns-&gt;<span class="built_in">GetName</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">LogTemp: Property Name: ival</span><br><span class="line">LogTemp: Function Name: func</span><br><span class="line">LogTemp: Function Name: ExecuteUbergraph</span><br></pre></td></tr></table></figure>

<p>那么如何通过属性和成员函数的反射信息来访问到它们呢？</p>
<h3 id="访问数据成员"><a href="# 访问数据成员" class="headerlink" title="访问数据成员"></a>访问数据成员 </h3><p> 首先，在 C++ 中类内存布局中是编译时固定的，所以一个数据成员在类中的位置是固定的，C++ 有一个特性叫做 <strong> 指向类成员的指针</strong>，本质上就是描述了当前数据成员在类布局内的偏移值。这部分内容在我之前的文章中有介绍：<a href="https://imzlp.com/posts/27615/">C++ 中指向类成员的指针并非指针</a>。</p>
<p>FProperty 做的就是类似的事情，记录反射数据成员的类内偏移信息，UE 中的实现也是通过 <strong> 指向成员的指针 </strong> 来实现的，这部分后面的文章会着重介绍，这里只介绍使用方法。</p>
<p>通过 FProperty 获取对象中值的方式，需要通过调用 <code>FProperty</code> 的<code>ContainerPtrToValuePtr</code>来实现：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span>(TFieldIterator&lt;FProperty&gt; <span class="built_in">PropertyIter</span>(<span class="built_in">GetClass</span>());PropertyIter;++PropertyIter)</span><br><span class="line">&#123;</span><br><span class="line">    FProperty* PropertyIns = *PropertyIter;</span><br><span class="line">    <span class="keyword">if</span>(PropertyIns-&gt;<span class="built_in">GetName</span>().<span class="built_in">Equals</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ival&quot;</span>)))</span><br><span class="line">    &#123;</span><br><span class="line">        int32* i32 = PropertyIns-&gt;ContainerPtrToValuePtr&lt;int32&gt;(<span class="keyword">this</span>);            </span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogTemp,Log,<span class="built_in">TEXT</span>(<span class="string">&quot;Property %s value is %d&quot;</span>),*PropertyIns-&gt;<span class="built_in">GetName</span>(),*i32);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/12624/fproperty-get-data-member-value.webp"></p>
<p>这样就实现了通过 FProperty 来访问数据成员的目的，因为获取到的是数据成员的指针，所以修改它也是没问题的。</p>
<h3 id="访问成员函数"><a href="# 访问成员函数" class="headerlink" title="访问成员函数"></a>访问成员函数 </h3><p> 通过反射访问函数则要复杂一些，因为要处理参数传递和返回值的接收问题。</p>
<p>前面已经提到了，UE 的反射成员函数会生成 <code>UFunction</code> 对象，函数的反射信息就在它里面，因为 UFUNCTION 是只能标记在继承自 UObject 的类中，所以 UE 封装了一套基于 UObject 的反射函数调用方式：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// defined in UObject</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ProcessEvent</span></span></span><br><span class="line"><span class="function"><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    UFunction * Function,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">void</span> * Parms</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<p>只有两个参数，第一个是传入 UFunction 的指针，第二个是 <code>void*</code> 指针，作为通用的方式来传递参数和接收返回值。<br>对于标记为 UFUNCTION 的函数，UHT 会为该函数生成一个 Thunk 函数，形如以下形式：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">DEFINE_FUNCTION</span>(URefObject::execfunc)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">P_GET_PROPERTY</span>(FIntProperty,Z_Param_InIval);</span><br><span class="line">    P_FINISH;</span><br><span class="line">    P_NATIVE_BEGIN;</span><br><span class="line">    *(<span class="keyword">bool</span>*)Z_Param__Result=P_THIS-&gt;<span class="built_in">func</span>(Z_Param_InIval);</span><br><span class="line">    P_NATIVE_END;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>把 <code>DEFINE_FUNCTION</code> 宏展开之后就是固定的原型了：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFINE_FUNCTION(func) void func(UObject* Context, FFrame&amp; Stack, RESULT_DECL)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">URefObject::execfunc</span><span class="params">(UObject* Context, FFrame&amp; Stack, RESULT_DECL)</span></span></span><br></pre></td></tr></table></figure>
<p>在 <code>ProcessEvent</code> 会按照这个统一的原型去调用反射函数的 Thunk 函数，在从 Thunk 函数转发给真正的 C++ 函数，实现基于反射调用到真正 C++ 函数的目的，当然也可以通过在 <code>UFUNCTION</code> 中添加 <code>CustomThunk</code> 标记，不让 UHT 生成函数的 Thunk 函数，自己手动提供，可以用来解决特殊的需求（如 unlua 中的覆写）。</p>
<p>现在回到<code>ProcessEvent</code>，它的函数原型中有三个关键点：</p>
<ol>
<li><code>ProcessEvent</code>是 <code>UObject</code> 的成员函数</li>
<li><code>ProcessEvent</code>的第一个参数要是当前类中的 UFunction</li>
<li><code>void* Parms</code>必须要是连续内存结构</li>
</ol>
<p>着重要讲的就是 <code>void* Parms</code> 怎么用。</p>
<p>首先，对于示例函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">func</span><span class="params">(int32 InIval)</span></span>;</span><br></pre></td></tr></table></figure>

<p>它接收一个参数，并返回一个 bool 值，如何通过一个参数来同时做这两件事情呢？</p>
<p>把他们封装为一个结构！如同下面这种形式：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">RefObject_eventFunc_Parms</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	int32 ival;</span><br><span class="line">	<span class="keyword">bool</span> ReturnValue;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>要传递给函数的参数排在前面，返回值为最后一个数据成员（如果有的话）。而且，也是可以通过 <code>UFunction::ParmsSize</code> 得到当前函数所有参数 + 返回值结构的大小，在运行时动态分配，并且可以通过 <code>UFunction</code> 的各个参数 <code>FProperty</code> 来访问到每个参数的内存，这部分内容暂时按下不表，后面的文章会详细的介绍。</p>
<p>所以，当我们通过 <code>UClass</code> 拿到指定的 UFunction 之后就可以做这个事情了：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span>(TFieldIterator&lt;UFunction&gt; <span class="built_in">PropertyIter</span>(<span class="built_in">GetClass</span>());PropertyIter;++PropertyIter)</span><br><span class="line">&#123;</span><br><span class="line">    UFunction* FuncIns = *PropertyIter;</span><br><span class="line">    <span class="keyword">if</span>(FuncIns-&gt;<span class="built_in">GetName</span>().<span class="built_in">Equals</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;func&quot;</span>)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">RefObject_eventFunc_Parms</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            int32 ival;</span><br><span class="line">            <span class="keyword">bool</span> ReturnValue;</span><br><span class="line">        &#125;func_params;</span><br><span class="line">        func_params.ival = <span class="number">111</span>;</span><br><span class="line">        <span class="keyword">this</span>-&gt;<span class="built_in">ProcessEvent</span>(FuncIns,&amp;func_params);</span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogTemp,Log,<span class="built_in">TEXT</span>(<span class="string">&quot;call func return: %s&quot;</span>),func_params.ReturnValue?<span class="built_in">TEXT</span>(<span class="string">&quot;true&quot;</span>):<span class="built_in">TEXT</span>(<span class="string">&quot;false&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">UE_LOG</span>(LogTemp,Log,<span class="built_in">TEXT</span>(<span class="string">&quot;Function Name: %s&quot;</span>),*FuncIns-&gt;<span class="built_in">GetName</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/12624/process-event-callstack.webp"></p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/12624/uobject-process-event.webp"></p>
<p>但是这样基于反射机制的函数调用有一个问题：无法处理参数和返回值为引用的情况。如：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function">int32&amp; <span class="title">Add</span><span class="params">(int32 R, int32&amp; L)</span></span>;</span><br><span class="line"><span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function">int32 <span class="title">Add</span><span class="params">(int32 R, int32 L)</span></span>;</span><br></pre></td></tr></table></figure>

<p>这两个函数生成的反射信息一摸一样！（对 L 参数生成的 FProperty 的 Flag 会多一个 <code>CPF_OutParm</code>，返回值的 FProperty 还具有 <code>CPF_ReturnParm</code>）。</p>
<p>因为 C++ 的引用必须要在初始化时进行绑定的：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassRef</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">ClassRef</span>(<span class="keyword">int</span>&amp; InIval):<span class="built_in">ival</span>(InIval)&#123;&#125;</span><br><span class="line">    <span class="keyword">int</span>&amp; ival;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// instance</span></span><br><span class="line"><span class="keyword">int</span> ival =<span class="number">666</span>;</span><br><span class="line"><span class="function">ClassRef <span class="title">obj</span><span class="params">(ival)</span></span>;</span><br></pre></td></tr></table></figure>

<p>这就对 UHT 的参数结构造成了限制，因为默认情况下 UHT 给每个反射函数生成了参数结构，是通过先实例化，再把真正的参数赋值给该实例中成员的，就跟上面的例子一样，做了一次值拷贝。而引用无法修改，只能在初始化时设置。在调用 ProcessEvent 时，真正调用到 C++ 函数的时候，如果参数有引用则是绑定到的该 UHT 生成的结构中数据成员，而不是我们真实传递的参数。</p>
<p>基于反射的函数调用实际上进行了两步操作：</p>
<ol>
<li>把参数赋值给 ProcessEvent 的函数参数结构</li>
<li>ProcessEvent 再把参数结构传递给真正的 C++ 函数</li>
</ol>
<p>这会造成通过 <code>UFunction*</code> 调用 ProcessEvent 传递的参数和想要获取的返回值也都只是原始参数的一份拷贝，而不是真正绑定的引用关系（因为本来调用时的参数传递到 ProcessEvent 之前都会被赋值到 UHT 创建出来的参数结构），在真正的 C++ 函数中对引用参数的修改也只能改动 UHT 生产的参数结构实例，而非我们传递的真正的参数。</p>
<p>本篇文章对 UE 的反射做了一个简单的介绍，并示例了通过 <code>UClass</code> 获取反射信息来访问数据成员和成员函数的方式，UE 中反射的实现会在后续的文章中详细介绍，下一篇会介绍 UE 反射实现所依赖的 C++ 特性，目前文章已发表：<a href="https://imzlp.com/posts/23694/">UE4 反射实现分析：C++ 特性</a>。</p>
<p>参考资料：</p>
<ul>
<li><a href="https://www.unrealengine.com/en-US/blog/unreal-property-system-reflection?sessionInvalidated=true">Unreal Property System (Reflection)</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>反射</category>
      </categories>
      <tags>
        <tag>反射</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 反射实现分析：反射代码生成（一）</title>
    <url>/wiki/9780/</url>
    <content><![CDATA[<p>之前写了两篇 UE 中实现反射的文章分析，介绍了 UE 的反射基础概念和依赖的一些 C++ 特性，本篇文章开始分析 UE 反射实现的具体流程。</p>
<p>C++ 标准中并没有反射的特性，UE 使用的反射是基于 <strong> 标记语法 </strong> 和<strong>UHT 扫描生成辅助代码 </strong> 来实现的一套机制，正如 <a href="https://en.wikipedia.org/wiki/David_Wheeler_(computer_scientist)">David Wheeler</a> 的那句名言一样：“<em>All problems in computer science can be solved by another level of indirection</em>”，UHT 做的就是这样的事情，在真正执行编译之前分析标记代码并产生真正的 C++ 代码，收集反射类型的元数据，供运行时之用。</p>
<p>UHT 生成的代码内容很多，为了避免文章组织上的混乱，本篇文章主要讲 <code>GENERATED_BODY</code>/<code>UFUNCTION</code> 等反射标记通过 UHT 之后生成到 <code>generated.h</code> 中的 <strong> 真正的 C++ 代码</strong>。</p>
<p>UHT 生成的代码分别在 <code>generated.h</code> 和<code>gen.cpp</code>中，<code>generated.h</code>中的代码大多是定义了一些宏，用在所声明的类内通过编译器预处理来添加通用成员，<code>gen.cpp</code>中的代码则是 UHT 基于反射标记生成的用来描述类反射信息的具体代码，<code>genrated.h</code>和 <code>gen.cpp</code> 也是为了声明和定义分离。</p>
<span id="more"></span>

<p>UE 的 <a href="https://www.unrealengine.com/en-US/feed">Feeds</a> 中写过一篇关于 UE Property System 的文章：<a href="https://www.unrealengine.com/en-US/blog/unreal-property-system-reflection">Unreal Property System(Reflection)</a></p>
<p>UE 与反射相关的 <strong>UHT 宏标记</strong> 大多定义在下列几个头文件中：</p>
<ul>
<li><a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h">Runtime/CoreUObject/Public/Object/ObjectMacros.h</a> （UHT 标记）</li>
<li><a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/CoreUObject/Public/UObject/ScriptMacros.h">Runtime/CoreUObject/Public/Object/ScriptMacros.h</a>（大多是 <code>P_*</code> 的宏，可以利用反射从 <code>Stack</code> 中获取数据）</li>
<li><a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/CoreUObject/Public/UObject/Class.h">Runtime/CoreUObject/Public/UObject/Class.h</a> （反射基类的定义 <code>UField</code>/<code>UEnum</code>/<code>UStruct</code>/<code>UClass</code> 等）</li>
</ul>
<blockquote>
<p>注意：不同的引擎版本，有些代码变更幅度很大，要结合具体的引擎版本做参考，重点是分析方法。</p>
</blockquote>
<h2 id="GENERATED-BODY"><a href="#GENERATED-BODY" class="headerlink" title="GENERATED_BODY"></a>GENERATED_BODY</h2><p>每一个在 UE 中继承自 <code>UObject</code> 的 C++ 类或者声明的 USTRUCT 类，在类声明中都会有一个 <code>GENERATED_XXXX</code> 的系列宏：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// This pair of macros is used to help implement GENERATED_BODY() and GENERATED_USTRUCT_BODY()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BODY_MACRO_COMBINE_INNER(A,B,C,D) A##B##C##D</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BODY_MACRO_COMBINE(A,B,C,D) BODY_MACRO_COMBINE_INNER(A,B,C,D)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Include a redundant semicolon at the end of the generated code block, so that intellisense parsers can start parsing</span></span><br><span class="line"><span class="comment">// a new declaration if the line number/generated code is out of date.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GENERATED_BODY_LEGACY(...) BODY_MACRO_COMBINE(CURRENT_FILE_ID,_,__LINE__,_GENERATED_BODY_LEGACY);</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GENERATED_BODY(...) BODY_MACRO_COMBINE(CURRENT_FILE_ID,_,__LINE__,_GENERATED_BODY);</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GENERATED_USTRUCT_BODY(...) GENERATED_BODY()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GENERATED_UCLASS_BODY(...) GENERATED_BODY_LEGACY()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GENERATED_UINTERFACE_BODY(...) GENERATED_BODY_LEGACY()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GENERATED_IINTERFACE_BODY(...) GENERATED_BODY_LEGACY()</span></span><br></pre></td></tr></table></figure>
<p>直接看起来并没什么用！就是拼接了一个字符串而已。但是真相却往往另有玄机，搞清楚它可以顺便厘清在工作中写代码遇到的一系列会造成疑惑的问题，本节来分析一下 <code>GENERATED_</code> 宏的作用。</p>
<p>考虑下列类代码：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// NetActor.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;NetActor.generated.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">UCLASS</span>()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ANetActor</span> :</span><span class="keyword">public</span> AActor</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>() <span class="comment">// 注意这个宏在 NetActor.h 的第八行</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">		<span class="function">int32 <span class="title">GetHp</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">SetHp</span><span class="params">(int32 pNewHp)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="built_in">UPROPERTY</span>()</span><br><span class="line">		int32 mHP;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NetActor.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;NetActor.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">int32 <span class="title">ANetActor::GetHp</span><span class="params">()</span><span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> mHP;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ANetActor::SetHp</span><span class="params">(int32 pNewHp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	mHP = pNewHp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当我们在编译时，UBT 会驱动 UHT 为我们写的这个类生成 <code>NetActor.generated.h</code> 和<code>NetActor.gen.cpp</code>文件。<br><code>*.generated.h</code>与 <code>*.gen.cpp</code> 文件存放与下列路径(相对于项目根目录)：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Intermediate\Build\Win64\UE4Editor\Inc\&#123;PROJECT_NAME&#125;</span><br></pre></td></tr></table></figure>
<p>其中在 <code>NetActor.generated.h</code> 中的代码，是 UHT 分析我们写的 <code>NetActor.h</code> 生成的代码 (都是宏定义，供后面使用)。<br> 在分析 <code>generated.h</code> 之前需要先来说一下 <code>GENERATED_BODY</code> 与<code>GENERATED_UCLASS_BODY</code>宏。根据本节开头列出的 UE 所支持的一系列 <code>GENERATED_</code> 宏，单纯从宏展开的角度看，<code>GENERATED_BODY</code>与 <code>GENERATED_UCLASS_BODY</code> 的区别就是：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># GENERATED_BODY 最终生成了这样的一串字符：</span></span><br><span class="line">&#123;CURRENT_FILE_ID&#125;_&#123;__LINE__&#125;_GENERATED_BODY</span><br><span class="line"><span class="comment"># GENERATED_UCLASS_BODY 最终生成的是这样的一串字符串：</span></span><br><span class="line">&#123;CURRENT_FILE_ID&#125;_&#123;__LINE__&#125;_GENERATED_BODY_LEGACY</span><br></pre></td></tr></table></figure>
<p>注意：这里用 <code>&#123;&#125;</code> 括着的是其他的宏组成的，这里只是列出来两个宏的不同形式。</p>
<ul>
<li><code>CURRENT_FILE_ID</code>为 <code> 项目所在的文件夹的名字_源文件相对路径_h</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># e.g</span></span><br><span class="line"><span class="comment"># ReflectionExample\Source\ReflectionExample\NetActor.h</span></span><br><span class="line">ReflectionExample_Source_ReflectionExample_NetActor_h</span><br></pre></td></tr></table></figure>
<ul>
<li><code>__LINE__</code>为这条宏所在的文件的行数，也就是上面代码中备注说的第八行。</li>
</ul>
<p>那么 <code>GENERATED_BODY</code> 与<code>GENERATED_UCLASS_BODY</code>所拼接的实际字符串就是：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// GENERATED_BODY</span></span><br><span class="line">ReflectionExample_Source_ReflectionExample_NetActor_h_8_GENERATED_BODY</span><br><span class="line"><span class="comment">// GENERATED_UCLASS_BODY</span></span><br><span class="line">ReflectionExample_Source_ReflectionExample_NetActor_h_8_GENERATED_BODY_LEGACY</span><br></pre></td></tr></table></figure>
<p>说了这么一大堆，那么就算拼接出来了两个这么长的字符，又是干什么用的呢？</p>
<p>此时，打开我们的 <code>NetActor.generated.h</code> 文件，可以看到其中定义了一大堆宏的代码：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Copyright 1998-2019 Epic Games, Inc. All Rights Reserved.</span></span><br><span class="line"><span class="comment">/*===========================================================================</span></span><br><span class="line"><span class="comment">	Generated code exported from UnrealHeaderTool.</span></span><br><span class="line"><span class="comment">	DO NOT modify this manually! Edit the corresponding .h files instead!</span></span><br><span class="line"><span class="comment">===========================================================================*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;UObject/ObjectMacros.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;UObject/ScriptMacros.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">PRAGMA_DISABLE_DEPRECATION_WARNINGS</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> REFLECTIONEXAMPLE_NetActor_generated_h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">error</span> <span class="meta-string">&quot;NetActor.generated.h already included, missing &#x27;#pragma once&#x27; in NetActor.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REFLECTIONEXAMPLE_NetActor_generated_h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ReflectionExample_Source_ReflectionExample_NetActor_h_8_RPC_WRAPPERS \</span></span><br><span class="line"><span class="meta"> \</span></span><br><span class="line"><span class="meta">	DECLARE_FUNCTION(execSetHp) \</span></span><br><span class="line"><span class="meta">	&#123; \</span></span><br><span class="line"><span class="meta">		P_GET_PROPERTY(UIntProperty,Z_Param_pNewHp); \</span></span><br><span class="line"><span class="meta">		P_FINISH; \</span></span><br><span class="line"><span class="meta">		P_NATIVE_BEGIN; \</span></span><br><span class="line"><span class="meta">		P_THIS-&gt;SetHp(Z_Param_pNewHp); \</span></span><br><span class="line"><span class="meta">		P_NATIVE_END; \</span></span><br><span class="line"><span class="meta">	&#125; \</span></span><br><span class="line"><span class="meta"> \</span></span><br><span class="line"><span class="meta">	DECLARE_FUNCTION(execGetHp) \</span></span><br><span class="line"><span class="meta">	&#123; \</span></span><br><span class="line"><span class="meta">		P_FINISH; \</span></span><br><span class="line"><span class="meta">		P_NATIVE_BEGIN; \</span></span><br><span class="line"><span class="meta">		*(int32*)Z_Param__Result=P_THIS-&gt;GetHp(); \</span></span><br><span class="line"><span class="meta">		P_NATIVE_END; \</span></span><br><span class="line"><span class="meta">	&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ReflectionExample_Source_ReflectionExample_NetActor_h_8_RPC_WRAPPERS_NO_PURE_DECLS \</span></span><br><span class="line"><span class="meta"> \</span></span><br><span class="line"><span class="meta">	DECLARE_FUNCTION(execSetHp) \</span></span><br><span class="line"><span class="meta">	&#123; \</span></span><br><span class="line"><span class="meta">		P_GET_PROPERTY(UIntProperty,Z_Param_pNewHp); \</span></span><br><span class="line"><span class="meta">		P_FINISH; \</span></span><br><span class="line"><span class="meta">		P_NATIVE_BEGIN; \</span></span><br><span class="line"><span class="meta">		P_THIS-&gt;SetHp(Z_Param_pNewHp); \</span></span><br><span class="line"><span class="meta">		P_NATIVE_END; \</span></span><br><span class="line"><span class="meta">	&#125; \</span></span><br><span class="line"><span class="meta"> \</span></span><br><span class="line"><span class="meta">	DECLARE_FUNCTION(execGetHp) \</span></span><br><span class="line"><span class="meta">	&#123; \</span></span><br><span class="line"><span class="meta">		P_FINISH; \</span></span><br><span class="line"><span class="meta">		P_NATIVE_BEGIN; \</span></span><br><span class="line"><span class="meta">		*(int32*)Z_Param__Result=P_THIS-&gt;GetHp(); \</span></span><br><span class="line"><span class="meta">		P_NATIVE_END; \</span></span><br><span class="line"><span class="meta">	&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ReflectionExample_Source_ReflectionExample_NetActor_h_8_INCLASS_NO_PURE_DECLS \</span></span><br><span class="line"><span class="meta">private: \</span></span><br><span class="line"><span class="meta">	static void StaticRegisterNativesANetActor(); \</span></span><br><span class="line"><span class="meta">	friend struct Z_Construct_UClass_ANetActor_Statics; \</span></span><br><span class="line"><span class="meta">public: \</span></span><br><span class="line"><span class="meta">	DECLARE_CLASS(ANetActor, AActor, COMPILED_IN_FLAGS(CLASS_Abstract), CASTCLASS_None, TEXT(<span class="meta-string">&quot;/Script/ReflectionExample&quot;</span>), NO_API) \</span></span><br><span class="line"><span class="meta">	DECLARE_SERIALIZER(ANetActor)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ReflectionExample_Source_ReflectionExample_NetActor_h_8_INCLASS \</span></span><br><span class="line"><span class="meta">private: \</span></span><br><span class="line"><span class="meta">	static void StaticRegisterNativesANetActor(); \</span></span><br><span class="line"><span class="meta">	friend struct Z_Construct_UClass_ANetActor_Statics; \</span></span><br><span class="line"><span class="meta">public: \</span></span><br><span class="line"><span class="meta">	DECLARE_CLASS(ANetActor, AActor, COMPILED_IN_FLAGS(CLASS_Abstract), CASTCLASS_None, TEXT(<span class="meta-string">&quot;/Script/ReflectionExample&quot;</span>), NO_API) \</span></span><br><span class="line"><span class="meta">	DECLARE_SERIALIZER(ANetActor)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ReflectionExample_Source_ReflectionExample_NetActor_h_8_STANDARD_CONSTRUCTORS \</span></span><br><span class="line"><span class="meta">	<span class="comment">/** Standard constructor, called after all reflected properties have been initialized */</span> \</span></span><br><span class="line"><span class="meta">	NO_API ANetActor(const FObjectInitializer&amp; ObjectInitializer = FObjectInitializer::Get()); \</span></span><br><span class="line"><span class="meta">	DEFINE_DEFAULT_OBJECT_INITIALIZER_CONSTRUCTOR_CALL(ANetActor) \</span></span><br><span class="line"><span class="meta">	DECLARE_VTABLE_PTR_HELPER_CTOR(NO_API, ANetActor); \</span></span><br><span class="line"><span class="meta">DEFINE_VTABLE_PTR_HELPER_CTOR_CALLER(ANetActor); \</span></span><br><span class="line"><span class="meta">private: \</span></span><br><span class="line"><span class="meta">	<span class="comment">/** Private move- and copy-constructors, should never be used */</span> \</span></span><br><span class="line"><span class="meta">	NO_API ANetActor(ANetActor&amp;&amp;); \</span></span><br><span class="line"><span class="meta">	NO_API ANetActor(const ANetActor&amp;); \</span></span><br><span class="line"><span class="meta">public:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ReflectionExample_Source_ReflectionExample_NetActor_h_8_ENHANCED_CONSTRUCTORS \</span></span><br><span class="line"><span class="meta">	<span class="comment">/** Standard constructor, called after all reflected properties have been initialized */</span> \</span></span><br><span class="line"><span class="meta">	NO_API ANetActor(const FObjectInitializer&amp; ObjectInitializer = FObjectInitializer::Get()) : Super(ObjectInitializer) &#123; &#125;; \</span></span><br><span class="line"><span class="meta">private: \</span></span><br><span class="line"><span class="meta">	<span class="comment">/** Private move- and copy-constructors, should never be used */</span> \</span></span><br><span class="line"><span class="meta">	NO_API ANetActor(ANetActor&amp;&amp;); \</span></span><br><span class="line"><span class="meta">	NO_API ANetActor(const ANetActor&amp;); \</span></span><br><span class="line"><span class="meta">public: \</span></span><br><span class="line"><span class="meta">	DECLARE_VTABLE_PTR_HELPER_CTOR(NO_API, ANetActor); \</span></span><br><span class="line"><span class="meta">DEFINE_VTABLE_PTR_HELPER_CTOR_CALLER(ANetActor); \</span></span><br><span class="line"><span class="meta">	DEFINE_DEFAULT_OBJECT_INITIALIZER_CONSTRUCTOR_CALL(ANetActor)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ReflectionExample_Source_ReflectionExample_NetActor_h_8_PRIVATE_PROPERTY_OFFSET \</span></span><br><span class="line"><span class="meta">	FORCEINLINE static uint32 __PPO__mHP() &#123; return STRUCT_OFFSET(ANetActor, mHP); &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ReflectionExample_Source_ReflectionExample_NetActor_h_5_PROLOG</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ReflectionExample_Source_ReflectionExample_NetActor_h_8_GENERATED_BODY_LEGACY \</span></span><br><span class="line"><span class="meta">PRAGMA_DISABLE_DEPRECATION_WARNINGS \</span></span><br><span class="line"><span class="meta">public: \</span></span><br><span class="line"><span class="meta">	ReflectionExample_Source_ReflectionExample_NetActor_h_8_PRIVATE_PROPERTY_OFFSET \</span></span><br><span class="line"><span class="meta">	ReflectionExample_Source_ReflectionExample_NetActor_h_8_RPC_WRAPPERS \</span></span><br><span class="line"><span class="meta">	ReflectionExample_Source_ReflectionExample_NetActor_h_8_INCLASS \</span></span><br><span class="line"><span class="meta">	ReflectionExample_Source_ReflectionExample_NetActor_h_8_STANDARD_CONSTRUCTORS \</span></span><br><span class="line"><span class="meta">public: \</span></span><br><span class="line"><span class="meta">PRAGMA_ENABLE_DEPRECATION_WARNINGS</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ReflectionExample_Source_ReflectionExample_NetActor_h_8_GENERATED_BODY \</span></span><br><span class="line"><span class="meta">PRAGMA_DISABLE_DEPRECATION_WARNINGS \</span></span><br><span class="line"><span class="meta">public: \</span></span><br><span class="line"><span class="meta">	ReflectionExample_Source_ReflectionExample_NetActor_h_8_PRIVATE_PROPERTY_OFFSET \</span></span><br><span class="line"><span class="meta">	ReflectionExample_Source_ReflectionExample_NetActor_h_8_RPC_WRAPPERS_NO_PURE_DECLS \</span></span><br><span class="line"><span class="meta">	ReflectionExample_Source_ReflectionExample_NetActor_h_8_INCLASS_NO_PURE_DECLS \</span></span><br><span class="line"><span class="meta">	ReflectionExample_Source_ReflectionExample_NetActor_h_8_ENHANCED_CONSTRUCTORS \</span></span><br><span class="line"><span class="meta">private: \</span></span><br><span class="line"><span class="meta">PRAGMA_ENABLE_DEPRECATION_WARNINGS</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt; REFLECTIONEXAMPLE_API UClass* StaticClass&lt;<span class="class"><span class="keyword">class</span> <span class="title">ANetActor</span>&gt;</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> CURRENT_FILE_ID</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CURRENT_FILE_ID ReflectionExample_Source_ReflectionExample_NetActor_h</span></span><br><span class="line"></span><br><span class="line">PRAGMA_ENABLE_DEPRECATION_WARNINGS</span><br></pre></td></tr></table></figure>
<p>看到了嘛！这个生成的 <code>generated.h</code> 里定义了上面我们写的那些宏：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">CURRENT_FILE_ID</span><br><span class="line"><span class="comment">// GENERATED_BODY</span></span><br><span class="line">ReflectionExample_Source_ReflectionExample_NetActor_h_8_GENERATED_BODY</span><br><span class="line"><span class="comment">// GENERATED_UCLASS_BODY</span></span><br><span class="line">ReflectionExample_Source_ReflectionExample_NetActor_h_8_GENERATED_BODY_LEGACY</span><br></pre></td></tr></table></figure>
<p>因为我们的 <code>NetActor.h</code> 中包含了 <code>NetActo.generated.h</code> 这个头文件，所以在真正进行编译的时候会将 <code>GENERATED_BODY</code> 进行宏展开，展开的内容就是 <code>NetActor.generated.h</code> 中的宏 <code>ReflectionExample_Source_ReflectionExample_NetActor_h_8_GENERATED_BODY</code> 展开之后的代码。</p>
<p>因为我在 <code>NetActor.h</code> 中使用的是<code>GENERATED_BODY</code>，我就先分析这个宏展开之后的真实代码。</p>
<blockquote>
<p>其实 <code>GENERATED_BODY</code> 与<code>GENERATED_UCLASS_BODY</code>的区别在于：<code>GENERATED_BODY</code><strong>声明并定义 </strong> 了一个接收 <code>const FObjectInitializer&amp;</code> 的构造函数，<code>GENERATED_UCLASS_BODY</code><strong>只声明 </strong> 了该构造函数，需要用户自己提供一个定义。</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">ANetActor</span>(<span class="keyword">const</span> FObjectInitializer&amp; ObjectInitializer = FObjectInitializer::<span class="built_in">Get</span>());</span><br></pre></td></tr></table></figure>
<p><code>GENERATED_BODY</code>的真实宏名字又包裹了一层其他的宏：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ReflectionExample_Source_ReflectionExample_NetActor_h_8_GENERATED_BODY \</span></span><br><span class="line"><span class="meta">PRAGMA_DISABLE_DEPRECATION_WARNINGS \</span></span><br><span class="line"><span class="meta">public: \</span></span><br><span class="line"><span class="meta">  ReflectionExample_Source_ReflectionExample_NetActor_h_8_PRIVATE_PROPERTY_OFFSET \</span></span><br><span class="line"><span class="meta">  ReflectionExample_Source_ReflectionExample_NetActor_h_8_RPC_WRAPPERS_NO_PURE_DECLS \</span></span><br><span class="line"><span class="meta">  ReflectionExample_Source_ReflectionExample_NetActor_h_8_INCLASS_NO_PURE_DECLS \</span></span><br><span class="line"><span class="meta">  ReflectionExample_Source_ReflectionExample_NetActor_h_8_ENHANCED_CONSTRUCTORS \</span></span><br><span class="line"><span class="meta">private: \</span></span><br><span class="line"><span class="meta">PRAGMA_ENABLE_DEPRECATION_WARNINGS</span></span><br></pre></td></tr></table></figure>
<p>展开之后：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ANetActor</span>:</span><span class="keyword">public</span> AActor</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">DECLARE_FUNCTION</span>(execSetHp)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">P_GET_PROPERTY</span>(UIntProperty,Z_Param_pNewHp);</span><br><span class="line">		P_FINISH;</span><br><span class="line">		P_NATIVE_BEGIN;</span><br><span class="line">		P_THIS-&gt;<span class="built_in">SetHp</span>(Z_Param_pNewHp);</span><br><span class="line">		P_NATIVE_END;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">DECLARE_FUNCTION</span>(execGetHp)</span><br><span class="line">	&#123;</span><br><span class="line">		P_FINISH;</span><br><span class="line">		P_NATIVE_BEGIN;</span><br><span class="line">		*(int32*)Z_Param__Result=P_THIS-&gt;<span class="built_in">GetHp</span>();</span><br><span class="line">		P_NATIVE_END;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="keyword">private</span>: </span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">StaticRegisterNativesANetActor</span><span class="params">()</span></span>; </span><br><span class="line">	<span class="keyword">friend</span> <span class="class"><span class="keyword">struct</span> <span class="title">Z_Construct_UClass_ANetActor_Statics</span>;</span> </span><br><span class="line"><span class="keyword">public</span>: </span><br><span class="line">	<span class="built_in">DECLARE_CLASS</span>(ANetActor, AActor, <span class="built_in">COMPILED_IN_FLAGS</span>(<span class="number">0</span>), CASTCLASS_None, <span class="built_in">TEXT</span>(<span class="string">&quot;/Script/ReflectionExample&quot;</span>), NO_API) </span><br><span class="line">	<span class="built_in">DECLARE_SERIALIZER</span>(ANetActor)</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Standard constructor, called after all reflected properties have been initialized */</span> </span><br><span class="line">	<span class="function">NO_API <span class="title">ANetActor</span><span class="params">(<span class="keyword">const</span> FObjectInitializer&amp; ObjectInitializer = FObjectInitializer::Get())</span> : Super(ObjectInitializer) &#123;</span> &#125;; </span><br><span class="line"><span class="keyword">private</span>: </span><br><span class="line">	<span class="comment">/** Private move- and copy-constructors, should never be used */</span> </span><br><span class="line">	<span class="function">NO_API <span class="title">ANetActor</span><span class="params">(ANetActor&amp;&amp;)</span></span>; </span><br><span class="line">	<span class="function">NO_API <span class="title">ANetActor</span><span class="params">(<span class="keyword">const</span> ANetActor&amp;)</span></span>; </span><br><span class="line"><span class="keyword">public</span>: </span><br><span class="line">	<span class="built_in">DECLARE_VTABLE_PTR_HELPER_CTOR</span>(NO_API, ANetActor); </span><br><span class="line">	<span class="built_in">DEFINE_VTABLE_PTR_HELPER_CTOR_CALLER</span>(ANetActor); </span><br><span class="line">	<span class="built_in">DEFINE_DEFAULT_OBJECT_INITIALIZER_CONSTRUCTOR_CALL</span>(ANetActor)</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">UFUNCTION</span>() <span class="comment">// 注意这里的都是空宏了</span></span><br><span class="line">		<span class="function">int32 <span class="title">GetHp</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line">	<span class="built_in">UFUNCTION</span>() <span class="comment">// 注意这里的都是空宏了</span></span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">SetHp</span><span class="params">(int32 pNewHp)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="built_in">UPROPERTY</span>() <span class="comment">// 注意这里的都是空宏了</span></span><br><span class="line">		int32 mHP;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>可以看到其中使用了：</p>
<ul>
<li><code>DECLARE_CLASS</code>：声明定义当前类的几个关键信息：<code>Super</code>和 <code>ThisClass</code> 等<code>typedef</code>在此处被定义，以及 <code>StaticClass</code>/<code>StaticPackage</code>/<code>StaticClassCastFlags</code> 和重载的 <code>new</code> 也被定义；</li>
<li><code>DECLARE_FUNCTION</code>为使用 <code>UFUNCIONT</code> 标记的函数创建中间函数；</li>
<li><code>DECLARE_SERIALIZER</code>：重载 <code>&lt;&lt;</code> 使可以被 <code>FArchive</code> 序列化；</li>
<li><code>DECLARE_VTABLE_PTR_HELPER_CTOR</code>：声明一个接收 <code>FVTableHelper&amp;</code> 参数的构造函数；</li>
<li><code>DEFINE_VTABLE_PTR_HELPER_CTOR_CALLER_DUMMY</code>：用于 <code>HotReload</code>，唯一调用的地方是在<a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/CoreUObject/Public/UObject/Class.h">Class.h</a> 中的模板函数<code>InternalVTableHelperCtorCaller</code>；</li>
<li><code>DEFINE_DEFAULT_OBJECT_INITIALIZER_CONSTRUCTOR_CALL</code>：定义一个名为 <code>__DefaultConstructor</code> 的静态函数，其中是调用 <code>placement-new</code> 创建类对象（用于统一的内存分配），引擎中唯一调用的位置是在 <a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/CoreUObject/Public/UObject/Class.h">Class.h</a> 的模板函数<code>InternalConstructor</code>；</li>
</ul>
<p>因为我们没有在 <code>ANetActor</code> 这个类上标记 <code>XXXX_API</code>，所以它不会被导出，UHT 生成的类<code>ANetActor</code> 的构造函数中都使用的是<code>NO_API</code>.</p>
<p>还有，因为 <code>UFUNCTION</code> 之类的宏在 C++ 的定义里都是 <strong> 空宏 </strong>，其实严格来说他们并不能称之为<strong> 宏</strong>，它们 <strong> 只是对 UHT 的标记 </strong>，用于通过 UHT 来解析生成<code>.generated.h</code> 和<code>.gen.cpp</code>的代码，所以在执行完 UHT 之后，对于 C++ 和编译器来说它们就是不存在的(在预处理之后就是彻底不存在的了)。</p>
<p>这几个宏 (被 UHT 生成之后就是真正的 C++ 宏了)，可以在<a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h">CoreUObject/Public/UObject/OBjectMacros.h</a> 中找到定义。</p>
<p>把上面的宏再全部展开：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ANetActor</span>:</span><span class="keyword">public</span> AActor</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// DECLARE_FUNCTION 在本节不展开讲，留到下一节，所以我保留了宏。</span></span><br><span class="line">	<span class="built_in">DECLARE_FUNCTION</span>(execSetHp)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">P_GET_PROPERTY</span>(UIntProperty,Z_Param_pNewHp);</span><br><span class="line">		P_FINISH;</span><br><span class="line">		P_NATIVE_BEGIN;</span><br><span class="line">		P_THIS-&gt;<span class="built_in">SetHp</span>(Z_Param_pNewHp);</span><br><span class="line">		P_NATIVE_END;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">DECLARE_FUNCTION</span>(execGetHp)</span><br><span class="line">	&#123;</span><br><span class="line">		P_FINISH;</span><br><span class="line">		P_NATIVE_BEGIN;</span><br><span class="line">		*(int32*)Z_Param__Result=P_THIS-&gt;<span class="built_in">GetHp</span>();</span><br><span class="line">		P_NATIVE_END;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"><span class="keyword">private</span>: </span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">StaticRegisterNativesANetActor</span><span class="params">()</span></span>; </span><br><span class="line">	<span class="keyword">friend</span> <span class="class"><span class="keyword">struct</span> <span class="title">Z_Construct_UClass_ANetActor_Statics</span>;</span> </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    ANetActor&amp; <span class="keyword">operator</span>=(ANetActor&amp;&amp;);  </span><br><span class="line">    ANetActor&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> ANetActor&amp;);  </span><br><span class="line">	<span class="function">NO_API <span class="keyword">static</span> UClass* <span class="title">GetPrivateStaticClass</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="comment">// DECLARE_CLASS(ANetActor, AActor, COMPILED_IN_FLAGS(0), CASTCLASS_None, TEXT(&quot;/Script/ReflectionExample&quot;), NO_API) </span></span><br><span class="line">	<span class="comment">/** Bitwise union of #EClassFlags pertaining to this class.*/</span></span><br><span class="line">	<span class="class"><span class="keyword">enum</span> &#123;</span>StaticClassFlags=<span class="built_in">COMPILED_IN_FLAGS</span>(<span class="number">0</span>)&#125;;</span><br><span class="line">	<span class="comment">/** Typedef for the base class (&#123;&#123; typedef-type &#125;&#125;) */</span></span><br><span class="line">	<span class="keyword">typedef</span> AActor Super</span><br><span class="line">	<span class="comment">/** Typedef for &#123;&#123; typedef-type &#125;&#125;. */</span></span><br><span class="line">	<span class="keyword">typedef</span> ANetActor ThisClass</span><br><span class="line">	<span class="comment">/** Returns a UClass object representing this class at runtime */</span></span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">static</span> UClass* <span class="title">StaticClass</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">GetPrivateStaticClass</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/** Returns the package this class belongs in */</span></span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">static</span> <span class="keyword">const</span> TCHAR* <span class="title">StaticPackage</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">TEXT</span>(<span class="string">&quot;/Script/ReflectionExample&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/** Returns the static cast flags for this class */</span></span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">static</span> EClassCastFlags <span class="title">StaticClassCastFlags</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> CASTCLASS_None;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/** For internal use only; use StaticConstructObject() to create new objects. */</span></span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="keyword">const</span> <span class="keyword">size_t</span> InSize, EInternal InInternalOnly, UObject* InOuter = (UObject*)GetTransientPackage(), FName InName = NAME_None, EObjectFlags InSetFlags = RF_NoFlags)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">StaticAllocateObject</span>(<span class="built_in">StaticClass</span>(), InOuter, InName, InSetFlags);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/** For internal use only; use StaticConstructObject() to create new objects. */</span></span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="keyword">const</span> <span class="keyword">size_t</span> InSize, EInternal* InMem )</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> (<span class="keyword">void</span>*)InMem;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DECLARE_SERIALIZER(ANetActor)</span></span><br><span class="line">	<span class="keyword">friend</span> FArchive &amp;<span class="keyword">operator</span>&lt;&lt;(FArchive&amp; Ar, ANetActor*&amp; Res)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> Ar &lt;&lt; (UObject*&amp;)Res;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">friend</span> <span class="keyword">void</span> <span class="keyword">operator</span>&lt;&lt;(FStructuredArchive::FSlot InSlot, ANetActor*&amp; Res)</span><br><span class="line">	&#123;</span><br><span class="line">		InSlot &lt;&lt; (UObject*&amp;)Res;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Standard constructor, called after all reflected properties have been initialized */</span> </span><br><span class="line">	<span class="function">NO_API <span class="title">ANetActor</span><span class="params">(<span class="keyword">const</span> FObjectInitializer&amp; ObjectInitializer = FObjectInitializer::Get())</span> : Super(ObjectInitializer) &#123;</span> &#125;; </span><br><span class="line"><span class="keyword">private</span>: </span><br><span class="line">	<span class="comment">/** Private move- and copy-constructors, should never be used */</span> </span><br><span class="line">	<span class="function">NO_API <span class="title">ANetActor</span><span class="params">(ANetActor&amp;&amp;)</span></span>; </span><br><span class="line">	</span><br><span class="line">	<span class="function">NO_API <span class="title">ANetActor</span><span class="params">(<span class="keyword">const</span> ANetActor&amp;)</span></span>; </span><br><span class="line"><span class="keyword">public</span>: </span><br><span class="line"><span class="comment">// DECLARE_VTABLE_PTR_HELPER_CTOR(NO_API, ANetActor); </span></span><br><span class="line">	<span class="keyword">static</span> UObject* __VTableCtorCaller(FVTableHelper&amp; Helper)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="comment">// DEFINE_VTABLE_PTR_HELPER_CTOR_CALLER(ANetActor); </span></span><br><span class="line">	<span class="comment">/** DO NOT USE. This constructor is for internal usage only for hot-reload purposes. */</span> \</span><br><span class="line">	<span class="function">API <span class="title">ANetActor</span><span class="params">(FVTableHelper&amp; Helper)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DEFINE_DEFAULT_OBJECT_INITIALIZER_CONSTRUCTOR_CALL(ANetActor)</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">void</span> __DefaultConstructor(<span class="keyword">const</span> FObjectInitializer&amp; X) &#123; <span class="keyword">new</span>((EInternal*)X.<span class="built_in">GetObj</span>())<span class="built_in">ANetActor</span>(X); &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">UFUNCTION</span>() <span class="comment">// 注意这里的都是空宏了</span></span><br><span class="line">		<span class="function">int32 <span class="title">GetHp</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line">	<span class="built_in">UFUNCTION</span>() <span class="comment">// 注意这里的都是空宏了</span></span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">SetHp</span><span class="params">(int32 pNewHp)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="built_in">UPROPERTY</span>() <span class="comment">// 注意这里的都是空宏了</span></span><br><span class="line">		int32 mHP;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这就是经过 UHT 之后的我们的 <code>ANetActtor</code> 类声明，其中定义了一系列的函数、<code>typedef</code>以及序列化、<code>new</code>等等。</p>
<p>还要类似于 C# 中的 <code>Super</code> 其实就是 UHT 给我们的类添加了一个 <code>typedef</code> 的形式，把 Super 定义成了基类，UE 通过这种形式给我们的类添加了通用的访问函数，用于支持 UE 的对象系统。</p>
<h3 id="GetPrivateStaticClass"><a href="#GetPrivateStaticClass" class="headerlink" title="GetPrivateStaticClass"></a>GetPrivateStaticClass</h3><p>在 <code>StaticClass</code> 中调用的 <code>GetPrivateStaticClass</code> 其实现是在 <code>NetActor.gen.cpp</code> 中的，通过 <code>IMPLEMENT_CLASS</code> 宏来定义 (这个<code>IMPLEMENT_</code> 系列宏也是被定义在 <a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/CoreUObject/Public/UObject/Class.h">Class.h</a> 中)：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">IMPLEMENT_CLASS</span>(ANetActor, <span class="number">2260007263</span>);</span><br></pre></td></tr></table></figure>

<p>展开之后为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMPLEMENT_CLASS(ANetActor, 2260007263)</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> ANetActorCompiledInDefer&lt;ANetActor&gt; <span class="title">AutoInitializeANetActor</span><span class="params">(TEXT(<span class="string">&quot;ANetActor&quot;</span>), <span class="keyword">sizeof</span>(ANetActor), <span class="number">2260007263</span>)</span></span>;</span><br><span class="line">  <span class="function">UClass* <span class="title">ANetActor::GetPrivateStaticClass</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> UClass* PrivateStaticClass = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (!PrivateStaticClass)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// GetPrivateStaticClassBody is a Template function, Helper template allocate and construct a UClass</span></span><br><span class="line">      <span class="comment">/* this could be handled with templates, but we want it external to avoid code bloat */</span></span><br><span class="line">      <span class="built_in">GetPrivateStaticClassBody</span>(</span><br><span class="line">        <span class="built_in">StaticPackage</span>(),</span><br><span class="line">        (TCHAR*)<span class="built_in">TEXT</span>(<span class="string">&quot;ANetActor&quot;</span>) + <span class="number">1</span> + ((StaticClassFlags &amp; CLASS_Deprecated) ? <span class="number">11</span> : <span class="number">0</span>),</span><br><span class="line">        PrivateStaticClass,</span><br><span class="line">        StaticRegisterNativesANetActor,</span><br><span class="line">        <span class="built_in"><span class="keyword">sizeof</span></span>(ANetActor),</span><br><span class="line">        <span class="built_in"><span class="keyword">alignof</span></span>(ANetActor),</span><br><span class="line">        (EClassFlags)ANetActor::StaticClassFlags,</span><br><span class="line">        ANetActor::<span class="built_in">StaticClassCastFlags</span>(),</span><br><span class="line">        ANetActor::<span class="built_in">StaticConfigName</span>(),</span><br><span class="line">        (UClass::ClassConstructorType)InternalConstructor&lt;ANetActor&gt;,</span><br><span class="line">        (UClass::ClassVTableHelperCtorCallerType)InternalVTableHelperCtorCaller&lt;ANetActor&gt;,</span><br><span class="line">        &amp;ANetActor::AddReferencedObjects,</span><br><span class="line">        &amp;ANetActor::Super::StaticClass,</span><br><span class="line">        &amp;ANetActor::WithinClass::StaticClass</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> PrivateStaticClass;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/CoreUObject/Public/UObject/Class.h#L2948">GetPrivateStaticClass</a>(定义在 <a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/CoreUObject/Private/UObject/Class.cpp#L4544">Class.cpp</a>) 其作用是从当前类的信息构造出一个 <code>UClass</code> 对象出来，其是一个单例对象，通过 <code>UXXX::StaticClass()</code> 获取到的就是这个对象。</p>
<blockquote>
<p>注意：在 <code>GetPrivateStaticClass</code> 中调用 <code>GetPrivateStaticClassBody</code> 所传递的参数，就是 UHT 根据我们类的声明产生的所有元数据的访问方法，<code>UClass</code>里存储的就是我们定义类的元数据，而且也并非是每一个我们定义的类都生成了一个一个 UClass 类，而是对每一个类产生一个不同的 UClass 对象实例。</p>
</blockquote>
<h2 id="UFUNCTION"><a href="#UFUNCTION" class="headerlink" title="UFUNCTION"></a>UFUNCTION</h2><p>在 UE 中写代码时，所有需要进行反射的函数必须添加 <code>UFUNTION()</code> 标记。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UCLASS</span>()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ANetActor</span>:</span><span class="keyword">public</span> Actor</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">SetHp</span><span class="params">(int32 pNewHp)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>UHT 通过扫描我们在代码中所有标记了 <code>UFUNCTION</code> 的函数，生成出来的名为 <code>execFUNC_NAME</code> 中间函数定义（被称作 <code>thunk</code> 函数）。它统一了所有的 <code>UFUNCTION</code> 函数调用规则(<code>this</code>/ 调用参数以及返回值)，并且包裹了真正要执行的函数。</p>
<p>之后就可以通过反射来调用该函数：</p>
<ol>
<li>通过 <code>UObject::FindFunction</code> 获得所指定函数的 <code>UFunction</code> 对象 (如果指定的函数没有添加<code>UFUNCTION</code> 标记，则返回<code>NULL</code>);</li>
<li>通过 <code>ProcessEvent</code> 来调用函数，第一个参数是调用函数<code>UFunction</code>, 第二个是参数列表<code>void*</code>;</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    UFunction* funcSetHp = pNetActor-&gt;<span class="built_in">FindFunctionChecked</span>(<span class="string">&quot;SetHp&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(funcSetHp)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// struct define in scope</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">funcSetHpParams</span>&#123;</span>int32 NewHp;&#125;InsParam;</span><br><span class="line">        InsParam.NewHp=<span class="number">123</span>;</span><br><span class="line">        <span class="comment">// call SetHp</span></span><br><span class="line">        <span class="built_in">ProcessEvent</span>(funcSetHp,(<span class="keyword">void</span>*)(&amp;InsParam));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注：<code>UFunction</code>对象中的 <code>ParamSize</code> 的大小是所有成员组成的结构大小，并且具有字节对齐，所以可以将所有参数封装为一个结构，再将其转换为<code>void*</code>。</p>
</blockquote>
<p>例，一个函数接收 <code>int32</code>/<code>bool</code>/<code>AActor*</code> 三个类型参数，其 <code>ParamSize</code> 的大小等同于：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// sizeof(Params) == 16</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Params</span>&#123;</span></span><br><span class="line">	int32 pIval;</span><br><span class="line">	<span class="keyword">bool</span> pBool;</span><br><span class="line">	AActor* pPointer;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9780/UFunction-member-ParamSize-is-aligned.webp"></p>
<p>内存对齐相关的内容可以看我之前的一篇文章：<a href="https://imzlp.com/posts/61962/">结构体成员内存对齐问题</a></p>
<h3 id="DECLARE-FUNCTION"><a href="#DECLARE-FUNCTION" class="headerlink" title="DECLARE_FUNCTION"></a>DECLARE_FUNCTION</h3><p><code>DECLARE_FUNCTION</code>的宏定义为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// This macro is used to declare a thunk function in autogenerated boilerplate code</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_FUNCTION(func) static void func(UObject* Context, FFrame&amp; Stack, RESULT_DECL)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// This macro is used to define a thunk function in autogenerated boilerplate code</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFINE_FUNCTION(func) void func(UObject* Context, FFrame&amp; Stack, RESULT_DECL)</span></span><br></pre></td></tr></table></figure>

<p>通过上面我们手动解析之后的代码可以看到，对于使用 <code>UFUNCTION</code> 标记的函数，UHT 解析时给我们生成了一个 <code>DECLARE_FUNCTION</code> 的宏，其宏定义为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// This macro is used to declare a thunk function in autogenerated boilerplate code</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_FUNCTION(func) static void func(UObject* Context, FFrame&amp; Stack, RESULT_DECL)</span></span><br><span class="line"><span class="comment">// This macro is used to define a thunk function in autogenerated boilerplate code</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFINE_FUNCTION(func) void func(UObject* Context, FFrame&amp; Stack, RESULT_DECL)</span></span><br></pre></td></tr></table></figure>

<p>在我之前的文章中有提到过，C++ 的成员函数和非成员函数本质没有区别，只不过 C++ 的成员函数有一个隐式的 <code>this</code> 指针参数，这个 <code>DECLARE_FUNCTION</code> 处理的思想也一样，可以把成员和非成员函数通过这种形式统一起来，至于 <code>Context</code> 自然就是传统 C++ 的那个 <strong> 隐式 this 指针 </strong> 了，代表着当前调用该成员函数的对象。</p>
<blockquote>
<p>注意：在老版本的引擎代码中(4.18.3 之前)，是没有这个 Context 参数的，从 4.19 之后才支持。</p>
</blockquote>
<p>Now，将上文 <code>NetActor.generated.h</code> 中的 <code>DECLARE_FUNCTION(execSetHp)</code> 展开为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// DECLARE_FUNCTION(execSetHp)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">execSetHp</span><span class="params">(UObject* Context, FFrame&amp; Stack, RESULT_DECL)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// P_GET_PROPERTY(UIntProperty,Z_Param_pNewHp);</span></span><br><span class="line">	UIntProperty::TCppType Z_Param_pNewHp = UIntProperty::<span class="built_in">GetDefaultPropertyValue</span>();</span><br><span class="line">	Stack.StepCompiledIn&lt;UIntProperty&gt;(&amp;Z_Param_pNewHp);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// P_FINISH;</span></span><br><span class="line">	Stack.Code += !!Stack.Code; <span class="comment">/* increment the code ptr unless it is null */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// P_NATIVE_BEGIN;</span></span><br><span class="line">	&#123; <span class="built_in">SCOPED_SCRIPT_NATIVE_TIMER</span>(ScopedNativeCallTimer);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// P_THIS-&gt;SetHp(Z_Param_pNewHp);</span></span><br><span class="line">	((ThisClass*)(Context))-&gt;<span class="built_in">SetHp</span>(Z_Param_pNewHp);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// P_NATIVE_END;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以及<code>DECLARE_FUNCTION(execGetHp)</code>：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// DECLARE_FUNCTION(execGetHp)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">execGetHp</span><span class="params">(UObject* Context, FFrame&amp; Stack, RESULT_DECL)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// P_FINISH;</span></span><br><span class="line">	Stack.Code += !!Stack.Code; <span class="comment">/* increment the code ptr unless it is null */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// P_NATIVE_BEGIN;</span></span><br><span class="line">	&#123; <span class="built_in">SCOPED_SCRIPT_NATIVE_TIMER</span>(ScopedNativeCallTimer);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// *(int32*)Z_Param__Result=P_THIS-&gt;GetHp();</span></span><br><span class="line">	*(int32*)Z_Param__Result=((ThisClass*)(Context))-&gt;<span class="built_in">GetHp</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// P_NATIVE_END;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这些 <code>P_</code> 开头的宏，是封装了从参数 <code>Context</code> 以及 <code>Stack</code> 中获取真正要执行的函数的参数，它们被定义在 <a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/CoreUObject/Public/UObject/ScriptMacros.h">Runtime/CoreUObject/Public/Object/ScriptMacros.h</a> 中。</p>
<p><code>RESULT_DECL</code>宏是被定义在 <a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/CoreUObject/Public/UObject/Script.h">Script.h</a> 中的：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime/CoreUObject/Public/Script.h</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Blueprint VM intrinsic return value declaration.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RESULT_PARAM Z_Param__Result</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RESULT_DECL void*const RESULT_PARAM</span></span><br></pre></td></tr></table></figure>

<p>被展开后是：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span>*<span class="keyword">const</span> Z_Param__Result</span><br></pre></td></tr></table></figure>

<p>它是一个顶层 const(<code>Top-level const</code>)，指针值不能修改，指针所指向的值可以修改，用于处理函数的返回值。</p>
<h3 id="Custom-Thunk-Function"><a href="#Custom-Thunk-Function" class="headerlink" title="Custom Thunk Function"></a>Custom Thunk Function</h3><p>上面写道，当我们对一个函数标记 <code>UFUNCTION</code> 的时候，UHT 就会自动给生成一个 <code>execFunc</code> 的函数，如果不想让 UHT 生成该函数的 <code>Thunk</code> 函数，可以使用 <code>CustomThunk</code> 来标记，不生成，自己提供。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UCLASS</span>(BlueprintType,Blueprintable)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ANetActor</span>:</span><span class="keyword">public</span> AActor</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">UFUNCTION</span>(CustomThunk)</span><br><span class="line">		<span class="function">int32 <span class="title">GetHp</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line">	<span class="built_in">DECLARE_FUNCTION</span>(execGetHp)</span><br><span class="line">	&#123;</span><br><span class="line">		P_FINISH;</span><br><span class="line">		P_NATIVE_BEGIN;</span><br><span class="line">		*(int32*)Z_Param__Result = P_THIS-&gt;<span class="built_in">GetHp</span>();</span><br><span class="line">		P_NATIVE_END;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其实就是需要把 <code>DECLARE_FUNCTION</code> 自己写一遍来处理 <code>ProcessEvent</code> 传递过来的逻辑。比如考虑一下实现这样的逻辑：写一个通用的函数，允许传入任何具有反射的的 struct（不管是蓝图的还是 C++ 的），然后将其序列化为 json。想要实现这样的功能就需要我们在 <code>Thunk</code> 函数中自己来写逻辑。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UFUNCTION</span>(BlueprintCallable,CustomThunk, meta = (CustomStructureParam = <span class="string">&quot;StructPack&quot;</span>))</span><br><span class="line"><span class="function">FString <span class="title">StructToJson</span><span class="params">(<span class="keyword">const</span> FNetActorStruct&amp; StructPack)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">DECLARE_FUNCTION</span>(execStructToJson)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>meta</code>中 <code>CustomStructureParam</code> 的含义是将参数作为通配符，可以传入任何类型的参数。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/9780/ue-bp-receive-any-type-struct.webp"></p>
<h2 id="UPROPERTY"><a href="#UPROPERTY" class="headerlink" title="UPROPERTY"></a>UPROPERTY</h2><p>在类内对属性加了 UPROPERTY 的标记，不会在 generated.h 中产生额外的代码，但是它会把它的反射信息代码生成到在 <code>gen.cpp</code> 中，关于生成在 <code>gen.cpp</code> 中的代码细节本篇文章暂时按下不表，留到下一篇文章中详细介绍。</p>
<h2 id="StaticClass-Struct-Enum"><a href="#StaticClass-Struct-Enum" class="headerlink" title="StaticClass/Struct/Enum"></a>StaticClass/Struct/Enum</h2><p>在 generated.h 中，UHT 会为当前文件中声明的反射类型（UObject class/struct/enum）生成对应的 <code>Static*&lt;&gt;</code> 模板特化：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;&gt; REFLECTIONEXAMPLE_API UClass* StaticClass&lt;<span class="class"><span class="keyword">class</span> <span class="title">ANetActor</span>&gt;</span>();</span><br><span class="line"><span class="keyword">template</span>&lt;&gt; REFLECTIONEXAMPLE_API UEnum* StaticEnum&lt;ENetEnum&gt;();</span><br><span class="line"><span class="keyword">template</span>&lt;&gt; REFLECTIONEXAMPLE_API UScriptStruct* StaticStruct&lt;<span class="class"><span class="keyword">struct</span> <span class="title">FNetStruct</span>&gt;</span>();</span><br></pre></td></tr></table></figure>

<p>这是我们在运行时通过 <code>StaticClass&lt;ANetActor&gt;</code> 这种形式获取 UClass/UStruct/UEnum 的方法。</p>
<p>这种形式在 UE4.21 之后才添加，在 4.21 之前要使用以下这种形式：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">UEnum* FoundEnum = FindObject&lt;UEnum&gt;(ANY_PACKAGE, *EnumTypeName, <span class="literal">true</span>); </span><br></pre></td></tr></table></figure>

<p><code>Static*&lt;&gt;()</code>的定义是在 <code>gen.cpp</code> 中。</p>
<h2 id="End"><a href="#End" class="headerlink" title="End"></a>End</h2><p>UE 反射的实现以一言蔽之：通过 UHT 生成反射的元数据，把这些元数据在运行时构造出来对应的 UClass/UStruct/UEnum，从而提供了反射的支持。本篇文章主要介绍了 UHT 生成的 generated.h 中的代码，其实核心是通过 UHT 给反射类的声明中添加了一堆通用的成员，依赖这些成员支持了 UE 的对象系统的管理。</p>
<p>下一篇文章会着重介绍 UHT 生成的 <code>gen.cpp</code> 中的代码，它们是真正记录了反射类的对象信息的，比如反射成员的名字、函数地址，传递参数、数据成员类内偏移等等，通过分析它们可以知道我们通过反射能够得到类的哪些信息。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>反射</category>
      </categories>
      <tags>
        <tag>反射</tag>
        <tag>UHT</tag>
      </tags>
  </entry>
  <entry>
    <title>WITH_EDITOR 包裹反射属性的问题</title>
    <url>/wiki/41080/</url>
    <content><![CDATA[<p>有时只想要一些属性在编辑器下存在，打包时不需要，按照常规的思路，需要对这些属性使用 <code>WITH_EDITOR</code> 包裹：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>()</span><br><span class="line">      int32 ival;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>这个代码在 Editor 的 Configuration 下没有问题，但是一旦编译非 Editor 就会产生如下错误：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ERROR: Build/Win64/FGame/Inc/FGame/NetActor.gen.cpp(97): error C2039: &#x27;ival&#x27;: is not a member of &#x27;ANetActor&#x27;</span><br></pre></td></tr></table></figure>
<p>那么，既然我们明明已经用 <code>WITH_EDITOR</code> 包裹了 <code>ival</code> 的属性，为什么在编译非 Editor 的时候 UHT 还会为这个属性生成反射代码呢？<br>这个问题涉及到了以下几个概念：</p>
<ol>
<li>gen.cpp 中是 UHT 为反射标记的类和属性生成的反射信息</li>
<li>UHT 的生成流程在调用编译器之前</li>
</ol>
<p>UE 构建系统的流程我之前做过分析：<a href="https://imzlp.com/posts/6362/">Build flow of the Unreal Engine4 project</a></p>
<p>因为 C++ 的宏是在调用编译器后预处理阶段做的事情，在执行 UHT 时，压根不会检测宏条件，所以上面的代码，UHT 依然会为 <code>ival</code> 生成反射信息到 <code>gen.cpp</code> 中，而 UHT 执行完毕之后进入编译阶段 <code>WITH_EDITOR</code> 会参与预处理，<code>ival</code>因此在类定义中不存在，但是 UHT 已经为它生成了反射代码，会通过获取成员函数指针的方式访问到它，进而产生了上述的编译错误。</p>
<p>所以这是 UE 反射代码生成先于预处理造成的问题，在写代码时是比较反直觉的。但是这个问题也并非不能解决，UE 提供了 <code>WITH_EDITORONLY_DATA</code> 宏来专门处理这个问题，一个宏解决不了，就引入一个新的。</p>
<p>但是为什么 <code>WITH_EDITOR</code> 不可以，而 <code>WITH_EDITORONLY_DATA</code> 就可以呢？因为 UHT 在生成反射代码时为 <code>WITH_EDITORONLY_DATA</code> 做了特殊检测：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FNativeClassHeaderGenerator::ExportProperties</span><span class="params">(FOutputDevice&amp; Out, UStruct* Struct, int32 TextIndent)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FProperty*	Previous			= <span class="literal">NULL</span>;</span><br><span class="line">	FProperty*	PreviousNonEditorOnly = <span class="literal">NULL</span>;</span><br><span class="line">	FProperty*	LastInSuper			= <span class="literal">NULL</span>;</span><br><span class="line">	UStruct*	InheritanceSuper	= Struct-&gt;<span class="built_in">GetInheritanceSuper</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Find last property in the lowest base class that has any properties</span></span><br><span class="line">	UStruct* CurrentSuper = InheritanceSuper;</span><br><span class="line">	<span class="keyword">while</span> (LastInSuper == <span class="literal">NULL</span> &amp;&amp; CurrentSuper)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span>(TFieldIterator&lt;FProperty&gt; <span class="built_in">It</span>(CurrentSuper,EFieldIteratorFlags::ExcludeSuper); It; ++It )</span><br><span class="line">		&#123;</span><br><span class="line">			FProperty* Current = *It;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Disregard properties with 0 size like functions.</span></span><br><span class="line">			<span class="keyword">if</span>(It.<span class="built_in">GetStruct</span>() == CurrentSuper &amp;&amp; Current-&gt;ElementSize)</span><br><span class="line">			&#123;</span><br><span class="line">				LastInSuper = Current;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// go up a layer in the hierarchy</span></span><br><span class="line">		CurrentSuper = CurrentSuper-&gt;<span class="built_in">GetSuperStruct</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">FMacroBlockEmitter <span class="title">WithEditorOnlyData</span><span class="params">(Out, TEXT(<span class="string">&quot;WITH_EDITORONLY_DATA&quot;</span>))</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Iterate over all properties in this struct.</span></span><br><span class="line">	<span class="keyword">for</span>(TFieldIterator&lt;FProperty&gt; <span class="built_in">It</span>(Struct, EFieldIteratorFlags::ExcludeSuper); It; ++It )</span><br><span class="line">	&#123;</span><br><span class="line">		FProperty* Current = *It;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Disregard properties with 0 size like functions.</span></span><br><span class="line">		<span class="keyword">if</span> (It.<span class="built_in">GetStruct</span>() == Struct)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">WithEditorOnlyData</span>(Current-&gt;<span class="built_in">IsEditorOnlyProperty</span>());</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Export property specifiers</span></span><br><span class="line">			<span class="comment">// Indent code and export CPP text.</span></span><br><span class="line">			&#123;</span><br><span class="line">				FUHTStringBuilder JustPropertyDecl;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">const</span> FString* Dim = GArrayDimensions.<span class="built_in">Find</span>(Current);</span><br><span class="line">				Current-&gt;<span class="built_in">ExportCppDeclaration</span>(JustPropertyDecl, EExportedDeclaration::Member, Dim ? **Dim : <span class="literal">NULL</span>);</span><br><span class="line">				<span class="built_in">ApplyAlternatePropertyExportText</span>(*It, JustPropertyDecl, EExportingState::TypeEraseDelegates);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Finish up line.</span></span><br><span class="line">				Out.<span class="built_in">Logf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%s%s;\r\n&quot;</span>), FCString::<span class="built_in">Tab</span>(TextIndent + <span class="number">1</span>), *JustPropertyDecl);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			LastInSuper	= <span class="literal">NULL</span>;</span><br><span class="line">			Previous = Current;</span><br><span class="line">			<span class="keyword">if</span> (!Current-&gt;<span class="built_in">IsEditorOnlyProperty</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				PreviousNonEditorOnly = Current;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看下 <code>FMacroBlockEmitter</code> 的定义：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FMacroBlockEmitter</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="function"><span class="keyword">explicit</span> <span class="title">FMacroBlockEmitter</span><span class="params">(FOutputDevice&amp; InOutput, <span class="keyword">const</span> TCHAR* InMacro)</span></span></span><br><span class="line"><span class="function">        : Output(InOutput)</span></span><br><span class="line"><span class="function">        , bEmittedIf(false)</span></span><br><span class="line"><span class="function">        , Macro(InMacro)</span></span><br><span class="line"><span class="function">	&#123;</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	~<span class="built_in">FMacroBlockEmitter</span>()</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (bEmittedIf)</span><br><span class="line">		&#123;</span><br><span class="line">			Output.<span class="built_in">Logf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;#endif // %s\r\n&quot;</span>), Macro);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="keyword">bool</span> bInBlock)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!bEmittedIf &amp;&amp; bInBlock)</span><br><span class="line">		&#123;</span><br><span class="line">			Output.<span class="built_in">Logf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;#if %s\r\n&quot;</span>), Macro);</span><br><span class="line">			bEmittedIf = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (bEmittedIf &amp;&amp; !bInBlock)</span><br><span class="line">		&#123;</span><br><span class="line">			Output.<span class="built_in">Logf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;#endif // %s\r\n&quot;</span>), Macro);</span><br><span class="line">			bEmittedIf = <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">FMacroBlockEmitter</span>(<span class="keyword">const</span> FMacroBlockEmitter&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">	FMacroBlockEmitter&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> FMacroBlockEmitter&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	FOutputDevice&amp; Output;</span><br><span class="line">	<span class="keyword">bool</span> bEmittedIf;</span><br><span class="line">	<span class="keyword">const</span> TCHAR* Macro;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>当生成代码时会为使用 <code>WITH_EDITORONLY_DATA</code> 包裹的属性在 <code>gen.cpp</code> 中添加 <code>WITH_EDITORONLY_DATA</code> 宏（有点套娃的感觉），使 <code>gen.cpp</code> 在非 EDITOR 下编译时也不会把这部分反射代码参与真正的编译，从而解决了上面的问题。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>反射</category>
      </categories>
      <tags>
        <tag>BuildSystem</tag>
        <tag>反射</tag>
      </tags>
  </entry>
  <entry>
    <title>函数反射实现分析</title>
    <url>/wiki/34184/</url>
    <content><![CDATA[<h3 id="UHT 生成的反射信息"><a href="#UHT 生成的反射信息" class="headerlink" title="UHT 生成的反射信息"></a>UHT 生成的反射信息 </h3><p> 在 UE 的代码中加了 <code>UFUNCTION()</code> 修饰后 UHT 就会为该函数生成反射代码。</p>
<p>每一个支持反射的函数 UHT 都会给它生成一个类和一个函数：<br>如在 <code>AMyActor</code> 这个类下有一个 <code>ReflexFunc</code> 的函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UFUNCTION</span>()</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ReflexFunc</span><span class="params">(int32 InIval, UObject* InObj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UHT 会生成这样命名规则的一个类和函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UHT 为 ReflexFunc 生成的反射代码</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Z_Construct_UFunction_AMyActor_ReflexFunc_Statics</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">MyActor_eventReflexFunc_Parms</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		int32 InIval;</span><br><span class="line">		UObject* InObj;</span><br><span class="line">		<span class="keyword">bool</span> ReturnValue;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">NewProp_ReturnValue_SetBit</span><span class="params">(<span class="keyword">void</span>* Obj)</span></span>;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FBoolPropertyParams NewProp_ReturnValue;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FObjectPropertyParams NewProp_InObj;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FIntPropertyParams NewProp_InIval;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase* <span class="keyword">const</span> PropPointers[];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Function_MetaDataParams[];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FFunctionParams FuncParams;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::NewProp_ReturnValue_SetBit</span><span class="params">(<span class="keyword">void</span>* Obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	((MyActor_eventReflexFunc_Parms*)Obj)-&gt;ReturnValue = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FBoolPropertyParams Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::NewProp_ReturnValue = &#123;</span><br><span class="line">	 <span class="string">&quot;ReturnValue&quot;</span>,</span><br><span class="line">	 <span class="literal">nullptr</span>,</span><br><span class="line">	 (EPropertyFlags)<span class="number">0x0010000000000580</span>,</span><br><span class="line">	 UE4CodeGen_Private::EPropertyGenFlags::Bool | UE4CodeGen_Private::EPropertyGenFlags::NativeBool,</span><br><span class="line">	 RF_Public|RF_Transient|RF_MarkAsNative,</span><br><span class="line">	 <span class="number">1</span>,</span><br><span class="line">	 <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">bool</span>),</span><br><span class="line">	 <span class="built_in"><span class="keyword">sizeof</span></span>(MyActor_eventReflexFunc_Parms),</span><br><span class="line">	 &amp;Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::NewProp_ReturnValue_SetBit,</span><br><span class="line">	 <span class="built_in">METADATA_PARAMS</span>(<span class="literal">nullptr</span>,</span><br><span class="line">	 <span class="number">0</span>)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FObjectPropertyParams Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::NewProp_InObj = &#123;</span><br><span class="line">	 <span class="string">&quot;InObj&quot;</span>,</span><br><span class="line">	 <span class="literal">nullptr</span>,</span><br><span class="line">	 (EPropertyFlags)<span class="number">0x0010000000000080</span>,</span><br><span class="line">	 UE4CodeGen_Private::EPropertyGenFlags::Object,</span><br><span class="line">	 RF_Public|RF_Transient|RF_MarkAsNative,</span><br><span class="line">	 <span class="number">1</span>,</span><br><span class="line">	 <span class="built_in">STRUCT_OFFSET</span>(MyActor_eventReflexFunc_Parms,</span><br><span class="line">	 InObj),</span><br><span class="line">	 Z_Construct_UClass_UObject_NoRegister,</span><br><span class="line">	 <span class="built_in">METADATA_PARAMS</span>(<span class="literal">nullptr</span>,</span><br><span class="line">	 <span class="number">0</span>)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FIntPropertyParams Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::NewProp_InIval = &#123;</span><br><span class="line">	 <span class="string">&quot;InIval&quot;</span>,</span><br><span class="line">	 <span class="literal">nullptr</span>,</span><br><span class="line">	 (EPropertyFlags)<span class="number">0x0010000000000080</span>,</span><br><span class="line">	 UE4CodeGen_Private::EPropertyGenFlags::Int,</span><br><span class="line">	 RF_Public|RF_Transient|RF_MarkAsNative,</span><br><span class="line">	 <span class="number">1</span>,</span><br><span class="line">	 <span class="built_in">STRUCT_OFFSET</span>(MyActor_eventReflexFunc_Parms,</span><br><span class="line">	 InIval),</span><br><span class="line">	 <span class="built_in">METADATA_PARAMS</span>(<span class="literal">nullptr</span>,</span><br><span class="line">	 <span class="number">0</span>)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase* <span class="keyword">const</span> Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::PropPointers[] = &#123;</span><br><span class="line">	(<span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase*)&amp;Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::NewProp_ReturnValue,</span><br><span class="line">	(<span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase*)&amp;Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::NewProp_InObj,</span><br><span class="line">	(<span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase*)&amp;Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::NewProp_InIval,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::Function_MetaDataParams[] = &#123;</span><br><span class="line">	&#123; <span class="string">&quot;ModuleRelativePath&quot;</span>,</span><br><span class="line">	 <span class="string">&quot;MyActor.h&quot;</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FFunctionParams Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::FuncParams = &#123; (UObject*(*)())Z_Construct_UClass_AMyActor,</span><br><span class="line">	<span class="literal">nullptr</span>,</span><br><span class="line">	<span class="string">&quot;ReflexFunc&quot;</span>,</span><br><span class="line">	<span class="literal">nullptr</span>,</span><br><span class="line">	<span class="literal">nullptr</span>,</span><br><span class="line">	<span class="built_in"><span class="keyword">sizeof</span></span>(MyActor_eventReflexFunc_Parms),</span><br><span class="line">	Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::PropPointers,</span><br><span class="line">	<span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::PropPointers),</span><br><span class="line">	RF_Public|RF_Transient|RF_MarkAsNative,</span><br><span class="line">	(EFunctionFlags)<span class="number">0x00020401</span>,</span><br><span class="line">	<span class="number">0</span>,</span><br><span class="line">	<span class="number">0</span>,</span><br><span class="line">	<span class="built_in">METADATA_PARAMS</span>(Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::Function_MetaDataParams,</span><br><span class="line">	<span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::Function_MetaDataParams))</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过 UHT 生成的反射信息来构造出 UFunction</span></span><br><span class="line"><span class="function">UFunction* <span class="title">Z_Construct_UFunction_AMyActor_ReflexFunc</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">static</span> UFunction* ReturnFunction = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">if</span> (!ReturnFunction)</span><br><span class="line">	&#123;</span><br><span class="line">		UE4CodeGen_Private::<span class="built_in">ConstructUFunction</span>(ReturnFunction, Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::FuncParams);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ReturnFunction;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定义的 <code>Z_Construct_UFunction_AMyActor_ReflexFunc_Statics</code> 类中包含了以下信息：</p>
<ol>
<li>存储函数的参数、返回值的结构体(POD)，注意该结构的声明顺序是按照函数参数的顺序 + 最后一个成员是函数返回值的方式排列。</li>
<li>函数参数、返回值的<code>F*PropertyParams</code>，用来给函数的每个参数以及返回值生成反射信息，用于构造出 UProperty，static 成员；</li>
<li>成员 <code>static const UE4CodeGen_Private::FPropertyParamsBase* const PropPointers[];</code>，数组，用于记录该函数的参数和返回值的类型为<code>FPropertyParamsBase</code> 的 static 数据成员的地址。</li>
<li>成员<code>static const UE4CodeGen_Private::FMetaDataPairParam Function_MetaDataParams[];</code>，用于记录函数的元数据。如所属文件、Category、注释等等。</li>
<li>成员 <code>static const UE4CodeGen_Private::FFunctionParams FuncParams;</code> 用于记录当前函数的名字、Flag、参数的<code>F*PropertyParams</code>、参数数量，参数的结构大小等等，用于通过它来创建出<code>UFunction*</code>。</li>
<li>至于生成的<code>SetBit</code>d 的函数的作用，在上面属性反射的部分已经讲到了。</li>
</ol>
<p><code>UE4CodeGen_Private::FFunctionParams</code>结构声明为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Source/Runtime/CoreUObject/Public/UObject/UObjectGlobals.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FFunctionParams</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	UObject*                          (*OuterFunc)();</span><br><span class="line">	UFunction*                        (*SuperFunc)();</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>*                         NameUTF8;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>*                         OwningClassName;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>*                         DelegateName;</span><br><span class="line">	SIZE_T                              StructureSize;</span><br><span class="line">	<span class="keyword">const</span> FPropertyParamsBase* <span class="keyword">const</span>*   PropertyArray;</span><br><span class="line">	int32                               NumProperties;</span><br><span class="line">	EObjectFlags                        ObjectFlags;</span><br><span class="line">	EFunctionFlags                      FunctionFlags;</span><br><span class="line">	uint16                              RPCId;</span><br><span class="line">	uint16                              RPCResponseId;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">const</span> FMetaDataPairParam*           MetaDataArray;</span><br><span class="line">	int32                               NumMetaData;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>UHT 生成的 <code>Z_Construct_UFunction_AMyActor_ReflexFunc</code> 函数做了以下事情：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">UFunction* <span class="title">Z_Construct_UFunction_AMyActor_ReflexFunc</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">static</span> UFunction* ReturnFunction = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">if</span> (!ReturnFunction)</span><br><span class="line">	&#123;</span><br><span class="line">		UE4CodeGen_Private::<span class="built_in">ConstructUFunction</span>(ReturnFunction, Z_Construct_UFunction_AMyActor_Add_Statics::FuncParams);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ReturnFunction;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据定义的 <code>Z_Construct_UFunction_AMyActor_ReflexFunc_Statics</code> 结构中的 <code>FuncParams</code> 成员来创建出真正的 <code>UFunction</code> 对象。</p>
<p>最后，<code>Z_Construct_UFunction_AMyActor_ReflexFunc</code>这个函数会被注册到当前类反射数据的 <code>FuncInfo</code> 中。</p>
<h3 id="Thunk 函数"><a href="#Thunk 函数" class="headerlink" title="Thunk 函数"></a>Thunk 函数 </h3><p>UE 会为标记为<code>UFUNCTION</code> 的 Native 函数生成对应的 Thunk 函数 (<code>BlueprintImplementableEvent</code> 的函数不会)。如下列函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UFUNCTION</span>()</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ReflexFunc</span><span class="params">(int32 InIval, UObject* InObj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成的 Thunk 函数形式如下：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// generated.h</span></span><br><span class="line"><span class="built_in">DECLARE_FUNCTION</span>(execReflexFunc);</span><br><span class="line"></span><br><span class="line"><span class="comment">// gen.cpp</span></span><br><span class="line"><span class="built_in">DEFINE_FUNCTION</span>(AMyActor::execReflexFunc)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">P_GET_PROPERTY</span>(FIntProperty,Z_Param_InIval);</span><br><span class="line">	<span class="built_in">P_GET_OBJECT</span>(UObject,Z_Param_InObj);</span><br><span class="line">	P_FINISH;</span><br><span class="line">	P_NATIVE_BEGIN;</span><br><span class="line">	*(<span class="keyword">bool</span>*)Z_Param__Result=P_THIS-&gt;<span class="built_in">ReflexFunc</span>(Z_Param_InIval,Z_Param_InObj);</span><br><span class="line">	P_NATIVE_END;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>DECLARE_FUNCTION</code>/<code>DEFINE_FUNCTION</code>这两个宏是定义在 <a href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L632">CoreUObject/Public/UObject/ObjectMacros.h</a> 中的：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// This macro is used to declare a thunk function in autogenerated boilerplate code</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_FUNCTION(func) static void func(UObject* Context, FFrame&amp; Stack, RESULT_DECL)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// This macro is used to define a thunk function in autogenerated boilerplate code</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFINE_FUNCTION(func) void func(UObject* Context, FFrame&amp; Stack, RESULT_DECL)</span></span><br></pre></td></tr></table></figure>

<p>展开这两个宏：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// generated.h</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AMyActor::execReflexFunc</span><span class="params">(UObject* Context, FFrame&amp; Stack, RESULT_DECL)</span></span>;</span><br><span class="line"><span class="comment">// gen.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AMyActor::execReflexFunc</span><span class="params">(UObject* Context, FFrame&amp; Stack, RESULT_DECL)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">P_GET_PROPERTY</span>(FIntProperty,Z_Param_InIval);</span><br><span class="line">	<span class="built_in">P_GET_OBJECT</span>(UObject,Z_Param_InObj);</span><br><span class="line">	P_FINISH;</span><br><span class="line">	P_NATIVE_BEGIN;</span><br><span class="line">	*(<span class="keyword">bool</span>*)Z_Param__Result=P_THIS-&gt;<span class="built_in">ReflexFunc</span>(Z_Param_InIval,Z_Param_InObj);</span><br><span class="line">	P_NATIVE_END;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，UHT 为每个反射函数生成的都是一个参数一致的 static 成员函数，接收通用的参数，就可以用来处理所有的函数调用。</p>
<p>Thunk 函数中用到的这些宏：</p>
<p>RESULT_DECL(<a href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Public/UObject/Script.h#L68">CoreUObject/Public/UObject/Script.h</a>)：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Blueprint VM intrinsic return value declaration.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RESULT_PARAM Z_Param__Result</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RESULT_DECL void*const RESULT_PARAM</span></span><br></pre></td></tr></table></figure>

<p>其他的形如 <code>P_GET_PROPERTY</code> 之类的宏，都是定义在 <a href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Public/UObject/ScriptMacros.h">CoreUObject/Public/UObject/ScriptMacros.h</a> 文件中的，作用就是从栈上操作参数（因为 Thunk 函数是通用的参数，所以要从通用的参数中获取到每个函数具体的参数，UE 提供这些宏来做这些事情）。</p>
<p>这些 Thunk 函数通过 UHT 生成的 <code>StaticRegisterNatives*</code> 函数注册到 UClass 中（在 <code>GetPrivateStaticClass</code> 把该函数指针传递了进去）：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AMyActor::StaticRegisterNativesAMyActor</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UClass* Class = AMyActor::<span class="built_in">StaticClass</span>();</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> FNameNativePtrPair Funcs[] = &#123;</span><br><span class="line">		&#123; <span class="string">&quot;BPNativeEvent&quot;</span>, &amp;AMyActor::execBPNativeEvent &#125;,</span><br><span class="line">		&#123; <span class="string">&quot;ReflexFunc&quot;</span>, &amp;AMyActor::execReflexFunc &#125;,</span><br><span class="line">	&#125;;</span><br><span class="line">	FNativeFunctionRegistrar::<span class="built_in">RegisterFunctions</span>(Class, Funcs, <span class="built_in">UE_ARRAY_COUNT</span>(Funcs));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UE 不会为 <code>BlueprintImplementableEvent</code> 生成 Thunk 函数，但是会为它生成函数的反射信息，所以也可以通过反射的信息来调用 <code>BlueprintImplementableEvent</code> 的函数。</p>
<p>因为 `BlueprintImplementatableEventd 的函数是 C++ 提供原型不提供实现，让蓝图来进行覆写的，所以它不使用 Thunk 的形式调用（应该执行字节码的方式，这个暂时还没看到，有时间再来分析）。</p>
<h3 id="Custom-Thunk"><a href="#Custom-Thunk" class="headerlink" title="Custom Thunk"></a>Custom Thunk</h3><p>前面讲到当给函数加了 <code>UFUNCTION</code> 标记时 UHT 会给我们生成对应的 Thunk 函数，但是有些情况下需要我们自己来写 Thunk 的函数，如 <a href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/Engine/Classes/Kismet/KismetArrayLibrary.h">UKismetArrayLibrary</a> 中的对 Array 进行操作的函数，或者 <a href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/Engine/Classes/Kismet/DataTableFunctionLibrary.h#L51">UDataTableFunctionLibrary</a> 中的 <code>GetDataTableRowFromName</code> 函数。</p>
<p>UE 提供了让我们自己实现 Thunk 函数的方法，在 <code>UFUNCTION</code> 中添加 <code>CustomThunk</code> 标记：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UFUNCTION</span>(CustomThunk)</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ReflexFunc</span><span class="params">(int32 InIval, UObject* InObj)</span></span></span><br></pre></td></tr></table></figure>

<p>这样 UHT 就不会为这个函数生成出它的 Thunk 函数，这种情况下就需要自己提供了。自己写的方式和 UHT 生成的代码一样，可以使用 <code>DECLARE_FUNCTION</code> 或者<code>DEFINE_FUNCTION</code>（手动写按照 Thunk 函数的签名规则也是没问题的）</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">DECLARE_FUNCTION</span>(execReflexFunc)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// do something...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="运行时访问反射函数"><a href="# 运行时访问反射函数" class="headerlink" title="运行时访问反射函数"></a>运行时访问反射函数</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (TFieldIterator&lt;UFunction&gt; <span class="built_in">It</span>(InActor-&gt;<span class="built_in">GetClass</span>()); It; ++It)</span><br><span class="line">&#123;</span><br><span class="line">	UFunction* FuncProperty = *It;</span><br><span class="line">	<span class="keyword">if</span> (FuncProperty-&gt;<span class="built_in">GetName</span>() == <span class="built_in">TEXT</span>(<span class="string">&quot;GetIval&quot;</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">CallParam</span></span></span><br><span class="line"><span class="class">		&#123;</span></span><br><span class="line">			int32 ival;</span><br><span class="line">		&#125;CallParamIns;</span><br><span class="line">		InActor-&gt;<span class="built_in">ProcessEvent</span>(FuncProperty, &amp;CallParamIns);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 ProcessEvent 来调用，第二个参数传递进去参数和返回值的结构。</p>
<p>每个被反射的函数 UHT 都会给它生成一个 <strong> 参数的结构体</strong>，其排列的顺序为：函数参数依次排列，最后一个成员为返回值。如：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function">int32 <span class="title">Add</span><span class="params">(int32 R, int32 L)</span></span>;</span><br></pre></td></tr></table></figure>
<p>UHT 为其生成的参数结构为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MyActor_eventAdd_Parms</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	int32 R;</span><br><span class="line">	int32 L;</span><br><span class="line">	int32 ReturnValue;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在通过 UFunction* 来调用函数时，需要把这个布局的结构传递作为传递给函数的参数以及接收返回值：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (TFieldIterator&lt;UFunction&gt; <span class="built_in">It</span>(InActor-&gt;<span class="built_in">GetClass</span>()); It; ++It)</span><br><span class="line">&#123;</span><br><span class="line">  UFunction* Property = *It;</span><br><span class="line">  <span class="keyword">if</span> (Property-&gt;<span class="built_in">GetName</span>() == <span class="built_in">TEXT</span>(<span class="string">&quot;Add&quot;</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">AddFuncCallParam</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">      int32 R;</span><br><span class="line">      int32 L;</span><br><span class="line">      int32 RetValue;</span><br><span class="line">    &#125;CallParamIns;</span><br><span class="line">    CallParamIns.R = <span class="number">123</span>;</span><br><span class="line">    CallParamIns.L = <span class="number">456</span>;</span><br><span class="line">    InActor-&gt;<span class="built_in">ProcessEvent</span>(Property, &amp;CallParamIns);</span><br><span class="line">    <span class="built_in">UE_LOG</span>(LogTemp, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;UFunction:%s value:%d&quot;</span>), *Property-&gt;<span class="built_in">GetName</span>(), CallParamIns.RetValue);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-reflex/ue4-call-ufunction-receive-ret-value.webp"></p>
<p>可以通过 <code>UFunction</code> 拿到当前函数的参数的结构的大小<code>UFunction::ParmsSize</code>，在运行时动态访问的话可以通过这个结构大小分配出一块内存，然后用 UProperty 对这块内存进行访问，因为通过 UProperty 访问成员其实本质上也是通过该成员在类内的偏移来做的（对数据成员获取成员指针得到的是一个相对于对象基址的偏移值）。</p>
<h3 id="坑点"><a href="# 坑点" class="headerlink" title="坑点"></a>坑点 </h3><p> 注意：通过 UE 的 UFunction 调用并不能正确地处理引用类型，如：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function">int32&amp; <span class="title">Add</span><span class="params">(int32 R, int32&amp; L)</span></span>;</span><br></pre></td></tr></table></figure>
<p>这个函数生成的反射代码和非引用的一摸一样（对 L 参数生成的 UProperty 的 Flag 会多一个 <code>CPF_OutParm</code>，返回值的 UProperty 还具有<code>CPF_ReturnParm</code>）。<br> 这会造成通过 <code>UFunction*</code> 调用传递的参数和想要获取的返回值都只是一份拷贝（因为本来调用时的参数传递到 ProcessEvent 之前都会被赋值到 UHT 创建出来的参数结构），不能再后续的流程中对得到的结果进行赋值。</p>
<p><strong>而且</strong>，通过遍历 UFunction 得到的参数和返回值<code>UProperty</code>，其中的 Offset 值是相对于 UHT 生成的参数结构。</p>
<p>在获取蓝图或者 C++ 中具有多个返回值 UFunction 的时候，因为 UE 的具有多个返回值的机制是通过传递进来引用实现的，所以不能够只是通过检测 UProperty 是否具有 <code>CPF_ReturnValue</code> 来检测，因为包含该 flag 的 UProperty 只有一个，还需要检测 <code>CPF_OutParam</code> 来判断是都是通过引用方式传递的“返回值”。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>反射</category>
      </categories>
      <tags>
        <tag>反射</tag>
        <tag>UFunction</tag>
      </tags>
  </entry>
  <entry>
    <title>属性反射实现分析</title>
    <url>/wiki/34497/</url>
    <content><![CDATA[<p>当在 UCLASS 类中给一个属性添加 <code>UPROPERTY</code> 标记时：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UCLASS</span>()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MICROEND_423_API</span> <span class="title">AMyActor</span> :</span> <span class="keyword">public</span> AActor</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="comment">// Called when the game starts or when spawned</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">BeginPlay</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:	</span><br><span class="line">	<span class="comment">// Called every frame</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Tick</span><span class="params">(<span class="keyword">float</span> DeltaTime)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditAnywhere)</span><br><span class="line">			int32 ival;</span><br><span class="line">&#125;；</span><br></pre></td></tr></table></figure>
<p>会生成反射代码，生成反射代码的代码是在 UHT 中的<a href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Programs/UnrealHeaderTool/Private/CodeGenerator.cpp#L1063">Programs/UnrealHeaderTool/Private/CodeGenerator.cpp</a>：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Z_Construct_UClass_AMyActor_Statics::NewProp_ival_MetaData[] = &#123;</span><br><span class="line">		&#123; <span class="string">&quot;Category&quot;</span>, <span class="string">&quot;MyActor&quot;</span> &#125;,</span><br><span class="line">		&#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;Public/MyActor.h&quot;</span> &#125;,</span><br><span class="line">	&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FIntPropertyParams Z_Construct_UClass_AMyActor_Statics::NewProp_ival = &#123;</span><br><span class="line">  <span class="string">&quot;ival&quot;</span>,</span><br><span class="line">  <span class="literal">nullptr</span>,</span><br><span class="line">  (EPropertyFlags) <span class="number">0x0010000000000001</span>,</span><br><span class="line">  UE4CodeGen_Private::EPropertyGenFlags::Int,</span><br><span class="line">  RF_Public | RF_Transient | RF_MarkAsNative,</span><br><span class="line">  <span class="number">1</span>,</span><br><span class="line">  <span class="built_in">STRUCT_OFFSET</span>(AMyActor, ival),</span><br><span class="line">  <span class="built_in">METADATA_PARAMS</span>(Z_Construct_UClass_AMyActor_Statics::NewProp_ival_MetaData, <span class="built_in">ARRAY_COUNT</span>(Z_Construct_UClass_AMyActor_Statics::NewProp_ival_MetaData))</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>首先 <code>const UE4CodeGen_Private::FIntPropertyParams Z_Construct_UClass_AMyActor_Statics::NewProp_ival</code> 是创建出一个结构，用于记录当前属性的信息，比如变量名、相对于对象起始地址的偏移。</p>
<blockquote>
<p>注意 <code>UE4CodeGen_Private::FIntPropertyParams</code> 这样的类型都是定义在 <a href="https://github.com/EpicGames/UnrealEngine/blob/4.24.3-release/Engine/Source/Runtime/CoreUObject/Public/UObject/UObjectGlobals.h">UObject/UObjectGlobals.h</a> 中的，对于基础类型的属性（如 int8/int32/float/array/map）等使用的都是<code>FGenericPropertyParams</code>。</p>
</blockquote>
<h4 id="F-PropertyParams"><a href="#F-PropertyParams" class="headerlink" title="F*PropertyParams"></a>F*PropertyParams</h4><p>在 <a href="https://github.com/EpicGames/UnrealEngine/blob/4.24.3-release/Engine/Source/Runtime/CoreUObject/Public/UObject/UObjectGlobals.h">UObject/UObjectGlobals.h</a> 文件中，引擎里定义了很多的<code>F*PropertyParams</code>，但是他们的数据结构基本相同（但是他们并没有继承关系），都是 POD 的类型，每个数据依次排列，而且不同类型的 Params 尽量都保持了一致的顺序。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UObject/UObjectGlobals.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FGenericPropertyParams</span> // :</span> FPropertyParamsBaseWithOffset</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>*       NameUTF8;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>*       RepNotifyFuncUTF8;</span><br><span class="line">	EPropertyFlags    PropertyFlags;</span><br><span class="line">	EPropertyGenFlags Flags;</span><br><span class="line">	EObjectFlags      ObjectFlags;</span><br><span class="line">	int32             ArrayDim;</span><br><span class="line">	int32             Offset;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">const</span> FMetaDataPairParam* Z_Construct_UClass_;</span><br><span class="line">	int32                     NumMetaData;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>一个一个来分析它的参数。</p>
<h5 id="NameUTF8"><a href="#NameUTF8" class="headerlink" title="NameUTF8"></a>NameUTF8</h5><p>NameUTF8 是属性的 UTF8 的名字，在运行时可以通过 <code>UProperty</code> 的<code>GetNameCPP</code>来获取。</p>
<h5 id="RepNotifyFuncUTF8"><a href="#RepNotifyFuncUTF8" class="headerlink" title="RepNotifyFuncUTF8"></a>RepNotifyFuncUTF8</h5><p>RepNotifyFuncUTF8 是在当前属性绑定的修改之后的函数名字。</p>
<p>如果属性是这样声明：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UPROPERTY</span>(EditAnywhere,ReplicatedUsing=OnRep_Replicatedival)</span><br><span class="line">	int32 ival;</span><br><span class="line"><span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnRep_Replicatedival</span><span class="params">()</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>这样生成的反射代码就为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FIntPropertyParams Z_Construct_UClass_AMyActor_Statics::NewProp_ival = &#123; </span><br><span class="line">	<span class="string">&quot;ival&quot;</span>, </span><br><span class="line">	<span class="string">&quot;OnRep_Replicatedival&quot;</span>, </span><br><span class="line">	(EPropertyFlags)<span class="number">0x0010000100000021</span>,</span><br><span class="line">    UE4CodeGen_Private::EPropertyGenFlags::Int,</span><br><span class="line">    RF_Public|RF_Transient|RF_MarkAsNative, </span><br><span class="line">    <span class="number">1</span>,</span><br><span class="line">    <span class="built_in">STRUCT_OFFSET</span>(AMyActor, ival),</span><br><span class="line">  <span class="built_in">METADATA_PARAMS</span>(Z_Construct_UClass_AMyActor_Statics::NewProp_ival_MetaData,<span class="built_in">ARRAY_COUNT</span>(Z_Construct_UClass_AMyActor_Statics::NewProp_ival_MetaData))</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>因为 <code>OnRep_Replicatedival</code> 也是 UFUNCTION 的函数，所以可以通过反射来访问。</p>
<h5 id="PropertyFlags"><a href="#PropertyFlags" class="headerlink" title="PropertyFlags"></a>PropertyFlags</h5><p><code>PropertyFlags</code>是一个类型为 <a href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L361">EPropertyFlags</a> 的枚举，枚举值按照位排列，根据在 UPROPERTY 中的标记来按照位或来记录当前属性包含的标记信息。<br>在 <a href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Programs/UnrealHeaderTool/Private/CodeGenerator.cpp#L1063">UnrealHeaderTool/Private/CodeGenerator.cpp</a> 中生成代码时会根据当前属性的 flag 和 <a href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L442">CPF_ComputedFlags</a> 做位运算：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">// All the properties that should never be loaded or saved</span></span><br><span class="line"><span class="comment">#define CPF_ComputedFlags			(CPF_IsPlainOldData | CPF_NoDestructor | CPF_ZeroConstructor | CPF_HasGetValueTypeHash)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">0x0000000040000000 CPF_IsPlainOldData </span></span><br><span class="line"><span class="comment">0x0000001000000000 CPF_NoDestructor </span></span><br><span class="line"><span class="comment">0x0000000000000200 CPF_ZeroConstructor </span></span><br><span class="line"><span class="comment">0x0008000000000000 CPF_HasGetValueTypeHash</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">EPropertyFlags PropFlags = Prop-&gt;PropertyFlags &amp; ~CPF_ComputedFlags;</span><br></pre></td></tr></table></figure>
<p>在运行时可以通过 <code>UProperty</code> 的<code>HasAnyPropertyFlags</code>函数来检测是否具有特定的 flag。</p>
<p>一般情况下，可以通过 <code>UProperty</code> 来获取到该参数的标记属性，比如当通过 <code>UFunction</code> 获取函数的参数时，可以区分哪个 UProperty 是输入参数、哪个是返回值。</p>
<h5 id="Flags"><a href="#Flags" class="headerlink" title="Flags"></a>Flags</h5><p>第四个参数 <code>Flags</code> 是类型为 <code>UE4CodeGen_Private::EPropertyGenFlags</code> 是一个枚举，定义在 <a href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Public/UObject/UObjectGlobals.h#L2231">UObject/UObjectGlobals.h</a> 中，标记了当前 Property 的类型。</p>
<h5 id="ObjectFlags"><a href="#ObjectFlags" class="headerlink" title="ObjectFlags"></a>ObjectFlags</h5><p>ObjectFlags 是 <code>EObjectFlags</code> 类型的枚举，其枚举值也是按照位来划分的。定义在<a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L474">CoreUObject/Public/UObject/ObjectMacros.h</a></p>
<p>UHT 生成这部分代码在 <a href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Programs/UnrealHeaderTool/Private/CodeGenerator.cpp#L1063">Programs/UnrealHeaderTool/Private/CodeGenerator.cpp</a> 中：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> TCHAR*   FPropertyObjectFlags = FClass::<span class="built_in">IsOwnedByDynamicType</span>(Prop) ? <span class="built_in">TEXT</span>(<span class="string">&quot;RF_Public|RF_Transient&quot;</span>) : <span class="built_in">TEXT</span>(<span class="string">&quot;RF_Public|RF_Transient|RF_MarkAsNative&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>通过 <code>FClass::IsOwnedByDynamicType</code> 函数来检测是否为 PROPERTY 添加 <code>RF_MarkAsNative</code> 的 flag。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealHeaderTool/Public/ParserClass.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** Helper function that checks if the field is a dynamic type (can be constructed post-startup) */</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsDynamic</span><span class="params">(<span class="keyword">const</span> T* Field)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> Field-&gt;<span class="built_in">HasMetaData</span>(NAME_ReplaceConverted);</span><br><span class="line">&#125;</span><br><span class="line">	</span><br><span class="line"><span class="comment">// Programs/UnrealHeaderTool/Private/ParserClass.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FClass::IsOwnedByDynamicType</span><span class="params">(<span class="keyword">const</span> UField* Field)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">const</span> UField* OuterField = Cast&lt;<span class="keyword">const</span> UField&gt;(Field-&gt;<span class="built_in">GetOuter</span>()); OuterField; OuterField = Cast&lt;<span class="keyword">const</span> UField&gt;(OuterField-&gt;<span class="built_in">GetOuter</span>()))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">IsDynamic</span>(OuterField))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FClass::IsOwnedByDynamicType</span><span class="params">(<span class="keyword">const</span> FField* Field)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (FFieldVariant Owner = Field-&gt;<span class="built_in">GetOwnerVariant</span>(); Owner.<span class="built_in">IsValid</span>(); Owner = Owner.<span class="built_in">GetOwnerVariant</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (Owner.<span class="built_in">IsUObject</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">IsOwnedByDynamicType</span>(Cast&lt;<span class="keyword">const</span> UField&gt;(Owner.<span class="built_in">ToUObject</span>()));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">IsDynamic</span>(Owner.<span class="built_in">ToField</span>()))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过调用 <code>UField</code> 的<code>HasMetaData</code>检测是否具有 <code>TEXT(&quot;ReplaceConverted&quot;)</code> 的元数据（该元数据就是后面要讲到的 Metadata）。</p>
<h5 id="ArrayDim"><a href="#ArrayDim" class="headerlink" title="ArrayDim"></a>ArrayDim</h5><p>ArrayDim 用于记录当前属性的元素数量，当只是声明一个单个对象时，如：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line">	<span class="keyword">float</span> fval;</span><br><span class="line"><span class="built_in">UPROPERTY</span>(EditAnywhere)</span><br><span class="line">	FString StrVal = <span class="built_in">TEXT</span>(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line"><span class="built_in">UPROPERTY</span>(EditAnywhere)</span><br><span class="line">	TSubclassOf&lt;UObject&gt; ClassVal;</span><br><span class="line"><span class="built_in">UPROPERTY</span>(EditAnywhere)</span><br><span class="line">	UTexture2D* Texture2D;</span><br><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line">	FResultDyDlg ResultDlg;</span><br><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line">	UMySceneComponent* SceneComp;</span><br></pre></td></tr></table></figure>
<p>这些属性所有的 <code>ArrayDim</code> 均为 1.</p>
<p>但是当使用 C++ 原生数组时：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line">	int32 iArray[<span class="number">12</span>];</span><br></pre></td></tr></table></figure>
<p>它的 ArrayDim 就为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">CPP_ARRAY_DIM</span>(iArray, AMyActor)</span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Public/UObject/UnrealType.h#L5967">CPP_ARRAY_DIM</a>这个宏定义在<a href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Public/UObject/UnrealType.h#L5967">CoreUObject/Public/UObject/UnrealType.h</a>：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** helper to calculate an array&#x27;s dimensions **/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPP_ARRAY_DIM(ArrayName, ClassName) \</span></span><br><span class="line"><span class="meta">	(sizeof(((ClassName*)0)-&gt;ArrayName) / sizeof(((ClassName*)0)-&gt;ArrayName[0]))</span></span><br></pre></td></tr></table></figure>
<p>就是用来计算数组内的元素数量的，普通的非数组属性其值为 1，可以当作是元素数量为 1 的数组。</p>
<h5 id="Offset"><a href="#Offset" class="headerlink" title="Offset"></a>Offset</h5><p><code>STRUCT_OFFSET</code>宏的作用为得到数据成员相对于类起始地址的偏移，通过获取 <strong> 数据成员指针 </strong> 得到，类型为<code>size_t</code>。</p>
<p>然后当前类中的反射属性都会被添加到 <code>PropPointers</code> 中，也是 UHT 生成的代码：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase* <span class="keyword">const</span> Z_Construct_UClass_AMyActor_Statics::PropPointers[] = &#123;</span><br><span class="line">		(<span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase*)&amp;Z_Construct_UClass_AMyActor_Statics::NewProp_ival,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在运行时可以通过 <code>UProperty</code> 得到指定的对象值：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (TFieldIterator&lt;UProperty&gt; <span class="built_in">It</span>(InActor-&gt;<span class="built_in">GetClass</span>()); It; ++It)</span><br><span class="line">	&#123;</span><br><span class="line">		UProperty* Property = *It;</span><br><span class="line">		<span class="keyword">if</span> (Property-&gt;<span class="built_in">GetNameCPP</span>() == <span class="built_in">FString</span>(<span class="string">&quot;ival&quot;</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			int32* i32 = Property-&gt;ContainerPtrToValuePtr&lt;int32&gt;(InActor);</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogTemp, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;Property:%s value:%d&quot;</span>), *Property-&gt;<span class="built_in">GetNameCPP</span>(),i32);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>其中 <code>UProperty</code> 中的 <code>ContainerPtrToValuePtr</code> 系列函数都会转发到<code>ContainerVoidPtrToValuePtrInternal</code>：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">FORCEINLINE <span class="keyword">void</span>* <span class="title">ContainerVoidPtrToValuePtrInternal</span><span class="params">(<span class="keyword">void</span>* ContainerPtr, int32 ArrayIndex)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">check</span>(ArrayIndex &lt; ArrayDim);</span><br><span class="line">	<span class="built_in">check</span>(ContainerPtr);</span><br><span class="line">	<span class="keyword">if</span> (<span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// in the future, these checks will be tested if the property is NOT relative to a UClass</span></span><br><span class="line">		<span class="built_in">check</span>(!Cast&lt;UClass&gt;(<span class="built_in">GetOuter</span>())); <span class="comment">// Check we are _not_ calling this on a direct child property of a UClass, you should pass in a UObject* in that case</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> (uint8*)ContainerPtr + Offset_Internal + ElementSize * ArrayIndex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实就是拿到 UObject 的指针，然后偏移到指定位置（第二个参数用在对象是数组的情况，用来访问指定下标的元素，默认情况下访问下标为 0）。</p>
<h5 id="Z-Construct-UClass- 和 NumMetaData"><a href="#Z-Construct-UClass- 和 NumMetaData" class="headerlink" title="Z_Construct_UClass_和 NumMetaData"></a>Z_Construct_UClass_和 NumMetaData</h5><p>它们的类型分别为 <a href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Public/UObject/UObjectGlobals.h#L2285">FMetaDataPairParam</a> 和<code>int32</code>，用来记录当前反射属性的元数据：比如属性的 <code>Category</code>、注释、所属的文件、<code>ToolTip</code> 信息等等，比如在 C++ 函数上添加的注释能够在编辑器蓝图中看到注释的信息，都是靠解析这些元数据来实现的。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// CoreUObject/Public/UObject/UObjectGlobals.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">FMetaDataPairParam</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">char</span>* NameUTF8;</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">char</span>* ValueUTF8;</span><br><span class="line">	&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>这两个参数通过 <code>METADATA_PARAMS</code> 包裹，用于处理 <code>WITH_MATEDATA</code> 的不同情况：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// METADATA_PARAMS(x, y) expands to x, y, if WITH_METADATA is set, otherwise expands to nothing</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> METADATA_PARAMS(x, y) x, y,</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> METADATA_PARAMS(x, y)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>把 UHT 生成的代码宏展开为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Z_Construct_UClass_AMyActor_Statics::NewProp_ival_MetaData[] = &#123;</span><br><span class="line">		&#123; <span class="string">&quot;Category&quot;</span>, <span class="string">&quot;MyActor&quot;</span> &#125;,</span><br><span class="line">		&#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;Public/MyActor.h&quot;</span> &#125;</span><br><span class="line">	&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">METADATA_PARAMS</span>(Z_Construct_UClass_AMyActor_Statics::NewProp_ival_MetaData, <span class="built_in">ARRAY_COUNT</span>(Z_Construct_UClass_AMyActor_Statics::NewProp_ival_MetaData))</span><br></pre></td></tr></table></figure>
<p>就是把 <code>UE4CodeGen_Private::FMetaDataPairParam</code> 这个类型的数组和数组元素个数传递给 <code>F*PropertyParams</code>，实现在<code>WITH_METADATA</code> 的情况下处理是否具有 Metadata 的情况。</p>
<h4 id="运行时的 Property"><a href="# 运行时的 Property" class="headerlink" title="运行时的 Property"></a>运行时的 Property</h4><p>引擎中通过 <code>UE4CodeGen_Private::ConstructFProperty</code> 来创建出真正 Runtime 使用的<code>UProperty</code>(4.25 之后是<code>FProperty</code>)，定义在<a href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectGlobals.cpp#L3900">UObject/UObjectGlobals.cpp</a>。</p>
<h4 id="FBoolPropertyParams 特例"><a href="#FBoolPropertyParams 特例" class="headerlink" title="FBoolPropertyParams 特例"></a>FBoolPropertyParams 特例 </h4><p> 当一个反射的数据是 bool 类型时，引擎产生的反射信息中有一个比较有意思的特例，<code>FBoolPropertyParams</code>，可以看一下它的结构：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FBoolPropertyParams</span> // :</span> FPropertyParamsBase</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>*      NameUTF8;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>*         RepNotifyFuncUTF8;</span><br><span class="line">	EPropertyFlags      PropertyFlags;</span><br><span class="line">	EPropertyGenFlags   Flags;</span><br><span class="line">	EObjectFlags     ObjectFlags;</span><br><span class="line">	int32            ArrayDim;</span><br><span class="line">	uint32           ElementSize;</span><br><span class="line">	SIZE_T           SizeOfOuter;</span><br><span class="line">	<span class="built_in"><span class="keyword">void</span></span>           (*SetBitFunc)(<span class="keyword">void</span>* Obj);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">const</span> FMetaDataPairParam*           MetaDataArray;</span><br><span class="line">	int32                               NumMetaData;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>它具有一个 <code>SetBitFunc</code> 的函数指针。看一下生成的反射代码：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// source code </span></span><br><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line">	<span class="keyword">bool</span> bEnabled;</span><br><span class="line"></span><br><span class="line"><span class="comment">// gen.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Z_Construct_UClass_AMyActor_Statics::NewProp_bEnabled_SetBit</span><span class="params">(<span class="keyword">void</span>* Obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	((AMyActor*)Obj)-&gt;bEnabled = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FBoolPropertyParams Z_Construct_UClass_AMyActor_Statics::NewProp_bEnabled = &#123; <span class="string">&quot;bEnabled&quot;</span>, <span class="literal">nullptr</span>, (EPropertyFlags)<span class="number">0x0010000000000000</span>, UE4CodeGen_Private::EPropertyGenFlags::Bool | UE4CodeGen_Private::EPropertyGenFlags::NativeBool, RF_Public|RF_Transient|RF_MarkAsNative, <span class="number">1</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">bool</span>), <span class="built_in"><span class="keyword">sizeof</span></span>(AMyActor), &amp;Z_Construct_UClass_AMyActor_Statics::NewProp_bEnabled_SetBit, <span class="built_in">METADATA_PARAMS</span>(Z_Construct_UClass_AMyActor_Statics::NewProp_bEnabled_MetaData, <span class="built_in">ARRAY_COUNT</span>(Z_Construct_UClass_AMyActor_Statics::NewProp_bEnabled_MetaData)) &#125;;</span><br></pre></td></tr></table></figure>

<p><strong>注意 </strong>：其中的关键是，UHT 给该属性生成了一个<code>SetBit</code> 的函数，why？其他类型的属性都可以通过 <code>STRUCT_OFFSET</code> 来获取该成员的类内偏移，为什么 bool 就不行了呢？</p>
<p>这是因为 C++ 有位域 (<code>bit-field</code>) 这个概念，一个 bool 可能只占 1bit，而不是 1byte，但这不是真正的原因。</p>
<p>真正的原因是，C++ 标准规定了不能对位域进行取地址操作！前面已经提到了 <code>STRUCT_OFFSET</code> 实际上是获取到数据成员的指针，得到的是类内偏移，但是因为 C++ 的不能对位域取地址的规定，<code>STRUCT_OFFSET</code>无法用在位域的成员上的。</p>
<blockquote>
<p>[IOS/IEC 14882:2014 §9.6]The address-of operator &amp; shall not be applied to a bit-ﬁeld, so there are no pointers to bit-ﬁelds.</p>
</blockquote>
<p>那么这又是因为什么呢？因为系统编址的最小单位是字节而不是位，所以没办法取到 1 字节零几位的地址。也就决定了不能对位域的数据成员取地址。</p>
<p>UE 内其实大量用到了 bool 使用位域的方式来声明（如果不使用位域，bool 类型的空间浪费率达到 87.5% :)），所以 UE 就生成了一个函数来为以位域方式声明的成员设置值。</p>
<p><strong>但是！</strong>UE 不支持直接对加了 UPROPERTY 的 bool 使用位域：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line">	<span class="keyword">bool</span> bEnabled:<span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>编译时会有下列错误：</p>
<blockquote>
<p>LogCompile: Error: bool bitfields are not supported.</p>
</blockquote>
<p>要写成下列方式：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line">	uint8 bEnabled:<span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>使用这种方式和使用 <code>bool bEnabled;</code> 方式生成的反射代码一模一样，所以，UE 之所以会生成一个函数来设置 bool 的值，是因为既要支持原生 bool，也要支持位域。</p>
<h4 id="通过 UProperty 获取值"><a href="# 通过 UProperty 获取值" class="headerlink" title="通过 UProperty 获取值"></a>通过 UProperty 获取值 </h4><p> 如果我知道某个类的对象内有一个属性名字，那么怎么能够得到它的值呢？这个可以基于 UE 的属性反射来实现：</p>
<p>首先通过 <code>TFieldIterator</code> 可以遍历该对象的 UProperty：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (TFieldIterator&lt;UProperty&gt; <span class="built_in">It</span>(InActor-&gt;<span class="built_in">GetClass</span>()); It; ++It)</span><br><span class="line">&#123;</span><br><span class="line">	UProperty* Property = *It;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后可以根据得到的 Property 来判读名字：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (Property-&gt;<span class="built_in">GetNameCPP</span>() == <span class="built_in">FString</span>(<span class="string">&quot;ival&quot;</span>))</span><br></pre></td></tr></table></figure>
<p>检测是指定名字的 Property 后可以通过 <code>UProperty</code> 上的 <code>ContainerPtrToValuePtr</code> 函数来获取对象内该属性的指针：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">int32* i32 = Property-&gt;ContainerPtrToValuePtr&lt;int32&gt;(InActor)</span><br></pre></td></tr></table></figure>
<p>前面讲到过，UPropery 里存储 Offdet 值就是当前属性相对于对象起始地址的偏移。而 ContainerPtrToValuePtr 函数所做的就是得到当前对象偏移 Offset 的地址然后做了类型转换。</p>
<h4 id="Property 的 Flag"><a href="#Property 的 Flag" class="headerlink" title="Property 的 Flag"></a>Property 的 Flag</h4><p>通过上面的分析，可以看到 <code>UPROPERTY</code> 添加的标记，如 <code>EditAnywhere</code> 等，会给指定的 Property 生成 FLAG 存储在 <code>F*PropertyParams</code> 结构的第三个参数中，是位描述的。</p>
<p>可选值为 <code>EPropertyFlags</code> 枚举值：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/CoreUObject/Public/UObject/ObjectMacros.h</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Flags associated with each property in a class, overriding the</span></span><br><span class="line"><span class="comment"> * property&#x27;s default behavior.</span></span><br><span class="line"><span class="comment"> * @warning When adding one here, please update ParsePropertyFlags()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">EPropertyFlags</span> :</span> uint64</span><br><span class="line">&#123;</span><br><span class="line">	CPF_None = <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">	CPF_Edit							= <span class="number">0x0000000000000001</span>,	<span class="comment">///&lt; Property is user-settable in the editor.</span></span><br><span class="line">	CPF_ConstParm						= <span class="number">0x0000000000000002</span>,	<span class="comment">///&lt; This is a constant function parameter</span></span><br><span class="line">	CPF_BlueprintVisible				= <span class="number">0x0000000000000004</span>,	<span class="comment">///&lt; This property can be read by blueprint code</span></span><br><span class="line">	CPF_ExportObject					= <span class="number">0x0000000000000008</span>,	<span class="comment">///&lt; Object can be exported with actor.</span></span><br><span class="line">	CPF_BlueprintReadOnly				= <span class="number">0x0000000000000010</span>,	<span class="comment">///&lt; This property cannot be modified by blueprint code</span></span><br><span class="line">	CPF_Net								= <span class="number">0x0000000000000020</span>,	<span class="comment">///&lt; Property is relevant to network replication.</span></span><br><span class="line">	CPF_EditFixedSize					= <span class="number">0x0000000000000040</span>,	<span class="comment">///&lt; Indicates that elements of an array can be modified, but its size cannot be changed.</span></span><br><span class="line">	CPF_Parm							= <span class="number">0x0000000000000080</span>,	<span class="comment">///&lt; Function/When call parameter.</span></span><br><span class="line">	CPF_OutParm							= <span class="number">0x0000000000000100</span>,	<span class="comment">///&lt; Value is copied out after function call.</span></span><br><span class="line">	CPF_ZeroConstructor					= <span class="number">0x0000000000000200</span>,	<span class="comment">///&lt; memset is fine for construction</span></span><br><span class="line">	CPF_ReturnParm						= <span class="number">0x0000000000000400</span>,	<span class="comment">///&lt; Return value.</span></span><br><span class="line">	CPF_DisableEditOnTemplate			= <span class="number">0x0000000000000800</span>,	<span class="comment">///&lt; Disable editing of this property on an archetype/sub-blueprint</span></span><br><span class="line">	<span class="comment">//CPF_      						= 0x0000000000001000,	///&lt; </span></span><br><span class="line">	CPF_Transient   					= <span class="number">0x0000000000002000</span>,	<span class="comment">///&lt; Property is transient: shouldn&#x27;t be saved or loaded, except for Blueprint CDOs.</span></span><br><span class="line">	CPF_Config      					= <span class="number">0x0000000000004000</span>,	<span class="comment">///&lt; Property should be loaded/saved as permanent profile.</span></span><br><span class="line">	<span class="comment">//CPF_								= 0x0000000000008000,	///&lt; </span></span><br><span class="line">	CPF_DisableEditOnInstance			= <span class="number">0x0000000000010000</span>,	<span class="comment">///&lt; Disable editing on an instance of this class</span></span><br><span class="line">	CPF_EditConst   					= <span class="number">0x0000000000020000</span>,	<span class="comment">///&lt; Property is uneditable in the editor.</span></span><br><span class="line">	CPF_GlobalConfig					= <span class="number">0x0000000000040000</span>,	<span class="comment">///&lt; Load config from base class, not subclass.</span></span><br><span class="line">	CPF_InstancedReference				= <span class="number">0x0000000000080000</span>,	<span class="comment">///&lt; Property is a component references.</span></span><br><span class="line">	<span class="comment">//CPF_								= 0x0000000000100000,	///&lt;</span></span><br><span class="line">	CPF_DuplicateTransient				= <span class="number">0x0000000000200000</span>,	<span class="comment">///&lt; Property should always be reset to the default value during any type of duplication (copy/paste, binary duplication, etc.)</span></span><br><span class="line">	CPF_SubobjectReference				= <span class="number">0x0000000000400000</span>,	<span class="comment">///&lt; Property contains subobject references (TSubobjectPtr)</span></span><br><span class="line">	<span class="comment">//CPF_    							= 0x0000000000800000,	///&lt; </span></span><br><span class="line">	CPF_SaveGame						= <span class="number">0x0000000001000000</span>,	<span class="comment">///&lt; Property should be serialized for save games, this is only checked for game-specific archives with ArIsSaveGame</span></span><br><span class="line">	CPF_NoClear							= <span class="number">0x0000000002000000</span>,	<span class="comment">///&lt; Hide clear (and browse) button.</span></span><br><span class="line">	<span class="comment">//CPF_  							= 0x0000000004000000,	///&lt;</span></span><br><span class="line">	CPF_ReferenceParm					= <span class="number">0x0000000008000000</span>,	<span class="comment">///&lt; Value is passed by reference; CPF_OutParam and CPF_Param should also be set.</span></span><br><span class="line">	CPF_BlueprintAssignable				= <span class="number">0x0000000010000000</span>,	<span class="comment">///&lt; MC Delegates only.  Property should be exposed for assigning in blueprint code</span></span><br><span class="line">	CPF_Deprecated  					= <span class="number">0x0000000020000000</span>,	<span class="comment">///&lt; Property is deprecated.  Read it from an archive, but don&#x27;t save it.</span></span><br><span class="line">	CPF_IsPlainOldData					= <span class="number">0x0000000040000000</span>,	<span class="comment">///&lt; If this is set, then the property can be memcopied instead of CopyCompleteValue / CopySingleValue</span></span><br><span class="line">	CPF_RepSkip							= <span class="number">0x0000000080000000</span>,	<span class="comment">///&lt; Not replicated. For non replicated properties in replicated structs </span></span><br><span class="line">	CPF_RepNotify						= <span class="number">0x0000000100000000</span>,	<span class="comment">///&lt; Notify actors when a property is replicated</span></span><br><span class="line">	CPF_Interp							= <span class="number">0x0000000200000000</span>,	<span class="comment">///&lt; interpolatable property for use with matinee</span></span><br><span class="line">	CPF_NonTransactional				= <span class="number">0x0000000400000000</span>,	<span class="comment">///&lt; Property isn&#x27;t transacted</span></span><br><span class="line">	CPF_EditorOnly						= <span class="number">0x0000000800000000</span>,	<span class="comment">///&lt; Property should only be loaded in the editor</span></span><br><span class="line">	CPF_NoDestructor					= <span class="number">0x0000001000000000</span>,	<span class="comment">///&lt; No destructor</span></span><br><span class="line">	<span class="comment">//CPF_								= 0x0000002000000000,	///&lt;</span></span><br><span class="line">	CPF_AutoWeak						= <span class="number">0x0000004000000000</span>,	<span class="comment">///&lt; Only used for weak pointers, means the export type is autoweak</span></span><br><span class="line">	CPF_ContainsInstancedReference		= <span class="number">0x0000008000000000</span>,	<span class="comment">///&lt; Property contains component references.</span></span><br><span class="line">	CPF_AssetRegistrySearchable			= <span class="number">0x0000010000000000</span>,	<span class="comment">///&lt; asset instances will add properties with this flag to the asset registry automatically</span></span><br><span class="line">	CPF_SimpleDisplay					= <span class="number">0x0000020000000000</span>,	<span class="comment">///&lt; The property is visible by default in the editor details view</span></span><br><span class="line">	CPF_AdvancedDisplay					= <span class="number">0x0000040000000000</span>,	<span class="comment">///&lt; The property is advanced and not visible by default in the editor details view</span></span><br><span class="line">	CPF_Protected						= <span class="number">0x0000080000000000</span>,	<span class="comment">///&lt; property is protected from the perspective of script</span></span><br><span class="line">	CPF_BlueprintCallable				= <span class="number">0x0000100000000000</span>,	<span class="comment">///&lt; MC Delegates only.  Property should be exposed for calling in blueprint code</span></span><br><span class="line">	CPF_BlueprintAuthorityOnly			= <span class="number">0x0000200000000000</span>,	<span class="comment">///&lt; MC Delegates only.  This delegate accepts (only in blueprint) only events with BlueprintAuthorityOnly.</span></span><br><span class="line">	CPF_TextExportTransient				= <span class="number">0x0000400000000000</span>,	<span class="comment">///&lt; Property shouldn&#x27;t be exported to text format (e.g. copy/paste)</span></span><br><span class="line">	CPF_NonPIEDuplicateTransient		= <span class="number">0x0000800000000000</span>,	<span class="comment">///&lt; Property should only be copied in PIE</span></span><br><span class="line">	CPF_ExposeOnSpawn					= <span class="number">0x0001000000000000</span>,	<span class="comment">///&lt; Property is exposed on spawn</span></span><br><span class="line">	CPF_PersistentInstance				= <span class="number">0x0002000000000000</span>,	<span class="comment">///&lt; A object referenced by the property is duplicated like a component. (Each actor should have an own instance.)</span></span><br><span class="line">	CPF_UObjectWrapper					= <span class="number">0x0004000000000000</span>,	<span class="comment">///&lt; Property was parsed as a wrapper class like TSubclassOf&lt;T&gt;, FScriptInterface etc., rather than a USomething*</span></span><br><span class="line">	CPF_HasGetValueTypeHash				= <span class="number">0x0008000000000000</span>,	<span class="comment">///&lt; This property can generate a meaningful hash value.</span></span><br><span class="line">	CPF_NativeAccessSpecifierPublic		= <span class="number">0x0010000000000000</span>,	<span class="comment">///&lt; Public native access specifier</span></span><br><span class="line">	CPF_NativeAccessSpecifierProtected	= <span class="number">0x0020000000000000</span>,	<span class="comment">///&lt; Protected native access specifier</span></span><br><span class="line">	CPF_NativeAccessSpecifierPrivate	= <span class="number">0x0040000000000000</span>,	<span class="comment">///&lt; Private native access specifier</span></span><br><span class="line">	CPF_SkipSerialization				= <span class="number">0x0080000000000000</span>,	<span class="comment">///&lt; Property shouldn&#x27;t be serialized, can still be exported to text</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>反射</category>
      </categories>
      <tags>
        <tag>反射</tag>
        <tag>UProperty</tag>
      </tags>
  </entry>
  <entry>
    <title>枚举的反射信息</title>
    <url>/wiki/37155/</url>
    <content><![CDATA[<p> 下列枚举类型：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ETargetPlatform.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ETargetPlatform.generated.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">UENUM</span>(BlueprintType)</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="title">ETargetPlatform</span> :</span> uint8</span><br><span class="line">&#123;</span><br><span class="line">	AllDesktop,</span><br><span class="line">	MacClient,</span><br><span class="line">	MacNoEditor,</span><br><span class="line">	MacServer,</span><br><span class="line">	Mac,</span><br><span class="line">	WindowsClient,</span><br><span class="line">	WindowsNoEditor,</span><br><span class="line">	WindowsServer,</span><br><span class="line">	Windows,</span><br><span class="line">	Android,</span><br><span class="line">	Android_ASTC,</span><br><span class="line">	Android_ATC,</span><br><span class="line">	Android_DXT,</span><br><span class="line">	Android_ETC1,</span><br><span class="line">	Android_ETC1a,</span><br><span class="line">	Android_ETC2,</span><br><span class="line">	Android_PVRTC,</span><br><span class="line">	AndroidClient,</span><br><span class="line">	Android_ASTCClient,</span><br><span class="line">	Android_ATCClient,</span><br><span class="line">	Android_DXTClient,</span><br><span class="line">	Android_ETC1Client,</span><br><span class="line">	Android_ETC1aClient,</span><br><span class="line">	Android_ETC2Client,</span><br><span class="line">	Android_PVRTCClient,</span><br><span class="line">	Android_Multi,</span><br><span class="line">	Android_MultiClient,</span><br><span class="line">	HTML5,</span><br><span class="line">	IOSClient,</span><br><span class="line">	IOS,</span><br><span class="line">	TVOSClient,</span><br><span class="line">	TVOS,</span><br><span class="line">	LinuxClient,</span><br><span class="line">	LinuxNoEditor,</span><br><span class="line">	LinuxServer,</span><br><span class="line">	Linux,</span><br><span class="line">	Lumin,</span><br><span class="line">	LuminClient</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p> 经过 UHT 之后的反射代码为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ETargetPlatform.generated.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;UObject/ObjectMacros.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;UObject/ScriptMacros.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">PRAGMA_DISABLE_DEPRECATION_WARNINGS</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HOTPATCHERRUNTIME_ETargetPlatform_generated_h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">error</span> <span class="meta-string">&quot;ETargetPlatform.generated.h already included, missing &#x27;#pragma once&#x27; in ETargetPlatform.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HOTPATCHERRUNTIME_ETargetPlatform_generated_h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> CURRENT_FILE_ID</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CURRENT_FILE_ID HotThirdPerson_Plugins_ue4_HotPackage_HotPatcher_Source_HotPatcherRuntime_Public_ETargetPlatform_h</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FOREACH_ENUM_ETARGETPLATFORM(op) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::AllDesktop) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::MacClient) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::MacNoEditor) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::MacServer) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::Mac) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::WindowsClient) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::WindowsNoEditor) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::WindowsServer) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::Windows) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::Android) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::Android_ASTC) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::Android_ATC) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::Android_DXT) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::Android_ETC1) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::Android_ETC1a) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::Android_ETC2) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::Android_PVRTC) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::AndroidClient) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::Android_ASTCClient) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::Android_ATCClient) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::Android_DXTClient) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::Android_ETC1Client) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::Android_ETC1aClient) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::Android_ETC2Client) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::Android_PVRTCClient) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::Android_Multi) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::Android_MultiClient) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::HTML5) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::IOSClient) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::IOS) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::TVOSClient) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::TVOS) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::LinuxClient) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::LinuxNoEditor) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::LinuxServer) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::Linux) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::Lumin) \</span></span><br><span class="line"><span class="meta">	op(ETargetPlatform::LuminClient) </span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="title">ETargetPlatform</span> :</span> uint8;</span><br><span class="line"><span class="keyword">template</span>&lt;&gt; HOTPATCHERRUNTIME_API UEnum* StaticEnum&lt;ETargetPlatform&gt;();</span><br><span class="line"></span><br><span class="line">PRAGMA_ENABLE_DEPRECATION_WARNINGS</span><br></pre></td></tr></table></figure>

<p> 产生的 <code>gen.cpp</code>：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;UObject/GeneratedCppIncludes.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;HotPatcherRuntime/Public/ETargetPlatform.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _MSC_VER</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span> (push)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span> (disable : 4883)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="function">PRAGMA_DISABLE_DEPRECATION_WARNINGS</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EmptyLinkFunctionForGeneratedCodeETargetPlatform</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"><span class="comment">// Cross Module References</span></span><br><span class="line">	<span class="function">HOTPATCHERRUNTIME_API UEnum* <span class="title">Z_Construct_UEnum_HotPatcherRuntime_ETargetPlatform</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function">UPackage* <span class="title">Z_Construct_UPackage__Script_HotPatcherRuntime</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// End Cross Module References</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> UEnum* <span class="title">ETargetPlatform_StaticEnum</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">static</span> UEnum* Singleton = <span class="literal">nullptr</span>;</span><br><span class="line">		<span class="keyword">if</span> (!Singleton)</span><br><span class="line">		&#123;</span><br><span class="line">			Singleton = <span class="built_in">GetStaticEnum</span>(Z_Construct_UEnum_HotPatcherRuntime_ETargetPlatform, <span class="built_in">Z_Construct_UPackage__Script_HotPatcherRuntime</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;ETargetPlatform&quot;</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> Singleton;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">template</span>&lt;&gt; HOTPATCHERRUNTIME_API UEnum* StaticEnum&lt;ETargetPlatform&gt;()</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">ETargetPlatform_StaticEnum</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> FCompiledInDeferEnum <span class="title">Z_CompiledInDeferEnum_UEnum_ETargetPlatform</span><span class="params">(ETargetPlatform_StaticEnum, TEXT(<span class="string">&quot;/Script/HotPatcherRuntime&quot;</span>), TEXT(<span class="string">&quot;ETargetPlatform&quot;</span>), <span class="literal">false</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line">	<span class="function">uint32 <span class="title">Get_Z_Construct_UEnum_HotPatcherRuntime_ETargetPlatform_Hash</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">2902485356U</span>; &#125;</span><br><span class="line">	<span class="function">UEnum* <span class="title">Z_Construct_UEnum_HotPatcherRuntime_ETargetPlatform</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">		UPackage* Outer = <span class="built_in">Z_Construct_UPackage__Script_HotPatcherRuntime</span>();</span><br><span class="line">		<span class="keyword">static</span> UEnum* ReturnEnum = <span class="built_in">FindExistingEnumIfHotReloadOrDynamic</span>(Outer, <span class="built_in">TEXT</span>(<span class="string">&quot;ETargetPlatform&quot;</span>), <span class="number">0</span>, <span class="built_in">Get_Z_Construct_UEnum_HotPatcherRuntime_ETargetPlatform_Hash</span>(), <span class="literal">false</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		<span class="keyword">static</span> UEnum* ReturnEnum = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// WITH_HOT_RELOAD</span></span></span><br><span class="line">		<span class="keyword">if</span> (!ReturnEnum)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FEnumeratorParam Enumerators[] = &#123;</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::AllDesktop&quot;</span>, (int64)ETargetPlatform::AllDesktop &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::MacClient&quot;</span>, (int64)ETargetPlatform::MacClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::MacNoEditor&quot;</span>, (int64)ETargetPlatform::MacNoEditor &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::MacServer&quot;</span>, (int64)ETargetPlatform::MacServer &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Mac&quot;</span>, (int64)ETargetPlatform::Mac &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::WindowsClient&quot;</span>, (int64)ETargetPlatform::WindowsClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::WindowsNoEditor&quot;</span>, (int64)ETargetPlatform::WindowsNoEditor &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::WindowsServer&quot;</span>, (int64)ETargetPlatform::WindowsServer &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Windows&quot;</span>, (int64)ETargetPlatform::Windows &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android&quot;</span>, (int64)ETargetPlatform::Android &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ASTC&quot;</span>, (int64)ETargetPlatform::Android_ASTC &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ATC&quot;</span>, (int64)ETargetPlatform::Android_ATC &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_DXT&quot;</span>, (int64)ETargetPlatform::Android_DXT &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ETC1&quot;</span>, (int64)ETargetPlatform::Android_ETC1 &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ETC1a&quot;</span>, (int64)ETargetPlatform::Android_ETC1a &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ETC2&quot;</span>, (int64)ETargetPlatform::Android_ETC2 &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_PVRTC&quot;</span>, (int64)ETargetPlatform::Android_PVRTC &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::AndroidClient&quot;</span>, (int64)ETargetPlatform::AndroidClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ASTCClient&quot;</span>, (int64)ETargetPlatform::Android_ASTCClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ATCClient&quot;</span>, (int64)ETargetPlatform::Android_ATCClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_DXTClient&quot;</span>, (int64)ETargetPlatform::Android_DXTClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ETC1Client&quot;</span>, (int64)ETargetPlatform::Android_ETC1Client &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ETC1aClient&quot;</span>, (int64)ETargetPlatform::Android_ETC1aClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ETC2Client&quot;</span>, (int64)ETargetPlatform::Android_ETC2Client &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_PVRTCClient&quot;</span>, (int64)ETargetPlatform::Android_PVRTCClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_Multi&quot;</span>, (int64)ETargetPlatform::Android_Multi &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_MultiClient&quot;</span>, (int64)ETargetPlatform::Android_MultiClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::HTML5&quot;</span>, (int64)ETargetPlatform::HTML5 &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::IOSClient&quot;</span>, (int64)ETargetPlatform::IOSClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::IOS&quot;</span>, (int64)ETargetPlatform::IOS &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::TVOSClient&quot;</span>, (int64)ETargetPlatform::TVOSClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::TVOS&quot;</span>, (int64)ETargetPlatform::TVOS &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::LinuxClient&quot;</span>, (int64)ETargetPlatform::LinuxClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::LinuxNoEditor&quot;</span>, (int64)ETargetPlatform::LinuxNoEditor &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::LinuxServer&quot;</span>, (int64)ETargetPlatform::LinuxServer &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Linux&quot;</span>, (int64)ETargetPlatform::Linux &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Lumin&quot;</span>, (int64)ETargetPlatform::Lumin &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::LuminClient&quot;</span>, (int64)ETargetPlatform::LuminClient &#125;,</span><br><span class="line">			&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">			<span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Enum_MetaDataParams[] = &#123;</span><br><span class="line">				&#123; <span class="string">&quot;BlueprintType&quot;</span>, <span class="string">&quot;true&quot;</span> &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;Public/ETargetPlatform.h&quot;</span> &#125;,</span><br><span class="line">			&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">			<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FEnumParams EnumParams = &#123;</span><br><span class="line">				(UObject*(*)())Z_Construct_UPackage__Script_HotPatcherRuntime,</span><br><span class="line">				<span class="literal">nullptr</span>,</span><br><span class="line">				<span class="string">&quot;ETargetPlatform&quot;</span>,</span><br><span class="line">				<span class="string">&quot;ETargetPlatform&quot;</span>,</span><br><span class="line">				Enumerators,</span><br><span class="line">				<span class="built_in">ARRAY_COUNT</span>(Enumerators),</span><br><span class="line">				RF_Public|RF_Transient|RF_MarkAsNative,</span><br><span class="line">				UE4CodeGen_Private::EDynamicType::NotDynamic,</span><br><span class="line">				(uint8)UEnum::ECppForm::EnumClass,</span><br><span class="line">				<span class="built_in">METADATA_PARAMS</span>(Enum_MetaDataParams, <span class="built_in">ARRAY_COUNT</span>(Enum_MetaDataParams))</span><br><span class="line">			&#125;;</span><br><span class="line">			UE4CodeGen_Private::<span class="built_in">ConstructUEnum</span>(ReturnEnum, EnumParams);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> ReturnEnum;</span><br><span class="line">	&#125;</span><br><span class="line">PRAGMA_ENABLE_DEPRECATION_WARNINGS</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _MSC_VER</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span> (pop)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> 枚举值的名字可以通过下列方法获得：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">FString PlatformName = StaticEnum&lt;ETargetPlatform&gt;()-&gt;<span class="built_in">GetNameByValue</span>((int64)Platform).<span class="built_in">ToString</span>();</span><br></pre></td></tr></table></figure>
<p> 其得到的值是具有 namespace 的，如 <code>ETargetPlatform::WindowsNoEditor</code>.</p>
<p> 如果不想要 namespace 可以使用：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">FString PlatformName;</span><br><span class="line">&#123;</span><br><span class="line">	FString EnumName;</span><br><span class="line">	StaticEnum&lt;ETargetPlatform&gt;()-&gt;<span class="built_in">GetNameByValue</span>((int64)Platform).<span class="built_in">ToString</span>().<span class="built_in">Split</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;::&quot;</span>), &amp;EnumName, &amp;PlatformName,ESearchCase::CaseSensitive,ESearchDir::FromEnd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>反射</category>
      </categories>
  </entry>
  <entry>
    <title>类反射实现分析</title>
    <url>/wiki/33746/</url>
    <content><![CDATA[<h3 id="UHT 为类产生的反射信息"><a href="#UHT 为类产生的反射信息" class="headerlink" title="UHT 为类产生的反射信息"></a>UHT 为类产生的反射信息 </h3><p> 当在 UE 中新建一个类并继承自 <code>UObject</code> 时，可以在类声明的上一行添加 <code>UCLASS</code> 标记，当执行编译的时候 UBT 会调用 UHT 来根据标记来生成 C++ 代码（不过非 UCLASS 的类也可以用宏来生成反射信息）。</p>
<p>UHT 为类生成的代码为：</p>
<ol>
<li>为所有的 UFUNCTION 的函数创建 FName，命名规则为<code>NAME_CLASSNAME_FUNCTIONNAME</code>，如<code>NAME_AMyActor_TestFunc</code></li>
<li>BlueprintNativeEvent 和 BlueprintImplementEvent 创建同名函数实现，并通过 <code>ProcessEvent</code> 转发调用</li>
<li>为所有加了 UFUNCTION 的函数生成 Thunk 函数，为当前类的 static 函数，原型为<code>static void execFUNCNAME(UObject* Context, FFrame&amp; Stack, RESULT_DECL)</code>；</li>
<li>创建当前类的 <code>StaticRegisterNatives*</code> 函数，并把上一步提到的 <code>exec</code> 这样的 thunk 函数通过 <code>Name-execFunc 指针</code> 的形式通过 <code>FNativeFunctionRegistrar::RegisterFunctions</code> 注册到 UClass；</li>
<li>创建出 <code>Z_Construct_UClass_CLASSNAME_NoRegister</code> 函数，返回值是<code>CLASSNAME::StaticClass()</code></li>
<li>创建出 <code>Z_Construct_UClass_CLASSNAME_Statics</code> 类（GENERATED_BODY 等宏会把该类添加为我们创建类的友元，使其可以访问私有成员，用于获取成员指针）</li>
</ol>
<p><code>Z_Construct_UClass_CLASSNAME_Statics</code>类的结构为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AMyActor.h</span></span><br><span class="line"><span class="built_in">UCLASS</span>(BlueprintType)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XXXX_API</span> <span class="title">AMyActor</span>:</span><span class="keyword">public</span> AActor</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">UPROPERTY</span>()</span><br><span class="line">		int32 ival;</span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">		<span class="function">int32 <span class="title">GetIval</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">TESTFUNC</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// generated code in AMyActor.gen.cpp</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Z_Construct_UClass_AMyActor_Statics</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">static</span> UObject* (*<span class="keyword">const</span> DependentSingletons[])();</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> FClassFunctionLinkInfo FuncInfo[];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam NewProp_ival_MetaData[];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FIntPropertyParams NewProp_ival;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase* <span class="keyword">const</span> PropPointers[];</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FImplementedInterfaceParams InterfaceParams[];</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> FCppClassTypeInfoStatic StaticCppClassTypeInfo;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FClassParams ClassParams;</span><br><span class="line">	&#125;;</span><br><span class="line">	UObject* (*<span class="keyword">const</span> Z_Construct_UClass_AMyActor_Statics::DependentSingletons[])() = &#123;</span><br><span class="line">	(UObject* (*)())Z_Construct_UClass_AActor,</span><br><span class="line">	(UObject* (*)())Z_Construct_UPackage__Script_MicroEnd_423,</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">const</span> FClassFunctionLinkInfo Z_Construct_UClass_AMyActor_Statics::FuncInfo[] = &#123;</span><br><span class="line">	&#123; &amp;Z_Construct_UFunction_AMyActor_GetIval, <span class="string">&quot;GetIval&quot;</span> &#125;, <span class="comment">// 3480851337</span></span><br><span class="line">	&#123; &amp;Z_Construct_UFunction_AMyActor_TESTFUNC, <span class="string">&quot;TESTFUNC&quot;</span> &#125;, <span class="comment">// 2984899165</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>该类中的成员为：</p>
<ul>
<li><code>static UObject* (*const DependentSingletons[])();</code>记录当前类基类的 <code>Z_Construct_UClass_BASECLASSNAME</code> 函数指针，用它可以构造出基类的 UClass，还记录了当前类属于哪个 Package 的函数指针<code>Z_Construct_UPackage__Script_MODULENAME</code>。</li>
</ul>
<blockquote>
<p><code>Z_Construct_UPackage__Script_MODULENAME</code>函数是定义在 <code>MODULE_NAME.init.gen.cpp</code> 里。</p>
</blockquote>
<ul>
<li><code>static const UE4CodeGen_Private::FMetaDataPairParam Class_MetaDataParams[];</code>用于记录 UCLASS 的元数据，如 BlueprintType 标记</li>
<li>反射属性的 <code>F*PropertyParams</code> 以及其 Metadata，均为 static 成员</li>
<li><code>static const UE4CodeGen_Private::FPropertyParamsBase* const PropPointers[];</code>，数组，用于存储当前类所有的反射属性的信息（是个指针数组，用于存储 5.3 中的 static 成员的地址）</li>
<li><code>static const UE4CodeGen_Private::FImplementedInterfaceParams InterfaceParams[];</code>，数组，用于存储当前类所有的接口信息</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FImplementedInterfaceParams Z_Construct_UClass_AMyActor_Statics::InterfaceParams[] = &#123;</span><br><span class="line">	&#123; Z_Construct_UClass_UUnLuaInterface_NoRegister, (int32)<span class="built_in">VTABLE_OFFSET</span>(AMyActor, IUnLuaInterface), <span class="literal">false</span> &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>static const FCppClassTypeInfoStatic StaticCppClassTypeInfo;</code>用于类型萃取，记录当前类是否是抽象类。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> FCppClassTypeInfoStatic Z_Construct_UClass_AMyActor_Statics::StaticCppClassTypeInfo = &#123;</span><br><span class="line">		TCppClassTypeTraits&lt;AMyActor&gt;::IsAbstract,</span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>static const UE4CodeGen_Private::FClassParams ClassParams;</code>构造出 UClass 需要的所有反射数据，统一记录上面所有生成的反射信息。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FClassParams Z_Construct_UClass_AMyActor_Statics::ClassParams = &#123;</span><br><span class="line">	&amp;AMyActor::StaticClass,</span><br><span class="line">	<span class="literal">nullptr</span>,</span><br><span class="line">	&amp;StaticCppClassTypeInfo,</span><br><span class="line">	DependentSingletons,</span><br><span class="line">	FuncInfo,</span><br><span class="line">	Z_Construct_UClass_AMyActor_Statics::PropPointers,</span><br><span class="line">	InterfaceParams,</span><br><span class="line">	<span class="built_in">ARRAY_COUNT</span>(DependentSingletons),</span><br><span class="line">	<span class="built_in">ARRAY_COUNT</span>(FuncInfo),</span><br><span class="line">	<span class="built_in">ARRAY_COUNT</span>(Z_Construct_UClass_AMyActor_Statics::PropPointers),</span><br><span class="line">	<span class="built_in">ARRAY_COUNT</span>(InterfaceParams),</span><br><span class="line">	<span class="number">0x009000A0</span>u,</span><br><span class="line">	<span class="built_in">METADATA_PARAMS</span>(Z_Construct_UClass_AMyActor_Statics::Class_MetaDataParams, <span class="built_in">ARRAY_COUNT</span>(Z_Construct_UClass_AMyActor_Statics::Class_MetaDataParams))</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>全局函数 <code>Z_Construct_UClass_AMyActor</code> 通过 <code>ClassParams</code> 构造出真正的 UClass 对象。</li>
<li>使用 <a href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L1673">IMPLEMENT_CLASS</a> 注册当前类到 <a href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectBase.cpp#L608">GetDeferredClassRegistration()</a>，如果在<code>WITH_HOT_RELOAD</code> 为 true 的情况下也会注册到 <a href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectBase.cpp#L616">GetDeferRegisterClassMap()</a> 中。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Register a class at startup time.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMPLEMENT_CLASS(TClass, TClassCrc) \</span></span><br><span class="line"><span class="meta">	static TClassCompiledInDefer<span class="meta-string">&lt;TClass&gt;</span> AutoInitialize##TClass(TEXT(#TClass), sizeof(TClass), TClassCrc); \</span></span><br><span class="line"><span class="meta">	UClass* TClass::GetPrivateStaticClass() \</span></span><br><span class="line"><span class="meta">	&#123; \</span></span><br><span class="line"><span class="meta">		static UClass* PrivateStaticClass = NULL; \</span></span><br><span class="line"><span class="meta">		<span class="meta-keyword">if</span> (!PrivateStaticClass) \</span></span><br><span class="line"><span class="meta">		&#123; \</span></span><br><span class="line"><span class="meta">			<span class="comment">/* this could be handled with templates, but we want it external to avoid code bloat */</span> \</span></span><br><span class="line"><span class="meta">			GetPrivateStaticClassBody(\</span></span><br><span class="line"><span class="meta">				StaticPackage(), \</span></span><br><span class="line"><span class="meta">				(TCHAR*)TEXT(#TClass) + 1 + ((StaticClassFlags &amp; CLASS_Deprecated) ? 11 : 0), \</span></span><br><span class="line"><span class="meta">				PrivateStaticClass, \</span></span><br><span class="line"><span class="meta">				StaticRegisterNatives##TClass, \</span></span><br><span class="line"><span class="meta">				sizeof(TClass), \</span></span><br><span class="line"><span class="meta">				alignof(TClass), \</span></span><br><span class="line"><span class="meta">				(EClassFlags)TClass::StaticClassFlags, \</span></span><br><span class="line"><span class="meta">				TClass::StaticClassCastFlags(), \</span></span><br><span class="line"><span class="meta">				TClass::StaticConfigName(), \</span></span><br><span class="line"><span class="meta">				(UClass::ClassConstructorType)InternalConstructor<span class="meta-string">&lt;TClass&gt;</span>, \</span></span><br><span class="line"><span class="meta">				(UClass::ClassVTableHelperCtorCallerType)InternalVTableHelperCtorCaller<span class="meta-string">&lt;TClass&gt;</span>, \</span></span><br><span class="line"><span class="meta">				&amp;TClass::AddReferencedObjects, \</span></span><br><span class="line"><span class="meta">				&amp;TClass::Super::StaticClass, \</span></span><br><span class="line"><span class="meta">				&amp;TClass::WithinClass::StaticClass \</span></span><br><span class="line"><span class="meta">			); \</span></span><br><span class="line"><span class="meta">		&#125; \</span></span><br><span class="line"><span class="meta">		return PrivateStaticClass; \</span></span><br><span class="line"><span class="meta">	&#125;</span></span><br></pre></td></tr></table></figure>
<p>如 <code>AMyActor</code> 的<code>IMPLEMENT_CLASS(AMyActor,3240835608)</code>经过预处理之后为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> TClassCompiledInDefer&lt;AMyActor&gt; <span class="title">AutoInitializeAMyActor</span><span class="params">(TEXT(<span class="string">&quot;AMyActor&quot;</span>), <span class="keyword">sizeof</span>(AMyActor), <span class="number">3240835608</span>)</span></span>;</span><br><span class="line"><span class="function">UClass * <span class="title">AMyActor::GetPrivateStaticClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> UClass * PrivateStaticClass = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">if</span> (!PrivateStaticClass) </span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">GetPrivateStaticClassBody</span>(</span><br><span class="line">    	<span class="built_in">StaticPackage</span>(), </span><br><span class="line">    	(TCHAR*)<span class="built_in">TEXT</span>(<span class="string">&quot;AMyActor&quot;</span>) + <span class="number">1</span> + ((StaticClassFlags &amp; CLASS_Deprecated) ? <span class="number">11</span> : <span class="number">0</span>), </span><br><span class="line">    	PrivateStaticClass, </span><br><span class="line">    	StaticRegisterNativesAMyActor, </span><br><span class="line">    	<span class="built_in"><span class="keyword">sizeof</span></span>(AMyActor), </span><br><span class="line">    	<span class="built_in"><span class="keyword">alignof</span></span>(AMyActor), </span><br><span class="line">    	(EClassFlags)AMyActor::StaticClassFlags, </span><br><span class="line">    	AMyActor::<span class="built_in">StaticClassCastFlags</span>(), </span><br><span class="line">    	AMyActor::<span class="built_in">StaticConfigName</span>(), </span><br><span class="line">    	(UClass::ClassConstructorType)InternalConstructor&lt;AMyActor&gt;, </span><br><span class="line">    	(UClass::ClassVTableHelperCtorCallerType) InternalVTableHelperCtorCaller&lt;AMyActor&gt;, </span><br><span class="line">    	&amp;AMyActor::AddReferencedObjects, </span><br><span class="line">    	&amp;AMyActor::Super::StaticClass, </span><br><span class="line">    	&amp;AMyActor::WithinClass::StaticClass</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> PrivateStaticClass;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中 <code>TClassCompiledInDefer&lt;TClass&gt;</code> 这个模板类的构造函数中通过调用 <a href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectBase.cpp#L643">UClassCompiledInDefer</a> 将当前反射类的注册到 <a href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectBase.cpp#L608">GetDeferredClassRegistration()</a>，它得到的是一个类型为<code>FFieldCompiledInInfo*</code> 的数组，用于记录引擎中所有反射类的信息，用于在 CoreUObjectModule 启动时将 UHT 生成的这些反射信息在 <a href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectBase.cpp#L921">ProcessNewlyLoadedUObjects</a> 函数中通过 <a href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectBase.cpp#L745">UClassRegisterAllCompiledInClasses</a> 将所有反射类的 UClass 构造出来。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** Register all loaded classes */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UClassRegisterAllCompiledInClasses</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">	TArray&lt;UClass*&gt; AddedClasses;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;UClassRegisterAllCompiledInClasses&quot;</span>);</span><br><span class="line"></span><br><span class="line">	TArray&lt;FFieldCompiledInInfo*&gt;&amp; DeferredClassRegistration = <span class="built_in">GetDeferredClassRegistration</span>();</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">const</span> FFieldCompiledInInfo* Class : DeferredClassRegistration)</span><br><span class="line">	&#123;</span><br><span class="line">		UClass* RegisteredClass = Class-&gt;<span class="built_in">Register</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">		<span class="keyword">if</span> (GIsHotReload &amp;&amp; Class-&gt;OldClass == <span class="literal">nullptr</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			AddedClasses.<span class="built_in">Add</span>(RegisteredClass);</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;</span><br><span class="line">	DeferredClassRegistration.<span class="built_in">Empty</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">	<span class="keyword">if</span> (AddedClasses.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		FCoreUObjectDelegates::RegisterHotReloadAddedClassesDelegate.<span class="built_in">Broadcast</span>(AddedClasses);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而 <code>TClassCompiledInDefer&lt;AMyActor&gt;</code> 的<code>Register</code>函数就是调用 <code>AMyActor::StaticClass</code> 的，然后 StaticClass 中调用 <code>GetPrivateStaticClass</code>，其中有一个 static 对象，就是当前类的 UClass，所以它只会构造依次，使用<code>UXXXX::StaticClass</code> 都是直接获得。</p>
<blockquote>
<p>注意：UClass 的构造是跟着模块的启动创建的，所以之后当引擎启动到一个模块的时候它的 UClass 才被创建出来）。</p>
</blockquote>
<h3 id="非 UCLASS 的反射"><a href="# 非 UCLASS 的反射" class="headerlink" title="非 UCLASS 的反射"></a>非 UCLASS 的反射 </h3><p> 有些继承自 UObject 的类是没有加 UCLASS 标记的，所以也不会包含 <code>gen.cpp</code> 和<code>generated.h</code>文件，但是 UE 也提供了非 UCLASS 的反射方法，类似于 <a href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb/Engine/Source/Runtime/CoreUObject/Public/Misc/TextBuffer.h#L14">UTextureBuffer</a> 这个类。</p>
<p>在类内时添加 <a href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L1628">DECLARE_CASTED_CLASS_INTRINSIC_WITH_API</a> 宏用于手动添加，实现类似 UHT 生成 <code>GENERATED_BODY</code> 宏的操作：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UTextBuffer</span></span></span><br><span class="line"><span class="class">	:</span> <span class="keyword">public</span> UObject</span><br><span class="line">	, <span class="keyword">public</span> FOutputDevice</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">DECLARE_CASTED_CLASS_INTRINSIC_WITH_API</span>(UTextBuffer, UObject, <span class="number">0</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;/Script/CoreUObject&quot;</span>), CASTCLASS_None, COREUOBJECT_API)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L1628">DECLARE_CASTED_CLASS_INTRINSIC_WITH_API</a>可以处理类似 <code>generated.h</code> 的行为，但是 <code>gen.cpp</code> 里创建出 <code>static TClassCompiledInDefer&lt;CLASS_NAME&gt;</code> 的代码还没有，UE 提供了另一个宏:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">IMPLEMENT_CORE_INTRINSIC_CLASS</span>(UTextBuffer, UObject, &#123; &#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li><a href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L1731">IMPLEMENT_CORE_INTRINSIC_CLASS</a>，用来生成类似 gen.cpp 中的代码， 还可以通过宏的第三个参数来传入代码。</li>
</ul>
<p>虽然和 <code>gen.cpp</code> 里通过 UHT 生成的代码不同，但是统一使用 <code>TClassCompiledInDefer&lt;TClass&gt;</code> 和<code>FCompiledInDefer</code>来注册到引擎中。<br>这样就实现了可以不使用 UCLASS 标记也可以为继承自 UObject 的类生成反射信息。</p>
<h3 id="UClass 的构造思路"><a href="#UClass 的构造思路" class="headerlink" title="UClass 的构造思路"></a>UClass 的构造思路 </h3><p> 前面讲了这么多都是在分析 UE 创建 UClass 的代码，我想从 UE 的实现思路上分析一下设计过程。</p>
<ol>
<li>首先 UHT 通过分析代码创建出 gen.cpp 和 generated.h 中间记录着当前类的反射信息、类本身的反射信息、类中函数的反射信息、类数据成员的反射信息。</li>
<li>当前类的反射信息（类、成员函数、数据成员）等被统一存储在一个名为 <code>Z_Construct_UClass_CLASSNAME_Statics</code> 的结构中；</li>
<li>该结构通过 <code>IMPLEMENT_CLASS</code> 生成的代码将当前类添加到 <a href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectBase.cpp#L608">GetDeferredClassRegistration()</a> 中。因为 <strong> 全局作用域 static 对象的构造时机 </strong> 是先于主函数的第一条语句的，所以当进入引擎逻辑的时候，引擎内置的模块中类的 <code>TClassCompiledInDefer&lt;&gt;</code> 都已经被创建完毕，在编辑器模式下， 因为不同的模块都是编译为 DLL 的，所以在加载模块的时候它们的 static 对象才会被创建。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// gen.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> TClassCompiledInDefer&lt;AMyActor&gt; <span class="title">AutoInitializeAMyActor</span><span class="params">(TEXT(<span class="string">&quot;AMyActor&quot;</span>), <span class="keyword">sizeof</span>(AMyActor), <span class="number">3240835608</span>)</span></span>;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>与上一步同样的手法，把类生成的反射信息通过 <code>FCompiledInDefer</code> 收集到<code>GetDeferredCompiledInRegistration()</code></li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> FCompiledInDefer <span class="title">Z_CompiledInDefer_UClass_AMyActor</span><span class="params">(Z_Construct_UClass_AMyActor, &amp;AMyActor::StaticClass, TEXT(<span class="string">&quot;/Script/MicroEnd_423&quot;</span>), TEXT(<span class="string">&quot;AMyActor&quot;</span>), <span class="literal">false</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>)</span></span>;</span><br></pre></td></tr></table></figure>



<h4 id="引擎如何使用生成的反射信息"><a href="# 引擎如何使用生成的反射信息" class="headerlink" title="引擎如何使用生成的反射信息"></a>引擎如何使用生成的反射信息 </h4><p> 在 UHT 生成反射的代码之后，引擎会根据这些代码生成 UClass、UStruct、UEnum、UFunction 和 UProperty 等。</p>
<p>它们都是在 <code>ProcessNewlyLoadedUObjects</code> 中被执行的，<strong>注意 </strong> 该函数会进来很多次，当每一个模块被加载的时候都会走一遍，因为在 <a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/CoreUObject/Private/UObject/Obj.cpp#L4326">Obj.cpp</a> 的<a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/CoreUObject/Private/UObject/Obj.cpp#L4326">InitUObject</a>函数中，把函数 <a href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectBase.cpp#L921">ProcessNewlyLoadedUObjects</a> 添加到了 <code>FModuleManager::Get().OnProcessLoadedObjectsCallback()</code> 中：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !USE_PER_MODULE_UOBJECT_BOOTSTRAP <span class="comment">// otherwise this is already done</span></span></span><br><span class="line">	FModuleManager::<span class="built_in">Get</span>().<span class="built_in">OnProcessLoadedObjectsCallback</span>().<span class="built_in">AddStatic</span>(ProcessNewlyLoadedUObjects);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p><strong>之所以 </strong> 要这么做，是因为 UE 的 Module 中都会有很多的反射类，但引擎一启动并不是所有的类在同一时刻都被加载了，因为模块有不同的加载时机，所以引擎中对于 UClass 的构造也不是一个一次性过程。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// CoreUObject/Private/UObject/UObjectBase.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ProcessNewlyLoadedUObjects</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">LLM_SCOPE</span>(ELLMTag::UObject);</span><br><span class="line">	<span class="built_in">DECLARE_SCOPE_CYCLE_COUNTER</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ProcessNewlyLoadedUObjects&quot;</span>), STAT_ProcessNewlyLoadedUObjects, STATGROUP_ObjectVerbose);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UClassRegisterAllCompiledInClasses</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> TArray&lt;UClass* (*)()&gt;&amp; DeferredCompiledInRegistration = <span class="built_in">GetDeferredCompiledInRegistration</span>();</span><br><span class="line">	<span class="keyword">const</span> TArray&lt;FPendingStructRegistrant&gt;&amp; DeferredCompiledInStructRegistration = <span class="built_in">GetDeferredCompiledInStructRegistration</span>();</span><br><span class="line">	<span class="keyword">const</span> TArray&lt;FPendingEnumRegistrant&gt;&amp; DeferredCompiledInEnumRegistration = <span class="built_in">GetDeferredCompiledInEnumRegistration</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> bNewUObjects = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">while</span>(GFirstPendingRegistrant || DeferredCompiledInRegistration.<span class="built_in">Num</span>() || DeferredCompiledInStructRegistration.<span class="built_in">Num</span>() || DeferredCompiledInEnumRegistration.<span class="built_in">Num</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		bNewUObjects = <span class="literal">true</span>;</span><br><span class="line">		<span class="built_in">UObjectProcessRegistrants</span>();</span><br><span class="line">		<span class="built_in">UObjectLoadAllCompiledInStructs</span>();</span><br><span class="line">		<span class="built_in">UObjectLoadAllCompiledInDefaultProperties</span>();</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">	<span class="built_in">UClassReplaceHotReloadClasses</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bNewUObjects &amp;&amp; !GIsInitialLoad)</span><br><span class="line">	&#123;</span><br><span class="line">		UClass::<span class="built_in">AssembleReferenceTokenStreams</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UClass 构造的调用栈：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-reflex/ue4-uclass-register-all-compiled.webp"></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// CoreUObject/Private/UObject/UObjectBase.cpp</span></span><br><span class="line"><span class="comment">/** Register all loaded classes */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UClassRegisterAllCompiledInClasses</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">	TArray&lt;UClass*&gt; AddedClasses;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	TArray&lt;FFieldCompiledInInfo*&gt;&amp; DeferredClassRegistration = <span class="built_in">GetDeferredClassRegistration</span>();</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">const</span> FFieldCompiledInInfo* Class : DeferredClassRegistration)</span><br><span class="line">	&#123;</span><br><span class="line">		UClass* RegisteredClass = Class-&gt;<span class="built_in">Register</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">		<span class="keyword">if</span> (GIsHotReload &amp;&amp; Class-&gt;OldClass == <span class="literal">nullptr</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			AddedClasses.<span class="built_in">Add</span>(RegisteredClass);</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;</span><br><span class="line">	DeferredClassRegistration.<span class="built_in">Empty</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">	<span class="keyword">if</span> (AddedClasses.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		FCoreUObjectDelegates::RegisterHotReloadAddedClassesDelegate.<span class="built_in">Broadcast</span>(AddedClasses);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，在 <code>UClassRegisterAllCompiledInClasses</code> 只是去调用了每个反射类的 StaticClass 函数（<code>Class-&gt;Register()</code>内部是对类型的 <code>StaticClass</code> 的转发调用），在开启 <code>WITH_HOT_RELOAD</code> 的情况下也会把新的 UClass 给代理调用传递出去，然后把当前的数组置空。</p>
<p>之所以要置空，就是因为前面说的，UE 的 UClass 构造是一个模块一个模块来执行的，当一个模块执行完毕之后就把当前模块注册到 <code>GetDeferredClassRegistration()</code> 里的元素置空，等着下个模块启动的时候（加载 DLL 时它们的 static 成员会构造然后注册到里面），再执行 <code>LoadModuleWithFailureReason</code> 就是又一遍循环。</p>
<p>在模块启动的时候会执行 <code>LoadModuleWithFailureReason</code> 里面调用了这个 Delegate，所以每一个模块启动的时候都会执行<code>ProcessNewlyLoadedUObjects</code>，把自己当前模块中的 UClass/UStruct/UEnum 都构造出来。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>反射</category>
      </categories>
      <tags>
        <tag>反射</tag>
        <tag>UClass</tag>
      </tags>
  </entry>
  <entry>
    <title>UE4Launcher</title>
    <url>/wiki/10556/</url>
    <content><![CDATA[<p><a href="https://github.com/hxhb/UE4Launcher">hxhb/UE4Launcher</a>是我使用 UE 的 <code>Program</code> 模式写的一个便捷的 UE Project 启动器，可以方便地加入启动参数，选择引擎版本，可以从 <a href="https://github.com/hxhb/UE4Launcher/releases">hxhb/UE4Launcher/release</a> 下载并安装，也支持 UE5。<br><a href="https://github.com/hxhb/UE4Launcher">hxhb/UE4Launcher</a>目前具有的功能如下:</p>
<ul>
<li>获取当前系统环境注册的所有引擎版本</li>
<li>打开 Project，并支持任意数量的启动参数</li>
<li>加载 / 保存 / 编辑配置文件</li>
<li>从命令行启动配置文件</li>
<li>支持写入注册表关联文件及右键菜单 (<strong> 以管理员权限运行</strong>)</li>
<li>关联 <code>.uproject</code> 右键菜单生成配置文件(<code>.uejson</code>)</li>
<li>关联配置文件 <code>.uejson</code> 可快速编辑</li>
<li>关联 <code>.uejson</code> 的右键菜单，支持编辑和启动配置</li>
<li>支持检测当前项目是否有 sln，可支持直接启动项目 sln(v0.16)</li>
</ul>
<p>主界面：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/31962/ue4launcher-noconf-window.webp"><br>编辑配置文件:<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/31962/ue4launcher-shootergame-conf-window.webp"><br><code>.uproject</code>文件的右键菜单关联：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/31962/ue4launcher-uproject-rightmouse-menu.webp"><br><code>.uejson</code>文件的右键菜单关联：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/31962/ue4launcher-uejson-rightmouse-menu.webp"><br>命令行的参数支持：</p>
<ul>
<li><code>-g</code>：<code>-g</code>参数后跟 <code>.uproject</code> 文件，为 <code>.uproject</code> 生成 <code>.uejson</code> 配置文件;</li>
<li><code>-e</code>：<code>-e</code>参数后跟 <code>.uejson</code> 文件，打开窗口以编辑该配置文件;</li>
<li><code>-c</code>：<code>-c</code>参数后跟 <code>.uejson</code> 文件，启动该配置(不会打开编辑窗口)</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># generate LauncherConf_ShooterGame.uejson</span></span><br><span class="line">$ UE4Launcher.exe -g ShooterGame.uproject</span><br><span class="line"><span class="comment"># Launch Edit Window with .uejson</span></span><br><span class="line">$ UE4Launcher.exe -e LauncherConf_ShooterGame.uejson</span><br><span class="line"><span class="comment"># Launch Conf</span></span><br><span class="line">$ UE4Launcher.exe -c LauncherConf_ShooterGame.uejson</span><br></pre></td></tr></table></figure>
<p>源码中也支持非常简单的扩展 UE 的其他工具，比如 <code>UBT</code>/<code>AutomationTool</code> 等，都可以增加为启动的工具 (<code>Editor/Editor-cmd</code> 为默认)。<br>PS: 功能实现的也比较仓促，后续有时间可以增加一个列表面板，将其扩展为一个完整的 Launcher。</p>
<h3 id="v0-17"><a href="#v0-17" class="headerlink" title="v0.17"></a>v0.17</h3><p><a href="https://github.com/hxhb/UE4Launcher/releases/tag/v0.17">Download Link</a></p>
<ul>
<li>添加启动工具的配置化</li>
<li>优化配置的 json 结构</li>
</ul>
<p>现在可以不用修改代码来添加 UE 的其他工具了，第一次启动时会在 <code>UE4Launcher.exe</code> 所在的目录下生成一个 <code>LaunchTools.json</code> 的文件：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;LaunchTools&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;ToolName&quot;</span>: <span class="string">&quot;UE4Editor&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;PreArgs&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;BinPath&quot;</span>: <span class="string">&quot;Engine/Binaries/Win64&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;ToolName&quot;</span>: <span class="string">&quot;UE4Editor-cmd&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;PreArgs&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;BinPath&quot;</span>: <span class="string">&quot;Engine/Binaries/Win64&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;ToolName&quot;</span>: <span class="string">&quot;UnrealFrontend&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;PreArgs&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;BinPath&quot;</span>: <span class="string">&quot;Engine/Binaries/Win64&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;ToolName&quot;</span>: <span class="string">&quot;NetworkProfiler&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;PreArgs&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;BinPath&quot;</span>: <span class="string">&quot;Engine/Binaries/DotNET&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是默认的四个工具，可以按照相同的格式在这里添加。</p>
<p>参数说明：</p>
<ul>
<li><code>ToolName</code>：该工具的 exe 名，去掉后缀；</li>
<li><code>PreArgs</code>：启动时默认传递什么参数；</li>
<li><code>BinPath</code>：相对于引擎的路径；</li>
</ul>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/31962/ue4launcher-add-other-tools.webp"></p>
<h3 id="v0-16"><a href="#v0-16" class="headerlink" title="v0.16"></a>v0.16</h3><p><a href="https://github.com/hxhb/UE4Launcher/releases/tag/v0.16">Download Link</a></p>
<ul>
<li>Fix bugs</li>
<li>Support launch project sln with Visual Studio</li>
</ul>
<h3 id="v0-15"><a href="#v0-15" class="headerlink" title="v0.15"></a>v0.15</h3><p><a href="https://github.com/hxhb/UE4Launcher/releases/tag/v0.15">Download Link</a></p>
<ul>
<li>Fix bugs</li>
<li>Ignore project and launch params when just selected program.</li>
<li>Support Launch UnrealFrontend and NetworkProfiler and custom additional tools</li>
</ul>
<h3 id="v0-14"><a href="#v0-14" class="headerlink" title="v0.14"></a>v0.14</h3><p><a href="https://github.com/hxhb/UE4Launcher/releases/tag/v0.14">Download Links</a></p>
<ul>
<li>Fix bugs</li>
<li>Add installer icon.</li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>工具</tag>
        <tag>Tools</tag>
        <tag>Launcher</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 工具集：我的开源项目介绍</title>
    <url>/wiki/c735df6d/</url>
    <content><![CDATA[<p>工欲善其事必先利其器，本文主要介绍在我在使用 UE 的过程中开发的一些开源的工具和插件，能够方便地在项目中使用，提高开发效率。之前简单罗列在 <a href="https://imzlp.com/resources/"> 资源 </a> 页面里，今天做一个详细的整理，对各个工具、插件做一些介绍。</p>
<h2 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h2><p>本节主要介绍我开发和部署的 UE 的外部工具，可以方便开发流程。</p>
<h3 id="UE4PROGRAM"><a href="#UE4PROGRAM" class="headerlink" title="UE4PROGRAM"></a>UE4PROGRAM</h3><p><a href="https://github.com/hxhb/ue4program">ue4program</a>是一个命令行工具，用于方便地创建 UE 的 <code>Standalone Application</code> 的工具（官方没有提供它的创建方法），可以使用 UE 来写一些独立程序而不依赖引擎启动的流程，也可以方便地测试引擎的功能而不用创建一个游戏项目。</p>
<p>详细介绍见我之前的文章：<a href="https://imzlp.com/posts/31962/">Create A Standalone Application in UE4</a></p>
<h3 id="UE4Launcher"><a href="#UE4Launcher" class="headerlink" title="UE4Launcher"></a>UE4Launcher</h3><p><a href="https://github.com/hxhb/UE4Launcher">UE4Launcher</a>是一个使用 UE 的 <code>Standalone Application</code> 的方式开发的独立程序，用来方便地切换引擎、启动项目、添加启动参数、保存配置，使用命令行通过配置启动，支持关联 <code>uproject</code> 文件。</p>
<p>主界面：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/31962/ue4launcher-shootergame-conf-window.webp"></p>
<p>uproject 的文件关联：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/31962/ue4launcher-uproject-rightmouse-menu.webp"></p>
<p>详细的用法和介绍可以看<a href="https://imzlp.com/posts/31962/">Create A Standalone Application in UE4</a></p>
<h3 id="UE4-API-FOR-DASH"><a href="#UE4-API-FOR-DASH" class="headerlink" title="UE4_API_FOR_DASH"></a>UE4_API_FOR_DASH</h3><p><a href="https://github.com/hxhb/UE4_API_FOR_DASH">UE4_API_FOR_DASH</a>是我制作的 UE4 API 的 Dash 文档源。可以方便地使用 <code>Dash</code> 或者 <code>Zeal</code> 来查询 UE 的 C++ API，目前最新的文档源是生成 UE4.25.3 引擎版本，如果后续有新的引擎版本发布，我也会不定期更新。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/11515/ue-doc-for-dash-425.webp"></p>
<p>文档源的下载和更新，见我之前的文章：<a href="https://imzlp.com/posts/11515/">抓取 UE4 API 并生成带索引的 Dash 文档</a></p>
<h3 id="UE4-Console-Help"><a href="#UE4-Console-Help" class="headerlink" title="UE4 Console Help"></a>UE4 Console Help</h3><p>UE 提供了 Console 命令的帮助文档，我把它部署到了公网，可以方便在线查看和搜索。</p>
<p>地址：<a href="https://consolehelp.imzlp.com/">consolehelp.imzlp.com</a></p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/21696/20201011094844.webp"></p>
<h3 id="UE4-Wiki-Archive"><a href="#UE4-Wiki-Archive" class="headerlink" title="UE4 Wiki Archive"></a>UE4 Wiki Archive</h3><p>UE4 的官方 wiki 经历了很大改版，之前老 Wiki 中的内容都没了，很可惜，老 wiki 中有很多很棒的内容，所以我部署了 UE4 老 wiki 的站点，作为备份。地址：<a href="https://ue4wiki.imzlp.com/">ue4wiki.imzlp.com</a></p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/21696/20201011095152.webp"></p>
<h2 id="Plugins"><a href="#Plugins" class="headerlink" title="Plugins"></a>Plugins</h2><p>本节介绍我业余开发的 UE 中的一些插件，简单介绍一下它们的功能和解决了什么问题。</p>
<h3 id="HotPatcher"><a href="#HotPatcher" class="headerlink" title="HotPatcher"></a>HotPatcher</h3><p><a href="https://github.com/hxhb/HotPatcher">HotPatcher</a>是我开发的用于 UE4 热更新资源的打包工具，用来管理热更新版本，进行资源的差异分析并打出 pak，支持全平台。</p>
<p>详细的介绍见我之前的文章：<a href="https://imzlp.com/posts/17590/">UE4 资源热更打包工具 HotPatcher</a>，Github 地址：<a href="https://github.com/hxhb/HotPatcher">hxhb/HotPatcher</a><br>以及 UE4 热更新的思路：<a href="https://imzlp.com/posts/17371/">UE4 热更新：需求分析与方案设计</a></p>
<h3 id="ExportNav"><a href="#ExportNav" class="headerlink" title="ExportNav"></a>ExportNav</h3><p><a href="https://github.com/hxhb/ue4-export-nav-data">ue4-export-nav-data</a>是我开发的用于从 UE4 导出 Recast Navigation 寻路数据的插件，可以用在非 DS 架构的服务器中用作地图同步以及寻路计算使用。该插件上架了 <a href="http://unrealengine.com/marketplace"> 虚幻商城 </a>，但是依然在 Github 上开源。<br> 详细的文档介绍见我之前的文章：<a href="https://imzlp.com/posts/20203/">Export Recast Navigation Data from UE4</a></p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/20203/diff-ue-nav-and-recastdemo-nav.webp"></p>
<p>另外，针对外部服务器使用导出的 Recast 数据，我也抽出了 UE 所使用的 recast-detour 版本，可以用在外部服务器的寻路：<a href="https://github.com/hxhb/ue4-recast-detour">ue4-recast-detour</a></p>
<h3 id="ue4-zstd"><a href="#ue4-zstd" class="headerlink" title="ue4-zstd"></a>ue4-zstd</h3><p><a href="https://github.com/hxhb/ue4-zstd">ue4-zstd</a>是我集成到 UE 的 ZSTD 压缩算法，使用 ModularFeature 的方式集成，可以替换引擎中默认的 ZLib 算法，也可以配合 <a href="https://github.com/hxhb/HotPatcher">HotPatcher</a> 使用，替换 pak 的压缩算法。<br>详细的文档见我之前的文章：<a href="https://imzlp.com/posts/8470/">ModularFeature：为 UE4 集成 ZSTD 压缩算法</a></p>
<h3 id="ue4-dtkit"><a href="#ue4-dtkit" class="headerlink" title="ue4-dtkit"></a>ue4-dtkit</h3><p><a href="https://github.com/hxhb/ue4-dtkit">ue4-dtkit</a>是我基于 HTTP 封装了一个下载库，支持 <strong> 边下边存 </strong>/<strong> 边下边计算 MD5</strong>，这样当文件下载完也已经存到本地了，并且还计算出了 MD5 值可以供校验用。还支持暂停 / 继续 / 分片下载，自己改一下也可以改成断点续传的。<br>开源在 Github 上：<a href="https://github.com/hxhb/ue4-dtkit">ue4-dtkit</a>，支持 IOS/Android/Windows/Mac 四个平台。<br>在这个插件中我还封装了一个 <code>MD5Wrapper.hpp</code> 可以用来在其他地方的 MD5 计算，使用的是 <code>OpenSSL</code> 的库。</p>
<h3 id="PlatformUtils"><a href="#PlatformUtils" class="headerlink" title="PlatformUtils"></a>PlatformUtils</h3><p><a href="https://github.com/hxhb/PlatformUtils">PlatformUtils</a>是一个跨平台插件，用于在四个平台（Win/Mac/Android/iOS）获取硬件信息，主要是用作展示 UE 的跨平台写法，如何集成 iOS 的 <code>framework</code> 并使用、Android 添加 Java 代码、使用 JNI 调用等特定平台的原生操作。</p>
<h3 id="unreal-pb"><a href="#unreal-pb" class="headerlink" title="unreal-pb"></a>unreal-pb</h3><p><a href="https://github.com/hxhb/unlua-pb">unlua-pb</a>是集成 <a href="https://github.com/starwing/lua-protobuf">lua-ptorobuf</a> 到<a href="https://github.com/Tencent/UnLua/">UnLua</a>的 Module，之前没有 UnLua 的版本，我做了集成。</p>
<h3 id="debugable-unlua"><a href="#debugable-unlua" class="headerlink" title="debugable-unlua"></a>debugable-unlua</h3><p><a href="https://github.com/hxhb/debugable-unlua">debugable-unlua</a>是 Fork 自 Tencent 的 <a href="https://github.com/Tencent/UnLua/">UnLua</a>，我在其基础上修改，基础版本为<a href="https://github.com/Tencent/UnLua/commit/106fa9c3a1a75b4af0e3e6b7e61b0c45609dd53d">106fa9c</a>，目的是打造一个开箱即用的 UnLua，<strong> 可调试 </strong> 和一些基础 lua 库、编辑器优化。</p>
<h3 id="ue4-git-controller"><a href="#ue4-git-controller" class="headerlink" title="ue4-git-controller"></a>ue4-git-controller</h3><p><a href="https://github.com/hxhb/ue4-git-controller">ue4-git-controller</a>可以在 UE 中操作 Git 仓库，可以用来拓展 UE 的版本控制功能。</p>
<h3 id="ue4-protobuf"><a href="#ue4-protobuf" class="headerlink" title="ue4-protobuf"></a>ue4-protobuf</h3><p><a href="https://github.com/hxhb/ue4-protobuf">ue4-protobuf</a>是以源码方式集成的 protobuf，版本为 3.5.1。</p>
<h3 id="ue4-jwt"><a href="#ue4-jwt" class="headerlink" title="ue4-jwt"></a>ue4-jwt</h3><p><a href="https://github.com/hxhb/ue4-jwt">ue4-jwt</a>在 UE 中集成 JWT 的插件，可以用来跨域认证。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>工具</tag>
        <tag>Plugins</tag>
        <tag>插件</tag>
        <tag>开源</tag>
      </tags>
  </entry>
  <entry>
    <title>UnrealPak</title>
    <url>/wiki/35741/</url>
    <content><![CDATA[<p>UnrealPak 是 UE 的资源打包工具，当进行打包和热更资源时需要把 Cook 后的 uasset 资源打包成一个 pak 文件，供运行时加载。<br>它支持的参数:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Usage:</span><br><span class="line">UnrealPak &lt;PakFilename&gt; -Test</span><br><span class="line">UnrealPak &lt;PakFilename&gt; -List [-ExcludeDeleted]</span><br><span class="line">UnrealPak &lt;PakFilename&gt; &lt;GameUProjectName&gt; &lt;GameFolderName&gt; -ExportDependencies=&lt;OutputFileBase&gt; -NoAssetRegistryCache -ForceDependsGathering</span><br><span class="line">UnrealPak &lt;PakFilename&gt; -Extract &lt;ExtractDir&gt; [-Filter=&lt;filename&gt;]</span><br><span class="line">UnrealPak &lt;PakFilename&gt; -Create=&lt;ResponseFile&gt; [Options]</span><br><span class="line">UnrealPak &lt;PakFilename&gt; -Dest=&lt;MountPoint&gt;</span><br><span class="line">UnrealPak &lt;PakFilename&gt; -Repack [-Output=Path] [-ExcludeDeleted] [Options]</span><br><span class="line">UnrealPak &lt;PakFilename1&gt; &lt;PakFilename2&gt; -diff</span><br><span class="line">UnrealPak &lt;PakFolder&gt; -AuditFiles [-OnlyDeleted] [-CSV=&lt;filename&gt;] [-order=&lt;OrderingFile&gt;] [-SortByOrdering]</span><br><span class="line">UnrealPak &lt;PakFilename&gt; -WhatsAtOffset [offset1] [offset2] [offset3] [...]</span><br><span class="line">UnrealPak &lt;PakFolder&gt; -GeneratePIXMappingFile -OutputPath=&lt;Path&gt;</span><br><span class="line">UnrealPak -TestEncryption</span><br><span class="line">Options:</span><br><span class="line">  -blocksize=&lt;BlockSize&gt;</span><br><span class="line">  -bitwindow=&lt;BitWindow&gt;</span><br><span class="line">  -compress</span><br><span class="line">  -encrypt</span><br><span class="line">  -order=&lt;OrderingFile&gt;</span><br><span class="line">  -diff (requires 2 filenames first)</span><br><span class="line">  -enginedir (specify engine dir for when using ini encryption configs)</span><br><span class="line">  -projectdir (specify project dir for when using ini encryption configs)</span><br><span class="line">  -encryptionini (specify ini base name to gather encryption settings from)</span><br><span class="line">  -extracttomountpoint (Extract to mount point path of pak file)</span><br><span class="line">  -encryptindex (encrypt the pak file index, making it unusable in unrealpak without supplying the key)</span><br><span class="line">  -compressionformat[s]=&lt;Format[,format2,...]&gt; (set the format(s) to compress with, falling back on failures)</span><br></pre></td></tr></table></figure>
<p>直接在编辑器中执行打包的命令(UE4.22.3，这里在指定了加密)：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;D:\UnrealEngine\UE_4.22\Engine\Binaries\Win64\UnrealPak.exe&quot; &quot;C:\Users\Administrator\Documents\Unreal Projects\Mobile422\Saved\StagedBuilds\WindowsNoEditor\Mobile422\Content\Paks\Mobile422-WindowsNoEditor.pak&quot;</span><br><span class="line"> -create=&quot;C:\Users\Administrator\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+Program+Files+Epic+Games+UE_4.22\PakList_Mobile422-WindowsNoEditor.txt&quot;</span><br><span class="line"> -cryptokeys=&quot;C:\Users\Administrator\Documents\Unreal Projects\Mobile422\Saved\Cooked\WindowsNoEditor\Mobile422\Metadata\Crypto.json&quot;</span><br><span class="line"> -order=&quot;C:\Users\Administrator\Documents\Unreal Projects\Mobile422\Build\WindowsNoEditor\FileOpenOrder\CookerOpenOrder.log&quot;</span><br><span class="line"> -encryptindex</span><br><span class="line"> -patchpaddingalign=2048</span><br><span class="line"> -compressionformats=  &quot;C:\Users\Administrator\Documents\Unreal Projects\Mobile422\Mobile422.uproject&quot;</span><br><span class="line"> -multiprocess</span><br><span class="line"> -abslog=&quot;C:\Users\Administrator\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+Program+Files+Epic+Games+UE_4.22\UnrealPak-Mobile422-WindowsNoEditor-2020.02.11-18.48.15.txt&quot;</span><br></pre></td></tr></table></figure>
<p>cryptokeys 指定参数的结构：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;$types&quot;</span>:&#123;</span><br><span class="line">      <span class="attr">&quot;UnrealBuildTool.EncryptionAndSigning+CryptoSettings, UnrealBuildTool, Version=4.0.0.0, Culture=neutral, PublicKeyToken=null&quot;</span>:<span class="string">&quot;1&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;UnrealBuildTool.EncryptionAndSigning+EncryptionKey, UnrealBuildTool, Version=4.0.0.0, Culture=neutral, PublicKeyToken=null&quot;</span>:<span class="string">&quot;2&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;UnrealBuildTool.EncryptionAndSigning+SigningKeyPair, UnrealBuildTool, Version=4.0.0.0, Culture=neutral, PublicKeyToken=null&quot;</span>:<span class="string">&quot;3&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;UnrealBuildTool.EncryptionAndSigning+SigningKey, UnrealBuildTool, Version=4.0.0.0, Culture=neutral, PublicKeyToken=null&quot;</span>:<span class="string">&quot;4&quot;</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">&quot;$type&quot;</span>:<span class="string">&quot;1&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;EncryptionKey&quot;</span>:&#123;</span><br><span class="line">      <span class="attr">&quot;$type&quot;</span>:<span class="string">&quot;2&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Name&quot;</span>:<span class="string">&quot;Embedded&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Guid&quot;</span>:<span class="string">&quot;00000000-0000-0000-0000-000000000000&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Key&quot;</span>:<span class="string">&quot;+c0unLTPVpJ8E2MAs3SrUh/bRHasFOvq1kKXnmZBZcw=&quot;</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">&quot;SigningKey&quot;</span>:&#123;</span><br><span class="line">      <span class="attr">&quot;$type&quot;</span>:<span class="string">&quot;3&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;PublicKey&quot;</span>:&#123;</span><br><span class="line">         <span class="attr">&quot;$type&quot;</span>:<span class="string">&quot;4&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;Exponent&quot;</span>:<span class="string">&quot;AQAB&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;Modulus&quot;</span>:<span class="string">&quot;m48Hq1rQKqljGUBCVku+qxFoa1oVBXghOWKSPArwl9uixba6pxlgqyV/BINWRYQMzgcdKPvGgusRIlalPqEEQB9XibCqJahUpxszoNkhH33cWSpMKZ8XWNmnvAZvtebpqtJYVP1ebqNGvCEm+e54dsxvRJJGmcOB6Wi36/l4c9/+zgNF5BZQItOlDc8OCYlttAvDhgExDow4leNuU/nBh12rcKD4P0KmIYdPzFBYgTe18DyJ12GKf2rStFF9VDlTsp+Gl7ZejPzQ7/CsX0eSHHplsZjjCB6mlmBStFOY7OWMLS/pnYAQ6Ywnaf+tBNz4Fd9eBBxwD0Vn+dU4YDxEJYvZuVkOqyio581jHn5U7rjTofzTyHvy5tzWuYF52R2dGkcTBgjkbmE0Z6nkZ2TdPEog15eZClsHHMseyzhBa3LCC2nmnvZqppV4+Ijj5e1XKEobPOgVZMejXNukW1dzfX9gMf1NrOD2KX2cnyPT6IvP6zu5Cztiy3rVtBiDtQIaQnaCsix8t0+oh5aqzhj6GrblcYs1JX/uy0OYO+hO/yTLET378TehhRjYbnHQsS2PBqBVM6i7hK7xT1TxuUE5oJYJULDWmOn9AZKmnzkx+VyQgmqmNA/L0vJqOhsDvvA29UGNEn5junydqkQlLP4OovlZcoic2R/tYPFcwMKPp68=&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;PrivateKey&quot;</span>:&#123;</span><br><span class="line">         <span class="attr">&quot;$type&quot;</span>:<span class="string">&quot;4&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;Exponent&quot;</span>:<span class="string">&quot;URhnOOSPQp7VG5FxGq2wLQ+k3FJUQEy+GWOYxbk8KKNwtbt/Fy+agBMtuZOuLKmhjWrIpU0+i78rM7cFur3qXI5TUFZ1Jj2eIhxrphoKnu99FmcLEIICtFp0Y/rbyv1RmBSvh9E+kMebvw2KGlVVl8JNhRnyZtdHEoWN7YV+zeSNuGDh8h6pJkN8b15PuXZhQw9RKa3WRsNy/3PCVkNILsOI7L+VZTQ3Zl0q3DghlaHNZlkeyLp/uSnArayUdWlTBq8H0ZtyaAlgBhFNnh/CkQFenpnz2EKSO4aMGo6NkIjbYEYoK5t119z0S56JbzGA71iDqW3VxK5KxZcDLItU8yGp7zi6SPAJXvUxg/8rnXRZ/nm+8KVLwi3Itog8DWYR7zx4weNd2Tx4JvHx+FatLnM3ut6yiUiaW6uL0Zg+yLg1PXy5bEwlAlke/9c/Z7gyY+cLQVMv525LgMQQDje/wNaQT2QosN5Cum+5jPq/0BYB4kXeotvASS2FLRJyo43JjmyfP6oQLOtSNDqbf1jl4JtjoCXBFAZKz6cR4RP1CWst4mMLUJqgOjQeSdd5ihdYZErKPzlLpghQixC/dx3W0ISzkp9b22Ee302bHQHwio+4Gc8B2e/Iabd8TQZuq8LY9BSrllHda8NsG3TFt3hEC+fjdhbz5ur4nd1xgtPtP00=&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;Modulus&quot;</span>:<span class="string">&quot;m48Hq1rQKqljGUBCVku+qxFoa1oVBXghOWKSPArwl9uixba6pxlgqyV/BINWRYQMzgcdKPvGgusRIlalPqEEQB9XibCqJahUpxszoNkhH33cWSpMKZ8XWNmnvAZvtebpqtJYVP1ebqNGvCEm+e54dsxvRJJGmcOB6Wi36/l4c9/+zgNF5BZQItOlDc8OCYlttAvDhgExDow4leNuU/nBh12rcKD4P0KmIYdPzFBYgTe18DyJ12GKf2rStFF9VDlTsp+Gl7ZejPzQ7/CsX0eSHHplsZjjCB6mlmBStFOY7OWMLS/pnYAQ6Ywnaf+tBNz4Fd9eBBxwD0Vn+dU4YDxEJYvZuVkOqyio581jHn5U7rjTofzTyHvy5tzWuYF52R2dGkcTBgjkbmE0Z6nkZ2TdPEog15eZClsHHMseyzhBa3LCC2nmnvZqppV4+Ijj5e1XKEobPOgVZMejXNukW1dzfX9gMf1NrOD2KX2cnyPT6IvP6zu5Cztiy3rVtBiDtQIaQnaCsix8t0+oh5aqzhj6GrblcYs1JX/uy0OYO+hO/yTLET378TehhRjYbnHQsS2PBqBVM6i7hK7xT1TxuUE5oJYJULDWmOn9AZKmnzkx+VyQgmqmNA/L0vJqOhsDvvA29UGNEn5junydqkQlLP4OovlZcoic2R/tYPFcwMKPp68=&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">&quot;bEnablePakSigning&quot;</span>:<span class="literal">true</span>,</span><br><span class="line">   <span class="attr">&quot;bEnablePakIndexEncryption&quot;</span>:<span class="literal">true</span>,</span><br><span class="line">   <span class="attr">&quot;bEnablePakIniEncryption&quot;</span>:<span class="literal">true</span>,</span><br><span class="line">   <span class="attr">&quot;bEnablePakUAssetEncryption&quot;</span>:<span class="literal">true</span>,</span><br><span class="line">   <span class="attr">&quot;bEnablePakFullAssetEncryption&quot;</span>:<span class="literal">true</span>,</span><br><span class="line">   <span class="attr">&quot;bDataCryptoRequired&quot;</span>:<span class="literal">true</span>,</span><br><span class="line">   <span class="attr">&quot;PakEncryptionRequired&quot;</span>:<span class="literal">true</span>,</span><br><span class="line">   <span class="attr">&quot;PakSigningRequired&quot;</span>:<span class="literal">true</span>,</span><br><span class="line">   <span class="attr">&quot;SecondaryEncryptionKeys&quot;</span>:[</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">&quot;$type&quot;</span>:<span class="string">&quot;2&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;Name&quot;</span>:<span class="string">&quot;Key1&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;Guid&quot;</span>:<span class="string">&quot;757096074E55F5FCA962949C55209CCB&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;Key&quot;</span>:<span class="string">&quot;SsukCy4DShNsMi5e9jUpMWJi5qtTA+rLeIoTHRtjM0o=&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它是根据 <code>Project Setting</code>-<code>Crypto</code> 中的设置生成的。</p>
<p>UnrealPak 比较常用的命令组合：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"># 将 COOCKED_ASSET_FOLDER 路径下所有 cookedd 的资源打包到一个 pak 里面，并执行压缩 </span><br><span class="line">unrealpak.exe NEW_PAK_FILE_NAME.pak -create=COOCKED_ASSET_FOLDER -compress</span><br><span class="line"># 加密 pak，需要指定<span class="number">32</span> 位的 AES key，要执行加密 -encrypt/-encrtptindex/-aes 缺一不可。</span><br><span class="line">unrealpak.exe NEW_PAK_FILE_NAME.pak -create=COOCKED_ASSET_FOLDER -compress -encrypt -encryptindex -aes=<span class="number">32B</span>IT_AES_KEY</span><br><span class="line"># 查看 pak 中的资源列表</span><br><span class="line">unrealpak.exe PAK_FILE_NAME.pak -list</span><br><span class="line"># 查看加密的 pak 中的资源列表</span><br><span class="line">unrealpak.exe NEW_PAK_FILE_NAME.pak -list -aes=<span class="number">32B</span>IT_AES_KEY</span><br></pre></td></tr></table></figure>
<p>相关工具：</p>
<ul>
<li><a href="https://www.sojson.com/encrypt_aes.html">AES 的在线加解密工具</a></li>
<li><a href="https://github.com/hxhb/UnrealPakViewer">UnrealPakViewer</a></li>
<li><a href="https://www.gildor.org/en/projects/umodel">umodel</a></li>
</ul>
<p>在 <code>Project Setting</code>-<code>Project</code>-<code>Crypto</code> 中可以选择加密项目并且直接生成<code>EncryptionKey</code>：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/12143/ue-encrypt-project.webp"></p>
<p>UnrealPak 是一个 StandaloneApplication 程序，它的启动代码在：<a href="https://github.com/EpicGames/UnrealEngine/blob/6c20d9831a968ad3cb156442bebb41a883e62152/Engine/Source/Programs/UnrealPak/Private/UnrealPak.cpp">Engine/Source/Programs/UnrealPak/Private/UnrealPak.cpp</a>.<br>但是它只是一个转发函数，真正的实现代码是在引擎中的 <code>ExecuteUnrealPak</code> 函数，其在引擎中的位置为<a href="https://github.com/EpicGames/UnrealEngine/blob/6c20d9831a968ad3cb156442bebb41a883e62152/Engine/Source/Developer/PakFileUtilities/Private/PakFileUtilities.cpp">Engine/Source/Developer/PakFileUtilities/Private/PakFileUtilities.cpp</a></p>
<p>UnrealPak 为 pak 生成 sig:</p>
<blockquote>
<p>注意：在 UE4.23+ 引擎版本中，在指定 <code>cryptokeys</code> 参数时，需要同时指定<code>-sign</code>。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ UnrealPak.exe D:\TEST_SIG.pak -create=<span class="string">&quot;XXXXXXX.txt&quot;</span> -cryptokeys=<span class="string">&quot;Crypto.json&quot;</span></span><br></pre></td></tr></table></figure>
<p>其中 Crypto.json 文件在你使用编辑器打包的时候会生成，它是根据 <code>Project Setting</code>-<code>Crypto</code> 中的设置生成的，保存在路径：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PROJECT_DIRECTORY\Saved\Cooked\WindowsNoEditor\PROJECT_NAME\Metadata\Crypto.json</span><br></pre></td></tr></table></figure>
<p>注意 <code>PROJECT_DIRECTORY</code> 和<code>PROJECT_NAME</code>都换成你自己的。</p>
<p><code>Crypto.json</code>这个文件的生成是在 <code>AutomationTool</code> 这个工具里面的，相关的代码在：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Source\Programs\AutomationTool\Scripts\CopyBuildToStagingDirectory.Automation.cs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Creates a pak file using staging context (single manifest)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Params&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;SC&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CreatePakUsingStagingManifest</span>(<span class="params">ProjectParams Params, DeploymentContext SC</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  LogInformation(<span class="string">&quot;Creating pak using staging manifest.&quot;</span>);</span><br><span class="line"></span><br><span class="line">  DumpManifest(SC, CombinePaths(CmdEnv.LogFolder, <span class="string">&quot;PrePak&quot;</span> + (SC.DedicatedServer ? <span class="string">&quot;_Server&quot;</span> : <span class="string">&quot;&quot;</span>)));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> UnrealPakResponseFile = CreatePakResponseFileFromStagingManifest(SC, SC.FilesToStage.UFSFiles);</span><br><span class="line"></span><br><span class="line">  List&lt;PakFileRules&gt; PakRulesList = GetPakFileRules(Params, SC);</span><br><span class="line"></span><br><span class="line">  List&lt;<span class="built_in">string</span>&gt; PakList = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">  List&lt;<span class="built_in">string</span>&gt; FilesToRemove = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Apply the pak file rules, this can remove things but will not override the pak file name</span></span><br><span class="line">  <span class="keyword">foreach</span> (<span class="keyword">var</span> StagingFile <span class="keyword">in</span> UnrealPakResponseFile)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">bool</span> bExcludeFromPaks = <span class="literal">false</span>;</span><br><span class="line">    ApplyPakFileRules(PakRulesList, StagingFile, PakList, <span class="keyword">out</span> bExcludeFromPaks);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bExcludeFromPaks)</span><br><span class="line">    &#123;</span><br><span class="line">      FilesToRemove.Add(StagingFile.Key);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">foreach</span> (<span class="keyword">var</span> FileToRemove <span class="keyword">in</span> FilesToRemove)</span><br><span class="line">  &#123;</span><br><span class="line">    UnrealPakResponseFile.Remove(FileToRemove);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  EncryptionAndSigning.CryptoSettings PakCryptoSettings = EncryptionAndSigning.ParseCryptoSettings(DirectoryReference.FromFile(Params.RawProjectPath), SC.StageTargetPlatform.IniPlatformType);</span><br><span class="line">  FileReference CryptoKeysCacheFilename = FileReference.Combine(SC.MetadataDir, <span class="string">&quot;Crypto.json&quot;</span>);</span><br><span class="line">  PakCryptoSettings.Save(CryptoKeysCacheFilename);</span><br><span class="line"></span><br><span class="line">  List&lt;CreatePakParams&gt; PakInputs = <span class="keyword">new</span> List&lt;CreatePakParams&gt;();</span><br><span class="line">  PakInputs.Add(<span class="keyword">new</span> CreatePakParams(SC.ShortProjectName, UnrealPakResponseFile, Params.Compressed, <span class="literal">null</span>));</span><br><span class="line">  CreatePaks(Params, SC, PakInputs, PakCryptoSettings, CryptoKeysCacheFilename);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>EncryptionAndSigning</code>这个类是定义在<code>UnrealBuildTool\System\EncryptionAndSigning</code>，在里面可以看到对 DefaultCrypto.ini 文件的解析。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>工具</tag>
        <tag>Tools</tag>
        <tag>UnrealPak</tag>
        <tag>打包</tag>
      </tags>
  </entry>
  <entry>
    <title>UnrealPak 的加密参数</title>
    <url>/wiki/8d44a949/</url>
    <content><![CDATA[<p>UnrealPak 支持的命令行参数：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">LogPakFile: Display: Using command line for crypto configuration</span><br><span class="line">LogPakFile: Error: No pak file name specified. Usage:</span><br><span class="line">LogPakFile: Error:   UnrealPak &lt;PakFilename&gt; -Test</span><br><span class="line">LogPakFile: Error:   UnrealPak &lt;PakFilename&gt; -List [-ExcludeDeleted]</span><br><span class="line">LogPakFile: Error:   UnrealPak &lt;PakFilename&gt; &lt;GameUProjectName&gt; &lt;GameFolderName&gt; -ExportDependencies=&lt;OutputFileBase&gt; -NoAssetRegistryCache -ForceDependsGathering</span><br><span class="line">LogPakFile: Error:   UnrealPak &lt;PakFilename&gt; -Extract &lt;ExtractDir&gt; [-Filter=&lt;filename&gt;]</span><br><span class="line">LogPakFile: Error:   UnrealPak &lt;PakFilename&gt; -Create=&lt;ResponseFile&gt; [Options]</span><br><span class="line">LogPakFile: Error:   UnrealPak &lt;PakFilename&gt; -Dest=&lt;MountPoint&gt;</span><br><span class="line">LogPakFile: Error:   UnrealPak &lt;PakFilename&gt; -Repack [-Output=Path] [-ExcludeDeleted] [Options]</span><br><span class="line">LogPakFile: Error:   UnrealPak &lt;PakFilename1&gt; &lt;PakFilename2&gt; -diff</span><br><span class="line">LogPakFile: Error:   UnrealPak &lt;PakFolder&gt; -AuditFiles [-OnlyDeleted] [-CSV=&lt;filename&gt;] [-order=&lt;OrderingFile&gt;] [-SortByOrdering]</span><br><span class="line">LogPakFile: Error:   UnrealPak &lt;PakFilename&gt; -WhatsAtOffset [offset1] [offset2] [offset3] [...]</span><br><span class="line">LogPakFile: Error:   UnrealPak &lt;PakFolder&gt; -GeneratePIXMappingFile -OutputPath=&lt;Path&gt;</span><br><span class="line">LogPakFile: Error:   Options:</span><br><span class="line">LogPakFile: Error:     -blocksize=&lt;BlockSize&gt;</span><br><span class="line">LogPakFile: Error:     -bitwindow=&lt;BitWindow&gt;</span><br><span class="line">LogPakFile: Error:     -compress</span><br><span class="line">LogPakFile: Error:     -encrypt</span><br><span class="line">LogPakFile: Error:     -order=&lt;OrderingFile&gt;</span><br><span class="line">LogPakFile: Error:     -diff (requires 2 filenames first)</span><br><span class="line">LogPakFile: Error:     -enginedir (specify engine dir for when using ini encryption configs)</span><br><span class="line">LogPakFile: Error:     -projectdir (specify project dir for when using ini encryption configs)</span><br><span class="line">LogPakFile: Error:     -encryptionini (specify ini base name to gather encryption settings from)</span><br><span class="line">LogPakFile: Error:     -extracttomountpoint (Extract to mount point path of pak file)</span><br><span class="line">LogPakFile: Error:     -encryptindex (encrypt the pak file index, making it unusable in unrealpak without supplying the key)</span><br><span class="line">LogPakFile: Error:     -compressionformat[s]=&lt;Format[,format2,...]&gt; (set the format(s) to compress with, falling back on failures)</span><br><span class="line">LogPakFile: Error:     -encryptionkeyoverrideguid (override the encryption key guid used for encrypting data in this pak file)</span><br><span class="line">LogPakFile: Error:     -sign (generate a signature (.sig) file alongside the pak)</span><br><span class="line">LogPakFile: Error:     -fallbackOrderForNonUassetFiles (if order is not specified for ubulk/uexp files, figure out implicit order based on the uasset order. Generally applies only to the cooker order)</span><br><span class="line">LogPakFile: Display: Unreal pak executed in 0.006367 seconds</span><br></pre></td></tr></table></figure>
<p>关于包的加密，在 <code>Project Settings</code>-<code>Crypto</code> 中有四个选项：</p>
<ul>
<li><code>bEnablePakIndexEncryption</code>: 加密 Pakindex</li>
<li><code>bEnablePakIniEncryption</code>：加密 pak 中的 ini</li>
<li><code>bEnablePakUAssetEncryption</code>：加密 pak 中的 uasset</li>
<li><code>bEnablePakFullAssetEncryption</code>：加密 Pak 中所有的文件</li>
</ul>
<p>但是除了 <code>bEnablePakIndexEncryption</code> 之外，其他的参数并不是传递给 UnrealPak 的命令行参数，而是生成的 Paklist 中每个文件的参数：</p>
<ul>
<li><a href="https://github.com/EpicGames/UnrealEngine/blob/9e0f5f2a419a75b83392c44bf75462366ca8c1e2/Engine/Source/Programs/AutomationTool/Scripts/CopyBuildToStagingDirectory.Automation.cs#L154">CopyBuildToStagingDirectory.Automation.cs#L154</a></li>
</ul>
<p>对 paklist 中的对应格式文件添加 <code>-encrypt</code> 参数。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;C:\Users\lipengzha\Documents\UnrealProjects\Blank425\Saved\Cooked\WindowsNoEditor\Engine\Content\EngineResources\GradientTexture0.uasset&quot; &quot;../../../Engine/Content/EngineResources/GradientTexture0.uasset&quot; -encrypt</span><br><span class="line">&quot;C:\Users\lipengzha\Documents\UnrealProjects\Blank425\Saved\Cooked\WindowsNoEditor\Engine\Content\EngineResources\GradientTexture0.uexp&quot; &quot;../../../Engine/Content/EngineResources/GradientTexture0.uexp&quot; -encrypt</span><br><span class="line">&quot;C:\Users\lipengzha\Documents\UnrealProjects\Blank425\Saved\Temp\Win64\Engine\Config\Base.ini&quot; &quot;../../../Engine/Config/Base.ini&quot; -encrypt</span><br><span class="line">&quot;C:\Users\lipengzha\Documents\UnrealProjects\Blank425\Saved\Temp\Win64\Engine\Config\BaseCompat.ini&quot; &quot;../../../Engine/Config/BaseCompat.ini&quot; -encrypt</span><br><span class="line">&quot;C:\Users\lipengzha\Documents\UnrealProjects\Blank425\Intermediate\Staging\Blank425.upluginmanifest&quot; &quot;../../../Blank425/Plugins/Blank425.upluginmanifest&quot; -encrypt</span><br></pre></td></tr></table></figure>
<p>当开启了 <code>bEnablePakIniEncryption</code>，就会对当前 Paklist 中的 ini 文件添加<code>-encrypt</code> 参数。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>工具</category>
        <category>UnrealPak</category>
      </categories>
      <tags>
        <tag>工具</tag>
        <tag>UnrealPak</tag>
        <tag>加密</tag>
      </tags>
  </entry>
  <entry>
    <title>UnrealVersionSelector</title>
    <url>/wiki/15353/</url>
    <content><![CDATA[<p><code>UnrealVersionSelector</code>是 UE 的一个工具，用来关联 <code>uproject</code> 文件、注册引擎、选择引擎版本、生成解决方案等功能的一个工具。<br>在对 <code>uproject</code> 文件点击右键时，<code>Switch Unreal Engine Version</code>等选项就是 UnrealVersionSelector 提供的：<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210708123617.webp"></p>
<h3 id="UnrealVersionSelector 的参数"><a href="#UnrealVersionSelector 的参数" class="headerlink" title="UnrealVersionSelector 的参数"></a>UnrealVersionSelector 的参数</h3><ul>
<li><code>-register</code>：Add the current directory to the list of installations</li>
<li><code>-fileassociations</code>：Update all the settings.</li>
<li><code>-switchversion</code>：Associate with an engine label</li>
<li><code>-switchversionsilent</code>：Associate with a specific engine label</li>
<li><code>-editor</code>：Open a project with the editor</li>
<li><code>-projectlist</code>：Open the editor</li>
<li><code>-game</code>：Play a game using the editor executable</li>
<li><code>-projectfiles</code>：Generate Visual Studio project files</li>
</ul>
<h3 id="注册 UnrealVersionSelector"><a href="# 注册 UnrealVersionSelector" class="headerlink" title="注册 UnrealVersionSelector"></a>注册 UnrealVersionSelector</h3><p>如果遇到 <code>uproject</code> 没有文件关联的情况可以使用下列注册表修复文件关联。</p>
<p>保存为<code>.reg</code>，双击合并即可。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Windows Registry Editor Version 5.00</span><br><span class="line"></span><br><span class="line">[HKEY_CLASSES_ROOT\.uproject]</span><br><span class="line">@=&quot;Unreal.ProjectFile&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_CLASSES_ROOT\Unreal.ProjectFile]</span><br><span class="line">@=&quot;Unreal Engine Project File&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_CLASSES_ROOT\Unreal.ProjectFile\DefaultIcon]</span><br><span class="line">@=&quot;\&quot;C:\\Program Files (x86)\\Epic Games\\Launcher\\Engine\\Binaries\\Win64\\UnrealVersionSelector.exe\&quot;&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_CLASSES_ROOT\Unreal.ProjectFile\shell]</span><br><span class="line"></span><br><span class="line">[HKEY_CLASSES_ROOT\Unreal.ProjectFile\shell\open]</span><br><span class="line">@=&quot;Open&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_CLASSES_ROOT\Unreal.ProjectFile\shell\open\command]</span><br><span class="line">@=&quot;\&quot;C:\\Program Files (x86)\\Epic Games\\Launcher\\Engine\\Binaries\\Win64\\UnrealVersionSelector.exe\&quot; /editor \&quot;%1\&quot;&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_CLASSES_ROOT\Unreal.ProjectFile\shell\run]</span><br><span class="line">@=&quot;Launch game&quot;</span><br><span class="line">&quot;Icon&quot;=&quot;\&quot;C:\\Program Files (x86)\\Epic Games\\Launcher\\Engine\\Binaries\\Win64\\UnrealVersionSelector.exe\&quot;&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_CLASSES_ROOT\Unreal.ProjectFile\shell\run\command]</span><br><span class="line">@=&quot;\&quot;C:\\Program Files (x86)\\Epic Games\\Launcher\\Engine\\Binaries\\Win64\\UnrealVersionSelector.exe\&quot; /game \&quot;%1\&quot;&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_CLASSES_ROOT\Unreal.ProjectFile\shell\rungenproj]</span><br><span class="line">@=&quot;Generate Visual Studio project files&quot;</span><br><span class="line">&quot;Icon&quot;=&quot;\&quot;C:\\Program Files (x86)\\Epic Games\\Launcher\\Engine\\Binaries\\Win64\\UnrealVersionSelector.exe\&quot;&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_CLASSES_ROOT\Unreal.ProjectFile\shell\rungenproj\command]</span><br><span class="line">@=&quot;\&quot;C:\\Program Files (x86)\\Epic Games\\Launcher\\Engine\\Binaries\\Win64\\UnrealVersionSelector.exe\&quot; /projectfiles \&quot;%1\&quot;&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_CLASSES_ROOT\Unreal.ProjectFile\shell\switchversion]</span><br><span class="line">@=&quot;Switch Unreal Engine version...&quot;</span><br><span class="line">&quot;Icon&quot;=&quot;\&quot;C:\\Program Files (x86)\\Epic Games\\Launcher\\Engine\\Binaries\\Win64\\UnrealVersionSelector.exe\&quot;&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_CLASSES_ROOT\Unreal.ProjectFile\shell\switchversion\command]</span><br><span class="line">@=&quot;\&quot;C:\\Program Files (x86)\\Epic Games\\Launcher\\Engine\\Binaries\\Win64\\UnrealVersionSelector.exe\&quot; /switchversion \&quot;%1\&quot;&quot;</span><br></pre></td></tr></table></figure>


<h3 id="获取所有已注册的引擎"><a href="# 获取所有已注册的引擎" class="headerlink" title="获取所有已注册的引擎"></a>获取所有已注册的引擎 </h3><p> 可以使用 <code>IDesktopPlatform::EnumerateEngineInstallations</code> 来获取当前系统中所有从启动器安装、以及用户使用 <code>UnrealVersionSelector</code> 注册的引擎版本。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">TMap&lt;FString,FString&gt; Installations;</span><br><span class="line">FDesktopPlatformModule::<span class="built_in">Get</span>()-&gt;<span class="built_in">EnumerateEngineInstallations</span>(Installations)</span><br></pre></td></tr></table></figure>

<h3 id="注册引擎"><a href="# 注册引擎" class="headerlink" title="注册引擎"></a>注册引擎 </h3><p> 使用 UnrealVersionSelector 注册引擎时，会将注册的引擎路径写入到注册表：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HKEY_CURRENT_USER\SOFTWARE\Epic Games\Unreal Engine\Builds</span><br></pre></td></tr></table></figure>
<p>其注册表项的 <code>lpValueName</code> 则是生成的一个 GUID：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// DesktopPlatfromWindows.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FDesktopPlatformWindows::RegisterEngineInstallation</span><span class="params">(<span class="keyword">const</span> FString &amp;RootDir, FString &amp;OutIdentifier)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">bool</span> bRes = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">IsValidRootDirectory</span>(RootDir))</span><br><span class="line">  &#123;</span><br><span class="line">    HKEY hRootKey;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">RegCreateKeyEx</span>(HKEY_CURRENT_USER, InstallationsSubKey, <span class="number">0</span>, <span class="literal">NULL</span>, REG_OPTION_NON_VOLATILE, KEY_ALL_ACCESS, <span class="literal">NULL</span>, &amp;hRootKey, <span class="literal">NULL</span>) == ERROR_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">      FString NewIdentifier = FGuid::<span class="built_in">NewGuid</span>().<span class="built_in">ToString</span>(EGuidFormats::DigitsWithHyphensInBraces);</span><br><span class="line">      LRESULT SetResult = <span class="built_in">RegSetValueEx</span>(hRootKey, *NewIdentifier, <span class="number">0</span>, REG_SZ, (<span class="keyword">const</span> BYTE*)*RootDir, (RootDir.<span class="built_in">Len</span>() + <span class="number">1</span>) * <span class="built_in"><span class="keyword">sizeof</span></span>(TCHAR));</span><br><span class="line">      <span class="built_in">RegCloseKey</span>(hRootKey);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(SetResult == ERROR_SUCCESS)</span><br><span class="line">      &#123;</span><br><span class="line">        OutIdentifier = NewIdentifier;</span><br><span class="line">        bRes = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> bRes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UE 并没有直接在 <code>IDesktopPlatfrom</code> 中<strong>单独提供 </strong> 获取用户通过使用 UnrealVersionSelector 注册的引擎列表。<br>但是在 <code>EnumerateEngineInstallations</code> 中写了从注册表获取 <code>per-user installations</code> 引擎：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FDesktopPlatformWindows::EnumerateEngineInstallations</span><span class="params">(TMap&lt;FString, FString&gt; &amp;OutInstallations)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// Enumerate the binary installations</span></span><br><span class="line">  <span class="built_in">EnumerateLauncherEngineInstallations</span>(OutInstallations);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Enumerate the per-user installations</span></span><br><span class="line">  HKEY hKey;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">RegOpenKeyEx</span>(HKEY_CURRENT_USER, InstallationsSubKey, <span class="number">0</span>, KEY_ALL_ACCESS, &amp;hKey) == ERROR_SUCCESS)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Get a list of all the directories</span></span><br><span class="line">    TArray&lt;FString&gt; UniqueDirectories;</span><br><span class="line">    OutInstallations.<span class="built_in">GenerateValueArray</span>(UniqueDirectories);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enumerate all the installations</span></span><br><span class="line">    TArray&lt;FString&gt; InvalidKeys;</span><br><span class="line">    <span class="keyword">for</span> (::DWORD Index = <span class="number">0</span>;; Index++)</span><br><span class="line">    &#123;</span><br><span class="line">      TCHAR ValueName[<span class="number">256</span>];</span><br><span class="line">      TCHAR ValueData[MAX_PATH];</span><br><span class="line">      ::DWORD ValueType = <span class="number">0</span>;</span><br><span class="line">      ::DWORD ValueNameLength = <span class="built_in"><span class="keyword">sizeof</span></span>(ValueName) / <span class="built_in"><span class="keyword">sizeof</span></span>(ValueName[<span class="number">0</span>]);</span><br><span class="line">      ::DWORD ValueDataSize = <span class="built_in"><span class="keyword">sizeof</span></span>(ValueData);</span><br><span class="line"></span><br><span class="line">      LRESULT Result = <span class="built_in">RegEnumValue</span>(hKey, Index, ValueName, &amp;ValueNameLength, <span class="literal">NULL</span>, &amp;ValueType, (BYTE*)&amp;ValueData[<span class="number">0</span>], &amp;ValueDataSize);</span><br><span class="line">      <span class="keyword">if</span>(Result == ERROR_SUCCESS)</span><br><span class="line">      &#123;</span><br><span class="line">        int32 ValueDataLength = ValueDataSize / <span class="built_in"><span class="keyword">sizeof</span></span>(TCHAR);</span><br><span class="line">        <span class="keyword">if</span>(ValueDataLength &gt; <span class="number">0</span> &amp;&amp; ValueData[ValueDataLength - <span class="number">1</span>] == <span class="number">0</span>) ValueDataLength--;</span><br><span class="line"></span><br><span class="line">        <span class="function">FString <span class="title">NormalizedInstalledDirectory</span><span class="params">(ValueDataLength, ValueData)</span></span>;</span><br><span class="line">        FPaths::<span class="built_in">NormalizeDirectoryName</span>(NormalizedInstalledDirectory);</span><br><span class="line">        FPaths::<span class="built_in">CollapseRelativeDirectories</span>(NormalizedInstalledDirectory);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">IsValidRootDirectory</span>(NormalizedInstalledDirectory) &amp;&amp; !UniqueDirectories.<span class="built_in">Contains</span>(NormalizedInstalledDirectory))</span><br><span class="line">        &#123;</span><br><span class="line">          OutInstallations.<span class="built_in">Add</span>(ValueName, NormalizedInstalledDirectory);</span><br><span class="line">          UniqueDirectories.<span class="built_in">Add</span>(NormalizedInstalledDirectory);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          InvalidKeys.<span class="built_in">Add</span>(ValueName);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span>(Result == ERROR_NO_MORE_ITEMS)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove all the keys which weren&#x27;t valid</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">const</span> FString InvalidKey: InvalidKeys)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">RegDeleteValue</span>(hKey, *InvalidKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">RegCloseKey</span>(hKey);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Launcher 版引擎注册表路径"><a href="#Launcher 版引擎注册表路径" class="headerlink" title="Launcher 版引擎注册表路径"></a>Launcher 版引擎注册表路径 </h3><p> 上面提到，如果非源码版引擎，使用 UnrealVersionSelector 注册时会写入到注册表：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HKEY_CURRENT_USER\SOFTWARE\Epic Games\Unreal Engine\Builds</span><br></pre></td></tr></table></figure>
<p>从 EpicGameLauncher 安装的版本则会写入到另一个注册表路径下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\EpicGames\Unreal Engine</span><br></pre></td></tr></table></figure>
<p>其值为(从注册表导出的)：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Windows Registry Editor Version 5.00</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\EpicGames\Unreal Engine\4.18]</span><br><span class="line">&quot;InstalledDirectory&quot;=&quot;C:\\Program Files\\Epic Games\\UE_4.18&quot;</span><br></pre></td></tr></table></figure>

<p>UE 提供了方法来得到从 EpicGameLauncher 安装的引擎 (通过<code>IDesktopPlatfrom</code> 接口)：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">TMap&lt;FString,FString&gt; Installations;</span><br><span class="line">FDesktopPlatformModule::<span class="built_in">Get</span>()-&gt;<span class="built_in">EnumerateLauncherEngineInstallations</span>(OutInstallations);</span><br></pre></td></tr></table></figure>

<h3 id="注册编译版引擎的安装路径"><a href="# 注册编译版引擎的安装路径" class="headerlink" title="注册编译版引擎的安装路径"></a>注册编译版引擎的安装路径 </h3><p>UE 提供了<code>UnrealVersionSelector</code> 工具用来选择引擎版本 / 生成 sln 等功能，其也可以用来注册本地的引擎 (非 Launcher 安装的引擎，如自己编译的源码版引擎) 到项目文件的右键 <code>Select Unreal Engine Version...</code> 列表中。<br>简单分析了一下 <code>UnrealVersionSelector</code> 的代码，它的注册流程如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">WinMain_Func=&gt;start: WinMain</span><br><span class="line">Main_Func=&gt;operation: Main(Arguments)</span><br><span class="line">RegisterCurrentEngineDirectoryWithPrompt_Func=&gt;operation: RegisterCurrentEngineDirectoryWithPrompt()</span><br><span class="line">RegisterCurrentEngineDirectory_Func=&gt;operation: RegisterCurrentEngineDirectory(false)</span><br><span class="line">GetEngineIdentifierFromRootDir_Func=&gt;operation: FDesktopPlatformModule::Get()-&gt;GetEngineIdentifierFromRootDir(EngineRootDir, Identifier)</span><br><span class="line">RegisterEngineInstallation_Func=&gt;operation: RegisterEngineInstallation(RootDir, OutIdentifier)</span><br><span class="line">end=&gt;end: End</span><br><span class="line"></span><br><span class="line">WinMain_Func-&gt;Main_Func</span><br><span class="line">Main_Func-&gt;RegisterCurrentEngineDirectoryWithPrompt_Func</span><br><span class="line">RegisterCurrentEngineDirectoryWithPrompt_Func-&gt;RegisterCurrentEngineDirectory_Func</span><br><span class="line">RegisterCurrentEngineDirectory_Func-&gt;GetEngineIdentifierFromRootDir_Func</span><br><span class="line">GetEngineIdentifierFromRootDir_Func-&gt;RegisterEngineInstallation_Func</span><br><span class="line">RegisterEngineInstallation_Func-&gt;end</span><br></pre></td></tr></table></figure>
<p>向注册表写入的操作在 <code>FDesktopPlatformWindows::RegisterEngineInstallation</code> 这个函数中。<br>操作为将注册的引擎目录写入到 <code>HKEY_CURRENT_USER\Software\Epic Games\Unreal Engine\Builds</code> 中的字符串项中。<br>当右键 <code>Switch Unreal Engine Version...</code> 的时候，会修改 <code>.uproject</code> 文件中的 <code>EngineAssociation</code> 值：</p>
<p>其调用流如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">WinMain_Func=&gt;start: WinMain</span><br><span class="line">Main_Func=&gt;operation: Main(Arguments)</span><br><span class="line">SwitchVersion_Func=&gt;operation: SwitchVersion(const FString&amp; ProjectFileName)</span><br><span class="line">GetEngineIdentifierForProject_fUNC=&gt;operation: FDesktopPlatformModule::Get()-&gt;GetEngineIdentifierForProject(ProjectFileName, Identifier) // 获取当前选择的引擎</span><br><span class="line">SelectEngineInstallation_Func=&gt;operation: FPlatformInstallation::SelectEngineInstallation(Identifier) // 弹出选择引擎列表框，当前选择的为默认</span><br><span class="line">SetEngineIdentifierForProject_func=&gt;operation: FDesktopPlatformModule::Get()-&gt;SetEngineIdentifierForProject(ProjectFileName, Identifier) // 设置选择的引擎，并写入 uproject 文件</span><br><span class="line">ContentOnly=&gt;condition: Is Content Only Project?</span><br><span class="line">GenerateProjectFiles_func=&gt;operation: GenerateProjectFiles(ProjectFileName)</span><br><span class="line">end=&gt;end: End</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">WinMain_Func-&gt;Main_Func</span><br><span class="line">Main_Func-&gt;SwitchVersion_Func</span><br><span class="line">SwitchVersion_Func-&gt;GetEngineIdentifierForProject_fUNC</span><br><span class="line">GetEngineIdentifierForProject_fUNC-&gt;SelectEngineInstallation_Func</span><br><span class="line">SelectEngineInstallation_Func-&gt;SetEngineIdentifierForProject_func</span><br><span class="line">SetEngineIdentifierForProject_func-&gt;ContentOnly</span><br><span class="line">ContentOnly(yes)-&gt;end</span><br><span class="line">ContentOnly(no)-&gt;GenerateProjectFiles_func</span><br><span class="line">GenerateProjectFiles_func-&gt;end</span><br></pre></td></tr></table></figure>
<p>执行项目文件写入的操作在 <code>FDesktopPlatformBase::SetEngineIdentifierForProject</code> 中：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FDesktopPlatformBase::SetEngineIdentifierForProject</span><span class="params">(<span class="keyword">const</span> FString &amp;ProjectFileName, <span class="keyword">const</span> FString &amp;InIdentifier)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// Load the project file</span></span><br><span class="line">  TSharedPtr&lt;FJsonObject&gt; ProjectFile = <span class="built_in">LoadProjectFile</span>(ProjectFileName);</span><br><span class="line">  <span class="keyword">if</span> (!ProjectFile.<span class="built_in">IsValid</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if the project is a non-foreign project of the given engine installation. If so, blank the identifier </span></span><br><span class="line">  <span class="comment">// string to allow portability between source control databases. GetEngineIdentifierForProject will translate</span></span><br><span class="line">  <span class="comment">// the association back into a local identifier on other machines or syncs.</span></span><br><span class="line">  FString Identifier = InIdentifier;</span><br><span class="line">  <span class="keyword">if</span>(Identifier.<span class="built_in">Len</span>() &gt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    FString RootDir;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">GetEngineRootDirFromIdentifier</span>(Identifier, RootDir))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">const</span> FUProjectDictionary &amp;Dictionary = <span class="built_in">GetCachedProjectDictionary</span>(RootDir);</span><br><span class="line">      <span class="keyword">if</span>(!Dictionary.<span class="built_in">IsForeignProject</span>(ProjectFileName))</span><br><span class="line">      &#123;</span><br><span class="line">        Identifier.<span class="built_in">Empty</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set the association on the project and save it</span></span><br><span class="line">  ProjectFile-&gt;<span class="built_in">SetStringField</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;EngineAssociation&quot;</span>), Identifier);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">SaveProjectFile</span>(ProjectFileName, ProjectFile);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以如果你选择了一个项目使用编译版引擎，可以使用文本编辑器打开该项目的 <code>.uproject</code> 文件，可以看到其中的 <code>EngineAssociation</code> 项的值就是注册表中的引擎版本值。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/3380/Unreal-Select-Engine-Version.webp"></p>
<p>注：<a href="https://github.com/EpicGames/UnrealEngine/blob/4.18/Engine/Source/Programs/UnrealVersionSelector/">UnrealVersionSelector</a>所支持的命令行参数及其用途在<a href="https://github.com/EpicGames/UnrealEngine/blob/4.18/Engine/Source/Programs/UnrealVersionSelector/Private/UnrealVersionSelector.cpp#L224">UnrealVersionSelector.cpp#L224</a>:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Main</span><span class="params">(<span class="keyword">const</span> TArray&lt;FString&gt;&amp; Arguments)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">bool</span> bRes = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (Arguments.<span class="built_in">Num</span>() == <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Add the current directory to the list of installations</span></span><br><span class="line">    bRes = <span class="built_in">RegisterCurrentEngineDirectoryWithPrompt</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (Arguments.<span class="built_in">Num</span>() == <span class="number">1</span> &amp;&amp; Arguments[<span class="number">0</span>] == <span class="built_in">TEXT</span>(<span class="string">&quot;-register&quot;</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Add the current directory to the list of installations</span></span><br><span class="line">    bRes = <span class="built_in">RegisterCurrentEngineDirectory</span>(<span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (Arguments.<span class="built_in">Num</span>() == <span class="number">1</span> &amp;&amp; Arguments[<span class="number">0</span>] == <span class="built_in">TEXT</span>(<span class="string">&quot;-fileassociations&quot;</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Update all the settings.</span></span><br><span class="line">    bRes = <span class="built_in">UpdateFileAssociations</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (Arguments.<span class="built_in">Num</span>() == <span class="number">2</span> &amp;&amp; Arguments[<span class="number">0</span>] == <span class="built_in">TEXT</span>(<span class="string">&quot;-switchversion&quot;</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Associate with an engine label</span></span><br><span class="line">    bRes = <span class="built_in">SwitchVersion</span>(Arguments[<span class="number">1</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (Arguments.<span class="built_in">Num</span>() == <span class="number">3</span> &amp;&amp; Arguments[<span class="number">0</span>] == <span class="built_in">TEXT</span>(<span class="string">&quot;-switchversionsilent&quot;</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Associate with a specific engine label</span></span><br><span class="line">    bRes = <span class="built_in">SwitchVersionSilent</span>(Arguments[<span class="number">1</span>], Arguments[<span class="number">2</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (Arguments.<span class="built_in">Num</span>() == <span class="number">2</span> &amp;&amp; Arguments[<span class="number">0</span>] == <span class="built_in">TEXT</span>(<span class="string">&quot;-editor&quot;</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Open a project with the editor</span></span><br><span class="line">    bRes = <span class="built_in">LaunchEditor</span>(Arguments[<span class="number">1</span>], <span class="string">L&quot;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (Arguments.<span class="built_in">Num</span>() == <span class="number">2</span> &amp;&amp; Arguments[<span class="number">0</span>] == <span class="built_in">TEXT</span>(<span class="string">&quot;-game&quot;</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Play a game using the editor executable</span></span><br><span class="line">    bRes = <span class="built_in">LaunchEditor</span>(Arguments[<span class="number">1</span>], <span class="string">L&quot;-game&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (Arguments.<span class="built_in">Num</span>() == <span class="number">2</span> &amp;&amp; Arguments[<span class="number">0</span>] == <span class="built_in">TEXT</span>(<span class="string">&quot;-projectfiles&quot;</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Generate Visual Studio project files</span></span><br><span class="line">    bRes = <span class="built_in">GenerateProjectFiles</span>(Arguments[<span class="number">1</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Invalid command line</span></span><br><span class="line">    FPlatformMisc::<span class="built_in">MessageBoxExt</span>(EAppMsgType::Ok, <span class="built_in">TEXT</span>(<span class="string">&quot;Invalid command line&quot;</span>), <span class="literal">NULL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> bRes ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="解决 -uproject 右键生成失败"><a href="# 解决 -uproject 右键生成失败" class="headerlink" title="解决.uproject 右键生成失败"></a>解决.uproject 右键生成失败 </h3><p> 首先要查看右键菜单所使用的 <code>UnrealVersionSelector.exe</code> 的路径，可以打开注册表:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HKEY_CLASSES_ROOT\Unreal.ProjectFile</span><br></pre></td></tr></table></figure>
<p>然后找到 <code>shell\open\command</code> 条目查看 <code>UnrealVersionSelector.exe</code> 的位置(如果没有安装过源码版引擎则默认在 EpicGamesLauncher 的 Binaries 路径下)，如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;C:\Program Files (x86)\Epic Games\Launcher\Engine\Binaries\Win64\UnrealVersionSelector.exe&quot; /editor &quot;%1&quot;</span><br></pre></td></tr></table></figure>
<p>然后打开 <code>C:\Program Files (x86)\Epic Games\Launcher\Engine\Binaries\Win64</code>，将<code>UnrealVersionSelector.exe</code> 设置为以管理员权限启动即可(右键 - 属性 - 兼容性 - 以管理员身份运行此程序)。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>工具</category>
      </categories>
  </entry>
  <entry>
    <title>ue4program</title>
    <url>/wiki/10027/</url>
    <content><![CDATA[<p>UE 的很多工具链，是基于 UE 自身的功能编译出来的程序，如 UnrealPak、UnrealFrontEnd、UnrealVersionSelector 等，它们都是 <code>Target</code> 为<code>Program</code>的类型的工程。<br>但是 UE 本身并没有提供创建这种工程的方法，所以我写了一个创建工具，能够方便地创建 Standalone Application 的模板工程，能够把 UE 当作一个大号的第三方库开发命令行合作或 GUI 程序。</p>
<p>首先，<a href="https://github.com/hxhb/ue4program/releases">下载 </a> 我写的<a href="https://github.com/hxhb/ue4program">hxhb/ue4program</a>，将其添加到系统的 PATH 路径中。添加之后的用法如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ue4program.exe ProgramName</span></span><br><span class="line">$ ue4program.exe StandaloneApplication</span><br></pre></td></tr></table></figure>

<p>此时会在当前目录下创建出一个 <code>StandaloneApplication</code> 文件夹，其目录结构如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">StandaloneApplication</span><br><span class="line">│  GenerateProgramProject.bat</span><br><span class="line">│  OpenProgramProject.bat</span><br><span class="line">│  StandaloneApplication.Build.cs</span><br><span class="line">│  StandaloneApplication.Target.cs</span><br><span class="line">│</span><br><span class="line">├─Resources</span><br><span class="line">│      Icon.ico</span><br><span class="line">│      Resource.h</span><br><span class="line">│      Resource.rc</span><br><span class="line">│      VersionResource.inl</span><br><span class="line">│</span><br><span class="line">└─Source</span><br><span class="line">    ├─Private</span><br><span class="line">    │  │  RealExecutionMain.cpp</span><br><span class="line">    │  │  StandaloneApplication.cpp</span><br><span class="line">    │  │</span><br><span class="line">    │  ├─Console</span><br><span class="line">    │  │      ConsoleMain.cpp</span><br><span class="line">    │  │</span><br><span class="line">    │  └─Windows</span><br><span class="line">    │          WindowsMain.cpp</span><br><span class="line">    │</span><br><span class="line">    └─Public</span><br><span class="line">            RealExecutionMain.h</span><br><span class="line">            StandaloneApplication.h</span><br><span class="line">            StandaloneApplicationLog.h</span><br></pre></td></tr></table></figure>
<p>本篇文章着重需要分析的是 <code>*.target.cs</code> 与<code>*.build.cs</code>这两个文件.<br>创建出来之后，需要将 <code>StandaloneApplication</code> 文件夹移动到 <code>Engine\Source\Programs</code> 下，UE 所有的辅助程序 (UHT/UBT 等) 都在这个目录之下。<br>然后，运行 <code>GenerateProgramProject.bat</code>，这是我仿照 UE 的<code>GenerateProjectFiles.bat</code> 写的一个脚本，通过调用 UBT 来创建 <code>Standalone Application</code> 程序，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># bash path in Engine\Source\Programs\StandaloneApplication</span></span><br><span class="line">$ UnrealBuildTool.exe -notinstallengine -ProjectFiles StandaloneApplication</span><br></pre></td></tr></table></figure>
<p><strong>注意 </strong>：直接在安装版引擎中使用上面的命令会报错(不允许创建非 Game 项目)，因为虽然传入了<code>-notinstallengine</code> 参数，但是对 <code>Engine/Build/InstalledBuild.txt</code> 文件检测的优先级高于<code>-notinstallengine</code>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Zhalipeng MINGW64 /d/UE_4.18/Engine/Source/Programs/StandaloneApplication (master)</span><br><span class="line">$ ../../../../Engine/Binaries/DotNET/UnrealBuildTool.exe -notinstallengine -ProjectFiles StandaloneApplication</span><br><span class="line">ERROR: UnrealBuildTool Exception: A game project path was not specified, <span class="built_in">which</span> is required when generating project files using an installed build or passing -game on the <span class="built_in">command</span> line</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我写的脚本中做了检测，如果使用的是安装版引擎会先重命名 <strong>InstalledBuild.txt</strong>，生产完毕后会恢复(但是我还是建议不要在安装版引擎中执行)。其执行完毕后会在<code>Engine\Intermediate\ProjectFiles</code> 下生成：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">StandaloneApplication.vcxproj</span><br><span class="line">StandaloneApplication.vcxproj.filters</span><br><span class="line">StandaloneApplication.vcxproj.user</span><br></pre></td></tr></table></figure>
<p>其实就是将当前项目添加到 UE 的解决方案，执行完毕之后，打开引擎根目录下的 <code>UE4.sln</code>, 就可以看到创建的项目了：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/31962/UE4sln_Solution.webp"><br> 先来编译运行看一下结果：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/31962/run-template-program.webp"></p>
<p>资料：</p>
<ul>
<li><a href="https://imzlp.com/posts/31962/">Create A Standalone Application in UE4</a></li>
<li><a href="https://ue5wiki.com/wiki/10556/">UE4Launcher</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>工具</tag>
        <tag>Standalone Application</tag>
        <tag>Tools</tag>
        <tag>ue4program</tag>
      </tags>
  </entry>
  <entry>
    <title>抓取 UE4 API 并生成带索引的 Dash 文档</title>
    <url>/wiki/836faf56/</url>
    <content><![CDATA[<p>不知为何，<a href="http://api.unrealengine.com/INT/API/index.html">UE API</a>现在已经不随引擎发布 chm 的离线文档了，官方发布的最新版本还是 2014 年的，UE 发展到现在有了很多变化，显然四年前的 API 文档已经丧失部分参考价值了。但是 UE 文档站自身的搜索功能就我的体验而言，十分的烂。<br>所以折腾了一下把 UE API 的所有页面爬了下来，并且生成了 Dash 支持的文档，检索起来十分酸爽。(文后附下载链接)</p>
<blockquote>
<p>2020.08.27 更新：把 API 文档更新至 UE4.25。</p>
</blockquote>
<span id="more"></span>
<p>先来看一下成果图(我在 Windows 下使用的是<a href="https://zealdocs.org/">Zeal</a>，它使用的是 Dash 的文档源)：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/11515/ue-doc-for-dash.webp"><br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/11515/ue-doc-for-dash-search-AActor.webp"></p>
<p>最开始的打算是把 UE API 的文档爬下来之后生成 chm，但是在我爬下来之后发现太大了，现在 (2018.07.05)，UE 的 API 文档 html 页面总大小为 2.89G，做成一个 chm 不太现实，所以就想到了其他办法——做成 Dash 支持的文档。<br> 本着不重复造轮子的精神我查了一下有没有相关的实现，查到了一位仁兄几年前做的一个东西：<a href="https://forums.unrealengine.com/community/community-content-tools-and-tutorials/3859-unreal-engine-api-documentation-in-dash?3694-Unreal-Engine-API-documentation-in-Dash=">Unreal Engine API documentation in Dash</a>.<br>该项目地址为：<a href="https://github.com/DrummerB/UnrealEngineDocset">DrummerB/UnrealEngineDocset</a>(<strong>作者已经四年没有更新了 </strong>)<br> 他实现的是把官方提供的 chm 解包出来，然后通过 bs4 爬虫框架来生成 Dash 的文档、并建立索引。我已经直接抓取了所有的 Html 文件，所以略过这一步。</p>
<blockquote>
<p>可以使用 <code>wget</code> 来下载站点，吐个槽：windows 下的 WebZIP 并不好用。<br>具体的用法可以从我之前的记录 (<a href="https://imzlp.com/notes/#Wget%E4%B8%8B%E8%BD%BD%E7%BD%91%E7%AB%99">imzlp.com/notes</a>) 里查看。</p>
</blockquote>
<p>但是经过生成后发现，当时作者解析的方法和现在 UE 的 API 页面已经不一样了，所以我在它的基础上改进了一下，增加了以下几个支持：</p>
<ul>
<li>对所有成员的索引增加 namespace(我手动关闭了 Class/Struct/union 的，因为增加了 namespace 后会对索引排序不友好，可以手动开启)</li>
<li>对没有独立页面的变量 / 函数 / 枚举等建立类页面的索引(之前作者的是不对没有独立页面的建立索引，会导致有些成员检索不到，我觉得不太好)</li>
<li>增加对 Overridden 的函数索引支持</li>
<li>增加 Constructor/Operator/Emum/Typedef 的索引支持</li>
<li>对具有 Inheritance Hierarchy 的结构，从 Inheritance Hierarchy 的 tag 中获取 Name，从而避免具有很多同名索引的情况</li>
<li>尽可能多地对不同类的相同名字的成员增加 Namespace 的标识</li>
<li>一些 bug 修复和优化</li>
</ul>
<p>生成大约需要十分钟左右(视机器性能而定，当然 Py 的效率也是很一般的)，用法(要求 python2 和 bs4)：</p>
<p>首先要安装 bs4：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pip install bs4</span><br></pre></td></tr></table></figure>

<p>然后执行脚本生成：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ python ue4docset.py -n <span class="string">&quot;UE4&quot;</span> ~/Desktop/API ~/Desktop/UE4.docset</span><br></pre></td></tr></table></figure>

<p>代码在这里(<a href="https://gist.github.com/hxhb/2e845712832bf6f499dca59fdad849b3">ue4docset.py</a>)：</p>
<script src="//gist.github.com/2e845712832bf6f499dca59fdad849b3.js"></script>

<p>另外，除了代码之外还需要对 UE API 的页面的 css 文件做一些处理，把下面红框里的部分隐藏掉(实在太影响观感)：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/11515/CleanUp-UE-API-Page.webp"></p>
<p>需要做的是修改 <code>udn_public.css</code> 和<code>navBar.css</code>：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"># udn_public<span class="selector-class">.css</span></span><br><span class="line"># 将下面列出的替换到 udn_public<span class="selector-class">.css</span>中</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#contentContainer</span>&#123;</span><br><span class="line">	<span class="attribute">transition</span>: margin-left <span class="number">0.5s</span> linear <span class="number">0s</span>; </span><br><span class="line">	<span class="attribute">margin-left</span>:<span class="number">0px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#pagenav</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attribute">margin</span>:<span class="number">0px</span> <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">overflow</span>:hidden;</span><br><span class="line">	<span class="attribute">position</span>:relative;</span><br><span class="line">	<span class="attribute">max-width</span>:<span class="number">1562px</span>;</span><br><span class="line">	<span class="attribute">height</span>:<span class="number">0px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#sideinfo</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="attribute">position</span>:absolute;</span><br><span class="line">	<span class="attribute">right</span>:-<span class="number">260px</span>;</span><br><span class="line">	<span class="attribute">top</span>:<span class="number">0px</span>;</span><br><span class="line">	<span class="attribute">width</span>:<span class="number">250px</span>;</span><br><span class="line">    <span class="attribute">display</span>: none;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#pagecontainer</span> &#123;</span><br><span class="line">	<span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">	# <span class="attribute">padding</span>: <span class="number">5px</span> <span class="number">265px</span> <span class="number">0px</span> <span class="number">5px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#pagenav</span> &#123;</span><br><span class="line">	<span class="attribute">width</span>: auto;</span><br><span class="line">    <span class="attribute">display</span>: none;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#head</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>:<span class="number">100%</span>;</span><br><span class="line">	<span class="attribute">clear</span>:both;</span><br><span class="line">	<span class="attribute">display</span>: none;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"># navBar<span class="selector-class">.css</span></span><br><span class="line"># 将下面列出的替换到 navBar<span class="selector-class">.css</span>中</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">nav</span><span class="selector-id">#navPanel</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="attribute">left</span>:<span class="number">0px</span>;</span><br><span class="line">	<span class="attribute">display</span>: none;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">div</span><span class="selector-id">#navigation</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="attribute">left</span>:<span class="number">300px</span>;</span><br><span class="line">	<span class="attribute">display</span>: none;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实我对 Py 和 CSS 以及 bs4 爬虫框架都不熟，没有专门学习过，只是这两天用到了就现查现学现用，这样能够解决问题也挺好。</p>
<p><strong>资源下载 </strong>(Windows 下推荐<a href="https://zealdocs.org/">Zeal</a> 来使用 Dash 文档)：</p>
<ul>
<li><a href="https://pan.baidu.com/s/1aTJs3c0b5z92DCsmIOc7rg">api.unrealengine.com.tar.gz</a></li>
<li><a href="https://pan.baidu.com/s/1RVB2yC_n4BGpIwryc989Gg">UE4.docset.7z</a>（Dash 文档 / 索引）</li>
</ul>
<p>将 <code>UE4.docset.7z</code> 与<code>api.unrealengine.com.tar.gz</code>均解压，并将 <code>api.unrealengine.com/</code> 下的 <code>images</code>/<code>Include</code>/<code>INT</code> 三个目录放入 <code>UE4.docset/Contents/Resources/Documents</code> 下即可。<br>如果使用的是 <a href="https://zealdocs.org/">Zeal</a>，则将<code>UE4.docset</code> 放入 Zeal 安装目录下的 <code>docsets</code> 下即可。</p>
<h2 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h2><p>我创建了一个 git 仓库，来存放生成的文档版本：<a href="https://github.com/hxhb/UE4_API_FOR_DASH/releases">UE4_API_FOR_DASH</a>，可以在仓库的 Release 中下载。</p>
<p><strong>20200827 更新</strong></p>
<ul>
<li><a href="https://github.com/hxhb/UE4_API_FOR_DASH/releases/tag/v1.0">UE425 CPP_API 20200827.docset</a></li>
</ul>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/11515/ue-doc-for-dash-425.webp"></p>
<p><strong>20190628 更新</strong></p>
<ul>
<li><a href="https://1drv.ms/u/s!AjFMYHAQUensgb5w-ScI0P4o009reA">UE API 20190628.docset</a></li>
</ul>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/11515/ue-doc-for-dash-on-macos.webp"></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>工具</tag>
        <tag>DASH</tag>
        <tag>UE API</tag>
      </tags>
  </entry>
  <entry>
    <title>Android 在 Windows 的编译环境</title>
    <url>/wiki/external1206210905/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="/wiki/52d36a">Android 在 Windows 的编译环境 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>开发环境</category>
        <category>Android</category>
      </categories>
  </entry>
  <entry>
    <title>Details Panel Customization in Unrea lEngine</title>
    <url>/wiki/external1356736046/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/26919/">Details Panel Customization in Unrea lEngine</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Editor</category>
        <category>Slate</category>
      </categories>
      <tags>
        <tag>Editor</tag>
        <tag>Slate</tag>
        <tag>Details</tag>
      </tags>
  </entry>
  <entry>
    <title>DevOps：虚幻引擎的 CI/CD 实践</title>
    <url>/wiki/external1698384926/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/96336/">DevOps：虚幻引擎的 CI/CD 实践 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>工具</category>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>工具</tag>
        <tag>构建系统</tag>
        <tag>DevOps</tag>
      </tags>
  </entry>
  <entry>
    <title>HotPatcher 的模块化改造和开发规划</title>
    <url>/wiki/external1223050263/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/30178/">HotPatcher 的模块化改造和开发规划 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>工具</tag>
        <tag>资源管理</tag>
        <tag>资源审计</tag>
      </tags>
  </entry>
  <entry>
    <title>Profiling IOS With UnrealInsight</title>
    <url>/wiki/external1605321656/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/14154/">Profiling IOS With UnrealInsight</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Profiling</category>
      </categories>
      <tags>
        <tag>工具</tag>
        <tag>Profiling</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 中 ASTC 贴图压缩分析及效率优化</title>
    <url>/wiki/external1194091674/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/7181/">UE 中 ASTC 贴图压缩分析及效率优化 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Optimization</category>
      </categories>
      <tags>
        <tag>Optimization</tag>
        <tag>优化</tag>
        <tag>ASTC</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 中利用反射为资产建立属性缓存</title>
    <url>/wiki/external1990173550/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/71162/">UE 中利用反射为资产建立属性缓存 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>工具</category>
        <category>资源管理</category>
        <category>反射</category>
      </categories>
      <tags>
        <tag>工具</tag>
        <tag>资源管理</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 中多阶段的自动化资源检查方案</title>
    <url>/wiki/external1172896530/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/22655/">UE 中多阶段的自动化资源检查方案 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>工具</category>
        <category>资源审计</category>
      </categories>
      <tags>
        <tag>工具</tag>
        <tag>资源管理</tag>
        <tag>资源审计</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 中资源自修正的设计与实现方案</title>
    <url>/wiki/external1330219411/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/19901/">UE 中资源自修正的设计与实现方案 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>工具</category>
        <category>资源管理</category>
      </categories>
      <tags>
        <tag>工具</tag>
        <tag>资源管理</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 插件与工具开发：Commandlet</title>
    <url>/wiki/external1562775310/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/27475/">UE 插件与工具开发：Commandlet</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Plugins</category>
      </categories>
      <tags>
        <tag>Plugins</tag>
        <tag>插件</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 插件与工具开发：j2 的设计思路与实现</title>
    <url>/wiki/external1455460662/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/86105/">UE 插件与工具开发：j2 的设计思路与实现 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>工具</category>
        <category>资源管理</category>
      </categories>
      <tags>
        <tag>工具</tag>
        <tag>资源管理</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 热更新：一次资源异常的故障分析</title>
    <url>/wiki/external1700004272/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/22890/">UE 热更新：一次资源异常的故障分析 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>工具</category>
        <category>资源管理</category>
      </categories>
      <tags>
        <tag>工具</tag>
        <tag>资源管理</tag>
        <tag>HotPatcher</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 资源管理：引擎打包资源分析</title>
    <url>/wiki/external1555331411/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/22570/">UE 资源管理：引擎打包资源分析 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>资源管理</category>
      </categories>
      <tags>
        <tag>资源管理</tag>
        <tag>资源审计</tag>
      </tags>
  </entry>
  <entry>
    <title>UE4 100 Tip For Unreal</title>
    <url>/wiki/external1441096196/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://papalqi.cn/100tipforunreal/">UE4 100 Tip For Unreal</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Tip</category>
      </categories>
      <tags>
        <tag>Tip</tag>
      </tags>
  </entry>
  <entry>
    <title>UE4 Chaos 基础使用及物理说明</title>
    <url>/wiki/external1989449313/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/506607859">UE4 Chaos 基础使用及物理说明 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>物理系统</category>
        <category>Chaos</category>
      </categories>
      <tags>
        <tag>物理系统</tag>
        <tag>Chaos</tag>
      </tags>
  </entry>
  <entry>
    <title>UE4 Cook 一致性实践</title>
    <url>/wiki/external1092230984/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://jashking.github.io/2021/07/15/2021-ue4-deterministic-cook/">UE4 Cook 一致性实践 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
        <category>Bug</category>
      </categories>
      <tags>
        <tag>Engine</tag>
        <tag>Bug</tag>
      </tags>
  </entry>
  <entry>
    <title>UE4 Lighting</title>
    <url>/wiki/external1598530572/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://papalqi.cn/ue4-lighting%E7%B3%BB%E5%88%971/">UE4 Lighting</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Rendering</category>
        <category>Lighting</category>
      </categories>
      <tags>
        <tag>Lighting</tag>
      </tags>
  </entry>
  <entry>
    <title>UE4 Rendering Dependency Graph</title>
    <url>/wiki/external1873084730/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://papalqi.cn/ue4renderingdependencygraph/">UE4 Rendering Dependency Graph</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Rendering</category>
        <category>RDG</category>
      </categories>
      <tags>
        <tag>Rendering</tag>
        <tag>RDG</tag>
      </tags>
  </entry>
  <entry>
    <title>UE4Chaos 框架解析</title>
    <url>/wiki/external1797451917/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/342638827">UE4Chaos 框架解析 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>物理系统</category>
        <category>Chaos</category>
      </categories>
      <tags>
        <tag>物理系统</tag>
        <tag>Chaos</tag>
        <tag>源码解析</tag>
      </tags>
  </entry>
  <entry>
    <title>UE4Editor 对比蓝图</title>
    <url>/wiki/external1312829900/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/453730729">UE4Editor 对比蓝图 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Editor</category>
      </categories>
      <tags>
        <tag>Editor</tag>
        <tag>蓝图</tag>
      </tags>
  </entry>
  <entry>
    <title>UE4Niagara 源码解析</title>
    <url>/wiki/external1145587240/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/362638250">UE4Niagara 源码解析 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>特效粒子</category>
        <category>Niagara</category>
      </categories>
      <tags>
        <tag>源码解析</tag>
        <tag>特效粒子</tag>
        <tag>Niagara</tag>
      </tags>
  </entry>
  <entry>
    <title>UE4VirtualTexture 源码解析</title>
    <url>/wiki/external1165613716/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/373969159">UE4VirtualTexture 源码解析 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Rendering</category>
        <category>VirtualTexture</category>
      </categories>
      <tags>
        <tag>Rendering</tag>
        <tag>源码解析</tag>
        <tag>VirtualTexture</tag>
      </tags>
  </entry>
  <entry>
    <title>UE4 一些实践建议</title>
    <url>/wiki/external1122176667/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://papalqi.cn/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/">UE4 一些实践建议 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Tip</category>
      </categories>
      <tags>
        <tag>Tip</tag>
      </tags>
  </entry>
  <entry>
    <title>UE4 中的 Subsystem</title>
    <url>/wiki/external1291031363/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://www.cnblogs.com/yejianying/p/15029111.html">UE4 中的 Subsystem</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
      </categories>
      <tags>
        <tag>Subsystem</tag>
      </tags>
  </entry>
  <entry>
    <title>UE4 从 UProperty 到 FProperty</title>
    <url>/wiki/external1774438800/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://papalqi.cn/%E8%93%9D%E5%9B%BE%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%86%E8%8A%82/">UE4 从 UProperty 到 FProperty</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
      </categories>
      <tags>
        <tag>Engine</tag>
      </tags>
  </entry>
  <entry>
    <title>UE4 动画系统源码剖析</title>
    <url>/wiki/external1251866798/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://papalqi.cn/ue4%E5%8A%A8%E7%94%BB%E7%B3%BB%E7%BB%9F%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/">UE4 动画系统源码剖析 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Animation</category>
      </categories>
      <tags>
        <tag>源码解析</tag>
        <tag>Animation</tag>
      </tags>
  </entry>
  <entry>
    <title>UE4 大世界场景工作流</title>
    <url>/wiki/external1309222633/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://papalqi.cn/%E7%BE%8E%E6%9C%AF%E5%A4%A7%E4%B8%96%E7%95%8C/">UE4 大世界场景工作流 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Optimization</category>
        <category>大世界</category>
      </categories>
      <tags>
        <tag>Tip</tag>
        <tag>大世界</tag>
      </tags>
  </entry>
  <entry>
    <title>UE4 技术总结——委托</title>
    <url>/wiki/external1670089210/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://www.cnblogs.com/yejianying/p/ue4_note_delegate.html">UE4 技术总结——委托 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
      </categories>
      <tags>
        <tag>Delegate</tag>
      </tags>
  </entry>
  <entry>
    <title>UE4 材质系统源码剖析</title>
    <url>/wiki/external1815422399/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://papalqi.cn/ue4%E6%9D%90%E8%B4%A8%E7%B3%BB%E7%BB%9F/">UE4 材质系统源码剖析 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Rendering</category>
        <category>Material</category>
      </categories>
      <tags>
        <tag>Rendering</tag>
        <tag>源码解析</tag>
        <tag>Material</tag>
      </tags>
  </entry>
  <entry>
    <title>UE4 灯光的移动性</title>
    <url>/wiki/external1229427375/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://papalqi.cn/ue4%E7%81%AF%E5%85%89%E7%9A%84%E7%A7%BB%E5%8A%A8%E6%80%A7/">UE4 灯光的移动性 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Rendering</category>
        <category>Lighting</category>
      </categories>
      <tags>
        <tag>Lighting</tag>
      </tags>
  </entry>
  <entry>
    <title>UE4 物理系统实现</title>
    <url>/wiki/external1582524816/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://papalqi.cn/ue4-%E7%89%A9%E7%90%86%E7%B3%BB%E7%BB%9F%E5%AE%9E%E7%8E%B0/">UE4 物理系统实现 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>物理系统</category>
      </categories>
      <tags>
        <tag>物理系统</tag>
        <tag>源码解析</tag>
      </tags>
  </entry>
  <entry>
    <title>UE5 VirtualHeightfieldMesh 简述</title>
    <url>/wiki/external1077255389/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/575398476">UE5 VirtualHeightfieldMesh 简述 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Rendering</category>
        <category>Landscape</category>
      </categories>
      <tags>
        <tag>Plugins</tag>
        <tag>Rendering</tag>
        <tag>Landscape</tag>
      </tags>
  </entry>
  <entry>
    <title>UE5：Game Feature 预研</title>
    <url>/wiki/external1985524568/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/17658/">UE5：Game Feature 预研 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>UE5</category>
        <category>Game Feature</category>
      </categories>
      <tags>
        <tag>工具</tag>
        <tag>UE5</tag>
        <tag>Modular Gameplay</tag>
        <tag>Game Feature</tag>
      </tags>
  </entry>
  <entry>
    <title>UEAsLib 机制初探</title>
    <url>/wiki/external1305107197/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/26475/">UEAsLib 机制初探 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
      </categories>
      <tags>
        <tag>Engine</tag>
        <tag>UEAsLib</tag>
      </tags>
  </entry>
  <entry>
    <title>UESlate 源码剖析</title>
    <url>/wiki/external1388167213/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://myslate.readthedocs.io/en/latest/">UESlate 源码剖析 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>工具</category>
        <category>UI</category>
      </categories>
      <tags>
        <tag>Editor</tag>
        <tag>工具</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 多用户协同编辑服务部署指南</title>
    <url>/wiki/external1300081523/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/25226/">UE 多用户协同编辑服务部署指南 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>工具</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 插件与工具开发：基础概念</title>
    <url>/wiki/external1631269588/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/75405/">UE 插件与工具开发：基础概念 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Plugins</category>
      </categories>
      <tags>
        <tag>Plugins</tag>
        <tag>插件</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 热更新：Config 的重载与应用</title>
    <url>/wiki/external1703454788/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/9028/">UE 热更新：Config 的重载与应用 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>热更新</category>
      </categories>
      <tags>
        <tag>HotPatcher</tag>
        <tag>热更新</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 热更新：Shader 更新策略</title>
    <url>/wiki/external1895410931/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/15810/">UE 热更新：Shader 更新策略 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>热更新</category>
      </categories>
      <tags>
        <tag>HotPatcher</tag>
        <tag>热更新</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 热更新：资源的二进制补丁方案</title>
    <url>/wiki/external1501139690/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/25136/">UE 热更新：资源的二进制补丁方案 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>热更新</category>
      </categories>
      <tags>
        <tag>HotPatcher</tag>
        <tag>热更新</tag>
        <tag>包体优化</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 资源合规检查工具 ResScannerUE</title>
    <url>/wiki/external1704811846/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/11750/">UE 资源合规检查工具 ResScannerUE</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>工具</category>
        <category>资源审计</category>
      </categories>
      <tags>
        <tag>工具</tag>
        <tag>资源审计</tag>
        <tag>ResScannerUE</tag>
      </tags>
  </entry>
  <entry>
    <title>UnrealPakViewer 可视化 Pak 分析工具</title>
    <url>/wiki/external1237318848/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/163501071">UnrealPakViewer 可视化 Pak 分析工具 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>工具</tag>
        <tag>Pak</tag>
      </tags>
  </entry>
  <entry>
    <title>一种灵活与非侵入式的基础包拆分方案</title>
    <url>/wiki/external1074252106/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/24350/"> 一种灵活与非侵入式的基础包拆分方案 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>资源管理</category>
      </categories>
      <tags>
        <tag>工具</tag>
        <tag>资源管理</tag>
        <tag>资源审计</tag>
      </tags>
  </entry>
  <entry>
    <title>一种高效的 ZSTD Shader 字典训练方案</title>
    <url>/wiki/external1946577463/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/26943/"> 一种高效的 ZSTD Shader 字典训练方案 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Optimization</category>
      </categories>
      <tags>
        <tag>压缩算法</tag>
        <tag>打包</tag>
        <tag>包体优化</tag>
        <tag>Shader</tag>
      </tags>
  </entry>
  <entry>
    <title>使用 SequenceRecorder 无法录制面部 MorphTarget 问题的解决方法</title>
    <url>/wiki/external1320739314/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://www.cnblogs.com/yejianying/p/record_morph_target_with_ue4_sequence_recorder.html"> 使用 SequenceRecorder 无法录制面部 MorphTarget 问题的解决方法 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Animation</category>
      </categories>
      <tags>
        <tag>Plugins</tag>
        <tag>Animation</tag>
        <tag>MorphTarget</tag>
      </tags>
  </entry>
  <entry>
    <title>内存扩展：UE 中利用 IOS 新的内存特性</title>
    <url>/wiki/external1165338292/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/56381/"> 内存扩展：UE 中利用 IOS 新的内存特性 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Optimization</category>
        <category>Memory</category>
      </categories>
      <tags>
        <tag>Optimization</tag>
        <tag>优化</tag>
        <tag>Memory</tag>
        <tag>内存</tag>
      </tags>
  </entry>
  <entry>
    <title>利用 HotPatcher 加速真机资源验证</title>
    <url>/wiki/external1038528457/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/76004/"> 利用 HotPatcher 加速真机资源验证 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>工具</category>
        <category>资源管理</category>
      </categories>
      <tags>
        <tag>工具</tag>
        <tag>资源管理</tag>
        <tag>HotPatcher</tag>
      </tags>
  </entry>
  <entry>
    <title>基于 ZSTD 字典的 Shader 压缩方案</title>
    <url>/wiki/external1376930294/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/24725/"> 基于 ZSTD 字典的 Shader 压缩方案 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Optimization</category>
      </categories>
      <tags>
        <tag>压缩算法</tag>
        <tag>打包</tag>
        <tag>包体优化</tag>
        <tag>Shader</tag>
      </tags>
  </entry>
  <entry>
    <title>基于 ResScannerUE 的资源检查自动化实践</title>
    <url>/wiki/external1535948165/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/20376/"> 基于 ResScannerUE 的资源检查自动化实践 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>工具</category>
        <category>资源审计</category>
      </categories>
      <tags>
        <tag>工具</tag>
        <tag>资源审计</tag>
        <tag>ResScannerUE</tag>
      </tags>
  </entry>
  <entry>
    <title>开源一个虚幻引擎启动器 UE Launcher</title>
    <url>/wiki/external1574333573/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/3635/"> 开源一个虚幻引擎启动器 UE Launcher</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>工具</category>
        <category>UELauncher</category>
      </categories>
      <tags>
        <tag>工具</tag>
        <tag>Launcher</tag>
        <tag>UELauncher</tag>
      </tags>
  </entry>
  <entry>
    <title>开源杂谈：HotPatcher 的开发进展</title>
    <url>/wiki/external1617315395/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/16808/"> 开源杂谈：HotPatcher 的开发进展 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>开源项目</category>
      </categories>
      <tags>
        <tag>工具</tag>
        <tag>开源</tag>
        <tag>资源管理</tag>
        <tag>HotPatcher</tag>
      </tags>
  </entry>
  <entry>
    <title>未变动资源 Cook 稳定性的 BUG</title>
    <url>/wiki/external1636799000/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/388094053"> 未变动资源 Cook 稳定性的 BUG</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
        <category>Bug</category>
      </categories>
      <tags>
        <tag>Engine</tag>
        <tag>Bug</tag>
      </tags>
  </entry>
  <entry>
    <title>给 UE4 项目改名</title>
    <url>/wiki/external1469810194/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://papalqi.cn/rename/"> 给 UE4 项目改名 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Tip</category>
      </categories>
      <tags>
        <tag>Tip</tag>
      </tags>
  </entry>
  <entry>
    <title>蓝图的一些细节</title>
    <url>/wiki/external1995684526/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://papalqi.cn/%E8%93%9D%E5%9B%BE%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%86%E8%8A%82/"> 蓝图的一些细节 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Tip</category>
        <category>蓝图</category>
      </categories>
      <tags>
        <tag>Tip</tag>
        <tag>蓝图</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220810| 高温预警</title>
    <url>/wiki/external1489254303/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/552068064"> 虚幻周报 20220810| 高温预警 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220817| 秋天第一个项目</title>
    <url>/wiki/external1757811612/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/554726309"> 虚幻周报 20220817| 秋天第一个项目 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220825| 虚幻嘉年华见！</title>
    <url>/wiki/external1964104163/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/557668437"> 虚幻周报 20220825| 虚幻嘉年华见！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220831| 神兽归笼</title>
    <url>/wiki/external1021399063/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/559791051"> 虚幻周报 20220831| 神兽归笼 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220907| 下周武汉见！</title>
    <url>/wiki/external1266536179/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/562125164"> 虚幻周报 20220907| 下周武汉见！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20210603| 开心地像个孩子！</title>
    <url>/wiki/external1024736214/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/377551140"> 虚幻周报 20210603| 开心地像个孩子！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20210623| 又有好东西要来了</title>
    <url>/wiki/external1200349813/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/383057008"> 虚幻周报 20210623| 又有好东西要来了 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20210714| 虚幻嘉年华！</title>
    <url>/wiki/external1036572621/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/389520888"> 虚幻周报 20210714| 虚幻嘉年华！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20210728| 虚幻嘉年华见吧！</title>
    <url>/wiki/external1139461986/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/393910783"> 虚幻周报 20210728| 虚幻嘉年华见吧！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20210811|SIGGRAPH 好多干货</title>
    <url>/wiki/external1070219978/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/398622312"> 虚幻周报 20210811|SIGGRAPH 好多干货 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20210820|UE4.27 正式版发布！</title>
    <url>/wiki/external1564884332/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/401742228"> 虚幻周报 20210820|UE4.27 正式版发布！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20210825| 要有光！</title>
    <url>/wiki/external1985729462/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/403373161"> 虚幻周报 20210825| 要有光！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20210831| 本周继续直播</title>
    <url>/wiki/external1690991244/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/405359156"> 虚幻周报 20210831| 本周继续直播 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20210908| 活动搞起来！</title>
    <url>/wiki/external1066075067/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/408172902"> 虚幻周报 20210908| 活动搞起来！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20210915|UnrealCircle 北京站！</title>
    <url>/wiki/external1584119025/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/410593946"> 虚幻周报 20210915|UnrealCircle 北京站！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20210929|UOD2021 售票中！</title>
    <url>/wiki/external1901544225/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/415311929"> 虚幻周报 20210929|UOD2021 售票中！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20211013| 来成为蓝图大师吧！</title>
    <url>/wiki/external1039860269/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/420985158"> 虚幻周报 20211013| 来成为蓝图大师吧！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20211020|UOD2021 倒计时 1 个月</title>
    <url>/wiki/external1566249995/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/423652760"> 虚幻周报 20211020|UOD2021 倒计时 1 个月 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20211028|UOD2021 演讲开始公布了</title>
    <url>/wiki/external1618671308/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/426709740"> 虚幻周报 20211028|UOD2021 演讲开始公布了 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20211103| 不给 PPT 就捣蛋！</title>
    <url>/wiki/external1558001029/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/428861891"> 虚幻周报 20211103| 不给 PPT 就捣蛋！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20211110| 万事开头难然后更难最后最难</title>
    <url>/wiki/external1632081076/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/431616269"> 虚幻周报 20211110| 万事开头难然后更难最后最难 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20211117| 好事多磨</title>
    <url>/wiki/external1768125355/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/434307199"> 虚幻周报 20211117| 好事多磨 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20211201|UOD2021 就在明天！</title>
    <url>/wiki/external1731865802/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/439915018"> 虚幻周报 20211201|UOD2021 就在明天！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20211208| 该醒醒了！</title>
    <url>/wiki/external1555099185/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/442703964"> 虚幻周报 20211208| 该醒醒了！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20211215| 照顾好自己</title>
    <url>/wiki/external1392636298/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/445611048"> 虚幻周报 20211215| 照顾好自己 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20211222| 圣蛋快乐哦~</title>
    <url>/wiki/external1925260487/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/448312989"> 虚幻周报 20211222| 圣蛋快乐哦~</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20211229| 元蛋快乐！</title>
    <url>/wiki/external1751555888/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/450945001"> 虚幻周报 20211229| 元蛋快乐！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220105| 开工啦！</title>
    <url>/wiki/external1217791788/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/453378749"> 虚幻周报 20220105| 开工啦！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220112|UOD2021 录播视频放送中！</title>
    <url>/wiki/external1890155749/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/456290322"> 虚幻周报 20220112|UOD2021 录播视频放送中！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220119| 还有两周！</title>
    <url>/wiki/external1400692830/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/459363704"> 虚幻周报 20220119| 还有两周！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220126| 还有几天！</title>
    <url>/wiki/external1523936753/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/462004139"> 虚幻周报 20220126| 还有几天！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220217| 先睹为快</title>
    <url>/wiki/external1964078621/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/468554791"> 虚幻周报 20220217| 先睹为快 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220223|UE5 预览版发布！</title>
    <url>/wiki/external1052449895/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/471250861"> 虚幻周报 20220223|UE5 预览版发布！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220302| 受苦很快乐</title>
    <url>/wiki/external1821049606/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/474661397"> 虚幻周报 20220302| 受苦很快乐 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220309| 搞点活动吧</title>
    <url>/wiki/external1853014985/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/478104567"> 虚幻周报 20220309| 搞点活动吧 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220316| 大家保重！</title>
    <url>/wiki/external1088777453/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/481866611"> 虚幻周报 20220316| 大家保重！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220323| 世事无常珍惜当下</title>
    <url>/wiki/external1492416133/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/486145269"> 虚幻周报 20220323| 世事无常珍惜当下 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220330| 前有珍贵的菜</title>
    <url>/wiki/external1528124898/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/490166688"> 虚幻周报 20220330| 前有珍贵的菜 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220413|55555</title>
    <url>/wiki/external1897115307/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/497767596"> 虚幻周报 20220413|55555</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220420| 有一就有二再有三</title>
    <url>/wiki/external1770303570/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/501783535"> 虚幻周报 20220420| 有一就有二再有三 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220427| 五一想上班</title>
    <url>/wiki/external1769271662/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/505959032"> 虚幻周报 20220427| 五一想上班 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220511|memset(0)</title>
    <url>/wiki/external1304759815/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/512701706"> 虚幻周报 20220511|memset(0)</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220518| 随缘了</title>
    <url>/wiki/external1128139694/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/516220151"> 虚幻周报 20220518| 随缘了 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220525| 应该是快了吧</title>
    <url>/wiki/external1983017198/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/519675285"> 虚幻周报 20220525| 应该是快了吧 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220601| 儿童节解封快乐！</title>
    <url>/wiki/external1958299445/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/523005911"> 虚幻周报 20220601| 儿童节解封快乐！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220608| 想要上班</title>
    <url>/wiki/external1823497232/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/525894036"> 虚幻周报 20220608| 想要上班 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220615|MetaHuman 觉醒</title>
    <url>/wiki/external1752863627/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/529099320"> 虚幻周报 20220615|MetaHuman 觉醒 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220622| 终于要动身了</title>
    <url>/wiki/external1904921416/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/532231206"> 虚幻周报 20220622| 终于要动身了 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220629| 杭州我来了！</title>
    <url>/wiki/external1230348720/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/535320610"> 虚幻周报 20220629| 杭州我来了！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220706| 周六杭州见！</title>
    <url>/wiki/external1934642032/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/538004938"> 虚幻周报 20220706| 周六杭州见！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220713| 周日广州见！</title>
    <url>/wiki/external1813860941/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/541067431"> 虚幻周报 20220713| 周日广州见！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220721| 下一站何处</title>
    <url>/wiki/external1408947904/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/544379818"> 虚幻周报 20220721| 下一站何处 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220803| 下周开工！</title>
    <url>/wiki/external1939418642/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/549365849"> 虚幻周报 20220803| 下周开工！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220914 | 武汉我来了！</title>
    <url>/wiki/external1721566552/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/564277018"> 虚幻周报 20220914 | 武汉我来了！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220922 | 新的忙碌循环</title>
    <url>/wiki/external1781044638/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/567046523"> 虚幻周报 20220922 | 新的忙碌循环 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20220930 | 放假啦</title>
    <url>/wiki/external1554461689/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/569667750"> 虚幻周报 20220930 | 放假啦 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20221012 | UOD2022 开票了</title>
    <url>/wiki/external1454734125/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/572818168"> 虚幻周报 20221012 | UOD2022 开票了 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20221019 | PPT 十天乐</title>
    <url>/wiki/external1129049340/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/575114766"> 虚幻周报 20221019 | PPT 十天乐 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20221026 | 不给 PPT 就捣蛋</title>
    <url>/wiki/external1238589689/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/579703531"> 虚幻周报 20221026 | 不给 PPT 就捣蛋 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20221026 | 啊最后一周</title>
    <url>/wiki/external1113686807/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/577465104"> 虚幻周报 20221026 | 啊最后一周 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20221115 | 大的要来了</title>
    <url>/wiki/external1909976704/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/583572626"> 虚幻周报 20221115 | 大的要来了 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20221130 | UOD2022 录播放送中</title>
    <url>/wiki/external1683281074/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/588048495"> 虚幻周报 20221130 | UOD2022 录播放送中 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20221214 | 早晚的事</title>
    <url>/wiki/external1736169713/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/591711145"> 虚幻周报 20221214 | 早晚的事 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20230104 | 新年新气象</title>
    <url>/wiki/external1773660727/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/596508977"> 虚幻周报 20230104 | 新年新气象 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20230119 | Happy New Year to 兔 you！</title>
    <url>/wiki/external1642904561/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/600077412"> 虚幻周报 20230119 | Happy New Year to 兔 you！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20230209 | 开工大吉！</title>
    <url>/wiki/external1161936286/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/604829273"> 虚幻周报 20230209 | 开工大吉！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20230215 | 兔年的第一场直播</title>
    <url>/wiki/external1464715932/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/606498781"> 虚幻周报 20230215 | 兔年的第一场直播 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20230302 | 喜欢冰箱应该没错吧？</title>
    <url>/wiki/external1735418196/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/610704105"> 虚幻周报 20230302 | 喜欢冰箱应该没错吧？</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20230308 | 活动搞起来</title>
    <url>/wiki/external1162953820/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/612288548"> 虚幻周报 20230308 | 活动搞起来 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20230315 | 周日厦门见</title>
    <url>/wiki/external1682619011/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/614222392"> 虚幻周报 20230315 | 周日厦门见 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20230405 | GDC 视频汉化中</title>
    <url>/wiki/external1690806032/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/619575655"> 虚幻周报 20230405 | GDC 视频汉化中 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20230412 | 春天来了</title>
    <url>/wiki/external1544062841/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/621324922"> 虚幻周报 20230412 | 春天来了 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20230426 | 五一快乐！</title>
    <url>/wiki/external1719895478/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/625066496"> 虚幻周报 20230426 | 五一快乐！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20230531 | 明天过节</title>
    <url>/wiki/external1672843577/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/633601615"> 虚幻周报 20230531 | 明天过节 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20230614 | 天热了啊</title>
    <url>/wiki/external1099769251/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/636996586"> 虚幻周报 20230614 | 天热了啊 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20230621 | 粽子节快乐！</title>
    <url>/wiki/external1655537268/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/638655932"> 虚幻周报 20230621 | 粽子节快乐！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20230629 | 要放暑假啦</title>
    <url>/wiki/external1149088880/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/640380434"> 虚幻周报 20230629 | 要放暑假啦 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20230719 | 好热好热</title>
    <url>/wiki/external1751867492/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/644528463"> 虚幻周报 20230719 | 好热好热 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20230802 | 又是一年</title>
    <url>/wiki/external1096810021/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/647487470"> 虚幻周报 20230802 | 又是一年 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20230809 | 周六苏州见</title>
    <url>/wiki/external1797336171/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/648931414"> 虚幻周报 20230809 | 周六苏州见 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20230816 | 要开始了</title>
    <url>/wiki/external1846586087/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/650365536"> 虚幻周报 20230816 | 要开始了 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20230823 | 昨晚我真在写代码</title>
    <url>/wiki/external1222542609/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/651848449"> 虚幻周报 20230823 | 昨晚我真在写代码 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20230907 | UE5.3 发布啦！</title>
    <url>/wiki/external1649169223/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/654839088"> 虚幻周报 20230907 | UE5.3 发布啦！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20230913 | 哪里贵了</title>
    <url>/wiki/external1609100988/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/655981141"> 虚幻周报 20230913 | 哪里贵了 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20230927 | UFSH 2023 来了！</title>
    <url>/wiki/external1515603348/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/658709774"> 虚幻周报 20230927 | UFSH 2023 来了！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20231018 | 许久不见</title>
    <url>/wiki/external1320858002/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/662004358"> 虚幻周报 20231018 | 许久不见 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20231101 | 买票要趁早</title>
    <url>/wiki/external1387224613/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/664499469"> 虚幻周报 20231101 | 买票要趁早 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20231115 | 最后两周了</title>
    <url>/wiki/external1654740574/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/666961620"> 虚幻周报 20231115 | 最后两周了 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20231122 | 就在下周</title>
    <url>/wiki/external1730042910/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/668177148"> 虚幻周报 20231122 | 就在下周 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20231214 | 又一年圆满落幕</title>
    <url>/wiki/external1451954171/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/672198957"> 虚幻周报 20231214 | 又一年圆满落幕 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20240110 | 录播放送中</title>
    <url>/wiki/external1832127816/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/677045531"> 虚幻周报 20240110 | 录播放送中 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20240117 | 还有一个月</title>
    <url>/wiki/external1975367245/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/678297071"> 虚幻周报 20240117 | 还有一个月 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20240125 | 还有两周</title>
    <url>/wiki/external1284538056/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/679761565"> 虚幻周报 20240125 | 还有两周 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20240131 | 等不及了！</title>
    <url>/wiki/external1599147668/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/680755913"> 虚幻周报 20240131 | 等不及了！</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻引擎中 Pak 的运行时重组方案</title>
    <url>/wiki/external1240235779/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/12188/"> 虚幻引擎中 Pak 的运行时重组方案 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>热更新</category>
      </categories>
      <tags>
        <tag>打包</tag>
        <tag>热更新</tag>
        <tag>Pak</tag>
      </tags>
  </entry>
  <entry>
    <title>资源管理：UASSET 资源加密方案</title>
    <url>/wiki/external1842889295/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/32412/"> 资源管理：UASSET 资源加密方案 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>工具</category>
        <category>资源管理</category>
      </categories>
      <tags>
        <tag>工具</tag>
        <tag>资源管理</tag>
      </tags>
  </entry>
  <entry>
    <title>资源管理：重塑 UE 的包拆分方案</title>
    <url>/wiki/external1086880409/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/37036/"> 资源管理：重塑 UE 的包拆分方案 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>工具</category>
        <category>资源管理</category>
      </categories>
      <tags>
        <tag>工具</tag>
        <tag>资源管理</tag>
        <tag>资源审计</tag>
      </tags>
  </entry>
  <entry>
    <title>高效调试：命令行参数启动 UE Android App</title>
    <url>/wiki/external1556224286/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://imzlp.com/posts/29169/"> 高效调试：命令行参数启动 UE Android App</a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>Debugging</tag>
        <tag>Android</tag>
        <tag>Mobile</tag>
        <tag>工具</tag>
      </tags>
  </entry>
  <entry>
    <title>Setup 多线程数加速下载</title>
    <url>/wiki/67d284ec/</url>
    <content><![CDATA[<p>在下载 UE4 的源码之后，需要先执行 <code>Setup.bat</code> 下载依赖才可以开始生成 VS 项目文件以及编译。<br>但是国内的网络环境又极差，默认的 <code>Setup.bat</code> 是没有指定线程数量的（<code>Setup.bat</code>只给 <code>GitDenpencies</code> 传递了 <code>--prompt</code> 参数）。</p>
<figure class="highlight bat"><table><tr><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="built_in">setlocal</span></span><br><span class="line"><span class="built_in">pushd</span> %~dp0</span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">rem Figure out if we should append the -prompt argument</span></span><br><span class="line"><span class="built_in">set</span> PROMPT_ARGUMENT=</span><br><span class="line"><span class="keyword">for</span> <span class="variable">%%P</span> <span class="keyword">in</span> (%*) <span class="keyword">do</span> <span class="keyword">if</span> /I &quot;<span class="variable">%%P</span>&quot; == &quot;--prompt&quot; <span class="keyword">goto</span> no_prompt_argument</span><br><span class="line"><span class="keyword">for</span> <span class="variable">%%P</span> <span class="keyword">in</span> (%*) <span class="keyword">do</span> <span class="keyword">if</span> /I &quot;<span class="variable">%%P</span>&quot; == &quot;--force&quot; <span class="keyword">goto</span> no_prompt_argument</span><br><span class="line"><span class="built_in">set</span> PROMPT_ARGUMENT=--prompt</span><br><span class="line">:no_prompt_argument</span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">rem Sync the dependencies...</span></span><br><span class="line">.\Engine\Binaries\DotNET\GitDependencies.exe <span class="variable">%PROMPT_ARGUMENT%</span> %*</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">ERRORLEVEL</span> <span class="number">1</span> <span class="keyword">goto</span> error</span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">rem Setup the git hooks...</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exist</span> .git\hooks <span class="keyword">goto</span> no_git_hooks_directory</span><br><span class="line"><span class="built_in">echo</span> Registering git hooks...</span><br><span class="line"><span class="built_in">echo</span> #!/bin/sh &gt;.git\hooks\post-checkout</span><br><span class="line"><span class="built_in">echo</span> Engine/Binaries/DotNET/GitDependencies.exe %* &gt;&gt;.git\hooks\post-checkout</span><br><span class="line"><span class="built_in">echo</span> #!/bin/sh &gt;.git\hooks\post-merge</span><br><span class="line"><span class="built_in">echo</span> Engine/Binaries/DotNET/GitDependencies.exe %* &gt;&gt;.git\hooks\post-merge</span><br><span class="line">:no_git_hooks_directory</span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">rem Install prerequisites...</span></span><br><span class="line"><span class="built_in">echo</span> Installing prerequisites...</span><br><span class="line"><span class="built_in">start</span> /wait Engine\Extras\Redist\en-us\UE4PrereqSetup_x64.exe /quiet</span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">rem Register the engine installation...</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exist</span> .\Engine\Binaries\Win64\UnrealVersionSelector-Win64-Shipping.exe <span class="keyword">goto</span> :no_unreal_version_selector</span><br><span class="line">.\Engine\Binaries\Win64\UnrealVersionSelector-Win64-Shipping.exe /register</span><br><span class="line">:no_unreal_version_selector</span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">rem Done!</span></span><br><span class="line"><span class="keyword">goto</span> :EOF</span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">rem Error happened. Wait for a keypress before quitting.</span></span><br><span class="line">:error</span><br><span class="line"><span class="built_in">pause</span></span><br></pre></td></tr></table></figure>

<p><code>GitDependencies.exe</code>支持的参数为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">Usage:</span><br><span class="line">   GitDependencies [options]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">   --all                         Sync all folders</span><br><span class="line">   --include=&lt;X&gt;                 Include binaries in folders called &lt;X&gt;</span><br><span class="line">   --exclude=&lt;X&gt;                 Exclude binaries in folders called &lt;X&gt;</span><br><span class="line">   --prompt                      Prompt before overwriting modified files</span><br><span class="line">   --force                       Always overwrite modified files</span><br><span class="line">   --root=&lt;PATH&gt;                 Set the repository directory to be sync</span><br><span class="line">   --threads=&lt;N&gt;                 Use N threads when downloading <span class="keyword">new</span> files</span><br><span class="line">   --dry-run                     Print a list of outdated files <span class="keyword">and</span> exit</span><br><span class="line">   --max-retries                 Override maximum number of retries per file</span><br><span class="line">   --proxy=&lt;user:password@url&gt;   Sets the HTTP proxy address <span class="keyword">and</span> credentials</span><br><span class="line">   --cache=&lt;PATH&gt;                Specifies a custom path <span class="keyword">for</span> the download cache</span><br><span class="line">   --cache-size-multiplier=&lt;N&gt;   Cache size as multiplier of current download</span><br><span class="line">   --cache-days=&lt;N&gt;              Number of days to keep entries in the cache</span><br><span class="line">   --no-cache                    Disable caching of downloaded files</span><br><span class="line"></span><br><span class="line">Detected settings:</span><br><span class="line">   Excluded folders: Mac, Android, Linux</span><br><span class="line">   Proxy server: none</span><br><span class="line">   Download cache: E:\UnrealEngine\EngineSource\UE_4<span class="number">.21</span>_Source\.git\ue4-gitdeps</span><br><span class="line"></span><br><span class="line">Default arguments can be set through the UE4_GITDEPS_ARGS environment variable.</span><br></pre></td></tr></table></figure>

<p>所以我们可以将 <code>Setup.bat</code> 中的变量 <code>PROMPT_ARGUMENT</code> 增加上指定的线程数即可（N 替换为数字）：</p>
<figure class="highlight bat"><table><tr><td class="code"><pre><span class="line"><span class="built_in">set</span> PROMPT_ARGUMENT=--prompt --threads=N</span><br></pre></td></tr></table></figure>
<p>我一般开 8 个线程，基本可以跑 2-3M/s…</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>开发环境</category>
      </categories>
      <tags>
        <tag>开发环境</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 内置的 Release/Patch 分析</title>
    <url>/wiki/10262/</url>
    <content><![CDATA[<p>UE 的 Patch 有一些缺点：</p>
<ul>
<li>无法精确地控制 Patch 包含的内容且不方便拆分。</li>
<li>无法进行迭代 Patch，不能直观预览资源信息。</li>
<li>无法方便地管理工程和 Patch 版本。</li>
<li>开发阶段无法方便地进行测试补丁打包。</li>
</ul>
<p>具体操作是在 Project Launcher 中进行 Release 打包：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210319213357.webp"></p>
<p>Cook 时的命令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UE4Editor-Cmd.exe &quot;D:\ThirdPerson425\ThirdPerson425.uproject&quot; -run=Cook  -TargetPlatform=WindowsNoEditor -fileopenlog -unversioned -createreleaseversion=1.0.0.0 -compressed -abslog=&quot;C:\Program Files\Epic Games\UE_4.25\Engine\Programs\AutomationTool\Saved\Cook-2021.03.19-19.00.30.txt&quot; -stdout -CrashForUAT -unattended -NoLogTimes  -UTF8Output</span><br></pre></td></tr></table></figure>
<p>当打包成功后会在项目的根目录中创建出一个 Releases 目录，存储以下文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\ThirdPerson425\Releases&gt;tree /a /f</span><br><span class="line">D:.</span><br><span class="line">\---1.0.0.0</span><br><span class="line">    \---WindowsNoEditor</span><br><span class="line">        |   AssetRegistry.bin</span><br><span class="line">        |   ThirdPerson425-WindowsNoEditor.pak</span><br><span class="line">        |</span><br><span class="line">        \---Metadata</span><br><span class="line">                DevelopmentAssetRegistry.bin</span><br></pre></td></tr></table></figure>
<p>可以看到它的实现实际上是备份了当前打包版本的 AssetRegistry 文件，但经过分析发现，它并不会用来和后续的版本做比对，使用的是另一种方式。</p>
<p>在基于某个 Release 进行 Patch 时会自动把 AssetRegistry.bin 和 ushaderbytecode 包含到 pak 中（并且 shaderbytecode 并没有进行 patch）：<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210319214356.webp"></p>
<p>当基于某个基础版本进行 Patch 的时候，在 Project Launher 的设置如下：<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210322164021.webp"></p>
<p>执行流程中首先需要对项目进行 Cook，但是 Cook 时不需要指定任何版本信息：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">UE4Editor-Cmd.exe</span><br><span class="line"> <span class="string">&quot;D:\Project\ThirdPerson425.uproject&quot;</span></span><br><span class="line"> -run=Cook</span><br><span class="line"> -TargetPlatform=WindowsNoEditor</span><br><span class="line"> -fileopenlog</span><br><span class="line"> -unversioned</span><br><span class="line"> -abslog=<span class="string">&quot;C:\Program Files\Epic Games\UE_4.25\Engine\Programs\AutomationTool\Saved\Cook-2021.03.22-15.29.04.txt&quot;</span></span><br><span class="line"> -stdout</span><br><span class="line"> -CrashForUAT</span><br><span class="line"> -unattended</span><br><span class="line"> -NoLogTimes</span><br><span class="line"> -UTF8Output</span><br></pre></td></tr></table></figure>
<p>当 Cook 完毕，执行 Pak 打包的时候，需要传入版本信息：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">UnrealPak.exe</span><br><span class="line"> <span class="string">&quot;D:\Projects\ThirdPerson425.uproject&quot;</span></span><br><span class="line"> <span class="string">&quot;D:\Projects\Package\1.0.0.0_patch1\WindowsNoEditor\ThirdPerson425\Content\Paks\ThirdPerson425-WindowsNoEditor_0_P.pak&quot;</span></span><br><span class="line"> -create=<span class="string">&quot;C:\Users\lipengzha\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+Program+Files+Epic+Games+UE_4.25\PakList_ThirdPerson425-WindowsNoEditor_0_P.txt&quot;</span></span><br><span class="line"> -cryptokeys=<span class="string">&quot;D:\Projects\Saved\Cooked\WindowsNoEditor\ThirdPerson425\Metadata\Crypto.json&quot;</span></span><br><span class="line"> -order=<span class="string">&quot;D:\Projects\Build\WindowsNoEditor\FileOpenOrder\CookerOpenOrder.log&quot;</span></span><br><span class="line"> -generatepatch=<span class="string">&quot;D:\Projects\Releases\1.0.0.0\WindowsNoEditor\ThirdPerson425-WindowsNoEditor*.pak&quot;</span></span><br><span class="line"> -tempfiles=<span class="string">&quot;C:\Program Files\Epic Games\UE_4.25\TempFilesThirdPerson425-WindowsNoEditor_0_P&quot;</span></span><br><span class="line"> -patchpaddingalign=2048</span><br><span class="line"> -platform=Windows</span><br><span class="line"> -multiprocess</span><br><span class="line"> -abslog=<span class="string">&quot;C:\Users\lipengzha\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+Program+Files+Epic+Games+UE_4.25\UnrealPak-ThirdPerson425-WindowsNoEditor_0_P-2021.03.22-15.29.17.txt&quot;</span></span><br></pre></td></tr></table></figure>
<p>注意：</p>
<ol>
<li><code>-create=</code>传递进去的 Response 的 <code>txt</code> 中是包含整个项目的资源列表的，并非是差异的文件列表。(-create= 也可以传递 pak 文件，用来生成差异)</li>
<li>需要通过 <code>-generatepatch=</code> 传递基础包中的 pak 文件</li>
<li>读取基础版本包 pak 中所有文件，计算出每个文件的 hash 值</li>
<li>与 Response 中的资源进行比对，得到新加或者与基础包 pak 中 Hash 文件不同的文件列表</li>
<li>把差异部分打包至新的 pak 中。</li>
</ol>
<p>执行时会加载基础包中 pak 的文件，计算 pak 中资源的 hash 值：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">LogPakFile: Display: Parsing crypto keys from a crypto key cache file</span><br><span class="line">LogPakFile: Display: Loading response file C:\Users\lipengzha\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+Program+Files+Epic+Games+UE_4.25\PakList_ThirdPerson425-WindowsNoEditor_0_P.txt</span><br><span class="line">LogPakFile: Display: Added 1559 entries to add to pak file.</span><br><span class="line">LogPakFile: Display: Loading pak order file C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson425\Build\WindowsNoEditor\FileOpenOrder\CookerOpenOrder.log...</span><br><span class="line">LogPakFile: Display: Finished loading pak order file C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson425\Build\WindowsNoEditor\FileOpenOrder\CookerOpenOrder.log.</span><br><span class="line">LogPakFile: Display: Generating patch from C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson425\Releases\1.0.0.0\WindowsNoEditor\ThirdPerson425-WindowsNoEditor*.pak.</span><br><span class="line">LogPakFile: Display: Generated hash for &quot;Engine/Content/Animation/DefaultAnimBoneCompressionSettings.uasset&quot;</span><br><span class="line">LogPakFile: Display: Generated hash for &quot;Engine/Content/Animation/DefaultAnimCurveCompressionSettings.uasset&quot;</span><br><span class="line">LogPakFile: Display: Generated hash for &quot;Engine/Content/Animation/DefaultAnimBoneCompressionSettings.uexp&quot;</span><br><span class="line">LogPakFile: Display: Generated hash for &quot;Engine/Content/Animation/DefaultAnimCurveCompressionSettings.uexp&quot;</span><br><span class="line">LogPakFile: Display: Generated hash for &quot;Engine/GlobalShaderCache-PCD3D_SM5.bin&quot;</span><br><span class="line">LogPakFile: Display: Generated hash for &quot;Engine/Content/Functions/Engine_MaterialFunctions01/Opacity/CameraDepthFade.uasset&quot;</span><br><span class="line">LogPakFile: Display: Generated hash for &quot;Engine/Content/Functions/Engine_MaterialFunctions01/Opacity/CameraDepthFade.uexp&quot;</span><br><span class="line">LogPakFile: Display: Generated hash for &quot;Engine/Content/EngineMaterials/T_Default_Material_Grid_M.uasset&quot;</span><br><span class="line">LogPakFile: Display: Generated hash for &quot;Engine/Content/EngineMaterials/T_Default_Material_Grid_N.uasset&quot;</span><br><span class="line">LogPakFile: Display: Generated hash for &quot;Engine/Content/EngineMaterials/WorldGridMaterial.uasset&quot;</span><br><span class="line">LogPakFile: Display: Generated hash for &quot;Engine/Content/EngineMaterials/DefaultMaterial.uasset&quot;</span><br></pre></td></tr></table></figure>
<p>生成 hash 的函数在 <code>GenerateHashesFromPak</code> 中，位于 <code>PakFileUtilities/Private/PakFileUtilities.cpp</code> 中。<br>其作用是：读取基础包中的文件，计算 hash 值，用作与新 Cook 之后的文件进行比对。</p>
<p>核心的代码在以下部分：</p>
<figure class="highlight cpp"><figcaption><span>PakFileUtilities/Private/PakFileUtilities.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ExecuteUnrealPak</span><span class="params">(<span class="keyword">const</span> TCHAR* CmdLine)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// List of all items to add to pak file</span></span><br><span class="line">  TArray&lt;FPakInputPair&gt; Entries;</span><br><span class="line">  FPakCommandLineParameters CmdLineParameters;</span><br><span class="line">  <span class="built_in">ProcessCommandLine</span>(CmdLine, NonOptionArguments, Entries, CmdLineParameters);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(NonOptionArguments.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">CheckAndReallocThreadPool</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// since this is for creation, we pass true to make it not look in LaunchDir</span></span><br><span class="line">    FString PakFilename = <span class="built_in">GetPakPath</span>(*NonOptionArguments[<span class="number">0</span>], <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// List of all items to add to pak file</span></span><br><span class="line">    TArray&lt;FPakInputPair&gt; Entries;</span><br><span class="line">    FPakCommandLineParameters CmdLineParameters;</span><br><span class="line">    <span class="built_in">ProcessCommandLine</span>(CmdLine, NonOptionArguments, Entries, CmdLineParameters);</span><br><span class="line"></span><br><span class="line">    FPakOrderMap OrderMap;</span><br><span class="line">    FString ResponseFile;</span><br><span class="line">    <span class="keyword">if</span> (FParse::<span class="built_in">Value</span>(CmdLine, <span class="built_in">TEXT</span>(<span class="string">&quot;-order=&quot;</span>), ResponseFile) &amp;&amp; !OrderMap.<span class="built_in">ProcessOrderFile</span>(*ResponseFile))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FString SecondaryResponseFile;</span><br><span class="line">    <span class="keyword">if</span> (FParse::<span class="built_in">Value</span>(CmdLine, <span class="built_in">TEXT</span>(<span class="string">&quot;-secondaryOrder=&quot;</span>), SecondaryResponseFile) &amp;&amp; !OrderMap.<span class="built_in">ProcessOrderFile</span>(*SecondaryResponseFile, <span class="literal">true</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int32 LowestSourcePakVersion = <span class="number">0</span>;</span><br><span class="line">    TMap&lt;FString, FFileInfo&gt; SourceFileHashes;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (CmdLineParameters.GeneratePatch)</span><br><span class="line">    &#123;</span><br><span class="line">      FString OutputPath;</span><br><span class="line">      <span class="keyword">if</span> (!FParse::<span class="built_in">Value</span>(CmdLine, <span class="built_in">TEXT</span>(<span class="string">&quot;TempFiles=&quot;</span>), OutputPath))</span><br><span class="line">      &#123;</span><br><span class="line">        OutputPath = FPaths::<span class="built_in">GetPath</span>(PakFilename) / <span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;TempFiles&quot;</span>));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      IFileManager::<span class="built_in">Get</span>().<span class="built_in">DeleteDirectory</span>(*OutputPath);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Check command line for the &quot;patchcryptokeys&quot; param, which will tell us where to look for the encryption keys that</span></span><br><span class="line">      <span class="comment">// we need to access the patch reference data</span></span><br><span class="line">      FString PatchReferenceCryptoKeysFilename;</span><br><span class="line">      FKeyChain PatchKeyChain;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (FParse::<span class="built_in">Value</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;PatchCryptoKeys=&quot;</span>), PatchReferenceCryptoKeysFilename))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">LoadKeyChainFromFile</span>(PatchReferenceCryptoKeysFilename, PatchKeyChain);</span><br><span class="line">        <span class="built_in">ApplyEncryptionKeys</span>(PatchKeyChain);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">UE_LOG</span>(LogPakFile, Display, <span class="built_in">TEXT</span>(<span class="string">&quot;Generating patch from %s.&quot;</span>), *CmdLineParameters.SourcePatchPakFilename, <span class="literal">true</span> );</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">GenerateHashesFromPak</span>(*CmdLineParameters.SourcePatchPakFilename, *PakFilename, SourceFileHashes, <span class="literal">true</span>, PatchKeyChain, <span class="comment">/*Out*/</span>LowestSourcePakVersion))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">ExtractFilesFromPak</span>(*CmdLineParameters.SourcePatchPakFilename, SourceFileHashes, *OutputPath, <span class="literal">true</span>, PatchKeyChain, <span class="literal">nullptr</span>) == <span class="literal">false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">UE_LOG</span>(LogPakFile, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Unable to extract files from source pak file for patch&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          CmdLineParameters.SourcePatchDiffDirectory = OutputPath;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">ApplyEncryptionKeys</span>(KeyChain);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start collecting files</span></span><br><span class="line">    TArray&lt;FPakInputPair&gt; FilesToAdd;</span><br><span class="line">    <span class="built_in">CollectFilesToAdd</span>(FilesToAdd, Entries, OrderMap, CmdLineParameters);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (CmdLineParameters.GeneratePatch)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// We need to get a list of files that were in the previous patch(&#x27;s) Pak, but NOT in FilesToAdd</span></span><br><span class="line">      TArray&lt;FPakInputPair&gt; DeleteRecords = <span class="built_in">GetNewDeleteRecords</span>(FilesToAdd, SourceFileHashes);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//if the patch is built using old source pak files, we need to handle the special case where a file has been moved between chunks but no delete record was created (this would cause a rogue delete record to be created in the latest pak), and also a case where the file was moved between chunks and back again without being changed (this would cause the file to not be included in this chunk because the file would be considered unchanged)</span></span><br><span class="line">      <span class="keyword">if</span> (LowestSourcePakVersion &lt; FPakInfo::PakFile_Version_DeleteRecords)</span><br><span class="line">      &#123;</span><br><span class="line">        int32 CurrentPatchChunkIndex = <span class="built_in">GetPakChunkIndexFromFilename</span>(PakFilename);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogPakFile, Display, <span class="built_in">TEXT</span>(<span class="string">&quot;Some patch source paks were generated with an earlier version of UnrealPak that didn&#x27;t support delete records. checking for historic assets that have moved between chunks to avoid creating invalid delete records&quot;</span>));</span><br><span class="line">        FString SourcePakFolder = FPaths::<span class="built_in">GetPath</span>(CmdLineParameters.SourcePatchPakFilename);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//remove invalid items from DeleteRecords and set &#x27;bForceInclude&#x27; on some SourceFileHashes</span></span><br><span class="line">        <span class="built_in">ProcessLegacyFileMoves</span>(DeleteRecords, SourceFileHashes, SourcePakFolder, FilesToAdd, CurrentPatchChunkIndex);</span><br><span class="line">      &#125;</span><br><span class="line">      FilesToAdd.<span class="built_in">Append</span>(DeleteRecords);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// if we are generating a patch here we remove files which are already shipped...</span></span><br><span class="line">      <span class="built_in">RemoveIdenticalFiles</span>(FilesToAdd, CmdLineParameters.SourcePatchDiffDirectory, SourceFileHashes, CmdLineParameters.SeekOptParams, CmdLineParameters.ChangedFilesOutputFilename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> bResult = <span class="built_in">CreatePakFile</span>(*PakFilename, FilesToAdd, CmdLineParameters, KeyChain);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (CmdLineParameters.GeneratePatch)</span><br><span class="line">    &#123;</span><br><span class="line">      FString OutputPath = FPaths::<span class="built_in">GetPath</span>(PakFilename) / <span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;TempFiles&quot;</span>));</span><br><span class="line">      <span class="comment">// delete the temporary directory</span></span><br><span class="line">      IFileManager::<span class="built_in">Get</span>().<span class="built_in">DeleteDirectory</span>(*OutputPath, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">GetDerivedDataCacheRef</span>().<span class="built_in">WaitForQuiescence</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bResult;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过分析 UE 的 Patch 机制可以知道，它的版本比对比较粗暴，是直接得到 Pak 中文件的二进制信息计算 Hash 值与当前工程中 Cook 之后的 HASH 值来进行比对的，本质上就是基于二进制的比对，这就需要管理好 DDC 等 COOK 之后生成的文件，我觉得这样是不合理的，所以 HotPatcher 是基于原始资源的 GUID 的比对。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>热更新</category>
      </categories>
      <tags>
        <tag>Release</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 热更新：Create Shader Patch</title>
    <url>/wiki/5867/</url>
    <content><![CDATA[<p>之前的热更新系列文章中介绍了 UE 热更新的流程和打包细节，其实有一些热更补丁优化的工程实践我觉得也可以详细介绍。</p>
<p>本篇文章从生成 Shader 的 Patch 入手，目的减少每次热更新时的 Shader 的大小，并会对引擎内部的实现细节做一些分析，解决引擎中的 Shader Patch 的相关问题，并基于 <a href="https://github.com/hxhb/HotPatcher">HotPatcher</a> 的实现自动化的 Shade Patch 流程。</p>
<span id="more"></span>

<h3 id="shaderbytecode 的生成与加载"><a href="#shaderbytecode 的生成与加载" class="headerlink" title="shaderbytecode 的生成与加载"></a>shaderbytecode 的生成与加载 </h3><p>UE 在<code>Project Settings</code>-<code>Packaging</code> 中提供了 <code>Share Material Shader Code</code> 的选项，可以控制 Shader 的共享，存储为单独的文件中，减少包体的大小。</p>
<blockquote>
<p>By default shader code gets saved inline inside material assets, enabling this option will store only shader code once as individual files This will reduce overall package size but might increase loading time.</p>
</blockquote>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/5867/20210312105039.webp"></p>
<p>当开启这个选项之后打包项目，包内的 <code>Content</code> 目录下会生成以下两个 <code>ushaderbytecode</code> 文件：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/5867/20210312110129.webp"></p>
<p>打包的 Pak 中的 Mount Point 为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">../../../PROJECT_NAME/Content/</span><br></pre></td></tr></table></figure>
<p>而且 ushaderbytecode 文件的命名根据以下规则：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/RenderCore/Private/ShaderCodeLibrary.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> FString ShaderExtension = <span class="built_in">TEXT</span>(<span class="string">&quot;.ushaderbytecode&quot;</span>);</span><br><span class="line"><span class="keyword">static</span> FString StableExtension = <span class="built_in">TEXT</span>(<span class="string">&quot;.scl.csv&quot;</span>);</span><br><span class="line"><span class="keyword">static</span> FString PipelineExtension = <span class="built_in">TEXT</span>(<span class="string">&quot;.ushaderpipelines&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> FString <span class="title">GetCodeArchiveFilename</span><span class="params">(<span class="keyword">const</span> FString&amp; BaseDir, <span class="keyword">const</span> FString&amp; LibraryName, FName Platform)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> BaseDir / FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ShaderArchive-%s-&quot;</span>), *LibraryName) + Platform.<span class="built_in">ToString</span>() + ShaderExtension;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ushaderbytecode 在引擎启动时会自动加载，但是注意 Global 和项目两者加载时机的区别：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/Launch/Private/LaunchEngineLoop.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function">int32 <span class="title">FEngineLoop::PreInitPreStartupScreen</span><span class="params">(<span class="keyword">const</span> TCHAR* CmdLine)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">bool</span> bUseCodeLibrary = FPlatformProperties::<span class="built_in">RequiresCookedData</span>() || GAllowCookedDataInEditorBuilds;</span><br><span class="line">    <span class="keyword">if</span> (bUseCodeLibrary)</span><br><span class="line">    &#123;</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;FShaderCodeLibrary::InitForRuntime&quot;</span>);</span><br><span class="line">        <span class="comment">// Will open material shader code storage if project was packaged with it</span></span><br><span class="line">        <span class="comment">// This only opens the Global shader library, which is always in the content dir.</span></span><br><span class="line">        FShaderCodeLibrary::<span class="built_in">InitForRuntime</span>(GMaxRHIShaderPlatform); <span class="comment">// 加载 Global 的 ushaderbytecode</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">if</span> !UE_EDITOR</span></span><br><span class="line">      <span class="comment">// Cooked data only - but also requires the code library - game only</span></span><br><span class="line">      <span class="keyword">if</span> (FPlatformProperties::<span class="built_in">RequiresCookedData</span>())</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;FShaderPipelineCache::Initialize&quot;</span>);</span><br><span class="line">        <span class="comment">// Initialize the pipeline cache system. Opening is deferred until the manual call to</span></span><br><span class="line">        <span class="comment">// OpenPipelineFileCache below, after content pak&#x27;s ShaderCodeLibraries are loaded.</span></span><br><span class="line">        FShaderPipelineCache::<span class="built_in">Initialize</span>(GMaxRHIShaderPlatform);</span><br><span class="line">      &#125;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">//!UE_EDITOR</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">int32 <span class="title">FEngineLoop::PreInitPostStartupScreen</span><span class="params">(<span class="keyword">const</span> TCHAR* CmdLine)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">//Handle opening shader library after our EarlyLoadScreen</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">LLM_SCOPE</span>(ELLMTag::Shaders);</span><br><span class="line">    <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;FShaderCodeLibrary::OpenLibrary&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Open the game library which contains the material shaders.</span></span><br><span class="line">    FShaderCodeLibrary::<span class="built_in">OpenLibrary</span>(FApp::<span class="built_in">GetProjectName</span>(), FPaths::<span class="built_in">ProjectContentDir</span>()); <span class="comment">// 加载项目的 ushaderbytecode</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> FString&amp; RootDir : FPlatformMisc::<span class="built_in">GetAdditionalRootDirectories</span>())</span><br><span class="line">    &#123;</span><br><span class="line">      FShaderCodeLibrary::<span class="built_in">OpenLibrary</span>(FApp::<span class="built_in">GetProjectName</span>(), FPaths::<span class="built_in">Combine</span>(RootDir, FApp::<span class="built_in">GetProjectName</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;Content&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now our shader code main library is opened, kick off the precompile, if already initialized</span></span><br><span class="line">    FShaderPipelineCache::<span class="built_in">OpenPipelineFileCache</span>(GMaxRHIShaderPlatform);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>综上所述，引擎打包对于 Shader 的处理需要注意以下两点：</p>
<ol>
<li>打包项目是会只把当前打包的资源的 Shader 编译到 ushaderbytecode 中</li>
<li>引擎启动时会自动加载</li>
</ol>
<p>所以，如果我们进行热更新资源时有 shader 的变动或者新增了，如果不把 shaderbytecode 打包进来，会导致有些资源没有效果，如图：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/pak-shadercode-error-in-ue425.webp"></p>
<p>Log 中的错误：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/5867/shader-bytecode-error.webp"></p>
<p>这就需要我们去处理更新 Shader 的情况。</p>
<h3 id="Shader 的热更新"><a href="#Shader 的热更新" class="headerlink" title="Shader 的热更新"></a>Shader 的热更新 </h3><p> 根据前面一小节的介绍，我们知道了打包时会自动把 <strong> 所打包资源 </strong> 的 Shader 生成到 ushaderbytecode 文件中，当我们热更时新增了材质，需要把新的 shader 文件给打到 pak 中，在运行时加载，不然会丢失材质效果。</p>
<p>在 <a href="https://github.com/hxhb/HotPatcher">HotPatcher</a> 中提供了包含 shaderbytecode 的选项，会把 Cook 之后最新生成的 ushaderbytecode 打包到 pak 中：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/5867/20210312124711.webp"></p>
<p>并且 Monut Point 与基础包的相同。</p>
<p>当我们挂载热更的 pak 时，需要 pak order 大于基础包中的 pak，这样我们热更的 pak 中的 ushaderbytecode 就是优先级最高的，但是因为前面也已经提到了，引擎启动时就已经自动加载了基础包中的 shaderbytecode，当程序运行起来之后挂载的 pak 中的 shaderbytecode 就不会被自动加载，这需要在挂载 pak 之后自己执行：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UFlibPatchParserHelper::ReloadShaderbytecode</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FShaderCodeLibrary::<span class="built_in">OpenLibrary</span>(<span class="string">&quot;Global&quot;</span>, FPaths::<span class="built_in">ProjectContentDir</span>());</span><br><span class="line">	FShaderCodeLibrary::<span class="built_in">OpenLibrary</span>(FApp::<span class="built_in">GetProjectName</span>(), FPaths::<span class="built_in">ProjectContentDir</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用 <code>FShaderCodeLibrary::OpenLibrary</code> 函数即可。</p>
<p>综上所述，我们热更 shader 时的流程如下：</p>
<ol>
<li>执行 Cook 生成包含最新资源的 ushaderbytecode 文件</li>
<li>打包 ushaderbytecode 到 pak 中</li>
<li>手动加载 ushaderbytecode</li>
</ol>
<p>重新生成 ushaderbytecode 可以直接使用以下 cook 命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">UE4Editor-cmd.exe PROJECT_NAME.uproject -run=cook -targetplatform=WindowsNoEditor -Iterate -UnVersioned -Compressed</span><br></pre></td></tr></table></figure>
<p>其实它会 rebuild metadata，AssetRegistry 之类的都会重新生成。<br>执行完毕之后 <code> Saved/Cooked</code> 下的 <code>AssetRegistry.bin</code>以及 <code>Metadate</code> 目录 <code>/Content/ShaderArchive-*.ushaderbytecode</code>以及 <code>Ending/GlobalShaderCache*.bin</code>等文件都是生成之后最新的了，可以在之后通过 HotPatcher 来打包他们了。</p>
<h3 id="Shader-Patch 的生成"><a href="#Shader-Patch 的生成" class="headerlink" title="Shader Patch 的生成"></a>Shader Patch 的生成 </h3><p> 但是，上一节的介绍其实是每次热更都需要完整地把 shaderbytecode 更新，其实是有点浪费的，因为基础包中的 shader 已经存在了，没必要我们每次更新还要把已有的包含进来，而且到项目后期 Shader 的占用会很大，甚至有的能达到几百 M，如果每次资源变动的热更都要包含几百 M 这肯定是不行的，所以也需要对 Shader 进行 Patch，实现增量更新的目的。</p>
<p>UE 中在 4.23+ 中开始提供了创建 ShaderPatch 的方法，需要提供 Old Metadata 和 New Metadata 的目录，<code>Metadata</code>必须要具有以下目录结构：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\Unreal Projects\Blank425\Saved\Cooked\WindowsNoEditor\Blank425\Metadata&gt;tree /a /f</span><br><span class="line">卷 Windows 的文件夹 PATH 列表 </span><br><span class="line"> 卷序列号为 0C49-9EA3</span><br><span class="line">C:.</span><br><span class="line">|   BulkDataInfo.ubulkmanifest</span><br><span class="line">|   CookedIniVersion.txt</span><br><span class="line">|   DevelopmentAssetRegistry.bin</span><br><span class="line">|</span><br><span class="line">\---ShaderLibrarySource</span><br><span class="line">        ShaderArchive-Global-PCD3D_SM5.ushaderbytecode</span><br><span class="line">        ShaderArchive-Blank425-PCD3D_SM5.ushaderbytecode</span><br></pre></td></tr></table></figure>
<p>需要在打基础包时备份好当时的 Metadata 目录，把最新的工程在执行 Cook 之后的 Metadata 目录作为 New Metadata，基础包的作为 Old Metadata，调用引擎中的 <code>FShaderCodeLibrary::CreatePatchLibrary</code> 函数，但是这个函数在不同的引擎版本中原型有差异，可以实现一层封装：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UFlibShaderPatchHelper::CreateShaderCodePatch</span><span class="params">(TArray&lt;FString&gt; <span class="keyword">const</span>&amp; OldMetaDataDirs, FString <span class="keyword">const</span>&amp; NewMetaDataDir, FString <span class="keyword">const</span>&amp; OutDir, <span class="keyword">bool</span> bNativeFormat)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ENGINE_MINOR_VERSION &gt; 25</span></span><br><span class="line">	<span class="keyword">return</span> FShaderCodeLibrary::<span class="built_in">CreatePatchLibrary</span>(OldMetaDataDirs,NewMetaDataDir,OutDir,bNativeFormat,<span class="literal">true</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">if</span> ENGINE_MINOR_VERSION &gt; 23</span></span><br><span class="line">		<span class="keyword">return</span> FShaderCodeLibrary::<span class="built_in">CreatePatchLibrary</span>(OldMetaDataDirs,NewMetaDataDir,OutDir,bNativeFormat);</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>FShaderCodeLibrary::CreatePatchLibrary</code>内部的实现原理是，从 Old Metadata 序列化出旧的 Shader 数据，与 New Metadata 的做比对，有差异的部分作为 Patch 中的 Shader。</p>
<p>HotPatcher 中提供了 Shader Patch 的配置和管理方法：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/5867/20210312131743.webp"></p>
<p>可以同时指定多个平台以及 Metadata 的目录参数，并且支持 commandlet。</p>
<h3 id="4-25-ShaderPatch-Crash"><a href="#4-25-ShaderPatch-Crash" class="headerlink" title="4.25+ ShaderPatch Crash"></a>4.25+ ShaderPatch Crash</h3><p><strong>注意 </strong>，引擎中提供的<code>FShaderCodeLibrary::CreatePatchLibrary</code> 在 4.25 中有 bug，会导致生成 Patch 时的 Crash，下面写一下解决方案。</p>
<p>在 4.25 引擎版本中调用 <code>FShaderCodeLibrary::CreatePatchLibrary</code> 来创建 ShaderCode Patch 会触发 check 抛异常：<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201211125932.webp"></p>
<p>这是因为 <code>FEditorShaderCodeArchive</code> 的构造函数中调用了 ShaderHashTable 的 Initialize，并给了默认值<code>0x1000</code>：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">FEditorShaderCodeArchive</span>(FName InFormat)</span><br><span class="line">    : <span class="built_in">FormatName</span>(InFormat)</span><br><span class="line">    , <span class="built_in">Format</span>(<span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">  Format = <span class="built_in">GetTargetPlatformManagerRef</span>().<span class="built_in">FindShaderFormat</span>(InFormat);</span><br><span class="line">  <span class="built_in">check</span>(Format);</span><br><span class="line"></span><br><span class="line">  SerializedShaders.ShaderHashTable.<span class="built_in">Initialize</span>(<span class="number">0x10000</span>);</span><br><span class="line">  SerializedShaders.ShaderMapHashTable.<span class="built_in">Initialize</span>(<span class="number">0x10000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201211125525.webp"></p>
<p>导致在后续的流程中 (<code>FSerializedShaderArchive::Serialize</code>) 调用 <code>Initialize</code> 的时候 check 失败了(因为 HaseSize 已经有值了，并不是 0，对其再调用 Initialize 就触发了 check)：<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201211130200.webp"></p>
<p>查了下 <code>FEditorShaderCodeArchive</code> 构造函数中调用 <code>Initialize</code> 的代码是在 4.25 之后的引擎版本才有的，所以影响到的之后 4.25+ 的版本。<br>代码对比：</p>
<ul>
<li><a href="https://github.com/EpicGames/UnrealEngine/blob/4.24.3-release/Engine/Source/Runtime/RenderCore/Private/ShaderCodeLibrary.cpp#L922">4.24.3-release/Engine/Source/Runtime/RenderCore/Private/ShaderCodeLibrary.cpp#L922</a></li>
<li><a href="https://github.com/EpicGames/UnrealEngine/blob/4.25.0-release/Engine/Source/Runtime/RenderCore/Private/ShaderCodeLibrary.cpp#L801">4.25.0-release/Engine/Source/Runtime/RenderCore/Private/ShaderCodeLibrary.cpp#L801</a></li>
</ul>
<p>解决方案：把 <code>FSerializedShaderArchive::Serialize</code> 中<code>ShaderMapHashTable</code>的 <code>Initialize</code> 和<code>ShaderHashTable</code>的 <code>Initialize</code> 在 Editor 下注释掉，因为 <code>FEditorShaderCodeArchive</code> 的代码只在 Editor 下有效，并且是只在生成 ShaderPatch 时有用。</p>
<p>这就造成了以下几个问题：</p>
<ol>
<li><code>FEditorShaderCodeArchive</code>的构造只有 Eidotor 并且 ShaderPatch 是才有用，也就意味着这里写的 <code>ShaderMapHashTable</code> 的<code>Initialize</code>和 <code>ShaderHashTable</code> 的<code>Initialize</code>只有在创建 ShaderPatch 时才会执行</li>
<li>在打基础包时执行 Cook 会编译 shader，但是不会执行 FEditorShaderCodeArchive 的构造，<code>ShaderMapHashTable</code>的 <code>Initialize</code> 和<code>ShaderHashTable</code>的 <code>Initialize</code> 也就不会执行，就需要在使用的地方来调用它们的初始化</li>
</ol>
<p>这也是 UE 中没有管理好这两个状态的地方：在 <code>FEditorShaderCodeArchive</code> 和<code>FSerializedShaderArchive::Serialize</code>中都做了 Initialize 的操作，在打基础包时造成了 <code>ShaderMapHashTable</code> 和<code>ShaderHashTable</code>的 <code>Initialize</code> 已经被 <code>FEditorShaderCodeArchive</code> 初始化的情况下又被 <code>FSerializedShaderArchive::Serialize</code> 执行了一遍，导致 Crash，但是我们又不能粗暴地把任何一处的初始化操作去掉，只能通过检测 <code>ShaderMapHashTable</code> 和<code>ShaderHashTable</code>的 <code>Initialize</code> 是否已经被执行，来选择性的跳过。</p>
<p>阅读代码可以知道 <code>ShaderMapHashTable</code> 和<code>ShaderHashTable</code>的 <code>Initialize</code> 只应该执行一次，并且初始化之后 HashSize 和 IndexSize 应该具有非 0 值：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/Core/Public/Containers/HashTable.h</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function">FORCEINLINE <span class="keyword">void</span> <span class="title">FHashTable::Initialize</span><span class="params">(uint32 InHashSize, uint32 InIndexSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">check</span>(HashSize == <span class="number">0u</span>);</span><br><span class="line">  <span class="built_in">check</span>(IndexSize == <span class="number">0u</span>);</span><br><span class="line"></span><br><span class="line">  HashSize = InHashSize;</span><br><span class="line">  IndexSize = InIndexSize;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">check</span>(HashSize &lt;= <span class="number">0x10000</span>);</span><br><span class="line">  <span class="built_in">check</span>(FMath::<span class="built_in">IsPowerOfTwo</span>(HashSize));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (IndexSize)</span><br><span class="line">  &#123;</span><br><span class="line">    HashMask = (uint16)(HashSize - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    Hash = <span class="keyword">new</span> uint32[HashSize];</span><br><span class="line">    NextIndex = <span class="keyword">new</span> uint32[IndexSize];</span><br><span class="line"></span><br><span class="line">    FMemory::<span class="built_in">Memset</span>(Hash, <span class="number">0xff</span>, HashSize * <span class="number">4</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>Initialize</code> 时会检测当前的 <code>HashSize</code> 和<code>IndexSize</code>是否为 0，并在之后进行赋值。所以，我们只要获取 <code>FHashTable</code> 的<code>HashSize</code>和 <code>IndexSize</code> 检测它们是否为 0 即可判断当前的 <code>HashTable</code> 对象是否已经被 <code>Initialize</code> 过，但是，UE 里的 <code>FHashTable</code> 里这两个成员都是 <code>protected</code> 的，只能修改引擎来实现了：</p>
<p>添加获取 <code>FHashTable</code> 的<code>HashSize</code>和 <code>IndexSize</code> 属性的成员函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FHashTable</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="function">FORCEINLINE uint32 <span class="title">GetHashSize</span><span class="params">()</span><span class="keyword">const</span></span>&#123;<span class="keyword">return</span> HashSize;&#125;;</span><br><span class="line">  <span class="function">FORCEINLINE uint32 <span class="title">GetIndexSize</span><span class="params">()</span><span class="keyword">const</span></span>&#123;<span class="keyword">return</span> IndexSize;&#125;;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>然后在 <code>FSerializedShaderArchive::Serialize</code> 进行检测，如果已被初始化则跳过 <code>Initialize</code> 逻辑：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/RenderCore/Private/ShaderCodeArchive.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FSerializedShaderArchive::Serialize</span><span class="params">(FArchive&amp; Ar)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Ar &lt;&lt; ShaderMapHashes;</span><br><span class="line">  Ar &lt;&lt; ShaderHashes;</span><br><span class="line">  Ar &lt;&lt; ShaderMapEntries;</span><br><span class="line">  Ar &lt;&lt; ShaderEntries;</span><br><span class="line">  Ar &lt;&lt; PreloadEntries;</span><br><span class="line">  Ar &lt;&lt; ShaderIndices;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">check</span>(ShaderHashes.<span class="built_in">Num</span>() == ShaderEntries.<span class="built_in">Num</span>());</span><br><span class="line">  <span class="built_in">check</span>(ShaderMapHashes.<span class="built_in">Num</span>() == ShaderMapEntries.<span class="built_in">Num</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (Ar.<span class="built_in">IsLoading</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">    <span class="keyword">auto</span> ShaderHashInitialized = [](<span class="keyword">const</span> FHashTable&amp; HashTable)-&gt;<span class="keyword">bool</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> HashTable.<span class="built_in">GetHashSize</span>() || HashTable.<span class="built_in">GetIndexSize</span>();</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">const</span> uint32 HashSize = FMath::Min&lt;uint32&gt;(<span class="number">0x10000</span>, <span class="number">1u</span> &lt;&lt; FMath::<span class="built_in">CeilLogTwo</span>(ShaderMapHashes.<span class="built_in">Num</span>()));</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">      <span class="keyword">if</span>(!<span class="built_in">ShaderHashInitialized</span>(ShaderMapHashTable))</span><br><span class="line">      &#123;</span><br><span class="line">        ShaderMapHashTable.<span class="built_in">Initialize</span>(HashSize, ShaderMapHashes.<span class="built_in">Num</span>());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">for</span> (int32 Index = <span class="number">0</span>; Index &lt; ShaderMapHashes.<span class="built_in">Num</span>(); ++Index)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">const</span> uint32 Key = <span class="built_in">GetTypeHash</span>(ShaderMapHashes[Index]);</span><br><span class="line">        ShaderMapHashTable.<span class="built_in">Add</span>(Key, Index);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">const</span> uint32 HashSize = FMath::Min&lt;uint32&gt;(<span class="number">0x10000</span>, <span class="number">1u</span> &lt;&lt; FMath::<span class="built_in">CeilLogTwo</span>(ShaderHashes.<span class="built_in">Num</span>()));</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">      <span class="keyword">if</span>(!<span class="built_in">ShaderHashInitialized</span>(ShaderHashTable))</span><br><span class="line">      &#123;</span><br><span class="line">        ShaderHashTable.<span class="built_in">Initialize</span>(HashSize, ShaderHashes.<span class="built_in">Num</span>());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">for</span> (int32 Index = <span class="number">0</span>; Index &lt; ShaderHashes.<span class="built_in">Num</span>(); ++Index)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">const</span> uint32 Key = <span class="built_in">GetTypeHash</span>(ShaderHashes[Index]);</span><br><span class="line">        ShaderHashTable.<span class="built_in">Add</span>(Key, Index);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样可以统一 ShaderPatch 和 Runtime 的 HashTable 的 Initialize 流程。</p>
<h3 id="Shader-Patch 的自动化流程"><a href="#Shader-Patch 的自动化流程" class="headerlink" title="Shader Patch 的自动化流程"></a>Shader Patch 的自动化流程</h3><p>HotPatcher 中支持了 Shade Patch 的配置化 Commandlet 功能，可以通过配置文件执行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">UE4Editor.exe PROJECT.uproject -run=HotShaderPatch -config=<span class="string">&quot;export-shaderpatch-config.json&quot;</span></span><br></pre></td></tr></table></figure>

<p> <code>-config</code> 参数所接收的文件都可以从编辑器中通过插件导出。</p>
<p>并且也支持在命令行上的参数替换，与 HotRelease 和 HotPatcher 的 Commandlet 功能类似，这里不再赘述，可以直接去看 HotPatcher 的文档介绍：</p>
<ul>
<li><a href="https://imzlp.com/posts/17590/#Commandlet">UE4 资源热更打包工具 HotPatcher#Commandlet</a></li>
</ul>
<p>只需要管理好项目每次版本的 Metadata 目录，就可以编辑一份通用的配置文件导出，在每次 HotPatcher 的 Patch 任务前执行生成 Shader 的 Patch 文件，以外部文件的形式添加至 HotPatcher 的配置中即可。剩下的事情就是运行时加载 Shader Patch 的文件了，插件中同样做了函数库的支持：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UFlibPatchParserHelper::LoadShaderbytecode</span><span class="params">(<span class="keyword">const</span> FString&amp; LibraryName, <span class="keyword">const</span> FString&amp; LibraryDir)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="注意事项"><a href="# 注意事项" class="headerlink" title="注意事项"></a>注意事项 </h3><p> 在 Shader Patch 的使用中需要注意的是：生成出来的 ShaderPatch 的 <code>ushaderbytecode</code> 文件是与基础包内的文件名一致的，所以不能使用引擎启动时的默认挂载（会导致基础包内的 ushaderbytecode 文件无法被加载，从而 crash）。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/auto-mount-shaderpatch-crash.webp"></p>
<p>应该按照前文的介绍在挂载之后自己处理 ShaderPatch 的 ushaderbytecode 文件的加载。</p>
<p><strong>并且 </strong>：ShaderPatch 的更新不<strong> 直接支持</strong>Patch 的迭代，如：1.0 Metadata + 1.1 的 ShaderPatch，并不能生成 1.2 的 ShaderPatch，必须要基于 1.1 的完整 Metadata 才可以，即每次 Patch 必须要基于上一次完整的 Metadate 数据（Project 和 Global 的 ushaderbytecode 文件），在工程管理上每次打包都需要把完整的 Metadata 收集起来。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>热更新</category>
      </categories>
      <tags>
        <tag>HotPatcher</tag>
        <tag>热更新</tag>
        <tag>Shader Patch</tag>
        <tag>ushaderbytecode</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 热更新：Questions &amp; Answers</title>
    <url>/wiki/16895/</url>
    <content><![CDATA[<p><a href="https://github.com/hxhb/HotPatcher">HotPatcher</a>项目开源这一年多以来，经过了不少的更新和优化，也被越来越多的开发者选择作为自己项目的热更新方案，期间有不少人陆陆续续询问 UE4 热更新相关遇到的问题，很多问题比较常见，重复询问的频率也比较多，所以我准备把一些常见的问题进行整理，方便初步上手 UE4 热更新方案的人能够尽快地排查问题。</p>
<p>本篇文章会持续更新 UE4 热更新和 <a href="https://github.com/hxhb/HotPatcher">HotPatcher</a> 相关的 Q&amp;A 内容，有疑问的地方也可以直接在本篇文章中评论，我会定期统一回答和整理，也可以加入我的 UE4 热更新群讨论遇到的问题(QQ 群 958363331)。</p>
<span id="more"></span>

<h2 id="HotPatcher 相关问题"><a href="#HotPatcher 相关问题" class="headerlink" title="HotPatcher 相关问题"></a>HotPatcher 相关问题</h2><ol>
<li><p>是否可以用在商业项目中？<br>可以，使用的是 MIT 开源协议。</p>
</li>
<li><p>是否可以热更 C++？<br>不能，只能用来更新 uasset 和 Non-Asset（lua/db/json 等等）。</p>
</li>
<li><p>支持移动端热更吗？<br>支持，本身 <a href="https://github.com/hxhb/HotPatcher">HotPatcher</a> 是没有平台限制的，可以打包和管理 UE 支持的任意平台。</p>
</li>
</ol>
<p>注意：使用 HotPatcher 打包时，需要避免一个目录既包含 uasset 又包含 non-asset 的情况，不然会导致未被 cook 的 uasset 打包。</p>
<h2 id="热更新系列文章"><a href="# 热更新系列文章" class="headerlink" title="热更新系列文章"></a>热更新系列文章 </h2><p> 我写的 UE4 热更新的系列文章，可以作为工程实践的参考：</p>
<ul>
<li><a href="https://imzlp.com/posts/17371">UE4 热更新：需求分析与方案设计</a></li>
<li><a href="https://imzlp.com/posts/17590/">UE4 资源热更打包工具 HotPatcher</a></li>
<li><a href="https://imzlp.com/posts/10938/">UE4 热更新：基于 HotPatcher 的自动化流程</a></li>
<li><a href="https://imzlp.com/posts/11043/">2020 Unreal Open Day</a></li>
<li><a href="https://imzlp.com/posts/13765/">UE4 热更新：拆分基础包</a></li>
<li><a href="https://imzlp.com/posts/3675">UE4 热更新：资产管理与审计工具</a></li>
<li><a href="https://imzlp.com/posts/5867/">UE4 热更新：Create Shader Patch</a></li>
<li><a href="https://imzlp.com/posts/16895/">UE4 热更新：Questions &amp; Answers</a></li>
</ul>
<h2 id="pak 的自动挂载目录"><a href="#pak 的自动挂载目录" class="headerlink" title="pak 的自动挂载目录"></a>pak 的自动挂载目录 </h2><p> 以下三个路径中的 Pak 会在引擎启动时自动挂载：</p>
<ul>
<li>Engine/Content/Paks</li>
<li>GAME_DIR/Content/Paks</li>
<li>GAME_DIR/Saved/Paks</li>
</ul>
<figure class="highlight cpp"><figcaption><span>Runtime\PakFile\Private\IPlatformFilePak.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FPakPlatformFile::GetPakFolders</span><span class="params">(<span class="keyword">const</span> TCHAR* CmdLine, TArray&lt;FString&gt;&amp; OutPakFolders)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !UE_BUILD_SHIPPING</span></span><br><span class="line">  <span class="comment">// Command line folders</span></span><br><span class="line">  FString PakDirs;</span><br><span class="line">  <span class="keyword">if</span> (FParse::<span class="built_in">Value</span>(CmdLine, <span class="built_in">TEXT</span>(<span class="string">&quot;-pakdir=&quot;</span>), PakDirs))</span><br><span class="line">  &#123;</span><br><span class="line">    TArray&lt;FString&gt; CmdLineFolders;</span><br><span class="line">    PakDirs.<span class="built_in">ParseIntoArray</span>(CmdLineFolders, <span class="built_in">TEXT</span>(<span class="string">&quot;*&quot;</span>), <span class="literal">true</span>);</span><br><span class="line">    OutPakFolders.<span class="built_in">Append</span>(CmdLineFolders);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// @todo plugin urgent: Needs to handle plugin Pak directories, too</span></span><br><span class="line">  <span class="comment">// Hardcoded locations</span></span><br><span class="line">  OutPakFolders.<span class="built_in">Add</span>(FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%sPaks/&quot;</span>), *FPaths::<span class="built_in">ProjectContentDir</span>()));</span><br><span class="line">  OutPakFolders.<span class="built_in">Add</span>(FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%sPaks/&quot;</span>), *FPaths::<span class="built_in">ProjectSavedDir</span>()));</span><br><span class="line">  OutPakFolders.<span class="built_in">Add</span>(FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%sPaks/&quot;</span>), *FPaths::<span class="built_in">EngineContentDir</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这三个路径下的 pak 的默认优先级不同（除非通过_1_P.pak 这种形式命名）：</p>
<figure class="highlight cpp"><figcaption><span>Runtime\PakFile\Private\IPlatformFilePak.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function">int32 <span class="title">FPakPlatformFile::GetPakOrderFromPakFilePath</span><span class="params">(<span class="keyword">const</span> FString&amp; PakFilePath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (PakFilePath.<span class="built_in">StartsWith</span>(FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%sPaks/%s-&quot;</span>), *FPaths::<span class="built_in">ProjectContentDir</span>(), FApp::<span class="built_in">GetProjectName</span>())))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (PakFilePath.<span class="built_in">StartsWith</span>(FPaths::<span class="built_in">ProjectContentDir</span>()))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (PakFilePath.<span class="built_in">StartsWith</span>(FPaths::<span class="built_in">EngineContentDir</span>()))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (PakFilePath.<span class="built_in">StartsWith</span>(FPaths::<span class="built_in">ProjectSavedDir</span>()))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Mount-Point 的作用"><a href="#Mount-Point 的作用" class="headerlink" title="Mount Point 的作用"></a>Mount Point 的作用 </h2><p> 在 Mount Pak 的时候，有一个参数可以指定 MountPoint:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Mounts a pak file at the specified path.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* @param InPakFilename Pak filename.</span></span><br><span class="line"><span class="comment">* @param InPath Path to mount the pak at.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Mount</span><span class="params">(<span class="keyword">const</span> TCHAR* InPakFilename, uint32 PakOrder, <span class="keyword">const</span> TCHAR* InPath = <span class="literal">NULL</span>, <span class="keyword">bool</span> bLoadIndex = <span class="literal">true</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>那么它是干什么的呢？<br>首先从 Mount 函数开始：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (InPath != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  Pak-&gt;<span class="built_in">SetMountPoint</span>(InPath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果在调用 Mount 时传递了 <code>InPath</code>，则通过加载 Pak 的 FPakFile 实例调用<code>SetMountPoint</code>，把 InPath 设置给它。<br> 其实在 FPakFile 中，MountPath 是有默认值的（从 Pak 文件中读取），在 FPakFile 的构造函数中调用了 <code>Initialize(Reader, bLoadIndex);</code>，Initialize 中又调用了<code>LoadIndex</code>，在<code>LoadIndex</code> 中从 Pak 中读取 Pak 的 Mount Point 的逻辑：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime/PakFile/Private/IPlatformFilePak.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FPakFile::LoadIndex</span><span class="params">(FArchive* Reader)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (CachedTotalSize &lt; (Info.IndexOffset + Info.IndexSize))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">UE_LOG</span>(LogPakFile, Fatal, <span class="built_in">TEXT</span>(<span class="string">&quot;Corrupted index offset in pak file.&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (Info.Version &gt;= FPakInfo::PakFile_Version_FrozenIndex &amp;&amp; Info.bIndexIsFrozen)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;PakFile_LoadFrozen&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// read frozen data</span></span><br><span class="line">      Reader-&gt;<span class="built_in">Seek</span>(Info.IndexOffset);</span><br><span class="line">      int32 FrozenSize = Info.IndexSize;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// read in the index, etc data in one lump</span></span><br><span class="line">      <span class="keyword">void</span>* DataMemory = FMemory::<span class="built_in">Malloc</span>(FrozenSize);</span><br><span class="line">      Reader-&gt;<span class="built_in">Serialize</span>(DataMemory, FrozenSize);</span><br><span class="line">      Data = TUniquePtr&lt;FPakFileData&gt;((FPakFileData*)DataMemory);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// cache the number of entries</span></span><br><span class="line">      NumEntries = Data-&gt;Files.<span class="built_in">Num</span>();</span><br><span class="line">      <span class="comment">// @todo loadtime: it is nice to serialize the mountpoint right into the Data so that IndexSize is right here</span></span><br><span class="line">      <span class="comment">// but it takes this to copy it out, because it&#x27;s too painful for the string manipulation when dealing with</span></span><br><span class="line">      <span class="comment">// MemoryImageString everywhere MountPoint is used</span></span><br><span class="line">      MountPoint = Data-&gt;MountPoint;</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单的可以理解为：如果 Mount 时不传递 Mount Point 就会从 Pak 文件中读取，如果有传入就设置为传入的值（Pak 文件中的 MountPoint 是 Pak 中所有文件的公共路径）。</p>
<p>那么，给 Pak 设置 MountPoint 的作用是什么呢？<br>真实目的是，检测要加载的文件是否存在于当前 Pak 中！因为 Pak 的 Mount Point 的默认含义是当前 Pak 中所有文件的公共路径，所以只需要检测要读取的文件是否以这个路径开头，就可以首先排除掉基础路径不对的文件（基础路径都不对，意味着这个文件在 Pak 中也不存在）。</p>
<p>具体逻辑可以看这个函数的实现：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime/PakFile/Public/IPlatformFilePak.h</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Finds a file in the specified pak files.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* @param Paks Pak files to find the file in.</span></span><br><span class="line"><span class="comment">* @param Filename File to find in pak files.</span></span><br><span class="line"><span class="comment">* @param OutPakFile Optional pointer to a pak file where the filename was found.</span></span><br><span class="line"><span class="comment">* @return Pointer to pak entry if the file was found, NULL otherwise.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">FindFileInPakFiles</span><span class="params">(TArray&lt;FPakListEntry&gt;&amp; Paks,<span class="keyword">const</span> TCHAR* Filename,FPakFile** OutPakFile,FPakEntry* OutEntry = <span class="literal">nullptr</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">FString <span class="title">StandardFilename</span><span class="params">(Filename)</span></span>;</span><br><span class="line">    FPaths::<span class="built_in">MakeStandardFilename</span>(StandardFilename);</span><br><span class="line"></span><br><span class="line">    int32 DeletedReadOrder = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (int32 PakIndex = <span class="number">0</span>; PakIndex &lt; Paks.<span class="built_in">Num</span>(); PakIndex++)</span><br><span class="line">    &#123;</span><br><span class="line">        int32 PakReadOrder = Paks[PakIndex].ReadOrder;</span><br><span class="line">        <span class="keyword">if</span> (DeletedReadOrder != <span class="number">-1</span> &amp;&amp; DeletedReadOrder &gt; PakReadOrder)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//found a delete record in a higher priority patch level, but now we&#x27;re at a lower priority set - don&#x27;t search further back or we&#x27;ll find the original, old file.</span></span><br><span class="line">            <span class="built_in">UE_LOG</span>(LogPakFile, Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;Delete Record: Accepted a delete record for %s&quot;</span>), Filename );</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        FPakFile::EFindResult FindResult = Paks[PakIndex].PakFile-&gt;<span class="built_in">Find</span>(*StandardFilename, OutEntry);</span><br><span class="line">        <span class="keyword">if</span> (FindResult == FPakFile::EFindResult::Found)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (OutPakFile != <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                *OutPakFile = Paks[PakIndex].PakFile;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">UE_CLOG</span>(DeletedReadOrder != <span class="number">-1</span>, LogPakFile, Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;Delete Record: Ignored delete record for %s - found it in %s instead (asset was moved between chunks)&quot;</span>), Filename, *Paks[PakIndex].PakFile-&gt;<span class="built_in">GetFilename</span>());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (FindResult == FPakFile::EFindResult::FoundDeleted)</span><br><span class="line">        &#123;</span><br><span class="line">            DeletedReadOrder = PakReadOrder;</span><br><span class="line">            <span class="built_in">UE_LOG</span>(LogPakFile, Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;Delete Record: Found a delete record for %s in %s&quot;</span>), Filename, *Paks[PakIndex].PakFile-&gt;<span class="built_in">GetFilename</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UE_CLOG</span>(DeletedReadOrder != <span class="number">-1</span>, LogPakFile, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Delete Record: No lower priority pak files looking for %s. (maybe not downloaded?)&quot;</span>), Filename );</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当我们从 Pak 中读取文件时，通过对游戏中所有 Mount 的 Pak 调用 <code>Find</code> 函数，而 <code>FPakFile::Find</code> 的函数就实现了上述我说的逻辑：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime/PakFile/Private/IPlatformFilePak.cpp</span></span><br><span class="line"><span class="function">FPakFile::EFindResult <span class="title">FPakFile::Find</span><span class="params">(<span class="keyword">const</span> FString&amp; Filename, FPakEntry* OutEntry)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">QUICK_SCOPE_CYCLE_COUNTER</span>(PakFileFind);</span><br><span class="line">  <span class="keyword">if</span> (Filename.<span class="built_in">StartsWith</span>(MountPoint))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function">FString <span class="title">Path</span><span class="params">(FPaths::GetPath(Filename))</span></span>;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以，MountPoint 的作用就是在从 Pak 中查找文件时，首先判断文件的路径是否与 Pak 中所有文件的 <strong> 基础路径 </strong> 相匹配（StartWith），如果不存在也就不会进入后续的流程了。</p>
<h2 id="Pak 无法被挂载"><a href="#Pak 无法被挂载" class="headerlink" title="Pak 无法被挂载"></a>Pak 无法被挂载 </h2><p> 在本体包中开启 signature 后，打包出来的 Pak 无法被挂载 <br> 同样是 pak 的 signature 的错误，是因为没有为 pak 生成对应的.sig 文件。<br>Log 中的内容如下:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">LogPakFile: Warning: Couldn&#x27;t find pak signature file &#x27;../../../Pak/Content/Paks/1.0.3_WindowsNoEditor_P.pak&#x27;</span><br><span class="line">LogPakFile: Warning: Unable to create pak &quot;../../../Pak/Content/Paks/1.0.3_WindowsNoEditor_P.pak&quot; handle</span><br><span class="line">LogPakFile: Warning: Failed to mount pak &quot;../../../Pak/Content/Paks/1.0.3_WindowsNoEditor_P.pak&quot;, pak is invalid</span><br></pre></td></tr></table></figure>
<p>这是因为打出本体包时 <code>Project Setting</code>-<code>Crypto</code> 中的 <code>bEnablePakSigning</code> 被设置成了 true，这样对打出来的包里的所有 <code>pak</code> 都会执行校验，目的就是为了确保 <strong> 只有自己打包的 pak 才可以被加载</strong>。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/16895/project-setting-crypto.webp"></p>
<p>相关的代码处理在：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime/PakFile/Private/SignedArchiveReader.cpp</span></span><br><span class="line">FChunkCacheWorker::<span class="built_in">FChunkCacheWorker</span>(FArchive* InReader, <span class="keyword">const</span> TCHAR* Filename)</span><br><span class="line">  : <span class="built_in">Thread</span>(<span class="literal">nullptr</span>)</span><br><span class="line">  , <span class="built_in">Reader</span>(InReader)</span><br><span class="line">  , <span class="built_in">QueuedRequestsEvent</span>(<span class="literal">nullptr</span>)</span><br><span class="line">  , <span class="built_in">ChunkRequestAvailable</span>(<span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">  FString SigFileFilename = FPaths::<span class="built_in">ChangeExtension</span>(Filename, <span class="built_in">TEXT</span>(<span class="string">&quot;sig&quot;</span>));</span><br><span class="line">  FArchive* SigFileReader = IFileManager::<span class="built_in">Get</span>().<span class="built_in">CreateFileReader</span>(*SigFileFilename);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (SigFileReader == <span class="literal">nullptr</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">UE_LOG</span>(LogPakFile, Fatal, <span class="built_in">TEXT</span>(<span class="string">&quot;Couldn&#x27;t find pak signature file &#x27;%s&#x27;&quot;</span>), *SigFileFilename);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Signatures.<span class="built_in">Serialize</span>(*SigFileReader);</span><br><span class="line">  <span class="keyword">delete</span> SigFileReader;</span><br><span class="line">  Signatures.<span class="built_in">DecryptSignatureAndValidate</span>(Filename);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">bool</span> bEnableMultithreading = FPlatformProcess::<span class="built_in">SupportsMultithreading</span>();</span><br><span class="line">  <span class="keyword">if</span> (bEnableMultithreading)</span><br><span class="line">  &#123;</span><br><span class="line">    QueuedRequestsEvent = FPlatformProcess::<span class="built_in">GetSynchEventFromPool</span>();</span><br><span class="line">    ChunkRequestAvailable = FPlatformProcess::<span class="built_in">GetSynchEventFromPool</span>();</span><br><span class="line">    Thread = FRunnableThread::<span class="built_in">Create</span>(<span class="keyword">this</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;FChunkCacheWorker&quot;</span>), <span class="number">0</span>, TPri_BelowNormal);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以，如果在用 HotPatcher 打包 pak 时没有与项目指定相同的加密参数，则导致放入包内的 pak 会加载失败（因为验证失败了）。<br>解决的办法就是，在使用 HotPatcher 时指定与项目相同的加密信息，当直接使用 UE 打出本体包时，会默认在下列路径中生成一个 <code>Crypto.json</code> 文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PROJECT_DIRECTORY\Saved\Cooked\WindowsNoEditor\PROJECT_NAME\Metadata\Crypto.json</span><br></pre></td></tr></table></figure>
<p>它里面的内容是根据 <code>Project Setting</code>-<code>Crypto</code> 中的选项生产的。<br>使用方法为：<br>在 HotPatcher 的 <code>UnrealPak</code> 参数项添加参数：<code>-cryptokeys=&quot;Crypto.json&quot;</code>(在 UE4.23+ 中还需要添加 <code>-sign</code> 参数):<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/16895/hotpatcher-unrealpak-options-sign.webp"></p>
<p>重新生成 Pak 就会在 Pak 的目录里生成与 Pak 同名的 <code>.sig</code> 文件了，把 <code>pak</code> 和<code>sig</code>文件一同拷贝到挂载目录里就可以了。</p>
<p>UnrealPak 的参数可以看我之前的一篇文章：<a href="https://imzlp.com/posts/12143/#UnrealPak%E7%9A%84%E5%8F%82%E6%95%B0">UE4 工具链配置与开发技巧 #UnrealPak 的参数</a></p>
<h2 id="Pak-master-signature-table-check-failed-for-pak"><a href="#Pak-master-signature-table-check-failed-for-pak" class="headerlink" title="Pak master signature table check failed for pak"></a>Pak master signature table check failed for pak</h2><ol>
<li>使用 HotPatcher 打包出来的 pak 在挂载时 Crash 并具有 <em>Pak master signature table check failed for pak</em> 提示</li>
</ol>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/16895/hotpatcher-qa-pak-master-signing-not-match.webp"></p>
<p>这是由于打出本体包的时候在项目设置中设置了 <code>Signing</code> 加密，需要在 HotPatcher 中的 UnrealPak 参数中添加相同的加密参数。</p>
<p>在 <code>IPlatformFilePak.cpp</code> 中的 <code>RegisterPakFile</code> 中，同样做了判断：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime/PakFile/Private/</span></span><br><span class="line"><span class="function">uint16* <span class="title">RegisterPakFile</span><span class="params">(FName File, int64 PakFileSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  uint16* PakIndexPtr = CachedPaks.<span class="built_in">Find</span>(File);</span><br><span class="line">  <span class="keyword">if</span> (!PakIndexPtr)</span><br><span class="line">  &#123;</span><br><span class="line">    FString PakFilename = File.<span class="built_in">ToString</span>();</span><br><span class="line">    <span class="built_in">check</span>(CachedPakData.<span class="built_in">Num</span>() &lt; MAX_uint16);</span><br><span class="line">    IAsyncReadFileHandle* Handle = LowerLevel-&gt;<span class="built_in">OpenAsyncRead</span>(*PakFilename);</span><br><span class="line">    <span class="keyword">if</span> (!Handle)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    CachedPakData.<span class="built_in">Add</span>(<span class="built_in">FPakData</span>(Handle, File, PakFileSize));</span><br><span class="line">    PakIndexPtr = &amp;CachedPaks.<span class="built_in">Add</span>(File, CachedPakData.<span class="built_in">Num</span>() - <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">UE_LOG</span>(LogPakFile, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;New pak file %s added to pak precacher.&quot;</span>), *PakFilename);</span><br><span class="line"></span><br><span class="line">    FPakData&amp; Pak = CachedPakData[*PakIndexPtr];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (SigningKey.<span class="built_in">IsValid</span>())</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// Load signature data</span></span><br><span class="line">      FString SignaturesFilename = FPaths::<span class="built_in">ChangeExtension</span>(*PakFilename, <span class="built_in">TEXT</span>(<span class="string">&quot;sig&quot;</span>));</span><br><span class="line">      IFileHandle* SignaturesFile = LowerLevel-&gt;<span class="built_in">OpenRead</span>(*SignaturesFilename);</span><br><span class="line">      <span class="built_in">ensure</span>(SignaturesFile);</span><br><span class="line">      FArchiveFileReaderGeneric* Reader = <span class="keyword">new</span> <span class="built_in">FArchiveFileReaderGeneric</span>(SignaturesFile, *SignaturesFilename, SignaturesFile-&gt;<span class="built_in">Size</span>());</span><br><span class="line">      Pak.Signatures.<span class="built_in">Serialize</span>(*Reader);</span><br><span class="line">      <span class="keyword">delete</span> Reader;</span><br><span class="line">      Pak.Signatures.<span class="built_in">DecryptSignatureAndValidate</span>(SigningKey, PakFilename);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Check that we have the correct match between signature and pre-cache granularity</span></span><br><span class="line">      int64 NumPakChunks = <span class="built_in">Align</span>(PakFileSize, FPakInfo::MaxChunkDataSize) / FPakInfo::MaxChunkDataSize;</span><br><span class="line">      <span class="built_in">ensure</span>(NumPakChunks == Pak.Signatures.ChunkHashes.<span class="built_in">Num</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> PakIndexPtr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="iOS 热更 metallib 问题"><a href="#iOS 热更 metallib 问题" class="headerlink" title="iOS 热更 metallib 问题"></a>iOS 热更 metallib 问题 </h2><p> 在 4.25 存在不会重新加载 shaderbytecode 的问题，而且引擎内部对加载 metallib 是单独处理的流程，无法服用 usahderbytecode 的流程，所以出 iOS 包尽量使用远程打包的方式，会生成<code>ushaderbytecode</code>，在 4.25 里 LoadLibrary 没有问题，但是如果去加载 metallib 就有问题。</p>
<p>UE 热更 Shader 相关的内容可以看之前的文章：<a href="https://imzlp.com/posts/5867/">UE4 热更新：Create Shader Patch</a></p>
<h2 id="UE4-25-ShaderPatch-Crash"><a href="#UE4-25-ShaderPatch-Crash" class="headerlink" title="UE4.25+ ShaderPatch Crash"></a>UE4.25+ ShaderPatch Crash</h2><p>这是因为在 4.25+ 引擎内部的 bug 导致的，<a href="https://imzlp.com/posts/5867/#4-25-ShaderPatch-Crash">UE4 热更新：Create Shader Patch#4.25+ ShaderPatch Crash</a>](<a href="https://imzlp.com/posts/5867/)%E8%BF%99%E7%AF%87%E6%96%87%E7%AB%A0%E4%B8%AD%E6%8F%90%E4%BE%9B%E4%BA%86%E4%BF%AE%E6%94%B9%E6%96%B9%E6%A1%88%E3%80%82">https://imzlp.com/posts/5867/)这篇文章中提供了修改方案。</a></p>
<h2 id="热更一个不存在的插件中的资源"><a href="# 热更一个不存在的插件中的资源" class="headerlink" title="热更一个不存在的插件中的资源"></a>热更一个不存在的插件中的资源 </h2><p> 打包之后引擎是会从 upluginmanifest 中读取当前工程中具有有哪些插件的，加载插件中的资源先判断插件是否存在，从而实现一个粒度较粗的过滤效果。</p>
<p>所以，当需要把一个在基础包中不存在的插件打包至 pak 中，需要在打包资源的同时需要把项目的 <code>upluginmanifest</code> 文件同步打包，挂载点为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">../../../PROJECT_NAME/Plugins/PROJECT_NAME.upluginmanifest</span><br></pre></td></tr></table></figure>
<p>关于 <code>upluginmanifest</code> 的介绍，可以看我之前的笔记：<a href="https://imzlp.com/notes/ue/#upluginmanifest">UE4#upluginmanifest</a>。</p>
<h2 id="热更的资源没有效果 - 材质丢失"><a href="# 热更的资源没有效果 - 材质丢失" class="headerlink" title="热更的资源没有效果 / 材质丢失"></a>热更的资源没有效果 / 材质丢失 </h2><p> 如果热更蓝图，逻辑没有变化，需要检查资源是否被 Cook，可以手动在 Content Browser 中通过 HotPatcher 中提供的功能对选中资源执行 Cook，也可以在打包 Patch 时勾选 <code>bCookAsset</code> 选项。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/17590/20201031181100.webp"></p>
<p>如果时热更了资源 / 材质，没有效果，需要检查是否把 Shaderbytecode 打包，如果新增材质没有打包 shaderbytecode 是会导致 Shader 获取失败使用默认材质的。<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/pak-shadercode-error-in-ue425.webp"></p>
<p>Log 中的错误：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/5867/shader-bytecode-error.webp"></p>
<p>如果不使用引擎启动时自动挂载 pak 的方式，而是运行时手动 Mount 包含新 shaderbytecode 的 pak，则需要在 mount 之后手动重新加载一遍 shaderbytecode，这样引擎才能够读取到最新的 shader，插件中提供了一个辅助函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ShaderCodeLibrary.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UFlibPatchParserHelper::ReloadShaderbytecode</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FShaderCodeLibrary::<span class="built_in">OpenLibrary</span>(<span class="string">&quot;Global&quot;</span>, FPaths::<span class="built_in">ProjectContentDir</span>());</span><br><span class="line">  FShaderCodeLibrary::<span class="built_in">OpenLibrary</span>(FApp::<span class="built_in">GetProjectName</span>(), FPaths::<span class="built_in">ProjectContentDir</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 mount 之后调用即可。</p>
<h2 id="AssetRegistry 是否必须热更"><a href="#AssetRegistry 是否必须热更" class="headerlink" title="AssetRegistry 是否必须热更"></a>AssetRegistry 是否必须热更 </h2><p> 看需求，如果 Runtime 的代码中有通过 AssetRegistry 模块获取资源的引用关系、检测资源是否存在，需要热更。但是 AssetRegistry 并不是引擎必要的，如果肯定不会在运行时用到，可以去掉它，会节省一点内存。</p>
<p>具体介绍可以看我之前的笔记：<a href="https://imzlp.com/notes/ue/#%E6%8E%A7%E5%88%B6AssetRegistry%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96">UE4# 控制 AssetRegistry 的序列化</a></p>
<h2 id="Android 提示 not-found-uproject"><a href="#Android 提示 not-found-uproject" class="headerlink" title="Android 提示 not found uproject"></a>Android 提示 not found uproject</h2><p>UE 中有一个 BUG，在 4.25.1 引擎版本中可以复现，步骤如下：</p>
<ol>
<li>安装 apk，第一次启动游戏</li>
<li>打开 UE 的沙盒数据目录 <code>UE4Game/PROJECTNAME</code>，在这个目录下创建<code>Content/Paks</code> 目录</li>
<li>重新启动游戏</li>
</ol>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/16895/20210121220607.webp"></p>
<p>Log 中也有 <code>Project file not found: ../../../FGame/FGame.uproject</code> 提示。</p>
<p>在 Android 上自动挂载的 Pak 文件可以放到 <code>Saved/Paks</code> 下，有时间具体分析一下这个问题。</p>
<h2 id="控制资源不打到基础包中"><a href="# 控制资源不打到基础包中" class="headerlink" title="控制资源不打到基础包中"></a>控制资源不打到基础包中 </h2><p> 拆分基础包的实践可看我的这两篇文章：</p>
<ul>
<li><a href="https://imzlp.com/posts/3675/">UE4 热更新：资产管理与审计工具</a></li>
<li><a href="https://imzlp.com/posts/13765/">UE4 热更新：拆分基础包</a></li>
</ul>
<h2 id="分析某个平台的包中的资源"><a href="# 分析某个平台的包中的资源" class="headerlink" title="分析某个平台的包中的资源"></a>分析某个平台的包中的资源 </h2><p> 可以使用 UE 提供的 Asset Audit 工具，需要在每次打包时备份好 Cooked/PLATFORM/PROJECT_NAME/Metadata 目录中的 DevelopmentAssetRegistry.bin 文件。</p>
<p>也可以使用 <a href="https://github.com/jashking/UnrealPakViewer">UnrealPakViewer</a> 来直接加载 Pak 文件。</p>
<p>具体可以看这篇文章的资产审计小节：<a href="https://imzlp.com/posts/3675/#%E8%B5%84%E4%BA%A7%E5%AE%A1%E8%AE%A1">UE4 热更新：资产管理与审计工具 #资产审计</a></p>
<h2 id="UMG 子控件热更不生效"><a href="#UMG 子控件热更不生效" class="headerlink" title="UMG 子控件热更不生效"></a>UMG 子控件热更不生效 </h2><p> 如果 Instanced 的形式引用的 UMG，子 UMG 的变动需要递归包含所有以子控件形式引用的 UMG 资源。我之前在笔记中记录过这个问题：<a href="https://imzlp.com/notes/ue/#UMG%E7%9A%84%E5%AD%90%E6%8E%A7%E4%BB%B6%E5%BC%95%E7%94%A8%E7%83%AD%E6%9B%B4%E9%97%AE%E9%A2%98">UE4#UMG 的子控件引用热更问题</a>。</p>
<p>解决方案：HotPatcher 中具有一个递归分析 UMG 父控件的的选项(bRecursiveWidgetTree)，开启即可。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/16895/20210315103155.webp"></p>
<p>这个问题的具体分析在我 2020 UOD 的演讲中有详细介绍，感兴趣的可以去这里查看视频和 PPT：</p>
<ul>
<li><a href="https://imzlp.com/posts/11043/">2020 Unreal Open Day</a></li>
</ul>
<h2 id="Pak 是否可以跨引擎版本使用"><a href="#Pak 是否可以跨引擎版本使用" class="headerlink" title="Pak 是否可以跨引擎版本使用"></a>Pak 是否可以跨引擎版本使用 </h2><p> 不行，要保持打包和使用的引擎版本一致。</p>
<h2 id="从 A 项目打包给 B 项目使用的 Pak"><a href="# 从 A 项目打包给 B 项目使用的 Pak" class="headerlink" title="从 A 项目打包给 B 项目使用的 Pak"></a>从 A 项目打包给 B 项目使用的 Pak</h2><p>HotPatcher 中做了替换 pakcommand 的功能，可以通过以下参数指定：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/17590/HotPatcher/hotpatcher-pak-options-replace-pak-command-texts.webp"></p>
<p>注意：From 和 To 都必须要包含 <code>../../../</code> 前缀，不然会把文件的绝对路径替换了。</p>
<h2 id="plugin-HotPatcher-faild"><a href="#plugin-HotPatcher-faild" class="headerlink" title="plugin HotPatcher faild"></a>plugin HotPatcher faild</h2><p>打包之后又如下提示：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/16895/20210419171558.webp"></p>
<p>应该是纯蓝图项目打包导致的，在项目中新建一个 C++ 类，变成一个 C++ 工程重新打包即可。</p>
<h2 id="打包原始 uasset 资源"><a href="# 打包原始 uasset 资源" class="headerlink" title="打包原始 uasset 资源"></a>打包原始 uasset 资源 </h2><p> 目前插件并没有能直接选择打包原始 uasset 资源的功能，但是可以使用一个取巧的方法实现。<br>可以设置 <code>ReplacePakCommandTexts</code> 把 Cooked 的目录替换为项目的<code>Content 目录</code>：<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210428141549.webp"></p>
<p>虽然 <code>*pakcommand.txt</code> 里依然会有 <code>uexp</code> 等文件的记录，但是在项目的 <code>Content</code> 下没有，也并不会打包到 pak 中去，会忽略不存在的文件，并有以下 log 输出：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">LogPakFile: Warning: Missing file &quot;D:/Client/Content/Assets/Scene/Map/LookDev/DemoAssets/Mesh/FFXV/000.uexp&quot; will not be added to PAK file.</span><br></pre></td></tr></table></figure>
<p>算是取巧的一种实现吧，但是可行。</p>
<h2 id="导出跨机器的通用配置文件"><a href="# 导出跨机器的通用配置文件" class="headerlink" title="导出跨机器的通用配置文件"></a>导出跨机器的通用配置文件</h2><p>Q：HotPatcher 中导出的配置，有些是依赖于本地绝对路径的文件，如 BaseVersion、Non-Asset 文件、SavePath 等，不同的机器这些绝对路径并不能保证一致，能否基于相对路径进行配置？</p>
<p>A：可以。HotPatcher 所有能够指定路径的配置项，都支持标记符替换，可以使用以下标记符来替代绝对路径。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[ENGINEDIR]</span><br><span class="line">[ENGINE_CONTENT_DIR]</span><br><span class="line">[PROJECTDIR]</span><br><span class="line">[PROJECT_CONTENT_DIR]</span><br><span class="line">[PROJECT_SAVED_DIR]</span><br><span class="line">[PROJECT_CONFIG_DIR]</span><br></pre></td></tr></table></figure>
<p>在打包时会自动替换为当前机器的绝对路径，基于相对路径则是完全通用的配置文件。</p>
<h2 id="依赖分析耗时"><a href="# 依赖分析耗时" class="headerlink" title="依赖分析耗时"></a>依赖分析耗时 </h2><p> 当项目资源非常多，插件提供的依赖分析功能的耗时十分可观，其主要目的是分析被依赖的资源，防止依赖了但是没有被打包的情况。<br>如果依赖了引擎、插件中的资源，不进行依赖分析是管理不到的（或者手动指定），而且如果想要剔除没有引用的资源不分析也做不到。不需要的话也是可以关掉的，设置 bAnalysisFilterDependencies 就可以了。<br>这样只会对配置中所指定的目录下的所有资源、单独指定的资源，与基础版本中的进行 Diff 分析，能够减少依赖分析的耗时（如果资源量非常大，并且能保证所有的资源依赖都在 /Game）下的可以不开启依赖分析。</p>
<h2 id="OTHER-UPDATE"><a href="#OTHER-UPDATE" class="headerlink" title="OTHER UPDATE"></a>OTHER UPDATE</h2><p>使用 Github Gist 管理的动态更新内容，在国内网络可能会无法查看。</p>
<script src="https://gist.github.com/imzlp/5d117e9c5e1fcc46fd778fb908402593.js"></script>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>热更新</category>
      </categories>
      <tags>
        <tag>HotPatcher</tag>
        <tag>热更新</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 热更新：UOD 资料</title>
    <url>/wiki/11043/</url>
    <content><![CDATA[<p>2020 年的 Unreal Open Day 是在线上直播和技术分会场的形式进行的，很开心参加了今年的 UOD 活动，我录制了一场 UOD 的技术视频，也去上海直播现场参加了 UOD 的颁奖活动，很荣幸也很感谢 Epic 授予我 <strong> 杰出社区贡献者 </strong> 奖项，对我既是认可也是激励，我也会尽力产出更多的技术内容，促进 UE 社区的发展。</p>
<p>本篇文章做一个简单的记录，把 UOD 的资料做一下整理，也把我参加 UOD 的视频、演讲 PPT，以及相关的资料做一个总结，还有一些在 UOD 直播现场拍的照片。</p>
<span id="more"></span>

<p>首先是虚幻中国 2020 Unreal Open Day 总结：<a href="https://mp.weixin.qq.com/s/aLbYhrrqbQ74EGGGw8x6Gg">2020 线上虚幻引擎技术开放日圆满落幕｜游戏引擎引领实时技术走向全行业</a></p>
<p><a href="https://mp.weixin.qq.com/s/aLbYhrrqbQ74EGGGw8x6Gg"><img src="https://img.imzlp.com/imgs/zlp/blog/posts/11043/UOD.webp"></a></p>
<p>我在 UOD 演讲主题视频：</p>
<p><a href="https://www.bilibili.com/video/BV1ir4y1c76g"><img src="https://img.imzlp.com/imgs/zlp/blog/posts/11043/uod-hot-update-video.webp"></a></p>
<p>UOD 演讲 PDF 预览：</p>


	<div class="row">
    <embed src="https://img.imzlp.com/imgs/zlp/blog/posts/11043/UOD_UE4 全平台热更新方案_查利鹏.pdf" width="100%" height="1000px" type="application/pdf">
	</div>




<p>PPT 下载：<a href="https://img.imzlp.com/imgs/zlp/blog/posts/11043/UOD_UE4%E5%85%A8%E5%B9%B3%E5%8F%B0%E7%83%AD%E6%9B%B4%E6%96%B0%E6%96%B9%E6%A1%88_%E6%9F%A5%E5%88%A9%E9%B9%8F.pdf">UOD_UE4 全平台热更新方案_查利鹏</a></p>
<p>之前录制的 HotPatcher 的使用教程：</p>
<p><a href="https://www.bilibili.com/video/BV1Tz4y197tR"><img src="https://img.imzlp.com/imgs/zlp/blog/posts/11043/bilibili-hotpatcher-usage.webp"></a></p>
<p>关于热更新演讲主题，之前的文章：</p>
<ul>
<li><a href="https://imzlp.com/posts/17590/">UE4 资源热更打包工具 HotPatcher</a></li>
<li><a href="https://imzlp.com/posts/36659/">UE4 热更新：基于 UnLua 的 Lua 编程指南</a></li>
<li><a href="https://imzlp.com/posts/17371/">UE4 热更新：需求分析与方案设计</a></li>
</ul>
<p>开源的相关仓库：</p>
<ul>
<li><a href="https://github.com/hxhb/HotPatcher">hxhb/HotPatcher</a></li>
<li><a href="https://github.com/hxhb/ue4-dtkit">hxhb/ue4-dtkit</a></li>
<li><a href="https://github.com/hxhb/debugable-unlua">hxhb/debugable-unlua</a></li>
</ul>
<p>去 UOD 直播现场拍的一些照片：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/11043/IMG_20201128_133602.webp"></p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/11043/IMG_20201127_180515.webp"></p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/11043/IMG_20201128_133747.webp"></p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/11043/IMG_20201128_173353.webp"></p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/11043/UOD_OUTSTANDING_COMMUNITY_CONTRIBUTOR.webp"></p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/11043/IMG_20201128_172547.webp"></p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/11043/IMG_20201128_102827.webp"></p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/11043/IMG_20201127_115622.webp"></p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/11043/IMG_20201129_162810.webp"></p>
<p>期待明年的 Unreal Open Day！</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>热更新</category>
      </categories>
      <tags>
        <tag>热更新</tag>
        <tag>UOD</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 热更新：基于 HotPatcher 的自动化流程</title>
    <url>/wiki/10938/</url>
    <content><![CDATA[<p><a href="https://github.com/hxhb/HotPatcher">HotPatcher</a>是我之前开源的一个 UE4 热更新版本管理和资源打包工具，可以方便地进行版本间的差异分析和 pak 打包。之前的文章为了直观地介绍都是基于手动地在编辑器中进行配置和打包的，在真正的工程实践中，可以自动化的重复操作就要避免手动的参与，较早之前我就在插件中添加了 commandlet 的支持，近期修复了一些问题以及增加了很多针对 commandlet 的优化，本篇文章是基于 HotPatcher 的自动化热更新流程的工程实践。</p>
<span id="more"></span>

<p>在之前的文章中，介绍了 <a href="https://github.com/hxhb/HotPatcher">HotPatcher</a> 的工作机制，可以从以下几篇文章中获取更详细的信息：</p>
<ul>
<li><a href="https://imzlp.com/posts/17590/">UE4 资源热更打包工具 HotPatcher</a></li>
<li><a href="https://imzlp.com/posts/17371">UE4 热更新：需求分析与方案设计</a></li>
<li><a href="https://imzlp.com/posts/11043/">2020 Unreal Open Day</a></li>
</ul>
<p>从流程上简单的划分为以下几个步骤：</p>
<ol>
<li>使用 UE 的方式打基础包；</li>
<li>提取基础包的 paklist 文件，导入 HotPatcher 中进行分析；</li>
<li>生成基础包的 Release 信息（多平台使用一份 Release）；</li>
<li>热更版本基于 Release 信息进行比对；</li>
<li>生成 Patch；</li>
</ol>
<p>所以本篇文章的目的就是实现这几个关键步骤的可配置自动化流程，并且这个流程和所有的配置文件不应该受到引擎、项目路径在不同机器的差异等非关键因素的影响，实现真正通用的配置和流程。</p>
<h2 id="自动化出基础包"><a href="# 自动化出基础包" class="headerlink" title="自动化出基础包"></a>自动化出基础包 </h2><p> 当需要集成到 ci/cd 进行自动化构建出包，可以使用 UE 的 BuildGraph 来指导 UBT 和 UAT 工作。</p>
<p>可以直接使用下面的命令（引擎、项目、平台根据自己实际情况修改）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">E:\UnrealEngine\Launcher\UE_4.25\Engine\Build\BatchFiles\RunUAT.bat BuildCookRun -nocompileeditor -installed -nop4 -project=&quot;E:/Examples/Blank425/Blank425.uproject&quot; -cook -stage -archive -archivedirectory=&quot;E:/Examples/Blank425/Package&quot; -package -pak -prereqs -nodebuginfo -targetplatform=Android -cookflavor=ASTC -build -target=Blank425 -clientconfig=Development -utf8output</span><br></pre></td></tr></table></figure>

<p>支持的平台名字为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Win32,Win64,HoloLens,Mac,XboxOne,PS4,IOS,Android,HTML5,Linux,LinuxAArch64,AllDesktop,TVOS,Switch,Lumin</span><br></pre></td></tr></table></figure>

<p>也可以通过自己写 BuildGraph 的脚本来更精准地控制打包的阶段，这里不再赘述，推荐看这篇文章：<a href="https://wangjie.rocks/2019/01/22/ue4-basic-package/">UE4 基础：一键出包脚本</a>。</p>
<p>通过上面的命令可以通过命令行的方式将 UE 的项目打包，可以自己封装一层脚本集成到 ci/cd 平台上。</p>
<p>打包不是本节的重点，重点是在打包后的第一时间提取当前打包时 UE 产生的 <code>paklist*.txt</code> 文件。</p>
<p>UE 打基础包时会把项目中配置的资源打包成 pak 文件，UE 的打包流程中也是通过创建了一个 <code>paklist*.txt</code> 文件来记录哪些资源需要被打成 pak，所以，只要提取了 <code>paklist*.txt</code> 文件就能知道当前基础包中包含了哪些 <strong> 文件</strong>（注意不仅仅是 uasset）。</p>
<p><a href="https://github.com/hxhb/HotPatcher">HotPatcher</a>提供了两种方式来生成基础包的 <code>Release</code> 信息（用于记录基础包中的所有资源信息）：</p>
<ol>
<li>通过导入打基础包时生成的 paklist 文件</li>
<li>通过自己指定打包的目录、添加外部文件</li>
</ol>
<p>我建议的方式是使用第一种，因为更精准，可以精确地分析出基础包的任何一个文件（uasset/non-uasset），而且可以分析出不同平台的基础包中的差异文件，实现完全精确地基础包信息导出。</p>
<p>UE 打基础包时默认会把 paklist 文件存放在以下路径中（源码版与安装版的路径不同）：</p>
<p><strong>安装版引擎</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">%AppData%\Unreal Engine\AutomationTool\Logs\ 引擎路径拼接 \PakList_*.txt</span><br></pre></td></tr></table></figure>

<p>其中 <code> 引擎路径拼接 </code> 的规则为：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 引擎路径</span></span><br><span class="line">E:\UnrealEngine\Launcher\UE_4.25</span><br><span class="line"><span class="comment"># 拼接之后</span></span><br><span class="line">E+UnrealEngine+Launcher+UE_4.25</span><br></pre></td></tr></table></figure>

<p><strong>源码版引擎</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Engine\Programs\AutomationTool\Saved\Logs\BuildCookRun\PakList_*.txt</span><br></pre></td></tr></table></figure>

<p>所以，当打完基础包之后就按照上面的路径规则提取 <code>paklist_*.txt</code> 文件即可，以安装版为例，Win 上可以使用以下文件拷贝命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> f|xcopy /y/i/s/e <span class="string">&quot;%AppData%\Unreal Engine\AutomationTool\Logs\E+UnrealEngine+Launcher+UE_4.25\PakList_*.txt&quot;</span> <span class="string">&quot;E:\ClientVersion\0.0.1.0&quot;</span></span><br></pre></td></tr></table></figure>

<p>就会把当前该目录下所有符合 <code>paklist_*.txt</code> 规则的文件拷贝到指定目录了。</p>
<p>为了统一获取源码版和安装版 paklist 的路径差异，可以使用 Python 写个脚本：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GetPakListFileRules</span>(<span class="params">target_platform,engine_root_dir</span>):</span></span><br><span class="line">    b_installed_engine = <span class="literal">False</span></span><br><span class="line">    installedbuild_txt_path = <span class="string">&quot;%s\\Engine\\Build\\InstalledBuild.txt&quot;</span> % engine_root_dir</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(InstalledBuild_txt_path):</span><br><span class="line">        b_installed_engine = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    ue_paklist_dir = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> b_installed_engine:</span><br><span class="line">        sys_appdata_dir = os.getenv(<span class="string">&quot;APPDATA&quot;</span>)</span><br><span class="line">        ue_aut_log_dir = <span class="string">&quot;Unreal Engine\\AutomationTool\\Logs&quot;</span></span><br><span class="line">        engine_log_dir = engine_root_dir</span><br><span class="line">        engine_log_dir = engine_log_dir.replace(<span class="string">&#x27;:&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        engine_log_dir = engine_log_dir.replace(<span class="string">&#x27;\\&#x27;</span>,<span class="string">&#x27;+&#x27;</span>)</span><br><span class="line">        engine_log_dir = engine_log_dir.replace(<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;+&#x27;</span>)</span><br><span class="line">        ue_paklist_dir = <span class="string">&quot;%s\\%s\\%s\\BuildCookRun&quot;</span> % (sys_appdata_dir,ue_aut_log_dir,engine_log_dir)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ue_paklist_dir = <span class="string">&quot;%s\\Engine\\Programs\\AutomationTool\\Saved\\Logs\\BuildCookRun&quot;</span> % engine_root_dir</span><br><span class="line">    <span class="built_in">print</span>(ue_paklist_dir)</span><br><span class="line">    ue_pak_list_rule = <span class="string">&quot;%s\\PakList_pakchunk*-%s.txt&quot;</span> % (ue_paklist_dir,GetRealPlatformName(target_platform))</span><br><span class="line">    <span class="keyword">return</span> ue_pak_list_rule</span><br></pre></td></tr></table></figure>
<p>调用方法：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ue_paklist_rules = GetPakListFileRules(<span class="string">&quot;Android_ASTC&quot;</span>,<span class="string">&quot;C:\\Program Files\\Epic Games\\UE_4.26&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>根据自己项目的需要简单修改即可。</p>
<blockquote>
<p>注意：每打包一个平台都 <strong> 必须要立即提取 </strong> 该平台基础包的 paklist 文件，因为当执行下一个打包任务的时候，该目录下的文件会被清理。</p>
</blockquote>
<h2 id="自动化提取基础包信息"><a href="# 自动化提取基础包信息" class="headerlink" title="自动化提取基础包信息"></a>自动化提取基础包信息 </h2><p> 在上一步自动化出基础包中，实现了两个关键点的自动化：</p>
<ol>
<li>UE 的打包</li>
<li>提取当前平台的基础包的 paklist</li>
</ol>
<p>这一节的重点，则是当我们打包了 <code>0.0.1.0</code> 版本数个平台的基础包和提取了相应的 paklist 文件之后，如何生成多平台的 release 的流程。</p>
<p>提取到的几个平台的 Paklist 目录结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">E:\ClientVersion\0.0.1.0&gt;tree /a /f</span><br><span class="line">卷 Document 的文件夹 PATH 列表 </span><br><span class="line"> 卷序列号为 0003-AEBB</span><br><span class="line">E:.</span><br><span class="line">+---Android_ASTC</span><br><span class="line">|       PakList_pakchunk0-Android_ASTC.txt</span><br><span class="line">|       PakList_pakchunk1-Android_ASTC.txt</span><br><span class="line">|       PakList_pakchunk2-Android_ASTC.txt</span><br><span class="line">|</span><br><span class="line">+---IOS</span><br><span class="line">|       PakList_pakchunk0-ios.txt</span><br><span class="line">|       PakList_pakchunk1-ios.txt</span><br><span class="line">|       PakList_pakchunk2-ios.txt</span><br><span class="line">|</span><br><span class="line">\---WindowsNoEditor</span><br><span class="line">        PakList_pakchunk0-WindowsNoEditor.txt</span><br><span class="line">        PakList_pakchunk1-WindowsNoEditor.txt</span><br><span class="line">        PakList_pakchunk2-WindowsNoEditor.txt</span><br></pre></td></tr></table></figure>

<p>几个平台的 paklist 的存放结构和文件名是有相同规则的，只要有规则就可以自动化处理。</p>
<p><a href="https://github.com/hxhb/HotPatcher">HotPatcher</a>提供了 <code>HotRelease</code> 的 Commandlet，用于命令行的方式来导出 Release，可以指定配置文件：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">UE4Editor.exe PROJECT.uproject -run=HotRelease -config=<span class="string">&quot;release-config.json&quot;</span></span><br></pre></td></tr></table></figure>

<p>但是，简单地指定配置文件其实对命令行是不那么友好的，因为首先需要构造出 config 文件才能指定，所以我近期对 HotRelease 的 Commandlet 做了增强，可以完全通过命令行来控制 config 的参数，并且可以不指定 config 文件。</p>
<p>因为前面已经提到 HotPather 支持两种模式导出 Release 的信息，所以如果当使用导入 <code>paklist</code> 时，只需要指定以下几个关键参数即可：</p>
<ol>
<li><code>VersionId</code> 当前 Release 的版本号</li>
<li><code>ByPakList</code> 开启 Paklist 模式</li>
<li><code>PlatformsPakListFiles</code> 指定各个平台的对应的 paklist*.txt 文件</li>
<li><code>SavePath</code> 生成 Release 的存储路径</li>
</ol>
<p>我使用 UE 的反射机制实现了可以在命令行指定参数结构中定义的名字来构造出真实的配置信息（暂不支持指定数组），可以在执行 commandlet 时直接指定上面的参数。</p>
<p>所以，需要使用的 HotRelease 的 Commandlet 命令为（方便观看我对参数换行拆分）：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">E:\UnrealEngine\Launcher\UE_4.25\Engine\Binaries\UE4Editor-cmd.exe</span><br><span class="line">E:\Examples\Blank425\Blank425.uproject</span><br><span class="line">-run=HotRelease</span><br><span class="line">-versionid=<span class="string">&quot;0.0.1.0&quot;</span></span><br><span class="line">-ByPakList=<span class="literal">true</span></span><br><span class="line">-AddPlatformPakList=WindowsNoEditor+E:\ClientVersion\0.0.1.0\WindowsNoEditor\PakList_pakchunk0-WindowsNoEditor.txt+E:\ClientVersion\0.0.1.0\WindowsNoEditor\PakList_pakchunk1-WindowsNoEditor.txt+E:\ClientVersion\0.0.1.0\WindowsNoEditor\PakList_pakchunk2-WindowsNoEditor.txt</span><br><span class="line">savepath.path=<span class="string">&quot;E:\ClientVersion\&quot;</span></span><br></pre></td></tr></table></figure>

<p><code>AddPlatformPakList</code>是通过命令行指定 <code>Platform-PaklistFiles</code> 的参数，要求为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PLATFORM_NAME+Paklist_0.txt+PakList_1.txt,PLATFORM_NAME+Paklist_0.txt+PakList_1.txt</span><br></pre></td></tr></table></figure>

<p>可以指定多个平台，以逗号 (<code>,</code>) 分割，每个平台的节第一个为平台名通过 <code>+</code> 号分割，后面可以指定任意数量的 Paklist 文件。</p>
<p>以指定 <code>WindowsNoEditor</code>/<code>Android_ASTC</code>/<code>IOS</code> 三个平台为例：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-AddPlatformPakList=WindowsNoEditor+E:\Paklist_chunk01_WindowsNoEditor.txt+E:\Paklist_chunk02_WindowsNoEditor.txt,Android_ASTC+E:\Paklist_chunk01_Android_ASTC.txt+E:\Paklist_chunk02_Android_ASTC.txt,IOS+E:\Paklist_chunk01_IOS.txt+E:\Paklist_chunk02_IOS.txt</span><br></pre></td></tr></table></figure>

<p>指定平台和文件路径都是有规则的，可以使用 <code>Python</code> 等脚本来针对项目的管理风格进行封装，最后直接使用 <code>os.system</code> 来执行 commandlet 即可，就会与在 Editor 中在 HotPatcher 编辑器中手动执行 ByRelease 一样的行为。</p>
<blockquote>
<p>注意：虽然 Release.json 中记录了 Non-uasset 文件的绝对路径，但是实际上进行版本比对时，是不检查文件的绝对路径的，所以 Release.json 文件是跨机器通用的信息（以资源路径、mount 路径进行比对）。</p>
</blockquote>
<h2 id="自动化生成 Patch"><a href="# 自动化生成 Patch" class="headerlink" title="自动化生成 Patch"></a>自动化生成 Patch</h2><p>上一节也已经介绍了如何自动化地生成 Release 信息，生成 Release 需要配置的选项不多，但是 Patch 就有非常多的配置了，所以完全地抛弃 config 文件是更麻烦的行为，所以我想了一个折衷方案——指定通用配置文件和命令行指定特殊的参数。</p>
<p>那么，哪些是通用的配置文件呢？</p>
<ul>
<li>Patch 要扫描的资源目录</li>
<li>要添加的文件（ini/shaderbytecode/assetregistry）</li>
<li>Non-uasset 的文件、目录</li>
<li>Chunk 的划分</li>
</ul>
<p>哪些是可以通过命令行指定的呢？</p>
<ul>
<li>VersionID</li>
<li>基础版本的 Release 文件</li>
<li>是否 Cook 当前 Patch 中的资源</li>
<li>要生成 Patch 的平台</li>
<li>Pak 文件的命名规则</li>
<li>保存目录</li>
</ul>
<p>在老版本的 <a href="https://github.com/hxhb/HotPatcher">HotPatcher</a> 中，配置文件是依赖各种参数的绝对路径的（添加的 Non-uasset）文件，近期我做了优化，可以支持相对于工程目录的相对路径。</p>
<p>以添加 <code>Content/Script</code> 目录为例，在之前的版本中只能通过选择绝对路径的文件夹：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/10938/hotpatch-abs-path.webp"></p>
<p>现在可以通过 <code>[PROJECT_CONTENT_DIR]</code> 来替代：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/10938/hotpatch-relative-path.webp"></p>
<p>在执行 Path 的过程中会扫描替换为当前工程的绝对路径。</p>
<p>支持 <code>[]</code> 标记的相对路径有以下几个：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[ENGINEDIR]</span><br><span class="line">[ENGINE_CONTENT_DIR]</span><br><span class="line">[PROJECTDIR]</span><br><span class="line">[PROJECT_CONTENT_DIR]</span><br><span class="line">[PROJECT_SAVED_DIR]</span><br><span class="line">[PROJECT_CONFIG_DIR]</span><br></pre></td></tr></table></figure>

<p>可以根据自己的需要使用，使用这种方式，就可以导出一份通用的配置。</p>
<figure class="highlight json"><figcaption><span>PatchTemplate.json</span></figcaption><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;bByBaseVersion&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="attr">&quot;baseVersion&quot;</span>:</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="attr">&quot;filePath&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">&quot;versionId&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;assetIncludeFilters&quot;</span>: [</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/Game&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	<span class="attr">&quot;assetIgnoreFilters&quot;</span>: [],</span><br><span class="line">	<span class="attr">&quot;bForceSkipContent&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="attr">&quot;forceSkipContentRules&quot;</span>: [</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/Engine/Editor&quot;</span></span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/Engine/VREditor&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	<span class="attr">&quot;forceSkipAssets&quot;</span>: [],</span><br><span class="line">	<span class="attr">&quot;bIncludeHasRefAssetsOnly&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">	<span class="attr">&quot;bAnalysisFilterDependencies&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="attr">&quot;bRecursiveWidgetTree&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="attr">&quot;assetRegistryDependencyTypes&quot;</span>: [</span><br><span class="line">		<span class="string">&quot;Packages&quot;</span></span><br><span class="line">	],</span><br><span class="line">	<span class="attr">&quot;includeSpecifyAssets&quot;</span>: [],</span><br><span class="line">	<span class="attr">&quot;bIncludeAssetRegistry&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="attr">&quot;bIncludeGlobalShaderCache&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">	<span class="attr">&quot;bIncludeShaderBytecode&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">	<span class="attr">&quot;bIncludeEngineIni&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">	<span class="attr">&quot;bIncludePluginIni&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">	<span class="attr">&quot;bIncludeProjectIni&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">	<span class="attr">&quot;bEnableExternFilesDiff&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="attr">&quot;ignoreDeletionModulesAsset&quot;</span>: [],</span><br><span class="line">	<span class="attr">&quot;addExternAssetsToPlatform&quot;</span>: [</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="attr">&quot;targetPlatform&quot;</span>: <span class="string">&quot;AllPlatforms&quot;</span>,</span><br><span class="line">			<span class="attr">&quot;addExternFileToPak&quot;</span>: [],</span><br><span class="line">			<span class="attr">&quot;addExternDirectoryToPak&quot;</span>: [</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">&quot;directoryPath&quot;</span>:</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="attr">&quot;path&quot;</span>: <span class="string">&quot;[PROJECT_CONTENT_DIR]/Script&quot;</span></span><br><span class="line">					&#125;,</span><br><span class="line">					<span class="attr">&quot;mountPoint&quot;</span>: <span class="string">&quot;../../../Blank425/Content/Script&quot;</span></span><br><span class="line">				&#125;</span><br><span class="line">			]</span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	<span class="attr">&quot;bIncludePakVersionFile&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">	<span class="attr">&quot;pakVersionFileMountPoint&quot;</span>: <span class="string">&quot;../../../Blank425/Versions/version.json&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;bEnableChunk&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">	<span class="attr">&quot;chunkInfos&quot;</span>: [],</span><br><span class="line">	<span class="attr">&quot;bCookPatchAssets&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="attr">&quot;pakCommandOptions&quot;</span>: [],</span><br><span class="line">	<span class="attr">&quot;replacePakCommandTexts&quot;</span>: [],</span><br><span class="line">	<span class="attr">&quot;unrealPakOptions&quot;</span>: [</span><br><span class="line">		<span class="string">&quot;-compress&quot;</span>,</span><br><span class="line">		<span class="string">&quot;-compressionformats=Zlib&quot;</span></span><br><span class="line">	],</span><br><span class="line">	<span class="attr">&quot;pakTargetPlatforms&quot;</span>: [],</span><br><span class="line">	<span class="attr">&quot;bCustomPakNameRegular&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">	<span class="attr">&quot;pakNameRegular&quot;</span>: <span class="string">&quot;&#123;VERSION&#125;_&#123;CHUNKNAME&#125;_&#123;PLATFORM&#125;_001_P&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;bIgnoreDeleatedAssetsInfo&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">	<span class="attr">&quot;bSaveDeletedAssetsToNewReleaseJson&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="attr">&quot;bSavePakList&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="attr">&quot;bSaveDiffAnalysis&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="attr">&quot;bSaveAssetRelatedInfo&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">	<span class="attr">&quot;bSavePatchConfig&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="attr">&quot;savePath&quot;</span>:</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="attr">&quot;path&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个配置就可以作为生成 Path 时 <strong> 资源相关 </strong> 的通用配置文件，当我们想要修改打包的配置时只需要修改这个文件即可。</p>
<p>其他的版本相关的参数都可以通过 HotPatcher 的 commandlet 命令行来指定了：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">E:\UnrealEngine\Launcher\UE_4.25\Engine\Binaries\UE4Editor-cmd.exe</span><br><span class="line">E:\Examples\Blank425\Blank425.uproject</span><br><span class="line">-run=HotPatcher</span><br><span class="line">-config=<span class="string">&quot;E:\ClientVersion\PatchTemplate.json&quot;</span></span><br><span class="line">-versionid=<span class="string">&quot;0.0.1.1&quot;</span></span><br><span class="line">-baseVersion.filePath=<span class="string">&quot;E:\ClientVersion\0.0.1.0\0.0.1.0_Release.json&quot;</span></span><br><span class="line">-AddPatchPlatforms=<span class="string">&quot;WindowsNoEditor,Android_ASTC,IOS&quot;</span></span><br><span class="line">-savePath.path=<span class="string">&quot;E:\ClientVersion\&quot;</span></span><br></pre></td></tr></table></figure>

<p>同样，这个命令的参数也是有规律可循的，当目录结构组织比较好的情况下，只要指定当前 Patch 的基础版本和当前的版本号就可以完全自动化的出包了。</p>
<p>同样，生成 Path 的流程也可以通过 Python 等脚本进行封装，可以在 ci/cd 平台上指定引擎目录、项目目录、基线版本、当前版本、以及生成哪些平台的 patch 等参数，方便控制。</p>
<h2 id="结语"><a href="# 结语" class="headerlink" title="结语"></a>结语 </h2><p> 本篇文章介绍了使用 <a href="https://github.com/hxhb/HotPatcher">HotPatcher</a> 来自动化执行热更新的流程，包括 UE 自动化出基础包、paklsit 的提取，Release 的生成、通用的 Patch 生成规则等，可以方便地集成至 ci/cd 平台，避免手动参与的过程。</p>
<p>后续有时间我会写一份用于 <a href="https://github.com/hxhb/HotPatcher">HotPatcher</a> 自动化导出 Release/Patch 的 Python 脚本，方便直接使用。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>热更新</category>
      </categories>
      <tags>
        <tag>HotPatcher</tag>
        <tag>热更新</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 热更新：拆分基础包</title>
    <url>/wiki/13765/</url>
    <content><![CDATA[<p>在之前的几篇文章中，分别介绍了 UE 热更新的实现机制，以及热更的自动化流程，近期打算继续写几篇文章介绍下 UE 里热更新中资源包管理的流程和规则。</p>
<p>当然，不同类型的项目会有不同的打包策略，资源管理也没有通用的最佳策略。本篇文章主要介绍热更新流程中基础包的拆分的工程实践，涉及修改引擎实现 Android/IOS 通用拆分方式的方法，希望对不同业务的项目能提供一些有用的思路。</p>
<span id="more"></span>

<p>当项目发展到中后期的时候，会有大量的地图和美术资源，对于手游而言，包体的大小也是比较敏感的，而且 Android 还是 2G 的包体大小限制，所以当项目进行到一定阶段，拆分包体就是需要考虑的事情了，并且巨型的安装包也不利于推广。</p>
<p>在具有热更的情况下拆分基础包需要兼顾两个因素：</p>
<ul>
<li>减小包体的同时不能影响玩法</li>
<li>要减少玩家的下载等待时间</li>
</ul>
<p>这两个因素的取舍和实现或多或少都是需要与具体的游戏业务相关的，这里仅从实现层面来拆分基础包，不同的业务根据适合自己的业务规则来拆分就好。</p>
<p>UE 本身的资源管理，是可以在打包时进行拆分资源的，就是通过 <code>Asset Manager</code> 或者 <code>AssetPrimaryLable</code> 对资源按照类型、目录、地图、依赖分析等粒度进行资源的划分，也就是所谓的 Chunk 机制。<br>Chunk 划分的操作方法可以看 UE 的文档：</p>
<ul>
<li><a href="https://docs.unrealengine.com/en-US/SharingAndReleasing/Patching/GeneralPatching/ChunkingExample/index.html">Preparing Assets for Chunking</a>。</li>
<li><a href="https://docs.unrealengine.com/en-US/SharingAndReleasing/Patching/GeneralPatching/CookingAndChunking/index.html">Cooking and Chunking</a></li>
</ul>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/13765/split-base-pack.webp"></p>
<p>UE 的 Chunk 机制，可以把默认情况下打出来一个单独的巨型 pak 根据设置的拆分粒度打包成数个小的 pak（在 <code>Priority</code> 相同的情况下会具有一份资源在多个 chunk 中存在的情况），如果以地图和其依赖的资源作为 chunk 的划分机制，就可以让基础包内包含初始的关键地图，在热更或者运行时把其余的资源动态下载下来。</p>
<p>其实拆分基础包的关键就两点：</p>
<ol>
<li>能够按照自定义分类拆分资源（chunk）</li>
<li>能够自己控制资源打包到基础包内的规则</li>
</ol>
<p>第一点可以通过 Asset Manager 的 Chunk 机制实现，那么第二点如何实现呢？</p>
<h2 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h2><p>对于 Android 平台，因为有超过 2G 就会出包失败的问题，所以 UE 对 Android 默认提供了 <code>ObbFilter</code> 的功能，可以指定哪些文件要被添加到 Obb 中（pak/mp4）等。</p>
<p>控制方法只需要添加配置即可。</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Config/DefaultEngine.ini</span></span><br><span class="line"><span class="section">[/Script/AndroidRuntimeSettings.AndroidRuntimeSettings]</span></span><br><span class="line">+<span class="attr">ObbFilters</span>=-pakchunk1-*</span><br><span class="line">+<span class="attr">ObbFilters</span>=-pakchunk2-*</span><br><span class="line">+<span class="attr">ObbFilters</span>=-pakchunk3-*</span><br></pre></td></tr></table></figure>
<p>ObbFilters 的规则以 <code>-</code> 开头就是排除规则，会把基础包中的 <code>chunk1-3</code> 的 pak 给过滤掉，可以用于后续的下载流程。</p>
<p>也可以指定 <code>Exclute</code> 和<code>Include</code>规则组合来用：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line">+<span class="attr">ObbFilters</span>=-*.pak</span><br><span class="line">+<span class="attr">ObbFilters</span>=pakchunk0-*</span><br></pre></td></tr></table></figure>
<p>第一步忽略掉所有的 pak 文件，然后把 <code>pakchunk0-*.pak</code> 显式添加至 obb 中。</p>
<h2 id="IOS"><a href="#IOS" class="headerlink" title="IOS"></a>IOS</h2><p><strong>但是 </strong>，IOS 并没有提供这个功能，为了实现 IOS 与 Android 一样的过滤机制，我翻了下 UE 中打包 IOS 的代码，可以通过以下方式实现（需要修改<code>iPhonePackager</code> 的代码），思考和实现过程记录如下。</p>
<blockquote>
<p><strong>注意</strong>：我使用的 IPA 打包方式是远程构建，详见之前的文章：<a href="https://imzlp.com/posts/1948/">UE4 开发笔记：Mac/iOS 篇</a>。</p>
</blockquote>
<p>在前面提到了 UE 为 Android 提供了打包到 obb 中的文件过滤规则：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Config/DefaultEngine.ini</span></span><br><span class="line"><span class="section">[/Script/AndroidRuntimeSettings.AndroidRuntimeSettings]</span></span><br><span class="line">+<span class="attr">ObbFilters</span>=-pakchunk1-*</span><br></pre></td></tr></table></figure>
<p>但是 UE 并没有为 IOS 提供相应的操作，默认情况下会把 IOS 的所有的 pak 文件都打包至 IPA 中。</p>
<p>为了统一 Android 和 IOS 的基础包规则，我自己实现了 IOS 上类似 Android 那种指定过滤规则的功能，做个简单的介绍。</p>
<p>我使用的是 Mac 远程打包，流程是在 Mac 上编译代码生成 IPA，拉回 Win，在 Win 上进行 Cook，生成 Pak 文件，最后把原始 IPA 解包，再添加 Pak 等文件组合成最终 IPA。</p>
<p>我的需求是，自定义指定过滤规则，可以把某些文件忽略，不打包到 IPA 中。那么这一步的操作其实就位于把 IPA 解包再打包的流程里，经过翻阅 UE 的代码，发现这个操作是通过 <code>iPhonePackager</code> 这个独立程序来实现的，那么就需要对这个程序的代码进行改造了。</p>
<p>经过调试分析，发现真正实现重新打包 IPA 的操作是在以下函数中执行的：</p>
<figure class="highlight plaintext"><figcaption><span>Programs/IOS/iPhonePackager/CookTime.cs</span></figcaption><table><tr><td class="code"><pre><span class="line">/** </span><br><span class="line">* Using the stub IPA previously compiled on the Mac, create a new IPA with assets</span><br><span class="line">*/</span><br><span class="line">static public void RepackageIPAFromStub();</span><br></pre></td></tr></table></figure>
<p>该函数位于 <code>iPhonePackager</code>-<code>CookTime</code> 类中。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RepackageIPAFromStub</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="built_in">string</span> SourceDir = Path.GetFullPath(ZipSourceDir);</span><br><span class="line">	<span class="built_in">string</span>[] PayloadFiles = Directory.GetFiles(SourceDir, <span class="string">&quot;*.*&quot;</span>, Config.bIterate ? SearchOption.TopDirectoryOnly : SearchOption.AllDirectories);</span><br><span class="line"> 	<span class="keyword">foreach</span> (<span class="built_in">string</span> Filename <span class="keyword">in</span> PayloadFiles)</span><br><span class="line">    &#123;</span><br><span class="line">       <span class="comment">// read file to memory,add to ZipFileSystem</span></span><br><span class="line">       <span class="comment">// generate stub and ipa</span></span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要做的操作就是介入这个过程，把 <code>PayloadFiles</code> 中的文件列表通过我们自定义的规则来执行过滤。</p>
<p>从流程上分为以下几个步骤：</p>
<ol>
<li>从项目中读取 Filter 的配置</li>
<li>创建出真正的过滤器</li>
<li>在 <code>RepackageIPAFromStub</code> 遍历文件的流程里使用过滤器进行检测是否需要被打入 ipa</li>
</ol>
<p>只需要几十行代码就可以实现，首先需要添加一个 IniReader 的类：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> Tools.DotNETCommon;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</span><br><span class="line"><span class="keyword">using</span> Ini;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Ini</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">IniReader</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">private</span> <span class="built_in">string</span> path;</span><br><span class="line"></span><br><span class="line">		[<span class="meta">DllImport(<span class="meta-string">&quot;kernel32&quot;</span>)</span>]</span><br><span class="line">		<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">int</span> <span class="title">GetPrivateProfileString</span>(<span class="params"><span class="built_in">string</span> section, <span class="built_in">string</span> key, <span class="built_in">string</span> def,</span></span></span><br><span class="line"><span class="params"><span class="function">			StringBuilder retVal, <span class="built_in">int</span> size, <span class="built_in">string</span> filePath</span>)</span>;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="title">IniReader</span>(<span class="params"><span class="built_in">string</span> INIPath</span>)</span></span><br><span class="line">		&#123;</span><br><span class="line">			path = INIPath;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">ReadValue</span>(<span class="params"><span class="built_in">string</span> Section, <span class="built_in">string</span> Key</span>)</span></span><br><span class="line">		&#123;</span><br><span class="line">			StringBuilder ReaderBuffer = <span class="keyword">new</span> StringBuilder(<span class="number">255</span>);</span><br><span class="line">			<span class="built_in">int</span> ret = GetPrivateProfileString(Section, Key, <span class="string">&quot;&quot;</span>, ReaderBuffer, <span class="number">255</span>, <span class="keyword">this</span>.path);</span><br><span class="line">			<span class="keyword">return</span> ReaderBuffer.ToString();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在 <code>RepackageIPAFromStub</code> 函数中创建过滤器：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">FileFilter IpaPakFileFilter = <span class="keyword">new</span> FileFilter(FileFilterType.Include);</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">string</span> ProjectDir = Directory.GetParent(Path.GetFullPath(Config.ProjectFile)).FullName;</span><br><span class="line">	<span class="comment">// Program.Log(&quot;ProjectDir path &#123;0&#125;&quot;, ProjectDir);</span></span><br><span class="line">	<span class="built_in">string</span> EngineIni = Path.Combine(ProjectDir,<span class="string">&quot;Config&quot;</span>,<span class="string">&quot;DefaultEngine.ini&quot;</span>);</span><br><span class="line">	<span class="comment">// Program.Log(&quot;EngineIni path &#123;0&#125;&quot;, EngineIni);</span></span><br><span class="line">	IniReader EngineIniReader = <span class="keyword">new</span> IniReader(EngineIni);</span><br><span class="line">	<span class="built_in">string</span> RawPakFilterRules = EngineIniReader.ReadValue(<span class="string">&quot;/Script/IOSRuntimeSettings.IOSRuntimeSettings&quot;</span>, <span class="string">&quot;IPAFilters&quot;</span>);</span><br><span class="line">	Program.Log(<span class="string">&quot;RawPakFilterRules &#123;0&#125;&quot;</span>, RawPakFilterRules);</span><br><span class="line">	<span class="built_in">string</span>[] PakRules = RawPakFilterRules.Split(<span class="string">&#x27;,&#x27;</span>);		</span><br><span class="line">	<span class="comment">// foreach(string Rule in PakRules) &#123;Program.Log(&quot;PakRules &#123;0&#125;&quot;, Rule);&#125;</span></span><br><span class="line">  </span><br><span class="line">	List&lt;<span class="built_in">string</span>&gt; PakFilters = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;(PakRules);</span><br><span class="line">	<span class="keyword">if</span> (PakFilters != <span class="literal">null</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		IpaPakFileFilter.AddRules(PakFilters);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里从项目的 <code>Config/DefaultEngine.ini</code> 的[/Script/IOSRuntimeSettings.IOSRuntimeSettings]项读取 <code>IPAFilters</code> 的值，规则与 Android 相同，也可以指定 <code>Exclute</code> 和<code>Include</code>规则，但是要把规则都写在一行，多个规则以逗号分隔。</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[/Script/IOSRuntimeSettings.IOSRuntimeSettings]</span></span><br><span class="line"><span class="attr">IPAFilters</span>=-*.pak,pakchunk0-*</span><br></pre></td></tr></table></figure>

<p>最终，还需要在 <code>RepackageIPAFromStub</code> 遍历 <code>Payload</code> 文件的循环中进行检测是否匹配我们指定的过滤规则：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RepackageIPAFromStub</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="built_in">string</span> SourceDir = Path.GetFullPath(ZipSourceDir);</span><br><span class="line">	<span class="built_in">string</span>[] PayloadFiles = Directory.GetFiles(SourceDir, <span class="string">&quot;*.*&quot;</span>, Config.bIterate ? SearchOption.TopDirectoryOnly : SearchOption.AllDirectories);</span><br><span class="line">	<span class="keyword">foreach</span> (<span class="built_in">string</span> Filename <span class="keyword">in</span> PayloadFiles)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (!IpaPakFileFilter.Matches(Filename))</span><br><span class="line">		&#123;</span><br><span class="line">			Program.Log(<span class="string">&quot;IpaPakFileFilter not match file &#123;0&#125;&quot;</span>, Filename);</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Program.Log(&quot;IpaPakFileFilter  match file &#123;0&#125;&quot;, Filename);</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样再执行打包 IOS，就会按照指定的过滤规则来添加文件了，实现了与 Android 上一致的行为。</p>
<p>打包过程中的 Log 如下（上文代码已注释）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Saving IPA ...</span><br><span class="line">ProjectDir path C:\BuildAgent\workspace\PackageWindows\Client</span><br><span class="line">EngineIni path C:\BuildAgent\workspace\PackageWindows\Client\Config\DefaultEngine.ini</span><br><span class="line">RawPakFilterRules -*.pak,pakchunk0-*</span><br><span class="line">PakRules -*.pak</span><br><span class="line">PakRules pakchunk0-*</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\Assets.car</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\Info.plist</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\LaunchScreenIOS.webp</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\Manifest_DebugFiles_IOS.txt</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\Manifest_NonUFSFiles_IOS.txt</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\mute.caf</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\ue4commandline.txt</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\cookeddata\fgame\content\movies\logo.mp4</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\cookeddata\fgame\content\movies\sparkmore.mp4</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\cookeddata\fgame\content\paks\pakchunk0-ios.pak</span><br><span class="line">IpaPakFileFilter not match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\cookeddata\fgame\content\paks\pakchunk1-ios.pak</span><br><span class="line">IpaPakFileFilter not match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\cookeddata\fgame\content\paks\pakchunk2-ios.pak</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>可以看到，过滤规则已经生效了，除此之外不会对打出来的包有任何其他影响（当然这种默认情况下是丢失了资源的，还要实现一套下载机制，可以参考我之前热更系列的文章）。</p>
<blockquote>
<p>注意：因为 iPhonePackager 是个 Program 类型的程序，并不依赖引擎，所以将其编译完之后是可以拷贝到非源码版引擎使用的。</p>
</blockquote>
<p><strong>注意 </strong>，在非远程构建，直接在 Mac 中打 IOS 包的并不能修改 IphonePackager 的代码，因为非远程构建不会用到它。实现相同的效果需要修改<code>IOSPlatform.Automation.cs</code> 中的流程，把上面的代码加到 <code>Package</code> 函数中，实现过滤行为。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210603164600.webp"></p>
<p>而且，默认 UE 在 mac 上应该也不会编译 csharp 的 program 的工程，可以在 Win 上修改了 AutomationTool 后拷贝到 Mac 上。</p>
<h2 id="End"><a href="#End" class="headerlink" title="End"></a>End</h2><p>通过上面的操作，可以实现 Android/IOS 相同的基础包过滤规则，把工程内最关键的资源打包到基础包中，其余的 pak 可以在打完基础包之后从 <code>Saved/StagedBuilds</code> 中提取出来，放到热更平台启动时下载或者根据项目的类型和需求设计运行时下载的方案。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>热更新</category>
      </categories>
      <tags>
        <tag>HotPatcher</tag>
        <tag>热更新</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 热更新：资产管理与审计工具</title>
    <url>/wiki/3675/</url>
    <content><![CDATA[<p>在前面的文章中，介绍了基础包的拆分规则和实现，在基础的打包规则稳定之后，日常开发中的关注重点就转向侧重于项目的资产管理和包体资源审计、分析项目中的资产大小和冗余情况等。</p>
<p>本篇文章介绍 UE 中的资源打包配置、常用的资产管理方式以及资产审计工具等工程实践，热更新系列文章的资源管理篇，也是对上一篇文章 <a href="https://imzlp.com/posts/13765/">UE4 热更新：拆分基础包</a> 的内容补充。</p>
<span id="more"></span>

<h2 id="打包配置"><a href="# 打包配置" class="headerlink" title="打包配置"></a>打包配置 </h2><p>UE 中的资源打包选项可以在<code>Project Settings</code>-<code>Packaging</code> 中进行设置，可以在这里设置是否生成 Pak 以及资源进包的规则。</p>
<blockquote>
<p>关于 UE4 基础包中包含的具体内容，我在 Unreal Open Day 的热更新方案中有介绍，有兴趣的可以去看这个视频：<a href="https://www.bilibili.com/video/BV1ir4y1c76g">Unreal Open Day 2020 虚幻引擎 4 全平台热更新方案 | 查利鹏</a>。</p>
</blockquote>
<ul>
<li><strong>UsePakFile</strong>：是否使用 Pak 文件，如果启用，会把游戏用到的资源都打包到 pak 文件中，如果不启用，则会把 cook 之后的 uasset/config/shaderbytecode/assetregistry/uplugin/uproject 等文件按照项目内的路径规则每个文件单独存放。</li>
</ul>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/3675/20210309161823.webp"></p>
<ul>
<li><strong>Generate Chunks</strong>：是否打包时生成 Chunk，如果项目内具有划分 Chunk 的规则，勾选此选项会生成多个 pak 文件。</li>
<li><strong>Generate No Chunks</strong>：不生成 Chunk</li>
<li><strong>Chunk Hard Reference Only</strong>：只把 Hard 引用的资源打包到 Chunk 中，Soft 的引用不会进包。</li>
<li><strong>PakFile Compression Formats</strong>：指定 Pak 的压缩算法，该参数会传递给 UnrealPak，详见：<a href="https://imzlp.com/posts/8470/">ModularFeature：为 UE4 集成 ZSTD 压缩算法</a></li>
<li><strong>ShareMaterialShaderCode</strong>：是否共享 ShaderCode，会生成 <code>ushaderbytecode</code> 到包内，可以减小包体的大小。</li>
</ul>
<p>下面这些参数就是具体的控制把资源打到包内的规则：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/3675/20210309162722.webp"></p>
<p><code>Directories to never cook</code>的目录不会被打到包内。</p>
<p><code>Additional Non-Asset Directories to Package</code>用来把一些 non-uasset 文件打到包内，比如 Lua 或者其他的一些表格文件等。</p>
<h2 id="Chunk 划分"><a href="#Chunk 划分" class="headerlink" title="Chunk 划分"></a>Chunk 划分</h2><p>UE 具有划分 Chunk 的功能，每个 Chunk 在打包时会生成一个单独的 pak 文件，可以通过创建一个 PrimaryAssetLable 来进行设置。</p>
<p>UE 关于划分 Chunk 的文档：</p>
<ul>
<li><a href="https://docs.unrealengine.com/en-US/SharingAndReleasing/Patching/GeneralPatching/ChunkingExample/index.html">Preparing Assets for Chunking</a></li>
<li><a href="https://docs.unrealengine.com/en-US/SharingAndReleasing/Patching/GeneralPatching/CookingAndChunking/index.html">Cooking and Chunking</a></li>
</ul>
<p>创建 PrimaryAssetLable 资源：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/3675/20210309163255.webp"></p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/3675/20210309163716.webp"></p>
<p><strong>注意</strong>，在默认情况下，引擎中的资源和在项目设置中配置的 Non-Asset 的资源是强制打包到 Chunk0 中的，如果包含了引擎的资源也不会把它们打包到当前 Chunk 中（设置 Priority 也无用），用 PrimaryAssetLable 只能控制 uasset 的划分。</p>
<p>这部分代码在：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/Engine/Private/AssetManager.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UAssetManager::GetPackageChunkIds</span><span class="params">(FName PackageName, <span class="keyword">const</span> ITargetPlatform* TargetPlatform, <span class="keyword">const</span> TArray&lt;int32&gt;&amp; ExistingChunkList, TArray&lt;int32&gt;&amp; OutChunkList, TArray&lt;int32&gt;* OutOverrideChunkList)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// Include preset chunks</span></span><br><span class="line">	OutChunkList.<span class="built_in">Append</span>(ExistingChunkList);</span><br><span class="line">	<span class="keyword">if</span> (OutOverrideChunkList)</span><br><span class="line">	&#123;</span><br><span class="line">		OutOverrideChunkList-&gt;<span class="built_in">Append</span>(ExistingChunkList);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (PackageName.<span class="built_in">ToString</span>().<span class="built_in">StartsWith</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;/Engine/&quot;</span>), ESearchCase::CaseSensitive))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Some engine content is only referenced by string, make sure it&#x27;s all in chunk 0 to avoid issues</span></span><br><span class="line">		OutChunkList.<span class="built_in">AddUnique</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (OutOverrideChunkList)</span><br><span class="line">		&#123;</span><br><span class="line">			OutOverrideChunkList-&gt;<span class="built_in">AddUnique</span>(<span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Add all chunk ids from the asset rules of managers. By default priority will not override other chunks</span></span><br><span class="line">	TSet&lt;FPrimaryAssetId&gt; Managers;</span><br><span class="line">	Managers.<span class="built_in">Reserve</span>(<span class="number">128</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">GetPackageManagers</span>(PackageName, <span class="literal">true</span>, Managers);</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">GetPrimaryAssetSetChunkIds</span>(Managers, TargetPlatform, ExistingChunkList, OutChunkList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过编辑创建的 PrimaryAssetLable 资源的参数来控制它所管理的 Chunk 的资源：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/3675/20210309163903.webp"></p>
<ul>
<li><p><strong>Priority</strong>：指定当前 Chunk 的优先级，因为可能有几个 Chunk 中都会包含同一个资源，如何决定这个资源打包到哪个 chunk 中去？通过指定优先级可以控制资产的冗余，如果优先级相同则每个 Chunk 中都会包含一份。</p>
</li>
<li><p><strong>ChunkID</strong>：指定生成 Chunk 的 ID 值，生成的 pak 文件命名规则为：pakchunk0-WindowsNoEditor.pak，<code>pakchunk</code>后的数字就是 ChunkID 值。</p>
</li>
<li><p><strong>ApplyRecursively</strong>：对所管理的资源进行递归依赖分析，但不包含优先级更高的 Chunk 管理的资产。</p>
</li>
<li><p><strong>CookRule</strong>：当前 Chunk 的 Cook 规则，可以实现控制该 PrimaryAssetLable 管理的资源都不打包（NeverCook）</p>
<ul>
<li>UnKnown：如果有引用则进行 Cook</li>
<li>NeverCook：从不进行 Cook，该部分资源不会被打包</li>
<li>DevelopmentCook：如果有引用则在 Development 模式中 Cook，Production 时不 Cook</li>
<li>DevelopmentAlwaysCook：在 Development 模式中均进行 Cook，Production 不 Cook</li>
<li>AlwayCook：在任何情况下都执行 Cook</li>
</ul>
</li>
<li><p><strong>Lable Assets in My Directory</strong>：当前 PrimaryAssetLable 所在目录（以及子目录）下的资源都归它管理。</p>
</li>
<li><p><strong>IsRuntimeLabel</strong>：设置 PrimaryAssetLable 资源本身在运行时可用，并且会打到包内，该选项不会对它标记的资产有影响。</p>
</li>
<li><p><strong>Explicit Assets</strong>：指定所管理的资源文件，与 HotPatcher 中的 <code>IncludeSpecifyAsset</code> 类似。</p>
</li>
<li><p><strong>ExplicitBlueprints</strong>：指定管理某种类型的蓝图资产。</p>
</li>
<li><p><strong>AssetCollection</strong>：指定 Collection 名字。</p>
</li>
</ul>
<p>可以看到通过上述的参数能够实现以下的资产管理功能：</p>
<ol>
<li>指定目录</li>
<li>指定资源和其依赖<!-- 3. 指定某种蓝图资源类型 --></li>
<li>反向控制上述参数不打到包内(Never Cook)</li>
<li>chunk 优先级控制资产冗余</li>
</ol>
<p>在工程的资产管理中可以组合这几种模式来实现项目的需求：</p>
<p>如果地图副本较多，可以把副本及其资源作为一个 Chunk 管理，如果有一些资源被其他 chunk 中重复引用，可以把这部分资源单独作为 chunk 管理并设置成较高优先级。</p>
<p>可以在资源预览（Reference Viewer）中看到 Chunk<strong>直接 </strong> 引用的资源，需要勾选<code>Show Management References</code>，被 Chunk 引用的类型是<code>EAssetRegistryDependencyType::Manage</code>，并不是普通的 Hard/Soft 资源引用关系。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/3675/20210309191154.webp"></p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/3675/20210309190612.webp"></p>
<p>但是 PrimaryAssetLable 也有个缺点，不能指定 non-uasset 文件，如果我们有更新 lua 或者 db、表格之类的需求，无法通过 <code>PrimaryAssetLable</code> 机制来进行打包和划分，这个需求可以通过 <a href="https://github.com/hxhb/HotPatcher">HotPatcher</a> 实现，HotPatcher 也实现了类似 PrimaryAssetLable 的 Chunk 的功能用于拆分 Patch，详情见之前的文章：<a href="https://imzlp.me/posts/17590/">UE4 资源热更打包工具 HotPatcher</a>。</p>
<p>当我们使用了 <code>PrimaryAssetLable</code> 并且在 <code>Project Settings</code>-<code>Packaging</code> 中开启了<code>Generate Chunks</code>，在打包时就会按照配置的规则生成多个 pak 文件了：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\PCVersion\WindowsNoEditor&gt;tree /a /f</span><br><span class="line">|   ClientGame.exe</span><br><span class="line">|   Manifest_DebugFiles_Win64.txt</span><br><span class="line">|   Manifest_NonUFSFiles_Win64.txt</span><br><span class="line">|   </span><br><span class="line">+---Engine</span><br><span class="line">\---ClientGame</span><br><span class="line">    +---Binaries</span><br><span class="line">    |   \---Win64</span><br><span class="line">    |           ClientGame.exe</span><br><span class="line">    |           ClientGame.pdb</span><br><span class="line">    |           </span><br><span class="line">    +---Content </span><br><span class="line">    |   \---Paks</span><br><span class="line">    |           pakchunk0-WindowsNoEditor.pak</span><br><span class="line">    |           pakchunk1-WindowsNoEditor.pak</span><br><span class="line">    |           pakchunk2-WindowsNoEditor.pak</span><br><span class="line">    |           </span><br><span class="line">    \---Plugins</span><br></pre></td></tr></table></figure>

<p>这里生成的多个 chunks 的 pak 文件可以设置在上一篇拆分基础包的规则文件中，实现基础包拆分的功能。</p>
<h2 id="资产审计"><a href="# 资产审计" class="headerlink" title="资产审计"></a>资产审计 </h2><h3 id="Asset-Audit"><a href="#Asset-Audit" class="headerlink" title="Asset Audit"></a>Asset Audit</h3><p> 在上面的两节中分别介绍了 UE 中打包的项目配置和为资产划分 Chunk 的方式，本节会介绍在日常开发中进行资产审计的方式和工具。</p>
<p>通过<strong>Chunk 划分</strong>，这一节的介绍，我们可以标记一些资源打包到 pak 中去，但是我们无法很直观地知道被这个 chunk 所管理的资源有多少，在每个平台的大小，因为 UE 打包时需要执行 cook，每个资源的最终大小都是平台相关的，所以需要一种方法能够直观地看到基础包内 Chunk 的资源划分。</p>
<p>UE 提供了资产审计工具：Asset Audit，可以在 Editor 中通过 <code>Windows</code>-<code>Developer Tools</code>-<code>Asset Audit</code> 打开。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210202194343.webp"></p>
<p>可以看到资源路径、大小、位于哪些 Chunk 中等一系列的信息，便于排查资源大小和 Chunk 中的资源冗余。</p>
<p>前面已经提到了 <code>Editor</code> 里的看到的资源大小和最终打到包内的大小是不一样的，在 Asset Audit 窗口的右上角会列出已经打包的平台（Saved/Cooked）下的平台。</p>
<p><code>Asset Audit</code>是需要读取 <code>DevelopmentAssetRegistry.bin</code> 文件来得到某个平台的资源信息的，当打包某个平台之后，存储在以下路径中：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Client\Saved\Cooked\WindowsNoEditor\Client\Metadata\DevelopmentAssetRegistry.bin</span><br></pre></td></tr></table></figure>
<p>这个文件记录着某个平台执行完 Cook 之后资源的大小以及引用关系等信息，注意 Cook 之后的资源如 Texture2D 等设置的压缩均以执行，但是打包成 pak 时也会执行压缩，这里列出来的大小是没有经过打包 pak 压缩的 Cook 资源之后的原始大小。</p>
<p>可以在打包时自动提取 Cooked 目录下的 Metadata 目录，在 AssetAudit 窗口的右上角选择 Custom，选择 DevelopmentAssetRegistry.bin 文件即可。</p>
<h3 id="UnrealPakViewer"><a href="#UnrealPakViewer" class="headerlink" title="UnrealPakViewer"></a>UnrealPakViewer</h3><p><a href="https://github.com/jashking/UnrealPakViewer">UnrealPakViewer</a>是一个可以查看 Pak 文件的工具，可以方便地查看 Pak 中的文件信息以及从 Pak 中解压文件。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/3675/20210309180515.webp"></p>
<p>作者还支持了指定加载 AssetRegistry 文件，因为默认情况下 AssetRistry.bin 只在 Chunk0 中包含，打开不包含 AssetRegistry.bin 的 pak 是无法预览出资源类型的，可以通过指定外部文件的 AssetRegistry.bin 来使用，UnrealPakViewer 可以与 AssetAudit 结合起来用作为日常工程的资产审计工具。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>热更新</category>
      </categories>
      <tags>
        <tag>资源审计</tag>
        <tag>HotPatcher</tag>
        <tag>热更新</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 热更新：需求分析与方案设计</title>
    <url>/wiki/17371/</url>
    <content><![CDATA[<p>游戏热更新是在玩家不重新安装游戏的前提下获取最新游戏内容的方式，在 PC 和移动端的网络游戏中有很多应用，因为游戏上上线后要快速调整、修复 bug、更新内容等等。如果每修改一点点内容都需要玩家去 AppStore 更新应用，甚至去网站手动下载再安装，而且不同的平台对于游戏的审核规则和反馈时间也不一致，运营也会疯掉。</p>
<p>在其他引擎中的热更应该有比较成熟的方案，但是在 UE 里还没看到有比较全面的文章来讲 UE4 的热更实现的文章，恰好之前分析和实现了 UE4 热更的内容，准备写两篇文章来记录一下思路和实现方案，并会实现一个可以运行的 Demo，希望能对有需要的朋友一点帮助。</p>
<p>为了方便地统一收集和管理热更新和 HotPatcher 常见的问题与解决方案，我新建了一篇文章来记录和整理：<a href="https://imzlp.com/posts/16895/">UE4 热更新：Questions &amp; Answers</a>，遇到问题可以先去看这个 FAQ 页面。</p>
<span id="more"></span>

<p>本篇文章会从 <strong> 需求分析 </strong>、<strong> 方案设计 </strong> 两个部分入手，主要是研究热更方案时的思考总结。热更的具体实现写到下一篇文章中。</p>
<h3 id="核心需求分析"><a href="# 核心需求分析" class="headerlink" title="核心需求分析"></a>核心需求分析 </h3><p> 因为是 <strong> 热更新</strong>，实际上是要把游戏内容的更新推迟到运行时，从最简单但是最核心的流程上来说是下面这样的执行结构：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/17371/hotupdate-flow.svg"></p>
<p>根据上面的流程图可以把热更要做的具体任务拆分成以下几个要解决的问题：</p>
<ol>
<li>UE 中哪些内容可以被热更？</li>
<li>如何打包可以热更的内容和管理热更？</li>
<li>UE 里如何使用热更下载下来的资源包？</li>
<li>如何对比本地和服务器最新的版本？</li>
<li>热更文件的下载和校验</li>
</ol>
<p>热更新的需求里 <strong> 最重要 </strong> 的是要解决 <strong> 如何打包资源 </strong> 和进行 <strong> 版本管理 </strong> 的问题，至于下载流程则不同的业务自己变动，我这里只写最基本可以实现热更的下载更新流程。</p>
<p>一条条来分析这些问题。</p>
<h3 id="在 UE 中哪些内容可以被热更？"><a href="# 在 UE 中哪些内容可以被热更？" class="headerlink" title="在 UE 中哪些内容可以被热更？"></a>在 UE 中哪些内容可以被热更？</h3><p>首先，从 <strong> 程序角度 </strong> 来说，UE 官方提供 C++ 和蓝图作为引擎提供的开发语言和脚本，而 C++ 是个编译型语言，所有的变动都需要执行编译操作，所以 C++ 的代码无法热更。而 <strong> 蓝图 </strong> 本质上是 <strong> 资产 (uasset)<strong>，资产的更新并不需要重新安装，所以使用</strong> 蓝图 </strong> 所写的游戏逻辑是可以热更的。</p>
<p>但是，蓝图毕竟是 <strong> 资源</strong>，这就要求当每改动一点点蓝图逻辑，都需要执行 Cook 才可以打包，更新起来很不方便，而且蓝图项目协同开发很难管理，所以需要集成一种文本化的脚本语言。</p>
<p>在国内的游戏开发以集成 <a href="https://www.lua.org/">Lua</a> 为业务脚本的居多，腾讯也开源了两个 UE 集成 Lua 的插件，分别是 <a href="https://github.com/Tencent/sluaunreal">sluaunreal</a> 和<a href="https://github.com/hxhb/debugable-unlua">UnLua</a>，可以在 UE 内集成 Lua 的脚本来替代蓝图写业务逻辑。</p>
<p>我在项目中选择的是 <a href="https://github.com/hxhb/debugable-unlua">UnLua</a>，并且我在 UnLua 的官方版本基础上集成了一些常用的 Lua 库、编辑器的拓展、常用的库导出、以及一些 bug 的修复。在 Github 上开源：<a href="https://github.com/hxhb/debugable-unlua">debugable-unlua</a>，我会<strong> 不定期 </strong> 地合并官方版本。</p>
<p>我之前的一篇文章写了使用 UnLua 的一些内容：<a href="https://imzlp.com/posts/36659/">UE4 热更新：基于 UnLua 的 Lua 编程指南</a></p>
<p>其次，<strong>工程内的所有 uasset 资源 </strong>（地图、蓝图、模型、动画、贴图、UMG、音频、字体等等）资源也是可以更新的，UE 的 uasset 在打包之前都需要 Cook，而 Cook 的含义是把 UE 中<strong> 平台无关 </strong> 的虚幻内部格式转换为特定平台的格式，因为各个平台使用自己的专有格式或者各个平台上具有性能更好的存储格式。</p>
<p>以 Windows 为例，在对 UE 的工程进行打包后会产生出类似下面这种路径关系的文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\Examples\PackageExample\Package&gt;tree /f</span><br><span class="line">卷 Windows 的文件夹 PATH 列表 </span><br><span class="line"> 卷序列号为 BAB5-5234</span><br><span class="line">C:.</span><br><span class="line">└─WindowsNoEditor</span><br><span class="line">    │  Manifest_NonUFSFiles_Win64.txt</span><br><span class="line">    │  PackageExample.exe</span><br><span class="line">    │</span><br><span class="line">    ├─Engine</span><br><span class="line">    │  ├─ ...</span><br><span class="line">    │</span><br><span class="line">    └─PackageExample</span><br><span class="line">        └─Content</span><br><span class="line">            └─Paks</span><br><span class="line">                PackageExample-WindowsNoEditor.pak</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中 <code>Content/Paks</code> 下的 <code>*.pak</code> 文件就是 UE 打包出的所有非代码资源，游戏启动时会从 pak 里读取资源，里面不仅仅只有 uasst 的内容，可以这么理解：pak 就是游戏运行所需要的资源包。pak 中支持的内容就是 UE 热更所支持的内容。</p>
<p>默认情况下（未设置忽略文件）UE4 打包时会默认把工程中的资源都打包到一个 Pak 文件中，具体有以下内容：</p>
<p>以下描述中有几个关键字：<code>PROJECT_NAME</code>项目名，<code>PLATFORN_NAME</code>打包的平台名。</p>
<ul>
<li><p>Package 时不会检测资源是否有引用，工程内的所有资源都会被 Cook 然后打包到 Pak 里；</p>
</li>
<li><p>引擎 Slate 的资源文件<code>Engine\Content\Slate\</code>，字体 / 图片等等</p>
</li>
<li><p>引擎的 <code>Content\Internationalization</code> 下相关语言的文件</p>
</li>
<li><p>引擎和启用插件目录下的 <code>Content\Localization</code> 的<code>locmeta</code>/<code>locres</code>文件</p>
</li>
<li><p>项目的 <code>uproject</code> 文件，挂载点为<code>../../../PROJECT_NAME/PROJECT_NAME.uproject</code>；</p>
</li>
<li><p>项目启用的所有插件的 <code>uplugin</code> 文件，挂载点为插件的相对与 <code>../../../Engine/</code> 或者 <code>../../../PROJECT_NAME/Plugins/</code> 的路径；</p>
</li>
<li><p>项目目录下 <code>Intermediate\Staging\PROJECT_NAME.upluginmanifest</code> 文件，挂载点为<code>../../../PROJECT_NAME/Plugins/PROJECT_NAME.upluginmanifest</code></p>
</li>
<li><p>引擎的 ini 文件，在引擎的 <code>Engine/Config</code> 下除了 <code>Editor</code> 的 ini 和 <code>BaseLightmass.ini</code>/<code>BasePakFileRules.ini</code> 之外都包含；</p>
</li>
<li><p>引擎下平台的 ini，在 <code>Engine/Config/PLATFORM_NAME</code> 内的所有 ini 文件；</p>
</li>
<li><p>项目启用的插件的 ini，在插件的目录的 config 下；</p>
</li>
<li><p>Cook 出来的<code>AssetRegistry.bin</code>；</p>
</li>
<li><p>Cook 出的<code>PLATFORN_NAME\Engine\GlobalShaderCache*.bin</code>；</p>
</li>
<li><p>Cook 出来的 <code>PLATFORM_NAME\PROJECT_NAME\Content\ShaderArchive-*.ushaderbytecode</code> 文件</p>
</li>
<li><p>通过 <code>Project Setting</code>-<code>Packaing</code>-<code>Add Non-Asset Directory*</code> 等添加的非 uasst 文件</p>
</li>
</ul>
<p>以上这些文件在 UE 中都是可以热更的。</p>
<p>可以在 <code>Engine\Config\BaseGame.ini</code> 中看到相关配置：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line">+<span class="attr">EarlyDownloaderPakFileFiles</span>=...\Content\Internationalization\...\*.icu</span><br><span class="line">+<span class="attr">EarlyDownloaderPakFileFiles</span>=...\Content\Internationalization\...\*.brk</span><br><span class="line">+<span class="attr">EarlyDownloaderPakFileFiles</span>=...\Content\Internationalization\...\*.res</span><br><span class="line">+<span class="attr">EarlyDownloaderPakFileFiles</span>=...\Content\Internationalization\...\*.nrm</span><br><span class="line">+<span class="attr">EarlyDownloaderPakFileFiles</span>=...\Content\Internationalization\...\*.cfu</span><br><span class="line">+<span class="attr">EarlyDownloaderPakFileFiles</span>=...\Content\Localization\...\*.*</span><br><span class="line">+<span class="attr">EarlyDownloaderPakFileFiles</span>=...\Content\Localization\*.*</span><br><span class="line">+<span class="attr">EarlyDownloaderPakFileFiles</span>=...\Content\Certificates\...\*.*</span><br><span class="line">+<span class="attr">EarlyDownloaderPakFileFiles</span>=...\Content\Certificates\*.*</span><br><span class="line"><span class="comment">; have special cased game localization so that it&#x27;s not required for early pak file</span></span><br><span class="line">+<span class="attr">EarlyDownloaderPakFileFiles</span>=-...\Content\Localization\Game\...\*.*</span><br><span class="line">+<span class="attr">EarlyDownloaderPakFileFiles</span>=-...\Content\Localization\Game\*.*</span><br><span class="line">+<span class="attr">EarlyDownloaderPakFileFiles</span>=...\Config\...\*.ini</span><br><span class="line">+<span class="attr">EarlyDownloaderPakFileFiles</span>=...\Config\*.ini</span><br><span class="line">+<span class="attr">EarlyDownloaderPakFileFiles</span>=...\Engine\GlobalShaderCache*.bin</span><br><span class="line">+<span class="attr">EarlyDownloaderPakFileFiles</span>=...\Content\ShaderArchive-Global*.ushaderbytecode</span><br><span class="line">+<span class="attr">EarlyDownloaderPakFileFiles</span>=...\Content\Slate\*.*</span><br><span class="line">+<span class="attr">EarlyDownloaderPakFileFiles</span>=...\Content\Slate\...\*.*</span><br><span class="line">+<span class="attr">EarlyDownloaderPakFileFiles</span>=...\*.upluginmanifest</span><br><span class="line">+<span class="attr">EarlyDownloaderPakFileFiles</span>=...\*.uproject</span><br><span class="line">+<span class="attr">EarlyDownloaderPakFileFiles</span>=...\global_sf*.metalmap</span><br></pre></td></tr></table></figure>

<p>除了引擎内置的资源类型，要实现 <strong> 程序热更 </strong> 最关键的一点在于：也可以把 <strong> 非资源文件 </strong> 打包到 Pak 中，所以前面提到的使用 <a href="https://github.com/hxhb/debugable-unlua">UnLua</a> 来作为业务脚本后的更新问题就可以解决了。</p>
<h3 id="如何打包热更内容和管理版本？"><a href="# 如何打包热更内容和管理版本？" class="headerlink" title="如何打包热更内容和管理版本？"></a>如何打包热更内容和管理版本？</h3><p> 通过上一小节，可以知道了 UE 能够热更的内容有哪些，热更还有一个最关键的点是：如何把想要更新的内容打包出来作为热更的下载文件？</p>
<p>UE 全平台的打包都有包含 pak 文件（有的在包内，有的则是单独的文件），所以如何把需要的资源打出 pak 就是我们的需求。UE 使用 <code>UnrealPak</code> 这个工具把文件打包成一个 pak，同时 UnrealPak 还提供了查看 Pak 中有哪些文件、以及从 Pak 中解压文件的命令，这部分的内容可以在我之前的一篇文章中查看：<a href="https://imzlp.com/posts/12143/#UnrealPak%E7%9A%84%E5%8F%82%E6%95%B0">UE4 工具链配置与开发技巧 #UnrealPak 的参数</a>，网络上也有不少相关的文章。</p>
<p>UE 打包时会调用 UnrealPak 来生成 Pak 文件，通过打包时收集到的资源信息生成 <code>pak-commandlist.txt</code> 里面记录着要打到 Pak 中的资源信息以及挂载点。</p>
<p>基础命令如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">UnrealPak.exe D:\TEST.pak -create=<span class="string">&quot;XXXXXXX.txt&quot;</span></span><br></pre></td></tr></table></figure>

<p>只是单纯地打出 pak 的问题可以直接调用 <code>UnrealPak</code>，而热更另一个更重要的点在于：<strong> 该如何控制把哪些资源打包到指定的 pak 里？</strong></p>
<p>其实 UE 本身提供了类似 <code>Chunk</code> 的功能，但是用起来很不方便，需要给每个资源指定 chunk id，只有打包才会产生，没有办法很方便地控制每个 pak 中会包含哪些资源。</p>
<p>而且 UE 默认打包的时候只能添加 <code>Content</code> 路径下的非资源文件，这样的限制就导致了很多文件没办法很方便地更新。虽然在 <code>Project Launcher</code> 中也提供了打 Patch 的操作，但是哪些资源会被打包进来是黑盒的，没办法精确地知道这个 Patch 中会包含哪些文件。而且还无法基于一个 Patch 再打出一个 Patch，这些问题导致官方的打包方案解决不了我们的热更需求。</p>
<p>所以我开发了一款插件用来解决这些问题，开源在 Github 上：<a href="https://github.com/hxhb/HotPatcher">hxhb/HotPatcher</a>，以及文档介绍：<a href="https://imzlp.com/posts/17590/">UE4 资源热更打包工具 HotPatcher</a></p>
<p>它的功能就是为了方便地在 UE 编辑器中来指定把哪些资源、哪个文件打包到哪个 pak 中，而且还提供了一键 Cook 多平台的功能，可以一键打出多个平台的 pak 包，支持导出版本信息，支持迭代 Patch。</p>
<p>核心思路为：打基础包时可以通过 <a href="https://github.com/hxhb/HotPatcher">HotPatcher</a> 导出基础包内的资源信息，在变动了工程中内容时，通过导入 <strong> 基础包内的资源信息 </strong> 与当前工程中的资源信息进行比对，得到差异资源，将差异资源打包到 Pak 中。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/17371/ue4-hotpatcher-by-release.webp"></p>
<p>本篇文章不详细介绍 <a href="https://github.com/hxhb/HotPatcher">HotPatcher</a> 的用法，具体的使用文档和参数说明可以从上面的文档链接中查看。</p>
<p>总的来说，使用 <a href="https://github.com/hxhb/HotPatcher">hxhb/HotPatcher</a> 就可以实现 UE 热更资源的打包和热更版本的管理！</p>
<h3 id="UE 里如何使用热更下载下来的资源包？"><a href="#UE 里如何使用热更下载下来的资源包？" class="headerlink" title="UE 里如何使用热更下载下来的资源包？"></a>UE 里如何使用热更下载下来的资源包？</h3><p>这里所说的 <strong> 资源包 </strong> 就是上一小节打包出来的 pak 文件。</p>
<p>UE 默认情况下提供了自动挂载 Pak 的三个路径：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># relative to Project Path</span></span><br><span class="line">Content/Paks/</span><br><span class="line">Saved/Paks/</span><br><span class="line"><span class="comment"># relative to Engine Path</span></span><br><span class="line">Content/Paks</span><br></pre></td></tr></table></figure>

<p>在我之前的笔记中记录了引擎启动时加载 Pak 的流程：<a href="https://imzlp.com/notes/#UE4-%E5%BC%95%E6%93%8E%E5%90%AF%E5%8A%A8%E6%97%B6Pak%E7%9A%84%E5%8A%A0%E8%BD%BD">UE4: 引擎启动时 Pak 的加载</a></p>
<p>把打出来的 Pak 直接放到这三个目录下，在没有开启 <code>Signing</code> 的情况下，是会默认加载这三个路径下的所有 Pak 的。从测试角度来说，可以把打包出来的 pak 文件放到这三个文件夹下的其中一个，再启动游戏，游戏就会自动挂载。</p>
<p>这又衍生出来了另一个问题。<strong>怎么让 UE 知道我哪个 Pak 文件是最新的？</strong></p>
<p>因为热更就是要把新更新的资源替换掉之前的旧的资源，必须要能够找到我们指定的最新的 pak 所有的新内容才会生效。</p>
<p>以引擎自动挂载的那三个路径为例，引擎从文件夹层面给这三个路径分别的优先级：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime\PakFile\Private\IPlatformFilePak.cpp</span></span><br><span class="line"><span class="function">int32 <span class="title">FPakPlatformFile::GetPakOrderFromPakFilePath</span><span class="params">(<span class="keyword">const</span> FString&amp; PakFilePath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (PakFilePath.<span class="built_in">StartsWith</span>(FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%sPaks/%s-&quot;</span>), *FPaths::<span class="built_in">ProjectContentDir</span>(), FApp::<span class="built_in">GetProjectName</span>())))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (PakFilePath.<span class="built_in">StartsWith</span>(FPaths::<span class="built_in">ProjectContentDir</span>()))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (PakFilePath.<span class="built_in">StartsWith</span>(FPaths::<span class="built_in">EngineContentDir</span>()))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (PakFilePath.<span class="built_in">StartsWith</span>(FPaths::<span class="built_in">ProjectSavedDir</span>()))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到位于 <code>Content/Paks</code> 目录下并且以项目名为前缀的 pak 文件默认具有最高优先级，其次分别为<code>Project/Content/Paks</code>&gt;<code>Engine/Content/Pak</code>&gt;<code>Saved/Paks</code>。</p>
<p><strong>而且</strong>，Pak 文件的命名也会对优先级有影响。</p>
<p>以 <code>_Num_P.pak</code> 结尾的文件，其中 <code>Num</code> 是数字，Patch 包的优先级高于普通的 pak，在 <code>IPlatformFilePak.cpp</code> 中默认给 <code>_P.pak</code> 的<code>PakOrder</code>加了 100，<code>_P.pak</code>前面的数字越大，其加载的优先级就越高。</p>
<p>这个 <strong> 优先级 </strong> 数组会用在 <code>mount pak</code> 时，需要给每个 pak 文件指定，用与引擎在进行资源查找、文件加载时精确地找到哪个 pak 中的文件才是最新的版本。</p>
<p>但是这种情况下如果被恶意者知道了规则，故意把 pak 的文件命名给搞乱了，就会导致程序错误，所以不建议直接使用基于文件命名来确定优先级的规则，自己在热更时应该做一次校验。</p>
<p>还有，为了热更需求，需要自己控制 pak 的挂载时机，这就需要自己来调用 <code>MountPak</code> 的函数，我写了一个封装函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">MountPak</span><span class="params">(<span class="keyword">const</span> FString&amp; PakPath, int32 PakOrder, <span class="keyword">const</span> FString&amp; InMountPoint)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">bool</span> bMounted = <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !WITH_EDITOR</span></span><br><span class="line">	FPakPlatformFile* PakFileMgr=(FPakPlatformFile*)FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">GetPlatformFile</span>(FPakPlatformFile::<span class="built_in">GetTypeName</span>());</span><br><span class="line">	<span class="keyword">if</span> (!PakFileMgr)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">UE_LOG</span>(LogTemp, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;GetPlatformFile(TEXT(\&quot;PakFile\&quot;) is NULL&quot;</span>));</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	PakOrder = FMath::<span class="built_in">Max</span>(<span class="number">0</span>, PakOrder);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (FPaths::<span class="built_in">FileExists</span>(PakPath) &amp;&amp; FPaths::<span class="built_in">GetExtension</span>(PakPath) == <span class="built_in">TEXT</span>(<span class="string">&quot;pak&quot;</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">const</span> TCHAR* MountPount = InMountPoint.<span class="built_in">GetCharArray</span>().<span class="built_in">GetData</span>();</span><br><span class="line">		<span class="keyword">if</span> (PakFileMgr-&gt;<span class="built_in">Mount</span>(*PakPath, PakOrder,MountPount))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogTemp, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;Mounted = %s, Order = %d, MountPoint = %s&quot;</span>), *PakPath, PakOrder, !MountPount ? <span class="built_in">TEXT</span>(<span class="string">&quot;(NULL)&quot;</span>) : MountPount);</span><br><span class="line">			bMounted = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogTemp, Error, <span class="built_in">TEXT</span>(<span class="string">&quot;Faild to mount pak = %s&quot;</span>), *PakPath);</span><br><span class="line">			bMounted = <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span> bMounted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当 Pak 文件从服务器下载下来时就可以调用这个函数来把 Pak 挂载的到引擎中，只要 <strong> 保证 </strong><code>PakOrder</code> 没问题，之后就不需要管 pak 的问题了，加载文件时引擎会自动找到最新版本的资源。</p>
<blockquote>
<p>注意：一般情况下都是在一个新地图中执行热更的流程，热更之前不要执行任何加载游戏资源的行为，不然如果一个资源在热更之前被加载了一遍，之后就算把新的 pak 挂载上，已经加载的资源也不会更新。</p>
</blockquote>
<h3 id="如何对比本地版本与服务器最新的版本？"><a href="# 如何对比本地版本与服务器最新的版本？" class="headerlink" title="如何对比本地版本与服务器最新的版本？"></a>如何对比本地版本与服务器最新的版本？</h3><p>不同的业务可以做不同的处理，关键思路就是：游戏启动时热更模块会最先去请求服务器上所有的热更版本信息，然后客户端会根据本体包的版本信息来扫描本地已经下载的 patch，把两个信息进行比对之后就可以分析出需要下载哪些版本。</p>
<p>简单的思路是写一个 json 的文件，记录着所有的 patch 信息（文件名、MD5 值），每次客户端启动时会去下载这个 json 的文件，并解析出来。然后客户端本地从指定的文件夹中去扫描 pak 文件，把文件名和 MD5 值进行比对检查，分析出本地合法的 pak 列表，再与服务器的版本列表进行比对，把差异部分下载即可。</p>
<h3 id="热更文件的下载与校验？"><a href="# 热更文件的下载与校验？" class="headerlink" title="热更文件的下载与校验？"></a>热更文件的下载与校验？</h3><p>上一部分写到了从服务器请求和本地版本扫描分析出来当前用户需要下载的 Patch 版本，这一部分就讲在 UE 中如何下载和校验。</p>
<p>UE 本身提供了跨平台的的 HTTP 库，可以使用引擎中 <code>Online</code> 下的 <code>HTTP</code> 模块：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">HttpRequest = FHttpModule::<span class="built_in">Get</span>().<span class="built_in">CreateRequest</span>();</span><br><span class="line">HttpRequest-&gt;<span class="built_in">OnRequestProgress</span>().<span class="built_in">BindUObject</span>(<span class="keyword">this</span>, &amp;UDownloadProxy::OnDownloadProcess);</span><br><span class="line">HttpRequest-&gt;<span class="built_in">OnProcessRequestComplete</span>().<span class="built_in">BindUObject</span>(<span class="keyword">this</span>, &amp;UDownloadProxy::OnDownloadComplete);</span><br><span class="line">HttpRequest-&gt;<span class="built_in">SetURL</span>(InternalDownloadFileInfo.URL);</span><br><span class="line">HttpRequest-&gt;<span class="built_in">SetVerb</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;GET&quot;</span>));</span><br><span class="line">HttpRequest-&gt;<span class="built_in">ProcessRequest</span>();</span><br></pre></td></tr></table></figure>

<p><strong>但是 </strong>，我又要说但是了，直接默认使用这样 HTTP 下载，需要在文件下载完毕时再写入到文件中，如果文件很大写入很花时间，会阻塞。而且，需要对下载的文件进行校验，我选择的是 MD5，MD5 是摘要算法，需要把文件从头到尾读一遍才能计算出结果，如果<strong> 下载 </strong>、<strong> 存储 </strong>、<strong> 校验 </strong> 三步都拆开来做，其实浪费了很多时间。</p>
<p>所以我简单封装了一个下载库，支持 <strong> 边下边存 </strong>/<strong> 边下边计算 MD5</strong>，这样当文件下载完也已经存到本地了，并且还计算出了 MD5 值可以供校验用。还支持暂停 / 继续 / 分片下载，自己改一下也可以改成断点续传的。</p>
<p>同样是 UE 的插件，并开源在 Github 上：<a href="https://github.com/hxhb/ue4-dtkit">ue4-dtkit</a>，支持 IOS/Android/Windows/Mac 四个平台。</p>
<p>在这个插件我还封装了一个 <code>MD5Wrapper.hpp</code> 可以用来在其他地方的 MD5 计算，使用的是 <code>OpenSSL</code> 的库。</p>
<p>在下载之后拿到了文件的 MD5 之后再与服务器的版本信息里的 MD5 进行比对，完全匹配的情况下就可以 <code>MountPak</code> 了。</p>
<h3 id="结语"><a href="# 结语" class="headerlink" title="结语"></a>结语 </h3><p> 本篇文章的主要内容是介绍了 UE 里热更的思路和可以使用的工具，主要的重点在于 UE4 里的资源打包，使用我写的 <a href="https://github.com/hxhb/HotPatcher">hxhb/HotPatcher</a> 可以比较方便地来完成这个工作，至于下载和验证的流程，我的这部分只做参考，可以根据自己的流程自己实现。</p>
<p>下一篇热更新的文章会根据本篇文章的思路和工具来具体实现热更的例子，工程和代码也会开源，有时间再来写。不过根据本篇文章的思路和提供的工具自己实现一个问题也不大。</p>
<p>本篇文章列举的工具和文档:</p>
<ul>
<li><a href="https://github.com/hxhb/HotPatcher">hxhb/HotPatcher</a></li>
<li><a href="https://imzlp.com/posts/17590/">UE4 资源热更打包工具 HotPatcher</a></li>
<li><a href="https://github.com/hxhb/ue4-dtkit">ue4-dtkit</a></li>
<li><a href="https://github.com/hxhb/debugable-unlua">debugable-unlua</a></li>
<li><a href="https://imzlp.com/posts/36659/">UE4 热更新：基于 UnLua 的 Lua 编程指南</a></li>
<li><a href="https://imzlp.com/notes/#UE4-%E5%BC%95%E6%93%8E%E5%90%AF%E5%8A%A8%E6%97%B6Pak%E7%9A%84%E5%8A%A0%E8%BD%BD">UE4: 引擎启动时 Pak 的加载</a></li>
<li><a href="https://imzlp.com/posts/12143/#UnrealPak%E7%9A%84%E5%8F%82%E6%95%B0">UE4 工具链配置与开发技巧 #UnrealPak 的参数</a></li>
<li><a href="https://github.com/hxhb/debugable-unlua">Tencent/UnLua</a></li>
</ul>
<h3 id="热更新系列文章"><a href="# 热更新系列文章" class="headerlink" title="热更新系列文章"></a>热更新系列文章</h3><ul>
<li><a href="https://imzlp.com/posts/17371">UE4 热更新：需求分析与方案设计</a></li>
<li><a href="https://imzlp.com/posts/17590/">UE4 资源热更打包工具 HotPatcher</a></li>
<li><a href="https://imzlp.com/posts/10938/">UE4 热更新：基于 HotPatcher 的自动化流程</a></li>
<li><a href="https://imzlp.com/posts/13765/">UE4 热更新：拆分基础包</a></li>
<li><a href="https://imzlp.com/posts/3675">UE4 热更新：资产管理与审计工具</a></li>
<li><a href="https://imzlp.com/posts/5867/">UE4 热更新：Create Shader Patch</a></li>
<li><a href="https://imzlp.com/posts/16895/">UE4 热更新：Questions &amp; Answers</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>热更新</category>
      </categories>
      <tags>
        <tag>HotPatcher</tag>
        <tag>热更新</tag>
      </tags>
  </entry>
  <entry>
    <title>在 UE 中使用 Git 进行版本控制</title>
    <url>/wiki/7647/</url>
    <content><![CDATA[<p>Unreal Editor 中提供的 Source Control 可以通过 Git 实现蓝图项目的 <strong> 版本提交 / 版本比对 / 撤销修改 </strong> 等一些基本功能，远远比不上 Git Bash 强大，但是 BluePrint 间的 Diff 还是很好用的。</p>
<span id="more"></span>
<p>在执行 UE 中的 Git 版本控制之前最好先在 <code>Git Bash</code> 中进行一些 Git 全局的初始化操作。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git config --global user.name <span class="string">&quot;Your Name&quot;</span></span><br><span class="line">$ git config --global user.email <span class="string">&quot;email@example.com&quot;</span></span><br></pre></td></tr></table></figure>

<p>生成 SSH Key(邮件地址换成你自己的邮件地址):</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ssh-keygen -t rsa -C &quot;youremail@example.com&quot;</span><br></pre></td></tr></table></figure>

<p>然后一路 Enter(或者你自己设置密码)，执行完毕后会在 <code>C:\Users\$&#123;userName&#125;\</code>(linux 则是在~/ 下) 下创建一个 <code>.ssh</code> 目录，其中有 <code>id_rsa</code> 和<code>id_rsa.pub</code>两个文件。</p>
<p><code>id_rsa</code>是私钥，不能泄露出去，<code>id_rsa.pub</code>是公钥，可以放心地告诉任何人(保存到 Github/GitLab 的 SSH Key 中)。</p>
<p>更多的 <code>Git Bash</code> 下的一些操作可以看这篇文章——<a href="https://imzlp.com/2016/09/29/git-quick-start-guide/">Git 快速上手指南</a>。</p>
<hr>
<p>打开 UE 项目，在虚幻编辑器中点击<code>Source Control</code></p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/7647/0.webp"></p>
<p>选中<code>connect to Source Contorl</code></p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/7647/1.webp"></p>
<p>在弹出的窗口中 <code>Provider</code> 选项中选择 <code>Git</code> 并在 <code>Git Path</code> 中填入系统中 <code>git.exe</code> 的绝对路径。<br>选中 <code>Add a .gitignore file</code>，然后点击<code>initialize project with Git</code>，最后点击<code>Accept Settings</code> 完成初始化。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/7647/2.webp"></p>
<p>现在，可以看到 <code>Source Control</code> 上出现了绿色的圆圈上有上下两个箭头。</p>
<p>这时我们需要 <code>commit</code> 的一次我们的工程 (同时也是对所有的文件改动进行提交。在这里因为是初始化，所以需要提交一次所有的文件)。点击<code>Source Control</code> 选中<code>Submit to Source Control</code>。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/7647/3.webp"></p>
<p>在弹出的窗口中填入提交信息 (等同于 git 中的<code>add</code> 与<code>commit</code>)，然后点 OK。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/7647/4.webp"></p>
<p><code>Source Control</code>初始化完成，现在我们可以测试一下。</p>
<p>新建一个蓝图类 EmptyActor，只是测试我们写入一个节点。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/7647/5-initBP.webp"></p>
<p>然后在 <code>Content Browser</code> 中右键点击该蓝图类，<code>Source Control</code>-&gt;<code>Check In</code>对该蓝图类做一次 <code> 初始化提交</code>。</p>
<p> <img src="https://img.imzlp.com/imgs/zlp/blog/posts/7647/5-checkIn.webp"></p>
<p>在弹出的窗口中填入相关的信息(commit)，然后点 OK。</p>
<p> <img src="https://img.imzlp.com/imgs/zlp/blog/posts/7647/5-commit.webp"></p>
<p> 现在我们可以再次编辑 EmptyActor 这个蓝图类，但是我们不提交(don’t check in)。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/7647/6-addOtherNode.webp"></p>
<p>可以通过 <code>diff</code> 来检测我们此次相较于上次提交的版本做了哪些修改：在该蓝图类上右键 <code>Source Control</code>-&gt;<code>Diff Against Depot</code>，会弹出<code>diff</code> 窗口。我们可以看到我们在该蓝图类中修改了哪些东西。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/7647/7-diffWindow.webp"></p>
<p>在蓝图类上右键 -&gt;<code>Source Control</code>下共有以下几个选项：<code>Check In</code>/<code>Refresh</code>/<code>History</code>/<code>Diff Against Depot</code>/<code>Revert</code>，其中 <code>Check In</code> 和<code>Diff Against Depot</code>的用途上面已经说过了。</p>
<p><strong>Check In</strong>提交当前文件。</p>
<p><strong>Refresh</strong>刷新当前文件 (蓝图类) 状态(status)。</p>
<p><strong>History</strong>查看提交 (Check In) 的历史，也可以提供当前未提交改动与某一提交版本的区别。</p>
<p> <img src="https://img.imzlp.com/imgs/zlp/blog/posts/7647/8-diffOtherCommit.webp"></p>
<p><strong>Diff Against Depot</strong>查看当前未提交 (Check In) 改动与上次提交版本的区别。</p>
<p><strong>Revert</strong>丢弃当前未提交 (Check In) 改动 (就是回滚到上一次 Check In 时的状态)。注意：Revert 之后需要重启引擎才会生效，这应该是 UE(4.12.5) 的一个 BUG。<strong>Revert</strong>的效果等同于直接在 Git Bash 下执行<code>git checkout -- $&#123;filename&#125;</code>。</p>
<hr>
<p>UE 中集成的 Source Control::Git 是不能够直接在虚幻编辑器中直接回滚到某一提交版本的，总的来说可供操作的功能还比较少 (蓝图的节点比对还是很爽的)，但是可以结合<code>Git Bash</code> 来使用 Git 的其他操作(版本回退 / 分支管理 / 远程推送等等)。</p>
<p>需要注意的是，使用 <code>Git Bash</code> 来进行版本回退的话一定要关闭虚幻编辑器，因为回退需要对文件进行改动，而虚幻编辑器正在占用 (打开) 该文件 (蓝图类)，而对未占用(打开) 的文件 (蓝图类) 进行版本回退也需要重启虚幻编辑器才可以(不重启不会看到回退效果)。</p>
<p>使用 Git 来推送 (push) 和拉取 (pull) 远程分支的话需要在 Git Bash 中执行。同样也需要关闭虚幻编辑器。注意编辑 <code>.gitignore</code> 来忽略不必要的文件来节省 push/pull 时间。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Editor</category>
        <category>VersionControl</category>
      </categories>
      <tags>
        <tag>Git</tag>
        <tag>Source Control</tag>
        <tag>版本控制</tag>
      </tags>
  </entry>
  <entry>
    <title>DDC 共享</title>
    <url>/wiki/11023/</url>
    <content><![CDATA[<p>共享 DDC 的作用是：当同一网络内共享 DDC 的人只要有一个人编译了 DDC，其他人就无需重新编译，节省 Shader 的编译时间，提高效率。</p>
<p>所以，一般情况下只需要在局域网内部署一个高 IO 吞吐的机器，每个人都把该机器的共享目录挂载到本地，就可以实现 DDC 的共享，因为 DDC 的目录是相对于网络路径的，所以每个人的修改都会影响到其他人，从而实现一个编译多人共享的效果。</p>
<p>UE 的文档里介绍了三种设置的方法：</p>
<ul>
<li><a href="https://docs.unrealengine.com/en-US/ProductionPipelines/DerivedDataCache/index.html">Derived Data Cache</a></li>
</ul>
<ol>
<li>修改 <code>DefaultEngine.ini</code> 添加 <code>DerivedDataBackendGraph</code> 项；</li>
<li>系统中添加 <code>UE-SharedDataCachePath</code> 环境变量；</li>
<li>在 UE 的 <code>Editor Preferences</code>-<code>Global</code>-<code>Shared Derived Data Cache</code> 设置共享的 DDC 目录；</li>
</ol>
<p>UE 推荐的是使用第一种方法，但是具体实践和文档中介绍的略有不同。</p>
<p>对于源码版引擎，使用 DDC 文档中介绍的第一种方法，在项目的 <code>DefaultEngine.ini</code> 中添加以下项：</p>
<figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="section">[DerivedDataBackendGraph]</span></span><br><span class="line"><span class="attr">Shared</span>=(Type=FileSystem, ReadOnly=<span class="literal">false</span>, Clean=<span class="literal">false</span>, Flush=<span class="literal">false</span>, DeleteUnused=<span class="literal">true</span>, UnusedFileAge=<span class="number">10</span>, FoldersToClean=<span class="number">10</span>, MaxFileChecksPerSec=<span class="number">1</span>, ConsiderSlowAt=<span class="number">70</span>, PromptIfMissing=<span class="literal">false</span>, Path=\\YourDDCServer\DDC, EnvPathOverride=UE-SharedDataCachePath, EditorOverrideSetting=SharedDerivedDataCache)</span><br></pre></td></tr></table></figure>
<p>但是对于安装版引擎（Installed），要把 <code>DerivedDataBackendGraph</code> 改成<code>InstalledDerivedDataBackendGraph</code>：</p>
<figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="section">[InstalledDerivedDataBackendGraph]</span></span><br><span class="line"><span class="attr">Shared</span>=(Type=FileSystem, ReadOnly=<span class="literal">false</span>, Clean=<span class="literal">false</span>, Flush=<span class="literal">false</span>, DeleteUnused=<span class="literal">true</span>, UnusedFileAge=<span class="number">10</span>, FoldersToClean=<span class="number">10</span>, MaxFileChecksPerSec=<span class="number">1</span>, ConsiderSlowAt=<span class="number">70</span>, PromptIfMissing=<span class="literal">false</span>, Path=\\YourDDCServer\FMGame\DDC, EnvPathOverride=UE-SharedDataCachePath, EditorOverrideSetting=SharedDerivedDataCache)</span><br></pre></td></tr></table></figure>
<p>这是因为引擎在 <code>Developer/DerivedDataCache/Private/DerivedDataBackends.cpp</code> 中对安装版和源码版做了区分：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">FDerivedDataBackendGraph</span>()</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span>(!RootCache)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Use default graph</span></span><br><span class="line">    GraphName = FApp::<span class="built_in">IsEngineInstalled</span>() ? <span class="built_in">TEXT</span>(<span class="string">&quot;InstalledDerivedDataBackendGraph&quot;</span>) : <span class="built_in">TEXT</span>(<span class="string">&quot;DerivedDataBackendGraph&quot;</span>);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在设置完之后就可以通过 Commandlet 来执行 DDC 的生成了：</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">Engine\Binaries\Win64\UE4Editor.exe Client\Client.uproject -run=DerivedDataCache -fill</span><br></pre></td></tr></table></figure>
<p>该 Commandlet 定义在<code>Editor/UnrealEd/Classes/Commandlets/DerivedDataCacheCommandlet.h</code>。</p>
<p>如果想要在配置文件添加之后关闭掉 DDC，可以在 Editor 启动时添加参数<code>-ddc=noshared</code>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
        <category>DDC</category>
      </categories>
      <tags>
        <tag>DDC</tag>
      </tags>
  </entry>
  <entry>
    <title>修改 DDC 的路径</title>
    <url>/wiki/13695/</url>
    <content><![CDATA[<p>源码版与安装版引擎的路径有区别：</p>
<figure class="highlight ini"><figcaption><span>BaseEngine.ini</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="section">[DerivedDataBackendGraph_Fill_Seattle]</span></span><br><span class="line"><span class="attr">MinimumDaysToKeepFile</span>=<span class="number">7</span></span><br><span class="line"><span class="attr">Root</span>=(Type=KeyLength, Length=<span class="number">120</span>, Inner=AsyncPut)</span><br><span class="line"><span class="attr">AsyncPut</span>=(Type=AsyncPut, Inner=Hierarchy)</span><br><span class="line"><span class="attr">Hierarchy</span>=(Type=Hierarchical, Inner=Boot, Inner=Pak, Inner=EnginePak, Inner=Local, Inner=Seattle)</span><br><span class="line"><span class="attr">Boot</span>=(Type=Boot, Filename=<span class="string">&quot;%GAMEDIR%DerivedDataCache/Boot.ddc&quot;</span>, MaxCacheSize=<span class="number">512</span>)</span><br><span class="line"><span class="attr">Local</span>=(Type=FileSystem, ReadOnly=<span class="literal">false</span>, Clean=<span class="literal">false</span>, Flush=<span class="literal">false</span>, PurgeTransient=<span class="literal">true</span>, DeleteUnused=<span class="literal">true</span>, UnusedFileAge=<span class="number">34</span>, FoldersToClean=-<span class="number">1</span>, Path=%ENGINEDIR%DerivedDataCache)</span><br><span class="line"><span class="attr">Seattle</span>=(Type=FileSystem, ReadOnly=<span class="literal">false</span>, Clean=<span class="literal">false</span>, Flush=<span class="literal">false</span>, DeleteUnused=<span class="literal">true</span>, UnusedFileAge=<span class="number">23</span>, FoldersToClean=<span class="number">10</span>, MaxFileChecksPerSec=<span class="number">1</span>, Path=?EpicSeaDDC, EnvPathOverride=UE-SharedDataCachePath_Seattle)</span><br><span class="line"><span class="attr">Pak</span>=(Type=ReadPak, Filename=<span class="string">&quot;%GAMEDIR%DerivedDataCache/DDC.ddp&quot;</span>)</span><br><span class="line"><span class="attr">EnginePak</span>=(Type=ReadPak, Filename=%ENGINEDIR%DerivedDataCache/DDC.ddp)</span><br><span class="line"></span><br><span class="line"><span class="section">[InstalledDerivedDataBackendGraph]</span></span><br><span class="line"><span class="attr">MinimumDaysToKeepFile</span>=<span class="number">7</span></span><br><span class="line"><span class="attr">Root</span>=(Type=KeyLength, Length=<span class="number">120</span>, Inner=AsyncPut)</span><br><span class="line"><span class="attr">AsyncPut</span>=(Type=AsyncPut, Inner=Hierarchy)</span><br><span class="line"><span class="attr">Hierarchy</span>=(Type=Hierarchical, Inner=Boot, Inner=Pak, Inner=CompressedPak, Inner=EnginePak, Inner=EnterprisePak, Inner=Local, Inner=Shared)</span><br><span class="line"><span class="attr">Boot</span>=(Type=Boot, Filename=<span class="string">&quot;%ENGINEUSERDIR%DerivedDataCache/Boot.ddc&quot;</span>, MaxCacheSize=<span class="number">512</span>)</span><br><span class="line"><span class="attr">Local</span>=(Type=FileSystem, ReadOnly=<span class="literal">false</span>, Clean=<span class="literal">false</span>, Flush=<span class="literal">false</span>, PurgeTransient=<span class="literal">true</span>, DeleteUnused=<span class="literal">true</span>, UnusedFileAge=<span class="number">34</span>, FoldersToClean=-<span class="number">1</span>, Path=<span class="string">&quot;%ENGINEVERSIONAGNOSTICUSERDIR%DerivedDataCache&quot;</span>, EditorOverrideSetting=LocalDerivedDataCache)</span><br><span class="line"><span class="attr">Shared</span>=(Type=FileSystem, ReadOnly=<span class="literal">false</span>, Clean=<span class="literal">false</span>, Flush=<span class="literal">false</span>, DeleteUnused=<span class="literal">true</span>, UnusedFileAge=<span class="number">10</span>, FoldersToClean=<span class="number">10</span>, MaxFileChecksPerSec=<span class="number">1</span>, Path=?EpicDDC, EnvPathOverride=UE-SharedDataCachePath, EditorOverrideSetting=SharedDerivedDataCache)</span><br><span class="line"><span class="attr">Pak</span>=(Type=ReadPak, Filename=<span class="string">&quot;%GAMEDIR%DerivedDataCache/DDC.ddp&quot;</span>)</span><br><span class="line"><span class="attr">CompressedPak</span>=(Type=ReadPak, Filename=<span class="string">&quot;%GAMEDIR%DerivedDataCache/Compressed.ddp&quot;</span>, Compressed=<span class="literal">true</span>)</span><br><span class="line"><span class="attr">EnginePak</span>=(Type=ReadPak, Filename=../../../Engine/DerivedDataCache/Compressed.ddp, Compressed=<span class="literal">true</span>)</span><br><span class="line"><span class="attr">EnterprisePak</span>=(Type=ReadPak, Filename=../../../Enterprise/DerivedDataCache/Compressed.ddp, Compressed=<span class="literal">true</span>)</span><br></pre></td></tr></table></figure>

<p>源码版的引擎存在于 <code>Engine/DerivedDataCache</code> 与项目的 <code>DerivedDataCache</code> 目录下。<br>安装版引擎的则位于以下几个路径中：</p>
<ul>
<li>%ENGINEUSERDIR%DerivedDataCache/Boot.ddc</li>
<li>%ENGINEVERSIONAGNOSTICUSERDIR%DerivedDataCache</li>
<li>%GAMEDIR%DerivedDataCache/DDC.ddp</li>
<li>../../../Engine/DerivedDataCache/Compressed.ddp</li>
<li>../../../Enterprise/DerivedDataCache/Compressed.ddp</li>
</ul>
<p>这几个路径规则的真实路径：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/Core/Private/Misc/ConfigCacheIni.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> FConfigExpansion* <span class="title">MatchExpansions</span><span class="params">(<span class="keyword">const</span> TCHAR* PotentialVariable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// Allocate replacement value strings once</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> FConfigExpansion Expansions[] =</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">FConfigExpansion</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%GAME%&quot;</span>), <span class="built_in">FString</span>(FApp::<span class="built_in">GetProjectName</span>())),</span><br><span class="line">    <span class="built_in">FConfigExpansion</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%GAMEDIR%&quot;</span>), FPaths::<span class="built_in">ProjectDir</span>()),</span><br><span class="line">    <span class="built_in">FConfigExpansion</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%ENGINEDIR%&quot;</span>), FPaths::<span class="built_in">EngineDir</span>()),</span><br><span class="line">    <span class="built_in">FConfigExpansion</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%ENGINEUSERDIR%&quot;</span>), FPaths::<span class="built_in">EngineUserDir</span>()),</span><br><span class="line">    <span class="built_in">FConfigExpansion</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%ENGINEVERSIONAGNOSTICUSERDIR%&quot;</span>), FPaths::<span class="built_in">EngineVersionAgnosticUserDir</span>()),</span><br><span class="line">    <span class="built_in">FConfigExpansion</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%APPSETTINGSDIR%&quot;</span>), <span class="built_in">GetApplicationSettingsDirNormalized</span>()),</span><br><span class="line">  &#125;;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以在 BaseEngine.ini 中修改 DDC 的路径占位符，替换为上面的可选路径。</p>
<p>注意：<code>EngineUserDir</code>与 <code>EngineVersionAgnosticUserDir</code> 在安装版与源码版上也有区分：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/Core/Private/Misc/Paths.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function">FString <span class="title">FPaths::EngineUserDir</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">ShouldSaveToUserDir</span>() || FApp::<span class="built_in">IsEngineInstalled</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> FPaths::<span class="built_in">Combine</span>(FPlatformProcess::<span class="built_in">UserSettingsDir</span>(), *FApp::<span class="built_in">GetEpicProductIdentifier</span>(), *FEngineue_version::<span class="built_in">Current</span>().<span class="built_in">ToString</span>(EVersionComponent::Minor)) + <span class="built_in">TEXT</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> FPaths::<span class="built_in">EngineDir</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FString <span class="title">FPaths::EngineVersionAgnosticUserDir</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">ShouldSaveToUserDir</span>() || FApp::<span class="built_in">IsEngineInstalled</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> FPaths::<span class="built_in">Combine</span>(FPlatformProcess::<span class="built_in">UserSettingsDir</span>(), *FApp::<span class="built_in">GetEpicProductIdentifier</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;Common&quot;</span>)) + <span class="built_in">TEXT</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> FPaths::<span class="built_in">EngineDir</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认情况下，如果要完全清理系统中的 DDC 缓存，需要清理以下路径：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Engine\Engine\DerivedDataCache\*</span><br><span class="line">ProjectName\DerivedDataCache\*</span><br><span class="line">C:\Users\username\AppData\Local\UnrealEngine\*</span><br></pre></td></tr></table></figure>
<p>可以使用以下 cmd 命令：</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> y|<span class="built_in">del</span> Engine\DerivedDataCache</span><br><span class="line"><span class="built_in">echo</span> y|<span class="built_in">del</span> ProjectName\DerivedDataCache</span><br><span class="line"><span class="built_in">echo</span> y|<span class="built_in">del</span> C:\Users\username\AppData\Local\UnrealEngine</span><br></pre></td></tr></table></figure>

<p>类似问题：</p>
<ul>
<li><a href="https://forums.unrealengine.com/t/how-to-change-local-data-cache-location/32354">[HOW TO] Change local data cache location</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
        <category>DDC</category>
      </categories>
  </entry>
  <entry>
    <title>Android 在 Windows 的编译环境</title>
    <url>/wiki/52d36a/</url>
    <content><![CDATA[<p>Android 的开发环境需要 JDK/NDK/SDK/Ant/Gradle 等组合而成，UE 的文档中介绍需要安装 NVDIA 的 CodeWorks，但是由于国内网络问题难以下载，并且有些组件并不需要，所以我打包了一份 Android 的开发环境，可以快速部署。</p>
<p>组件版本：</p>
<ul>
<li>JDK 18077</li>
<li>NDK r14b</li>
<li>SDK android19-26</li>
<li>Ant 1.8.2</li>
<li>Gradle 4.1</li>
</ul>
<p>下载地址：<a href="https://stusdnueducn-my.sharepoint.com/:u:/g/personal/2017020625_stu_sdnu_edu_cn/EUEwhi0h05JLvdogvD5qbz0Be96Q6s7n0PlrHng4cqtsiA?e=Lctclf">AndroidSDK_1R7u1_20190923.7z</a>，解压之后有 <code>AddToPath.bat</code> 脚本，一键添加所需的环境变量。</p>
<figure class="highlight bat"><table><tr><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="built_in">set</span> &quot;current_dir_name=<span class="variable">%cd%</span>&quot;</span><br><span class="line">setx JAVA_HOME &quot;<span class="variable">%current_dir_name%</span>\jdk18077&quot;</span><br><span class="line">setx ANDROID_HOME &quot;<span class="variable">%current_dir_name%</span>\android-sdk-windows&quot;</span><br><span class="line">setx ANDROID_NDK_ROOT &quot;<span class="variable">%current_dir_name%</span>\android-ndk-r14b&quot;</span><br><span class="line">setx ANT_HOME &quot;<span class="variable">%current_dir_name%</span>\apache-ant-<span class="number">1</span>.<span class="number">8</span>.<span class="number">2</span>&quot;</span><br><span class="line">setx GRADLE_HOME &quot;<span class="variable">%current_dir_name%</span>\gradle-<span class="number">4</span>.<span class="number">1</span>&quot;</span><br><span class="line">setx NDK_ROOT &quot;<span class="variable">%current_dir_name%</span>\android-ndk-r14b&quot;</span><br><span class="line">setx NDKROOT &quot;<span class="variable">%current_dir_name%</span>\android-ndk-r14b&quot;</span><br><span class="line">setx NVPACK_NDK_TOOL_VERSION &quot;<span class="number">4</span>.<span class="number">9</span>&quot;</span><br><span class="line">setx NVPACK_NDK_VERSION &quot;android-ndk-r14b&quot;</span><br><span class="line">setx NVPACK_ROOT &quot;<span class="variable">%current_dir_name%</span>&quot;</span><br></pre></td></tr></table></figure>

<p>如果需要更新版本的 NDK 和 SDK 支持的版本有些老，可以自行在下载所需的版本：</p>
<ul>
<li><a href="https://androidsdkmanager.azurewebsites.net/SDKPlatform">Online Android SDK Manager</a></li>
<li><a href="https://developer.android.com/ndk/downloads?hl=en">Android Developer NDK Downloads</a></li>
<li><a href="https://developer.android.com/ndk/downloads/older_releases?hl=en">Unsupported NDK Downloads</a></li>
</ul>
<p>下载之后放到对应的目录下即可，并且需要修改环境变量中的值。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/17996/20210416124501.webp"></p>
<p>添加完环境变量之后之后无需再从 UE 中设置 SDK 与 NDK 的路径，保持默认即可打包。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Mobile</tag>
        <tag>Windows</tag>
        <tag>编译环境</tag>
      </tags>
  </entry>
  <entry>
    <title>Android 基础包拆分</title>
    <url>/wiki/12280/</url>
    <content><![CDATA[<p>在打包时，不想要把所有的资源都打包到 apk 中，所以可以在打包时进行拆分，只把必要资源打包到 apk 中，首先需要把基础包中的资源进行 pak 拆分，可以把通过 <code>Project Settings</code>-<code>Asset Manager</code> 中进行设置或者通过创建 <code>PrimaryAssetLable</code> 资源进行标记。</p>
<p>目标是：</p>
<ol>
<li>把基础包的打包资源拆分到多个 Pak 中</li>
<li>只把必要的 pak 文件打包到 apk 里</li>
<li>其余的 pak 在运行时进行下载</li>
</ol>
<p>第一步都可以通过项目设置进行控制，第二部的条件就是要实现一个过滤规则，不过 UE 已经提供了这个机制，可以指定过滤掉哪些文件，只需要添加配置即可。</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Config/DefaultEngine.ini</span></span><br><span class="line"><span class="section">[/Script/AndroidRuntimeSettings.AndroidRuntimeSettings]</span></span><br><span class="line">+<span class="attr">ObbFilters</span>=-pakchunk1-*</span><br><span class="line">+<span class="attr">ObbFilters</span>=-pakchunk2-*</span><br><span class="line">+<span class="attr">ObbFilters</span>=-pakchunk3-*</span><br></pre></td></tr></table></figure>
<p>ObbFilters 的规则以 <code>-</code> 开头就是排除规则，会把基础包中的 <code>chunk1-3</code> 的 pak 给过滤掉，可以用于后续的下载流程。</p>
<p>也可以指定 <code>Exclute</code> 和<code>Include</code>规则组合来用：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line">+<span class="attr">ObbFilters</span>=-*.pak</span><br><span class="line">+<span class="attr">ObbFilters</span>=pakchunk0-*</span><br></pre></td></tr></table></figure>
<p>第一步忽略掉所有的 pak 文件，然后把 <code>pakchunk0-*.pak</code> 显式添加至 obb 中。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Mobile</tag>
      </tags>
  </entry>
  <entry>
    <title>Android 常用的工具和命令</title>
    <url>/wiki/6fa72650/</url>
    <content><![CDATA[<h3 id="Adb"><a href="#Adb" class="headerlink" title="Adb"></a>Adb</h3><p>adb 是 Android 的调试工具，非常强大，熟悉一些 adb 的命令能够让效率加倍。首先先要下载<a href="https://img.imzlp.com/imgs/zlp/blog/notes/tips/index/Adb.7z">Adb</a>。</p>
<h4 id="安装 Apk"><a href="# 安装 Apk" class="headerlink" title="安装 Apk"></a>安装 Apk</h4><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">$ adb install APK_FILE_NAME.apk</span><br></pre></td></tr></table></figure>

<h4 id="启动 App"><a href="# 启动 App" class="headerlink" title="启动 App"></a>启动 App</h4><p>安装的 renderdoccmd 是没有桌面图标的，想要自己启动的话只能使用下列 adb 命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb shell am start org.renderdoc.renderdoccmd.arm64/.Loader -e renderdoccmd <span class="string">&quot;remoteserver&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><a href="https://stusdnueducn-my.sharepoint.com/:f:/g/personal/2017020625_stu_sdnu_edu_cn/EnnSRgeQZOZAmytO_Mm6nD0BQ9HOk42Ximo78ovuzOVEQg?e=xCoutx">renderdoc-cmd-apk</a></li>
</ul>
<p>adb 启动 App 的 shell 命令模板:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb shell am start PACKAGE_NAME/.ActivityName</span><br></pre></td></tr></table></figure>

<p>这个方法需要知道 App 的包名和 Activity 名，包名很容易知道，但是 Activity 如果不知道可以通过下列操作获取：</p>
<p>首先使用一个反编译工具将 apk 解包(可以使用之前的<a href="https://imzlp.com/notes/#apk%E7%9A%84%E5%8F%8D%E7%BC%96%E8%AF%91%E4%B8%8E%E7%AD%BE%E5%90%8D">apktools</a>)：</p>
<figure class="highlight bat"><table><tr><td class="code"><pre><span class="line">apktool.bat d -o ./renderdoccmd_arm64 org.renderdoc.renderdoccmd.arm64.apk</span><br></pre></td></tr></table></figure>

<p>然后打开 <code>org.renderdoc.renderdoccmd.arm64</code> 目录下的 <code>AndroidManifest.xml</code> 文件，找到其中的 <code>Application</code> 项：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; standalone=&quot;no&quot;?&gt;</span><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span> <span class="attr">package</span>=<span class="string">&quot;org.renderdoc.renderdoccmd.arm64&quot;</span> <span class="attr">platformBuildVersionCode</span>=<span class="string">&quot;26&quot;</span> <span class="attr">platformBuildVersionName</span>=<span class="string">&quot;8.0.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-feature</span> <span class="attr">android:glEsVersion</span>=<span class="string">&quot;0x00030000&quot;</span> <span class="attr">android:required</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span> <span class="attr">android:debuggable</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:hasCode</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:icon</span>=<span class="string">&quot;@drawable/icon&quot;</span> <span class="attr">android:label</span>=<span class="string">&quot;RenderDocCmd&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:configChanges</span>=<span class="string">&quot;keyboardHidden|orientation&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:label</span>=<span class="string">&quot;RenderDoc&quot;</span> <span class="attr">android:name</span>=<span class="string">&quot;.Loader&quot;</span> <span class="attr">android:screenOrientation</span>=<span class="string">&quot;landscape&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;android.app.lib_name&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;renderdoccmd&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>其中有所有注册的<code>Activity</code>，没有有界面的 apk 只有一个 Activity，所以上面的 renderdoccmd 的主 Activity 就是<code>.Loader</code>。</p>
<p>如果说有界面的 app，则会有多个，则可以从 <code>AndroidManifest.xml</code> 查找 <code>Category</code> 或者根据命名 (名字带<code>main</code> 的 Activity)来判断哪个是主 Activity。一般都是从 lanucher 开始，到 main，或者有的进登陆界面。</p>
<blockquote>
<p>PS：使用 UE 打包出游戏的主 Activity 是<code>com.epicgames.ue4.SplashActivity</code>，可以通过下列命令启动。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">adb shell am start com.imzlp.GWorld/com.epicgames.ue4.SplashActivity</span><br></pre></td></tr></table></figure>

<h4 id="传输文件"><a href="# 传输文件" class="headerlink" title="传输文件"></a>传输文件 </h4><p> 使用 adb 往手机传文件：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta"># adb push 1.0_Android_ETC2_P.pak /sdcard/Android/data/com.imzlp.TEST/files/UE4GameData/Mobile422/Mobile422/Saved/Paks</span></span><br><span class="line">$ adb push FILE_NAME REMOATE_PATH</span><br></pre></td></tr></table></figure>

<p>从手机传递到电脑：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta"># adb pull /sdcard/Android/data/com.imzlp.TEST/files/UE4GameData/Mobile422/Mobile422/Saved/Paks/1.0_Android_ETC2_P.pak A.Pak</span></span><br><span class="line">$ adb pull REMOATE_FILE_PATH LOCAL_PATH</span><br></pre></td></tr></table></figure>

<h4 id="Logcat"><a href="#Logcat" class="headerlink" title="Logcat"></a>Logcat</h4><p>使用 <code>logcast</code> 可以看到 Android 的设备 Log 信息。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> adb logcat</span></span><br></pre></td></tr></table></figure>

<p>会打印出当前设备的所有信息，但是我们调试 App 时不需要看到这么多，可以使用 <code>find</code> 进行筛选(注意大小写严格区分)：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> adb logcat | find <span class="string">&quot;GWorld&quot;</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> adb logcat | find <span class="string">&quot;KEY_WORD&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>查看 UE 打包的 APP 所有的 log 可以筛选：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> adb logcat | find <span class="string">&quot;UE4&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>如果运行的次数过多积累了大量的 Log，可以使用清理：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">adb logcat -c</span><br></pre></td></tr></table></figure>

<h4 id="从设备中提取已安装的 APK"><a href="# 从设备中提取已安装的 APK" class="headerlink" title="从设备中提取已安装的 APK"></a>从设备中提取已安装的 APK</h4><p>注意：执行下列命令时需要检查手机是否开放开发者权限，手机上提示的验证指纹信息要允许。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看链接设备</span></span><br><span class="line">$ adb devices</span><br><span class="line">List of devices attached</span><br><span class="line">b2fcxxxx        unauthorized</span><br><span class="line"><span class="comment"># 列出手机中安装的所有 app</span></span><br><span class="line">$ adb shell pm list package</span><br><span class="line"><span class="comment"># 如果提示下问题，则需要执行 adb kill-server</span></span><br><span class="line">error: device unauthorized.</span><br><span class="line">This adb servers <span class="variable">$ADB_VENDOR_KEYS</span> is not <span class="built_in">set</span></span><br><span class="line">Try <span class="string">&#x27;adb kill-server&#x27;</span> <span class="keyword">if</span> that seems wrong.</span><br><span class="line">Otherwise check <span class="keyword">for</span> a confirmation dialog on your device.</span><br><span class="line"><span class="comment"># 正常情况下会列出一堆这样的列表</span></span><br><span class="line">C:\Users\imzlp&gt;adb shell pm list package</span><br><span class="line">package:com.miui.screenrecorder</span><br><span class="line">package:com.amazon.mShop.android.shopping</span><br><span class="line">package:com.mobisystems.office</span><br><span class="line">package:com.weico.international</span><br><span class="line">package:com.github.shadowsocks</span><br><span class="line">package:com.android.cts.priv.ctsshim</span><br><span class="line">package:com.sorcerer.sorcery.iconpack</span><br><span class="line">package:com.google.android.youtube</span><br><span class="line"></span><br><span class="line"><span class="comment"># 找到指定 app 的的 apk 位置</span></span><br><span class="line">$ adb shell pm path com.github.shadowsocks</span><br><span class="line">package:/data/app/com.github.shadowsocks-iBtqbmLo8rYcq2BqFhJtsA==/base.apk</span><br><span class="line"><span class="comment"># 然后将该文件拉取到本地来即可</span></span><br><span class="line">$ adb pull /data/app/com.github.shadowsocks-iBtqbmLo8rYcq2BqFhJtsA==/base.apk</span><br><span class="line">/data/app/com.github.shadowsocks-iBtqbmLo8rYcq2BqFhJtsA==/...se.apk: 1 file pulled. 21.5 MB/s (4843324 bytes <span class="keyword">in</span> 0.215s)</span><br></pre></td></tr></table></figure>

<h4 id="刷入 Recovery"><a href="# 刷入 Recovery" class="headerlink" title="刷入 Recovery"></a>刷入 Recovery</h4><p>下载<a href="index/Adb.7z">Adb</a>，然后根据具体情况使用下列命令(如果当前已经在 bootloader 就不需要执行第一条了)。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb reboot bootloader</span><br><span class="line"><span class="comment"># 写入 img 到设备</span></span><br><span class="line">fastboot flash recovery recovery.img</span><br><span class="line">fastboot flash boot boot.img</span><br><span class="line"><span class="comment"># 引导 img</span></span><br><span class="line">fastboot boot recovery.img</span><br></pre></td></tr></table></figure>

<h4 id="端口转发"><a href="# 端口转发" class="headerlink" title="端口转发"></a>端口转发 </h4><p> 可以通过 adb 命令来指定：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># PC to Device</span></span><br><span class="line">adb reverse tcp:1985 tcp:1985</span><br><span class="line"><span class="comment"># Device to PC</span></span><br><span class="line">adb forward tcp:1985 tcp:1985</span><br></pre></td></tr></table></figure>
<ul>
<li><a href="http://blog.xiaoyu.im/post_678.html">Android 上超级好用的前端调试方法（adb reverse）</a></li>
</ul>
<h4 id="根据包名查看 apk 位置"><a href="# 根据包名查看 apk 位置" class="headerlink" title="根据包名查看 apk 位置"></a>根据包名查看 apk 位置 </h4><p> 可以使用以下 adb 命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ adb shell pm list package -f com.tencent.tmgp.fm</span><br><span class="line">package:/data/app/com.tencent.tmgp.fm-a_cOsX8G3VClXwiI-RD9wQ==/base.apk=com.tencent.tmgp.fm</span><br></pre></td></tr></table></figure>
<p>最后一个参数是包名, 输出的则是 apk 的路径。</p>
<h4 id="查看当前窗口的 app 的包名"><a href="# 查看当前窗口的 app 的包名" class="headerlink" title="查看当前窗口的 app 的包名"></a>查看当前窗口的 app 的包名 </h4><p> 使用以下 adb 命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ adb shell dumpsys window w | findstr \/ | findstr name=</span><br><span class="line">      mSurface=Surface(name=SideSlideGestureBar-Bottom)/@0xa618588</span><br><span class="line">      mSurface=Surface(name=SideSlideGestureBar-Right)/@0x619b646</span><br><span class="line">      mSurface=Surface(name=SideSlideGestureBar-Left)/@0xea02007</span><br><span class="line">      mSurface=Surface(name=StatusBar)/@0x7e4962d</span><br><span class="line">       mAnimationIsEntrance=<span class="literal">true</span>      mSurface=Surface(name=com.tencent.tmgp.fm/com.epicgames.ue4.GameActivity)/@0x43b30a0</span><br><span class="line">      mSurface=Surface(name=com.tencent.tmgp.fm/com.epicgames.ue4.GameActivity)/@0xa3481e</span><br><span class="line">       mAnimationIsEntrance=<span class="literal">true</span>      mSurface=Surface(name=com.vivo.livewallpaper.monster.bmw.MonsterWallpaperService)/@0x53e44ae</span><br></pre></td></tr></table></figure>
<p>其中的 <code>mAnimationIsEntrance=true      mSurface=Surface(name=</code> 之后，到 <code>/</code> 之前的字符串就是我们的 app 包名。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Mobile</tag>
      </tags>
  </entry>
  <entry>
    <title>ES2.0 最多 75 根骨骼的限制</title>
    <url>/wiki/36473/</url>
    <content><![CDATA[<p> 因为移动平台缺少 32 位的索引支持，所以最多支持 65k 个顶点和 75 根骨骼。<br> 但是可以通过拆分骨骼模型的材质来实现，每个材质支持 75 根，这是单次 drawcall 的限制，分成不同的批次就可以了。</p>
<ul>
<li><a href="https://docs.unrealengine.com/en-US/Platforms/Mobile/Meshes/index.html">Meshes for Mobile Platforms</a></li>
<li><a href="https://forums.unrealengine.com/development-discussion/rendering/43185-character-s-skeletal-mesh-disappears-under-mobile-html-5-preview-rendering-level">Character’s skeletal mesh disappears under Mobile/HTML 5 Preview Rendering Level</a></li>
</ul>
<blockquote>
<p>PS: 不能用 uniform 了，换其他方式，比如 VTF，也可以实现超过 75 根骨骼。</p>
</blockquote>
<p> 在 UE 中如果在 ES2.0 中（目前 UE 的 ES3.0 也是 75）想要更高的骨骼数量，需要拆分模型使用的材质：</p>
<blockquote>
<p>Warning: SkeletalMesh SK_m0146b0003, is not supported for current feature level (ES3_1) and will not be rendered. NumBones 78 (supported 75), NumBoneInfluences: 4</p>
</blockquote>
<p> 材质和模型插槽的关系：</p>
<ul>
<li><a href="https://blender.stackexchange.com/questions/75816/how-to-distinguish-material-and-material-slot">How to distinguish material and material slot</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Mobile</tag>
        <tag>ES2.0</tag>
      </tags>
  </entry>
  <entry>
    <title>UE4 中 ES3.1 的 75 根骨骼限制</title>
    <url>/wiki/11689/</url>
    <content><![CDATA[<p> 之前提到过在 ES2.0 上使用单个材质蒙皮的骨骼不能超过 75 根，在 ES3 之后就没有这个限制了，但是 UE 里目前还有这个限制。</p>
<blockquote>
<p>Warning: SkeletalMesh SK_m0146b0003, is not supported for current feature level (ES3_1) and will not be rendered. NumBones 78 (supported 75), NumBoneInfluences: 4</p>
</blockquote>
<figure class="highlight cpp"><figcaption><span>Runtime/RHI/Public/RHIDefinitions.h</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> int32 <span class="title">GetFeatureLevelMaxNumberOfBones</span><span class="params">(<span class="keyword">const</span> FStaticFeatureLevel FeatureLevel)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in"><span class="keyword">switch</span></span> (FeatureLevel)</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">case</span> ERHIFeatureLevel::ES3_1:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">75</span>;  </span><br><span class="line">  <span class="keyword">case</span> ERHIFeatureLevel::SM5:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">65536</span>; <span class="comment">// supports uint16</span></span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="built_in">checkf</span>(<span class="number">0</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;Unknown FeatureLevel %d&quot;</span>), (int32)FeatureLevel);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 看了下相关的代码，UE 在下面这次提交中修改了 ES3.1 原本 256 到 75，commit 里提到的是修复了 Mobile Preview 的 Crash:</p>
<ul>
<li><a href="https://github.com/EpicGames/UnrealEngine/commit/c33160755b4c28b4277f4323c7e4c9c7bdfdb995">Fixed: Skeletal Mesh with more than 75 bones crashes Mobile Preview</a></li>
</ul>
<blockquote>
<p>Limit ES3.1 to 75 bones like ES2. All ES3.1 feature level platforms use UB for Bones. Project has to set Compat.MAX_GPUSKIN_BONES=75 to support SkelMeshes with more than 75 bones for ES3.1 and ES2.</p>
</blockquote>
<p> 该代码在 4.21 Preview 4 中提交：<a href="https://forums.unrealengine.com/unreal-engine/announcements-and-releases/1537691-unreal-engine-4-21-preview">Unreal Engine 4.21 Preview</a></p>
<p> 在 answers 上也有一些相关的问题：</p>
<ul>
<li><a href="https://answers.unrealengine.com/questions/919176/change-es3-1-bone-number-limit-to-256.html">Change ES3_1 bone number limit to 256</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Mobile</tag>
        <tag>ES3</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 开发 Android 的工程实践</title>
    <url>/wiki/22ba95f2/</url>
    <content><![CDATA[<h3 id="Android 运行时请求权限"><a href="#Android 运行时请求权限" class="headerlink" title="Android 运行时请求权限"></a>Android 运行时请求权限</h3><p>ActivityCompact 里面有个 requestPermission 方法，可以用来处理这种情况。</p>
<ul>
<li><a href="https://developer.android.com/training/permissions/requesting#java">请求应用权限</a></li>
<li><a href="https://www.jianshu.com/p/c1c03825d7a5">Android 运行时请求权限</a></li>
<li><a href="https://developer.android.com/guide/topics/permissions/overview">Android 中的权限</a></li>
</ul>
<h3 id="Android 获取包名"><a href="#Android 获取包名" class="headerlink" title="Android 获取包名"></a>Android 获取包名 </h3><p> 通过 UPL 在 Java 里添加以下代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">AndroidThunkJava_GetPackageName</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Context context = getApplicationContext();</span><br><span class="line">  <span class="keyword">return</span> context.getPackageName();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 C++ 里通过 JNI 调用即可：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">FString <span class="title">UFlibAppHelper::GetAppPackageName</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FString result;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_ANDROID</span></span><br><span class="line">    <span class="keyword">if</span> (JNIEnv* Env = FAndroidApplication::<span class="built_in">GetJavaEnv</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        jmethodID GetInstalledPakPathMethodID = FJavaWrapper::<span class="built_in">FindMethod</span>(Env, FJavaWrapper::GameActivityClassID, <span class="string">&quot;AndroidThunkJava_GetPackageName&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">        result = FJavaHelper::<span class="built_in">FStringFromLocalRef</span>(Env, (jstring)FJavaWrapper::<span class="built_in">CallObjectMethod</span>(Env, FJavaWrapper::GameActivityThis,GetInstalledPakPathMethodID));</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> result; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Android 获取外部存储路径"><a href="#Android 获取外部存储路径" class="headerlink" title="Android 获取外部存储路径"></a>Android 获取外部存储路径 </h3><p> 获取 App 的沙盒路径：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// /storage/emulated/0/Android/data/com.xxxx.yyyy.zzzz/files</span></span><br><span class="line"><span class="function">FString <span class="title">FAndroidGCloudPlatformMisc::getExternalStorageDirectory</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FString result;</span><br><span class="line">    <span class="keyword">if</span> (JNIEnv* Env = FAndroidApplication::<span class="built_in">GetJavaEnv</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// get context</span></span><br><span class="line">        jobject JniEnvContext;</span><br><span class="line">        &#123;</span><br><span class="line">            jclass activityThreadClass = Env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;android/app/ActivityThread&quot;</span>);</span><br><span class="line">            jmethodID currentActivityThread = FJavaWrapper::<span class="built_in">FindStaticMethod</span>(Env, activityThreadClass, <span class="string">&quot;currentActivityThread&quot;</span>, <span class="string">&quot;()Landroid/app/ActivityThread;&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            jobject at = Env-&gt;<span class="built_in">CallStaticObjectMethod</span>(activityThreadClass, currentActivityThread);</span><br><span class="line">            jmethodID getApplication = FJavaWrapper::<span class="built_in">FindMethod</span>(Env, activityThreadClass, <span class="string">&quot;getApplication&quot;</span>, <span class="string">&quot;()Landroid/app/Application;&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            JniEnvContext = FJavaWrapper::<span class="built_in">CallObjectMethod</span>(Env, at, getApplication);</span><br><span class="line">        &#125;</span><br><span class="line">        jmethodID getExternalFilesDir = Env-&gt;<span class="built_in">GetMethodID</span>(Env-&gt;<span class="built_in">GetObjectClass</span>(JniEnvContext), <span class="string">&quot;getExternalFilesDir&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)Ljava/io/File;&quot;</span>);</span><br><span class="line">        <span class="comment">// get File</span></span><br><span class="line">        jobject ExternalFileDir = Env-&gt;<span class="built_in">CallObjectMethod</span>(JniEnvContext, getExternalFilesDir,<span class="literal">nullptr</span>);</span><br><span class="line">        <span class="comment">// getPath method in File class</span></span><br><span class="line">        jmethodID getFilePath = Env-&gt;<span class="built_in">GetMethodID</span>(Env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;java/io/File&quot;</span>), <span class="string">&quot;getPath&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>);</span><br><span class="line">        jstring pathString = (jstring)Env-&gt;<span class="built_in">CallObjectMethod</span>(ExternalFileDir, getFilePath, <span class="literal">nullptr</span>);</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *nativePathString = Env-&gt;<span class="built_in">GetStringUTFChars</span>(pathString, <span class="number">0</span>);</span><br><span class="line">        result = <span class="built_in">ANSI_TO_TCHAR</span>(nativePathString);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Android 获取已安装 App 的 Apk 路径"><a href="#Android 获取已安装 App 的 Apk 路径" class="headerlink" title="Android 获取已安装 App 的 Apk 路径"></a>Android 获取已安装 App 的 Apk 路径 </h3><p> 有个需求，需要在运行时获取到，App 的 Apk 路径，查了一下 UE 里没有现成的接口，只能用 JNI 调用从 Java 那边想办法了。<br>通过在 Android Developer 上查找，发现 <a href="https://developer.android.com/reference/android/content/pm/ApplicationInfo#sourceDir">ApplicationInfo</a> 中具有 <code>sourceDir</code> 属性，记录着 APK 的路径。<br>而可以通过 <code>PackageManager</code> 调用 <a href="https://developer.android.com/reference/android/content/pm/PackageManager#getApplicationInfo(java.lang.String,%20int)">getApplicationInfo</a> 可以获取指定包名的 ApplicationInfo。</p>
<p>那么就好说了，UPL 里 java 代码走起：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">AndroidThunkJava_GetInstalledApkPath</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Context context = getApplicationContext();</span><br><span class="line">    PackageManager packageManager = context.getPackageManager();</span><br><span class="line">    ApplicationInfo appInfo;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        appInfo = packageManager.getApplicationInfo(context.getPackageName(),PackageManager.GET_META_DATA);</span><br><span class="line">        <span class="keyword">return</span> appInfo.sourceDir;</span><br><span class="line">    &#125;<span class="keyword">catch</span> (PackageManager.NameNotFoundException e)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;invalid&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在 UE 里使用 JNI 调用：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (JNIEnv* Env = FAndroidApplication::<span class="built_in">GetJavaEnv</span>())</span><br><span class="line">&#123;</span><br><span class="line">	jmethodID GetInstalledPakPathMethodID = FJavaWrapper::<span class="built_in">FindMethod</span>(Env, FJavaWrapper::GameActivityClassID, <span class="string">&quot;AndroidThunkJava_GetInstalledApkPath&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">	FString ResultApkPath = FJavaHelperEx::<span class="built_in">FStringFromLocalRef</span>(Env, (jstring)FJavaWrapper::<span class="built_in">CallObjectMethod</span>(Env, FJavaWrapper::GameActivityThis,GetInstalledPakPathMethodID));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中 <code>FJavaHelperEx::FStringFromLocalRef</code> 是我封装的从 jstring 到 FString 的转换函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> FJavaHelperEx</span><br><span class="line">&#123;</span><br><span class="line">	<span class="function">FString <span class="title">FStringFromParam</span><span class="params">(JNIEnv* Env, jstring JavaString)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!Env || !JavaString || Env-&gt;<span class="built_in">IsSameObject</span>(JavaString, <span class="literal">NULL</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">auto</span> chars = Env-&gt;<span class="built_in">GetStringUTFChars</span>(JavaString, <span class="number">0</span>);</span><br><span class="line">		<span class="function">FString <span class="title">ReturnString</span><span class="params">(UTF8_TO_TCHAR(chars))</span></span>;</span><br><span class="line">		Env-&gt;<span class="built_in">ReleaseStringUTFChars</span>(JavaString, chars);</span><br><span class="line">		<span class="keyword">return</span> ReturnString;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">FString <span class="title">FStringFromLocalRef</span><span class="params">(JNIEnv* Env, jstring JavaString)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		FString ReturnString = <span class="built_in">FStringFromParam</span>(Env, JavaString);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (Env &amp;&amp; JavaString)</span><br><span class="line">		&#123;</span><br><span class="line">			Env-&gt;<span class="built_in">DeleteLocalRef</span>(JavaString);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> ReturnString;</span><br><span class="line">    </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取的结果：<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201016112348.webp"></p>
<h3 id="升级至 AndroidX 资料"><a href="# 升级至 AndroidX 资料" class="headerlink" title="升级至 AndroidX 资料"></a>升级至 AndroidX 资料 </h3><p> 看操作方式也是使用 UPL 来介入打包过程，先记录下。</p>
<ul>
<li><a href="https://answers.unrealengine.com/questions/961161/androidx-support.html">AndroidX support</a></li>
<li><a href="https://medium.com/nineva/how-to-force-the-unreal-engine-android-project-to-use-androidx-f7060abd56ac">How to force the Unreal Engine Android project to use AndroidX?</a></li>
</ul>
<h3 id="为 APK 添加外部存储读写权限"><a href="# 为 APK 添加外部存储读写权限" class="headerlink" title="为 APK 添加外部存储读写权限"></a>为 APK 添加外部存储读写权限 </h3><p> 在<code>Project Settings</code>-<code>Platform</code>-<code>Android</code>-<code>Advanced APK Packaging</code>-<code>Extra Permissions</code>下添加：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">android.permission.WRITE EXTERNAL STORAGE</span><br><span class="line">android.permission.READ_EXTERNAL_STORAGE</span><br></pre></td></tr></table></figure>

<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-android-add-extra-permissions.webp"></p>
<h3 id="AndroidP-HTTP 请求错误"><a href="#AndroidP-HTTP 请求错误" class="headerlink" title="AndroidP HTTP 请求错误"></a>AndroidP HTTP 请求错误 </h3><p> 在 Android P 上使用 HTTP 请求上传数据会有以下错误提示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2018-10-10 16:39:21.312 31611-31646/com.xfhy.tinkerfirmdemo W/CrashReport: java.io.IOException: Cleartext HTTP traffic to android.bugly.qq.com not permitted</span><br><span class="line">        at com.android.okhttp.HttpHandler$CleartextURLFilter.checkURLPermitted(HttpHandler.java:115)</span><br><span class="line">        at com.android.okhttp.internal.huc.HttpURLConnectionImpl.execute(HttpURLConnectionImpl.java:458)</span><br><span class="line">        at com.android.okhttp.internal.huc.HttpURLConnectionImpl.connect(HttpURLConnectionImpl.java:127)</span><br><span class="line">        at com.android.okhttp.internal.huc.HttpURLConnectionImpl.getOutputStream(HttpURLConnectionImpl.java:258)</span><br><span class="line">        at com.tencent.bugly.proguard.ai.a(BUGLY:265)</span><br><span class="line">        at com.tencent.bugly.proguard.ai.a(BUGLY:114)</span><br><span class="line">        at com.tencent.bugly.proguard.al.run(BUGLY:355)</span><br><span class="line">        at com.tencent.bugly.proguard.ak$1.run(BUGLY:723)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:764)</span><br><span class="line">2018-10-10 16:39:21.312 31611-31646/com.xfhy.tinkerfirmdemo E/CrashReport: Failed to upload, please check your network.</span><br><span class="line">2018-10-10 16:39:21.312 31611-31646/com.xfhy.tinkerfirmdemo D/CrashReport: Failed to execute post.</span><br><span class="line">2018-10-10 16:39:21.312 31611-31646/com.xfhy.tinkerfirmdemo E/CrashReport: [Upload] Failed to upload(1): Failed to upload for no response!</span><br><span class="line">2018-10-10 16:39:21.313 31611-31646/com.xfhy.tinkerfirmdemo E/CrashReport: [Upload] Failed to upload(1) userinfo: failed after many attempts</span><br></pre></td></tr></table></figure>
<ul>
<li><a href="http://www.douevencode.com/articles/2018-07/cleartext-communication-not-permitted/">Android P - CLEARTEXT communication not permitted by network security policy</a></li>
</ul>
<p>这需要我们在打包时把指定的域名给配置成白名单。</p>
<p>方法如下:</p>
<p>在 <code>res/xml</code> 下创建 <code>network_security_config.xml</code> 文件</p>
<p>填入以下内容（网址自行修改）：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">network-security-config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">domain-config</span> <span class="attr">cleartextTrafficPermitted</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">domain</span> <span class="attr">includeSubdomains</span>=<span class="string">&quot;true&quot;</span>&gt;</span>android.bugly.qq.com<span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">domain-config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">network-security-config</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后在 AndroifManifest.xml 中引用该文件：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span> <span class="attr">android:networkSecurityConfig</span>=<span class="string">&quot;@xml/network_security_config&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>重新打包即可，在运行时会有以下 Log：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">02-25 21:09:15.831 27760 27791 D NetworkSecurityConfig: Using Network Security Config from resource network_security_config debugBuild: true</span><br></pre></td></tr></table></figure>

<ul>
<li><a href="https://www.jianshu.com/p/3600483f9c9f">Android P 新特性</a></li>
<li><a href="https://www.jianshu.com/p/cbd4ffc26501">适配 Bugly 不支持 Android P</a></li>
<li><a href="https://developer.android.com/training/articles/security-config?hl=zh-cn">Android Developer 网络安全配置</a></li>
</ul>
<h3 id="Android 写入文件"><a href="#Android 写入文件" class="headerlink" title="Android 写入文件"></a>Android 写入文件 </h3><p> 当调用 <code>FFileHelper::SaveArrayToFile</code> 时：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">FFileHelper::<span class="built_in">SaveArrayToFile</span>(TArrayView&lt;<span class="keyword">const</span> uint8&gt;(data, delta), *path, &amp;IFileManager::<span class="built_in">Get</span>(), EFileWrite::FILEWRITE_Append));</span><br></pre></td></tr></table></figure>

<p>在该函数内部会创建一个 <code>FArchive</code> 的对象来管理当前文件，其内部具有一个 <code>IFileHandle</code> 的对象<code>Handle</code>，在 Android 平台上是<code>FFileHandleAndroid</code>。</p>
<p>在 <code>FArchive</code> 中写入文件调用的是 <code>Serialize</code>，它又会调用<code>Handle</code> 的<code>Write</code>：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FArchiveFileWriterGeneric::WriteLowLevel</span><span class="params">(<span class="keyword">const</span> uint8* Src, int64 CountToWrite )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> Handle-&gt;<span class="built_in">Write</span>(Src, CountToWrite);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Android 的 Write 的实现为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime/Core/Private/Android/AndroidFile.h</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Write</span><span class="params">(<span class="keyword">const</span> uint8* Source, int64 BytesToWrite)</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">CheckValid</span>();</span><br><span class="line">	<span class="keyword">if</span> (<span class="literal">nullptr</span> != File-&gt;Asset)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Can&#x27;t write to assets.</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> bSuccess = <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">while</span> (BytesToWrite)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">check</span>(BytesToWrite &gt;= <span class="number">0</span>);</span><br><span class="line">		int64 ThisSize = FMath::Min&lt;int64&gt;(READWRITE_SIZE, BytesToWrite);</span><br><span class="line">		<span class="built_in">check</span>(Source);</span><br><span class="line">		<span class="keyword">if</span> (__pwrite(File-&gt;Handle, Source, ThisSize, CurrentOffset) != ThisSize)</span><br><span class="line">		&#123;</span><br><span class="line">			bSuccess = <span class="literal">false</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		CurrentOffset += ThisSize;</span><br><span class="line">		Source += ThisSize;</span><br><span class="line">		BytesToWrite -= ThisSize;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Update the cached file length</span></span><br><span class="line">	Length = FMath::<span class="built_in">Max</span>(Length, CurrentOffset);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bSuccess;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到是每次 1M 往文件里存的。</p>
<h3 id="Android 写入文件错误码对照"><a href="#Android 写入文件错误码对照" class="headerlink" title="Android 写入文件错误码对照"></a>Android 写入文件错误码对照</h3><ul>
<li><a href="http://androidxref.com/8.0.0_r4/xref/bionic/libc/bionic/strerror.cpp#35">http://androidxref.com/8.0.0_r4/xref/bionic/libc/bionic/strerror.cpp#35</a></li>
</ul>
<p>根据 error code number 查找 error string.</p>
<ul>
<li><a href="http://androidxref.com/8.0.0_r4/xref/bionic/libc/bionic/strerror_r.cpp#_sys_error_strings">http://androidxref.com/8.0.0_r4/xref/bionic/libc/bionic/strerror_r.cpp#_sys_error_strings</a></li>
<li><a href="http://androidxref.com/8.0.0_r4/xref/bionic/libc/private/bionic_errdefs.h">http://androidxref.com/8.0.0_r4/xref/bionic/libc/private/bionic_errdefs.h</a></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// bionic_errdefs.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __BIONIC_ERRDEF</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">error</span> <span class="meta-string">&quot;__BIONIC_ERRDEF must be defined before including this file&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">__BIONIC_ERRDEF(<span class="number">0</span>              ,   <span class="number">0</span>, <span class="string">&quot;Success&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EPERM          ,   <span class="number">1</span>, <span class="string">&quot;Operation not permitted&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENOENT         ,   <span class="number">2</span>, <span class="string">&quot;No such file or directory&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ESRCH          ,   <span class="number">3</span>, <span class="string">&quot;No such process&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EINTR          ,   <span class="number">4</span>, <span class="string">&quot;Interrupted system call&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EIO            ,   <span class="number">5</span>, <span class="string">&quot;I/O error&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENXIO          ,   <span class="number">6</span>, <span class="string">&quot;No such device or address&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(E2BIG          ,   <span class="number">7</span>, <span class="string">&quot;Argument list too long&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENOEXEC        ,   <span class="number">8</span>, <span class="string">&quot;Exec format error&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EBADF          ,   <span class="number">9</span>, <span class="string">&quot;Bad file descriptor&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ECHILD         ,  <span class="number">10</span>, <span class="string">&quot;No child processes&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EAGAIN         ,  <span class="number">11</span>, <span class="string">&quot;Try again&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENOMEM         ,  <span class="number">12</span>, <span class="string">&quot;Out of memory&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EACCES         ,  <span class="number">13</span>, <span class="string">&quot;Permission denied&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EFAULT         ,  <span class="number">14</span>, <span class="string">&quot;Bad address&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENOTBLK        ,  <span class="number">15</span>, <span class="string">&quot;Block device required&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EBUSY          ,  <span class="number">16</span>, <span class="string">&quot;Device or resource busy&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EEXIST         ,  <span class="number">17</span>, <span class="string">&quot;File exists&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EXDEV          ,  <span class="number">18</span>, <span class="string">&quot;Cross-device link&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENODEV         ,  <span class="number">19</span>, <span class="string">&quot;No such device&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENOTDIR        ,  <span class="number">20</span>, <span class="string">&quot;Not a directory&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EISDIR         ,  <span class="number">21</span>, <span class="string">&quot;Is a directory&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EINVAL         ,  <span class="number">22</span>, <span class="string">&quot;Invalid argument&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENFILE         ,  <span class="number">23</span>, <span class="string">&quot;File table overflow&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EMFILE         ,  <span class="number">24</span>, <span class="string">&quot;Too many open files&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENOTTY         ,  <span class="number">25</span>, <span class="string">&quot;Not a typewriter&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ETXTBSY        ,  <span class="number">26</span>, <span class="string">&quot;Text file busy&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EFBIG          ,  <span class="number">27</span>, <span class="string">&quot;File too large&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENOSPC         ,  <span class="number">28</span>, <span class="string">&quot;No space left on device&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ESPIPE         ,  <span class="number">29</span>, <span class="string">&quot;Illegal seek&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EROFS          ,  <span class="number">30</span>, <span class="string">&quot;Read-only file system&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EMLINK         ,  <span class="number">31</span>, <span class="string">&quot;Too many links&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EPIPE          ,  <span class="number">32</span>, <span class="string">&quot;Broken pipe&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EDOM           ,  <span class="number">33</span>, <span class="string">&quot;Math argument out of domain of func&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ERANGE         ,  <span class="number">34</span>, <span class="string">&quot;Math result not representable&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EDEADLK        ,  <span class="number">35</span>, <span class="string">&quot;Resource deadlock would occur&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENAMETOOLONG   ,  <span class="number">36</span>, <span class="string">&quot;File name too long&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENOLCK         ,  <span class="number">37</span>, <span class="string">&quot;No record locks available&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENOSYS         ,  <span class="number">38</span>, <span class="string">&quot;Function not implemented&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENOTEMPTY      ,  <span class="number">39</span>, <span class="string">&quot;Directory not empty&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ELOOP          ,  <span class="number">40</span>, <span class="string">&quot;Too many symbolic links encountered&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENOMSG         ,  <span class="number">42</span>, <span class="string">&quot;No message of desired type&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EIDRM          ,  <span class="number">43</span>, <span class="string">&quot;Identifier removed&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ECHRNG         ,  <span class="number">44</span>, <span class="string">&quot;Channel number out of range&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EL2NSYNC       ,  <span class="number">45</span>, <span class="string">&quot;Level 2 not synchronized&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EL3HLT         ,  <span class="number">46</span>, <span class="string">&quot;Level 3 halted&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EL3RST         ,  <span class="number">47</span>, <span class="string">&quot;Level 3 reset&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ELNRNG         ,  <span class="number">48</span>, <span class="string">&quot;Link number out of range&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EUNATCH        ,  <span class="number">49</span>, <span class="string">&quot;Protocol driver not attached&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENOCSI         ,  <span class="number">50</span>, <span class="string">&quot;No CSI structure available&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EL2HLT         ,  <span class="number">51</span>, <span class="string">&quot;Level 2 halted&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EBADE          ,  <span class="number">52</span>, <span class="string">&quot;Invalid exchange&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EBADR          ,  <span class="number">53</span>, <span class="string">&quot;Invalid request descriptor&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EXFULL         ,  <span class="number">54</span>, <span class="string">&quot;Exchange full&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENOANO         ,  <span class="number">55</span>, <span class="string">&quot;No anode&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EBADRQC        ,  <span class="number">56</span>, <span class="string">&quot;Invalid request code&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EBADSLT        ,  <span class="number">57</span>, <span class="string">&quot;Invalid slot&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EBFONT         ,  <span class="number">59</span>, <span class="string">&quot;Bad font file format&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENOSTR         ,  <span class="number">60</span>, <span class="string">&quot;Device not a stream&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENODATA        ,  <span class="number">61</span>, <span class="string">&quot;No data available&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ETIME          ,  <span class="number">62</span>, <span class="string">&quot;Timer expired&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENOSR          ,  <span class="number">63</span>, <span class="string">&quot;Out of streams resources&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENONET         ,  <span class="number">64</span>, <span class="string">&quot;Machine is not on the network&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENOPKG         ,  <span class="number">65</span>, <span class="string">&quot;Package not installed&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EREMOTE        ,  <span class="number">66</span>, <span class="string">&quot;Object is remote&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENOLINK        ,  <span class="number">67</span>, <span class="string">&quot;Link has been severed&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EADV           ,  <span class="number">68</span>, <span class="string">&quot;Advertise error&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ESRMNT         ,  <span class="number">69</span>, <span class="string">&quot;Srmount error&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ECOMM          ,  <span class="number">70</span>, <span class="string">&quot;Communication error on send&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EPROTO         ,  <span class="number">71</span>, <span class="string">&quot;Protocol error&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EMULTIHOP      ,  <span class="number">72</span>, <span class="string">&quot;Multihop attempted&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EDOTDOT        ,  <span class="number">73</span>, <span class="string">&quot;RFS specific error&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EBADMSG        ,  <span class="number">74</span>, <span class="string">&quot;Not a data message&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EOVERFLOW      ,  <span class="number">75</span>, <span class="string">&quot;Value too large for defined data type&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENOTUNIQ       ,  <span class="number">76</span>, <span class="string">&quot;Name not unique on network&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EBADFD         ,  <span class="number">77</span>, <span class="string">&quot;File descriptor in bad state&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EREMCHG        ,  <span class="number">78</span>, <span class="string">&quot;Remote address changed&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ELIBACC        ,  <span class="number">79</span>, <span class="string">&quot;Can not access a needed shared library&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ELIBBAD        ,  <span class="number">80</span>, <span class="string">&quot;Accessing a corrupted shared library&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ELIBSCN        ,  <span class="number">81</span>, <span class="string">&quot;.lib section in a.out corrupted&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ELIBMAX        ,  <span class="number">82</span>, <span class="string">&quot;Attempting to link in too many shared libraries&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ELIBEXEC       ,  <span class="number">83</span>, <span class="string">&quot;Cannot exec a shared library directly&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EILSEQ         ,  <span class="number">84</span>, <span class="string">&quot;Illegal byte sequence&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ERESTART       ,  <span class="number">85</span>, <span class="string">&quot;Interrupted system call should be restarted&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ESTRPIPE       ,  <span class="number">86</span>, <span class="string">&quot;Streams pipe error&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EUSERS         ,  <span class="number">87</span>, <span class="string">&quot;Too many users&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENOTSOCK       ,  <span class="number">88</span>, <span class="string">&quot;Socket operation on non-socket&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EDESTADDRREQ   ,  <span class="number">89</span>, <span class="string">&quot;Destination address required&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EMSGSIZE       ,  <span class="number">90</span>, <span class="string">&quot;Message too long&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EPROTOTYPE     ,  <span class="number">91</span>, <span class="string">&quot;Protocol wrong type for socket&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENOPROTOOPT    ,  <span class="number">92</span>, <span class="string">&quot;Protocol not available&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EPROTONOSUPPORT,  <span class="number">93</span>, <span class="string">&quot;Protocol not supported&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ESOCKTNOSUPPORT,  <span class="number">94</span>, <span class="string">&quot;Socket type not supported&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EOPNOTSUPP     ,  <span class="number">95</span>, <span class="string">&quot;Operation not supported on transport endpoint&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EPFNOSUPPORT   ,  <span class="number">96</span>, <span class="string">&quot;Protocol family not supported&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EAFNOSUPPORT   ,  <span class="number">97</span>, <span class="string">&quot;Address family not supported by protocol&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EADDRINUSE     ,  <span class="number">98</span>, <span class="string">&quot;Address already in use&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EADDRNOTAVAIL  ,  <span class="number">99</span>, <span class="string">&quot;Cannot assign requested address&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENETDOWN       , <span class="number">100</span>, <span class="string">&quot;Network is down&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENETUNREACH    , <span class="number">101</span>, <span class="string">&quot;Network is unreachable&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENETRESET      , <span class="number">102</span>, <span class="string">&quot;Network dropped connection because of reset&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ECONNABORTED   , <span class="number">103</span>, <span class="string">&quot;Software caused connection abort&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ECONNRESET     , <span class="number">104</span>, <span class="string">&quot;Connection reset by peer&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENOBUFS        , <span class="number">105</span>, <span class="string">&quot;No buffer space available&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EISCONN        , <span class="number">106</span>, <span class="string">&quot;Transport endpoint is already connected&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENOTCONN       , <span class="number">107</span>, <span class="string">&quot;Transport endpoint is not connected&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ESHUTDOWN      , <span class="number">108</span>, <span class="string">&quot;Cannot send after transport endpoint shutdown&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ETOOMANYREFS   , <span class="number">109</span>, <span class="string">&quot;Too many references: cannot splice&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ETIMEDOUT      , <span class="number">110</span>, <span class="string">&quot;Connection timed out&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ECONNREFUSED   , <span class="number">111</span>, <span class="string">&quot;Connection refused&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EHOSTDOWN      , <span class="number">112</span>, <span class="string">&quot;Host is down&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EHOSTUNREACH   , <span class="number">113</span>, <span class="string">&quot;No route to host&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EALREADY       , <span class="number">114</span>, <span class="string">&quot;Operation already in progress&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EINPROGRESS    , <span class="number">115</span>, <span class="string">&quot;Operation now in progress&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ESTALE         , <span class="number">116</span>, <span class="string">&quot;Stale NFS file handle&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EUCLEAN        , <span class="number">117</span>, <span class="string">&quot;Structure needs cleaning&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENOTNAM        , <span class="number">118</span>, <span class="string">&quot;Not a XENIX named type file&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENAVAIL        , <span class="number">119</span>, <span class="string">&quot;No XENIX semaphores available&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EISNAM         , <span class="number">120</span>, <span class="string">&quot;Is a named type file&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EREMOTEIO      , <span class="number">121</span>, <span class="string">&quot;Remote I/O error&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EDQUOT         , <span class="number">122</span>, <span class="string">&quot;Quota exceeded&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENOMEDIUM      , <span class="number">123</span>, <span class="string">&quot;No medium found&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EMEDIUMTYPE    , <span class="number">124</span>, <span class="string">&quot;Wrong medium type&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ECANCELED      , <span class="number">125</span>, <span class="string">&quot;Operation Canceled&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENOKEY         , <span class="number">126</span>, <span class="string">&quot;Required key not available&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EKEYEXPIRED    , <span class="number">127</span>, <span class="string">&quot;Key has expired&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EKEYREVOKED    , <span class="number">128</span>, <span class="string">&quot;Key has been revoked&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EKEYREJECTED   , <span class="number">129</span>, <span class="string">&quot;Key was rejected by service&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(EOWNERDEAD     , <span class="number">130</span>, <span class="string">&quot;Owner died&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF(ENOTRECOVERABLE, <span class="number">131</span>, <span class="string">&quot;State not recoverable&quot;</span> )</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> __BIONIC_ERRDEF</span></span><br></pre></td></tr></table></figure>

<h3 id="UE 项目启动参数"><a href="#UE 项目启动参数" class="headerlink" title="UE 项目启动参数"></a>UE 项目启动参数 </h3><p> 看了一下引擎里的代码，在 <code>Launch</code> 模块下 <code>Launch\Private\Android\LaunchAndroid.cpp</code> 中有 <code>InitCommandLine</code> 函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Launch\Private\Android\LaunchAndroid.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">InitCommandLine</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> uint32 CMD_LINE_MAX = <span class="number">16384u</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// initialize the command line to an empty string</span></span><br><span class="line">  FCommandLine::<span class="built_in">Set</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">  AAssetManager* AssetMgr = <span class="built_in">AndroidThunkCpp_GetAssetManager</span>();</span><br><span class="line">  AAsset* asset = <span class="built_in">AAssetManager_open</span>(AssetMgr, <span class="built_in">TCHAR_TO_UTF8</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UE4CommandLine.txt&quot;</span>)), AASSET_MODE_BUFFER);</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> != asset)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">void</span>* FileContents = <span class="built_in">AAsset_getBuffer</span>(asset);</span><br><span class="line">    int32 FileLength = <span class="built_in">AAsset_getLength</span>(asset);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> CommandLine[CMD_LINE_MAX];</span><br><span class="line">    FileLength = (FileLength &lt; CMD_LINE_MAX - <span class="number">1</span>) ? FileLength : CMD_LINE_MAX - <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(CommandLine, FileContents, FileLength);</span><br><span class="line">    CommandLine[FileLength] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">AAsset_close</span>(asset);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// chop off trailing spaces</span></span><br><span class="line">    <span class="keyword">while</span> (*CommandLine &amp;&amp; <span class="built_in">isspace</span>(CommandLine[<span class="built_in">strlen</span>(CommandLine) - <span class="number">1</span>]))</span><br><span class="line">    &#123;</span><br><span class="line">      CommandLine[<span class="built_in">strlen</span>(CommandLine) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FCommandLine::<span class="built_in">Append</span>(<span class="built_in">UTF8_TO_TCHAR</span>(CommandLine));</span><br><span class="line">    FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;APK Commandline: %s&quot;</span>), FCommandLine::<span class="built_in">Get</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// read in the command line text file from the sdcard if it exists</span></span><br><span class="line">  FString CommandLineFilePath = GFilePathBase + <span class="built_in">FString</span>(<span class="string">&quot;/UE4Game/&quot;</span>) + (!FApp::<span class="built_in">IsProjectNameEmpty</span>() ? FApp::<span class="built_in">GetProjectName</span>() : FPlatformProcess::<span class="built_in">ExecutableName</span>()) + <span class="built_in">FString</span>(<span class="string">&quot;/UE4CommandLine.txt&quot;</span>);</span><br><span class="line">  FILE* CommandLineFile = <span class="built_in">fopen</span>(<span class="built_in">TCHAR_TO_UTF8</span>(*CommandLineFilePath), <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(CommandLineFile == <span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// if that failed, try the lowercase version</span></span><br><span class="line">    CommandLineFilePath = CommandLineFilePath.<span class="built_in">Replace</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UE4CommandLine.txt&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;ue4commandline.txt&quot;</span>));</span><br><span class="line">    CommandLineFile = <span class="built_in">fopen</span>(<span class="built_in">TCHAR_TO_UTF8</span>(*CommandLineFilePath), <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(CommandLineFile)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">char</span> CommandLine[CMD_LINE_MAX];</span><br><span class="line">    <span class="built_in">fgets</span>(CommandLine, <span class="built_in">ARRAY_COUNT</span>(CommandLine) - <span class="number">1</span>, CommandLineFile);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fclose</span>(CommandLineFile);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// chop off trailing spaces</span></span><br><span class="line">    <span class="keyword">while</span> (*CommandLine &amp;&amp; <span class="built_in">isspace</span>(CommandLine[<span class="built_in">strlen</span>(CommandLine) - <span class="number">1</span>]))</span><br><span class="line">    &#123;</span><br><span class="line">      CommandLine[<span class="built_in">strlen</span>(CommandLine) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// initialize the command line to an empty string</span></span><br><span class="line">    FCommandLine::<span class="built_in">Set</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    FCommandLine::<span class="built_in">Append</span>(<span class="built_in">UTF8_TO_TCHAR</span>(CommandLine));</span><br><span class="line">    FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Override Commandline: %s&quot;</span>), FCommandLine::<span class="built_in">Get</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !UE_BUILD_SHIPPING</span></span><br><span class="line">  <span class="keyword">if</span> (FString* ConfigRulesCmdLineAppend = FAndroidMisc::<span class="built_in">GetConfigRulesVariable</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;cmdline&quot;</span>)))</span><br><span class="line">  &#123;</span><br><span class="line">    FCommandLine::<span class="built_in">Append</span>(**ConfigRulesCmdLineAppend);</span><br><span class="line">    FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ConfigRules appended: %s&quot;</span>), **ConfigRulesCmdLineAppend);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单来说就是在 <code>UE4Game/ProjectName/ue4commandline.txt</code> 中把启动参数写到里面，引擎启动的时候会从这个文件去读，然后添加到 FCommandLine 中。</p>
<h3 id="Android 设置宽高比"><a href="#Android 设置宽高比" class="headerlink" title="Android 设置宽高比"></a>Android 设置宽高比 </h3><p> 在<code>Project Settings</code>-<code>Platforms</code>-<code>Android</code>-<code>Maximum support aspect ratio</code>的值，默认是 2.1，但是在全面屏的情况下会有黑边。<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-project-settings-android-maximum-support-aspect-ratio.webp"></p>
<p>它控制的值是 <code>AndroidManifest.xml</code> 中的值：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;android.max_aspect&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;2.1&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>我目前设置的值是 2.5.</p>
<blockquote>
<p>注：<code>Enable FullScreen Immersive on KitKat and above devices</code>控制的是进入游戏时是否隐藏虚拟按键。</p>
</blockquote>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Mobile</tag>
      </tags>
  </entry>
  <entry>
    <title>app:assembleDebug 报错</title>
    <url>/wiki/6eed44f8/</url>
    <content><![CDATA[<p>打包 Android 时的错误信息：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">UATHelper: Packaging (Android…) ERROR: cmd.exe failed with args /c “[ProjectPath]\Intermediate/Android/APK/gradle/rungradle.bat” :app:assembleDebug</span><br></pre></td></tr></table></figure>
<p>将下面选项取消勾选即可：<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-package-android-error-assdebug.webp"></p>
<p>在 4.24+ 中没有了 <code>Enable Gradle instead of Ant</code> 选项，仔细看了下 log 发现是因为 UE 要从网络上下载 <code>Grade</code> 下载失败导致的，可以在打包时开启全局代理。或者使用我打包的 gradle 版本：<a href="https://stusdnueducn-my.sharepoint.com/:u:/g/personal/2017020625_stu_sdnu_edu_cn/EchGqZT81YdGi_nAncZPrMkBW3DkeGySMHkhWWYA6SaWMg?e=qReHkS">gradle-5.4.1.7z</a>，将其解压到以下路径即可：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">C:\Users\lipengzha\.gradle\wrapper\dists\gradle-5.4.1-all\3221gyojl5jsh0helicew7rwx\gradle-5.4.1</span><br></pre></td></tr></table></figure>

<p>然后创建一个环境变量 <code>ANDROID_HOME</code> 指向该路径即可。</p>
<p>还有一些相关的文章，可以更新 Android Tools，操作方法为：</p>
<ol>
<li>run NVPACK/android-sdk-windows/tools/android.bat</li>
<li>click on “Deselect All”</li>
<li>update Extras/Android Support Repository</li>
</ol>
<p>文章：</p>
<ul>
<li><a href="https://answers.unrealengine.com/questions/720605/android-packaging-build-fail-ue-418.html">Android packaging build fail - UE 4.18</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Mobile</tag>
      </tags>
  </entry>
  <entry>
    <title>修改游戏默认的数据存储路径</title>
    <url>/wiki/20367/</url>
    <content><![CDATA[<p>默认情况下，使用 UE 打包出游戏的 Apk 并在手机上安装之后，启动游戏会在 <code>/storage/emulated/0/UE4Game/</code> 下创建游戏的数据目录 (也就是内部存储器的根目录下)。按照 Google 的规则，每个 APP 的数据文件最好都是放在自己的私有目录，所以我想要把 UE 打包出来的游戏的数据全放到<code>/storage/emulated/0/Android/data/PACKAGE_NAME</code> 目录中 (不管是 log、ini、还是 crash 信息)。<br> 一个看似简单的需求，有几种不同的方法，涉及到了 UE4 的路径管理 /JNI/Android Manifest 以及对 UBT 的代码的分析。</p>
<span id="more"></span>

<p>默认的路径：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/20367/ue4-data-folder-in-android.webp"></p>
<p>有两种方法，一种是改动引擎代码实现对 <code>GFilePathBase</code> 的修改，另一种是不改动引擎只添加项目设置中的 <code>manifest</code> 就可以，当然不改动引擎是最好的，不过既然是分析，我就两个都来搞一下，顺便从 UBT 代码分析一下 <code>Project Setting</code>-<code>Android</code>-<code>Use ExternalFilesDir for UE4Game Files</code> 选项没有作用的原因。</p>
<h3 id="改动引擎代码实现"><a href="# 改动引擎代码实现" class="headerlink" title="改动引擎代码实现"></a>改动引擎代码实现 </h3><p> 翻了一下引擎代码，发现路径的这部分代码是写在这里的：<a href="https://github.com/EpicGames/UnrealEngine/blob/6c20d9831a968ad3cb156442bebb41a883e62152/Engine/Source/Runtime/Core/Private/Android/AndroidPlatformFile.cpp#L946">AndroidPlatformFile.cpp#L946</a>，它是在 <code>GFilePathBase</code> 然后组合 <code>UE4Game</code>+<code>PROJECT_NAME</code> 的路径。</p>
<p>在 UE4.22 及之前的引擎版本中是在 <code>AndroidFile.cpp</code> 文件中的，4.23+ 是在 <code>AndroidPlatformFile.cpp</code> 中的。<br>基础路径 <code>GFilePathBase</code> 的初始化是在 <code>Launch\Private\Android\AndroidJNI.cpp</code> 中：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Launch\Private\Android\AndroidJNI.cpp</span></span><br><span class="line"><span class="function">JNIEXPORT jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM* InJavaVM, <span class="keyword">void</span>* InReserved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FPlatformMisc::<span class="built_in">LowLevelOutputDebugString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;In the JNI_OnLoad function&quot;</span>));</span><br><span class="line"></span><br><span class="line">  JNIEnv* Env = <span class="literal">NULL</span>;</span><br><span class="line">  InJavaVM-&gt;<span class="built_in">GetEnv</span>((<span class="keyword">void</span> **)&amp;Env, JNI_CURRENT_VERSION);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if you have problems with stuff being missing especially in distribution builds then it could be because proguard is stripping things from java</span></span><br><span class="line">  <span class="comment">// check proguard-project.txt and see if your stuff is included in the exceptions</span></span><br><span class="line">  GJavaVM = InJavaVM;</span><br><span class="line">  FAndroidApplication::<span class="built_in">InitializeJavaEnv</span>(GJavaVM, JNI_CURRENT_VERSION, FJavaWrapper::GameActivityThis);</span><br><span class="line"></span><br><span class="line">  FJavaWrapper::<span class="built_in">FindClassesAndMethods</span>(Env);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// hook signals</span></span><br><span class="line">  <span class="keyword">if</span> (!FPlatformMisc::<span class="built_in">IsDebuggerPresent</span>() || GAlwaysReportCrash)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// disable crash handler.. getting better stack traces from system for now</span></span><br><span class="line">    <span class="comment">//FPlatformMisc::SetCrashHandler(EngineCrashHandler);</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Cache path to external storage</span></span><br><span class="line">  jclass EnvClass = Env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;android/os/Environment&quot;</span>);</span><br><span class="line">  jmethodID getExternalStorageDir = Env-&gt;<span class="built_in">GetStaticMethodID</span>(EnvClass, <span class="string">&quot;getExternalStorageDirectory&quot;</span>, <span class="string">&quot;()Ljava/io/File;&quot;</span>);</span><br><span class="line">  jobject externalStoragePath = Env-&gt;<span class="built_in">CallStaticObjectMethod</span>(EnvClass, getExternalStorageDir, <span class="literal">nullptr</span>);</span><br><span class="line">  jmethodID getFilePath = Env-&gt;<span class="built_in">GetMethodID</span>(Env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;java/io/File&quot;</span>), <span class="string">&quot;getPath&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>);</span><br><span class="line">  jstring pathString = (jstring)Env-&gt;<span class="built_in">CallObjectMethod</span>(externalStoragePath, getFilePath, <span class="literal">nullptr</span>);</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *nativePathString = Env-&gt;<span class="built_in">GetStringUTFChars</span>(pathString, <span class="number">0</span>);</span><br><span class="line">  <span class="comment">// Copy that somewhere safe </span></span><br><span class="line">  GFilePathBase = <span class="built_in">FString</span>(nativePathString);</span><br><span class="line">  GOBBFilePathBase = GFilePathBase;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// then release...</span></span><br><span class="line">  Env-&gt;<span class="built_in">ReleaseStringUTFChars</span>(pathString, nativePathString);</span><br><span class="line">  Env-&gt;<span class="built_in">DeleteLocalRef</span>(pathString);</span><br><span class="line">  Env-&gt;<span class="built_in">DeleteLocalRef</span>(externalStoragePath);</span><br><span class="line">  Env-&gt;<span class="built_in">DeleteLocalRef</span>(EnvClass);</span><br><span class="line">  FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Path found as &#x27;%s&#x27;\n&quot;</span>), *GFilePathBase);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Get the system font directory</span></span><br><span class="line">  jstring fontPath = (jstring)Env-&gt;<span class="built_in">CallStaticObjectMethod</span>(FJavaWrapper::GameActivityClassID, FJavaWrapper::AndroidThunkJava_GetFontDirectory);</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> * nativeFontPathString = Env-&gt;<span class="built_in">GetStringUTFChars</span>(fontPath, <span class="number">0</span>);</span><br><span class="line">  GFontPathBase = <span class="built_in">FString</span>(nativeFontPathString);</span><br><span class="line">  Env-&gt;<span class="built_in">ReleaseStringUTFChars</span>(fontPath, nativeFontPathString);</span><br><span class="line">  Env-&gt;<span class="built_in">DeleteLocalRef</span>(fontPath);</span><br><span class="line">  FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Font Path found as &#x27;%s&#x27;\n&quot;</span>), *GFontPathBase);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Wire up to core delegates, so core code can call out to Java</span></span><br><span class="line">  <span class="built_in">DECLARE_DELEGATE_OneParam</span>(FAndroidLaunchURLDelegate, <span class="keyword">const</span> FString&amp;);</span><br><span class="line">  <span class="keyword">extern</span> CORE_API FAndroidLaunchURLDelegate OnAndroidLaunchURL;</span><br><span class="line">  OnAndroidLaunchURL = FAndroidLaunchURLDelegate::<span class="built_in">CreateStatic</span>(&amp;AndroidThunkCpp_LaunchURL);</span><br><span class="line"></span><br><span class="line">  FPlatformMisc::<span class="built_in">LowLevelOutputDebugString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;In the JNI_OnLoad function 5&quot;</span>));</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">char</span> mainThreadName[] = <span class="string">&quot;MainThread-UE4&quot;</span>;</span><br><span class="line">  <span class="built_in">AndroidThunkCpp_SetThreadName</span>(mainThreadName);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> JNI_CURRENT_VERSION;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们的目的就是要改动 <code>GFilePathBase</code> 的值，因为默认引擎里是通过调用 <code>getExternalStorageDirectory</code> 得到的，其是外部存储的目录即 <code>/storage/emulated/0/</code>，再拼接上<code>UE4Game</code> 就是默认平时我们看到的路径。</p>
<p>因为 <code>getExternalStorageDirectory</code> 这些都是 Environment 的静态成员，没有我们想要获取的路径的方法，但是 <code>Context</code> 中有，UE 的代码中并没有获取到，所以我们要像一个办法得到 App 的 Context。</p>
<p>可以通过下列方法从 JNI 获取 Context，:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// get context</span></span><br><span class="line">jobject JniEnvContext;</span><br><span class="line">&#123;</span><br><span class="line">	jclass activityThreadClass = Env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;android/app/ActivityThread&quot;</span>);</span><br><span class="line">	jmethodID currentActivityThread = FJavaWrapper::<span class="built_in">FindStaticMethod</span>(Env, activityThreadClass, <span class="string">&quot;currentActivityThread&quot;</span>, <span class="string">&quot;()Landroid/app/ActivityThread;&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">	jobject at = Env-&gt;<span class="built_in">CallStaticObjectMethod</span>(activityThreadClass, currentActivityThread);</span><br><span class="line">	jmethodID getApplication = FJavaWrapper::<span class="built_in">FindMethod</span>(Env, activityThreadClass, <span class="string">&quot;getApplication&quot;</span>, <span class="string">&quot;()Landroid/app/Application;&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">	JniEnvContext = FJavaWrapper::<span class="built_in">CallObjectMethod</span>(Env, at, getApplication);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后可以使用 <code>Context</code> 下的函数 <code>getExternalFilesDir</code> 获取到我们想要的路径：</p>
<blockquote>
<p>注意 <code>getExternalFilesDir</code> 的原型是：<code>File getExternalFilesDir(String)</code>，在使用 JNI 获取 jmehodID 时一定注意签名要传对，不然会 Crash，其签名是<code>(Ljava/lang/String;)Ljava/io/File;</code>。</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">jmethodID getExternalFilesDir = Env-&gt;<span class="built_in">GetMethodID</span>(Env-&gt;<span class="built_in">GetObjectClass</span>(JniEnvContext), <span class="string">&quot;getExternalFilesDir&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)Ljava/io/File;&quot;</span>);</span><br><span class="line"><span class="comment">// get File</span></span><br><span class="line">jobject ExternalFileDir = Env-&gt;<span class="built_in">CallObjectMethod</span>(JniEnvContext, getExternalFilesDir,<span class="literal">nullptr</span>);</span><br><span class="line"><span class="comment">// getPath method in File class</span></span><br><span class="line">jmethodID getFilePath = Env-&gt;<span class="built_in">GetMethodID</span>(Env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;java/io/File&quot;</span>), <span class="string">&quot;getPath&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>);</span><br><span class="line">jstring pathString = (jstring)Env-&gt;<span class="built_in">CallObjectMethod</span>(ExternalFileDir, getFilePath, <span class="literal">nullptr</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *nativePathString = Env-&gt;<span class="built_in">GetStringUTFChars</span>(pathString, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>得到的 <code>nativePathString</code> 的值为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">/storage/emulated/<span class="number">0</span>/Android/data/com.imzlp.GWorld/files</span><br></pre></td></tr></table></figure>

<p>其中的 <code>com.imzlp.GWorld</code> 是你的 App 的包名。</p>
<p>然后将其赋值给 <code>GFilePathBase</code> 即可，打开编辑器重新打包 Apk，安装上之后该 APP 所有的数据就会在 <code>/storage/emulated/0/Android/data/PACKAGE_NAME/files</code> 下了。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/20367/ue4-android-loadjni-log.webp"></p>
<p>在 UE 中调用和操作 JNI 以及 Android 存储路径相关的链接：</p>
<ul>
<li><a href="https://stackoverflow.com/questions/46869901/how-to-get-the-android-context-instance-when-calling-jni-method">How to get the Android context instance when calling JNI method?</a></li>
<li><a href="https://kotlintc.com/articles/3760">Android JNI get Context</a></li>
<li><a href="https://developer.android.com/reference/android/os/Environment">Android Environment API</a></li>
<li><a href="https://developer.android.com/reference/android/content/Context.html">Android Context API</a></li>
<li><a href="https://www.jianshu.com/p/2de0113b3164">Android 存储路径你了解多少？</a></li>
</ul>
<h3 id="使用 Manifest 控制"><a href="# 使用 Manifest 控制" class="headerlink" title="使用 Manifest 控制"></a>使用 Manifest 控制 </h3><p>OK，关于分析引擎中修改<code>GFilePathBase</code> 的大致写完了，其实有个不改动引擎的办法，就是在项目设置中添加<code>minifest</code>。</p>
<p>其实原理也在 <code>AndoidJNI.cpp</code> 里了，<code>AndroidJNI.cpp</code>中有以下代码：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//This function is declared in the Java-defined class, GameActivity.java: &quot;public native void nativeSetGlobalActivity();&quot;</span></span><br><span class="line"><span class="function">JNI_METHOD <span class="keyword">void</span> <span class="title">Java_com_epicgames_ue4_GameActivity_nativeSetGlobalActivity</span><span class="params">(JNIEnv* jenv, jobject thiz, jboolean bUseExternalFilesDir, jstring internalFilePath, jstring externalFilePath, jboolean bOBBinAPK, jstring APKFilename <span class="comment">/*, jobject googleServices*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!FJavaWrapper::GameActivityThis)</span><br><span class="line">	&#123;</span><br><span class="line">		GGameActivityThis = FJavaWrapper::GameActivityThis = jenv-&gt;<span class="built_in">NewGlobalRef</span>(thiz);</span><br><span class="line">		<span class="keyword">if</span> (!FJavaWrapper::GameActivityThis)</span><br><span class="line">		&#123;</span><br><span class="line">			FPlatformMisc::<span class="built_in">LowLevelOutputDebugString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Error setting the global GameActivity activity&quot;</span>));</span><br><span class="line">			<span class="built_in">check</span>(<span class="literal">false</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// This call is only to set the correct GameActivityThis</span></span><br><span class="line">		FAndroidApplication::<span class="built_in">InitializeJavaEnv</span>(GJavaVM, JNI_CURRENT_VERSION, FJavaWrapper::GameActivityThis);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// @todo split GooglePlay, this needs to be passed in to this function</span></span><br><span class="line">		FJavaWrapper::GoogleServicesThis = FJavaWrapper::GameActivityThis;</span><br><span class="line">		<span class="comment">// FJavaWrapper::GoogleServicesThis = jenv-&gt;NewGlobalRef(googleServices);</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// Next we check to see if the OBB file is in the APK</span></span><br><span class="line">		<span class="comment">//jmethodID isOBBInAPKMethod = jenv-&gt;GetStaticMethodID(FJavaWrapper::GameActivityClassID, &quot;isOBBInAPK&quot;, &quot;()Z&quot;);</span></span><br><span class="line">		<span class="comment">//GOBBinAPK = (bool)jenv-&gt;CallStaticBooleanMethod(FJavaWrapper::GameActivityClassID, isOBBInAPKMethod, nullptr);</span></span><br><span class="line">		GOBBinAPK = bOBBinAPK;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">char</span> *nativeAPKFilenameString = jenv-&gt;<span class="built_in">GetStringUTFChars</span>(APKFilename, <span class="number">0</span>);</span><br><span class="line">		GAPKFilename = <span class="built_in">FString</span>(nativeAPKFilenameString);</span><br><span class="line">		jenv-&gt;<span class="built_in">ReleaseStringUTFChars</span>(APKFilename, nativeAPKFilenameString);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">char</span> *nativeInternalPath = jenv-&gt;<span class="built_in">GetStringUTFChars</span>(internalFilePath, <span class="number">0</span>);</span><br><span class="line">		GInternalFilePath = <span class="built_in">FString</span>(nativeInternalPath);</span><br><span class="line">		jenv-&gt;<span class="built_in">ReleaseStringUTFChars</span>(internalFilePath, nativeInternalPath);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">char</span> *nativeExternalPath = jenv-&gt;<span class="built_in">GetStringUTFChars</span>(externalFilePath, <span class="number">0</span>);</span><br><span class="line">		GExternalFilePath = <span class="built_in">FString</span>(nativeExternalPath);</span><br><span class="line">		jenv-&gt;<span class="built_in">ReleaseStringUTFChars</span>(externalFilePath, nativeExternalPath);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (bUseExternalFilesDir)</span><br><span class="line">		&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UE_BUILD_SHIPPING</span></span><br><span class="line">			GFilePathBase = GInternalFilePath;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">			GFilePathBase = GExternalFilePath;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">			FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;GFilePathBase Path override to&#x27;%s&#x27;\n&quot;</span>), *GFilePathBase);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;InternalFilePath found as &#x27;%s&#x27;\n&quot;</span>), *GInternalFilePath);</span><br><span class="line">		FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ExternalFilePath found as &#x27;%s&#x27;\n&quot;</span>), *GExternalFilePath);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在引擎启动的时候会从 JNI 调过来，其中有一个参数 <code>bUseExternalFilesDir</code> 用来控制修改 <code>GFilePathBase</code> 的值，如果它为 ture，在 Shipping 打包的模式下就会把 <code>GFilePathBase</code> 设置为 <code>GInternalFilePath</code> 的值，也就是下列路径：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/data/user/PACKAGE_NAME/files</span><br></pre></td></tr></table></figure>

<p>在非 Shipping 打包模式下会设置为 <code>GExternalFilePath</code> 的值：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">/storage/emulated/<span class="number">0</span>/Android/data/PACKAGE_NAME/files</span><br></pre></td></tr></table></figure>

<p>但是，问题的关键是 <code>bUseExternalFilesDir</code> 这个从 JNI 调过来的参数我们又如何控制呢？</p>
<p>问题的答案是添加 <code>manifest</code> 信息！本来以为是 <code>ProjectSettings</code>-<code>Android</code>-<code>UseExternalFilesDirForUE4GameFiles</code> 这个选项，但是选中没有任何效果，原因后面会分析。</p>
<p>在详细解释怎么通过 <code>manifest</code> 控制 <code>bUseExternalFilesDir</code> 这个变量之前，需要先知道，UE4 打包出来的 APK 的 <code>Manifest</code> 中默认有什么。</p>
<p>下列是我解包出来的 APK 中的 Manifest 文件：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; standalone=&quot;no&quot;?&gt;</span><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span> <span class="attr">android:installLocation</span>=<span class="string">&quot;internalOnly&quot;</span> <span class="attr">package</span>=<span class="string">&quot;com.imzlp.TEST&quot;</span> <span class="attr">platformBuildVersionCode</span>=<span class="string">&quot;29&quot;</span> <span class="attr">platformBuildVersionName</span>=<span class="string">&quot;10&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span> <span class="attr">android:debuggable</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:hardwareAccelerated</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:hasCode</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:icon</span>=<span class="string">&quot;@drawable/icon&quot;</span> <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:debuggable</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span> <span class="attr">android:launchMode</span>=<span class="string">&quot;singleTask&quot;</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.SplashActivity&quot;</span> <span class="attr">android:screenOrientation</span>=<span class="string">&quot;landscape&quot;</span> <span class="attr">android:theme</span>=<span class="string">&quot;@style/UE4SplashTheme&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:configChanges</span>=<span class="string">&quot;density|keyboard|keyboardHidden|mcc|mnc|orientation|screenSize|uiMode&quot;</span> <span class="attr">android:debuggable</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span> <span class="attr">android:launchMode</span>=<span class="string">&quot;singleTask&quot;</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity&quot;</span> <span class="attr">android:screenOrientation</span>=<span class="string">&quot;landscape&quot;</span> <span class="attr">android:theme</span>=<span class="string">&quot;@style/UE4SplashTheme&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;android.app.lib_name&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;UE4&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:configChanges</span>=<span class="string">&quot;density|keyboard|keyboardHidden|mcc|mnc|orientation|screenSize|uiMode&quot;</span> <span class="attr">android:name</span>=<span class="string">&quot;.DownloaderActivity&quot;</span> <span class="attr">android:screenOrientation</span>=<span class="string">&quot;landscape&quot;</span> <span class="attr">android:theme</span>=<span class="string">&quot;@style/UE4SplashTheme&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.EngineVersion&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;4.22.3&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.EngineBranch&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;++UE4+Release-4.22&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.ProjectVersion&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;1.0.0.0&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.DepthBufferPreference&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;0&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bPackageDataInsideApk&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bVerifyOBBOnStartUp&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bShouldHideUI&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.ProjectName&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;Mobile422&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.AppType&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bHasOBBFiles&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.BuildConfiguration&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;Development&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.CookedFlavors&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;ETC2&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bValidateTextureFormats&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bUseExternalFilesDir&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bUseDisplayCutout&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bAllowIMU&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bSupportsVulkan&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.google.android.gms.games.APP_ID&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;@string/app_id&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.google.android.gms.version&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;@integer/google_play_services_version&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:configChanges</span>=<span class="string">&quot;keyboard|keyboardHidden|orientation|screenLayout|screenSize|smallestScreenSize|uiMode&quot;</span> <span class="attr">android:name</span>=<span class="string">&quot;com.google.android.gms.ads.AdActivity&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">service</span> <span class="attr">android:name</span>=<span class="string">&quot;OBBDownloaderService&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">&quot;AlarmReceiver&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.LocalNotificationReceiver&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.MulticastBroadcastReceiver&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.android.vending.INSTALL_REFERRER&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;android.max_aspect&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;2.1&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-feature</span> <span class="attr">android:glEsVersion</span>=<span class="string">&quot;0x00030000&quot;</span> <span class="attr">android:required</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.ACCESS_NETWORK_STATE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.WAKE_LOCK&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;com.android.vending.CHECK_LICENSE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.ACCESS_WIFI_STATE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.MODIFY_AUDIO_SETTINGS&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.VIBRATE&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>该文件在 <code>UnrealBuildTool\Platform\Android\UEDeployAdnroid.cs</code> 中的 <code>GenerateManifest</code> 函数中生成。</p>
<p>其中控制了 APK 安装后的权限要求、属性配置等等，可以看到其中有一条：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bUseExternalFilesDir&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>bUseExternalFilesDir</code>的值为 false!，那么怎么把它设置为 true 呢？</p>
<p>需要打开 <code>Project Settings</code>-<code>Android</code>-<code>Advanced APK Packaging</code>，找到<code>Extra Tags for&lt;application&gt; node</code>，因为<code>&lt;meta-data /&gt;</code> 是在 <code>Application</code> 下的，所以需要在这个选项下添加。</p>
<p>添加内容为：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bUseExternalFilesDir&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>没错！直接把 <code>meta-data</code> 这一行直接粘贴过来改一下值就可以了，UE 打包时会自动把这里的内容追加到 <code>Manifest</code> 的<code>Application</code>项尾部，这样就覆盖了默认的 <code>false</code> 的值。</p>
<p>然后再打包就可以看到 <code>bUseExternalFilesDir</code> 这个选项起作用了。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/20367/ue4-android-override-GFilePathBase-as-ExternalFilePath.webp"></p>
<h3 id="UPL 控制 bUseExternalFilesDir"><a href="#UPL 控制 bUseExternalFilesDir" class="headerlink" title="UPL 控制 bUseExternalFilesDir"></a>UPL 控制 bUseExternalFilesDir</h3><p>因为 UE 默认会给 <code>AndroidManifest.xml</code> 添加了 <code>com.epicgames.ue4.GameActivity.bUseExternalFilesDir</code> 项，如果我们想要手动控制，直接添加的话会产生错误，提示已经存在：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   &gt; Task :app:processDebugManifest FAILED</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   </span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   Z:\app\src\main\AndroidManifest.xml:<span class="number">47</span>:<span class="number">5</span><span class="number">-106</span> Error:</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):     Element meta-data<span class="meta">#com.epicgames.ue4.GameActivity.bUseExternalFilesDir at AndroidManifest.xml:47:5-106 duplicated with element declared at AndroidManifest.xml:27:5-107</span></span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   Z:\app\src\main\AndroidManifest.xml Error:</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):     Validation failed, exiting</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   </span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   FAILURE: Build failed with an exception.</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   </span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   * What went wrong:</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   Execution failed <span class="keyword">for</span> task <span class="string">&#x27;:app:processDebugManifest&#x27;</span>.</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   &gt; Manifest merger failed with multiple errors, see logs</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   </span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   See http:<span class="comment">//g.co/androidstudio/manifest-merger for more information about the manifest merger.</span></span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   </span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   * Try:</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   Run with --stacktrace option to get the stack trace. Run with --info <span class="keyword">or</span> --debug option to get more log output. Run with --scan to get full insights.</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   </span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   * Get more help at https:<span class="comment">//help.gradle.org</span></span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   </span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   BUILD FAILED in <span class="number">10</span>s</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   <span class="number">189</span> actionable tasks: <span class="number">1</span> executed, <span class="number">188</span> up-to-date</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   ERROR: cmd.exe failed with args /c <span class="string">&quot;C:\Users\lipengzha\Documents\Unreal Projects\GCloudExample\Intermediate\Android\armv7\gradle\rungradle.bat&quot;</span> :app:assembleDebug</span><br><span class="line">PackagingResults: Error: cmd.exe failed with args /c <span class="string">&quot;C:\Users\lipengzha\Documents\Unreal Projects\GCloudExample\Intermediate\Android\armv7\gradle\rungradle.bat&quot;</span> :app:assembleDebug</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)): Took <span class="number">13.3060694</span>s to run UnrealBuildTool.exe, ExitCode=<span class="number">6</span></span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)): UnrealBuildTool failed. See log <span class="keyword">for</span> more details. (C:\Users\lipengzha\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+Program+Files+Epic+Games+UE_4<span class="number">.25</span>\UBT-.txt)</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)): AutomationTool exiting with ExitCode=<span class="number">6</span> (<span class="number">6</span>)</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)): BUILD FAILED</span><br><span class="line">PackagingResults: Error: Unknown Error</span><br></pre></td></tr></table></figure>

<p>如果想要修改或者删除 UE 默认生成的 <code>AndroidManifest.xml</code> 中的项，可以通过先删除再添加的方式。</p>
<p>以删除以下项为例:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">&lt;meta-data android:name=<span class="string">&quot;com.epicgames.ue4.GameActivity.bUseExternalFilesDir&quot;</span> android:value=<span class="string">&quot;false&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>
<p>在 UPL 的 <code>androidManifestUpdates</code> 中编写以下代码：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">androidManifestUpdates</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">loopElements</span> <span class="attr">tag</span>=<span class="string">&quot;meta-data&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setStringFromAttribute</span> <span class="attr">result</span>=<span class="string">&quot;ApplicationSectionName&quot;</span> <span class="attr">tag</span>=<span class="string">&quot;$&quot;</span> <span class="attr">name</span>=<span class="string">&quot;android:name&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setBoolIsEqual</span> <span class="attr">result</span>=<span class="string">&quot;bUseExternalFilesDir&quot;</span> <span class="attr">arg1</span>=<span class="string">&quot;$S(ApplicationSectionName)&quot;</span> <span class="attr">arg2</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bUseExternalFilesDir&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">condition</span>=<span class="string">&quot;bUseExternalFilesDir&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">true</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">removeElement</span> <span class="attr">tag</span>=<span class="string">&quot;$&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">true</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">loopElements</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">addElements</span> <span class="attr">tag</span>=<span class="string">&quot;application&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bUseExternalFilesDir&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">addElements</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">androidManifestUpdates</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>就是去遍历 <code>AndroidManfest.xml</code> 中已经存在 <code>meta-data</code> 中，<code>android:name</code>为 <code>com.epicgames.ue4.GameActivity.bUseExternalFilesDir</code> 的项给删除。</p>
<h3 id="项目设置 bUseExternalFilesDir 选项无效分析"><a href="# 项目设置 bUseExternalFilesDir 选项无效分析" class="headerlink" title="项目设置 bUseExternalFilesDir 选项无效分析"></a>项目设置 bUseExternalFilesDir 选项无效分析 </h3><p> 下面来分析一下 <code>Project Settings</code>-<code>Android</code>-<code>Use ExternalFilesDir for UE4Game Files</code> 这个选项不生效。<br>其实这个选项确实是控制 <code>manifest</code> 中的 <code>bUseExternalFilesDir</code> 的值的，在 UBT 中操作的，上面已经提到 <code>manifest</code> 文件就是在 UBT 中生成的。<br><strong>但是 </strong>，虽然 UE 提供了这个参数，但是目前的引擎中(4.22.3) 这个选项是没有作用的，因为它被默认禁用了。<br>首先，UBT 的构建调用栈为：</p>
<ol>
<li><code>AndroidPlatform</code>(UEBuildAndroid.cs)的<code>Deploy</code></li>
<li><code>UEDeployAndroid</code>(UEDeployAndroid.cs)中的<code>PrepTargetForDeployment</code></li>
<li><code>UEDeployAndroid</code>(UEDeployAndroid.cs)中的<code>MakeApk</code>(最关键的函数)</li>
</ol>
<p><code>MakeApk</code>这个函数接收了一个特殊的控制参数<code>bDisallowExternalFilesDir</code>:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UEDeployAndroid.cs</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MakeApk</span><span class="params">(AndroidToolChain ToolChain, string ProjectName, TargetType InTargetType, string ProjectDirectory, string OutputPath, string EngineDirectory, <span class="keyword">bool</span> bForDistribution, string CookFlavor, <span class="keyword">bool</span> bMakeSeparateApks, <span class="keyword">bool</span> bIncrementalPackage, <span class="keyword">bool</span> bDisallowPackagingDataInApk, <span class="keyword">bool</span> bDisallowExternalFilesDir)</span></span>;</span><br></pre></td></tr></table></figure>

<p>它用来控制是否启用项目设置中的 <code>Use ExternalFilesDir for UE4Game Files</code> 选项。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UEDeployAndroid.cs</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MakeApk</span><span class="params">(AndroidToolChain ToolChain, string ProjectName, TargetType InTargetType, string ProjectDirectory, string OutputPath, string EngineDirectory, <span class="keyword">bool</span> bForDistribution, string CookFlavor, <span class="keyword">bool</span> bMakeSeparateApks, <span class="keyword">bool</span> bIncrementalPackage, <span class="keyword">bool</span> bDisallowPackagingDataInApk, <span class="keyword">bool</span> bDisallowExternalFilesDir)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">bool</span> bUseExternalFilesDir = <span class="built_in">UseExternalFilesDir</span>(bDisallowExternalFilesDir);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// func UseExternalFilesDir</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">UseExternalFilesDir</span><span class="params">(<span class="keyword">bool</span> bDisallowExternalFilesDir, ConfigHierarchy Ini = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (bDisallowExternalFilesDir)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// make a new one if one wasn&#x27;t passed in</span></span><br><span class="line">  <span class="keyword">if</span> (Ini == null)</span><br><span class="line">  &#123;</span><br><span class="line">    Ini = <span class="built_in">GetConfigCacheIni</span>(ConfigHierarchyType.Engine);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// we check this a lot, so make it easy </span></span><br><span class="line">  <span class="keyword">bool</span> bUseExternalFilesDir;</span><br><span class="line">  Ini.<span class="built_in">GetBool</span>(<span class="string">&quot;/Script/AndroidRuntimeSettings.AndroidRuntimeSettings&quot;</span>, <span class="string">&quot;bUseExternalFilesDir&quot;</span>, out bUseExternalFilesDir);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> bUseExternalFilesDir;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，如果 <code>bDisallowExternalFilesDir</code> 为 true 的话，就完全不会去读项目设置里的配置。</p>
<p>而关键的地方就在于，在 <code>PrepTargetForDeployment</code> 中调用 <code>MakeApk</code> 的时候，给了默认参数 true：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UEDeployAndroid.cs</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">bool</span> <span class="title">PrepTargetForDeployment</span><span class="params">(UEBuildDeployTarget InTarget)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">//Log.TraceInformation(&quot;$$$$$$$$$$$$$$ PrepTargetForDeployment $$$$$$$$$$$$$$$$$ &#123;0&#125;&quot;, InTarget.TargetName);</span></span><br><span class="line">  AndroidToolChain ToolChain = <span class="keyword">new</span> <span class="built_in">AndroidToolChain</span>(InTarget.ProjectFile, <span class="literal">false</span>, InTarget.AndroidArchitectures, InTarget.AndroidGPUArchitectures); </span><br><span class="line"></span><br><span class="line">  <span class="comment">// we need to strip architecture from any of the output paths</span></span><br><span class="line">  string BaseSoName = ToolChain.<span class="built_in">RemoveArchName</span>(InTarget.OutputPaths[<span class="number">0</span>].FullName);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// get the receipt</span></span><br><span class="line">  UnrealTargetPlatform Platform = InTarget.Platform;</span><br><span class="line">  UnrealTargetConfiguration Configuration = InTarget.Configuration;</span><br><span class="line">  string ProjectBaseName = Path.<span class="built_in">GetFileName</span>(BaseSoName).<span class="built_in">Replace</span>(<span class="string">&quot;-&quot;</span> + Platform, <span class="string">&quot;&quot;</span>).<span class="built_in">Replace</span>(<span class="string">&quot;-&quot;</span> + Configuration, <span class="string">&quot;&quot;</span>).<span class="built_in">Replace</span>(<span class="string">&quot;.so&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">  FileReference ReceiptFilename = TargetReceipt.<span class="built_in">GetDefaultPath</span>(InTarget.ProjectDirectory, ProjectBaseName, Platform, Configuration, <span class="string">&quot;&quot;</span>);</span><br><span class="line">  Log.<span class="built_in">TraceInformation</span>(<span class="string">&quot;Receipt Filename: &#123;0&#125;&quot;</span>, ReceiptFilename);</span><br><span class="line">  <span class="built_in">SetAndroidPluginData</span>(ToolChain.<span class="built_in">GetAllArchitectures</span>(), <span class="built_in">CollectPluginDataPaths</span>(TargetReceipt.<span class="built_in">Read</span>(ReceiptFilename, UnrealBuildTool.EngineDirectory, InTarget.ProjectDirectory)));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// make an apk at the end of compiling, so that we can run without packaging (debugger, cook on the fly, etc)</span></span><br><span class="line">  string RelativeEnginePath = UnrealBuildTool.EngineDirectory.<span class="built_in">MakeRelativeTo</span>(DirectoryReference.<span class="built_in">GetCurrentDirectory</span>());</span><br><span class="line">  <span class="built_in">MakeApk</span>(ToolChain, InTarget.TargetName, InTarget.ProjectDirectory.FullName, BaseSoName, RelativeEnginePath, bForDistribution: <span class="literal">false</span>, CookFlavor: <span class="string">&quot;&quot;</span>,</span><br><span class="line">bMakeSeparateApks: <span class="built_in">ShouldMakeSeparateApks</span>(), bIncrementalPackage: <span class="literal">true</span>, bDisallowPackagingDataInApk: <span class="literal">false</span>, bDisallowExternalFilesDir: <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if we made any non-standard .apk files, the generated debugger settings may be wrong</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">ShouldMakeSeparateApks</span>() &amp;&amp; (InTarget.OutputPaths.Count &gt; <span class="number">1</span> || !InTarget.OutputPaths[<span class="number">0</span>].FullName.<span class="built_in">Contains</span>(<span class="string">&quot;-armv7-es2&quot;</span>)))</span><br><span class="line">  &#123;</span><br><span class="line">    Console.<span class="built_in">WriteLine</span>(<span class="string">&quot;================================================================================================================================&quot;</span>);</span><br><span class="line">    Console.<span class="built_in">WriteLine</span>(<span class="string">&quot;Non-default apk(s) have been made: If you are debugging, you will need to manually select one to run in the debugger properties!&quot;</span>);</span><br><span class="line">    Console.<span class="built_in">WriteLine</span>(<span class="string">&quot;================================================================================================================================&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这真是好坑的一个点…我看 UE4.18 UBT 的源码中是一样的，都是默认关闭的。明明有这个选项，却默认给关闭了，但是还没有任何的提示，这真是比较蛋疼的事情。</p>
<h3 id="总结"><a href="# 总结" class="headerlink" title="总结"></a>总结 </h3><p> 其实改动引擎代码和使用 <code>manifest</code> 各有好处：</p>
<ul>
<li>改动代码的好处是可以任意指定路径（当然不一定合理），但缺点是需要源码版引擎；</li>
<li>使用 <code>Manifest</code> 的好处是不需要源码版引擎，但是只能使用 <code>InternalFilesDir</code>(Shipping) 或者<code>ExternalFilesDir</code>(not-shipping)；</li>
</ul>
<p>顺道吐槽一下 UE，一个选项没作用，还把它在设置里暴露出来干嘛…</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Mobile</tag>
        <tag>Data</tag>
      </tags>
  </entry>
  <entry>
    <title>同时支持 armv7 和 arm64 的链接库</title>
    <url>/wiki/97154335/</url>
    <content><![CDATA[<p>在开发 Android 的时候，有需求需要同时支持 arm64 和 armv7，需要在 Build.cs 中同时把 armv7 和 arm64 的链接库都添加到 <code>PublicAdditionalLibraries</code> 中：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">PublicAdditionalLibraries.<span class="built_in">AddRange</span>(<span class="keyword">new</span> string[]</span><br><span class="line">&#123;</span><br><span class="line">  Path.<span class="built_in">Combine</span>(ThirdPartyFolder, <span class="string">&quot;Android_armeabi-v7a&quot;</span>, AkConfigurationDir),</span><br><span class="line">  Path.<span class="built_in">Combine</span>(ThirdPartyFolder, <span class="string">&quot;Android_arm64-v8a&quot;</span>, AkConfigurationDir),</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>但是，在 UE 的 ModuleRules 里没有能判断当前编译的架构的方法（ModuleRules 的构造在编译时只会执行一次），导致编译 arm64 的时候找到了 armv7 的链接库，导致链接错误：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">14&gt;ld.lld: error: D:/Client/Plugins/WWise/ThirdParty/Android_armeabi-v7a/Profile/lib\libAkSoundEngine.a(AkAudioLib.o) is incompatible with aarch64linux</span><br><span class="line">ld.lld: error: D:/Client/Plugins/WWise/ThirdParty/Android_armeabi-v7a/Profile/lib\libAkSoundEngine.a(AkLEngine.o) is incompatible with aarch64linux</span><br><span class="line">ld.lld: error: D:/Client/Plugins/WWise/ThirdParty/Android_armeabi-v7a/Profile/lib\libAkSoundEngine.a(AkAudioLib.o) is incompatible with aarch64linux</span><br><span class="line">ld.lld: error: D:/Client/Plugins/WWise/ThirdParty/Android_armeabi-v7a/Profile/lib\libAkSoundEngine.a(AkLEngine.o) is incompatible with aarch64linux</span><br><span class="line">ld.lld: error: D:/Client/Plugins/WWise/ThirdParty/Android_armeabi-v7a/Profile/lib\libAkMemoryMgr.a(AkMemoryMgr.o) is incompatible with aarch64linux</span><br><span class="line">ld.lld: error: D:/Client/Plugins/WWise/ThirdParty/Android_armeabi-v7a/Profile/lib\libAkMemoryMgr.a(AkMemoryMgrBase.o) is incompatible with aarch64linux</span><br><span class="line">ld.lld: error: D:/Client/Plugins/WWise/ThirdParty/Android_armeabi-v7a/Profile/lib\libAkMemoryMgr.a(AkMemoryMgr.o) is incompatible with aarch64linux</span><br><span class="line">ld.lld: error: D:/Client/Plugins/WWise/ThirdParty/Android_armeabi-v7a/Profile/lib\libAkMemoryMgr.a(AkMemoryMgrBase.o) is incompatible with aarch64linux</span><br><span class="line">ld.lld: error: D:/Client/Plugins/WWise/ThirdParty/Android_armeabi-v7a/Profile/lib\libAkStreamMgr.a(AkStreamMgr.o) is incompatible with aarch64linux</span><br><span class="line">ld.lld: error: D:/Client/Plugins/WWise/ThirdParty/Android_armeabi-v7a/Profile/lib\libAkStreamMgr.a(AkStreamMgr.o) is incompatible with aarch64linux</span><br><span class="line">ld.lld: error: D:/Client/Plugins/WWise/ThirdParty/Android_armeabi-v7a/Profile/lib\libAkMusicEngine.a(AkMusicRenderer.o) is incompatible with aarch64linux</span><br><span class="line">ld.lld: error: D:/Client/Plugins/WWise/ThirdParty/Android_armeabi-v7a/Profile/lib\libAkMusicEngine.a(AkMusicRenderer.o) is incompatible with aarch64linux</span><br><span class="line">ld.lld: error: D:/Client/Plugins/WWise/ThirdParty/Android_armeabi-v7a/Profile/lib\libAkSpatialAudio.a(AkSpatialAudio.o) is incompatible with aarch64linux</span><br><span class="line">ld.lld: error: D:/Client/Plugins/WWise/ThirdParty/Android_armeabi-v7a/Profile/lib\libAkSpatialAudio.a(AkSpatialAudio.o) is incompatible with aarch64linux</span><br><span class="line">ld.lld: error: D:/Client/Plugins/WWise/ThirdParty/Android_armeabi-v7a/Profile/lib\libAkAudioInputSource.a(AkFXSrcAudioInput.o) is incompatible with aarch64linux</span><br><span class="line">ld.lld: error: D:/Client/Plugins/WWise/ThirdParty/Android_armeabi-v7a/Profile/lib\libAkAudioInputSource.a(AkFXSrcAudioInput.o) is incompatible with aarch64linux</span><br><span class="line">ld.lld: error: D:/Client/Plugins/WWise/ThirdParty/Android_armeabi-v7a/Profile/lib\libAkVorbisDecoder.a(AkVorbisLib.o) is incompatible with aarch64linux</span><br><span class="line">ld.lld: error: D:/Client/Plugins/WWise/ThirdParty/Android_armeabi-v7a/Profile/lib\libAkVorbisDecoder.a(AkVorbisLib.o) is incompatible with aarch64linux</span><br><span class="line">ld.lld: error: D:/Client/Plugins/WWise/ThirdParty/Android_armeabi-v7a/Profile/lib\libAkMeterFX.a(InitAkMeterFX.o) is incompatible with aarch64linux</span><br><span class="line">ld.lld: error: D:/Client/Plugins/WWise/ThirdParty/Android_armeabi-v7a/Profile/lib\libAkMeterFX.a(InitAkMeterFX.o) is incompatible with aarch64linux</span><br><span class="line">ld.lld: error: too many errors emitted, stopping now (use -error-limit=0 to see all errors)</span><br><span class="line">clang++: error: linker command failed with exit code 1 (use -v to see invocation)</span><br><span class="line">14&gt;Execution failed. Error: 1 (0x01) Target: &#x27;C:\BuildAgent\workspace\FGameClientBuild\Client\Binaries\Android\FGame-arm64.so&#x27;</span><br></pre></td></tr></table></figure>

<p>所以，需要找到一种方法，能够在使用 <code>PublicAdditionalLibraries</code> 同时添加了 arm64 和 armv7 链接库的情况下让编译器能够自动地匹配到应该去什么路径来执行链接。</p>
<p>翻了一下 UBT 的代码，发现 UE 中对在 Android 上对链接库的路径做了模式匹配：</p>
<figure class="highlight csharp"><figcaption><span>Engine\Source\Programs\UnrealBuildTool\Platform\Android\AndroidToolChain.cs</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt; AllArchNames = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt; &#123;</span><br><span class="line">  &#123; <span class="string">&quot;-armv7&quot;</span>, <span class="keyword">new</span> <span class="built_in">string</span>[] &#123; <span class="string">&quot;armv7&quot;</span>, <span class="string">&quot;armeabi-v7a&quot;</span>, &#125; &#125;,</span><br><span class="line">  &#123; <span class="string">&quot;-arm64&quot;</span>, <span class="keyword">new</span> <span class="built_in">string</span>[] &#123; <span class="string">&quot;arm64&quot;</span>, <span class="string">&quot;arm64-v8a&quot;</span>, &#125; &#125;,</span><br><span class="line">  &#123; <span class="string">&quot;-x86&quot;</span>,   <span class="keyword">new</span> <span class="built_in">string</span>[] &#123; <span class="string">&quot;x86&quot;</span>, &#125; &#125;,</span><br><span class="line">  &#123; <span class="string">&quot;-x64&quot;</span>,   <span class="keyword">new</span> <span class="built_in">string</span>[] &#123; <span class="string">&quot;x64&quot;</span>, <span class="string">&quot;x86_64&quot;</span>, &#125; &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsDirectoryForArch</span>(<span class="params"><span class="built_in">string</span> Dir, <span class="built_in">string</span> Arch</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// make sure paths use one particular slash</span></span><br><span class="line">  Dir = Dir.Replace(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;/&quot;</span>).ToLowerInvariant();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// look for other architectures in the Dir path, and fail if it finds it</span></span><br><span class="line">  <span class="keyword">foreach</span> (KeyValuePair&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt; Pair <span class="keyword">in</span> AllArchNames)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (Pair.Key != Arch)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">foreach</span> (<span class="built_in">string</span> ArchName <span class="keyword">in</span> Pair.Value)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// if there&#x27;s a directory in the path with a bad architecture name, reject it</span></span><br><span class="line">        <span class="keyword">if</span> (Regex.IsMatch(Dir, <span class="string">&quot;/&quot;</span> + ArchName + <span class="string">&quot;$&quot;</span>) || Regex.IsMatch(Dir, <span class="string">&quot;/&quot;</span> + ArchName + <span class="string">&quot;/&quot;</span>) || Regex.IsMatch(Dir, <span class="string">&quot;/&quot;</span> + ArchName + <span class="string">&quot;_API[0-9]+_NDK[0-9]+&quot;</span>, RegexOptions.IgnoreCase))</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if nothing was found, we are okay</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> FileItem[] <span class="title">LinkAllFiles</span>(<span class="params">LinkEnvironment LinkEnvironment, <span class="built_in">bool</span> bBuildImportLibraryOnly, IActionGraphBuilder Graph</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// Add the library paths to the additional path list</span></span><br><span class="line">  <span class="keyword">foreach</span> (DirectoryReference LibraryPath <span class="keyword">in</span> LinkEnvironment.LibraryPaths)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// LinkerPaths could be relative or absolute</span></span><br><span class="line">    <span class="built_in">string</span> AbsoluteLibraryPath = Utils.ExpandVariables(LibraryPath.FullName);</span><br><span class="line">    <span class="keyword">if</span> (IsDirectoryForArch(AbsoluteLibraryPath, Arch))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// environment variables aren&#x27;t expanded when using the $(style</span></span><br><span class="line">      <span class="keyword">if</span> (Path.IsPathRooted(AbsoluteLibraryPath) == <span class="literal">false</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        AbsoluteLibraryPath = Path.Combine(LinkerPath.FullName, AbsoluteLibraryPath);</span><br><span class="line">      &#125;</span><br><span class="line">      AbsoluteLibraryPath = Utils.CollapseRelativeDirectories(AbsoluteLibraryPath);</span><br><span class="line">      <span class="keyword">if</span> (!AdditionalLibraryPaths.Contains(AbsoluteLibraryPath))</span><br><span class="line">      &#123;</span><br><span class="line">        AdditionalLibraryPaths.Add(AbsoluteLibraryPath);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最关键的就是这这一行：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (Regex.IsMatch(Dir, <span class="string">&quot;/&quot;</span> + ArchName + <span class="string">&quot;$&quot;</span>) || Regex.IsMatch(Dir, <span class="string">&quot;/&quot;</span> + ArchName + <span class="string">&quot;/&quot;</span>) || Regex.IsMatch(Dir, <span class="string">&quot;/&quot;</span> + ArchName + <span class="string">&quot;_API[0-9]+_NDK[0-9]+&quot;</span>, RegexOptions.IgnoreCase))</span><br></pre></td></tr></table></figure>
<p>根据上面正则的规则，可以把链接库的路径改为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">XXXX/armeabi-v7a/</span><br><span class="line">XXXX/armeabi-v8a/</span><br></pre></td></tr></table></figure>
<p>只要我们为 Android 添加的链接库路径匹配这个规则，使用 UE 编译时就会自动使用对应架构的链接库（.a 和.so 都是可以使用这个规则的）。</p>
<p>UE 这也太坑了，这个要求文档没写，完全是一个潜规则。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Mobile</tag>
        <tag>链接库</tag>
      </tags>
  </entry>
  <entry>
    <title>引擎的环境依赖与 NDK 支持</title>
    <url>/wiki/38594c17/</url>
    <content><![CDATA[<h3 id="引擎对 Android 版本的支持"><a href="# 引擎对 Android 版本的支持" class="headerlink" title="引擎对 Android 版本的支持"></a>引擎对 Android 版本的支持 </h3><p> 在之前的笔记里：<a href="https://imzlp.com/notes/ue/#Android-SDK%E7%89%88%E6%9C%AC%E4%B8%8EAndroid%E7%9A%84%E7%89%88%E6%9C%AC">Android SDK 版本与 Android 的版本 </a> 列出了 Android 系统版本和 API Leve 版本之间的对照表。</p>
<p>但是 UE 不同的引擎版本对 Android 的系统支持也是不一样的，在 <code>Project Setting</code>-<code>Android</code> 中的 <code>Minimum SDK Version</code> 中可以设置最小的 SDK 版本，也就是 UE 打包 Android 所支持的最低系统版本。</p>
<p>在 UE4.25 中，最低可以设置 Level 为 19，即 Android4.4，在 4.25 之前的引擎版本最低支持 Level 9，也就是 Android 2.3。</p>
<p>这部分的代码可以在 <a href="https://github.com/EpicGames/UnrealEngine/blob/4.24/Engine/Source/Runtime/Android/AndroidRuntimeSettings/Classes/AndroidRuntimeSettings.h">Runtime/Android/AndroidRuntimeSettings/Classes/AndroidRuntimeSettings.h</a> 中查看，并对比不同引擎版本的区别。</p>
<h3 id="SDK 版本与 Android 的版本对照表"><a href="#SDK 版本与 Android 的版本对照表" class="headerlink" title="SDK 版本与 Android 的版本对照表"></a>SDK 版本与 Android 的版本对照表 </h3><p> 可以在 Google 的开发者站点看到：<a href="https://developer.android.com/studio/releases/platforms">Android SDK Platform</a><br>Build.VERSION_CODES 的含义：<a href="https://developer.android.com/reference/android/os/Build.VERSION_CODES">Build.VERSION_CODES</a></p>
<table>
<thead>
<tr>
<th align="center">AndroidVersion</th>
<th align="center">SDK Version</th>
<th align="center">Build.VERSION_CODES</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Android 11</td>
<td align="center">(API level 30)</td>
<td align="center">R</td>
</tr>
<tr>
<td align="center">Android 10</td>
<td align="center">(API level 29)</td>
<td align="center">Q</td>
</tr>
<tr>
<td align="center">Android 9</td>
<td align="center">(API level 28)</td>
<td align="center">P</td>
</tr>
<tr>
<td align="center">Android 8.1</td>
<td align="center">(API level27)</td>
<td align="center">O_MR1</td>
</tr>
<tr>
<td align="center">Android 8.0</td>
<td align="center">(API level 26)</td>
<td align="center">O</td>
</tr>
<tr>
<td align="center">Android 7.1</td>
<td align="center">(API level 25)</td>
<td align="center">N_MR1</td>
</tr>
<tr>
<td align="center">Android 7.0</td>
<td align="center">(API level 24)</td>
<td align="center">N</td>
</tr>
<tr>
<td align="center">Android 6.0</td>
<td align="center">(API level 23)</td>
<td align="center">M</td>
</tr>
<tr>
<td align="center">Android 5.1</td>
<td align="center">(API level 22)</td>
<td align="center">LOLLIPOP_MR1</td>
</tr>
<tr>
<td align="center">Android 5.0</td>
<td align="center">(API level 21)</td>
<td align="center">LOLLIPOP</td>
</tr>
<tr>
<td align="center">Android 4.4W</td>
<td align="center">(API level 20)</td>
<td align="center">KITKAT_WATCH</td>
</tr>
<tr>
<td align="center">Android 4.4</td>
<td align="center">(API level 19)</td>
<td align="center">KITKAT</td>
</tr>
<tr>
<td align="center">Android 4.3</td>
<td align="center">(API level 18)</td>
<td align="center">JELLY_BEAN_MR2</td>
</tr>
<tr>
<td align="center">Android 4.2</td>
<td align="center">(API level 17)</td>
<td align="center">JELLY_BEAN_MR1</td>
</tr>
<tr>
<td align="center">Android 4.1</td>
<td align="center">(API level 16)</td>
<td align="center">JELLY_BEAN</td>
</tr>
<tr>
<td align="center">Android 4.0.3</td>
<td align="center">(API level15)</td>
<td align="center">ICE_CREAM_SANDWICH_MR1</td>
</tr>
<tr>
<td align="center">Android 4.0</td>
<td align="center">(API level 14)</td>
<td align="center">ICE_CREAM_SANDWICH</td>
</tr>
<tr>
<td align="center">Android 3.2</td>
<td align="center">(API level 13)</td>
<td align="center">HONEYCOMB_MR2</td>
</tr>
<tr>
<td align="center">Android 3.1</td>
<td align="center">(API level 12)</td>
<td align="center">HONEYCOMB_MR1</td>
</tr>
<tr>
<td align="center">Android 3.0</td>
<td align="center">(API level 11)</td>
<td align="center">HONEYCOMB</td>
</tr>
<tr>
<td align="center">Android 2.3.3</td>
<td align="center">(API level 10)</td>
<td align="center">GINGERBREAD_MR1</td>
</tr>
<tr>
<td align="center">Android 2.3</td>
<td align="center">(API level 9)</td>
<td align="center">GINGERBREAD</td>
</tr>
</tbody></table>
<p>UE4 对 Android 的最低支持是 SDK9，也就是 Android2.3。</p>
<h3 id="引擎对 AndroidNDK 的要求"><a href="# 引擎对 AndroidNDK 的要求" class="headerlink" title="引擎对 AndroidNDK 的要求"></a>引擎对 AndroidNDK 的要求</h3><p>UE 在打包 Android 的时候会要求系统中具有 NDK 环境，但是不同的引擎版本对 NDK 的版本要求也不一样。</p>
<p>当使用不支持的 NDK 版本时，打包会有如下错误：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UATHelper: Packaging (Android (ETC2)):   ERROR: Android toolchain NDK r14b not supported; please use NDK r21 to NDK r23 (NDK r21b recommended)</span><br><span class="line">PackagingResults: Error: Android toolchain NDK r14b not supported; please use NDK r21 to NDK r23 (NDK r21b recommended)</span><br></pre></td></tr></table></figure>

<p>提示当前系统中的 NDK 版本不支持，并会显示支持的版本。</p>
<p>UE 打包时对 NDK 版本的检测是在 UBT 中执行的，具体文件为<code>UnrealBuildTool/Platform/Android/AndroidToolChain.cs</code>。</p>
<p>其中定义了当前引擎版本支持的 NDK 的最低和最高版本：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// in ue 4.25</span></span><br><span class="line"><span class="keyword">readonly</span> <span class="built_in">int</span> MinimumNDKToolchain = <span class="number">210100</span>;</span><br><span class="line"><span class="keyword">readonly</span> <span class="built_in">int</span> MaximumNDKToolchain = <span class="number">230100</span>;</span><br><span class="line"><span class="keyword">readonly</span> <span class="built_in">int</span> RecommendedNDKToolchain = <span class="number">210200</span>;</span><br></pre></td></tr></table></figure>

<p>可以在 Github 上比较方便地查看不同引擎版本要求的 NDK 版本:<a href="https://github.com/EpicGames/UnrealEngine/blob/4.25/Engine/Source/Programs/UnrealBuildTool/Platform/Android/AndroidToolChain.cs">UE_425_AndroidToolChain.cs</a></p>
<p>不同的引擎版本对 NDK 的要求 UE 文档中也有介绍：<a href="https://docs.unrealengine.com/en-US/SharingAndReleasing/Mobile/Android/Setup/AndroidStudio/index.html">Setting Up Android SDK and NDK for Unreal</a></p>
<table>
<thead>
<tr>
<th>Unreal Engine</th>
<th>NDK Version</th>
</tr>
</thead>
<tbody><tr>
<td>4.25+</td>
<td>NDK r21b, NDK r20b</td>
</tr>
<tr>
<td>4.21 - 4.24</td>
<td>NDK r14b</td>
</tr>
<tr>
<td>4.19 - 4.20</td>
<td>NDK r12b</td>
</tr>
</tbody></table>
<h3 id="NDK 的编译器版本"><a href="#NDK 的编译器版本" class="headerlink" title="NDK 的编译器版本"></a>NDK 的编译器版本 </h3><p>UE4 支持<code>r14b</code>-<code>r18b</code> 的 Android NDK，但是我在 UE4.22.3 中设置 <code>r18b</code> 被引擎识别为<code>r18c</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UATHelper: Packaging (Android (ETC2)):   Using &#x27;git status&#x27; to determine working set for adaptive non-unity build (C:\Users\imzlp\Documents\Unreal Projects\GWorldClient).</span><br><span class="line">UATHelper: Packaging (Android (ETC2)):   ERROR: Android toolchain NDK r18c not supported; please use NDK r14b to NDK r18b (NDK r14b recommended)</span><br><span class="line">PackagingResults: Error: Android toolchain NDK r18c not supported; please use NDK r14b to NDK r18b (NDK r14b recommended)</span><br><span class="line">UATHelper: Packaging (Android (ETC2)): Took 7.4575476s to run UnrealBuildTool.exe, ExitCode=5</span><br><span class="line">UATHelper: Packaging (Android (ETC2)): ERROR: UnrealBuildTool failed. See log for more details. (C:\Users\imzlp\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+Program+Files+Epic+Games+UE_4.22\UBT-GWorld-Android-Development.txt)</span><br><span class="line">UATHelper: Packaging (Android (ETC2)):        (see C:\Users\imzlp\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+Program+Files+Epic+Games+UE_4.22\Log.txt for full exception trace)</span><br><span class="line">PackagingResults: Error: UnrealBuildTool failed. See log for more details. (C:\Users\imzlp\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+Program+Files+Epic+Games+UE_4.22\UBT-GWorld-Android-Development.txt)</span><br><span class="line">UATHelper: Packaging (Android (ETC2)): AutomationTool exiting with ExitCode=5 (5)</span><br><span class="line">UATHelper: Packaging (Android (ETC2)): BUILD FAILED</span><br><span class="line">PackagingResults: Error: Unknown Error</span><br></pre></td></tr></table></figure>
<p>之所以要换 NDK 的版本是因为不同的 NDK 版本所包含的编译器对 C++11 标准支持度不同。</p>
<table>
<thead>
<tr>
<th>NDK</th>
<th>clang version</th>
</tr>
</thead>
<tbody><tr>
<td>r14b</td>
<td>clang 3.8.275480  (based on LLVM 3.8.275480)</td>
</tr>
<tr>
<td>r17c</td>
<td>clang version 6.0.2</td>
</tr>
<tr>
<td>r18b</td>
<td>clang version 7.0.2</td>
</tr>
<tr>
<td>r20b</td>
<td>clang version 8.0.7</td>
</tr>
</tbody></table>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Mobile</tag>
      </tags>
  </entry>
  <entry>
    <title>IOS Metal Shader 编译</title>
    <url>/wiki/10076/</url>
    <content><![CDATA[<h3 id="Windows-Metal-Shader-Compiler-for-IOS"><a href="#Windows-Metal-Shader-Compiler-for-IOS" class="headerlink" title="Windows Metal Shader Compiler for IOS"></a>Windows Metal Shader Compiler for IOS</h3><p>在 4.26 及更高的引擎版本中，支持在 Windows 上直接安装 Metal Sahder Compiler 来支持在 Windows 上编译 Metal 的 Shader，只需要在 <a href="https://developer.apple.com/download/more/">Apple 开发者网站</a> 上安装 <code>Metal Developer Tools for Windows</code> 工具安装即可。</p>
<ul>
<li><a href="https://dq8iqaixvew1d.cloudfront.net/en-US/SharingAndReleasing/Mobile/iOS/WindowsMetalShader/index.html">Using the Windows Metal Shader Compiler for iOS</a></li>
<li><a href="https://developer.apple.com/download/more/">More Downloads for Apple Developers</a></li>
</ul>
<p>4.26 引擎执行 Cook 时的 Log，可以看到创建了 Metallib：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Running: C:\Program Files\Epic Games\UE_4.26\Engine\Binaries\Win64\UE4Editor-Cmd.exe &quot;C:\Users\lipengzha\Documents\Unreal Projects\StarterContent426\StarterContent426.uproject&quot; -run=Cook  -TargetPlatform=IOS -fileopenlog -ddc=InstalledDerivedDataBackendGraph -unversioned -abslog=&quot;C:\Program Files\Epic Games\UE_4.26\Engine\Programs</span><br><span class="line">\AutomationTool\Saved\Cook-2021.04.08-10.06.40.txt&quot; -stdout -CrashForUAT -unattended -NoLogTimes  -UTF8Output</span><br><span class="line">  LogInit: Display: Running engine for game: StarterContent426</span><br><span class="line">  LogHAL: Display: Platform has ~ 32 GB [34123063296 / 34359738368 / 32], which maps to Largest [LargestMinGB=32, LargerMinGB=12, DefaultMinGB=8, SmallerMinGB=6, SmallestMinGB=0)</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;AllDesktop&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;Android&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;Android_ASTC&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;Android_DXT&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;Android_ETC2&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;AndroidClient&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;Android_ASTCClient&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;Android_DXTClient&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;Android_ETC2Client&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;Android_Multi&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;Android_MultiClient&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;IOSClient&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;IOS&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;Linux&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;LinuxNoEditor&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;LinuxClient&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;LinuxServer&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;LinuxAArch64NoEditor&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;LinuxAArch64Client&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;LinuxAArch64Server&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;Lumin&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;LuminClient&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;MacNoEditor&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;Mac&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;MacClient&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;MacServer&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;TVOSClient&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;TVOS&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;WindowsNoEditor&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;Windows&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;WindowsClient&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#x27;WindowsServer&#x27;</span><br><span class="line">  LogTargetPlatformManager: Display: Building Assets For IOS</span><br><span class="line">  LogAudioDebug: Display: Lib vorbis DLL was dynamically loaded.</span><br><span class="line">  LogShaderCompilers: Display: Using Local Shader Compiler.</span><br><span class="line">  LogDerivedDataCache: Display: Max Cache Size: 512 MB</span><br><span class="line">  LogDerivedDataCache: Display: Loaded Boot cache: C:/Users/lipengzha/AppData/Local/UnrealEngine/4.26/DerivedDataCache/Boot.ddc</span><br><span class="line">  LogDerivedDataCache: Display: Pak cache opened for reading ../../../Engine/DerivedDataCache/Compressed.ddp.</span><br><span class="line">  LogDerivedDataCache: Display: Performance to C:/Users/lipengzha/AppData/Local/UnrealEngine/Common/DerivedDataCache: Latency=0.06ms. RandomReadSpeed=291.68MBs, RandomWriteSpeed=137.99MBs. Assigned SpeedClass &#x27;Local&#x27;</span><br><span class="line">  LogMaterial: Display: Missing cached shader map for material Widget3DPassThrough, compiling.</span><br><span class="line">  LogMaterial: Display: Missing cached shader map for material Widget3DPassThrough, compiling.</span><br><span class="line">  LogMaterial: Display: Missing cached shader map for material Widget3DPassThrough, compiling.</span><br><span class="line">  LogMaterial: Display: Missing cached shader map for material Widget3DPassThrough, compiling.</span><br><span class="line">  LogMaterial: Display: Missing cached shader map for material Widget3DPassThrough, compiling.</span><br><span class="line">  LogMaterial: Display: Missing cached shader map for material Widget3DPassThrough, compiling.</span><br><span class="line">  LogMaterial: Display: Missing cached shader map for material DefaultSpriteMaterial, compiling.</span><br><span class="line">  LogAudioCaptureCore: Display: No Audio Capture implementations found. Audio input will be silent.</span><br><span class="line">  LogAudioCaptureCore: Display: No Audio Capture implementations found. Audio input will be silent.</span><br><span class="line">  LogCook: Display: CookSettings for Memory: MemoryMaxUsedVirtual 0MiB, MemoryMaxUsedPhysical 16384MiB, MemoryMinFreeVirtual 0MiB, MemoryMinFreePhysical 1024MiB</span><br><span class="line">  LogCook: Display: Mobile HDR setting 1</span><br><span class="line">  LogCook: Display: Creating asset registry</span><br><span class="line">  LogCook: Display: Discovering localized assets for cultures: en</span><br><span class="line">  LogCook: Display: Unable to read previous cook inisettings for platform IOS invalidating cook</span><br><span class="line">  LogCook: Display: Clearing all cooked content for platform IOS</span><br><span class="line">  LogCook: Display: Sandbox cleanup took 0.025 seconds for platforms IOS</span><br><span class="line">  LogMetalShaderCompiler: Display: Creating Native Library C:/Users/lipengzha/Documents/Unreal Projects/StarterContent426/Saved/Cooked/IOS/StarterContent426/Content/Global_SF_METAL.0.metallib</span><br><span class="line">  LogMetalShaderCompiler: Display: Archiving 685 shaders for shader platform: SF_METAL</span><br><span class="line">  LogZipArchiveWriter: Display: Closing zip file with 0 entries.</span><br><span class="line">  LogMetalShaderCompiler: Display: Post-processing archive for shader platform: SF_METAL</span><br><span class="line">  LogCook: Display: Cooked packages 0 Packages Remain 314 Total 314</span><br></pre></td></tr></table></figure>
<p>打包出来的 Shadercode 不是 <code>ushaderbytecode</code> 文件，而是和 Mac 上打包一致的<code>metallib</code>。</p>
<h3 id="Loaded-a-text-shader-will-be-slower-to-load"><a href="#Loaded-a-text-shader-will-be-slower-to-load" class="headerlink" title="Loaded a text shader (will be slower to load)"></a>Loaded a text shader (will be slower to load)</h3><p>当使用远程构建的方式打包了 IOS 包，在运行时会有以下 log：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">LogMetal: Display: Loaded a text shader (will be slower to load)</span><br></pre></td></tr></table></figure>
<p>该日志在以下代码中输出：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">Source\Runtime\Apple\MetalRHI\Private\MetalShaders.cpp</span><br><span class="line"><span class="comment">/** Initialization constructor. */</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> BaseResourceType, int32 ShaderType&gt;</span><br><span class="line"><span class="keyword">void</span> TMetalBaseShader&lt;BaseResourceType, ShaderType&gt;::<span class="built_in">Init</span>(TArrayView&lt;<span class="keyword">const</span> uint8&gt; InShaderCode, FMetalCodeHeader&amp; Header, mtlpp::Library InLibrary)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是因为加载的 Shader 需要实时编译，会比较慢，可以在项目设置中为 IOS 开启<code>remote shader compile</code>，在 UE4.26 之后，也可以通过本地安装 metal 的工具链在本地编译 metal 的 shader。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
        <category>IOS</category>
      </categories>
      <tags>
        <tag>Mobile</tag>
        <tag>IOS</tag>
        <tag>Shader</tag>
        <tag>Metal</tag>
      </tags>
  </entry>
  <entry>
    <title>IOS 基础包拆分</title>
    <url>/wiki/12156/</url>
    <content><![CDATA[<p>在前面提到了 UE 为 Android 提供了打包到 obb 中的文件过滤规则：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Config/DefaultEngine.ini</span></span><br><span class="line"><span class="section">[/Script/AndroidRuntimeSettings.AndroidRuntimeSettings]</span></span><br><span class="line">+<span class="attr">ObbFilters</span>=-pakchunk1-*</span><br></pre></td></tr></table></figure>
<p>但是 UE 并没有为 IOS 提供相应的操作，默认情况下会把 IOS 的所有的 pak 文件都打包至 IPA 中。</p>
<p>为了统一 Android 和 IOS 的基础包规则，我自己实现了 IOS 上类似 Android 那种指定过滤规则的功能，做个简单的介绍。</p>
<p>我使用的是 Mac 远程打包，流程是在 Mac 上编译代码生成 IPA，拉回 Win，在 Win 上进行 Cook，生成 Pak 文件，最后把原始 IPA 解包，再添加 Pak 等文件组合成最终 IPA。</p>
<p>我的需求是，自定义指定过滤规则，可以把某些文件忽略，不打包到 IPA 中。那么这一步的操作其实就位于把 IPA 解包再打包的流程里，经过翻阅 UE 的代码，发现这个操作是通过 <code>iPhonePackager</code> 这个独立程序来实现的，那么就需要对这个程序的代码进行改造了。</p>
<p>经过调试分析，发现真正实现重新打包 IPA 的操作是在以下函数中执行的：</p>
<figure class="highlight plaintext"><figcaption><span>Programs/IOS/iPhonePackager/CookTime.cs</span></figcaption><table><tr><td class="code"><pre><span class="line">/** </span><br><span class="line">* Using the stub IPA previously compiled on the Mac, create a new IPA with assets</span><br><span class="line">*/</span><br><span class="line">static public void RepackageIPAFromStub();</span><br></pre></td></tr></table></figure>
<p>该函数位于 <code>iPhonePackager</code>-<code>CookTime</code> 类中。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RepackageIPAFromStub</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="built_in">string</span> SourceDir = Path.GetFullPath(ZipSourceDir);</span><br><span class="line">  <span class="built_in">string</span>[] PayloadFiles = Directory.GetFiles(SourceDir, <span class="string">&quot;*.*&quot;</span>, Config.bIterate ? SearchOption.TopDirectoryOnly : SearchOption.AllDirectories);</span><br><span class="line">  <span class="keyword">foreach</span> (<span class="built_in">string</span> Filename <span class="keyword">in</span> PayloadFiles)</span><br><span class="line">    &#123;</span><br><span class="line">       <span class="comment">// read file to memory,add to ZipFileSystem</span></span><br><span class="line">       <span class="comment">// generate stub and ipa</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要做的操作就是介入这个过程，把 <code>PayloadFiles</code> 中的文件列表通过我们自定义的规则来执行过滤。</p>
<p>从流程上分为以下几个步骤：</p>
<ol>
<li>从项目中读取 Filter 的配置</li>
<li>创建出真正的过滤器</li>
<li>在 <code>RepackageIPAFromStub</code> 遍历文件的流程里使用过滤器进行检测是否需要被打入 ipa</li>
</ol>
<p>只需要几十行代码就可以实现，首先需要添加一个 IniReader 的类：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> Tools.DotNETCommon;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</span><br><span class="line"><span class="keyword">using</span> Ini;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Ini</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">IniReader</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> path;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">DllImport(<span class="meta-string">&quot;kernel32&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">int</span> <span class="title">GetPrivateProfileString</span>(<span class="params"><span class="built_in">string</span> section, <span class="built_in">string</span> key, <span class="built_in">string</span> def,</span></span></span><br><span class="line"><span class="params"><span class="function">      StringBuilder retVal, <span class="built_in">int</span> size, <span class="built_in">string</span> filePath</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IniReader</span>(<span class="params"><span class="built_in">string</span> INIPath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">      path = INIPath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">ReadValue</span>(<span class="params"><span class="built_in">string</span> Section, <span class="built_in">string</span> Key</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">      StringBuilder ReaderBuffer = <span class="keyword">new</span> StringBuilder(<span class="number">255</span>);</span><br><span class="line">      <span class="built_in">int</span> ret = GetPrivateProfileString(Section, Key, <span class="string">&quot;&quot;</span>, ReaderBuffer, <span class="number">255</span>, <span class="keyword">this</span>.path);</span><br><span class="line">      <span class="keyword">return</span> ReaderBuffer.ToString();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在 <code>RepackageIPAFromStub</code> 函数中创建过滤器：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">FileFilter IpaPakFileFilter = <span class="keyword">new</span> FileFilter(FileFilterType.Include);</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">string</span> ProjectDir = Directory.GetParent(Path.GetFullPath(Config.ProjectFile)).FullName;</span><br><span class="line">  <span class="comment">// Program.Log(&quot;ProjectDir path &#123;0&#125;&quot;, ProjectDir);</span></span><br><span class="line">  <span class="built_in">string</span> EngineIni = Path.Combine(ProjectDir,<span class="string">&quot;Config&quot;</span>,<span class="string">&quot;DefaultEngine.ini&quot;</span>);</span><br><span class="line">  <span class="comment">// Program.Log(&quot;EngineIni path &#123;0&#125;&quot;, EngineIni);</span></span><br><span class="line">  IniReader EngineIniReader = <span class="keyword">new</span> IniReader(EngineIni);</span><br><span class="line">  <span class="comment">// string RawPakFilterRules = EngineIniReader.ReadValue(&quot;/Script/IOSRuntimeSettings.IOSRuntimeSettings&quot;, &quot;IPAFilters&quot;);</span></span><br><span class="line">  Program.Log(<span class="string">&quot;RawPakFilterRules &#123;0&#125;&quot;</span>, RawPakFilterRules);</span><br><span class="line">  <span class="built_in">string</span>[] PakRules = RawPakFilterRules.Split(<span class="string">&#x27;,&#x27;</span>);   </span><br><span class="line">  <span class="comment">// foreach(string Rule in PakRules) &#123;Program.Log(&quot;PakRules &#123;0&#125;&quot;, Rule);&#125;</span></span><br><span class="line">  </span><br><span class="line">  List&lt;<span class="built_in">string</span>&gt; PakFilters = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;(PakRules);</span><br><span class="line">  <span class="keyword">if</span> (PakFilters != <span class="literal">null</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    IpaPakFileFilter.AddRules(PakFilters);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里从项目的 <code>Config/DefaultEngine.ini</code> 的[/Script/IOSRuntimeSettings.IOSRuntimeSettings]项读取 <code>IPAFilters</code> 的值，规则与 Android 相同，但是要把规则都写在一行，多个规则以逗号分隔。</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[/Script/IOSRuntimeSettings.IOSRuntimeSettings]</span></span><br><span class="line"><span class="attr">IPAFilters</span>=-*.pak,pakchunk0-*</span><br></pre></td></tr></table></figure>

<p>最终，还需要在 <code>RepackageIPAFromStub</code> 遍历 <code>Payload</code> 文件的循环中进行检测是否匹配我们指定的过滤规则：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RepackageIPAFromStub</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="built_in">string</span> SourceDir = Path.GetFullPath(ZipSourceDir);</span><br><span class="line">  <span class="built_in">string</span>[] PayloadFiles = Directory.GetFiles(SourceDir, <span class="string">&quot;*.*&quot;</span>, Config.bIterate ? SearchOption.TopDirectoryOnly : SearchOption.AllDirectories);</span><br><span class="line">  <span class="keyword">foreach</span> (<span class="built_in">string</span> Filename <span class="keyword">in</span> PayloadFiles)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (!IpaPakFileFilter.Matches(Filename))</span><br><span class="line">    &#123;</span><br><span class="line">      Program.Log(<span class="string">&quot;IpaPakFileFilter not match file &#123;0&#125;&quot;</span>, Filename);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Program.Log(&quot;IpaPakFileFilter  match file &#123;0&#125;&quot;, Filename);</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样再执行打包 IOS，就会按照指定的过滤规则来添加文件了，实现了与 Android 上一致的行为。</p>
<p>打包过程中的 Log 如下（上文代码已注释）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Saving IPA ...</span><br><span class="line">ProjectDir path C:\BuildAgent\workspace\PackageWindows\Client</span><br><span class="line">EngineIni path C:\BuildAgent\workspace\PackageWindows\Client\Config\DefaultEngine.ini</span><br><span class="line">RawPakFilterRules -*.pak,pakchunk0-*</span><br><span class="line">PakRules -*.pak</span><br><span class="line">PakRules pakchunk0-*</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\Assets.car</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\Info.plist</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\LaunchScreenIOS.webp</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\Manifest_DebugFiles_IOS.txt</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\Manifest_NonUFSFiles_IOS.txt</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\mute.caf</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\ue4commandline.txt</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\cookeddata\fgame\content\movies\logo.mp4</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\cookeddata\fgame\content\movies\sparkmore.mp4</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\cookeddata\fgame\content\paks\pakchunk0-ios.pak</span><br><span class="line">IpaPakFileFilter not match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\cookeddata\fgame\content\paks\pakchunk1-ios.pak</span><br><span class="line">IpaPakFileFilter not match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\cookeddata\fgame\content\paks\pakchunk2-ios.pak</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\Engine\Content\SlateDebug\Fonts\LastResort.ttf</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\GCloudVoice.bundle\files\config.json</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\GCloudVoice.bundle\files\libwxvoiceembed.bin</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\GCloudVoice.bundle\files\mute_detection.aiff</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\GRobotResource.bundle\config.json</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>可以看到，过滤规则已经生效了。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
        <category>IOS</category>
      </categories>
      <tags>
        <tag>Mobile</tag>
        <tag>IOS</tag>
      </tags>
  </entry>
  <entry>
    <title>IOS 远程构建最大文件不能超过 2G</title>
    <url>/wiki/12584/</url>
    <content><![CDATA[<p>Win 上远程构建出 IOS 包的流程是代码和 bundle 都上传到 Mac 上编译，生成不包含资源的 IPA，拉回本地执行资源 Cook 生成 Pak 后，把代码的 IPA 和资源的 Pak 合并成真正的 IPA 文件。<br>但是这样有个问题，UE 里的实现是把所有要合并的文件读到内存中再合并打包的：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RepackageIPAFromStub</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// Add all of the payload files, replacing existing files in the stub IPA if necessary (should only occur for icons)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">string</span> SourceDir = Path.GetFullPath(ZipSourceDir);</span><br><span class="line">    <span class="built_in">string</span>[] PayloadFiles = Directory.GetFiles(SourceDir, <span class="string">&quot;*.*&quot;</span>, Config.bIterate ? SearchOption.TopDirectoryOnly : SearchOption.AllDirectories);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="built_in">string</span> Filename <span class="keyword">in</span> PayloadFiles)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// Get the relative path to the file (this implementation only works because we know the files are all</span></span><br><span class="line">      <span class="comment">// deeper than the base dir, since they were generated from a search)</span></span><br><span class="line">      <span class="built_in">string</span> AbsoluteFilename = Path.GetFullPath(Filename);</span><br><span class="line">      <span class="built_in">string</span> RelativeFilename = AbsoluteFilename.Substring(SourceDir.Length + <span class="number">1</span>).Replace(<span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="built_in">string</span> ZipAbsolutePath = String.Format(<span class="string">&quot;Payload/&#123;0&#125;&#123;1&#125;.app/&#123;2&#125;&quot;</span>,</span><br><span class="line">        Config.GetTargetName(),</span><br><span class="line">        Program.Architecture,</span><br><span class="line">        RelativeFilename);</span><br><span class="line"></span><br><span class="line">      <span class="built_in">byte</span>[] FileContents = File.ReadAllBytes(AbsoluteFilename);</span><br><span class="line">      <span class="keyword">if</span> (FileContents.Length == <span class="number">0</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// Zero-length files added by Ionic cause installation/upgrade to fail on device with error 0xE8000050</span></span><br><span class="line">        <span class="comment">// We store a single byte in the files as a workaround for now</span></span><br><span class="line">        FileContents = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1</span>];</span><br><span class="line">        FileContents[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      FileSystem.WriteAllBytes(RelativeFilename, FileContents);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((FileContents.Length &gt;= <span class="number">1024</span> * <span class="number">1024</span>) || (Config.bVerbose))</span><br><span class="line">      &#123;</span><br><span class="line">        FilesBeingModifiedToPrintOut.Add(ZipAbsolutePath);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到是把 Payload 的每个文件读到 <code>byte[]</code> 里的，这就有了一个限制，在 C# 中，数组的长度最大是 <code>int32.MaxValue</code>，意味着<code>byte[]</code> 不能存储超过 2G 的文件，不然就会触发异常。<br>查询了 MSDN 的文档，发现设置 <a href="https://docs.microsoft.com/zh-cn/dotnet/framework/configure-apps/file-schema/runtime/gcallowverylargeobjects-element?redirectedfrom=MSDN">gcAllowVeryLargeObjects</a> 也不会改变单个维度的数组的大小。</p>
<ul>
<li><a href="https://stackoverflow.com/questions/3944320/maximum-length-of-byte">Maximum length of byte[]?</a></li>
</ul>
<p>所以这个问题只能从其他方面入手了，让 UE 进行资源打包的时候把 Pak 的文件拆分，让每个文件都小于 2GB 即可，可以通过 UE 里的 Chunk 机制进行拆分。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
        <category>IOS</category>
      </categories>
      <tags>
        <tag>Mobile</tag>
        <tag>IOS</tag>
      </tags>
  </entry>
  <entry>
    <title>Install IPA 0xE8008029 Error</title>
    <url>/wiki/d2310d51/</url>
    <content><![CDATA[<p>使用最新的苹果开发者证书（2021.07.11）打包的 IPA 安装时具有错误：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[DD] Mobile Device &#x27;iPhone&#x27; connected</span><br><span class="line">Trying to connect to mobile device running iOS ...</span><br><span class="line">Transferring IPA to device &#x27;iPhone&#x27; ...</span><br><span class="line"> ... Transfer is 10% complete at phase &#x27;TransferringPackage&#x27;</span><br><span class="line"> ... Transfer is 20% complete at phase &#x27;CopyingFile&#x27;</span><br><span class="line"> ... Transfer is 30% complete at phase &#x27;CopyingFile&#x27;</span><br><span class="line"> ... Transfer is 40% complete at phase &#x27;CopyingFile&#x27;</span><br><span class="line"> ... Transfer is 50% complete at phase &#x27;CopyingFile&#x27;</span><br><span class="line"> ... Transfer is 60% complete at phase &#x27;CopyingFile&#x27;</span><br><span class="line"> ... Transfer is 80% complete at phase &#x27;CopyingFile&#x27;</span><br><span class="line">Installing IPA on device &#x27;iPhone&#x27; ...</span><br><span class="line"> ... Install is 5% complete at phase &#x27;CreatingStagingDirectory&#x27;</span><br><span class="line"> ... Install is 20% complete at phase &#x27;InspectingPackage&#x27;</span><br><span class="line"> ... Install is 40% complete at phase &#x27;VerifyingApplication&#x27;</span><br><span class="line">Install \ Update of &quot;Blank425.ipa&quot; failed with Unknown error 0xE8008029 in 13.65 seconds</span><br></pre></td></tr></table></figure>
<p>或者有 <code>0xE8008019</code> 的错误：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Installing IPA on device &#x27;iPhone&#x27; ...</span><br><span class="line"> ... Install is 5% complete at phase &#x27;CreatingStagingDirectory&#x27;</span><br><span class="line"> ... Install is 20% complete at phase &#x27;InspectingPackage&#x27;</span><br><span class="line"> ... Install is 40% complete at phase &#x27;VerifyingApplication&#x27;</span><br><span class="line">Install \ Update of &quot;Blank425.ipa&quot; failed with Missing or invalid code signature (0xE8008019) in 0.27 seconds</span><br></pre></td></tr></table></figure>
<p>这是因为使用了老的代码格式签名导致的。</p>
<ul>
<li><a href="https://github.com/EpicGames/UnrealEngine/blob/4.27/Engine/Source/Programs/IOS/iPhonePackager/MachObjects.cs#L2099">4.27/Engine/Source/Programs/IOS/iPhonePackager/MachObjects.cs#L2099</a></li>
<li><a href="https://developer.apple.com/documentation/xcode/using-the-latest-code-signature-format">Using the Latest Code Signature Format</a></li>
<li><a href="https://issues.unrealengine.com/issue/UE-114823">iOS 14.5 - Code Signing Version No Longer Supported</a></li>
</ul>
<p>在 UE4.25 中，<code>cVersion2</code>的值：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CodeDirectoryBlob</span> : <span class="title">AbstractBlob</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">const</span> UInt32 cVersion2 = <span class="number">0x20200</span>;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 4.27 中 <code>IPhonePackager</code> 做了修正，使用之前版本的 UE 打包出来的 IPA 使用 4.27 之后的 IPhonePackager 进行 re-signing 即可安装。<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210713121757.webp"></p>
<p>re-signing log：<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210713122100.webp"></p>
<p>我提取了 UE4.27 的 iPhonePackager 的代码和编译的可执行程序：</p>
<ul>
<li><a href="https://img.imzlp.com/imgs/zlp/others/ue/iPhonePackager.7z">iPhonePackager.7z</a></li>
<li><a href="https://img.imzlp.com/imgs/zlp/others/ue/iPhonePackager_src_427.7z">iPhonePackager_src_427.7z</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
        <category>IOS</category>
      </categories>
      <tags>
        <tag>Mobile</tag>
        <tag>IOS</tag>
        <tag>IPA</tag>
      </tags>
  </entry>
  <entry>
    <title>TargetRules 导入证书和 Provision</title>
    <url>/wiki/41495/</url>
    <content><![CDATA[<p>传统的打包 ios 时，需要手动在 <code>Project Settings</code>-<code>Platforms</code>-<code>IOS</code> 中选择打包要使用的 <code>Certificate</code> 和<code>Provision</code>，当需要切换打包 Configuration 的时候就需要打开编辑器重新选择一遍（因为 Development 和 Shipping 用到的证书不同），很麻烦，我是一个非常讨厌做重复操作的人，所以研究了一下解决了这个问题。<br>也是得益于 UE 本身提供了代码中导入 <code>Certificate</code> 和<code>Provision</code>的方式（之前我还写了自动化把证书导入到系统中，其实不用了）。<br>在前面的笔记中提到过 UE 的 Target 也提供了平台相关的 Target 对象：<a href="https://imzlp.com/notes/ue/#%E5%B9%B3%E5%8F%B0%E7%9B%B8%E5%85%B3Target">平台相关 Target</a>，要实现本文提到的需求就要通过控制 <code>IOSPlatform</code> 来实现。</p>
<p><code>IOSPlatform</code>提供了以下几个属性：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTool/Platform/UEBuildIOS.cs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Manual override for the provision to use. Should be a full path.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CommandLine(<span class="meta-string">&quot;-ImportProvision=&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> ImportProvision = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Imports the given certificate (inc private key) into a temporary keychain before signing.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CommandLine(<span class="meta-string">&quot;-ImportCertificate=&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> ImportCertificate = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Password for the imported certificate</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CommandLine(<span class="meta-string">&quot;-ImportCertificatePassword=&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> ImportCertificatePassword = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>
<p>通过操作它们的值来实现自动化导入证书和 Provision，我写了一段使用代码：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FGameTarget</span> : <span class="title">TargetRules</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">FGameTarget</span>(<span class="params"> TargetInfo Target</span>) : <span class="title">base</span>(<span class="params">Target</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    Type = TargetType.Game;</span><br><span class="line">    DefaultBuildSettings = BuildSettingsVersion.V1;</span><br><span class="line">    ExtraModuleNames.AddRange(<span class="keyword">new</span> <span class="built_in">string</span>[] &#123; <span class="string">&quot;FGame&quot;</span> &#125; );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// for package dSYM</span></span><br><span class="line">    bDisableDebugInfo = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span>(Target.Platform == UnrealTargetPlatform.IOS)</span><br><span class="line">    &#123;</span><br><span class="line">      DirectoryReference ProjectDir = ProjectFile.Directory;</span><br><span class="line">      IOSPlatform.bGeneratedSYM = <span class="literal">true</span>;</span><br><span class="line">      <span class="built_in">string</span> PackageConfiguration = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// import cer/provision</span></span><br><span class="line">      <span class="keyword">switch</span> (Target.Configuration)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.Debug:</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.Development:</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.Test:</span><br><span class="line">        &#123;</span><br><span class="line">          PackageConfiguration = <span class="string">&quot;Development&quot;</span>;</span><br><span class="line">          IOSPlatform.bForDistribution = <span class="literal">false</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.Shipping:</span><br><span class="line">        &#123;</span><br><span class="line">          PackageConfiguration = <span class="string">&quot;Distibution&quot;</span>;</span><br><span class="line">          IOSPlatform.bForDistribution = <span class="literal">true</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="built_in">string</span> cerPath = Path.Combine(ProjectDir.FullName, <span class="string">&quot;Source/ThirdParty/iOS/&quot;</span>,PackageConfiguration,<span class="string">&quot;XXXXXX_IOS.p12&quot;</span>);</span><br><span class="line">      <span class="built_in">string</span> proversionPath = Path.Combine(ProjectDir.FullName, <span class="string">&quot;Source/ThirdParty/iOS/&quot;</span>,PackageConfiguration,<span class="string">&quot;com.tencent.xxxx.xx_SignProvision.mobileprovision&quot;</span>);</span><br><span class="line">      <span class="built_in">string</span> cerPassword = <span class="string">&quot;password&quot;</span>;</span><br><span class="line">      </span><br><span class="line">      Console.WriteLine(<span class="string">&quot;Import Certificate:&quot;</span>+cerPath);</span><br><span class="line">      Console.WriteLine(<span class="string">&quot;Import Provision:&quot;</span>+proversionPath);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (File.Exists(cerPath) &amp;&amp; File.Exists(proversionPath))</span><br><span class="line">      &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Import Certificate &amp; Provision set to IOSPlatform&quot;</span>);</span><br><span class="line">        IOSPlatform.ImportCertificate = cerPath;</span><br><span class="line">        IOSPlatform.ImportProvision = proversionPath;</span><br><span class="line">        IOSPlatform.ImportCertificatePassword = cerPassword;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在打包 IOS 时就会自动使用所指定的证书了，并且会在 Shipping 时自动化启用 <code>Distribution</code>，这样就可以避免要事先把证书和<code>provision</code> 导入到系统中。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
        <category>IOS</category>
      </categories>
      <tags>
        <tag>Mobile</tag>
        <tag>IOS</tag>
      </tags>
  </entry>
  <entry>
    <title>命令行导入证书和 Provision</title>
    <url>/wiki/32489/</url>
    <content><![CDATA[<p>在部署构建机的时候，需要给每台构建机都导入 iOS 的 <code>provision</code> 和<code>p12</code>证书，如果每个都要打开一遍编辑器，纯粹是重复劳动，翻了下代码，UE 编辑器中导入证书是通过调用 <code>IPhonePackager.exe</code> 来实现的，而且是以命令行的方式执行，这样就好办了，按照它的参数自己实现脚本即可。<br>具体看引擎中的相关代码：<a href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Developer/IOS/IOSPlatformEditor/Private/IOSTargetSettingsCustomization.cpp#L1312">IOSTargetSettingsCustomization.cpp#L1312</a></p>
<h3 id="Certificate"><a href="#Certificate" class="headerlink" title="Certificate"></a>Certificate</h3><p>导入证书的命令为：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Engine\Binaries\DotNET\IOS\IPhonePackager.exe Install Engine -project <span class="string">&quot;D:\Client\FGame.uproject&quot;</span> -certificate <span class="string">&quot;D:\IOS_DEVELOPMENT.p12&quot;</span> -bundlename <span class="string">&quot;com.tencent.xxxx.xx&quot;</span></span><br></pre></td></tr></table></figure>

<p>证书是导入到系统中的，可以在 <code>certmgr.msc</code> 中查看导入的证书：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/IOS/import-ios-cer-in-windows-certmgr.webp"></p>
<p><strong>注意</strong>：因为 iPhonePackager.exe 在导入证书时会让弹框输入证书的密码：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/IOS/ue4-import-cer-for-ios.webp"></p>
<p>这导致不能用在自动化流程里，但是我怎么可能会老老实实每台电脑都输一次密码呢，看了一下 iPhonePackager 的代码，找到了弹窗让输入密码的地方<a href="https://github.com/epicgames/unrealengine/blob/release/Engine/Source/Programs/IOS/iPhonePackager/ToolsHub.cs#L263">Programs/IOS/iPhonePackager/ToolsHub.cs#L263</a>，我给它加了个从命令行参数读取密码的选项，如果有该参数就不会弹框：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Load the certificate</span></span><br><span class="line"><span class="built_in">string</span> CertificatePassword = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="built_in">string</span>[] arguments = Environment.GetCommandLineArgs();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">int</span> index = <span class="number">0</span>;index&lt;arguments.Length;++index)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (arguments[index] == <span class="string">&quot;-cerpassword&quot;</span> &amp;&amp; index != (arguments.Length<span class="number">-1</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		CertificatePassword = arguments[index + <span class="number">1</span>];</span><br><span class="line">		Console.WriteLine(<span class="string">&quot;Usage -cerpasseord argument&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">X509Certificate2 Cert = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">	Cert = <span class="keyword">new</span> X509Certificate2(CertificateFilename, CertificatePassword, X509KeyStorageFlags.PersistKeySet | X509KeyStorageFlags.Exportable | X509KeyStorageFlags.MachineKeySet);</span><br><span class="line">&#125;</span><br><span class="line">catch (System.Security.Cryptography.CryptographicException ex)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Try once with a password</span></span><br><span class="line">	<span class="keyword">if</span> (CertificatePassword.Length &gt; <span class="number">0</span> || PasswordDialog.RequestPassword(<span class="keyword">out</span> CertificatePassword))</span><br><span class="line">	&#123;</span><br><span class="line">		Cert = <span class="keyword">new</span> X509Certificate2(CertificateFilename, CertificatePassword, X509KeyStorageFlags.PersistKeySet | X509KeyStorageFlags.Exportable | X509KeyStorageFlags.MachineKeySet);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// User cancelled dialog, rethrow</span></span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>把上面的代码替换掉 <a href="https://github.com/epicgames/unrealengine/blob/release/Engine/Source/Programs/IOS/iPhonePackager/ToolsHub.cs#L263">Programs/IOS/iPhonePackager/ToolsHub.cs#L263</a> 这里的部分，重新编译 iPhonePackager 即可。</p>
<h3 id="Provision"><a href="#Provision" class="headerlink" title="Provision"></a>Provision</h3><p>导入 <code>Provision</code> 的命令为：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Engine\Binaries\DotNET\IOS\IPhonePackager.exe Install Engine -project <span class="string">&quot;D:\Client\FGame.uproject&quot;</span> -provision <span class="string">&quot;D:\com.tencent.xxxx.xx_Development_SignProvision.mobileprovision&quot;</span> -bundlename <span class="string">&quot;com.tencent.xxxx.xx&quot;</span></span><br></pre></td></tr></table></figure>

<p>Provision 文件导入后会放在用户目录下：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> The shared provision library directory (on PC)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ProvisionDirectory</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">get</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Environment.OSVersion.Platform == PlatformID.MacOSX || Environment.OSVersion.Platform == PlatformID.Unix) &#123;</span><br><span class="line">            <span class="keyword">return</span> Environment.GetEnvironmentVariable(<span class="string">&quot;HOME&quot;</span>) + <span class="string">&quot;/Library/MobileDevice/Provisioning Profiles/&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Environment.GetFolderPath (Environment.SpecialFolder.LocalApplicationData) + <span class="string">&quot;/Apple Computer/MobileDevice/Provisioning Profiles/&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Win 上就为：<code>C:\Users\USER_NAME\AppData\Local\Apple Computer\MobileDevice\Provisioning Profiles</code>.</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
        <category>IOS</category>
      </categories>
      <tags>
        <tag>Mobile</tag>
        <tag>IOS</tag>
      </tags>
  </entry>
  <entry>
    <title>打包 IOS 签名错误排查</title>
    <url>/wiki/41792/</url>
    <content><![CDATA[<h3 id="IOS 签名错误排查"><a href="#IOS 签名错误排查" class="headerlink" title="IOS 签名错误排查"></a>IOS 签名错误排查 </h3><p> 在 Mac 上直接打包 iOS 时遇到以下错误：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">2020-09-27 19:23:48:778 :         /usr/bin/codesign --force --sign 2C74981D1576F95021XXXXXXXXXXA7ECBD8A81A0 --entitlements /Users/buildmachine/Documents/BuildWorkspace/workspace/PackageClient/Client/Intermediate/ProjectFilesIOS/build/FGame.build/Development-iphoneos/FGame.build/FGame.app.xcent --timestamp=none /Users/buildmachine/Documents/BuildWorkspace/workspace/PackageClient/Client/Binaries/IOS/Payload/FGame.app</span><br><span class="line">2020-09-27 19:23:59:896 :     /Users/buildmachine/Documents/BuildWorkspace/workspace/PackageClient/Client/Binaries/IOS/Payload/FGame.app: errSecInternalComponent</span><br><span class="line">2020-09-27 19:23:59:896 :     Command /usr/bin/codesign failed with <span class="built_in">exit</span> code 1</span><br><span class="line">2020-09-27 19:23:59:896 :   </span><br><span class="line">2020-09-27 19:23:59:899 :     ** BUILD FAILED **</span><br><span class="line">2020-09-27 19:23:59:899 : </span><br><span class="line">2020-09-27 19:23:59:899 :     The following build commands failed:</span><br><span class="line">2020-09-27 19:23:59:899 :     	CodeSign /Users/buildmachine/Documents/BuildWorkspace/workspace/PackageClient/Client/Binaries/IOS/Payload/FGame.app</span><br><span class="line">2020-09-27 19:23:59:900 :     (1 failure)</span><br><span class="line">2020-09-27 19:23:59:915 :   Took 15.181822s to run env, ExitCode=65</span><br><span class="line">2020-09-27 19:23:59:920 :   ERROR: CodeSign Failed</span><br><span class="line">2020-09-27 19:23:59:920 :          (see /Users/buildmachine/Library/Logs/Unreal Engine/LocalBuildLogs/BuildCookRun/Log.txt <span class="keyword">for</span> full exception trace)</span><br><span class="line">2020-09-27 19:23:59:922 :   AutomationTool exiting with ExitCode=32 (Error_FailedToCodeSign)</span><br><span class="line">2020-09-27 19:23:59:962 : Took 568.832115s to run mono, ExitCode=32</span><br><span class="line">2020-09-27 19:23:59:974 : AutomationTool exiting with ExitCode=1 (Error_Unknown)</span><br><span class="line">2020-09-27 19:24:00:010 : RunUAT ERROR: AutomationTool was unable to run successfully.</span><br></pre></td></tr></table></figure>
<p>可以看到是执行 codesign 的时候遇到了错误导致打包失败的。</p>
<p>这是因为打包时会访问钥匙串，需要输入密码授权，如果弹窗之后没有授权就会导致 codesign 执行失败。Stack overflow 上有相同的问题：<a href="https://stackoverflow.com/questions/24023639/xcode-command-usr-bin-codesign-failed-with-exit-code-1-errsecinternalcomponen">Xcode Command /usr/bin/codesign failed with exit code 1 : errSecInternalComponent</a></p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20200927204452.webp"></p>
<p>解决方案有三种：</p>
<ol>
<li>在打包时的弹窗中输入密码解锁钥匙串</li>
<li>在打包之前的解锁钥匙串</li>
<li>在弹窗中输入密码后选择始终允许 codesign 访问钥匙串</li>
</ol>
<p>解锁钥匙串使用以下终端命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ security unlock-keychain login.keychain</span><br></pre></td></tr></table></figure>

<h3 id="No-certificate-for-team-xxxx-matching"><a href="#No-certificate-for-team-xxxx-matching" class="headerlink" title="No certificate for team xxxx matching"></a>No certificate for team xxxx matching</h3><p>如果有以下错误提示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Code Signing Error: No certificate for team &#x27;9TV4ZYSS4J&#x27; matching &#x27;iPhone Developer: Created via API (JDPXHYVWYZ)&#x27; found: Select a different signing certificate for CODE_SIGN_IDENTITY, a team that matches your selected certificate, or switch to autom atic provisioning.</span><br></pre></td></tr></table></figure>
<p>解决办法：</p>
<ol>
<li>在 Mac 上的 <code>~/Library/MobileDevice/Provisioning\ Profiles</code> 清理掉多余的 mobileprovision 文件。</li>
<li>在 Mac 钥匙串中清理掉过期的开发者证书</li>
<li>重新导入 mobileprovision 与证书</li>
</ol>
<p>注意：导入的 mobileprovision 的文件命名要与在 <code>BaseEngine.ini</code> 中指定的 <code>MobileProvision</code> 相同。</p>
<h3 id="errSecInternalComponent 错误"><a href="#errSecInternalComponent 错误" class="headerlink" title="errSecInternalComponent 错误"></a>errSecInternalComponent 错误</h3><ul>
<li><a href="https://stackoverflow.com/questions/24023639/xcode-command-usr-bin-codesign-failed-with-exit-code-1-errsecinternalcomponen">Xcode Command /usr/bin/codesign failed with exit code 1 : errSecInternalComponent</a></li>
<li><a href="https://www.jianshu.com/p/b03e59560d31">iOS 远程自动打包问题</a></li>
<li><a href="https://medium.com/@ceyhunkeklik/how-to-fix-ios-application-code-signing-error-4818bd331327">How to Fix iOS Application Code Signing Error?</a></li>
</ul>
<p>是因为通过 ssh 去调用 <code>/usr/bin/codesign</code> 访问钥匙串没有权限，可以使用以下命令在 ssh 中执行解锁：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">security unlock-keychain -p password login.keychain</span><br></pre></td></tr></table></figure>
<p>在 UE 远程构建时，可以先执行这条命令在当前的 ssh 环境下解锁 keychain，使后面的签名可以正常执行。<br>修改 UE 中的 <code>Engine\Build\BatchFiles\Mac\Build.sh</code> 文件，在调用 UBT 编译之前，写入以下内容：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="string">&quot;`dirname &quot;</span><span class="variable">$0</span><span class="string">&quot;`/../../../..&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Setup Mono</span></span><br><span class="line"><span class="built_in">source</span> Engine/Build/BatchFiles/Mac/SetupMono.sh Engine/Build/BatchFiles/Mac</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [<span class="string">&quot;<span class="variable">$4</span>&quot;</span> == <span class="string">&quot;-buildscw&quot;</span> ] || [<span class="string">&quot;<span class="variable">$5</span>&quot;</span> == <span class="string">&quot;-buildscw&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> Building ShaderCompileWorker...</span><br><span class="line">  mono Engine/Binaries/DotNET/UnrealBuildTool.exe ShaderCompileWorker Mac Development</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> unlock mac keychain...</span><br><span class="line">security unlock-keychain -p password login.keychain</span><br><span class="line"><span class="built_in">echo</span> Running <span class="built_in">command</span> : Engine/Binaries/DotNET/UnrealBuildTool.exe <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line">mono Engine/Binaries/DotNET/UnrealBuildTool.exe <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line"></span><br><span class="line">ExitCode=$?</span><br><span class="line"><span class="keyword">if</span> [<span class="variable">$ExitCode</span> -eq 254 ] || [<span class="variable">$ExitCode</span> -eq 255 ] || [<span class="variable">$ExitCode</span> -eq 2 ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">exit</span> <span class="variable">$ExitCode</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>因为编译时会把 Build.sh 通过 RSync 传递到 Mac 上，所以可以看到以下 log:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[Remote] Executing build</span><br><span class="line">  Running bundled mono, ue_version: Mono JIT compiler version 5.16.0.220 (2018-06/bb3ae37d71a Fri Nov 16 17:12:11 EST 2018)</span><br><span class="line">  unlock mac keychain...</span><br><span class="line">  Running command : Engine/Binaries/DotNET/UnrealBuildTool.exe UnrealHeaderTool Mac Development -SkipRulesCompile -XmlConfigCache=/Users/buildmachine/UE4/Builds/lipengzha-PC2/C/BuildAgent/workspace/FGameEngine/Engine/Engine/Intermediate/Build/XmlConfigCache.bin -precompile -allmodules -Log=/Users/buildmachine/UE4/Builds/lipengzha-PC2/C/BuildAgent/workspace/FGameEngine/Engine/Engine/Programs/AutomationTool/Saved/Logs/UBT-UnrealHeaderTool-Mac-Development_Remote.txt -Manifest=/Users/buildmachine/UE4/Builds/lipengzha-PC2/C/BuildAgent/workspace/FGameEngine/Engine/Engine/Intermediate/Remote/UnrealHeaderTool/Mac/Development/Manifest.xml</span><br><span class="line">  Target is up to date</span><br><span class="line">  Deploying UnrealHeaderTool Mac Development...</span><br><span class="line">  Deploying now!</span><br><span class="line">  Total execution time: 1.01 seconds</span><br><span class="line">[Remote] Downloading C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Intermediate\Remote\UnrealHeaderTool\Mac\Development\Manifest.xml</span><br><span class="line">[Remote] Downloading build products</span><br><span class="line">  receiving file list ... done</span><br></pre></td></tr></table></figure>
<p>这样每次编译都会解锁 keychain，从而避免 ssh 连接时没有访问 codesign 导致的签名错误。</p>
<blockquote>
<p>注意：也需要排查 BaseEngine.ini 中 <code>SigningCertificate</code> 的值是否被指定。</p>
</blockquote>
<h3 id="Invalid-trust-settings"><a href="#Invalid-trust-settings" class="headerlink" title="Invalid trust settings."></a>Invalid trust settings.</h3><p>如果 Log 中出现以下错误：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Code Signing Error: Invalid trust settings. Restore system default trust settings for certificate &quot;iPhone Developer: Created via API (JDPXHYVWYZ)&quot; in order to sign code with it.</span><br><span class="line">Code Signing Error: Code signing is required for product type &#x27;Application&#x27; in SDK &#x27;iOS 13.6&#x27;</span><br></pre></td></tr></table></figure>
<p>这是因为在 Mac 上的钥匙串中对证书的设置被修改为了 <code> 始终信任 </code>，修改回<code> 使用系统默认 </code> 即可。<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210326121855.webp"></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
        <category>IOS</category>
      </categories>
      <tags>
        <tag>Mobile</tag>
        <tag>IOS</tag>
        <tag>codesign</tag>
      </tags>
  </entry>
  <entry>
    <title>打包 iOS 导出 dSYM</title>
    <url>/wiki/12245/</url>
    <content><![CDATA[<p>像 Bugly 之类的 crash 上报平台都需要上传符号表才能看到具体的堆栈信息，而 iOS 上的符号和调试信息都是在 <code>dSYM</code> 文件中的。<br>UE 提供了 dSYM 的生成选项，在<code>Project Settings</code>-<code>Platforms</code>-<code>iOS</code>-<code>Build</code>：<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-project-settings-ios-gen-dSYM.webp"></p>
<ul>
<li>Generate dSYM file for code debugging and profiling：只开启这个会在 <code>Binaries/IOS</code> 下生成 <code>PROJECT_NAME.dSYM</code> 文件</li>
<li>Generate dSYM bundle for third party crash tools：依赖上面的选项，如果开启会在 <code>Binaries/IOS</code> 下生成 <code>PROJECT_NAME.dSYM.zip</code>，并且不会再生成<code>PROJECT_NAME.dSYM</code> 文件。</li>
</ul>
<p>但是，在使用源码版打包 iOS 项目的时候生成的 <code>dSYM</code> 特别大，超过 2G，而同样的工程用 Luncher 引擎打包就只有 100+M，而且 bugly 之类的上传还有大小限制。</p>
<p>经过对比之后发现，大小的差距主要是在 <code>_DWARF_debug_*</code> 这些上（左侧为 Launcher 版，右侧为 DebugGame 源码版）：<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/IOS/diff-source-and-launch-engine-dSYM.webp"></p>
<p>本来以为是源码版会把所有参与编译的代码都导出到 dSYM 文件中，但是经过翻阅引擎代码发现，其实 TargetRules 中有控制调试信息的选项，就是来控制产生这些 <code>_DWARF_debug_*</code> 的：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// TargetRules.cs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Whether to globally disable debug info generation; see DebugInfoHeuristics.cs for per-config and per-platform options.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CommandLine(<span class="meta-string">&quot;-NoDebugInfo&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">XmlConfigFile(Category = <span class="meta-string">&quot;BuildConfiguration&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">bool</span> bDisableDebugInfo = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Whether to disable debug info generation for generated files. This improves link times for modules that have a lot of generated glue code.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">XmlConfigFile(Category = <span class="meta-string">&quot;BuildConfiguration&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">bool</span> bDisableDebugInfoForGeneratedCode = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Whether to disable debug info on PC in development builds (for faster developer iteration, as link times are extremely fast with debug info disabled).</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">XmlConfigFile(Category = <span class="meta-string">&quot;BuildConfiguration&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">bool</span> bOmitPCDebugInfoInDevelopment = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
<p>在项目的 <code>Target.cs</code> 中控制这些变量即可，如 <code>bDisableDebugInfo=true</code>，在源码版引擎中也不会生很大的<code>_DWARF_debug</code> 文件了（左侧为 Lunch 版引擎，右侧为 DebugGame 源码版控制<code>bDisableDebugInfo=true</code>）：<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/IOS/diff-source-and-launch-engine-disabledebugfile-dSYM.webp"></p>
<p>而且，还发现 UE 在打包 IOS 平台的时候处理有问题，本来以为打 Shipping 生成的 dSYM 会没有调试信息了，但是测试发现还是非常大。</p>
<p>经过分析后发现，在 UE 的构建系统中是通过两个值来控制是否创建调试信息的：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UEBuildPlatforms.cs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create debug info based on the heuristics specified by the user.</span></span><br><span class="line">GlobalCompileEnvironment.bCreateDebugInfo =</span><br><span class="line">				!Target.bDisableDebugInfo &amp;&amp; ShouldCreateDebugInfo(Target);</span><br><span class="line">GlobalLinkEnvironment.bCreateDebugInfo = GlobalCompileEnvironment.bCreateDebugInfo;</span><br></pre></td></tr></table></figure>
<p>可以看到是通过 <code>Target.bDisableDebugInfo</code> 和<code>ShouldCreateDebugInfo(Target)</code>两个值来控制的，而 <code>ShouldCreateDebugInfo</code> 函数则是每个平台的有自己的重写实现。</p>
<p>如在 Windows 上：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTool/Platform/Windows/UEBuildWindows.cs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Whether this platform should create debug information or not</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Target&quot;&gt;</span>The target being built<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>bool    true if debug info should be generated, false if not<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">ShouldCreateDebugInfo</span>(<span class="params">ReadOnlyTargetRules Target</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (Target.Configuration)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.Development:</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.Shipping:</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.Test:</span><br><span class="line">        <span class="keyword">return</span> !Target.bOmitPCDebugInfoInDevelopment;</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.DebugGame:</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.Debug:</span><br><span class="line">        <span class="literal">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是，在 IOS 和 Mac 上完全没有判断！</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTool/Platform/IOS/UEBuildIOS.cs</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">ShouldCreateDebugInfo</span>(<span class="params">ReadOnlyTargetRules Target</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这导致只能自己用 <code>bDisableDebugInfo=true</code> 来控制，太坑爹了。翻了代码才发现 <code>bOmitPCDebugInfoInDevelopment</code> 这个选项只在 PC 上有效：<a href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Documentation/Source/Programming/UnrealBuildSystem/Configuration/BuildConfigProperties/BuildConfigProperties.INT.udn#L85">BuildConfigProperties.INT.udn#L85</a>。</p>
<h4 id="坑点"><a href="# 坑点" class="headerlink" title="坑点"></a>坑点 </h4><p> 根据上面的介绍，可以通过控制 <code>bDisableDebugInfo=true</code> 来生成体积较小的 <code>dSYM</code>，但这样有牵扯出来一个坑的问题：使用远程构建时<code>dSYM</code> 无法通过 UE 的构建系统传回本地。<br>查了下代码，没有什么比较方便的办法来控制从远程拷贝的文件，目前我使用 <code>pscp</code> 从远程拉取 dSYM 文件回本地。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
        <category>IOS</category>
      </categories>
      <tags>
        <tag>Mobile</tag>
        <tag>IOS</tag>
        <tag>dSYM</tag>
      </tags>
  </entry>
  <entry>
    <title>测试 iOS 包的常见问题</title>
    <url>/wiki/28decf0e/</url>
    <content><![CDATA[<h3 id="iOS-UE4App 的数据目录"><a href="#iOS-UE4App 的数据目录" class="headerlink" title="iOS UE4App 的数据目录"></a>iOS UE4App 的数据目录 </h3><p> 访问 iOS 程序的文稿目录需要 App 开启文件共享 (File Sharing)，需要在 UE 的<code>Project Settings</code>-<code>Platform</code>-<code>IOS</code>-<code>File System</code> 里开启：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/1948/ue4-ios-support-file-sharing.webp"></p>
<p>这样打包之后才可以访问应用程序的文稿目录。</p>
<p>可以使用 <a href="https://imazing.com/zh">iMaZing</a> 这个工具来访问 ios App 的文稿目录，可以创建文件夹、拷贝文件等等，还是比较方便的。</p>
<p>UE 在 Win 和 Android 平台都有这样的目录结构：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+---Engine</span><br><span class="line">|   +---Content</span><br><span class="line">\---FGame</span><br><span class="line">    +---Content</span><br><span class="line">    |   +---Movies</span><br><span class="line">    |   \---Paks</span><br><span class="line">    \---Saved</span><br><span class="line">        +---Logs</span><br><span class="line">        \---Paks</span><br></pre></td></tr></table></figure>

<p>在 Win 上是相对于打包目录，在 Android 上默认是 <code>&lt;Sdcard&gt;/UE4Game/PROJECT_NAME/</code> 的。</p>
<p>而在 iOS 上这个结构是相对于 App 的文稿目录的（这几个文件夹都是我手动创建的，Shipping 时也没有 log）：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/1948/ue4-assess-ios-app-document-folder.webp"></p>
<p>如果想要 mount pak 就按照这个目录结构把 pak 放到相关目录即可，在程序中就可以通过 <code>FPaths</code> 的 API 来访问了。</p>
<h3 id="在 Windows 上查看 iOS 设备 log"><a href="# 在 Windows 上查看 iOS 设备 log" class="headerlink" title="在 Windows 上查看 iOS 设备 log"></a>在 Windows 上查看 iOS 设备 log</h3><p>Andorid 的设备可以使用 <code>adb logcat</code> 来捕获 log，在想要看 iOS 的 log 却十分麻烦，还要 Mac。</p>
<p>但是经过一番查找，找到了一个工具，可以在 Windows 上实时地查看当前设备 log：<a href="https://www.blackberry.com/blackberrytraining/web/KB_Resources/KB36986_iOSLogInfo_4.3.4.zip">IOSLogInfo</a></p>
<p>下载之后解压，执行 <code>sdsiosloginfo.exe</code> 就可以看到类似 <code>logcat</code> 的日志输出了，如果装了 <code>Git bash</code> 环境也可以使用 <code>|</code> 来进行过滤。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/1948/iOSLogInfo-for-windows.webp"></p>
<h3 id="UE 项目在 MAC 上的 Log 位置"><a href="#UE 项目在 MAC 上的 Log 位置" class="headerlink" title="UE 项目在 MAC 上的 Log 位置"></a>UE 项目在 MAC 上的 Log 位置</h3><blockquote>
<p>MacOS 上打开 UE 项目的 Log 位置为<code>~/Library/Logs/Unreal Engine/ProjectName</code>，<a href="https://wiki.unrealengine.com/Locating_Project_Logs">Locating Project Logs</a></p>
</blockquote>
<h3 id="相关链接"><a href="# 相关链接" class="headerlink" title="相关链接"></a>相关链接</h3><ul>
<li><a href="https://wiki.unrealengine.com/Mobile_Development_Troubleshooting_Guide">UE4 移动设备开发指南</a></li>
<li><a href="https://docs.unrealengine.com/en-US/Platforms/Mobile/iOS/Windows/index.html">Building for iOS on Windows</a></li>
<li>ios 上类似 logcat 的工具<a href="https://lemonjar.com/iosconsole/">iOS Console</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
        <category>IOS</category>
      </categories>
      <tags>
        <tag>Mobile</tag>
        <tag>IOS</tag>
      </tags>
  </entry>
  <entry>
    <title>源码版与安装版 IOS 数据路径差异</title>
    <url>/wiki/36383/</url>
    <content><![CDATA[<p>使用安装版引擎打包 IOS 时，开启 FileSharing 能够在通过工具访问程序的 <code>Document</code> 目录，里面类似 Android 的 UE4Game 目录结构。<br>但是当使用源码版引擎打包时，开启 FileSharing 的包，UE 的数据目录并不在 <code>Document</code> 目录下，因为项目配置没有任何更改，怀疑是引擎中有些地方对源码版或安装版做了检测。<br>搜索代码发现，引擎中通过 <code>FILESHARING_ENABLED</code> 宏进行检测，当开启时，数据目录位于 <code>Library</code> 目录下，没有开启时则位于 <code>Document</code> 目录下。</p>
<figure class="highlight cpp"><figcaption><span>Core/Private/IOS/IOSPlatformMisc.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FIOSPlatformMisc::PlatformInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> FILESHARING_ENABLED</span></span><br><span class="line">  FString DownloadPath = <span class="built_in">FString</span>([<span class="built_in">NSSearchPathForDirectoriesInDomains</span>(NSLibraryDirectory, NSUserDomainMask, YES) objectAtIndex:<span class="number">0</span>]) + <span class="built_in">TEXT</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  FString DownloadPath = <span class="built_in">FString</span>([<span class="built_in">NSSearchPathForDirectoriesInDomains</span>(NSDocumentDirectory, NSUserDomainMask, YES) objectAtIndex:<span class="number">0</span>]) + <span class="built_in">TEXT</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个宏由 UBT 生成，通过读取 <code>DefaultEngine.ini</code> 中<code>[/Script/IOSRuntimeSettings.IOSRuntimeSettings]</code>下的 <code>bSupportsITunesFileSharing</code> 来确定宏的值。</p>
<figure class="highlight csharp"><figcaption><span>Source/Programs/UnrealBuildTool/Platform/IOS/UEBuildIOS.cs</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Stores project-specific IOS settings. Instances of this object are cached by IOSPlatform.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">IOSProjectSettings</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> true if iTunes file sharing support is enabled</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  [<span class="meta">ConfigFile(ConfigHierarchyType.Engine, <span class="meta-string">&quot;/Script/IOSRuntimeSettings.IOSRuntimeSettings&quot;</span>, <span class="meta-string">&quot;bSupportsITunesFileSharing&quot;</span>)</span>]</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">readonly</span> <span class="built_in">bool</span> bFileSharingEnabled = <span class="literal">false</span>;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>添加宏的代码如下：</p>
<figure class="highlight csharp"><figcaption><span>Source/Programs/UnrealBuildTool/Platform/IOS/UEBuildIOS.cs</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Setup the target environment for building</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Target&quot;&gt;</span>Settings for the target being compiled<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;CompileEnvironment&quot;&gt;</span>The compile environment for this target<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;LinkEnvironment&quot;&gt;</span>The link environment for this target<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetUpEnvironment</span>(<span class="params">ReadOnlyTargetRules Target, CppCompileEnvironment CompileEnvironment, LinkEnvironment LinkEnvironment</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span> (ProjectSettings.bFileSharingEnabled)</span><br><span class="line">  &#123;</span><br><span class="line">    CompileEnvironment.Definitions.Add(<span class="string">&quot;FILESHARING_ENABLED=1&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    CompileEnvironment.Definitions.Add(<span class="string">&quot;FILESHARING_ENABLED=0&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原因分析：</p>
<ol>
<li>因为编译安装版引擎时，没有项目，引擎中 <code>BaseEngine.ini</code> 中<code>bSupportsITunesFileSharing=False</code>，所以通过 BuildGraph 编译安装版引擎时，<code>bFileSharingEnabled</code>默认值是 false，通过安装版引擎打包项目引擎也不会编译了，所以 <code>bFileSharingEnabled</code> 的值一直是 false，使用的是 NSDocumentDirectory 目录</li>
<li>相同的道理，使用源码版引擎打包项目时，因为需要通过打包项目才编译引擎，如果项目中指定了 <code>bSupportsITunesFileSharing=True</code>，则编译引擎时<code>bFileSharingEnabled</code> 就为 true，导致 <code>FILESHARING_ENABLED=1</code>，则使用了<code>NSLibraryDirectory</code> 目录。</li>
</ol>
<p>需要注意的是：<code>bSupportsITunesFileSharing</code>不仅仅只是控制数据存储路径，还控制打包时 plist 的生成：</p>
<figure class="highlight csharp"><figcaption><span>Programs/UnrealBuildTool/Platform/IOS/UEDeployIOS.cs</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">GenerateIOSPList</span>(<span class="params">FileReference ProjectFile, UnrealTargetConfiguration Config, <span class="built_in">string</span> ProjectDirectory, <span class="built_in">bool</span> bIsUE4Game, <span class="built_in">string</span> GameName, <span class="built_in">bool</span> bIsClient, <span class="built_in">string</span> ProjectName, <span class="built_in">string</span> InEngineDir, <span class="built_in">string</span> AppDirectory, VersionNumber SdkVersion, UnrealPluginLanguage UPL, <span class="built_in">string</span> BundleID, <span class="built_in">bool</span> bBuildAsFramework, <span class="keyword">out</span> <span class="built_in">bool</span> bSupportsPortrait, <span class="keyword">out</span> <span class="built_in">bool</span> bSupportsLandscape, <span class="keyword">out</span> <span class="built_in">bool</span> bSkipIcons</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ITunes file sharing</span></span><br><span class="line">  <span class="built_in">bool</span> bSupportsITunesFileSharing = <span class="literal">false</span>;</span><br><span class="line">  Ini.GetBool(<span class="string">&quot;/Script/IOSRuntimeSettings.IOSRuntimeSettings&quot;</span>, <span class="string">&quot;bSupportsITunesFileSharing&quot;</span>, <span class="keyword">out</span> bSupportsITunesFileSharing);</span><br><span class="line">  <span class="built_in">bool</span> bSupportsFilesApp = <span class="literal">false</span>;</span><br><span class="line">  Ini.GetBool(<span class="string">&quot;/Script/IOSRuntimeSettings.IOSRuntimeSettings&quot;</span>, <span class="string">&quot;bSupportsFilesApp&quot;</span>, <span class="keyword">out</span> bSupportsFilesApp);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  Text.AppendLine(<span class="string">&quot;\t&lt;key&gt;UIFileSharingEnabled&lt;/key&gt;&quot;</span>);</span><br><span class="line">  Text.AppendLine(<span class="built_in">string</span>.Format(<span class="string">&quot;\t&lt;&#123;0&#125;/&gt;&quot;</span>, bSupportsITunesFileSharing ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>));</span><br><span class="line">  <span class="keyword">if</span> (bSupportsFilesApp)</span><br><span class="line">  &#123;</span><br><span class="line">    Text.AppendLine(<span class="string">&quot;\t&lt;key&gt;LSSupportsOpeningDocumentsInPlace&lt;/key&gt;&quot;</span>);</span><br><span class="line">    Text.AppendLine(<span class="string">&quot;\t&lt;true/&gt;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以，为了同时支持数据存储在 <code>Document</code> 下和开启 plist 中的<code>UIFileSharingEnabled</code>，对于 FileSharing 功能的支持需要进行以下操作：</p>
<ol>
<li><code>DefaultEngine.ini</code>中的<code>bSupportsITunesFileSharing=False</code></li>
<li>修改引擎中生成 <code>FILESHARING_ENABLED</code> 宏的代码，保持为 false 即可</li>
</ol>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
        <category>IOS</category>
      </categories>
      <tags>
        <tag>Mobile</tag>
        <tag>IOS</tag>
      </tags>
  </entry>
  <entry>
    <title>部署 Windows 远程构建 iOS</title>
    <url>/wiki/df679169/</url>
    <content><![CDATA[<p>UE 可以在 Windows 可以直接出 Android 和 Win 的包（Android 需要配置 JDK/SDK/NDK/Gradle 等环境）。打包 iOS 则需要一台 Mac，如果是每次打包 iOS 都要在 Mac 上进行操作，其实就是与 Win 上完全相同的操作，但是流程上不能复用就显得很繁琐，尤其是在修改了引擎的情况下，需要先更新引擎代码并编译，然后再更新项目、执行打包。好在 UE 提供了远程构建 iOS，可以把 Win/Android/iOS 三端的包在相同的构建流程里出完。</p>
<p>前置需求：</p>
<ol>
<li>内网搭载 MacOS 的电脑一台（白黑都可）</li>
<li>申请 p12 证书和 mobileprovision</li>
<li>PC 和 Mac 需要在网络内可以相互访问（在相同网段）</li>
</ol>
<h3 id="IOS 证书申请"><a href="#IOS 证书申请" class="headerlink" title="IOS 证书申请"></a>IOS 证书申请 </h3><p> 打包 iOS 之前需要申请 iOS 的开发者账号来创建证书，可以在 <a href="https://developer.apple.com/">developer.apple.com</a> 申请。需要得到 p12 证书和 mobileprovision，然后在 UE 的项目设置中导入它们。需要注意创建的证书是 <code>Developer</code> 还是 <code>Distribution</code> 证书，在出包的时候要匹配，否则会打包失败。</p>
<p>申请证书的流程网上有很多文章，我这里是简单记录了下我申请证书的流程，步骤不是最详细的，仅供参考。</p>
<p>首先在 Mac 上导出一个证书：<br>打开软件 <code> 钥匙串访问 </code>-<code> 证书助理 </code>-<code> 从证书颁发机构请求证书 </code>：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/1948/AppleDev/mac-os-export-ca.webp"><br> 选择存储到磁盘，会生成一个 <code>CertificateSigningRequest.certSigningRequest</code> 的文件。<br>然后登录<a href="https://developer.apple.com/">Apple Developer</a>，进入<code>Account</code>-<code>Certificates</code>：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/1948/AppleDev/apple-developer-certification-ids-profiles.webp"></p>
<p>进去之后创建 <code>Apple Development</code> 或者 <code>iOS App Development</code>，创建过程中需要把上面生成的<code>CertificateSigningRequest.certSigningRequest</code> 文件上传。</p>
<p>添加设备：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/1948/AppleDev/apple-developer-add-device.webp"></p>
<p>可以使用 UE 的 <code>IPhonePackager.exe</code> 来查看 ios 设备的 uuid：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/1948/AppleDev/ue-iphonepackagetool-device-uuid.webp"></p>
<p>生成 Provision：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/1948/AppleDev/apple-developer-generated-provisioning-profile.webp"></p>
<p>生成之后要下载 <code>provision</code> 文件：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/1948/AppleDev/apple-developer-download-provisioning-profile.webp"></p>
<h3 id="配置远程构建"><a href="# 配置远程构建" class="headerlink" title="配置远程构建"></a>配置远程构建 </h3><p>UE 打包 iOS 需要在项目设置中导入证书和<code>provision</code>，以及把<code>BundleName</code> 和<code>Bundle Identifier</code>设置为在 Apple 开发者网站上设置的 Bundle ID，格式为<code>com.xxxxx.yyyyyy</code>。</p>
<p>p12 证书和 mobileprovision 导入之后如图：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/1948/ue4-project-settings-ios-import-mobileprevision-ce.webp"></p>
<p>导入证书之后就可以开始远程打包的配置了。</p>
<p>首先在 MAC 的 <code> 系统偏好设置 </code>-<code> 共享 </code> 中启用远程登录：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/1948/mac-setting-sharing.webp"></p>
<p>然后在 Windows 上对项目添导入 <code>mobileproversion</code> 和设置 <code>BundleName</code> 和<code>Bundle Identifier</code>。<br>之后继续往下拉找到 <code>IOS</code>-<code>Build</code> 下的 <code>Remote Build Options</code>:<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/1948/ue-project-settings-IOS-remote-build.webp"><br> 填入目标 MAC 机器的 IP 地址（如果不指定端口则默认为 22，如果指定端口则使用 <code>xx.xx.xx.xx:2222</code> 这种形式，以冒号分隔）和用户名。</p>
<p>然后点击 <code>Generated SSH Key</code> 会弹出一个窗口：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/1948/ue4-remote-build-generated-sshkey-01.webp"><br>按任意键继续。<br>会提示你输入一个密码，按照提示输入，之后会提示你输入 <code>MAC</code> 电脑的密码，输入之后会提示：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase):</span><br></pre></td></tr></table></figure>
<p>这是让你输入生成的 ssh Key 的密码，默认情况下可以不输，直接 Enter 就好。<br>按照提示一直 <code>Enter</code> 会提示你 ssh key 生成成功：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/1948/ue4-remote-build-generated-sshkey-02.webp"><br>再继续会提示让你输入第一次设置的密码，和目标 MAC 机器的密码，执行完毕之后就会提示没有错误，就 ok 了：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/1948/ue4-remote-build-generated-sshkey-03.webp"></p>
<p>生成的 SSH Key 的存放路径为：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">C:\Users\imzlp\AppData\Roaming/Unreal Engine/UnrealBuildTool/SSHKeys/192.168.2.89/imzlp/RemoteToolChainPrivate.key</span><br></pre></td></tr></table></figure>

<p>如果要将其共享给组内的其他成员，则把这个 <code>RemoteToolChainPrivate.key</code> 共享，然后让他们把 <code>IOS</code>-<code>Build</code>-<code>RemoteBuildOptions</code> 下的 <code>Override existing SSH Permissions file</code> 设置为 <code>RemoteToolChainPrivate.key</code> 的路径即可。</p>
<p>之后就可以像打包 Windows 或者在 Win 上打包 IOS 一样了：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/1948/ue4-package-ios-in-windows.webp"></p>
<p>远程到 Mac 打包分了几个阶段：</p>
<ol>
<li>把本机的引擎和工程代码上传至 Mac</li>
<li>在 Mac 上执行编译</li>
<li>编译完毕之后在 Mac 上生成 ipa 包（但不包含 Cook 资源）</li>
<li>把生成的 ipa 包拉回本地，解包，Cook 美术资源，再合并为 ipa</li>
</ol>
<p>其中第一步，把本机引擎和工程的代码上传至 Mac 是通过 rsync 来实现的，引擎中的 <code>Engine\Build\Rsync</code> 目录下包含了远程构建时需要上传至目标机器的过滤器。<br>对于项目，可以在工程目录的 <code>&lt;ProjectDir&gt;/Build/Rsync/RsyncProject.txt</code> 创建该文件，添加自己想要上传至 Mac 的文件过滤器，可以解决执行远程打包时有些文件被遗漏掉的问题。<br>UE 上传时默认使用的 RsyncProject.txt 过滤器有引擎和项目目录的，具体的代码看：<a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Programs/UnrealBuildTool/ToolChain/RemoteMac.cs#L927">UnrealBuildTool/ToolChain/RemoteMac.cs#L927</a></p>
<ul>
<li><a href="https://docs.unrealengine.com/en-US/Platforms/Mobile/iOS/Windows/index.html">Building for iOS on Windows</a></li>
<li><a href="https://www.audiokinetic.com/zh/library/edge/?source=UE4&id=using_faq.html">WWise 常见问题解答</a></li>
</ul>
<h3 id="iOS 打包证书配置报错问题"><a href="#iOS 打包证书配置报错问题" class="headerlink" title="iOS 打包证书配置报错问题"></a>iOS 打包证书配置报错问题 </h3><p> 在 UE 的项目设置中添加 <code>Provision</code> 和<code>Certificate</code>，<code>Bundle Identifier</code>要和证书能对应上，但是在设置完之后选择打包还是会提示以下错误：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Provision not found. A provision is required for deploying your app to the device.  </span><br><span class="line">Signing key not found. The app could not be digitally signed, because the signing key is not configured.  </span><br></pre></td></tr></table></figure>
<p>配置完证书和 <code>Provision</code> 之后出现这种情况需要检查下证书是 <strong> 开发 (Development)<strong> 还是 </strong> 发行 (Distribution)<strong>，默认情况下项目设置中是不勾选</strong> 发行 (Distribution)<strong> 的，如果导入的证书是发行证书则 </strong> 只能打包 Shipping</strong>并且 ** 需要勾上发行(Distribution)**。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/1948/ue4-package-project-for-distribution.webp"></p>
<p>如果使用发行证书不勾选 ** 发行(For Distribution)** 则打包时会有以下错误：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Check dependencies</span><br><span class="line">Code Signing Error: Provisioning profile &quot;com.tencent.tmgp.zyhx_Production_SignProvision&quot; doesn&#x27;t match the entitlements file&#x27;s value for the get-task-allow entitlement.</span><br><span class="line">Code Signing Error: Code signing is required for product type &#x27;Application&#x27; in SDK &#x27;iOS 13.6&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="SSHKey 路径查找的 bug"><a href="#SSHKey 路径查找的 bug" class="headerlink" title="SSHKey 路径查找的 bug"></a>SSHKey 路径查找的 bug</h3><p>前面提到了在 <code>Project Settings</code>-<code>Platforms</code>-<code>iOS</code> 中可以在 <code>Override Existing SSH Permissions file</code> 中指定 SSHKey，如果不指定会默认使用引擎查找路径，默认情况下会从以下路径中查找：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> FString DefaultKeyFilename = <span class="built_in">TEXT</span>(<span class="string">&quot;RemoteToolChainPrivate.key&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> FString RelativeFilePathLocation = FPaths::<span class="built_in">Combine</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;SSHKeys&quot;</span>), *RemoteServerName, *RSyncUsername, *DefaultKeyFilename);</span><br><span class="line">TArray&lt;FString&gt; PossibleKeyLocations;</span><br><span class="line">PossibleKeyLocations.<span class="built_in">Add</span>(FPaths::<span class="built_in">Combine</span>(*FPaths::<span class="built_in">ProjectDir</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;Build&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;NotForLicensees&quot;</span>), *RelativeFilePathLocation));</span><br><span class="line">PossibleKeyLocations.<span class="built_in">Add</span>(FPaths::<span class="built_in">Combine</span>(*FPaths::<span class="built_in">ProjectDir</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;Build&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;NoRedist&quot;</span>), *RelativeFilePathLocation));</span><br><span class="line">PossibleKeyLocations.<span class="built_in">Add</span>(FPaths::<span class="built_in">Combine</span>(*FPaths::<span class="built_in">ProjectDir</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;Build&quot;</span>), *RelativeFilePathLocation));</span><br><span class="line">PossibleKeyLocations.<span class="built_in">Add</span>(FPaths::<span class="built_in">Combine</span>(*FPaths::<span class="built_in">EngineDir</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;Build&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;NotForLicensees&quot;</span>), *RelativeFilePathLocation));</span><br><span class="line">PossibleKeyLocations.<span class="built_in">Add</span>(FPaths::<span class="built_in">Combine</span>(*FPaths::<span class="built_in">EngineDir</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;Build&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;NoRedist&quot;</span>), *RelativeFilePathLocation));</span><br><span class="line">PossibleKeyLocations.<span class="built_in">Add</span>(FPaths::<span class="built_in">Combine</span>(*FPaths::<span class="built_in">EngineDir</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;Build&quot;</span>), *RelativeFilePathLocation));</span><br><span class="line">PossibleKeyLocations.<span class="built_in">Add</span>(FPaths::<span class="built_in">Combine</span>(*Path, <span class="built_in">TEXT</span>(<span class="string">&quot;Unreal Engine&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;UnrealBuildTool&quot;</span>), *RelativeFilePathLocation));</span><br></pre></td></tr></table></figure>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/1948/ue4-project--ios-found-existing-ssh.webp"></p>
<p>但是在 RemoveServerName 包含端口的情况下，希望使用引擎查找路径时，UE 的实现有 Bug。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UIOSRuntimeSettings::PostInitProperties</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Super::<span class="built_in">PostInitProperties</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// We can have a look for potential keys</span></span><br><span class="line">	<span class="keyword">if</span> (!RemoteServerName.<span class="built_in">IsEmpty</span>() &amp;&amp; !RSyncUsername.<span class="built_in">IsEmpty</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		SSHPrivateKeyLocation = <span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">const</span> FString DefaultKeyFilename = <span class="built_in">TEXT</span>(<span class="string">&quot;RemoteToolChainPrivate.key&quot;</span>);</span><br><span class="line">		<span class="keyword">const</span> FString RelativeFilePathLocation = FPaths::<span class="built_in">Combine</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;SSHKeys&quot;</span>), *RemoteServerName, *RSyncUsername, *DefaultKeyFilename);</span><br><span class="line"></span><br><span class="line">		FString Path = FPlatformMisc::<span class="built_in">GetEnvironmentVariable</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;APPDATA&quot;</span>));</span><br><span class="line"></span><br><span class="line">		TArray&lt;FString&gt; PossibleKeyLocations;</span><br><span class="line">		PossibleKeyLocations.<span class="built_in">Add</span>(FPaths::<span class="built_in">Combine</span>(*FPaths::<span class="built_in">ProjectDir</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;Build&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;NotForLicensees&quot;</span>), *RelativeFilePathLocation));</span><br><span class="line">		PossibleKeyLocations.<span class="built_in">Add</span>(FPaths::<span class="built_in">Combine</span>(*FPaths::<span class="built_in">ProjectDir</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;Build&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;NoRedist&quot;</span>), *RelativeFilePathLocation));</span><br><span class="line">		PossibleKeyLocations.<span class="built_in">Add</span>(FPaths::<span class="built_in">Combine</span>(*FPaths::<span class="built_in">ProjectDir</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;Build&quot;</span>), *RelativeFilePathLocation));</span><br><span class="line">		PossibleKeyLocations.<span class="built_in">Add</span>(FPaths::<span class="built_in">Combine</span>(*FPaths::<span class="built_in">EngineDir</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;Build&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;NotForLicensees&quot;</span>), *RelativeFilePathLocation));</span><br><span class="line">		PossibleKeyLocations.<span class="built_in">Add</span>(FPaths::<span class="built_in">Combine</span>(*FPaths::<span class="built_in">EngineDir</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;Build&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;NoRedist&quot;</span>), *RelativeFilePathLocation));</span><br><span class="line">		PossibleKeyLocations.<span class="built_in">Add</span>(FPaths::<span class="built_in">Combine</span>(*FPaths::<span class="built_in">EngineDir</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;Build&quot;</span>), *RelativeFilePathLocation));</span><br><span class="line">		PossibleKeyLocations.<span class="built_in">Add</span>(FPaths::<span class="built_in">Combine</span>(*Path, <span class="built_in">TEXT</span>(<span class="string">&quot;Unreal Engine&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;UnrealBuildTool&quot;</span>), *RelativeFilePathLocation));</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Find a potential path that we will use if the user hasn&#x27;t overridden.</span></span><br><span class="line">		<span class="comment">// For information purposes only</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">const</span> FString&amp; NextLocation : PossibleKeyLocations)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (IFileManager::<span class="built_in">Get</span>().<span class="built_in">FileSize</span>(*NextLocation) &gt; <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				SSHPrivateKeyLocation = NextLocation;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个代码在 Windows 上有 bug，因为当 <code>RemoteServerName</code> 具有指定端口时，在 Windows 上就会找不到 SSHKey，因为 Windows 上路径中不能包含冒号，所以在查找 Key 路径的时候会有问题，这个问题需要修改引擎才能解决。<br>修改上面的代码：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">SSHPrivateKeyLocation = <span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">FString RealRemoteServerName = RemoteServerName;</span><br><span class="line"><span class="keyword">if</span>(RemoteServerName.<span class="built_in">Contains</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;:&quot;</span>)))</span><br><span class="line">&#123;</span><br><span class="line">    FString RemoteServerPort;</span><br><span class="line">    RemoteServerName.<span class="built_in">Split</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;:&quot;</span>),&amp;RealRemoteServerName,&amp;RemoteServerPort);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> FString DefaultKeyFilename = <span class="built_in">TEXT</span>(<span class="string">&quot;RemoteToolChainPrivate.key&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> FString RelativeFilePathLocation = FPaths::<span class="built_in">Combine</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;SSHKeys&quot;</span>), *RealRemoteServerName, *RSyncUsername, *DefaultKeyFilename);</span><br></pre></td></tr></table></figure>
<p>重新编译引擎即可。</p>
<h3 id="远程编译 Shader 的 Key 查找 bug"><a href="# 远程编译 Shader 的 Key 查找 bug" class="headerlink" title="远程编译 Shader 的 Key 查找 bug"></a>远程编译 Shader 的 Key 查找 bug</h3><blockquote>
<p>注意：在 4.26 及之后的引擎版本支持在 Windows 上编译 metal 的 Shader 了，详情见文档：<a href="https://dq8iqaixvew1d.cloudfront.net/en-US/SharingAndReleasing/Mobile/iOS/WindowsMetalShader/index.html">Using the Windows Metal Shader Compiler for iOS</a>。</p>
</blockquote>
<p>在 <code>Project Settings</code>-<code>Platforms</code>-<code>IOS</code> 中开启 <code>Enable Remote Shader Compile</code> 后，如果填入的构建机地址具有指定端口，在查找 SSHkey 时会有问题：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Developer/Apple/MetalShaderFormat/Private/MetalShaderCompiler.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">IsRemoteBuildingConfigured</span><span class="params">(<span class="keyword">const</span> FShaderCompilerEnvironment* InEnvironment)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    GRemoteBuildServerSSHKey = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (InEnvironment != <span class="literal">nullptr</span> &amp;&amp; InEnvironment-&gt;RemoteServerData.<span class="built_in">Contains</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;SSHPrivateKeyOverridePath&quot;</span>)))</span><br><span class="line">    &#123;</span><br><span class="line">        GRemoteBuildServerSSHKey = InEnvironment-&gt;RemoteServerData[<span class="built_in">TEXT</span>(<span class="string">&quot;SSHPrivateKeyOverridePath&quot;</span>)];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (GRemoteBuildServerSSHKey.<span class="built_in">Len</span>() == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        GConfig-&gt;<span class="built_in">GetString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;/Script/IOSRuntimeSettings.IOSRuntimeSettings&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;SSHPrivateKeyOverridePath&quot;</span>), GRemoteBuildServerSSHKey, GEngineIni);</span><br><span class="line"></span><br><span class="line">        GConfig-&gt;<span class="built_in">GetString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;/Script/IOSRuntimeSettings.IOSRuntimeSettings&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;SSHPrivateKeyOverridePath&quot;</span>), GRemoteBuildServerSSHKey, GEngineIni);</span><br><span class="line">        <span class="keyword">if</span> (GRemoteBuildServerSSHKey.<span class="built_in">Len</span>() == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!FParse::<span class="built_in">Value</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;serverkey&quot;</span>), GRemoteBuildServerSSHKey) &amp;&amp; GRemoteBuildServerSSHKey.<span class="built_in">Len</span>() == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (GRemoteBuildServerSSHKey.<span class="built_in">Len</span>() == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// RemoteToolChain.cs in UBT looks in a few more places but the code in FIOSTargetSettingsCustomization::OnGenerateSSHKey() only puts the key in this location so just going with that to keep things simple</span></span><br><span class="line">                    FString Path = FPlatformMisc::<span class="built_in">GetEnvironmentVariable</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;APPDATA&quot;</span>));</span><br><span class="line">                    GRemoteBuildServerSSHKey = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%s\\Unreal Engine\\UnrealBuildTool\\SSHKeys\\%s\\%s\\RemoteToolChainPrivate.key&quot;</span>), *Path, *GRemoteBuildServerHost, *GRemoteBuildServerUser);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...    </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这里查找的 Key 路径时直接通过 <code>GRemoteBuildServerHost</code> 拼接的，但是如果在配置中指定了端口，那么 <code>GRemoteBuildServerHost</code> 的值为这种格式<code>xxx.xx.xx.xx:1234</code>，但是 Win 上目录名不能带<code>:</code>，就会导致 Key 查找失败。</p>
<p>还有在同文件的 <code>ExecRemoteProcess</code> 函数中，没有针对具有指定端口的情况做处理：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ExecRemoteProcess</span><span class="params">(<span class="keyword">const</span> TCHAR* Command, <span class="keyword">const</span> TCHAR* Params, int32* OutReturnCode, FString* OutStdOut, FString* OutStdErr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_MAC &amp;&amp; !UNIXLIKE_TO_MAC_REMOTE_BUILDING</span></span><br><span class="line">	<span class="keyword">return</span> FPlatformProcess::<span class="built_in">ExecProcess</span>(Command, Params, OutReturnCode, OutStdOut, OutStdErr);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="keyword">if</span> (GRemoteBuildServerHost.<span class="built_in">IsEmpty</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	FString CmdLine = <span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;-i \&quot;&quot;</span>)) + GRemoteBuildServerSSHKey + <span class="built_in">TEXT</span>(<span class="string">&quot;\&quot; \&quot;&quot;</span>) + GRemoteBuildServerUser + <span class="string">&#x27;@&#x27;</span> + GRemoteBuildServerHost + <span class="built_in">TEXT</span>(<span class="string">&quot;\&quot; &quot;</span>) + Command + <span class="built_in">TEXT</span>(<span class="string">&quot; &quot;</span>) + (Params != <span class="literal">nullptr</span> ? Params : <span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>));</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">ExecProcess</span>(*GSSHPath, *CmdLine, OutReturnCode, OutStdOut, OutStdErr);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要做一些处理：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ExecRemoteProcess</span><span class="params">(<span class="keyword">const</span> TCHAR* Command, <span class="keyword">const</span> TCHAR* Params, int32* OutReturnCode, FString* OutStdOut, FString* OutStdErr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_MAC &amp;&amp; !UNIXLIKE_TO_MAC_REMOTE_BUILDING</span></span><br><span class="line">	<span class="keyword">return</span> FPlatformProcess::<span class="built_in">ExecProcess</span>(Command, Params, OutReturnCode, OutStdOut, OutStdErr);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="keyword">if</span> (GRemoteBuildServerHost.<span class="built_in">IsEmpty</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FString RemoteBuildServerIP = GRemoteBuildServerHost;</span><br><span class="line">	FString RemoteBuildServerPort = <span class="built_in">TEXT</span>(<span class="string">&quot;22&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(GRemoteBuildServerHost.<span class="built_in">Contains</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;:&quot;</span>)))</span><br><span class="line">	&#123;</span><br><span class="line">		GRemoteBuildServerHost.<span class="built_in">Split</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;:&quot;</span>),&amp;RemoteBuildServerIP,&amp;RemoteBuildServerPort);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FString CmdLine = <span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;-i \&quot;&quot;</span>)) + GRemoteBuildServerSSHKey + <span class="built_in">TEXT</span>(<span class="string">&quot;\&quot; \&quot;&quot;</span>) + GRemoteBuildServerUser + <span class="string">&#x27;@&#x27;</span> + RemoteBuildServerIP + <span class="built_in">TEXT</span>(<span class="string">&quot;\&quot; &quot;</span>) <span class="built_in">TEXT</span>(<span class="string">&quot;-p &quot;</span>) + RemoteBuildServerPort +<span class="built_in">TEXT</span>(<span class="string">&quot; &quot;</span>)+ Command + <span class="built_in">TEXT</span>(<span class="string">&quot; &quot;</span>) + (Params != <span class="literal">nullptr</span> ? Params : <span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>));</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">ExecProcess</span>(*GSSHPath, *CmdLine, OutReturnCode, OutStdOut, OutStdErr);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
        <category>IOS</category>
      </categories>
      <tags>
        <tag>Mobile</tag>
        <tag>IOS</tag>
        <tag>远程构建</tag>
        <tag>Mac</tag>
      </tags>
  </entry>
  <entry>
    <title>UPL for Android</title>
    <url>/wiki/d03bb27/</url>
    <content><![CDATA[<p>在 UE 中为移动端添加第三方模块或者修改配置文件时经常会用到 <code>AdditionalPropertiesForReceipt</code>，里面创建<code>ReceiptProperty</code> 传入的 <code>xml</code> 文件就是 UE 的 <code>Unreal Plugin Language</code> 脚本。</p>
<p><code>ReceiptProperty</code>的平台名称在 IOS 和 Android 上是固定的，分别是 <code>IOSPlugin</code> 和<code>AndroidPlugin</code>，不可以指定其他的名字（详见代码 <a href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Programs/UnrealBuildTool/Platform/IOS/UEDeployIOS.cs#L1153">UEDeployIOS.cs#L1153</a> 和<a href="https://github.com/EpicGames/UnrealEngine/blob/1eb5d965b994b4bd59f31ec4158d42f13137ab1f/Engine/Source/Programs/UnrealBuildTool/Platform/Android/UEDeployAndroid.cs#L4303">UEDeployAndroid.cs#L4303</a>）。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">AdditionalPropertiesForReceipt.Add(<span class="keyword">new</span> ReceiptProperty(<span class="string">&quot;AndroidPlugin&quot;</span>, Path.Combine(ThirdPartyPath, <span class="string">&quot;Android/PlatformUtils_UPL_Android.xml&quot;</span>)));</span><br></pre></td></tr></table></figure>

<ul>
<li><a href="https://docs.unrealengine.com/en-US/Platforms/Mobile/UnrealPluginLanguage/index.html">Unreal Plugin Language</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/34374244">虚幻插件语言参考(Android 版)</a></li>
<li><a href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Programs/UnrealBuildTool/System/UnrealPluginLanguage.cs">Engine/Source/Programs/UnrealBuildTool/System/UnrealPluginLanguage.cs</a></li>
</ul>
<h3 id="Android 项目中所有的 UPL"><a href="#Android 项目中所有的 UPL" class="headerlink" title="Android 项目中所有的 UPL"></a>Android 项目中所有的 UPL</h3><p>可以在项目路径下<code>Intermediate/Android/ActiveUPL.xml</code>，里面列出了当前项目中所有的 UPL 文件路径：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Plugins\Online\Android\OnlineSubsystemGooglePlay\Source\OnlineSubsystemGooglePlay_UPL.xml</span><br><span class="line">Plugins\Runtime\AndroidPermission\Source\AndroidPermission\AndroidPermission_APL.xml</span><br><span class="line">Plugins\Runtime\GoogleCloudMessaging\Source\GoogleCloudMessaging\GoogleCloudMessaging_UPL.xml</span><br><span class="line">Plugins\Runtime\GooglePAD\Source\GooglePAD\GooglePAD_APL.xml</span><br><span class="line">Plugins\Runtime\Oculus\OculusVR\Source\OculusHMD\OculusMobile_APL.xml</span><br><span class="line">Source\Runtime\Online\Voice\AndroidVoiceImpl_UPL.xml</span><br><span class="line">Source\ThirdParty\GoogleGameSDK\GoogleGameSDK_APL.xml</span><br></pre></td></tr></table></figure>

<h3 id="删除 AndroidManifest-xml 中的项"><a href="# 删除 AndroidManifest-xml 中的项" class="headerlink" title="删除 AndroidManifest.xml 中的项"></a>删除 AndroidManifest.xml 中的项 </h3><p> 因为 UE 默认会给 <code>AndroidManifest.xml</code> 添加项，如果其中的项我们想要手动控制，直接添加的话会产生错误，提示已经存在：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   &gt; Task :app:processDebugManifest FAILED</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   </span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   Z:\app\src\main\AndroidManifest.xml:<span class="number">47</span>:<span class="number">5</span><span class="number">-106</span> Error:</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):     Element meta-data<span class="meta">#com.epicgames.ue4.GameActivity.bUseExternalFilesDir at AndroidManifest.xml:47:5-106 duplicated with element declared at AndroidManifest.xml:27:5-107</span></span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   Z:\app\src\main\AndroidManifest.xml Error:</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):     Validation failed, exiting</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   </span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   FAILURE: Build failed with an exception.</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   </span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   * What went wrong:</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   Execution failed <span class="keyword">for</span> task <span class="string">&#x27;:app:processDebugManifest&#x27;</span>.</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   &gt; Manifest merger failed with multiple errors, see logs</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   </span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   See http:<span class="comment">//g.co/androidstudio/manifest-merger for more information about the manifest merger.</span></span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   </span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   * Try:</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   Run with --stacktrace option to get the stack trace. Run with --info <span class="keyword">or</span> --debug option to get more log output. Run with --scan to get full insights.</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   </span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   * Get more help at https:<span class="comment">//help.gradle.org</span></span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   </span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   BUILD FAILED in <span class="number">10</span>s</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   <span class="number">189</span> actionable tasks: <span class="number">1</span> executed, <span class="number">188</span> up-to-date</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   ERROR: cmd.exe failed with args /c <span class="string">&quot;C:\Users\lipengzha\Documents\Unreal Projects\GCloudExample\Intermediate\Android\armv7\gradle\rungradle.bat&quot;</span> :app:assembleDebug</span><br><span class="line">PackagingResults: Error: cmd.exe failed with args /c <span class="string">&quot;C:\Users\lipengzha\Documents\Unreal Projects\GCloudExample\Intermediate\Android\armv7\gradle\rungradle.bat&quot;</span> :app:assembleDebug</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)): Took <span class="number">13.3060694</span>s to run UnrealBuildTool.exe, ExitCode=<span class="number">6</span></span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)): UnrealBuildTool failed. See log <span class="keyword">for</span> more details. (C:\Users\lipengzha\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+Program+Files+Epic+Games+UE_4<span class="number">.25</span>\UBT-.txt)</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)): AutomationTool exiting with ExitCode=<span class="number">6</span> (<span class="number">6</span>)</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)): BUILD FAILED</span><br><span class="line">PackagingResults: Error: Unknown Error</span><br></pre></td></tr></table></figure>

<p>如果想要修改或者删除 UE 默认生成的 <code>AndroidManifest.xml</code> 中的项，可以通过先删除再添加的方式。</p>
<p>以删除以下项为例:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">&lt;meta-data android:name=<span class="string">&quot;com.epicgames.ue4.GameActivity.bUseExternalFilesDir&quot;</span> android:value=<span class="string">&quot;false&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>
<p>在 UPL 的 <code>androidManifestUpdates</code> 中编写以下代码：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">androidManifestUpdates</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">loopElements</span> <span class="attr">tag</span>=<span class="string">&quot;meta-data&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setStringFromAttribute</span> <span class="attr">result</span>=<span class="string">&quot;ApplicationSectionName&quot;</span> <span class="attr">tag</span>=<span class="string">&quot;$&quot;</span> <span class="attr">name</span>=<span class="string">&quot;android:name&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setBoolIsEqual</span> <span class="attr">result</span>=<span class="string">&quot;bUseExternalFilesDir&quot;</span> <span class="attr">arg1</span>=<span class="string">&quot;$S(ApplicationSectionName)&quot;</span> <span class="attr">arg2</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bUseExternalFilesDir&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">condition</span>=<span class="string">&quot;bUseExternalFilesDir&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">true</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">removeElement</span> <span class="attr">tag</span>=<span class="string">&quot;$&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">true</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">loopElements</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">androidManifestUpdates</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>就是去遍历 <code>AndroidManfest.xml</code> 中已经存在 <code>meta-data</code> 中，<code>android:name</code>为 <code>com.epicgames.ue4.GameActivity.bUseExternalFilesDir</code> 的项给删除。</p>
<h3 id="JNI 调用接收 ActivityResult"><a href="#JNI 调用接收 ActivityResult" class="headerlink" title="JNI 调用接收 ActivityResult"></a>JNI 调用接收 ActivityResult</h3><p>有时需要通过 <code>startActivityForResult</code> 来创建 <code>Intent</code> 来执行一些操作，如打开摄像头、打开相册选择图片等。</p>
<p>但是 Android 做这些操作的时候不是阻塞在当前的函数中的，所以不能直接在调用的函数里接收这些数据。而通过 <code>startActivityForResult</code> 执行的 Action 的结果都会调用到 Activity 的 <code>onActivityResult</code> 中。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// GameActivity.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onActivityResult</span><span class="params">(<span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, Intent data)</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>UE 在 UPL 中提供了往 OnActivityResult 追加 Java 代码的用法：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- optional additions to GameActivity onActivityResult in GameActivity.java --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">gameActivityOnActivityResultAdditions</span>&gt;</span>	<span class="tag">&lt;/<span class="name">gameActivityOnActivityResultAdditions</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>使用这种方式添加的 Java 代码会追加到 <code>OnActivityResult</code> 函数的末尾，但是这种方式有一个问题，那就是执行了自己追加到 <code>OnActivityResult</code> 的代码之后，还要处理接收到的结果，并且传递到 UE 端来，有点麻烦。</p>
<p>经过翻阅代码，发现 UE 提供了 Java 端的 <code>OnActivityResult</code> 的多播代理事件，这样就可以直接在 UE 里用 C++ 来监听 <code>OnActivityResult</code> 的事件，自己做处理。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Launch/Puclic/Android/AndroidJNI.h</span></span><br><span class="line"><span class="built_in">DECLARE_MULTICAST_DELEGATE_SixParams</span>(FOnActivityResult, JNIEnv *, jobject, jobject, jint, jint, jobject);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该代理是定义在 `FJavaWrapper` 里的</span></span><br><span class="line"><span class="comment">// Delegate that can be registered to that is called when an activity is finished</span></span><br><span class="line"><span class="keyword">static</span> FOnActivityResult OnActivityResultDelegate;</span><br></pre></td></tr></table></figure>
<p>在 UE 侧就可以通过绑定这个多播代理来监听 Java 端的 <code>OnActivityResult</code> 调用，可以在其中做分别的处理。</p>
<p>它由 <code>AndroidJNI.cpp</code> 中的 <code>Java_com_epicgames_ue4_GameActivity_nativeOnActivityResult</code> 函数从 Java 那边调用过来，调用机制在上个笔记中有记录。</p>
<h3 id="Java 调 C"><a href="#Java 调 C" class="headerlink" title="Java 调 C++"></a>Java 调 C++</h3><p>有些需求和实现需要从 Java 调到 C++ 这边，可以通过下面这种方式：<br>首先，在 GameActivity 中新建一个 <code>native</code> 的 java 函数声明（不需要定义）：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeOnActivityResult</span><span class="params">(GameActivity activity, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, Intent data)</span></span>;</span><br></pre></td></tr></table></figure>
<p>然后在 C++ 端按照下面的规则定义一个 C++ 函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">JNI_METHOD <span class="keyword">void</span> <span class="title">Java_com_epicgames_ue4_GameActivity_nativeOnActivityResult</span><span class="params">(JNIEnv* jenv, jobject thiz, jobject activity, jint requestCode, jint resultCode, jobject data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FJavaWrapper::OnActivityResultDelegate.<span class="built_in">Broadcast</span>(jenv, thiz, activity, requestCode, resultCode, data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到函数名字的规则为：</p>
<ol>
<li>函数前需要加 <code>JNI_METHOD</code> 修饰，它是一个宏<code>__attribute__ ((visibility (&quot;default&quot;))) extern &quot;C&quot;</code></li>
<li>函数名需要以 <code>Java_</code> 开头，并且后面跟上 <code>com_epicgames_ue4_GameActivity_</code>，标识是定义在<code>GameActivity</code> 中的</li>
<li>然后再跟上 java 中的函数名</li>
</ol>
<p>接受参数的规则：</p>
<ol>
<li>第一个参数是 Java 的 Env</li>
<li>第二个是 java 里的 this</li>
<li>后面的参数以此是从 java 里传递参数</li>
</ol>
<h3 id="AndroidP 的全面屏适配"><a href="#AndroidP 的全面屏适配" class="headerlink" title="AndroidP 的全面屏适配"></a>AndroidP 的全面屏适配 </h3><p> 在 UE4 打包的时候，会给项目生成 GameActivity.java 文件，里面的 OnCreate 具有适配全面屏的代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> (UseDisplayCutout)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// will not be true if not Android Pie or later</span></span><br><span class="line">	    WindowManager.LayoutParams params = getWindow().getAttributes();</span><br><span class="line">		params.layoutInDisplayCutoutMode = WindowManager.LayoutParams.LAYOUT_IN_DISPLAY_CUTOUT_MODE_SHORT_EDGES;</span><br><span class="line">	    getWindow().setAttributes(params);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Android P 和之后的系统不支持，所以就要自己写 Jni 调用来强制让 P 和之后系统版本支持。<br>在 UE4.23+ 以后的引擎版本，支持了通过 UPL 往 OnCreate 函数添加代码，就可以直接把代码插入到 GameActivity.java 了：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;gameActivityOnCreateFinalAdditions&gt;</span><br><span class="line">&lt;insert&gt;</span><br><span class="line">    <span class="comment">// P 版本允许使用刘海</span></span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P) &#123;</span><br><span class="line">    WindowManager.LayoutParams lp = <span class="keyword">this</span>.getWindow().getAttributes();</span><br><span class="line">    lp.layoutInDisplayCutoutMode = WindowManager.LayoutParams.LAYOUT_IN_DISPLAY_CUTOUT_MODE_SHORT_EDGES;</span><br><span class="line">    <span class="keyword">this</span>.getWindow().setAttributes(lp);</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/insert&gt;</span><br><span class="line">&lt;/gameActivityOnCreateFinalAdditions&gt;</span><br></pre></td></tr></table></figure>

<p>在 UE4.23 之前不可以给 <code>OnCreate</code> 添加代码，只能自己写个 JNI 调用：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AndroidThunkJava_SetFullScreenDisplayForP</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">final</span> GameActivity Activity = <span class="keyword">this</span>;</span><br><span class="line">	runOnUiThread(<span class="keyword">new</span> Runnable() </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> GameActivity InActivity = Activity;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            WindowManager windowManager =  InActivity.getWindowManager();</span><br><span class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P) </span><br><span class="line">            &#123;</span><br><span class="line">        </span><br><span class="line">                WindowManager.LayoutParams lp = InActivity.getWindow().getAttributes();</span><br><span class="line">                lp.layoutInDisplayCutoutMode = WindowManager.LayoutParams.LAYOUT_IN_DISPLAY_CUTOUT_MODE_SHORT_EDGES;</span><br><span class="line">                InActivity.getWindow().setAttributes(lp);</span><br><span class="line">                Log.debug(<span class="string">&quot;call AndroidThunkJava_SetFullScreenDisplayForP&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将其在 UPL 中通过 <code>&lt;gameActivityClassAdditions&gt;</code> 添加到 GameActivity.java 中，在游戏启动时通过 JNI 调用即可。</p>
<p>注：</p>
<p><code>layoutInDisplayCutoutMode</code>的可选项为：</p>
<ul>
<li><a href="https://developer.android.com/reference/android/view/WindowManager.LayoutParams#LAYOUT_IN_DISPLAY_CUTOUT_MODE_ALWAYS">LAYOUT_IN_DISPLAY_CUTOUT_MODE_ALWAYS</a>(Added in <a href="https://developer.android.com/guide/topics/manifest/uses-sdk-element#ApiLevels">API level 30</a>)：始终允许窗口扩展到 <code>DisplayCutout</code> 屏幕所有边缘上的区域。</li>
<li><a href="https://developer.android.com/reference/android/view/WindowManager.LayoutParams#LAYOUT_IN_DISPLAY_CUTOUT_MODE_DEFAULT">LAYOUT_IN_DISPLAY_CUTOUT_MODE_DEFAULT</a>(Added in <a href="https://developer.android.com/guide/topics/manifest/uses-sdk-element#ApiLevels">API level 28</a>)：仅当窗口完全包含在系统栏中时<code>DisplayCutout</code>，才允许该窗口扩展到该区域 <code>DisplayCutout</code>。</li>
<li><a href="https://developer.android.com/reference/android/view/WindowManager.LayoutParams#LAYOUT_IN_DISPLAY_CUTOUT_MODE_NEVER">LAYOUT_IN_DISPLAY_CUTOUT_MODE_NEVER</a>(Added in <a href="https://developer.android.com/guide/topics/manifest/uses-sdk-element#ApiLevels">API level 28</a>)：永远不要让窗口与 DisplayCutout 区域重叠。</li>
<li><a href="https://developer.android.com/reference/android/view/WindowManager.LayoutParams#LAYOUT_IN_DISPLAY_CUTOUT_MODE_SHORT_EDGES">LAYOUT_IN_DISPLAY_CUTOUT_MODE_SHORT_EDGES</a>(Added in <a href="https://developer.android.com/guide/topics/manifest/uses-sdk-element#ApiLevels">API level 28</a>)：始终允许窗口扩展到 <code>DisplayCutout</code> 屏幕短边的区域。</li>
</ul>
<h4 id="外部资料"><a href="# 外部资料" class="headerlink" title="外部资料"></a>外部资料</h4><ul>
<li><a href="https://docs.unrealengine.com/zh-CN/Support/Builds/ReleaseNotes/4_23/index.html">UE4.23 的更新日志</a></li>
</ul>
<h3 id="Android 重启 App"><a href="#Android 重启 App" class="headerlink" title="Android 重启 App"></a>Android 重启 App</h3><p>当游戏更新完毕之后有时候需要重启 App 才可以生效，在 UE 中可以使用 UPL 写入以下 java 代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AndroidThunkJava_AndroidAPI_RestartApplication</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	Context context = getApplicationContext();</span><br><span class="line">    PackageManager pm = context.getPackageManager();</span><br><span class="line">    Intent intent = pm.getLaunchIntentForPackage(context.getPackageName());</span><br><span class="line">    <span class="keyword">int</span> delayTime = <span class="number">500</span>;</span><br><span class="line">    AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);</span><br><span class="line">    PendingIntent restartIntent = PendingIntent.getActivity(context, <span class="number">0</span>, intent, PendingIntent.FLAG_CANCEL_CURRENT);</span><br><span class="line">    alarmManager.set(AlarmManager.RTC, System.currentTimeMillis() + delayTime, restartIntent);</span><br><span class="line">    System.exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在需要重启的时候通过 jni 调用来触发：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RestartApplication</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_ANDROID</span></span><br><span class="line">	<span class="keyword">if</span> (JNIEnv* Env = FAndroidApplication::<span class="built_in">GetJavaEnv</span>(<span class="literal">true</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		FJavaWrapper::<span class="built_in">CallVoidMethod</span>(Env, FJavaWrapper::GameActivityThis, AndroidThunkJava_AndroidAPI_RestartApplication);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
        <category>UPL</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Mobile</tag>
        <tag>UPL</tag>
      </tags>
  </entry>
  <entry>
    <title>UPL 与 JNI 调用的最佳实践</title>
    <url>/wiki/23f6c20d/</url>
    <content><![CDATA[<p>在使用 UE4 开发 Android 时，有时需要获取平台相关的信息、或者执行平台相关的操作，在这种情况下，需要在代码中添加 Java 的代码以及在 C++ 中调用它们。有些需求也需要在游戏中从 Java 侧接收一些事件，需要处理 Java 调用 C++ 的流程。</p>
<p>本篇文章主要涉及以下几部分内容：</p>
<ul>
<li>UE 工程中添加 Java 代码</li>
<li>Java 函数的签名规则</li>
<li>Java 调用 C++ 的函数</li>
<li>C++ 调用 Java 的函数</li>
</ul>
<p>如何利用 UE 的 UPL 特性、Java 的签名规则，以及在 UE 中进行 JNI 调用实现方法，会在文章中做详细的介绍。</p>
<h2 id="UPL"><a href="#UPL" class="headerlink" title="UPL"></a>UPL</h2><p>UPL 全称 <a href="https://docs.unrealengine.com/en-US/Platforms/Mobile/UnrealPluginLanguage/index.html">Unreal Plugin Language</a>，是一个 XML-Based 的结构化语言，用于介入 UE 的打包过程（如拷贝 so/ 编辑 AndroidManifest.xml，添加 IOS 的 framework/ 操作 plist 等），本篇文章主要介绍 UPL 在 Android 中的使用，UPL 在 IOS 上的使用，在我之前的文章<a href="https://imzlp.com/posts/1948/#UPL%E5%9C%A8iOS%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8">UE4 开发笔记：Mac/iOS 篇 #UPL 在 iOS 中的应用</a> 中有介绍。</p>
<p>往 UE 项目里添加 Java 代码，需要通过 UPL 在打包时往 GameActivity.java 插入代码来实现。</p>
<p>UPL 的语法使用 XML，文件也需要保存为 <code>.xml</code> 格式：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="comment">&lt;!--Unreal Plugin Example--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 <code>&lt;root&gt;&lt;/root&gt;</code> 中可以使用 UPL 提供的节点来编写逻辑（但是因为它的语法都是 XML 的形式来实现编程逻辑的，所以写起来循环等控制流程十分麻烦），以添加 <code>AndroidManifest.xml</code> 中权限请求为例（以下代码均位于 <code>&lt;root&gt;&lt;/root&gt;</code> 中）：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">androidManifestUpdates</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 权限请求 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">addPermission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">addPermission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.READ_EXTERNAL_STORAGE&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--Android 的全面屏支持 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">addElements</span> <span class="attr">tag</span>=<span class="string">&quot;application&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;notch.config&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;portrait|landscape&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;android.notch_support&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">addElements</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">androidManifestUpdates</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用 <code>androidManifestUpdates</code> 节点，可以在其中更新<code>AndroidManifest.xml</code>，UPL 为 IOS 和 Android 都提供了很多平台相关的节点，在使用时需要注意，不能混用。</p>
<p>UPL 还提供了往 GameActivity 类中添加 Java 方法的节点：<code>gameActivityClassAdditions</code>，通过这个节点，可以直接在 UPL 里编写 Java 代码，在构建 Android 包时，会自动把这些代码插入到 <code>GameActivity.java</code> 中的 <code>GameActivity</code> 类中：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">gameActivityClassAdditions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span>&gt;</span></span><br><span class="line">        public String AndroidThunkJava_GetPackageName()</span><br><span class="line">        &#123;</span><br><span class="line">        Context context = getApplicationContext();</span><br><span class="line">        return context.getPackageName();</span><br><span class="line">        &#125;</span><br><span class="line">        public String AndroidThunkJava_GetInstalledApkPath()</span><br><span class="line">        &#123;</span><br><span class="line">        Context context = getApplicationContext();</span><br><span class="line">        PackageManager packageManager = context.getPackageManager();</span><br><span class="line">        ApplicationInfo appInfo;</span><br><span class="line">        try&#123;</span><br><span class="line">        appInfo = packageManager.getApplicationInfo(context.getPackageName(),PackageManager.GET_META_DATA);</span><br><span class="line">        return appInfo.sourceDir;</span><br><span class="line">        &#125;catch (PackageManager.NameNotFoundException e)&#123;</span><br><span class="line">        return &quot;invalid&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">gameActivityClassAdditions</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>插入之后生成的文件：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/27289/ue4-package-android-gameactivity.webp"></p>
<p>这两个函数就在 <code>GameActivity.java</code> 中了，UPL 有很多增加 GameActivity 内容的节点，这部分内容在 UE 的文档中是不全的，具体还是要去看 UBT 的代码：<a href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Programs/UnrealBuildTool/System/UnrealPluginLanguage.cs#L378">UnrealBuildTool/System/UnrealPluginLanguage.cs#L378</a>。</p>
<p>UPL 支持对 GameActivity 的扩展，不仅仅只是添加函数，还可以给 <code>OnCreate</code>/<code>OnDestory</code> 等函数添加额外的代码，方便根据需求介入到不同的时机。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Engine/Source/Programs/UnrealBuildTool/System/UnrealPluginLanguage.cs#L378 </span></span><br><span class="line"><span class="comment">*   &lt;!-- optional additions to the GameActivity imports in GameActivity.java --&gt;</span></span><br><span class="line"><span class="comment">*   &lt;gameActivityImportAdditions&gt; &lt;/gameActivityImportAdditions&gt;</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">*   &lt;!-- optional additions to the GameActivity after imports in GameActivity.java --&gt;</span></span><br><span class="line"><span class="comment">*  &lt;gameActivityPostImportAdditions&gt; &lt;/gameActivityPostImportAdditions&gt;</span></span><br><span class="line"><span class="comment">*  </span></span><br><span class="line"><span class="comment">*   &lt;!-- optional additions to the GameActivity class implements in GameActivity.java (end each line with a comma) --&gt;</span></span><br><span class="line"><span class="comment">*   &lt;gameActivityImplementsAdditions&gt; &lt;/gameActivityImplementsAdditions&gt;</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">*   &lt;!-- optional additions to the GameActivity class body in GameActivity.java --&gt;</span></span><br><span class="line"><span class="comment">*   &lt;gameActivityClassAdditions&gt; &lt;/gameActivityOnClassAdditions&gt;</span></span><br><span class="line"><span class="comment">*   </span></span><br><span class="line"><span class="comment">*   &lt;!-- optional additions to GameActivity onCreate metadata reading in GameActivity.java --&gt;</span></span><br><span class="line"><span class="comment">*   &lt;gameActivityReadMetadata&gt; &lt;/gameActivityReadMetadata&gt;</span></span><br><span class="line"><span class="comment">* </span></span><br><span class="line"><span class="comment">*  &lt;!-- optional additions to GameActivity onCreate in GameActivity.java --&gt;</span></span><br><span class="line"><span class="comment">*  &lt;gameActivityOnCreateAdditions&gt; &lt;/gameActivityOnCreateAdditions&gt;</span></span><br><span class="line"><span class="comment">*   </span></span><br><span class="line"><span class="comment">*   &lt;!-- optional additions to GameActivity onDestroy in GameActivity.java --&gt;</span></span><br><span class="line"><span class="comment">*   &lt;gameActivityOnDestroyAdditions&gt; &lt;/gameActivityOnDestroyAdditions&gt;</span></span><br><span class="line"><span class="comment">*   </span></span><br><span class="line"><span class="comment">*   &lt;!-- optional additions to GameActivity onStart in GameActivity.java --&gt;</span></span><br><span class="line"><span class="comment">*   &lt;gameActivityOnStartAdditions&gt; &lt;/gameActivityOnStartAdditions&gt;</span></span><br><span class="line"><span class="comment">*   </span></span><br><span class="line"><span class="comment">*   &lt;!-- optional additions to GameActivity onStop in GameActivity.java --&gt;</span></span><br><span class="line"><span class="comment">*   &lt;gameActivityOnStopAdditions&gt; &lt;/gameActivityOnStopAdditions&gt;</span></span><br><span class="line"><span class="comment">*   </span></span><br><span class="line"><span class="comment">*   &lt;!-- optional additions to GameActivity onPause in GameActivity.java --&gt;</span></span><br><span class="line"><span class="comment">*   &lt;gameActivityOnPauseAdditions&gt; &lt;/gameActivityOnPauseAdditions&gt;</span></span><br><span class="line"><span class="comment">*   </span></span><br><span class="line"><span class="comment">*   &lt;!-- optional additions to GameActivity onResume in GameActivity.java --&gt;</span></span><br><span class="line"><span class="comment">*  &lt;gameActivityOnResumeAdditions&gt;  &lt;/gameActivityOnResumeAdditions&gt;</span></span><br><span class="line"><span class="comment">*  </span></span><br><span class="line"><span class="comment">*   &lt;!-- optional additions to GameActivity onNewIntent in GameActivity.java --&gt;</span></span><br><span class="line"><span class="comment">*  &lt;gameActivityOnNewIntentAdditions&gt; &lt;/gameActivityOnNewIntentAdditions&gt;</span></span><br><span class="line"><span class="comment">*  </span></span><br><span class="line"><span class="comment">*   &lt;!-- optional additions to GameActivity onActivityResult in GameActivity.java --&gt;</span></span><br><span class="line"><span class="comment">*   &lt;gameActivityOnActivityResultAdditions&gt;  &lt;/gameActivityOnActivityResultAdditions&gt;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>那么，写完了 UPL 的脚本之后，如何来使用它呢？</p>
<p>需要在需要添加该 UPL 的 Module 的 <code>build.cs</code> 中添加以下代码：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// for Android</span></span><br><span class="line"><span class="keyword">if</span> (Target.Platform == UnrealTargetPlatform.Android)</span><br><span class="line">&#123;</span><br><span class="line">  PrivateDependencyModuleNames.Add(<span class="string">&quot;Launch&quot;</span>);</span><br><span class="line">  AdditionalPropertiesForReceipt.Add(<span class="string">&quot;AndroidPlugin&quot;</span>, Path.Combine(ModuleDirectory, <span class="string">&quot;UPL/Android/FGame_Android_UPL.xml&quot;</span>));    </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// for IOS</span></span><br><span class="line"><span class="keyword">if</span> (Target.Platform == UnrealTargetPlatform.IOS)</span><br><span class="line">&#123;</span><br><span class="line">  AdditionalPropertiesForReceipt.Add(<span class="string">&quot;IOSPlugin&quot;</span>,Path.Combine(ModuleDirectory,<span class="string">&quot;UPL/IOS/FGame_IOS_UPL.xml&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 <code>AdditionalPropertiesForReceipt</code> 来指定我们的 UPL 脚本，注意 <code>AndroidPlugin</code> 和<code>IOSPlugin</code>不可修改，文件路径可以根据 UPL 文件在项目中的位置指定。</p>
<p>使用这种方式就把 UPL 添加到了 UE 的构建系统中，当构建 Android/IOS 平台时，就会自动执行我们在脚本中的逻辑了。</p>
<h2 id="Java 函数签名"><a href="#Java 函数签名" class="headerlink" title="Java 函数签名"></a>Java 函数签名</h2><p>JNI 是什么？JNI 全称 Java Native Interface，即 Java 原生接口。主要用来从 Java 调用其他语言代码、其他语言来调用 Java 的代码。</p>
<p>在上一节中，我们通过 UPL 往 GameActivity 中添加了 Java 的代码，在 UE 中如何通过 C++ 去调用这些 Java 的函数，需要使用 JNI 调用来实现。</p>
<p>通过 C++ 去调用 Java，首先需要知道，所要调用的 Java 函数的签名。<strong>签名 </strong> 是描述一个函数的参数和返回值类型的信息。<br>以该函数为例：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">AndroidThunkJava_GetPackageName</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="string">&quot;&quot;</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>以这个函数为例，它不接受参数，返回一个 Java 的 String 值，那么它的签名是什么呢？</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">()Ljava/lang/String;</span><br></pre></td></tr></table></figure>

<p>签名的计算是有一个规则的，暂时先按下不表，后面会详细介绍。</p>
<p>JDK 提供的 <code>javac</code> 具有一个参数可以给 Java 代码生成 C++ 的头文件，用来方便 JNI 调用，其中就包含了签名。</p>
<p>写一个测试的 Java 代码，用来生成 JNI 调用的.h：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GameActivity</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> String <span class="title">SingnatureTester</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">javac -h . GameActivity.java</span><br></pre></td></tr></table></figure>

<p>会在当前目录下生成 <code>.class</code> 和<code>.h</code>文件，<code>.h</code>中的内容如下：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Header for class GameActivity */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _Included_GameActivity</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _Included_GameActivity</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     GameActivity</span></span><br><span class="line"><span class="comment"> * Method:    SingnatureTester</span></span><br><span class="line"><span class="comment"> * Signature: ()Ljava/lang/String;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">JNIEXPORT jstring JNICALL <span class="title">Java_GameActivity_SingnatureTester</span></span></span><br><span class="line"><span class="function">  <span class="params">(JNIEnv *, jclass)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>里面导出了 <code>GameActivity</code> 类成员<code>SingnatureTester</code>JNI 调用的符号信息，在注释中包含了它的签名<code>()Ljava/lang/String;</code>。</p>
<p><code>Java_ue4game_GameActivity_SingnatureTester</code>是当前函数可以在 C/C++ 中实现的函数名，当我们在 C++ 中实现了这个名字的函数，在 Java 中调用到 <code>GameActivity</code> 的<code>SingnatureTester</code>时，就会调用到我们 C++ 中的实现。</p>
<p>把函数声明改为：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GameActivity</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> String <span class="title">SingnatureTester</span><span class="params">(<span class="keyword">int</span> ival,<span class="keyword">double</span> dval,String str)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它的签名则是：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     GameActivity</span></span><br><span class="line"><span class="comment"> * Method:    SingnatureTester</span></span><br><span class="line"><span class="comment"> * Signature: (IDLjava/lang/String;)Ljava/lang/String;</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p>经过上面的两个例子，其实就可以看出来 Java 函数的签名规则：签名包含两部分——参数、返回值。</p>
<p>其中，<code>()</code>中的是参数的类型签名，按照参数顺序排列，<code>()</code>后面的是返回值的类型签名。</p>
<p>那么 Java 中的类型签名规则是怎么样的呢？可以依据下面的 Java 签名对照表：<a href="https://imzlp.com/notes/computerscience/#JNI%E8%B0%83%E7%94%A8%E7%AD%BE%E5%90%8D%E5%AF%B9%E7%85%A7%E8%A1%A8">JNI 调用签名对照表</a>。</p>
<p>Java 中的 <strong> 基础类型和签名对照表</strong>：</p>
<table>
<thead>
<tr>
<th align="center">Java</th>
<th align="center">Native</th>
<th align="center">Signature</th>
</tr>
</thead>
<tbody><tr>
<td align="center">byte</td>
<td align="center">jbyte</td>
<td align="center">B</td>
</tr>
<tr>
<td align="center">char</td>
<td align="center">jchar</td>
<td align="center">C</td>
</tr>
<tr>
<td align="center">double</td>
<td align="center">jdouble</td>
<td align="center">D</td>
</tr>
<tr>
<td align="center">float</td>
<td align="center">jfloat</td>
<td align="center">F</td>
</tr>
<tr>
<td align="center">int</td>
<td align="center">jint</td>
<td align="center">I</td>
</tr>
<tr>
<td align="center">short</td>
<td align="center">jshort</td>
<td align="center">S</td>
</tr>
<tr>
<td align="center">long</td>
<td align="center">jlong</td>
<td align="center">J</td>
</tr>
<tr>
<td align="center">boolean</td>
<td align="center">jboolean</td>
<td align="center">Z</td>
</tr>
<tr>
<td align="center">void</td>
<td align="center">void</td>
<td align="center">V</td>
</tr>
</tbody></table>
<p>根据上面的规则，<code>void EmptyFunc(int)</code>的签名为<code>(I)V</code>。</p>
<p><strong>非内置基础类型的签名规则 </strong> 为：</p>
<ol>
<li>以 <code>L</code> 开头</li>
<li>以 <code>;</code> 结尾</li>
<li>中间用 <code>/</code> 隔开包和类名</li>
</ol>
<p>如 Java 中类类型：</p>
<ul>
<li>String：<code>Ljava/lang/String;</code></li>
<li>Object：<code>Ljava/lang/Object;</code></li>
</ul>
<p>给上面的例子加上 package 时候再测试下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> ue4game;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GameActivity</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> String <span class="title">SingnatureTester</span><span class="params">(GameActivity activity)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>则得到的签名为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     ue4game_GameActivity</span></span><br><span class="line"><span class="comment"> * Method:    SingnatureTester</span></span><br><span class="line"><span class="comment"> * Signature: (Lue4game/GameActivity;)Ljava/lang/String;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">JNIEXPORT jstring JNICALL <span class="title">Java_ue4game_GameActivity_SingnatureTester</span></span></span><br><span class="line"><span class="function">  <span class="params">(JNIEnv *, jclass, jobject)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="JNI-Java-to-C"><a href="#JNI-Java-to-C" class="headerlink" title="JNI:Java to C++"></a>JNI:Java to C++</h2><p>UE 给我们的游戏生成的 <code>GameActivity</code> 中也声明了很多的 <code>native</code> 函数，这些函数是在 C++ 实现的，在 Java 中执行到这些函数会自动调用到引擎的 C++ 代码中：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">nativeGetCPUFamily</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">nativeSupportsNEON</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeSetAffinityInfo</span><span class="params">(<span class="keyword">boolean</span> bEnableAffinity, <span class="keyword">int</span> bigCoreMask, <span class="keyword">int</span> littleCoreMask)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeSetConfigRulesVariables</span><span class="params">(String[] KeyValuePairs)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">nativeIsShippingBuild</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeSetAndroidStartupState</span><span class="params">(<span class="keyword">boolean</span> bDebuggerAttached)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeSetGlobalActivity</span><span class="params">(<span class="keyword">boolean</span> bUseExternalFilesDir, <span class="keyword">boolean</span> bPublicLogFiles, String internalFilePath, String externalFilePath, <span class="keyword">boolean</span> bOBBInAPK, String APKPath)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeSetObbFilePaths</span><span class="params">(String OBBMainFilePath, String OBBPatchFilePath)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeSetWindowInfo</span><span class="params">(<span class="keyword">boolean</span> bIsPortrait, <span class="keyword">int</span> DepthBufferPreference)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeSetObbInfo</span><span class="params">(String ProjectName, String PackageName, <span class="keyword">int</span> Version, <span class="keyword">int</span> PatchVersion, String AppType)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeSetAndroidVersionInformation</span><span class="params">(String AndroidVersion, String PhoneMake, String PhoneModel, String PhoneBuildNumber, String OSLanguage)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeSetSurfaceViewInfo</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeSetSafezoneInfo</span><span class="params">(<span class="keyword">boolean</span> bIsPortrait, <span class="keyword">float</span> left, <span class="keyword">float</span> top, <span class="keyword">float</span> right, <span class="keyword">float</span> bottom)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeConsoleCommand</span><span class="params">(String commandString)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeVirtualKeyboardChanged</span><span class="params">(String contents)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeVirtualKeyboardResult</span><span class="params">(<span class="keyword">boolean</span> update, String contents)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeVirtualKeyboardSendKey</span><span class="params">(<span class="keyword">int</span> keyCode)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeVirtualKeyboardSendTextSelection</span><span class="params">(String contents, <span class="keyword">int</span> selStart, <span class="keyword">int</span> selEnd)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeVirtualKeyboardSendSelection</span><span class="params">(<span class="keyword">int</span> selStart, <span class="keyword">int</span> selEnd)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeInitHMDs</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeResumeMainInit</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeOnActivityResult</span><span class="params">(GameActivity activity, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, Intent data)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeGoogleClientConnectCompleted</span><span class="params">(<span class="keyword">boolean</span> bSuccess, String accessToken)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeVirtualKeyboardShown</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeVirtualKeyboardVisible</span><span class="params">(<span class="keyword">boolean</span> bShown)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeOnConfigurationChanged</span><span class="params">(<span class="keyword">boolean</span> bPortrait)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeOnInitialDownloadStarted</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeOnInitialDownloadCompleted</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeHandleSensorEvents</span><span class="params">(<span class="keyword">float</span>[] tilt, <span class="keyword">float</span>[] rotation_rate, <span class="keyword">float</span>[] gravity, <span class="keyword">float</span>[] acceleration)</span></span>;</span><br></pre></td></tr></table></figure>

<p>在上一节 Java 签名中已经提到过，<code>native</code>的方法是 Java 调用其他语言实现，上面这些函数在 UE 中均有实现，用于在引擎中接收 Android 设备的不同逻辑，定义分布在下列文件中：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Runtime\Android\AndroidLocalNotification\Private\AndroidLocalNotification.cpp</span><br><span class="line">Runtime\ApplicationCore\Private\Android\AndroidWindow.cpp</span><br><span class="line">Runtime\Core\Private\Android\AndroidPlatformFile.cpp</span><br><span class="line">Runtime\Core\Private\Android\AndroidPlatformMisc.cpp</span><br><span class="line">Runtime\Core\Private\Android\AndroidPlatformProcess.cpp</span><br><span class="line">Runtime\Launch\Private\Android\AndroidEventManager.cpp</span><br><span class="line">Runtime\Launch\Private\Android\AndroidJNI.cpp</span><br><span class="line">Runtime\Launch\Private\Android\LaunchAndroid.cpp</span><br></pre></td></tr></table></figure>

<p>我们也可以自己在 GameActivity 添加 <code>native</code> 的函数，如果有一些 SDK 中提供了 <code>native</code> 这样的函数，也可以用以下方式来实现，我这里写一个简单的例子，使用 UPL 往 GameActivity 添加一个 <code>native</code> 函数，并在 C++ 端实现。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">&lt;gameActivityClassAdditions&gt;</span><br><span class="line">  &lt;insert&gt;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> native <span class="keyword">void</span> <span class="title">nativeDoTester</span><span class="params">(String Msg)</span></span>;</span><br><span class="line">  &lt;/insert&gt;</span><br><span class="line">&lt;/gameActivityClassAdditions&gt;</span><br></pre></td></tr></table></figure>

<p>在 C++ 中实现一个这样的函数即可：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_ANDROID</span></span><br><span class="line"><span class="function">JNI_METHOD <span class="keyword">void</span> <span class="title">Java_com_epicgames_ue4_GameActivity_nativeDoTester</span></span></span><br><span class="line"><span class="function">  <span class="params">(JNIEnv jenv*, jobject thiz, jstring msg)</span></span>;</span><br><span class="line">&#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p><code>com.epicgames.ue4</code>是 UE 生成的 <code>GameActivity.java</code> 的包名(<code>package com.epicgames.ue4;</code>)。</p>
<p>可以看到，在 C++ 中实现 JNIMETHOD 的函数名是以下规则：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">RType <span class="title">Java_PACKAGENAME_CLASSNAME_FUNCNAME</span><span class="params">(JNIEnv*,jobject thiz,Oher...)</span></span></span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：这个函数必须是个 C 函数，不能参与 C++ 的 name mangling，不然签名就不对了。</p>
<p>在 UE 中可以使用 <code>JNI_METHOD</code> 宏，它定义在 <code>AndroidPlatform.h</code> 中。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime/Core/Public/Android/AndroidPlatform.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> JNI_METHOD      __attribute__ ((visibility (<span class="meta-string">&quot;default&quot;</span>))) extern <span class="meta-string">&quot;C&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>也可以使用<code>extern &quot;C&quot;</code>。在 C++ 中定义之后，如果 Java 端调用了该函数，就可以执行到我们在 C++ 里写的逻辑了。</p>
<h2 id="JNI-C-to-Java"><a href="#JNI-C-to-Java" class="headerlink" title="JNI:C++ to Java"></a>JNI:C++ to Java</h2><p>通过上一节的内容，可以知道了 Java 中函数的签名信息，如何在 UE 中通过函数名和签名信息来在 C++ 中调用到游戏中的 Java 代码呢。</p>
<p>UE 在 C++ 端封装了大量的 JNI 的辅助函数，可以很方便地进行 JNI 操作。这些函数大多定义在下面三个头文件中：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime/Launch/Public/Android</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Android/AndroidJNI.h&quot;</span></span></span><br><span class="line"><span class="comment">// Runtime/Core/Public/Android</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Android/AndroidJavaEnv.h&quot;</span></span></span><br><span class="line"><span class="comment">// Runtime/Core/Public/Android</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Android/AndroidJava.h&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>因为 <code>AndroidJNI.h</code> 位于 <code>Launch</code> 模块中，所以在需要在 Build.cs 中为 <code>Android</code> 平台添加该模块。</p>
<p>以第一节我们使用 UPL 往 <strong>GameActivity</strong> 类中添加的下面这个函数为例：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">AndroidThunkJava_GetPackageName</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Context context = getApplicationContext();</span><br><span class="line">  <span class="keyword">return</span> context.getPackageName();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>想要在 UE 中调用到它，首先要获取它的 <code>jmethodID</code>，需要通过<strong> 函数所属的类 </strong>、<strong> 函数名字 </strong>，<strong> 签名 </strong> 三种信息来获取：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (JNIEnv* Env = FAndroidApplication::<span class="built_in">GetJavaEnv</span>())</span><br><span class="line">&#123;</span><br><span class="line">  jmethodID GetPackageNameMethodID = FJavaWrapper::<span class="built_in">FindMethod</span>(Env, FJavaWrapper::GameActivityClassID, <span class="string">&quot;AndroidThunkJava_GetPackageName&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为我们的代码是插入到 <code>GameActivity</code> 类中的，而 UE 对 <code>GameActivity</code> 做了封装，所以可以通过 <code>FJavaWrapper</code> 来获取，<code>FJavaWrapper</code>定义位于<code>Runtime/Launch/Public/Android</code>。</p>
<p>得到的这个<code>methodID</code>，有点类似于 C++ 的成员函数指针，想要调用到它，需要通过某个对象来执行调用，UE 也做了封装：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">jstring JstringResult = (jstring)FJavaWrapper::<span class="built_in">CallObjectMethod</span>(Env, FJavaWrapper::GameActivityThis,GetPackageNameMethodID);</span><br></pre></td></tr></table></figure>
<p>通过 <code>CallObjectMethod</code> 来在 <code>GameActivity</code> 的实例上调用<code>GetPackageNameMethodID</code>，得到的值是 java 中的对象，这个值还不能直接转换为 UE 中的字符串使用，需要进行转换的流程：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> FJavaHelperEx</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function">FString <span class="title">FStringFromParam</span><span class="params">(JNIEnv* Env, jstring JavaString)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!Env || !JavaString || Env-&gt;<span class="built_in">IsSameObject</span>(JavaString, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> chars = Env-&gt;<span class="built_in">GetStringUTFChars</span>(JavaString, <span class="number">0</span>);</span><br><span class="line">    <span class="function">FString <span class="title">ReturnString</span><span class="params">(UTF8_TO_TCHAR(chars))</span></span>;</span><br><span class="line">    Env-&gt;<span class="built_in">ReleaseStringUTFChars</span>(JavaString, chars);</span><br><span class="line">    <span class="keyword">return</span> ReturnString;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function">FString <span class="title">FStringFromLocalRef</span><span class="params">(JNIEnv* Env, jstring JavaString)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    FString ReturnString = <span class="built_in">FStringFromParam</span>(Env, JavaString);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Env &amp;&amp; JavaString)</span><br><span class="line">    &#123;</span><br><span class="line">      Env-&gt;<span class="built_in">DeleteLocalRef</span>(JavaString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ReturnString;</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过上面定义的 <code>FJavaHelperEx::FStringFromLocalRef</code> 可以把 <code>jstring</code> 转换为 UE 的 FString：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">FString FinalResult = FJavaHelperEx::<span class="built_in">FStringFromLocalRef</span>(Env,JstringResult);</span><br></pre></td></tr></table></figure>
<p>到这里，整个 JNI 调用的流程就结束了，能够通过 C++ 去调用 Java 并获取返回值了。</p>
<h2 id="结语"><a href="# 结语" class="headerlink" title="结语"></a>结语 </h2><p> 参考资料：</p>
<ul>
<li><a href="https://docs.unrealengine.com/en-US/Platforms/Mobile/UnrealPluginLanguage/index.html">Unreal Plugin Language</a></li>
<li><a href="https://imzy.vip/posts/55704/">Jni 符号对照</a></li>
<li><a href="https://docs.oracle.com/javase/7/docs/technotes/guides/jni/spec/types.html#wp9502">JNI Types and Data Structures</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
        <category>UPL</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Mobile</tag>
        <tag>UPL</tag>
      </tags>
  </entry>
  <entry>
    <title>UPL 在 iOS 中的应用</title>
    <url>/wiki/10d03e93/</url>
    <content><![CDATA[<p><a href="https://docs.unrealengine.com/en-US/Platforms/Mobile/UnrealPluginLanguage/index.html">Unreal Plugin Language</a>是 UE 提供的以 XML 语法为基础的语言，用来可以控制构建 Apk 以及 ipa 的过程，如实现修改 <code>AndroidManifest.xml</code> 或者 <code>info.plist</code> 等。</p>
<h3 id="分析 plist 的生成流程"><a href="# 分析 plist 的生成流程" class="headerlink" title="分析 plist 的生成流程"></a>分析 plist 的生成流程 </h3><p> 在<a href="">UEDeployIOS.cs</a>的 <code>GeneratePList</code> 函数中通过传入进来的 <code>UPLScripts</code> 来构造出 UPL 对象：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">bool</span> <span class="title">GeneratePList</span>(<span class="params">FileReference ProjectFile, UnrealTargetConfiguration Config, <span class="built_in">string</span> ProjectDirectory, <span class="built_in">bool</span> bIsUE4Game, <span class="built_in">string</span> GameName, <span class="built_in">bool</span> bIsClient, <span class="built_in">string</span> ProjectName, <span class="built_in">string</span> InEngineDir, <span class="built_in">string</span> AppDirectory, List&lt;<span class="built_in">string</span>&gt; UPLScripts, VersionNumber SdkVersion, <span class="built_in">string</span> BundleID, <span class="built_in">bool</span> bBuildAsFramework, <span class="keyword">out</span> <span class="built_in">bool</span> bSupportsPortrait, <span class="keyword">out</span> <span class="built_in">bool</span> bSupportsLandscape, <span class="keyword">out</span> <span class="built_in">bool</span> bSkipIcons</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// remember name with -IOS-Shipping, etc</span></span><br><span class="line">	<span class="comment">// string ExeName = GameName;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// strip out the markup</span></span><br><span class="line">	GameName = GameName.Split(<span class="string">&quot;-&quot;</span>.ToCharArray())[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">	List&lt;<span class="built_in">string</span>&gt; ProjectArches = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">	ProjectArches.Add(<span class="string">&quot;None&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">string</span> BundlePath;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// get the receipt</span></span><br><span class="line">	<span class="keyword">if</span> (bIsUE4Game)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// ReceiptFilename = TargetReceipt.GetDefaultPath(UnrealBuildTool.EngineDirectory, &quot;UE4Game&quot;, UnrealTargetPlatform.IOS, Config, &quot;&quot;);</span></span><br><span class="line">		BundlePath = Path.Combine(UnrealBuildTool.EngineDirectory.ToString(), <span class="string">&quot;Intermediate&quot;</span>, <span class="string">&quot;IOS-Deploy&quot;</span>, <span class="string">&quot;UE4Game&quot;</span>, Config.ToString(), <span class="string">&quot;Payload&quot;</span>, <span class="string">&quot;UE4Game.app&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// ReceiptFilename = TargetReceipt.GetDefaultPath(new DirectoryReference(ProjectDirectory), GameName, UnrealTargetPlatform.IOS, Config, &quot;&quot;);</span></span><br><span class="line">		BundlePath = AppDirectory;<span class="comment">//Path.Combine(ProjectDirectory, &quot;Binaries&quot;, &quot;IOS&quot;, &quot;Payload&quot;, ProjectName + &quot;.app&quot;);</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">string</span> RelativeEnginePath = UnrealBuildTool.EngineDirectory.MakeRelativeTo(DirectoryReference.GetCurrentDirectory());</span><br><span class="line"></span><br><span class="line">	UnrealPluginLanguage UPL = <span class="keyword">new</span> UnrealPluginLanguage(ProjectFile, UPLScripts, ProjectArches, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, UnrealTargetPlatform.IOS);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Passing in true for distribution is not ideal here but given the way that ios packaging happens and this call chain it seems unavoidable for now, maybe there is a way to correctly pass it in that I can&#x27;t find?</span></span><br><span class="line">	UPL.Init(ProjectArches, <span class="literal">true</span>, RelativeEnginePath, BundlePath, ProjectDirectory, Config.ToString(), <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> GenerateIOSPList(ProjectFile, Config, ProjectDirectory, bIsUE4Game, GameName, bIsClient, ProjectName, InEngineDir, AppDirectory, SdkVersion, UPL, BundleID, bBuildAsFramework, <span class="keyword">out</span> bSupportsPortrait, <span class="keyword">out</span> bSupportsLandscape, <span class="keyword">out</span> bSkipIcons);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在最后调用的 <a href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Programs/UnrealBuildTool/Platform/IOS/UEDeployIOS.cs#L198">GeneratedIOSList</a> 中，构造出默认的 pliat 内容、从 <code>Additional Plist Data</code> 中读取的内容、以及调用 UPL 来处理 plist 的内容，UPL 的过程是最后处理的。</p>
<p>而且需要注意的是，在 <code>GeneratedPList</code> 函数中，通过 <a href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Programs/UnrealBuildTool/Platform/IOS/UEDeployIOS.cs#L760">GeneratedIOSList</a> 获取所有模块中添加的 UPL.xml 文件，然后把这些 xml 文件合并成一个，注意合并的顺序是 <code>AdditionalProperties</code> 的顺序，最后添加的 UPL 会放在最后执行，在一个项目中如果有多个使用 UPL 的操作要注意顺序问题。</p>
<h3 id="介入 ipa 生成过程：操作 plist"><a href="# 介入 ipa 生成过程：操作 plist" class="headerlink" title="介入 ipa 生成过程：操作 plist"></a>介入 ipa 生成过程：操作 plist</h3><p>ios 的 ipa 包中都会有 plist 文件，可以用来配置 app 的一些属性，apple 的开发者文档里对每个支持的 key 有详细的描述：<a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/iPhoneOSKeys.html#//apple_ref/doc/uid/TP40009252-SW10">iOS Keys</a></p>
<p>UE 4.25.1 默认打包会产生下面这样一个 plist 文件：<a href="info.plist">info.plist</a>，在一些特殊的需求中，需要往这个 plist 中添加元素或者修改以及删除。</p>
<p>在 UE 的项目设置中，可以给 plist 添加元素，在 <code>Project Settings</code>-<code>Platform</code>-<code>iOS</code>-<code>Additional Plist data</code> 中可以填入一个字符串，它会被插入到 plist 文件中：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">key</span>&gt;</span>AdditionalElementAAA<span class="tag">&lt;/<span class="name">key</span>&gt;</span>\n<span class="tag">&lt;<span class="name">string</span>&gt;</span>this key is a test element.<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>中间的 <code>\n</code> 是格式化代码，用于另起一行。<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/1948/ue4-project-ios-additional-plist-data.webp"></p>
<p>如果想要修改或者删除 plist 的元素，需要通过 UPL 来写逻辑（当然也可以使用 UPL 来添加元素，建议使用这种做法）。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">log</span> <span class="attr">text</span>=<span class="string">&quot;UPL Exalpme adding element to plist...&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">trace</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">iosPListUpdates</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">addElements</span> <span class="attr">tag</span>=<span class="string">&quot;dict&quot;</span> <span class="attr">once</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">key</span>&gt;</span>AdditionalElementAAA<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">string</span>&gt;</span>this key is a test element.<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">addElements</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">iosPListUpdates</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>上面是用来添加元素的，上面的内容和直接写到 <code>Additional Plist data</code> 是一样的。</p>
<p>遍历 plist 中的 key：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">log</span> <span class="attr">text</span>=<span class="string">&quot;UPL Exalpme...&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">trace</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">iosPListUpdates</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">loopElements</span> <span class="attr">tag</span>=<span class="string">&quot;dict&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">loopElements</span> <span class="attr">tag</span>=<span class="string">&quot;$&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">setStringFromTag</span> <span class="attr">result</span>=<span class="string">&quot;TagName&quot;</span> <span class="attr">tag</span>=<span class="string">&quot;$&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">setBoolIsEqual</span> <span class="attr">result</span>=<span class="string">&quot;bIsKey&quot;</span> <span class="attr">arg1</span>=<span class="string">&quot;$S(TagName)&quot;</span> <span class="attr">arg2</span>=<span class="string">&quot;key&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">condition</span>=<span class="string">&quot;bIsKey&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">true</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">log</span> <span class="attr">text</span>=<span class="string">&quot;$S(TagName):$S(TagValue)&quot;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">true</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">loopElements</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">loopElements</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">    <span class="tag">&lt;/<span class="name">iosPListUpdates</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>注意：当前元素以 <code>tag = &quot;$&quot;</code> 方式引用。</p>
<p>编译时就会有以下 log：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UPL: /Users/buildmachine/UE4/Builds/lipengzha-PC1/C/BuildAgent/workspace/PackageFGameClient/FGame/Plugins/UPLExample/Source/UPLExample/ThirdParty/IOS/IOS_UPL.xml</span><br><span class="line">UPL Init: None</span><br><span class="line">UPLExalpme adding element to plist...</span><br><span class="line">key : CFBundleURLTypes</span><br><span class="line">key : CFBundleDevelopmentRegion</span><br><span class="line">key : CFBundleDisplayName</span><br><span class="line">key : CFBundleExecutable</span><br><span class="line">key : CFBundleIdentifier</span><br><span class="line">key : CFBundleInfoDictionaryVersion</span><br><span class="line">key : CFBundleName</span><br><span class="line">key : CFBundlePackageType</span><br><span class="line">key : CFBundleSignature</span><br><span class="line">key : CFBundleVersion</span><br><span class="line">key : CFBundleShortVersionString</span><br><span class="line">key : LSRequiresIPhoneOS</span><br><span class="line">key : UIStatusBarHidden</span><br><span class="line">key : UIFileSharingEnabled</span><br><span class="line">key : UIRequiresFullScreen</span><br><span class="line">key : UIViewControllerBasedStatusBarAppearance</span><br><span class="line">key : UIInterfaceOrientation</span><br><span class="line">key : UISupportedInterfaceOrientations</span><br><span class="line">key : UIRequiredDeviceCapabilities</span><br><span class="line">key : CFBundleIcons</span><br><span class="line">key : CFBundleIcons~ipad</span><br><span class="line">key : UILaunchStoryboardName</span><br><span class="line">key : CFBundleSupportedPlatforms</span><br><span class="line">key : MinimumOSVersion</span><br><span class="line">key : ITSAppUsesNonExemptEncryption</span><br><span class="line">key : NSLocationAlwaysAndWhenInUseUsageDescription</span><br><span class="line">key : NSLocationWhenInUseUsageDescription</span><br><span class="line">key : CFBundleURLName</span><br><span class="line">key : CFBundleURLSchemes</span><br><span class="line">key : CFBundlePrimaryIcon</span><br><span class="line">key : CFBundleIconFiles</span><br><span class="line">key : CFBundleIconName</span><br><span class="line">key : UIPrerenderedIcon</span><br><span class="line">key : CFBundlePrimaryIcon</span><br><span class="line">key : CFBundleIconFiles</span><br><span class="line">key : CFBundleIconName</span><br><span class="line">key : UIPrerenderedIcon</span><br></pre></td></tr></table></figure>
<p>对于新增比较简单，但是对于删除和修改就比较麻烦了，需要遍历一遍所有的节点，然后根据匹配来删掉当前的元素（注意 plist 的是键值对的，一个 <code>&lt;key&gt;&lt;/key&gt;</code> 下面还对应着一个 value 元素，这两个都要删掉，不然会打包不过）：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">key</span>&gt;</span>BuildMachineOSBuild<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">string</span>&gt;</span>19C57<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>我写了个方便删除 plist 中元素的流程，可以方便删除多组元素：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">log</span> <span class="attr">text</span>=<span class="string">&quot;UPLExalpme adding element to plist...&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">trace</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">iosPListUpdates</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">addElements</span> <span class="attr">tag</span>=<span class="string">&quot;dict&quot;</span> <span class="attr">once</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">key</span>&gt;</span>AdditionalElementA<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">string</span>&gt;</span>this key is a AdditionalElementA element.<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">key</span>&gt;</span>AdditionalElementB<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">string</span>&gt;</span>this key is a AdditionalElementB element.<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">addElements</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">setString</span> <span class="attr">result</span>=<span class="string">&quot;NeedDeleteKey_1&quot;</span> <span class="attr">value</span>=<span class="string">&quot;AdditionalElementA&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setString</span> <span class="attr">result</span>=<span class="string">&quot;NeedDeleteKey_2&quot;</span> <span class="attr">value</span>=<span class="string">&quot;AdditionalElementB&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setInt</span> <span class="attr">result</span>=<span class="string">&quot;loopSumNum&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span>/&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">setInt</span> <span class="attr">result</span>=<span class="string">&quot;loopCount&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setBoolIsLessEqual</span> <span class="attr">result</span>=<span class="string">&quot;loopRun&quot;</span> <span class="attr">arg1</span>=<span class="string">&quot;$I(loopCount)&quot;</span> <span class="attr">arg2</span>=<span class="string">&quot;$I(loopSumNum)&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">while</span> <span class="attr">condition</span>=<span class="string">&quot;loopRun&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">log</span> <span class="attr">text</span>=<span class="string">&quot;count:$I(loopCount) SearchKey:$S(NeedDeleteKey_$I(loopCount))&quot;</span>/&gt;</span></span><br><span class="line">            </span><br><span class="line">            <span class="tag">&lt;<span class="name">setBool</span> <span class="attr">result</span>=<span class="string">&quot;bIsDeleteElement&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">loopElements</span> <span class="attr">tag</span>=<span class="string">&quot;dict&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">loopElements</span> <span class="attr">tag</span>=<span class="string">&quot;$&quot;</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- delete value --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">if</span> <span class="attr">condition</span>=<span class="string">&quot;bIsDeleteElement&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">true</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">setBool</span> <span class="attr">result</span>=<span class="string">&quot;bIsDeleteElement&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">log</span> <span class="attr">text</span>=<span class="string">&quot;bIsDeleteElement is true!!!&quot;</span>/&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">setStringFromTag</span> <span class="attr">result</span>=<span class="string">&quot;TagName&quot;</span> <span class="attr">tag</span>=<span class="string">&quot;$&quot;</span>/&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">setStringFromTagText</span> <span class="attr">result</span>=<span class="string">&quot;TagValue&quot;</span> <span class="attr">tag</span>=<span class="string">&quot;$&quot;</span>/&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">log</span> <span class="attr">text</span>=<span class="string">&quot;Delete element value,tagname:$S(TagName) value:$S(TagValue)&quot;</span>/&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">removeElement</span> <span class="attr">tag</span>=<span class="string">&quot;$&quot;</span> <span class="attr">once</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">true</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">&lt;!-- delete key --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">setStringFromTag</span> <span class="attr">result</span>=<span class="string">&quot;TagName&quot;</span> <span class="attr">tag</span>=<span class="string">&quot;$&quot;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">setBoolIsEqual</span> <span class="attr">result</span>=<span class="string">&quot;bIsKey&quot;</span> <span class="attr">arg1</span>=<span class="string">&quot;$S(TagName)&quot;</span> <span class="attr">arg2</span>=<span class="string">&quot;key&quot;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">if</span> <span class="attr">condition</span>=<span class="string">&quot;bIsKey&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">true</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">setStringFromTagText</span> <span class="attr">result</span>=<span class="string">&quot;TagValue&quot;</span> <span class="attr">tag</span>=<span class="string">&quot;$&quot;</span>/&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">log</span> <span class="attr">text</span>=<span class="string">&quot;tagname:$S(TagName) tagvalue:$S(TagValue)&quot;</span>/&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">setBoolIsEqual</span> <span class="attr">result</span>=<span class="string">&quot;bIs_NeedDeleteKey_$I(loopCount)&quot;</span> <span class="attr">arg1</span>=<span class="string">&quot;$S(TagValue)&quot;</span> <span class="attr">arg2</span>=<span class="string">&quot;$S(NeedDeleteKey_$I(loopCount))&quot;</span>/&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">if</span> <span class="attr">condition</span>=<span class="string">&quot;bIs_NeedDeleteKey_$I(loopCount)&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">true</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">log</span> <span class="attr">text</span>=<span class="string">&quot;Match key $S(NeedDeleteKey_$I(loopCount)).&quot;</span>/&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">log</span> <span class="attr">text</span>=<span class="string">&quot;Delete element key,tagname:$S(TagName) value:$S(TagValue).&quot;</span>/&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">removeElement</span> <span class="attr">tag</span>=<span class="string">&quot;$&quot;</span> <span class="attr">once</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">setBool</span> <span class="attr">result</span>=<span class="string">&quot;bIsDeleteElement&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">true</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">true</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">loopElements</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">loopElements</span>&gt;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">&lt;!--control loop end--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">setIntAdd</span> <span class="attr">result</span>=<span class="string">&quot;loopCount&quot;</span> <span class="attr">arg1</span>=<span class="string">&quot;$I(loopCount)&quot;</span> <span class="attr">arg2</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">setBoolIsLessEqual</span> <span class="attr">result</span>=<span class="string">&quot;loopRun&quot;</span> <span class="attr">arg1</span>=<span class="string">&quot;$I(loopCount)&quot;</span> <span class="attr">arg2</span>=<span class="string">&quot;$I(loopSumNum)&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">condition</span>=<span class="string">&quot;loopRun&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">true</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">log</span> <span class="attr">text</span>=<span class="string">&quot;add loopCount to $I(loopCount)&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">true</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">false</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">log</span> <span class="attr">text</span>=<span class="string">&quot;the loop is finished!&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">false</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">while</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">    <span class="tag">&lt;/<span class="name">iosPListUpdates</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>脚本最开始 Add 了两个元素对，后面则是删除的代码，使用时需要关注的是下面三行：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">setString</span> <span class="attr">result</span>=<span class="string">&quot;NeedDeleteKey_1&quot;</span> <span class="attr">value</span>=<span class="string">&quot;AdditionalElementA&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">setString</span> <span class="attr">result</span>=<span class="string">&quot;NeedDeleteKey_2&quot;</span> <span class="attr">value</span>=<span class="string">&quot;AdditionalElementB&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">setInt</span> <span class="attr">result</span>=<span class="string">&quot;loopSumNum&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>头两行是要删除的元素的变量，值是要删除的 key 的字符串，注意命名规则都是以 <code>NeedDeleteKey_</code> 开头，要遵守这个命名规则。<br>第三行是创建了一个 <code>loopSumNum</code> 的变量，用于记录有多少个需要删除的元素对，这里我测试删除两个，它的值就是 2。</p>
<p>当打包构建的时候，这个脚本执行起来就会有下面的输出：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UPL: /Users/buildmachine/UE4/Builds/lipengzha-PC1/C/BuildAgent/workspace/PackageFGameClient/FGame/Plugins/UPLExample/Source/UPLExample/ThirdParty/IOS/IOS_UPL.xml</span><br><span class="line">UPL Init: None</span><br><span class="line">UPLExalpme adding element to plist...</span><br><span class="line">count:1 SearchKey:AdditionalElementA</span><br><span class="line">tagname:key tagvalue:CFBundleURLTypes</span><br><span class="line">tagname:key tagvalue:CFBundleDevelopmentRegion</span><br><span class="line">tagname:key tagvalue:CFBundleDisplayName</span><br><span class="line">tagname:key tagvalue:CFBundleExecutable</span><br><span class="line">tagname:key tagvalue:CFBundleIdentifier</span><br><span class="line">tagname:key tagvalue:CFBundleInfoDictionaryVersion</span><br><span class="line">tagname:key tagvalue:CFBundleName</span><br><span class="line">tagname:key tagvalue:CFBundlePackageType</span><br><span class="line">tagname:key tagvalue:CFBundleSignature</span><br><span class="line">tagname:key tagvalue:CFBundleVersion</span><br><span class="line">tagname:key tagvalue:CFBundleShortVersionString</span><br><span class="line">tagname:key tagvalue:LSRequiresIPhoneOS</span><br><span class="line">tagname:key tagvalue:UIStatusBarHidden</span><br><span class="line">tagname:key tagvalue:UIFileSharingEnabled</span><br><span class="line">tagname:key tagvalue:UIRequiresFullScreen</span><br><span class="line">tagname:key tagvalue:UIViewControllerBasedStatusBarAppearance</span><br><span class="line">tagname:key tagvalue:UIInterfaceOrientation</span><br><span class="line">tagname:key tagvalue:UISupportedInterfaceOrientations</span><br><span class="line">tagname:key tagvalue:UIRequiredDeviceCapabilities</span><br><span class="line">tagname:key tagvalue:CFBundleIcons</span><br><span class="line">tagname:key tagvalue:CFBundleIcons~ipad</span><br><span class="line">tagname:key tagvalue:UILaunchStoryboardName</span><br><span class="line">tagname:key tagvalue:CFBundleSupportedPlatforms</span><br><span class="line">tagname:key tagvalue:MinimumOSVersion</span><br><span class="line">tagname:key tagvalue:ITSAppUsesNonExemptEncryption</span><br><span class="line">tagname:key tagvalue:NSLocationAlwaysAndWhenInUseUsageDescription</span><br><span class="line">tagname:key tagvalue:NSLocationWhenInUseUsageDescription</span><br><span class="line">tagname:key tagvalue:AdditionalElementA</span><br><span class="line">Match key AdditionalElementA.</span><br><span class="line">Delete element key,tagname:key value:AdditionalElementA.</span><br><span class="line">bIsDeleteElement is true!!!</span><br><span class="line">Delete element value,tagname:string value:this key is a AdditionalElementA element.</span><br><span class="line">tagname:key tagvalue:AdditionalElementB</span><br><span class="line">tagname:key tagvalue:CFBundleURLName</span><br><span class="line">tagname:key tagvalue:CFBundleURLSchemes</span><br><span class="line">tagname:key tagvalue:CFBundlePrimaryIcon</span><br><span class="line">tagname:key tagvalue:CFBundleIconFiles</span><br><span class="line">tagname:key tagvalue:CFBundleIconName</span><br><span class="line">tagname:key tagvalue:UIPrerenderedIcon</span><br><span class="line">tagname:key tagvalue:CFBundlePrimaryIcon</span><br><span class="line">tagname:key tagvalue:CFBundleIconFiles</span><br><span class="line">tagname:key tagvalue:CFBundleIconName</span><br><span class="line">tagname:key tagvalue:UIPrerenderedIcon</span><br><span class="line">add loopCount to 2</span><br><span class="line">count:2 SearchKey:AdditionalElementB</span><br><span class="line">tagname:key tagvalue:CFBundleURLTypes</span><br><span class="line">tagname:key tagvalue:CFBundleDevelopmentRegion</span><br><span class="line">tagname:key tagvalue:CFBundleDisplayName</span><br><span class="line">tagname:key tagvalue:CFBundleExecutable</span><br><span class="line">tagname:key tagvalue:CFBundleIdentifier</span><br><span class="line">tagname:key tagvalue:CFBundleInfoDictionaryVersion</span><br><span class="line">tagname:key tagvalue:CFBundleName</span><br><span class="line">tagname:key tagvalue:CFBundlePackageType</span><br><span class="line">tagname:key tagvalue:CFBundleSignature</span><br><span class="line">tagname:key tagvalue:CFBundleVersion</span><br><span class="line">tagname:key tagvalue:CFBundleShortVersionString</span><br><span class="line">tagname:key tagvalue:LSRequiresIPhoneOS</span><br><span class="line">tagname:key tagvalue:UIStatusBarHidden</span><br><span class="line">tagname:key tagvalue:UIFileSharingEnabled</span><br><span class="line">tagname:key tagvalue:UIRequiresFullScreen</span><br><span class="line">tagname:key tagvalue:UIViewControllerBasedStatusBarAppearance</span><br><span class="line">tagname:key tagvalue:UIInterfaceOrientation</span><br><span class="line">tagname:key tagvalue:UISupportedInterfaceOrientations</span><br><span class="line">tagname:key tagvalue:UIRequiredDeviceCapabilities</span><br><span class="line">tagname:key tagvalue:CFBundleIcons</span><br><span class="line">tagname:key tagvalue:CFBundleIcons~ipad</span><br><span class="line">tagname:key tagvalue:UILaunchStoryboardName</span><br><span class="line">tagname:key tagvalue:CFBundleSupportedPlatforms</span><br><span class="line">tagname:key tagvalue:MinimumOSVersion</span><br><span class="line">tagname:key tagvalue:ITSAppUsesNonExemptEncryption</span><br><span class="line">tagname:key tagvalue:NSLocationAlwaysAndWhenInUseUsageDescription</span><br><span class="line">tagname:key tagvalue:NSLocationWhenInUseUsageDescription</span><br><span class="line">tagname:key tagvalue:AdditionalElementAAA</span><br><span class="line">tagname:key tagvalue:AdditionalElementB</span><br><span class="line">Match key AdditionalElementB.</span><br><span class="line">Delete element key,tagname:key value:AdditionalElementB.</span><br><span class="line">bIsDeleteElement is true!!!</span><br><span class="line">Delete element value,tagname:string value:this key is a AdditionalElementB element.</span><br><span class="line">tagname:key tagvalue:CFBundleURLName</span><br><span class="line">tagname:key tagvalue:CFBundleURLSchemes</span><br><span class="line">tagname:key tagvalue:CFBundlePrimaryIcon</span><br><span class="line">tagname:key tagvalue:CFBundleIconFiles</span><br><span class="line">tagname:key tagvalue:CFBundleIconName</span><br><span class="line">tagname:key tagvalue:UIPrerenderedIcon</span><br><span class="line">tagname:key tagvalue:CFBundlePrimaryIcon</span><br><span class="line">tagname:key tagvalue:CFBundleIconFiles</span><br><span class="line">tagname:key tagvalue:CFBundleIconName</span><br><span class="line">tagname:key tagvalue:UIPrerenderedIcon</span><br><span class="line">the loop is finished!</span><br></pre></td></tr></table></figure>
<p>其实只要可以删除，就可以在删除之后自己通过 <code>addElements</code> 来再把已删除的元素添加一遍了，从而实现要修改的目的。</p>
<h3 id="为 IOS 添加 Framawork"><a href="# 为 IOS 添加 Framawork" class="headerlink" title="为 IOS 添加 Framawork"></a>为 IOS 添加 Framawork</h3><p>IOS 上的 <code>Framework</code> 有点类似于静态链接库的意思，相当于把<code>.a</code>+<code>.h</code>+ 资源打包到一块的集合体。更具体的区别描述请看：<a href="https://blog.csdn.net/lvxiangan/article/details/43115131">iOS 库 .a 与.framework 区别</a></p>
<p>在 UE 中以集成 IOS 上操作 Keycahin 的 <code>SSKeychain</code> 为例，在 Module 的 <code>build.cs</code> 中使用 <code>PublicAdditionalFrameworks</code> 来添加：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">PublicAdditionalFrameworks.Add(</span><br><span class="line">    <span class="keyword">new</span> Framework(</span><br><span class="line">        <span class="string">&quot;SSKeychain&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ThirdParty/IOS/SSKeychain.embeddedframework.zip&quot;</span>,</span><br><span class="line">        <span class="string">&quot;SSKeychain.framework/SSKeychain.bundle&quot;</span></span><br><span class="line">        )</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>构造 Framework 的第一个参数是名字，第二个是 framework 的路径（相对于 Module），第三个则是解压之后的 Framework 的 <code>bundle</code> 路径（如果 framework 没有 bundle 则可以忽略这个参数，而且就算有 bundle，但是不写这第三个参数貌似也没什么问题）。</p>
<p>这个可以打开 <code>SSKeychain.embeddedframework.zip</code> 文件看：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">SSKeychain.embeddedframework</span><br><span class="line">    └─SSKeychain.framework</span><br><span class="line">        │  Info.plist</span><br><span class="line">        │  SSKeychain</span><br><span class="line">        │</span><br><span class="line">        ├─Headers</span><br><span class="line">        │      SSKeychain.h</span><br><span class="line">        │      SSKeychainQuery.h</span><br><span class="line">        │</span><br><span class="line">        ├─Modules</span><br><span class="line">        │      <span class="keyword">module</span>.modulemap</span><br><span class="line">        │</span><br><span class="line">        ├─SSKeychain.bundle</span><br><span class="line">        │  └─en.lproj</span><br><span class="line">        │          SSKeychain.strings</span><br><span class="line">        │</span><br><span class="line">        └─_CodeSignature</span><br><span class="line">                CodeDirectory</span><br><span class="line">                CodeRequirements</span><br><span class="line">                CodeRequirements<span class="number">-1</span></span><br><span class="line">                CodeResources</span><br><span class="line">                CodeSignature</span><br></pre></td></tr></table></figure>

<p>相对于 <code>.framework</code> 的路径，这个路径一定要填正确，不然是不能用的，因为打包时会把这个 zip 解压出来，然后拷贝到包体中，路径指定错了就无法拷贝了。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">[<span class="number">2020.05</span><span class="number">.14</span><span class="number">-11.04</span><span class="number">.48</span>:<span class="number">324</span>][<span class="number">988</span>]UATHelper: <span class="built_in">Packaging</span> (iOS):     [<span class="number">2</span>/<span class="number">183</span>] sh Unzipping : /Users/zyhmac/UE4/Builds/ZHALIPENG/C/Users/imzlp/Documents/UnrealProjectSSD/MicroEnd_423/Plugins/PlatformUtils/Source/PlatformUtils/ThirdParty/IOS/SSKeychain.embeddedframework.zip -&gt; /Users/zyhmac/UE4/Builds/ZHALIPENG/D/UnrealEngine/Epic/UE_4<span class="number">.23</span>/Engine/Intermediate/UnzippedFrameworks/SSKeychain/SSKeychain.embeddedframework</span><br></pre></td></tr></table></figure>

<p>注意：不要在两个不同的模块里同时引入一个相同的第三方 framework 文件，不然会有以下错误（如我在插件 A 中引入了 <code>SSKeychain.embeddedframework.zip</code> 然后在相同工程的另一个插件 B 中也引入了它）。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Unable to merge actions producing SSKeychain.embeddedframework.extracted: prerequisites are different.</span><br></pre></td></tr></table></figure>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Mobile</category>
        <category>UPL</category>
      </categories>
      <tags>
        <tag>Mobile</tag>
        <tag>IOS</tag>
        <tag>UPL</tag>
      </tags>
  </entry>
  <entry>
    <title>Actor Replication Config</title>
    <url>/wiki/33631/</url>
    <content><![CDATA[<h3 id="Replication"><a href="#Replication" class="headerlink" title="Replication"></a>Replication</h3><p>OnlyRelecantToServer(default false)<br>if true,this actor is only relevant its owner,if this flag is changed during play,all non-owner channels would need to be explicitly close.</p>
<h3 id="Always-Relevant-default-false"><a href="#Always-Relevant-default-false" class="headerlink" title="Always Relevant(default false)"></a>Always Relevant(default false)</h3><p>Always relevant for network(overrides bOnlyRelevantToOwner)</p>
<h3 id="ReplicateMovement-default-true"><a href="#ReplicateMovement-default-true" class="headerlink" title="ReplicateMovement(default true)"></a>ReplicateMovement(default true)</h3><p>if true,replicate movement/location related properties.<br>Actor must also be set to replicate.</p>
<ol>
<li>see SetReplicates()</li>
<li>see <a href="https://doc.unrealengine.com/latest/INT/Gameplay/Networking/Replication/">https://doc.unrealengine.com/latest/INT/Gameplay/Networking/Replication/</a></li>
</ol>
<h3 id="NetLoadOnClient-default-true"><a href="#NetLoadOnClient-default-true" class="headerlink" title="NetLoadOnClient(default true)"></a>NetLoadOnClient(default true)</h3><p>This actor will be loaded on network clients during map load.</p>
<h3 id="NetUseOwnerReplovancy-default-false"><a href="#NetUseOwnerReplovancy-default-false" class="headerlink" title="NetUseOwnerReplovancy(default false)"></a>NetUseOwnerReplovancy(default false)</h3><p>If actor has valid Owner, call Owner’s IsNetRelevantFor and GetNetPriovity</p>
<h3 id="Replicates-default-true"><a href="#Replicates-default-true" class="headerlink" title="Replicates(default true)"></a>Replicates(default true)</h3><p>if true,this actor will replicate to remote machines<br>see SetReplicates()</p>
<h3 id="NetDormancy-default-DORM-Awake"><a href="#NetDormancy-default-DORM-Awake" class="headerlink" title="NetDormancy(default DORM_Awake)"></a>NetDormancy(default DORM_Awake)</h3><p>Dormancy setting for actor ro take itself off the replication list without being destory on clients.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// This actor can go dormant,but is not currently dormant,Game code will tell it when it go dormant.</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">ENetDormancy</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    DORM_Never,</span><br><span class="line">    DORM_Awake,</span><br><span class="line">    DORM_DormantAll,</span><br><span class="line">    DORM_DormantPartial,</span><br><span class="line">    DORM_Initial,</span><br><span class="line">    DORM_MAX,</span><br><span class="line">&#125;</span><br><span class="line">DORM_Never: This actor can never go network dormant.</span><br><span class="line">DORM_Awake: This actor can go dormant, but is <span class="keyword">not</span> currently dormant. Game code will tell it when it go dormant.</span><br><span class="line">DORM_DormantAll: This actor wants to go fully dormant <span class="keyword">for</span> all connections.</span><br><span class="line">DORM_DormantPartial: This actor may want to go dormant <span class="keyword">for</span> some connections, <span class="built_in">GetNetDormancy</span>() will be called to find out which.</span><br><span class="line">DORM_Initial: This actor is initially dormant <span class="keyword">for</span> all connection <span class="keyword">if</span> it was placed in map.</span><br><span class="line">DORM_MAX</span><br></pre></td></tr></table></figure>

<h3 id="NeuCullDistanceSquared-default-225000000-0"><a href="#NeuCullDistanceSquared-default-225000000-0" class="headerlink" title="NeuCullDistanceSquared(default 225000000.0)"></a>NeuCullDistanceSquared(default 225000000.0)</h3><p>Suqare of the max distance from the client’s viewpoint that this actor is relevant and will be replicated.</p>
<h3 id="NetUpdateFrequency-default-100-0"><a href="#NetUpdateFrequency-default-100-0" class="headerlink" title="NetUpdateFrequency(default 100.0)"></a>NetUpdateFrequency(default 100.0)</h3><p>how often(per second) this actor will be considered for replication,used to determine NetUpdateTime.</p>
<h3 id="MinNetUpdateFrequency-default-2-0"><a href="#MinNetUpdateFrequency-default-2-0" class="headerlink" title="MinNetUpdateFrequency(default 2.0)"></a>MinNetUpdateFrequency(default 2.0)</h3><p>Used to determine what rate to throttle down to when replicated properties are changing infrequently.</p>
<h3 id="NetPriority-default-3-0"><a href="#NetPriority-default-3-0" class="headerlink" title="NetPriority: (default 3.0)"></a>NetPriority: (default 3.0)</h3><p>Priority for this actor when checking for replication in a low bandwidth or saturated siuation,higher priority means it is more likely to replicate.</p>
<h3 id="Replicated-Movement"><a href="#Replicated-Movement" class="headerlink" title="Replicated Movement"></a>Replicated Movement</h3><p>LocationQuantization Level: (default EVectorQuantization::RoundTwoDecimals)</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">EVectorQuantization</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    RoundWholeNumber,</span><br><span class="line">    RoundOneDecimal,</span><br><span class="line">    RoundTwoDecimals,</span><br><span class="line">&#125;</span><br><span class="line">RoundWholeNumber: Each vector component will be rounded to the nearest whole number.</span><br><span class="line">RoundOneDecimal: Each vector component will be rounded, preserving one decimal place.</span><br><span class="line">RoundTwoDecimals: Each vector component will be rounded, preserving two decimal places.</span><br></pre></td></tr></table></figure>

<p>VelocityQuantization Level: (default ERotatorQuantization::RoundWholeNumber)</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">ERotatorQuantization</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ByteComponents,</span><br><span class="line">    ShortComponents,</span><br><span class="line">&#125;</span><br><span class="line">ByteComponents: The rotator will be compressed to <span class="number">8</span> bits per component.</span><br><span class="line">ShortComponents: The rotator will be compressed to <span class="number">16</span> bits per component.</span><br></pre></td></tr></table></figure>

<h3 id="RotationQuantization-Level-default-ByteComponents"><a href="#RotationQuantization-Level-default-ByteComponents" class="headerlink" title="RotationQuantization Level(default ByteComponents)"></a>RotationQuantization Level(default ByteComponents)</h3><p>Allow turing the compression level for replicated rotation.You should only need to change this from the default if you see visual artfacts.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">ERotatorQuantization</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ByteComponents,</span><br><span class="line">    ShortComponents,</span><br><span class="line">&#125;</span><br><span class="line">ByteComponents: The rotator will be compressed to <span class="number">8</span> bits per component.</span><br><span class="line">ShortComponents: The rotator will be compressed to <span class="number">16</span> bits per component.</span><br></pre></td></tr></table></figure>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Network</category>
        <category>DS</category>
      </categories>
  </entry>
  <entry>
    <title>HandleNetworkFailure</title>
    <url>/wiki/639023d5/</url>
    <content><![CDATA[<p>在 UE 中当网络连接出现错误时会调用 <code>UEngine::HandleNetworkFailure</code> 来接收错误消息和处理错误，错误的类型为枚举 <a href="https://api.unrealengine.com/INT/API/Runtime/Engine/Engine/ENetworkFailure__Type/index.html">ENetworkFailure::Type</a>, 标识了几种网络的错误类型。<br> 以 Server 拒绝玩家的加入为例，在 UE 的这套网络架构中，使用 <code>CreateSession</code>/<code>JoinSession</code> 的方式来创建 / 加入游戏，可以通过 <code>AGameModeBase::Prelogin</code> 以及 <code>overwrite</code> 了该成员函数的子类来拒绝玩家的加入，方法为返回的 <code>ErrorMessage</code> 不为空即为拒绝：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Accept or reject a player attempting to join the server.  Fails login if you set the ErrorMessage to a non-empty string.</span></span><br><span class="line"><span class="comment"> * PreLogin is called before Login.  Significant game time may pass before Login is called</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param	Options			The URL options (e.g. name/spectator) the player has passed</span></span><br><span class="line"><span class="comment"> * @param	Address			The network address of the player</span></span><br><span class="line"><span class="comment"> * @param	UniqueId		The unique id the player has passed to the server</span></span><br><span class="line"><span class="comment"> * @param	ErrorMessage	When set to a non-empty value, the player will be rejected using the error message set</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PreLogin</span><span class="params">(<span class="keyword">const</span> FString&amp; Options, <span class="keyword">const</span> FString&amp; Address, <span class="keyword">const</span> FUniqueNetIdRepl&amp; UniqueId, FString&amp; ErrorMessage)</span></span>;</span><br></pre></td></tr></table></figure>
<p>GameMode 的 PreLogin 调用栈为：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/25331/UE-GameMode-PreLogin-Callstack.webp"></p>
<p>当玩家被拒绝加入游戏时，服务器会发送给当前连接的客户端错误消息：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// call in server send to client</span></span><br><span class="line"><span class="comment">// function is UWorld::NotifyControlMessage</span></span><br><span class="line">FNetControlMessage&lt;NMT_Failure&gt;::<span class="built_in">Send</span>(Connection, ErrorMsg);</span><br></pre></td></tr></table></figure>
<p>PS：<code>FNetControlMessage&lt;T&gt;::Send</code>的实现是由 <code>DEFINE_CONTROL_CHANNEL_MESSAGE_ONEPARAM</code> 宏包裹的，其定义在文件 <code>DataChannel.h</code> 中。<br>该消息会发送到客户端上，通过 <code>UEngine::HandleNetworkError</code> 来使客户端来处理该错误，在其中会通知到 <code>UGameInstance::HandleNetworkError</code>，但是并没有把<code>ErrorMessage</code> 传递给 GameInstance, 我们可以通过继承 <code>UGameEngine</code> 重写 <code>HandleNetworkError</code> 来将 <code>ErrorMessage</code> 传递给外部。</p>
<p>PS: 玩家被拒绝之后会回到项目设置里的 <code>Game Default Map</code> 中。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Network</category>
        <category>DS</category>
      </categories>
      <tags>
        <tag>DS</tag>
      </tags>
  </entry>
  <entry>
    <title>UGameInstance::HandleNetworkError</title>
    <url>/wiki/5167fe85/</url>
    <content><![CDATA[<p>当网络链接出现错误时，会调用该函数 (服务端拒绝玩家加入时也会调用)。<br> 调用栈为（可以继承 UEngine 来替换 Engine 实现）：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">UEngine::HandleNetworkError -&gt; UEngine::HandleNetworkFailure_NotifyGameInstance -&gt; GameInstance-&gt;<span class="built_in">HandleNetworkError</span>(FailureType, bIsServer);</span><br></pre></td></tr></table></figure>
<p>VS 断点调用栈：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/25331/UE4-UEngine-HandleNetwokFailure-Callback-in-EditorEngine.webp"></p>
<p><code>UEngine::HandleNetworkFailure</code>实现为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime\Source\Runtime\Engine\Private\UnrealEngine.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UEngine::HandleNetworkFailure</span><span class="params">(UWorld *World, UNetDriver *NetDriver, ENetworkFailure::Type FailureType, <span class="keyword">const</span> FString&amp; ErrorString)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">UE_LOG</span>(LogNet, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;NetworkFailure: %s, Error: &#x27;%s&#x27;&quot;</span>), ENetworkFailure::<span class="built_in">ToString</span>(FailureType), *ErrorString);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!NetDriver)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Only handle failure at this level for game or pending net drivers.</span></span><br><span class="line">  FName NetDriverName = NetDriver-&gt;NetDriverName;</span><br><span class="line">  <span class="keyword">if</span> (NetDriverName == NAME_GameNetDriver || NetDriverName == NAME_PendingNetDriver)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// If this net driver has already been unregistered with this world, then don&#x27;t handle it.</span></span><br><span class="line">    <span class="keyword">if</span> (World)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">FindNamedNetDriver</span>(World, NetDriverName))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// This netdriver has already been destroyed (probably waiting for GC)</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Give the GameInstance a chance to handle the failure.</span></span><br><span class="line">    <span class="built_in">HandleNetworkFailure_NotifyGameInstance</span>(World, NetDriver, FailureType);</span><br><span class="line"></span><br><span class="line">    ENetMode FailureNetMode = NetDriver-&gt;<span class="built_in">GetNetMode</span>();  <span class="comment">// NetMode of the driver that failed</span></span><br><span class="line">    <span class="keyword">bool</span> bShouldTravel = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in"><span class="keyword">switch</span></span> (FailureType)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> ENetworkFailure::FailureReceived:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ENetworkFailure::PendingConnectionFailure:</span><br><span class="line">      <span class="comment">// TODO stop the connecting movie</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ENetworkFailure::ConnectionLost:</span><br><span class="line">      <span class="comment">// Hosts don&#x27;t travel when clients disconnect</span></span><br><span class="line">      bShouldTravel = (FailureNetMode == NM_Client);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ENetworkFailure::ConnectionTimeout:</span><br><span class="line">      <span class="comment">// Hosts don&#x27;t travel when clients disconnect</span></span><br><span class="line">      bShouldTravel = (FailureNetMode == NM_Client);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ENetworkFailure::NetGuidMismatch:</span><br><span class="line">    <span class="keyword">case</span> ENetworkFailure::NetChecksumMismatch:</span><br><span class="line">      <span class="comment">// Hosts don&#x27;t travel when clients have actor issues</span></span><br><span class="line">      bShouldTravel = (FailureNetMode == NM_Client);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ENetworkFailure::NetDriverAlreadyExists:</span><br><span class="line">    <span class="keyword">case</span> ENetworkFailure::NetDriverCreateFailure:</span><br><span class="line">    <span class="keyword">case</span> ENetworkFailure::OutdatedClient:</span><br><span class="line">    <span class="keyword">case</span> ENetworkFailure::OutdatedServer:</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bShouldTravel)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">CallHandleDisconnectForFailure</span>(World, NetDriver);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UEngine::HandleNetworkFailure_NotifyGameInstance</span><span class="params">(UWorld *World, UNetDriver *NetDriver, ENetworkFailure::Type FailureType)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">bool</span> bIsServer = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (NetDriver != <span class="literal">nullptr</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    bIsServer = NetDriver-&gt;<span class="built_in">GetNetMode</span>() != NM_Client;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (World != <span class="literal">nullptr</span> &amp;&amp; World-&gt;<span class="built_in">GetGameInstance</span>() != <span class="literal">nullptr</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    World-&gt;<span class="built_in">GetGameInstance</span>()-&gt;<span class="built_in">HandleNetworkError</span>(FailureType, bIsServer);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Since the UWorld passed in might be null, as well as the NetDriver&#x27;s UWorld,</span></span><br><span class="line">    <span class="comment">// go through the world contexts until we find the one with this net driver.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; Context : WorldList)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (Context.PendingNetGame != <span class="literal">nullptr</span> &amp;&amp;</span><br><span class="line">        Context.PendingNetGame-&gt;NetDriver == NetDriver &amp;&amp;</span><br><span class="line">        Context.OwningGameInstance != <span class="literal">nullptr</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// Use the GameInstance from the current context.</span></span><br><span class="line">        Context.OwningGameInstance-&gt;<span class="built_in">HandleNetworkError</span>(FailureType, bIsServer);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ENetworkFailure 的声明：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime\Engine\Classes\Engine\EngineBaseType.h</span></span><br><span class="line"><span class="comment">/** Types of network failures broadcast from the engine */</span></span><br><span class="line"><span class="built_in">UENUM</span>(BlueprintType)</span><br><span class="line"><span class="keyword">namespace</span> ENetworkFailure</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">Type</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		<span class="comment">/** A relevant net driver has already been created for this service */</span></span><br><span class="line">		NetDriverAlreadyExists,</span><br><span class="line">		<span class="comment">/** The net driver creation failed */</span></span><br><span class="line">		NetDriverCreateFailure,</span><br><span class="line">		<span class="comment">/** The net driver failed its Listen() call */</span></span><br><span class="line">		NetDriverListenFailure,</span><br><span class="line">		<span class="comment">/** A connection to the net driver has been lost */</span></span><br><span class="line">		ConnectionLost,</span><br><span class="line">		<span class="comment">/** A connection to the net driver has timed out */</span></span><br><span class="line">		ConnectionTimeout,</span><br><span class="line">		<span class="comment">/** The net driver received an NMT_Failure message */</span></span><br><span class="line">		FailureReceived,</span><br><span class="line">		<span class="comment">/** The client needs to upgrade their game */</span></span><br><span class="line">		OutdatedClient,</span><br><span class="line">		<span class="comment">/** The server needs to upgrade their game */</span></span><br><span class="line">		OutdatedServer,</span><br><span class="line">		<span class="comment">/** There was an error during connection to the game */</span></span><br><span class="line">		PendingConnectionFailure,</span><br><span class="line">		<span class="comment">/** NetGuid mismatch */</span></span><br><span class="line">		NetGuidMismatch,</span><br><span class="line">		<span class="comment">/** Network checksum mismatch */</span></span><br><span class="line">		NetChecksumMismatch</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Network</category>
        <category>DS</category>
      </categories>
      <tags>
        <tag>DS</tag>
      </tags>
  </entry>
  <entry>
    <title>Unreal Networking Guide</title>
    <url>/wiki/eac348f5/</url>
    <content><![CDATA[

	<div class="row">
    <embed src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210715095407.pdf" width="100%" height="1000px" type="application/pdf">
	</div>



<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Network</category>
        <category>DS</category>
      </categories>
      <tags>
        <tag>DS</tag>
      </tags>
  </entry>
  <entry>
    <title>Unreal Engine 4 Network Compendium</title>
    <url>/wiki/2e32e862/</url>
    <content><![CDATA[

	<div class="row">
    <embed src="https://img.imzlp.com/imgs/zlp/picgo/2021/Unreal_Engine_4_Network_Compendium.pdf" width="100%" height="1000px" type="application/pdf">
	</div>



<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Network</category>
        <category>DS</category>
      </categories>
      <tags>
        <tag>DS</tag>
      </tags>
  </entry>
  <entry>
    <title>UE 性能分析：内存优化</title>
    <url>/wiki/19135/</url>
    <content><![CDATA[<p>在开发游戏时，程序性能是需要着重考虑的问题，因为要尽可能覆盖最多的用户群体，就要考虑那些中低端设备的运行效果，兼容非常多配置差异的硬件，在这种情况下，怎么样分析和优化游戏的性能瓶颈是关键。</p>
<p>在运行时把更多的资源加载至内存中，本质上是一种空间换时间的思路。因为频繁从磁盘进行 IO 是非常耗时的，把资源预先加载到内存就可以实现高速读取，但是内存资源也是有限的，并不能不加限制地使用，尤其是对某些中低端移动设备而言，4G 甚至更小的内存的设备目前还具有不少的占有率，所以在内存方面不能浪费，而且过高的内存占用也有可能导致被系统查杀。</p>
<p>内存优化本质上就是在加载效率和内存占用之间寻求一个平衡，怎么样在能满足兼容更多低配设备正常运行不触发 OOM 的同时尽可能地把可利用的内存使用起来，提高程序的运行效率。</p>
<p>准备写几篇性能优化相关的文章，本篇文章先从 UE 内存分析入手，介绍常用的内存分析工具和方法，以及对 UE 项目中能够进行的内存优化手段做一个整理，这部分内容之前以笔记的形式记录在 <a href="https://imzlp.com/notes/ue/">notes/ue</a> 中，后续内存相关的内容都会补充到本篇文章。</p>
<span id="more"></span>

<p>内存优化其实主要就是从以下四个方面着手：</p>
<ol>
<li>排查内存泄漏</li>
<li>裁剪多余模块</li>
<li>优化现有模块的内存占用</li>
<li>有损优化：砍内容（素材质量等）</li>
</ol>
<p>三步走：查 bug、挤水分、砍需求。</p>
<h2 id="内存分析工具"><a href="# 内存分析工具" class="headerlink" title="内存分析工具"></a>内存分析工具 </h2><p> 所以，在进行内存优化之前，首先要能够对 UE 项目的内存分布有一个大概的了解，可以使用 UE 提供的内存分析工具以及一些 Native 平台的分析工具。</p>
<p>内存分析资料：</p>
<ul>
<li><a href="https://docs.unrealengine.com/zh-CN/ProductionPipelines/DevelopmentSetup/Tools/LowLevelMemoryTracker/index.html">LLM</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/61366273">UE4 内存 Profiler</a></li>
<li><a href="https://blog.csdn.net/xoyojank/article/details/82876508">Android 平台上的 Native 内存分析</a></li>
</ul>
<p>一些常用的 console command:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">stat</span> memory <span class="comment"># 显示引擎中各个子系统的内存占用</span></span><br><span class="line"><span class="built_in">stat</span> MemoryAllocator <span class="comment"># 显示内存分配信息</span></span><br><span class="line"><span class="built_in">stat</span> MemoryPlatform <span class="comment"># 显示平台内存信息</span></span><br><span class="line"><span class="built_in">stat</span> MemoryStaticMesh <span class="comment"># 显示静态模型的内存信息</span></span><br></pre></td></tr></table></figure>
<p>以及开启 LLM，在启动时加上 <code>-LLM</code> 参数</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-LLM <span class="comment"># 启用 LLM</span></span><br><span class="line">-LLMCSV <span class="comment"># 连续将所有值写入 CSV 文件。自动启用 -LLM。</span></span><br><span class="line">-llmtagsets=Assets <span class="comment"># 实验性功能。显示每个资源分配的内存总计。</span></span><br><span class="line">-llmtagsets=AssetClasses <span class="comment"># 实验性功能。显示每个 UObject 类类型的总计。</span></span><br></pre></td></tr></table></figure>

<p>然后就可以在运行时使用以下 console 命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">stat</span> llm <span class="comment"># 显示 LLM 摘要。所有较低级别的引擎统计信息都归入单个引擎统计信息。</span></span><br><span class="line"><span class="built_in">stat</span> llmfull <span class="comment"># 显示 LLM 所有统计信息</span></span><br><span class="line"><span class="built_in">stat</span> LLMPlatform <span class="comment"># 显示从 OS 分配的所有内存信息 </span></span><br><span class="line"><span class="built_in">stat</span> LLMOverhead <span class="comment"># 显示 LLM 内部使用的内存</span></span><br></pre></td></tr></table></figure>
<p>内存分析还可以使用以下工具：</p>
<ul>
<li>memreport</li>
<li>MemoryProfiler</li>
<li>Heapprofd(Android)</li>
<li>Instrument(IOS)</li>
</ul>
<p>在游戏的 console 中输入 <code>memreport</code>(-full) 会在 <code>Saved/Profiling/Memreports</code> 中创建地图目录以及 <code>.memreport</code> 文件，可以使用文本编辑器打开，能够看到游戏中各个部分的内存占用情况。</p>
<p>具体的内存分析工具的使用和对 UE 引擎中内存分配的分析流程有时间再详细补充，关于 LLM 的内容可以详情参考 UE 的文档。</p>
<h2 id="内存优化方案"><a href="# 内存优化方案" class="headerlink" title="内存优化方案"></a>内存优化方案 </h2><p> 以下列举的优化方式，其实都是可选的，并不是一定要把所有的都做了就最好，因为内存优化要兼顾效率，所以可以根据项目需求在不同的设备上控制要优化的功能，尽可能再保证功能一致地情况下对低端机进行适配。</p>
<p>这里主要列举 UE 中哪些部分可以被优化以及如果做，具体的优化数据有时间慢慢分析和补充。</p>
<h3 id="关闭不必要的功能支持"><a href="# 关闭不必要的功能支持" class="headerlink" title="关闭不必要的功能支持"></a>关闭不必要的功能支持 </h3><p> 根据需求可以裁剪以下的引擎模块支持：</p>
<ul>
<li>APEX：如果不使用 Nvidia 的 APEX 破碎系统，可以在编译引擎时去掉 APEX 的支持。可以在 BuildSetting 或者 TargetRules 设置<code>bCompileAPEX=true</code>。</li>
<li>Recast(NavMesh)：如果客户端在运行时不需要 Recast 的支持，并且不需要客户端本地进行 NavMesh 寻路操作，可以运行时裁剪掉 NavMesh 的支持。可以在 BuildSetting 或者 TargetRules 设置<code>bCompileRecast=true</code>。</li>
<li>FreeType：是否需要 FreeType 字库支持，可以在 BuildSetting 或者 TargetRules 设置<code>bCompileFreeType=true</code>。</li>
<li>ICU(unicode/i18n)：引擎 Core 模块中对 unicode/i18n 的支持，可以在 BuildSetting 或者 TargetRules 设置<code>bCompileICU=true</code>。</li>
<li>CompileForSize：UE 提供的优化选项，可以控制编译时严格控制大小，但是会牺牲性能。可以在 BuildSetting 或者 TargetRules 设置<code>bCompileForSize=true</code>。</li>
<li>CEF3：可选是否支持<code>Chromium Embedded Framework</code>，Google 的嵌入式浏览器支持。可以在 BuildSetting 或者 TargetRules 设置<code>bCompileCEF3=true</code>。</li>
<li>bUsesSteam：是否使用 Steam，手游可以关闭，在 TargetRules 中通过 <code>bUsesSteam</code> 控制。</li>
<li>SpeedTree：如果游戏中不需要使用 SpeedTree 进行植被建模，可以关闭编译 SpeedTree，通过 TargetRules 中的 <code>bOverrideCompileSpeedTree</code> 控制。</li>
<li>Audio 模块：如果项目使用 WWise 等作为音频播放接口，如果完全不需要引擎中内置的 Audio 模块，该部分功能是冗余的，可以裁剪掉。</li>
<li>国际化模块：如果游戏的多语言支持不依赖 UE 的文本采集和翻译功能，可以裁剪掉该模块。</li>
</ul>
<p>可以减少编译之后静态程序的大小以及减少不必要的执行逻辑。</p>
<h3 id="控制 AssetRegistry 的序列化"><a href="# 控制 AssetRegistry 的序列化" class="headerlink" title="控制 AssetRegistry 的序列化"></a>控制 AssetRegistry 的序列化</h3><p>AssetRegistry 其实主要是在 Editor 下用来方便进行资源的查找和过滤操作，它的主要使用者是 ContentBrowser，这一点在 UE 的文档中也有描述：<a href="https://docs.unrealengine.com/en-US/ProgrammingAndScripting/ProgrammingWithCPP/Assets/Registry/index.html">Asset Registry</a>。</p>
<p>对于项目而言在 Runtime 可能没有需求来使用它，但是在 <code>AssetRegistry</code> 模块一启动就会把 <code>AssetRegistry.bin</code> 加载到内存中，如果对它没有需求其实这部分内存是浪费的。</p>
<p>好在 UE 提供了不序列化或者部分序列化 AssetRegistry 数据的方法，在 <code>UAssetRegistryImpl</code> 的构造函数中会调用 <code>InitializeSerializationOptionsFromIni</code> 函数来读取 <code>DefaultEngine.ini</code> 中的配置，并会构造出一个 <code>FAssetRegistrySerializationOptions</code> 结构来存储，它会在后续的 <code>Serialize</code> 函数中使用，用来控制把哪部分的数据序列化到 <code>AssetRegistry</code> 中。</p>
<figure class="highlight cpp"><figcaption><span>Runtime/AssetRegistry/Private/AssetRegistry.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UAssetRegistryImpl::InitializeSerializationOptionsFromIni</span><span class="params">(FAssetRegistrySerializationOptions&amp; Options, <span class="keyword">const</span> FString&amp; PlatformIniName)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FConfigFile* EngineIni = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">  <span class="comment">// Use passed in platform, or current platform if empty</span></span><br><span class="line">  FConfigFile PlatformEngineIni;</span><br><span class="line">  FConfigCacheIni::<span class="built_in">LoadLocalIniFile</span>(PlatformEngineIni, <span class="built_in">TEXT</span>(<span class="string">&quot;Engine&quot;</span>), <span class="literal">true</span>, (!PlatformIniName.<span class="built_in">IsEmpty</span>() ? *PlatformIniName : <span class="built_in">ANSI_TO_TCHAR</span>(FPlatformProperties::<span class="built_in">IniPlatformName</span>())));</span><br><span class="line">  EngineIni = &amp;PlatformEngineIni;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="comment">// In cooked builds, always use the normal engine INI</span></span><br><span class="line">  EngineIni = GConfig-&gt;<span class="built_in">FindConfigFile</span>(GEngineIni);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bSerializeAssetRegistry&quot;</span>), Options.bSerializeAssetRegistry);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bSerializeDependencies&quot;</span>), Options.bSerializeDependencies);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bSerializeNameDependencies&quot;</span>), Options.bSerializeSearchableNameDependencies);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bSerializeManageDependencies&quot;</span>), Options.bSerializeManageDependencies);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bSerializePackageData&quot;</span>), Options.bSerializePackageData);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bUseAssetRegistryTagsWhitelistInsteadOfBlacklist&quot;</span>), Options.bUseAssetRegistryTagsWhitelistInsteadOfBlacklist);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bFilterAssetDataWithNoTags&quot;</span>), Options.bFilterAssetDataWithNoTags);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bFilterDependenciesWithNoTags&quot;</span>), Options.bFilterDependenciesWithNoTags);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bFilterSearchableNames&quot;</span>), Options.bFilterSearchableNames);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个控制方式可以在打包时控制是否生成 AssetRegistry.bin，以及控制在运行时反序列化哪些 AssetRegistry 的数据（但是不会对 DevelopmentAssetRegistry.bin 造成影响，可以用它来进行资产审计）。</p>
<p>它的反序列化流程为：</p>
<ol>
<li>检测 <code>bSerializeAssetRegistry</code>，如果为<code>true</code> 则把 AssetRegistry.bin 以二进制形式加载到内存中</li>
<li>通过 <code>Serialize</code> 函数来把二进制数据反序列化</li>
<li>释放加载 AssetRegistry.bin 所占用的内存</li>
</ol>
<p>所以，AssetRegistry 的内存占用是在序列化之后的数据，而 <code>FAssetRegistrySerializationOptions</code> 就是控制把哪些数据序列化的。</p>
<figure class="highlight cpp"><figcaption><span>Runtime/AssetRegistry/Public/AssetRegistryState.h</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">/** Load/Save options used to modify how the cache is serialized. These are read out of the AssetRegistry section of Engine.ini and can be changed per platform. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FAssetRegistrySerializationOptions</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/** True rather to load/save registry at all */</span></span><br><span class="line">  <span class="keyword">bool</span> bSerializeAssetRegistry;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** True rather to load/save dependency info. If true this will handle hard and soft package references */</span></span><br><span class="line">  <span class="keyword">bool</span> bSerializeDependencies;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** True rather to load/save dependency info for Name references,  */</span></span><br><span class="line">  <span class="keyword">bool</span> bSerializeSearchableNameDependencies;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** True rather to load/save dependency info for Manage references,  */</span></span><br><span class="line">  <span class="keyword">bool</span> bSerializeManageDependencies;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** If true will read/write FAssetPackageData */</span></span><br><span class="line">  <span class="keyword">bool</span> bSerializePackageData;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** True if CookFilterlistTagsByClass is a whitelist. False if it is a blacklist. */</span></span><br><span class="line">  <span class="keyword">bool</span> bUseAssetRegistryTagsWhitelistInsteadOfBlacklist;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** True if we want to only write out asset data if it has valid tags. This saves memory by not saving data for things like textures */</span></span><br><span class="line">  <span class="keyword">bool</span> bFilterAssetDataWithNoTags;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** True if we also want to filter out dependency data for assets that have no tags. Only filters if bFilterAssetDataWithNoTags is also true */</span></span><br><span class="line">  <span class="keyword">bool</span> bFilterDependenciesWithNoTags;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Filter out searchable names from dependency data */</span></span><br><span class="line">  <span class="keyword">bool</span> bFilterSearchableNames;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** The map of classname to tag set of tags that are allowed in cooked builds. This is either a whitelist or blacklist depending on bUseAssetRegistryTagsWhitelistInsteadOfBlacklist */</span></span><br><span class="line">  TMap&lt;FName, TSet&lt;FName&gt;&gt; CookFilterlistTagsByClass;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">FAssetRegistrySerializationOptions</span>()</span><br><span class="line">    : <span class="built_in">bSerializeAssetRegistry</span>(<span class="literal">false</span>)</span><br><span class="line">    , <span class="built_in">bSerializeDependencies</span>(<span class="literal">false</span>)</span><br><span class="line">    , <span class="built_in">bSerializeSearchableNameDependencies</span>(<span class="literal">false</span>)</span><br><span class="line">    , <span class="built_in">bSerializeManageDependencies</span>(<span class="literal">false</span>)</span><br><span class="line">    , <span class="built_in">bSerializePackageData</span>(<span class="literal">false</span>)</span><br><span class="line">    , <span class="built_in">bUseAssetRegistryTagsWhitelistInsteadOfBlacklist</span>(<span class="literal">false</span>)</span><br><span class="line">    , <span class="built_in">bFilterAssetDataWithNoTags</span>(<span class="literal">false</span>)</span><br><span class="line">    , <span class="built_in">bFilterDependenciesWithNoTags</span>(<span class="literal">false</span>)</span><br><span class="line">    , <span class="built_in">bFilterSearchableNames</span>(<span class="literal">false</span>)</span><br><span class="line">  &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Options used to read/write the DevelopmentAssetRegistry, which includes all data */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">ModifyForDevelopment</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    bSerializeAssetRegistry = bSerializeDependencies = bSerializeSearchableNameDependencies = bSerializeManageDependencies = bSerializePackageData = <span class="literal">true</span>;</span><br><span class="line">    <span class="built_in">DisableFilters</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Disable all filters */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">DisableFilters</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    bFilterAssetDataWithNoTags = <span class="literal">false</span>;</span><br><span class="line">    bFilterDependenciesWithNoTags = <span class="literal">false</span>;</span><br><span class="line">    bFilterSearchableNames = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>配置的读取在以下代码中：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/AssetRegistry/Private/AssetRegistry.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UAssetRegistryImpl::InitializeSerializationOptionsFromIni</span><span class="params">(FAssetRegistrySerializationOptions&amp; Options, <span class="keyword">const</span> FString&amp; PlatformIniName)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FConfigFile* EngineIni = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">  <span class="comment">// Use passed in platform, or current platform if empty</span></span><br><span class="line">  FConfigFile PlatformEngineIni;</span><br><span class="line">  FConfigCacheIni::<span class="built_in">LoadLocalIniFile</span>(PlatformEngineIni, <span class="built_in">TEXT</span>(<span class="string">&quot;Engine&quot;</span>), <span class="literal">true</span>, (!PlatformIniName.<span class="built_in">IsEmpty</span>() ? *PlatformIniName : <span class="built_in">ANSI_TO_TCHAR</span>(FPlatformProperties::<span class="built_in">IniPlatformName</span>())));</span><br><span class="line">  EngineIni = &amp;PlatformEngineIni;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="comment">// In cooked builds, always use the normal engine INI</span></span><br><span class="line">  EngineIni = GConfig-&gt;<span class="built_in">FindConfigFile</span>(GEngineIni);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bSerializeAssetRegistry&quot;</span>), Options.bSerializeAssetRegistry);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bSerializeDependencies&quot;</span>), Options.bSerializeDependencies);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bSerializeNameDependencies&quot;</span>), Options.bSerializeSearchableNameDependencies);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bSerializeManageDependencies&quot;</span>), Options.bSerializeManageDependencies);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bSerializePackageData&quot;</span>), Options.bSerializePackageData);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bUseAssetRegistryTagsWhitelistInsteadOfBlacklist&quot;</span>), Options.bUseAssetRegistryTagsWhitelistInsteadOfBlacklist);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bFilterAssetDataWithNoTags&quot;</span>), Options.bFilterAssetDataWithNoTags);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bFilterDependenciesWithNoTags&quot;</span>), Options.bFilterDependenciesWithNoTags);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bFilterSearchableNames&quot;</span>), Options.bFilterSearchableNames);</span><br><span class="line"></span><br><span class="line">  TArray&lt;FString&gt; FilterlistItems;</span><br><span class="line">  <span class="keyword">if</span> (Options.bUseAssetRegistryTagsWhitelistInsteadOfBlacklist)</span><br><span class="line">  &#123;</span><br><span class="line">    EngineIni-&gt;<span class="built_in">GetArray</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;CookedTagsWhitelist&quot;</span>), FilterlistItems);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    EngineIni-&gt;<span class="built_in">GetArray</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;CookedTagsBlacklist&quot;</span>), FilterlistItems);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// this only needs to be done once, and only on builds using USE_COMPACT_ASSET_REGISTRY</span></span><br><span class="line">    TArray&lt;FString&gt; AsFName;</span><br><span class="line">    EngineIni-&gt;<span class="built_in">GetArray</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;CookedTagsAsFName&quot;</span>), AsFName);</span><br><span class="line">    TArray&lt;FString&gt; AsPathName;</span><br><span class="line">    EngineIni-&gt;<span class="built_in">GetArray</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;CookedTagsAsPathName&quot;</span>), AsPathName);</span><br><span class="line">    TArray&lt;FString&gt; AsLocText;</span><br><span class="line">    EngineIni-&gt;<span class="built_in">GetArray</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;CookedTagsAsLocText&quot;</span>), AsLocText);</span><br><span class="line">    FAssetRegistryState::<span class="built_in">IngestIniSettingsForCompact</span>(AsFName, AsPathName, AsLocText);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>Config/DefaultEngine.ini</code> 中创建<code>AssetRegistry</code>Section 使用上面的名字就可以控制 AssetRegistry 的序列化，减少打包时的包体大小以及内存占用（AssetRegistry 在引擎启动时会加载到内存中）</p>
<figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="section">[AssetRegistry]</span></span><br><span class="line"><span class="attr">bSerializeAssetRegistry</span>=<span class="literal">false</span></span><br><span class="line"><span class="attr">bSerializeDependencies</span>=<span class="literal">false</span></span><br><span class="line"><span class="attr">bSerializeNameDependencies</span>=<span class="literal">false</span></span><br><span class="line"><span class="attr">bSerializeManageDependencies</span>=<span class="literal">false</span></span><br><span class="line"><span class="attr">bSerializePackageData</span>=<span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>也可以对某个平台来单独指定，只需要修改平台相关的 Ini 文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Config/Windows/WindowsEngine.ini</span><br><span class="line">Config/Android/AndroidEngine.ini</span><br><span class="line">Config/IOS/IOSEngine.ini</span><br></pre></td></tr></table></figure>


<h3 id="只加载所使用质量级别的 Shader"><a href="# 只加载所使用质量级别的 Shader" class="headerlink" title="只加载所使用质量级别的 Shader"></a>只加载所使用质量级别的 Shader</h3><p>默认情况下，引擎会把所有质量级别的 Shader 加载到内存中，在不需要实施切换画质的情况下，可以不加载未使用的质量级别，降低 Shader 的内存占用。</p>
<p>在<code>Project Settings</code>-<code>Engine</code>-<code>Rendering</code>-<code>Materials</code>-<code>Game Discards Unused Material Quality Levels</code>：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210324154036.webp"></p>
<p>或者在 <code>DefaultEngine.ini</code> 中添加以下配置：</p>
<figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="section">[/Script/Engine.RendererSettings]</span></span><br><span class="line"><span class="attr">r.DiscardUnusedQuality</span>=<span class="literal">True</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>When running in game mode, whether to keep shaders for all quality levels in memory or only those needed for the current quality level.</p>
</blockquote>
<ul>
<li>Unchecked: Keep all quality levels in memory allowing a runtime quality level change.(default)</li>
<li>Checked: Discard unused quality levels when loading content for the game, saving some memory.</li>
</ul>
<h3 id="减少 Shader 变体"><a href="# 减少 Shader 变体" class="headerlink" title="减少 Shader 变体"></a>减少 Shader 变体 </h3><p> 可以通过减少母材制的数量以及在 <code>Project Settings</code>-<code>Engine</code>-<code>Rendering</code> 中开启下列选项：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/19135/20210330152835.webp"></p>
<h3 id="ShareMaterialShaderCode"><a href="#ShareMaterialShaderCode" class="headerlink" title="ShareMaterialShaderCode"></a>ShareMaterialShaderCode</h3><p>在打包时可以在 <code>Project Settings</code>-<code>Packaging</code> 中设置 <code>Share Material Shader Code</code> 和<code>Shadred Material Native Libraries</code>可以减小包体的大小，并且会减少内存占用（增加加载时间）。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * By default shader code gets saved inline inside material assets, </span></span><br><span class="line"><span class="comment"> * enabling this option will store only shader code once as individual files</span></span><br><span class="line"><span class="comment"> * This will reduce overall package size but might increase loading time</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">UPROPERTY</span>(config, EditAnywhere, Category=Packaging)</span><br><span class="line"><span class="keyword">bool</span> bShareMaterialShaderCode;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * By default shader shader code gets saved into individual platform agnostic files,</span></span><br><span class="line"><span class="comment"> * enabling this option will use the platform-specific library format if and only if one is available</span></span><br><span class="line"><span class="comment"> * This will reduce overall package size but might increase loading time</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">UPROPERTY</span>(config, EditAnywhere, Category=Packaging, meta = (EditCondition = <span class="string">&quot;bShareMaterialShaderCode&quot;</span>, ConfigRestartRequired = <span class="literal">true</span>))</span><br><span class="line"><span class="keyword">bool</span> bSharedMaterialNativeLibraries;</span><br></pre></td></tr></table></figure>
<p>开启了之后打出的包中会生成下列文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ShaderArchive-Blank425-PCD3D_SM5.ushaderbytecode</span><br><span class="line">ShaderCode-Global-PCD3D_SM5.ushaderbytecode</span><br></pre></td></tr></table></figure>
<p>但是，如果开启之后如果后续的 Cook 资源 Shader 发生了变动，而基础包内还是旧的 ShaderBytecode 信息，会导致材质丢失。<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/pak-shadercode-error-in-ue425.webp"></p>
<p>有三个办法：</p>
<ol>
<li>后续的打包时可以把 Shaderbytecode 文件打包在 pak 中，挂载时加载；</li>
<li>Cook 热更资源时把 Shaderbytecode 打包在资源内；</li>
<li>创建 ShaderPatch，在热更后加载；</li>
</ol>
<p>热更 Shaderbytecode 更具体地实践流程可以在我之前对我文章 <a href="https://imzlp.com/posts/5867/">UE4 热更新：Create Shader Patch</a> 中查看。</p>
<h3 id="关闭 UMG 的模板化创建"><a href="# 关闭 UMG 的模板化创建" class="headerlink" title="关闭 UMG 的模板化创建"></a>关闭 UMG 的模板化创建 </h3><p> 引擎中有缓存蓝图控件加速创建的功能，但是会造成内存的浪费，可以配置关闭：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210324153016.webp"></p>
<p>也可以直接修改引擎中的代码使用类内初始化给予默认值：</p>
<figure class="highlight cpp"><figcaption><span>Source\Editor\UMGEditor\Public\WidgetBlueprint.h</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="built_in">UPROPERTY</span>(EditAnywhere, AdvancedDisplay, Category=WidgetBlueprintOptions, AssetRegistrySearchable)</span><br><span class="line"><span class="keyword">bool</span> bForceSlowConstructionPath;</span><br></pre></td></tr></table></figure>
<p>该变量在以下代码中被检测使用：</p>
<figure class="highlight cpp"><figcaption><span>Source\Editor\UMGEditor\Private\WidgetBlueprintCompiler.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FWidgetBlueprintCompilerContext::CanAllowTemplate</span><span class="params">(FCompilerResultsLog&amp; MessageLog, UWidgetBlueprintGeneratedClass* InClass)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// If this widget forces the slow construction path, we can&#x27;t template it.</span></span><br><span class="line">  <span class="keyword">if</span> (WidgetBP-&gt;bForceSlowConstructionPath)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (GetDefault&lt;UUMGEditorProjectSettings&gt;()-&gt;<span class="built_in">CompilerOption_CookSlowConstructionWidgetTree</span>(WidgetBP))</span><br><span class="line">    &#123;</span><br><span class="line">      MessageLog.<span class="built_in">Note</span>(*<span class="built_in">LOCTEXT</span>(<span class="string">&quot;ForceSlowConstruction&quot;</span>, <span class="string">&quot;Fast Templating Disabled By User.&quot;</span>).<span class="built_in">ToString</span>());</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      MessageLog.<span class="built_in">Error</span>(*<span class="built_in">LOCTEXT</span>(<span class="string">&quot;UnableToForceSlowConstruction&quot;</span>, <span class="string">&quot;This project has [Cook Slow Construction Widget Tree] disabled, so [Force Slow Construction Path] is no longer allowed.&quot;</span>).<span class="built_in">ToString</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="关闭 pakcache"><a href="# 关闭 pakcache" class="headerlink" title="关闭 pakcache"></a>关闭 pakcache</h3><p>引擎中默认启用了 PakCache 机制，在从 Pak 中读取文件时，会多读一段内存用作缓存，内存占用还是十分可观的（通过 <code>stat memory</code> 查看）：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210318202827.webp"></p>
<p>游戏启动时会有 PakCache 的 Log：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[2021.03.23-10.49.21:354][445]LogPakFile: Precache HighWater 16MB</span><br><span class="line">[2021.03.23-10.49.21:382][447]LogPakFile: Precache HighWater 32MB</span><br><span class="line">[2021.03.23-10.49.21:442][450]LogPakFile: Precache HighWater 48MB</span><br><span class="line">[2021.03.23-10.49.21:470][452]LogPakFile: Precache HighWater 64MB</span><br></pre></td></tr></table></figure>

<p>可以通过以下方式配置关闭：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[ConsoleVariables]</span></span><br><span class="line"><span class="attr">pakcache.Enable</span>=<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>关闭 PakCache 会带来频繁 IO 的问题，但是具体的性能影响细节要等有时间再来分析。</p>
<h3 id="Unload-pakentry-filenames"><a href="#Unload-pakentry-filenames" class="headerlink" title="Unload pakentry filenames"></a>Unload pakentry filenames</h3><p>从 UE4.23 开始，引擎中提供了 Mount PakFile 的内存优化配置：</p>
<figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="section">[Pak]</span></span><br><span class="line"><span class="attr">UnloadPakEntryFilenamesIfPossible</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">DirectoryRootsToKeepInMemoryWhenUnloadingPakEntryFilenames</span>=<span class="string">&quot;*/Config/Tags/&quot;</span></span><br><span class="line">+<span class="attr">DirectoryRootsToKeepInMemoryWhenUnloadingPakEntryFilenames</span>=<span class="string">&quot;*/Content/Localization/*&quot;</span></span><br><span class="line"><span class="attr">ShrinkPakEntriesMemoryUsage</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>在 FPakPlatformFile 执行 Initialize 的时候会绑定<code>FCoreDelegates::OnOptimizeMemoryUsageForMountedPaks</code>，可以调用该 Delegate 来通知 PakPlatformFile 来优化已 mount 的 Pak 的内存。</p>
<figure class="highlight cpp"><figcaption><span>Runtime\PakFile\Private\IPlatformFilePak.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FPakPlatformFile::OptimizeMemoryUsageForMountedPaks</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !(IS_PROGRAM || WITH_EDITOR)</span></span><br><span class="line">	FSlowHeartBeatScope SuspendHeartBeat;</span><br><span class="line">	<span class="keyword">bool</span> bUnloadPakEntryFilenamesIfPossible = FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;unloadpakentryfilenames&quot;</span>));</span><br><span class="line">	GConfig-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Pak&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;UnloadPakEntryFilenamesIfPossible&quot;</span>), bUnloadPakEntryFilenamesIfPossible, GEngineIni);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((bUnloadPakEntryFilenamesIfPossible &amp;&amp; !FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;nounloadpakentries&quot;</span>))) || FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;unloadpakentries&quot;</span>)))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// With [Pak] UnloadPakEntryFilenamesIfPossible enabled, [Pak] DirectoryRootsToKeepInMemoryWhenUnloadingPakEntryFilenames</span></span><br><span class="line">		<span class="comment">// can contain pak entry directory wildcards of which the entire recursive directory structure of filenames underneath a</span></span><br><span class="line">		<span class="comment">// matching wildcard will be kept.</span></span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		<span class="comment">// Example:</span></span><br><span class="line">		<span class="comment">//   [Pak]</span></span><br><span class="line">		<span class="comment">//   DirectoryRootsToKeepInMemoryWhenUnloadingPakEntryFilenames=&quot;*/Config/Tags/&quot;</span></span><br><span class="line">		<span class="comment">//   +DirectoryRootsToKeepInMemoryWhenUnloadingPakEntryFilenames=&quot;*/Content/Localization/*&quot;</span></span><br><span class="line">		TArray&lt;FString&gt; DirectoryRootsToKeep;</span><br><span class="line">		GConfig-&gt;<span class="built_in">GetArray</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Pak&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;DirectoryRootsToKeepInMemoryWhenUnloadingPakEntryFilenames&quot;</span>), DirectoryRootsToKeep, GEngineIni);</span><br><span class="line"></span><br><span class="line">		FPakPlatformFile* PakPlatformFile = (FPakPlatformFile*)(FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">FindPlatformFile</span>(FPakPlatformFile::<span class="built_in">GetTypeName</span>()));</span><br><span class="line">		PakPlatformFile-&gt;<span class="built_in">UnloadPakEntryFilenames</span>(&amp;DirectoryRootsToKeep);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> bShrinkPakEntriesMemoryUsage = FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;shrinkpakentries&quot;</span>));</span><br><span class="line">	GConfig-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Pak&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;ShrinkPakEntriesMemoryUsage&quot;</span>), bShrinkPakEntriesMemoryUsage, GEngineIni);</span><br><span class="line">	<span class="keyword">if</span> (bShrinkPakEntriesMemoryUsage)</span><br><span class="line">	&#123;</span><br><span class="line">		FPakPlatformFile* PakPlatformFile = (FPakPlatformFile*)(FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">FindPlatformFile</span>(FPakPlatformFile::<span class="built_in">GetTypeName</span>()));</span><br><span class="line">		PakPlatformFile-&gt;<span class="built_in">ShrinkPakEntriesMemoryUsage</span>();</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>UnloadPakEntryFilenamesIfPossible：允许卸载 PakEntry filenames 占用的内存</li>
<li>DirectoryRootsToKeepInMemoryWhenUnloadingPakEntryFilenames：卸载 PakEntry filename 时要保留的目录</li>
<li>bShrinkPakEntriesMemoryUsage：缩小 PakEntry 的内存占用</li>
</ul>
<p>当调用之后，如果开启 <code>UnloadPakEntryFilenamesIfPossible</code> 了，会通过计算 Pak 中文件名列表的 Hash 来节省内存，但是卸载 PakEntry filenames 之后无法再使用路径的通配符匹配。</p>
<figure class="highlight cpp"><figcaption><span>Runtime\PakFile\Public\IPlatformFilePak.h</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">/** Iterator class used to iterate over all files in pak. */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FFileIterator</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  	<span class="comment">// ...</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Saves memory by hashing the filenames, if possible. After this process,</span></span><br><span class="line"><span class="comment">	 * wildcard scanning of pak entries can no longer be performed. Returns TRUE</span></span><br><span class="line"><span class="comment">	 * if the process successfully unloaded filenames from this pak</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param CrossPakCollisionChecker A map of hash-&gt;fileentry records encountered during filename unloading on other pak files. Used to detect collisions with entries in other pak files.</span></span><br><span class="line"><span class="comment">	 * @param DirectoryRootsToKeep An array of strings in wildcard format that specify whole directory structures of filenames to keep in memory for directory iteration to work.</span></span><br><span class="line"><span class="comment">	 * @param bAllowRetries If a collision is encountered, change the intial seed and try again a fixed number of times before failing</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">UnloadPakEntryFilenames</span><span class="params">(TMap&lt;uint64, FPakEntry&gt;&amp; CrossPakCollisionChecker, TArray&lt;FString&gt;* DirectoryRootsToKeep = <span class="literal">nullptr</span>, <span class="keyword">bool</span> bAllowRetries = <span class="literal">true</span>)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="压缩 Texture"><a href="# 压缩 Texture" class="headerlink" title="压缩 Texture"></a>压缩 Texture</h3><p>Texture 的压缩是有损压缩，能够减小包体大小以及加载到内存中的大小，虽然是有损压缩，但是在移动端质量降低的效果并不明显，可以根据项目情况进行设置。</p>
<p>之前的笔记中，提到过可以在 <code>Project Settings</code>-<code>Cooker</code>-<code>Texture</code>-<code>ASTC Compression vs Size</code> 可以设置默认的资源质量和大小的级别： </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0=12x12 </span><br><span class="line">1=10x10 </span><br><span class="line">2=8x8 </span><br><span class="line">3=6x6 </span><br><span class="line">4=4x4 </span><br></pre></td></tr></table></figure>
<p>在 Texture 的资源编辑中也可以针对某个 Texture 单独设置： </p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210112154624.webp">  </p>
<p>Lowest-&gt;Hightest 对应着 <code>0-4</code> 的值，使用 Default 则使用项目设置中的配置。  </p>
<p>并且，设置 <code>Compression Settings</code> 的类型也会对资源压缩的类型有差别，Default 则是项目设置中的参数，如果设置成 NormalMap 的类型会是 <code>ASTC_4x4</code> 的。 </p>
<ul>
<li><a href="https://developer.nvidia.com/astc-texture-compression-for-game-assets#_Toc398571904">Using ASTC Texture Compression for Game Assets</a> </li>
<li><a href="https://docs.unrealengine.com/en-US/RenderingAndGraphics/Textures/TextureCompressionSettings/index.html">Texture Compression Settings</a> </li>
</ul>
<h2 id="UPDATE"><a href="#UPDATE" class="headerlink" title="UPDATE"></a>UPDATE</h2><p>使用 Github Gist 管理的动态更新内容，在国内网络可能会无法查看。</p>
<script src="https://gist.github.com/imzlp/a76e3efd1ff6b7ea69da006823504cf7.js"></script>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Optimization</category>
        <category>Memory</category>
      </categories>
      <tags>
        <tag>Optimization</tag>
        <tag>Profiling</tag>
        <tag>Memory</tag>
        <tag>内存优化</tag>
      </tags>
  </entry>
  <entry>
    <title>控制 AssetRegistry 的序列化</title>
    <url>/wiki/41006/</url>
    <content><![CDATA[<p>AssetRegistry 其实主要是在 Editor 下用来方便进行资源的查找和过滤操作，它的主要使用者是 ContentBrowser，这一点在 UE 的文档中也有描述：<a href="https://docs.unrealengine.com/en-US/ProgrammingAndScripting/ProgrammingWithCPP/Assets/Registry/index.html">Asset Registry</a>。</p>
<p>对于项目而言在 Runtime 可能没有需求来使用它，但是在 <code>AssetRegistry</code> 模块一启动就会把 <code>AssetRegistry.bin</code> 加载到内存中，如果对它没有需求其实这部分内存是浪费的。</p>
<blockquote>
<p>关闭 AssetRegistry 的影响：无法在运行时通过 AssetRegistry 模块进行资源的依赖分析、以及通过 AssetRegistry 检测资源是否存在的判断。</p>
</blockquote>
<p>好在 UE 提供了不序列化或者部分序列化 AssetRegistry 数据的方法，在 <code>UAssetRegistryImpl</code> 的构造函数中会调用 <code>InitializeSerializationOptionsFromIni</code> 函数来读取 <code>DefaultEngine.ini</code> 中的配置，并会构造出一个 <code>FAssetRegistrySerializationOptions</code> 结构来存储，它会在后续的 <code>Serialize</code> 函数中使用，用来控制把哪部分的数据序列化到 <code>AssetRegistry</code> 中。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime/AssetRegistry/Private/AssetRegistry.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UAssetRegistryImpl::InitializeSerializationOptionsFromIni</span><span class="params">(FAssetRegistrySerializationOptions&amp; Options, <span class="keyword">const</span> FString&amp; PlatformIniName)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FConfigFile* EngineIni = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">  <span class="comment">// Use passed in platform, or current platform if empty</span></span><br><span class="line">  FConfigFile PlatformEngineIni;</span><br><span class="line">  FConfigCacheIni::<span class="built_in">LoadLocalIniFile</span>(PlatformEngineIni, <span class="built_in">TEXT</span>(<span class="string">&quot;Engine&quot;</span>), <span class="literal">true</span>, (!PlatformIniName.<span class="built_in">IsEmpty</span>() ? *PlatformIniName : <span class="built_in">ANSI_TO_TCHAR</span>(FPlatformProperties::<span class="built_in">IniPlatformName</span>())));</span><br><span class="line">  EngineIni = &amp;PlatformEngineIni;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="comment">// In cooked builds, always use the normal engine INI</span></span><br><span class="line">  EngineIni = GConfig-&gt;<span class="built_in">FindConfigFile</span>(GEngineIni);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bSerializeAssetRegistry&quot;</span>), Options.bSerializeAssetRegistry);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bSerializeDependencies&quot;</span>), Options.bSerializeDependencies);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bSerializeNameDependencies&quot;</span>), Options.bSerializeSearchableNameDependencies);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bSerializeManageDependencies&quot;</span>), Options.bSerializeManageDependencies);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bSerializePackageData&quot;</span>), Options.bSerializePackageData);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bUseAssetRegistryTagsWhitelistInsteadOfBlacklist&quot;</span>), Options.bUseAssetRegistryTagsWhitelistInsteadOfBlacklist);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bFilterAssetDataWithNoTags&quot;</span>), Options.bFilterAssetDataWithNoTags);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bFilterDependenciesWithNoTags&quot;</span>), Options.bFilterDependenciesWithNoTags);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bFilterSearchableNames&quot;</span>), Options.bFilterSearchableNames);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个控制方式可以在打包时控制是否生成 AssetRegistry.bin，以及控制在运行时反序列化哪些 AssetRegistry 的数据（但是不会对 DevelopmentAssetRegistry.bin 造成影响，可以用它来进行资产审计）。</p>
<p>它的反序列化流程为：</p>
<ol>
<li>检测 <code>bSerializeAssetRegistry</code>，如果为<code>true</code> 则把 AssetRegistry.bin 以二进制形式加载到内存中</li>
<li>通过 <code>Serialize</code> 函数来把二进制数据反序列化</li>
<li>释放加载 AssetRegistry.bin 所占用的内存</li>
</ol>
<p>所以，AssetRegistry 的内存占用是在序列化之后的数据，而 <code>FAssetRegistrySerializationOptions</code> 就是控制把哪些数据序列化的。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime/AssetRegistry/Public/AssetRegistryState.h</span></span><br><span class="line"><span class="comment">/** Load/Save options used to modify how the cache is serialized. These are read out of the AssetRegistry section of Engine.ini and can be changed per platform. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FAssetRegistrySerializationOptions</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/** True rather to load/save registry at all */</span></span><br><span class="line">  <span class="keyword">bool</span> bSerializeAssetRegistry;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** True rather to load/save dependency info. If true this will handle hard and soft package references */</span></span><br><span class="line">  <span class="keyword">bool</span> bSerializeDependencies;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** True rather to load/save dependency info for Name references,  */</span></span><br><span class="line">  <span class="keyword">bool</span> bSerializeSearchableNameDependencies;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** True rather to load/save dependency info for Manage references,  */</span></span><br><span class="line">  <span class="keyword">bool</span> bSerializeManageDependencies;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** If true will read/write FAssetPackageData */</span></span><br><span class="line">  <span class="keyword">bool</span> bSerializePackageData;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** True if CookFilterlistTagsByClass is a whitelist. False if it is a blacklist. */</span></span><br><span class="line">  <span class="keyword">bool</span> bUseAssetRegistryTagsWhitelistInsteadOfBlacklist;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** True if we want to only write out asset data if it has valid tags. This saves memory by not saving data for things like textures */</span></span><br><span class="line">  <span class="keyword">bool</span> bFilterAssetDataWithNoTags;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** True if we also want to filter out dependency data for assets that have no tags. Only filters if bFilterAssetDataWithNoTags is also true */</span></span><br><span class="line">  <span class="keyword">bool</span> bFilterDependenciesWithNoTags;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Filter out searchable names from dependency data */</span></span><br><span class="line">  <span class="keyword">bool</span> bFilterSearchableNames;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** The map of classname to tag set of tags that are allowed in cooked builds. This is either a whitelist or blacklist depending on bUseAssetRegistryTagsWhitelistInsteadOfBlacklist */</span></span><br><span class="line">  TMap&lt;FName, TSet&lt;FName&gt;&gt; CookFilterlistTagsByClass;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">FAssetRegistrySerializationOptions</span>()</span><br><span class="line">    : <span class="built_in">bSerializeAssetRegistry</span>(<span class="literal">false</span>)</span><br><span class="line">    , <span class="built_in">bSerializeDependencies</span>(<span class="literal">false</span>)</span><br><span class="line">    , <span class="built_in">bSerializeSearchableNameDependencies</span>(<span class="literal">false</span>)</span><br><span class="line">    , <span class="built_in">bSerializeManageDependencies</span>(<span class="literal">false</span>)</span><br><span class="line">    , <span class="built_in">bSerializePackageData</span>(<span class="literal">false</span>)</span><br><span class="line">    , <span class="built_in">bUseAssetRegistryTagsWhitelistInsteadOfBlacklist</span>(<span class="literal">false</span>)</span><br><span class="line">    , <span class="built_in">bFilterAssetDataWithNoTags</span>(<span class="literal">false</span>)</span><br><span class="line">    , <span class="built_in">bFilterDependenciesWithNoTags</span>(<span class="literal">false</span>)</span><br><span class="line">    , <span class="built_in">bFilterSearchableNames</span>(<span class="literal">false</span>)</span><br><span class="line">  &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Options used to read/write the DevelopmentAssetRegistry, which includes all data */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">ModifyForDevelopment</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    bSerializeAssetRegistry = bSerializeDependencies = bSerializeSearchableNameDependencies = bSerializeManageDependencies = bSerializePackageData = <span class="literal">true</span>;</span><br><span class="line">    <span class="built_in">DisableFilters</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Disable all filters */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">DisableFilters</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    bFilterAssetDataWithNoTags = <span class="literal">false</span>;</span><br><span class="line">    bFilterDependenciesWithNoTags = <span class="literal">false</span>;</span><br><span class="line">    bFilterSearchableNames = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>配置的读取在以下代码中：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime/AssetRegistry/Private/AssetRegistry.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UAssetRegistryImpl::InitializeSerializationOptionsFromIni</span><span class="params">(FAssetRegistrySerializationOptions&amp; Options, <span class="keyword">const</span> FString&amp; PlatformIniName)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FConfigFile* EngineIni = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">  <span class="comment">// Use passed in platform, or current platform if empty</span></span><br><span class="line">  FConfigFile PlatformEngineIni;</span><br><span class="line">  FConfigCacheIni::<span class="built_in">LoadLocalIniFile</span>(PlatformEngineIni, <span class="built_in">TEXT</span>(<span class="string">&quot;Engine&quot;</span>), <span class="literal">true</span>, (!PlatformIniName.<span class="built_in">IsEmpty</span>() ? *PlatformIniName : <span class="built_in">ANSI_TO_TCHAR</span>(FPlatformProperties::<span class="built_in">IniPlatformName</span>())));</span><br><span class="line">  EngineIni = &amp;PlatformEngineIni;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="comment">// In cooked builds, always use the normal engine INI</span></span><br><span class="line">  EngineIni = GConfig-&gt;<span class="built_in">FindConfigFile</span>(GEngineIni);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bSerializeAssetRegistry&quot;</span>), Options.bSerializeAssetRegistry);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bSerializeDependencies&quot;</span>), Options.bSerializeDependencies);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bSerializeNameDependencies&quot;</span>), Options.bSerializeSearchableNameDependencies);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bSerializeManageDependencies&quot;</span>), Options.bSerializeManageDependencies);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bSerializePackageData&quot;</span>), Options.bSerializePackageData);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bUseAssetRegistryTagsWhitelistInsteadOfBlacklist&quot;</span>), Options.bUseAssetRegistryTagsWhitelistInsteadOfBlacklist);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bFilterAssetDataWithNoTags&quot;</span>), Options.bFilterAssetDataWithNoTags);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bFilterDependenciesWithNoTags&quot;</span>), Options.bFilterDependenciesWithNoTags);</span><br><span class="line">  EngineIni-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bFilterSearchableNames&quot;</span>), Options.bFilterSearchableNames);</span><br><span class="line"></span><br><span class="line">  TArray&lt;FString&gt; FilterlistItems;</span><br><span class="line">  <span class="keyword">if</span> (Options.bUseAssetRegistryTagsWhitelistInsteadOfBlacklist)</span><br><span class="line">  &#123;</span><br><span class="line">    EngineIni-&gt;<span class="built_in">GetArray</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;CookedTagsWhitelist&quot;</span>), FilterlistItems);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    EngineIni-&gt;<span class="built_in">GetArray</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;CookedTagsBlacklist&quot;</span>), FilterlistItems);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// this only needs to be done once, and only on builds using USE_COMPACT_ASSET_REGISTRY</span></span><br><span class="line">    TArray&lt;FString&gt; AsFName;</span><br><span class="line">    EngineIni-&gt;<span class="built_in">GetArray</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;CookedTagsAsFName&quot;</span>), AsFName);</span><br><span class="line">    TArray&lt;FString&gt; AsPathName;</span><br><span class="line">    EngineIni-&gt;<span class="built_in">GetArray</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;CookedTagsAsPathName&quot;</span>), AsPathName);</span><br><span class="line">    TArray&lt;FString&gt; AsLocText;</span><br><span class="line">    EngineIni-&gt;<span class="built_in">GetArray</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;CookedTagsAsLocText&quot;</span>), AsLocText);</span><br><span class="line">    FAssetRegistryState::<span class="built_in">IngestIniSettingsForCompact</span>(AsFName, AsPathName, AsLocText);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>Config/DefaultEngine.ini</code> 中创建<code>AssetRegistry</code>Section 使用上面的名字就可以控制 AssetRegistry 的序列化，减少打包时的包体大小以及内存占用（AssetRegistry 在引擎启动时会加载到内存中）</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[AssetRegistry]</span></span><br><span class="line"><span class="attr">bSerializeAssetRegistry</span>=<span class="literal">false</span></span><br><span class="line"><span class="attr">bSerializeDependencies</span>=<span class="literal">false</span></span><br><span class="line"><span class="attr">bSerializeNameDependencies</span>=<span class="literal">false</span></span><br><span class="line"><span class="attr">bSerializeManageDependencies</span>=<span class="literal">false</span></span><br><span class="line"><span class="attr">bSerializePackageData</span>=<span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>也可以对某个平台来单独指定，只需要修改平台相关的 Ini 文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Config/Windows/WindowsEngine.ini</span><br><span class="line">Config/Android/AndroidEngine.ini</span><br><span class="line">Config/IOS/IOSEngine.ini</span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Optimization</category>
        <category>Memory</category>
      </categories>
      <tags>
        <tag>Optimization</tag>
        <tag>Memory</tag>
        <tag>AssetRegistry</tag>
      </tags>
  </entry>
  <entry>
    <title>创建异步 Blueprint 节点</title>
    <url>/wiki/34346/</url>
    <content><![CDATA[<p>在工程中有一些异步操作的需求，比如下载文件的行为，一个下载命令等待下载完成之后回调，而且要尽量避免太多的事件绑定和解绑操作。<br>在蓝图的节点中有一些异步的操作，比如 <code>PlayMontage</code>/<code>DownloadImage</code> 等，都是异步操作中有多个输出节点的:<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/3380/bp-node-playmontage-and-downloadImage.webp"><br>我们能不能自己写一个这样的异步操作的节点呢？那必然是可以的。<br>可以在 <code>Engine\Source\Runtime\UMG\Public\Blueprint\AsyncTaskDownloadImage.h</code> 中查看 <a href="https://api.unrealengine.com/INT/BlueprintAPI/Class/AsyncTaskDownloadImage/DownloadImage/index.html">DownloadImage</a> 节点的实现 (<a href="https://api.unrealengine.com/INT/API/Runtime/UMG/Blueprint/UAsyncTaskDownloadImage/index.html">C++API</a>)。<br> 可以自己仿照这自己写一个出来：</p>
<ol>
<li>关键就是要继承<code>UBlueprintAsyncActionBase</code>，这个是必须的。</li>
<li>然后写一个 <code>static</code> 的函数，返回类的指针，并用 <code>UFUNCTION</code> 的<code>mate</code>标记为<code>BlueprintInternalUseOnly=&quot;true&quot;</code></li>
<li>声明并定义几个派发器成员，这些派发器成员就是异步的节点，也就是蓝图节点右侧的 exec 节点。</li>
</ol>
<p>我们先来看一下 <code>DownloadImage</code> 的声明:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UTexture2DDynamic</span>;</span></span><br><span class="line"><span class="built_in">DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam</span>(FDownloadImageDelegate, UTexture2DDynamic*, Texture);</span><br><span class="line"></span><br><span class="line"><span class="built_in">UCLASS</span>()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UMG_API</span> <span class="title">UAsyncTaskDownloadImage</span> :</span> <span class="keyword">public</span> UBlueprintAsyncActionBase</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_UCLASS_BODY</span>()</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintCallable, meta=( BlueprintInternalUseOnly=<span class="string">&quot;true&quot;</span> ))</span><br><span class="line">	<span class="function"><span class="keyword">static</span> UAsyncTaskDownloadImage* <span class="title">DownloadImage</span><span class="params">(FString URL)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">UPROPERTY</span>(BlueprintAssignable)</span><br><span class="line">	FDownloadImageDelegate OnSuccess;</span><br><span class="line">	<span class="built_in">UPROPERTY</span>(BlueprintAssignable)</span><br><span class="line">	FDownloadImageDelegate OnFail;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span><span class="params">(FString URL)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">/** Handles image requests coming from the web */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">HandleImageRequest</span><span class="params">(FHttpRequestPtr HttpRequest, FHttpResponsePtr HttpResponse, <span class="keyword">bool</span> bSucceeded)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>对比上面的 DownloadImage 的节点，可以看到：<br>0. 首先声明了一个动态多播代理<code>FDownloadImageDelegate</code>，并且需要传入一个参数</p>
<ol>
<li><code>UAsyncTaskDownloadImage</code>类中声明了两个事件派发器 <code>OnSuccess</code> 和<code>OnFail</code>，这也是蓝图节点右侧的 Exec 和参数<code>Texture</code>，本质都是派发器(动态多播代理)</li>
<li><code>UAsyncTaskDownloadImage</code>的 <code>static</code> 函数 <code>DownloadImage</code> 接收一个 FString 的参数，返回一个<code>UAsyncTaskDownloadImage*</code>，这个返回就是把派发器的执行节点在蓝图中显示出来</li>
</ol>
<p>即：声明的动态多播的成员和该多播的参数都会显示在蓝图节点的右侧。</p>
<p>我自己实现了一个异步行为的操作，先在蓝图中看操作：<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/3380/create-async-task-and-action.webp"><br>行为就是，先创建一个 <code>AsyncActionObject</code> 的对象作为后期触发异步操作的对象，然后执行 <code>CreateAsyncTask</code> 里面对上一步创建的 <code>AsyncActionObject</code> 进行事件绑定。<br>然后我们就可以在那个 ActionObj 调用 <code>OnActionStart</code> 之类的操作就可以调用 <code>CreateAsyncTask</code> 右侧的相关节点。<br>注意：我做的限制是，一个对象对应一个 Task, 如果当前传入的 <code>AsyncActionObject</code> 正在被其他的 task 绑定，则创建 task 会失败。<br>然后就是代码：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AsyncTask.h</span></span><br><span class="line"><span class="comment">// Copyright 1998-2017 Epic Games, Inc. All Rights Reserved.</span></span><br><span class="line"><span class="comment">// Copyright 1998-2017 Epic Games, Inc. All Rights Reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;AsyncActionObject.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// unreal header</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Array.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Kismet/KismetSystemLibrary.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;UObject/ObjectMacros.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Kismet/BlueprintAsyncActionBase.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;AsyncTask.generated.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PRINT_LOG</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRINT_LOG(lOG_TEXT) UKismetSystemLibrary::PrintString(this,lOG_TEXT,true,true);</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PRINT_ASYNC_ACTION_TOOLS_DEBUG_INFO</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRINT_ASYNC_ACTION_TOOLS_DEBUG_INFO 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam</span>(FAsyncTaskDelegate,UAsyncActionObject*,ActionObj);</span><br><span class="line"></span><br><span class="line"><span class="built_in">UCLASS</span>(BlueprintType)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UAsyncTask</span> :</span> <span class="keyword">public</span> UBlueprintAsyncActionBase</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_UCLASS_BODY</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintCallable, meta=( BlueprintInternalUseOnly=<span class="string">&quot;true&quot;</span> ))</span><br><span class="line">	<span class="function"><span class="keyword">static</span> UAsyncTask* <span class="title">CreateAsyncTask</span><span class="params">(UAsyncActionObject* ActionObj)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(BlueprintAssignable)</span><br><span class="line">	FAsyncTaskDelegate OnStart;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(BlueprintAssignable)</span><br><span class="line">	FAsyncTaskDelegate OnAbort;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(BlueprintAssignable)</span><br><span class="line">	FAsyncTaskDelegate OnUpdate;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(BlueprintAssignable)</span><br><span class="line">	FAsyncTaskDelegate OnFinishd;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">StartTask</span><span class="params">(UAsyncActionObject* ActionObj)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnActionStart</span><span class="params">(UAsyncActionObject* ActionObj)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnActionAbort</span><span class="params">(UAsyncActionObject* ActionObj)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnActionUpdate</span><span class="params">(UAsyncActionObject* ActionObj)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnActionFinishd</span><span class="params">(UAsyncActionObject* ActionObj)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>然后是实现：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AsyncTask.cpp</span></span><br><span class="line"><span class="comment">// Copyright 1998-2017 Epic Games, Inc. All Rights Reserved.</span></span><br><span class="line"><span class="comment">// Copyright 1998-2017 Epic Games, Inc. All Rights Reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;AsyncTask.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Modules/ModuleManager.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//----------------------------------------------------------------------//</span></span><br><span class="line"><span class="comment">// UAsyncTask</span></span><br><span class="line"><span class="comment">//----------------------------------------------------------------------//</span></span><br><span class="line"></span><br><span class="line">UAsyncTask::<span class="built_in">UAsyncTask</span>(<span class="keyword">const</span> FObjectInitializer&amp; ObjectInitializer)</span><br><span class="line">	: <span class="built_in">Super</span>(ObjectInitializer)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">HasAnyFlags</span>(RF_ClassDefaultObject) == <span class="literal">false</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">AddToRoot</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">UAsyncTask* <span class="title">UAsyncTask::CreateAsyncTask</span><span class="params">(UAsyncActionObject* ActionObj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UAsyncTask* AsyncActionTask = NewObject&lt;UAsyncTask&gt;();</span><br><span class="line">	AsyncActionTask-&gt;<span class="built_in">StartTask</span>(ActionObj);</span><br><span class="line">	<span class="keyword">return</span> AsyncActionTask;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UAsyncTask::StartTask</span><span class="params">(UAsyncActionObject* ActionObj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(ActionObj &amp;&amp; !ActionObj-&gt;<span class="built_in">Action_IsRunning</span>())</span><br><span class="line">	&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PRINT_ASYNC_ACTION_TOOLS_DEBUG_INFO</span></span><br><span class="line">	<span class="built_in">PRINT_LOG</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UAsyncTask::StartTask Bind Event&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		(ActionObj-&gt;OnStart).<span class="built_in">BindUObject</span>(<span class="keyword">this</span>,&amp;UAsyncTask::OnActionStart);</span><br><span class="line">		(ActionObj-&gt;OnAbort).<span class="built_in">BindUObject</span>(<span class="keyword">this</span>,&amp;UAsyncTask::OnActionAbort);</span><br><span class="line">		(ActionObj-&gt;OnUpdate).<span class="built_in">BindUObject</span>(<span class="keyword">this</span>,&amp;UAsyncTask::OnActionUpdate);</span><br><span class="line">		(ActionObj-&gt;OnFinishd).<span class="built_in">BindUObject</span>(<span class="keyword">this</span>,&amp;UAsyncTask::OnActionFinishd);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UAsyncTask::OnActionStart</span><span class="params">(UAsyncActionObject* ActionObj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PRINT_ASYNC_ACTION_TOOLS_DEBUG_INFO</span></span><br><span class="line">	<span class="built_in">PRINT_LOG</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UAsyncTask::OnStart&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	OnStart.<span class="built_in">Broadcast</span>(ActionObj);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UAsyncTask::OnActionAbort</span><span class="params">(UAsyncActionObject* ActionObj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PRINT_ASYNC_ACTION_TOOLS_DEBUG_INFO</span></span><br><span class="line">	<span class="built_in">PRINT_LOG</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UAsyncTask::OnActionAbort&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	OnAbort.<span class="built_in">Broadcast</span>(ActionObj);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UAsyncTask::OnActionUpdate</span><span class="params">(UAsyncActionObject* ActionObj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PRINT_ASYNC_ACTION_TOOLS_DEBUG_INFO</span></span><br><span class="line">	<span class="built_in">PRINT_LOG</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UAsyncTask::OnActionUpdate&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	OnUpdate.<span class="built_in">Broadcast</span>(ActionObj);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UAsyncTask::OnActionFinishd</span><span class="params">(UAsyncActionObject* ActionObj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PRINT_ASYNC_ACTION_TOOLS_DEBUG_INFO</span></span><br><span class="line">	<span class="built_in">PRINT_LOG</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UAsyncTask::OnActionFinishd&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	OnFinishd.<span class="built_in">Broadcast</span>(ActionObj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AsyncActionObject 类的声明:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AsyncActionObject.h</span></span><br><span class="line"><span class="comment">// Fill out your copyright notice in the Description page of Project Settings.</span></span><br><span class="line"><span class="comment">// Fill out your copyright notice in the Description page of Project Settings.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// unreal header</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Array.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Kismet/KismetSystemLibrary.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;UObject/NoExportTypes.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;AsyncActionObject.generated.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PRINT_LOG</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRINT_LOG(lOG_TEXT) UKismetSystemLibrary::PrintString(this,lOG_TEXT,true,true);</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PRINT_ASYNC_ACTION_OBJ_DEBUG_INFO</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRINT_ASYNC_ACTION_OBJ_DEBUG_INFO 0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UAsyncActionObject</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">DECLARE_DELEGATE_OneParam</span>(FAsyncActionDelegate,UAsyncActionObject*);</span><br><span class="line"></span><br><span class="line"><span class="built_in">UCLASS</span>(BlueprintType,Blueprintable)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UAsyncActionObject</span> :</span> <span class="keyword">public</span> UObject</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">UAsyncActionObject</span>(<span class="keyword">const</span> FObjectInitializer&amp; objectInitializer);</span><br><span class="line">	FAsyncActionDelegate OnStart;</span><br><span class="line">	FAsyncActionDelegate OnAbort;</span><br><span class="line">	FAsyncActionDelegate OnUpdate;</span><br><span class="line">	FAsyncActionDelegate OnFinishd;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintCallable)</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">OnActionStart</span><span class="params">(FString&amp; rReason)</span></span>;</span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintCallable)</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnActionAbort</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintCallable)</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnActionUpdate</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintCallable)</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnActionFinishd</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">// Action status (BP Executable function)</span></span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintCallable)</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Action_IsRunning</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintCallable)</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Action_ExecutableStart</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="comment">// End Action</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">EndAction</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">UnBindAll</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">InitDelegateList</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Action_IsStarted</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Action_EventIsBinded</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="keyword">bool</span> mActionStarted=<span class="literal">false</span>;</span><br><span class="line">	TArray&lt;FAsyncActionDelegate*&gt; DelegateList;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>以及它的实现：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AsyncActionObject.cpp</span></span><br><span class="line"><span class="comment">// Fill out your copyright notice in the Description page of Project Settings.</span></span><br><span class="line"><span class="comment">// Copyright 1998-2017 Epic Games, Inc. All Rights Reserved.</span></span><br><span class="line"><span class="comment">// Fill out your copyright notice in the Description page of Project Settings.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;AsyncActionObject.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">UAsyncActionObject::<span class="built_in">UAsyncActionObject</span>(<span class="keyword">const</span> FObjectInitializer&amp; objectInitializer)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PRINT_ASYNC_ACTION_OBJ_DEBUG_INFO</span></span><br><span class="line">		<span class="built_in">PRINT_LOG</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UAsyncActionObject::UAsyncActionObject&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="built_in">InitDelegateList</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UAsyncActionObject::OnActionStart</span><span class="params">(FString&amp; rReason)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	rReason.<span class="built_in">Reset</span>();</span><br><span class="line">	<span class="keyword">bool</span> local_bResault=<span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">Action_ExecutableStart</span>())</span><br><span class="line">	&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PRINT_ASYNC_ACTION_OBJ_DEBUG_INFO</span></span><br><span class="line">		<span class="built_in">PRINT_LOG</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UAsyncActionObject::OnActionStart&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		mActionStarted=<span class="literal">true</span>;</span><br><span class="line">		OnStart.<span class="built_in">ExecuteIfBound</span>(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">		local_bResault=<span class="literal">true</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PRINT_ASYNC_ACTION_OBJ_DEBUG_INFO</span></span><br><span class="line">		<span class="built_in">PRINT_LOG</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;call UAsyncActionObject::OnActionStart Faild.&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">		local_bResault=<span class="literal">false</span>;</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">Action_IsStarted</span>())</span><br><span class="line">		&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PRINT_ASYNC_ACTION_OBJ_DEBUG_INFO</span></span><br><span class="line">		<span class="built_in">PRINT_LOG</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;StartFaild: Action is Started.&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">			rReason.<span class="built_in">Append</span>(<span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Action is Started.\n&quot;</span>)));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(!<span class="built_in">Action_EventIsBinded</span>())</span><br><span class="line">		&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PRINT_ASYNC_ACTION_OBJ_DEBUG_INFO</span></span><br><span class="line">		<span class="built_in">PRINT_LOG</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;StartFaild: Action is not bind anything event.&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">			rReason.<span class="built_in">Append</span>(<span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Action is not bind to anything Task&quot;</span>)));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> local_bResault;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UAsyncActionObject::OnActionAbort</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">Action_IsRunning</span>())</span><br><span class="line">	&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PRINT_ASYNC_ACTION_OBJ_DEBUG_INFO</span></span><br><span class="line">	<span class="built_in">PRINT_LOG</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UAsyncActionObject::OnActionAbort&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		OnAbort.<span class="built_in">ExecuteIfBound</span>(<span class="keyword">this</span>);</span><br><span class="line">		<span class="built_in">EndAction</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UAsyncActionObject::OnActionUpdate</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">Action_IsRunning</span>())</span><br><span class="line">	&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PRINT_ASYNC_ACTION_OBJ_DEBUG_INFO</span></span><br><span class="line">	<span class="built_in">PRINT_LOG</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UAsyncActionObject::OnActionUpdate&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		OnUpdate.<span class="built_in">ExecuteIfBound</span>(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UAsyncActionObject::OnActionFinishd</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">Action_IsRunning</span>())</span><br><span class="line">	&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PRINT_ASYNC_ACTION_OBJ_DEBUG_INFO</span></span><br><span class="line">	<span class="built_in">PRINT_LOG</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UAsyncActionObject::OnActionFinishd&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		OnFinishd.<span class="built_in">ExecuteIfBound</span>(<span class="keyword">this</span>);</span><br><span class="line">		<span class="built_in">EndAction</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UAsyncActionObject::EndAction</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">Action_IsRunning</span>())</span><br><span class="line">	&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PRINT_ASYNC_ACTION_OBJ_DEBUG_INFO</span></span><br><span class="line">	<span class="built_in">PRINT_LOG</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UAsyncActionObject::EndAction&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		<span class="built_in">UnBindAll</span>();</span><br><span class="line">		mActionStarted=<span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UAsyncActionObject::UnBindAll</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PRINT_ASYNC_ACTION_OBJ_DEBUG_INFO</span></span><br><span class="line">	<span class="built_in">PRINT_LOG</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UAsyncActionObject::UnBindAll&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">auto</span>&amp; DeleIndex:DelegateList)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(DeleIndex-&gt;<span class="built_in">IsBound</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			DeleIndex-&gt;<span class="built_in">Unbind</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UAsyncActionObject::InitDelegateList</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="built_in">Action_IsStarted</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		DelegateList.<span class="built_in">AddUnique</span>(&amp;OnStart);</span><br><span class="line">		DelegateList.<span class="built_in">AddUnique</span>(&amp;OnAbort);</span><br><span class="line">		DelegateList.<span class="built_in">AddUnique</span>(&amp;OnUpdate);</span><br><span class="line">		DelegateList.<span class="built_in">AddUnique</span>(&amp;OnFinishd);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UAsyncActionObject::Action_EventIsBinded</span><span class="params">()</span><span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">bool</span> EventIsBinded=<span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">auto</span>&amp; DeleIndex:DelegateList)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(!DeleIndex-&gt;<span class="built_in">IsBound</span>())</span><br><span class="line">			EventIsBinded=<span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> EventIsBinded;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UAsyncActionObject::Action_IsStarted</span><span class="params">()</span><span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> mActionStarted;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UAsyncActionObject::Action_IsRunning</span><span class="params">()</span><span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Action_IsStarted</span>() &amp;&amp; <span class="built_in">Action_EventIsBinded</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UAsyncActionObject::Action_ExecutableStart</span><span class="params">()</span><span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> !<span class="built_in">Action_IsStarted</span>() &amp;&amp; <span class="built_in">Action_EventIsBinded</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实就是本质上裹了两层派发器而已…<br>举个例子的用途：可以在行为树里监听某个动画被终止或者结束了之后然后再执行其他的行为，可以解决不同模块之间之间的耦合。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Programming</category>
        <category>Blueprint</category>
      </categories>
      <tags>
        <tag>Blueprint</tag>
        <tag>异步</tag>
      </tags>
  </entry>
  <entry>
    <title>自定义蓝图节点</title>
    <url>/wiki/12302/</url>
    <content><![CDATA[<p>在蓝图中类似于 <code>SpawnActor</code> 或者 <code>GetClassDefaults</code> 之类的函数，可以根据参数的变化来改变节点的信息(如增加引脚，修改返回值类型等等)。</p>
<p>其实在蓝图中这样的节点都是继承自 <code>UK2Node</code> 的类，每一个节点是一个类，如 <code>SpawnActor</code> 它就是定义在 <code>Editor/BlueprintEditor</code> 下的 <code>K2Node_SpawnActor</code> 类。<br><code>UK2Node</code>提供了很多的方法供继承类重写，如：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 鼠标指到节点上的提示信息</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FText <span class="title">GetTooltipText</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line"><span class="comment">// 节点在蓝图中显示的名字</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FText <span class="title">GetNodeTitle</span><span class="params">(ENodeTitleType::Type TitleType)</span><span class="keyword">const</span></span>;</span><br><span class="line"><span class="comment">// 将节点添加至上下文菜单</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">GetMenuActions</span><span class="params">(FBlueprintActionDatabaseRegistrar&amp; ActionRegister)</span><span class="keyword">const</span></span>;</span><br><span class="line"><span class="comment">// 设置节点在编辑器中右键菜单的分类</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FText <span class="title">GetMenuCategory</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line"><span class="comment">// 在编译时扩展节点，可以添加或移除节点的 Pin</span></span><br><span class="line"><span class="comment">// 在这个函数中需要绑定真正需要执行的函数，注意绑定的函数要是 BlueprintCallable 的</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ExpandNode</span><span class="params">(FKismetCompilerContext &amp; CompilerContext, UEdGraph * SourceGraph)</span></span>;</span><br><span class="line"><span class="comment">// 当节点中的 Pin 信息被改变</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PinDefaultValueChanged</span><span class="params">(UEdGraphPin* ChangedPin)</span></span>;</span><br><span class="line"><span class="comment">// 给节点分配默认的 Pin，如初始添加 InExec 和 OutExec，声明在 UEdGraphNode 中</span></span><br><span class="line"><span class="comment">// 默认在 ReallocatePinsDuringReconstruction 中调用，也可以自己在 ExpandNode 中调用</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">AllocateDefaultPins</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>上面列出的就是创建一个自定义的蓝图节点需要实现的最重要的几个函数。</p>
<p>当在蓝图中点击节点右键刷新的时候会调用到 <code>ExpandNode</code> 函数，如果在其中调用了 <code>AllocateDefaultPins</code> 要考虑从序列化中读取已有配置的问题。</p>
<p>一个例子，实现的效果为根据枚举值修改节点的参数类型：<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/Show_CustomK2Node.gif"></p>
<p>代码放在了 Gist：<a href="https://gist.github.com/hxhb/d431c18592b1385574aac50eb00f8209">CustomK2Node.cpp</a></p>
<script src="https://gist.github.com/hxhb/d431c18592b1385574aac50eb00f8209.js"></script><link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Programming</category>
        <category>Blueprint</category>
      </categories>
      <tags>
        <tag>Blueprint</tag>
      </tags>
  </entry>
  <entry>
    <title>CharCast 的坑</title>
    <url>/wiki/70212204/</url>
    <content><![CDATA[<p><code>CharCast</code>是定义在 <code>StringConv.h</code> 的模板函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Casts one fixed-width char type into another.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param Ch The character to convert.</span></span><br><span class="line"><span class="comment"> * @return The converted character.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> To, <span class="keyword">typename</span> From&gt;</span><br><span class="line"><span class="function">FORCEINLINE To <span class="title">CharCast</span><span class="params">(From Ch)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	To Result;</span><br><span class="line">	FPlatformString::<span class="built_in">Convert</span>(&amp;Result, <span class="number">1</span>, &amp;Ch, <span class="number">1</span>, (To)UNICODE_BOGUS_CHAR_CODEPOINT);</span><br><span class="line">	<span class="keyword">return</span> Result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就是对 <code>FPlatformString::Convert</code> 的转发调用。</p>
<blockquote>
<p>PS：<code>UNICODE_BOGUS_CHAR_CODEPOINT</code> 宏定义为<code>&#39;?&#39;</code>。</p>
</blockquote>
<p><code>FPlatformString::Convert</code>有两个版本：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Converts the [Src, Src+SrcSize) string range from SourceChar to DestChar and writes it to the [Dest, Dest+DestSize) range.</span></span><br><span class="line"><span class="comment"> * The Src range should contain a null terminator if a null terminator is required in the output.</span></span><br><span class="line"><span class="comment"> * If the Dest range is not big enough to hold the converted output, NULL is returned.  In this case, nothing should be assumed about the contents of Dest.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param Dest      The start of the destination buffer.</span></span><br><span class="line"><span class="comment"> * @param DestSize  The size of the destination buffer.</span></span><br><span class="line"><span class="comment"> * @param Src       The start of the string to convert.</span></span><br><span class="line"><span class="comment"> * @param SrcSize   The number of Src elements to convert.</span></span><br><span class="line"><span class="comment"> * @param BogusChar The char to use when the conversion process encounters a character it cannot convert.</span></span><br><span class="line"><span class="comment"> * @return          A pointer to one past the last-written element.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> SourceEncoding, <span class="keyword">typename</span> DestEncoding&gt;</span><br><span class="line"><span class="keyword">static</span> FORCEINLINE <span class="keyword">typename</span> TEnableIf&lt;</span><br><span class="line">  <span class="comment">// This overload should be called when SourceEncoding and DestEncoding are &#x27;compatible&#x27;, i.e. they&#x27;re the same type or equivalent (e.g. like UCS2CHAR and WIDECHAR are on Windows).</span></span><br><span class="line">  TAreEncodingsCompatible&lt;SourceEncoding, DestEncoding&gt;::Value,</span><br><span class="line">  DestEncoding*</span><br><span class="line">&gt;::<span class="function">Type <span class="title">Convert</span><span class="params">(DestEncoding* Dest, int32 DestSize, <span class="keyword">const</span> SourceEncoding* Src, int32 SrcSize, DestEncoding BogusChar = (DestEncoding)<span class="string">&#x27;?&#x27;</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (DestSize &lt; SrcSize)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (DestEncoding*)<span class="built_in">Memcpy</span>(Dest, Src, SrcSize * <span class="built_in"><span class="keyword">sizeof</span></span>(SourceEncoding)) + SrcSize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> SourceEncoding, <span class="keyword">typename</span> DestEncoding&gt;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">typename</span> TEnableIf&lt;</span><br><span class="line">  <span class="comment">// This overload should be called when the types are not compatible but the source is fixed-width, e.g. ANSICHAR-&gt;WIDECHAR.</span></span><br><span class="line">  !TAreEncodingsCompatible&lt;SourceEncoding, DestEncoding&gt;::Value &amp;&amp; TIsFixedWidthEncoding&lt;SourceEncoding&gt;::Value,</span><br><span class="line">  DestEncoding*</span><br><span class="line">  &gt;::<span class="function">Type <span class="title">Convert</span><span class="params">(DestEncoding* Dest, int32 DestSize, <span class="keyword">const</span> SourceEncoding* Src, int32 SrcSize, DestEncoding BogusChar = (DestEncoding)<span class="string">&#x27;?&#x27;</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> int32 Size = DestSize &lt;= SrcSize ? DestSize : SrcSize;</span><br><span class="line">  <span class="keyword">bool</span> bInvalidChars = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> I = <span class="number">0</span>; I &lt; Size; ++I)</span><br><span class="line">  &#123;</span><br><span class="line">    SourceEncoding SrcCh = Src[I];</span><br><span class="line">    Dest[I] = (DestEncoding)SrcCh;</span><br><span class="line">    bInvalidChars |= !CanConvertChar&lt;DestEncoding&gt;(SrcCh);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bInvalidChars)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> I = <span class="number">0</span>; I &lt; Size; ++I)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">if</span> (!CanConvertChar&lt;DestEncoding&gt;(Src[I]))</span><br><span class="line">    &#123;</span><br><span class="line">      Dest[I] = BogusChar;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LogBogusChars&lt;DestEncoding&gt;(Src, Size);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> DestSize &lt; SrcSize ? <span class="literal">nullptr</span> : Dest + Size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中关键的是第二个实现， 通过判断 <code>CanConvertChar</code> 来检测是否能够转换字符，如果不能转换就把转换结果设置为 <code>BogusChar</code>，默认也就是<code>?</code>，这也是把不同编码的数据转换为 FString 有些会显示一堆<code>?</code> 的原因。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Tests whether a particular character can be converted to the destination encoding.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param Ch The character to test.</span></span><br><span class="line"><span class="comment"> * @return True if Ch can be encoded as a DestEncoding.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> DestEncoding, <span class="keyword">typename</span> SourceEncoding&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">CanConvertChar</span><span class="params">(SourceEncoding Ch)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">IsValidChar</span>(Ch) &amp;&amp; (SourceEncoding)(DestEncoding)Ch == Ch &amp;&amp; <span class="built_in">IsValidChar</span>((DestEncoding)Ch);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以：类似 <code>LoadFileToString</code> 去读文件如果编码不支持，那么读出来的数据和原始文件里是不一样的。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Programming</category>
        <category>C++</category>
      </categories>
      <tags>
        <tag>C++</tag>
        <tag>Programming</tag>
      </tags>
  </entry>
  <entry>
    <title>MD5 的分片校验</title>
    <url>/wiki/42464/</url>
    <content><![CDATA[<p>有一个需求：对下载的文件执行 MD5 运算。在 UE 中可以使用 <code>FMD5Hash</code> 来进行 MD5 计算，但是只能指定文件加载：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">FMD5Hash FileHash = FMD5Hash::<span class="built_in">HashFile</span>(*InFile);</span><br><span class="line">FString HashValue = <span class="built_in">LexToString</span>(FileHash);</span><br></pre></td></tr></table></figure>
<p>但是当文件比较大的时候如果等文件下载完再执行校验耗时会很长，所以我想有没有办法边下边进行 MD5 的计算，因为知道 MD5 是基于摘要的，所以觉得边下边校验的方法应该可行。我查了一下相关的实现，找到 <code>OpenSSL</code> 中有相关的操作：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// openssl/md5.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HEADER_MD5_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HEADER_MD5_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;openssl/e_os2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stddef.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span>  __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> OPENSSL_NO_MD5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">error</span> MD5 is disabled.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></span><br><span class="line"><span class="comment"> * ! MD5_LONG has to be at least 32 bits wide. If it&#x27;s wider, then !</span></span><br><span class="line"><span class="comment"> * ! MD5_LONG_LOG2 has to be defined along.			   !</span></span><br><span class="line"><span class="comment"> * !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__LP32__)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MD5_LONG unsigned long</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(OPENSSL_SYS_CRAY) || defined(__ILP64__)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MD5_LONG unsigned long</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MD5_LONG_LOG2 3</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * _CRAY note. I could declare short, but I have no idea what impact</span></span><br><span class="line"><span class="comment"> * does it have on performance on none-T3E machines. I could declare</span></span><br><span class="line"><span class="comment"> * int, but at least on C90 sizeof(int) can be chosen at compile time.</span></span><br><span class="line"><span class="comment"> * So I&#x27;ve chosen long...</span></span><br><span class="line"><span class="comment"> *					&lt;appro@fy.chalmers.se&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MD5_LONG unsigned int</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MD5_CBLOCK	64</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MD5_LBLOCK	(MD5_CBLOCK/4)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MD5_DIGEST_LENGTH 16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">MD5state_st</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">	MD5_LONG A,B,C,D;</span><br><span class="line">	MD5_LONG Nl,Nh;</span><br><span class="line">	MD5_LONG data[MD5_LBLOCK];</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num;</span><br><span class="line">	&#125; MD5_CTX;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> OPENSSL_FIPS</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">private_MD5_Init</span><span class="params">(MD5_CTX *c)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MD5_Init</span><span class="params">(MD5_CTX *c)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MD5_Update</span><span class="params">(MD5_CTX *c, <span class="keyword">const</span> <span class="keyword">void</span> *data, <span class="keyword">size_t</span> len)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MD5_Final</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *md, MD5_CTX *c)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> *<span class="title">MD5</span><span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *d, <span class="keyword">size_t</span> n, <span class="keyword">unsigned</span> <span class="keyword">char</span> *md)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MD5_Transform</span><span class="params">(MD5_CTX *c, <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *b)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span>  __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>其中提供的 MD5 计算可以分开操作的有三个函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MD5_Init</span><span class="params">(MD5_CTX *c)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MD5_Update</span><span class="params">(MD5_CTX *c, <span class="keyword">const</span> <span class="keyword">void</span> *data, <span class="keyword">size_t</span> len)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MD5_Final</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *md, MD5_CTX *c)</span></span>;</span><br></pre></td></tr></table></figure>

<p>其中的 <code>MD5_Update</code> 就是我们需要的函数。</p>
<p>所以使用的伪代码为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">MD5_CTX Md5CTX;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Request</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">MD5_Init</span>(&amp;Md5CTX);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TickRequestProgress</span><span class="params">(<span class="keyword">char</span>* InData,uint32 InLength)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">MD5_Update</span>(&amp;Md5CTX,InData,InLength);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RequestCompleted</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">unsigned</span> <span class="keyword">char</span> digest[<span class="number">16</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="built_in">MD5_Final</span>(digest, &amp;Md5CTX);</span><br><span class="line">	<span class="keyword">char</span> md5string[<span class="number">33</span>];</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; ++i)</span><br><span class="line">		std::<span class="built_in">sprintf</span>(&amp;md5string[i * <span class="number">2</span>], <span class="string">&quot;%02x&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)digest[i]);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// result</span></span><br><span class="line">    <span class="built_in">pritf</span>(<span class="string">&quot;MD5:%s&quot;</span>,md5string);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样当文件下载完，MD5 计算就完成了。</p>
<blockquote>
<p>注：在 UE4 中 (~4.24) 提供的 OpenSSL 在 Win 下只支持到 VS2015，可以自己把这个限制给去掉(VS2015 的链接库在 VS2017 中使用也没有问题)。</p>
</blockquote>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Programming</category>
        <category>C++</category>
      </categories>
      <tags>
        <tag>MD5</tag>
      </tags>
  </entry>
  <entry>
    <title>UEC++ 与标准 C++ 的区别与联系</title>
    <url>/wiki/20425/</url>
    <content><![CDATA[<p>UEC++ 本质是 C++ 的一个超集，它支持和使用 C++ 的全部特性，但是它在标准特性之上自己构建了一套语法。很多开发中的编译问题只有知道了两者的边界，才能够快速和准确地定位问题出现在哪个阶段。对于使用 UE 之前就学习过 C++ 的来说这不是什么问题，但是对于先接触 UE 然后慢慢学 C++ 的同学来说，这是个挺大的问题。</p>
<p><strong>标准 C++<strong>是基于 </strong>ISO/IEC 14882</strong> 的语言规范（C++98/03/11/14/17 等标准），UEC++ 则是我们开发当中使用的 Epic 在标准 C++ 之上扩展的用法，这里不讨论 GC、反射之类的基于 C++ 之上自己构建的对象体系，也不涉及 UE 中的各种库，关注的着重点在于核心语法层面。</p>
<p>近期博客的更新文章里，写了一些 UE 反射机制的内容，可以作为本篇文章的进阶内容结合来看：</p>
<ul>
<li><a href="https://imzlp.com/posts/12624/">UE4 反射实现分析：基础概念</a></li>
<li><a href="https://imzlp.com/posts/23694/">UE4 反射实现分析：C++ 特性</a></li>
<li><a href="https://imzlp.com/posts/9780/">UE4 的反射实现分析：反射代码生成（一）</a></li>
</ul>
<p>在 UE4.23+ 以后，UE 所支持的 C++ 标准是可以被控制的，在 <code>*.target.cs</code> 和<code>*.build.cs</code>中均可以设置 <code>CppStandard</code> 的值，目前有三个标准可选：<code>Cpp14</code>、<code>Cpp17</code>、<code>Latast</code>，它控制了传递给编译器的 <code>/std:c++*</code> 值。</p>
<p>开始具体的分析之前，首先要知道标准 C++ 和 UE C++ 都是怎么执行编译的，因为只有先区分了最根本的使用区别，才能够进一步分析为什么会有这些区别。</p>
<h2 id="编译标准 C- 代码"><a href="# 编译标准 C- 代码" class="headerlink" title="编译标准 C++ 代码"></a>编译标准 C++ 代码 </h2><p> 首先，C++ 的代码只依赖于编译器，如下面代码:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// hw.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HW_MSG <span class="meta-string">&quot;HelloWorld&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  std::cout&lt;&lt;HW_MSG&lt;&lt;std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>想要编译上面的代码，需要使用一个编译器（GCC/MSVC）等，VS 使用的是 MSVC，以 GCC 为例：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">$ g++ hw.cpp -o hw.exe</span><br></pre></td></tr></table></figure>
<p>通过这一行命令就会编译出 hw.exe，但是编译器是一套工具链，虽然只执行了一条命令，但是它其实是调用了一串的工具进行预处理、语法分析、编译、链接等等一系列操作，不过它们不是本篇文章的重点，有兴趣的可以看一下我之前的这篇文章：<a href="https://imzlp.com/posts/27118/">C/C++ 编译和链接模型分析 </a>。<br> 举上面的例子需要关注的有两点：</p>
<ol>
<li>标准 C++ 语法可以直接用编译器编译；</li>
<li>编译器对代码需要执行预处理、语法分析、编译、链接等操作；</li>
</ol>
<h2 id="编译 UEC- 代码"><a href="# 编译 UEC- 代码" class="headerlink" title="编译 UEC++ 代码"></a>编译 UEC++ 代码 </h2><p> 首先，UEC++ 代码，并不像标准 C++ 那样把代码单独存在一个文件就可以编译的，UE 自己搭建了一套编译体系，所有基于 UE 引擎的代码必须要通过 UE 的这套编译体系才可以编译。<br>我之前写过 UE 构建系统的一些文章，想要 UE 项目的构建系统可以看一下：</p>
<ul>
<li><a href="https://imzlp.com/posts/6362/">Build flow of the Unreal Engine4 project</a></li>
<li><a href="https://img.imzlp.com/imgs/zlp/blog/posts/16643/">UE4 Build System：Target and Module</a></li>
</ul>
<p>UEC++ 的代码必须要依赖于一个<strong>UE 项目</strong>，其基本项目结构为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Example\GWorld\Source&gt;tree /a /f</span><br><span class="line">|   GWorld.Target.cs</span><br><span class="line">|</span><br><span class="line">\---GWorld</span><br><span class="line">        GWorld.Build.cs</span><br><span class="line">        GWorld.cpp</span><br><span class="line">        GWorld.h</span><br><span class="line">        Public/</span><br><span class="line">        Private/</span><br></pre></td></tr></table></figure>
<p>其中各个文件的职责为：</p>
<ul>
<li><code>*.Target.cs</code>是用来控制的是生成的可执行程序的外部编译环境，就是所谓的 Target。比如，生成的是什么 <code>Type</code>(Game/Client/Server/Editor/Program)，开不开启 RTTI(<code>bForceEnableRTTI</code>)，CRT 使用什么方式链接(<code>bUseStaticCRT</code>) 等等。</li>
<li><code>*.Build.cs</code>控制的是 Module 编译过程，由它来控制所属 Module 的对其他 Module 的依赖、文件包含、链接、宏定义等等相关的操作，<code>*.Build.cs</code>告诉 UE 的构建系统，它是一个 Module，并且编译的时候要做哪些事情。</li>
<li>其余的是代码源文件(一般情况下头文件放在<code>Public/</code>，实现放在<code>Private/</code>)</li>
</ul>
<p>UE 构建系统的重点是 UBT 和 UHT，他们各自的作用我之前的文章中有提到：</p>
<ul>
<li>UBT 的作用是收集和构建编译环境，调用 UHT 生成代码，然后 <strong> 调用真正的编译器进行编译</strong></li>
<li>UHT 的作用是把项目中所有代码里的 UHT 标记翻译为真正的 C++ 代码（如 <code>UCLASS/GENERATED_BODY</code> 等等），它属于 UBT 工作流程中的一环</li>
</ul>
<p>上面写的需要关注的有三点：</p>
<ol>
<li>UEC++ 的代码必须通过 UE 自己的构建体系</li>
<li>UEC++ 的代码必须要通过 UHT 进行翻译成 <strong> 真正的 C++ 代码</strong></li>
<li>UE 的项目里真正进入编译阶段的，全部都是标准 C++ 的代码</li>
</ol>
<p>所以，UEC++ 和标准 C++ 的区别在于，UEC++ 自己定义了一些语法，需要通过专门的解释器进行翻译，然后再通过 C++ 编译器进行编译（进入标准 C++ 的编译流程）。</p>
<p>关于流程上的区别就说这么多，下面的内容来写 UE 具体有哪些特殊的语法。</p>
<h2 id="UEC- 的特殊语法"><a href="#UEC- 的特殊语法" class="headerlink" title="UEC++ 的特殊语法"></a>UEC++ 的特殊语法 </h2><p>UEC++ 的特殊语法主要是用于指导 UHT 来产生辅助代码的方式。<br> 来聊 UEC++ 的特殊语法之前，需要先明确一点：<code>UCLASS</code>/<code>UFUNCTION</code>/<code>UPROPERTY</code>等都不是 <strong> 真正有意义的 C++ 宏 </strong>，他们是<strong>UHT 的标记</strong>，在经过 UHT 生成代码之后他们就是空宏了，没有意义。<br>UE 的代码是把<strong>UHT 标记</strong> 和<strong>真正的宏 </strong> 都以 <strong> 宏的形式 </strong> 来表现，从结果来说，它们都是生成了一些代码，但是它们的处理流程不同。<br>UHT 标记是先通过 UHT 进行扫描并生成代码，再通过编译器进行预处理等等，这里存在一个先后的过程，其限制就为：<strong>对 UHT 对代码的处理在前，编译器对宏的预处理在后，所以在 UE 中没办法用宏来包裹 UHT 标记</strong>。</p>
<p>UE 的 UHT 标记包括但不限于：</p>
<ul>
<li><a href="https://docs.unrealengine.com/en-US/Programming/UnrealArchitecture/Reference/Functions/Specifiers/index.html">Function Specifiers</a></li>
<li><a href="https://docs.unrealengine.com/en-US/Programming/UnrealArchitecture/Reference/Metadata/index.html">Metadata Specifiers</a></li>
<li><a href="https://docs.unrealengine.com/en-US/Programming/UnrealArchitecture/Reference/Properties/Specifiers/index.html">Property Specifiers</a></li>
<li><a href="https://docs.unrealengine.com/en-US/Programming/UnrealArchitecture/Reference/Structs/Specifiers/index.html">Struct Specifiers</a></li>
<li><a href="https://docs.unrealengine.com/en-US/Programming/UnrealArchitecture/Reference/Interfaces/index.html">Interfaces</a></li>
</ul>
<p>可以从 <code>Runtime\CoreUObject\Public\ObjectMacros.h</code> 看更多的 UHT 标记，有一个简单的分辨方法：如果这个宏是一个空宏，那么它就是一个 UHT 标记：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime\CoreUObject\Public\ObjectMacros.h</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// These macros wrap metadata parsed by the Unreal Header Tool, and are otherwise</span></span><br><span class="line"><span class="comment">// ignored when code containing them is compiled by the C++ compiler</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UPROPERTY(...)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFUNCTION(...)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USTRUCT(...)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UMETA(...)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UPARAM(...)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UENUM(...)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UDELEGATE(...)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// This pair of macros is used to help implement GENERATED_BODY() and GENERATED_USTRUCT_BODY()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BODY_MACRO_COMBINE_INNER(A,B,C,D) A##B##C##D</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BODY_MACRO_COMBINE(A,B,C,D) BODY_MACRO_COMBINE_INNER(A,B,C,D)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Include a redundant semicolon at the end of the generated code block, so that intellisense parsers can start parsing</span></span><br><span class="line"><span class="comment">// a new declaration if the line number/generated code is out of date.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GENERATED_BODY_LEGACY(...) BODY_MACRO_COMBINE(CURRENT_FILE_ID,_,__LINE__,_GENERATED_BODY_LEGACY);</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GENERATED_BODY(...) BODY_MACRO_COMBINE(CURRENT_FILE_ID,_,__LINE__,_GENERATED_BODY);</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GENERATED_USTRUCT_BODY(...) GENERATED_BODY()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GENERATED_UCLASS_BODY(...) GENERATED_BODY_LEGACY()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GENERATED_UINTERFACE_BODY(...) GENERATED_BODY_LEGACY()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GENERATED_IINTERFACE_BODY(...) GENERATED_BODY_LEGACY()</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UE_BUILD_DOCS || defined(__INTELLISENSE__)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UCLASS(...)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UCLASS(...) BODY_MACRO_COMBINE(CURRENT_FILE_ID,_,__LINE__,_PROLOG)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UINTERFACE(...) UCLASS()</span></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>下面简单列举一些：</p>
<ol start="0">
<li><p><code>*.generated.h</code>这个文件是 UE 特有的，它是 UHT 生成的代码（大多都是宏）</p>
</li>
<li><p><code>UCLASS</code>/<code>UFUNCTION</code>/<code>UPROPERTY</code>/<code>UENUM</code>等 <strong> 标记 </strong> 在 C++ 中是没有的，它们的作用是指导 UHT 生成什么样的辅助代码；</p>
</li>
<li><p><code>GENERATED_BODY</code>等系列宏标准 C++ 是没有的，它的作用在于把 UHT 生成的代码包含到当前类中来；</p>
</li>
<li><p><code>BlueprintNativeEvent</code>函数的实现需要加 <code>_Implementation</code>，这个规则是没有的，上面提到了 C++ 中连<code>UFUNCTION</code> 都没有；</p>
</li>
<li><p>C++ 中没有 Slate</p>
</li>
<li><p>UE 项目中的宏都会生成在 <code>Intermediate\Build\Win64\UE4Editor\Development\MODULE_NAME</code> 下，如 <code>MODULE_NAME_API</code> 是导出符号，在标准 C++ 项目中需要你自己定义导出。</p>
</li>
<li><p>标准 C++ 的接口可以通过抽象类的来实现，并不需要一个特定基类，而且并没有 UE 中不可以提供数据成员的限制（仅从语法的角度，当然从设计思路上接口要无状态）</p>
</li>
<li><p>标准 C++ 没有 UE 中的 DELEGATE</p>
</li>
<li><p><code>Cast&lt;&gt;</code>和 <code>NewObject&lt;&gt;</code> 是 UE 特有的，C++ 使用四种标准 cast 和<code>new</code></p>
</li>
<li><p>C++ 也没有 UE 的 Thunk 函数</p>
</li>
<li><p>…</p>
</li>
</ol>
<p>了解 UEC++ 和标准 C++ 的区别的关键点在于能够了解两者在构建流程上的区别，这一点能够区分开之后，再多的语法区别都是在这个结构内。至于 UEC++ 的反射，这是另一个可以写很大篇幅的内容了，先挖个坑。</p>
<h2 id="如何学习 C"><a href="# 如何学习 C" class="headerlink" title="如何学习 C++"></a>如何学习 C++</h2><p>从最开始接触 C 语言到现在快有十年了，也看了不少 C++ 的书，但是我觉得学习 C++ 最重要的是要去了解一下那些特性为什么这么设计，受哪些历史特性的限制，了解特性之间的关联，再去看看这些特性的编译器的实现，很多犄角旮旯的东西产生的原因就很明显了。<br>推荐一些书（建议按照顺序阅读，带 * 建议必读）：</p>
<ol>
<li>The C Programing Language</li>
<li>*C++ Primer / The C++ Programming Language</li>
<li>*inside the c++ object model</li>
<li>*Effective C++</li>
<li>Modern Effective C++</li>
<li>C++ coding standard: 101 rules, guidelines and best practices</li>
<li>*The design and evolution of c++</li>
</ol>
<p>前两本是基础语法，如果没有太多时间，可以读 C++ Primer 或者 TC++PL 中的其中一本即可，我还写过一篇文章对比这两本书 <a href="https://imzlp.com/posts/4367"> 读 TC++PL、C++Primer 和 ISO C++</a>，有兴趣的可以读一下，学习 C++ 后面的路还很长。<br>我建议学完基础语法之后就开始大量地写代码，因为只看懂了理论，不上手多写是没有意义的。</p>
<h2 id="如何学习 UEC"><a href="# 如何学习 UEC" class="headerlink" title="如何学习 UEC++"></a>如何学习 UEC++</h2><p>在 C++ 的基础语法学的差不多了之后，直接就开始在 UE 中写项目吧，作为 <strong> 开放源代码 </strong> 的引擎（但 UE 不是开源软件，许可证区别），没有什么是藏着掖着的，可以在边写项目的同时边尝试看 UE 引擎里的代码，去尝试分析 UE 的构建流程和代码生成。</p>
<p>我的一个小技巧就是，可以多去翻一下 <code>Intermediate</code> 中通过 UHT 生产的代码，不少的错误或者疑问的问题都能在里面找到答案。</p>
<p>最重要的还是：多看！多写！多思考！</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Programming</category>
        <category>C++</category>
      </categories>
      <tags>
        <tag>C++</tag>
      </tags>
  </entry>
  <entry>
    <title>定义外部可用的全局符号</title>
    <url>/wiki/aef7be29/</url>
    <content><![CDATA[<p>有时候，在插件或者其他的模块中，想要定义一个全局对象，供内部或者外部的模块访问，就像 UE 内置的 <code>GEngine</code>/<code>GConfig</code> 这些。</p>
<p>首先需要把 C++ 中 <strong> 声明 </strong> 和<strong>定义 </strong> 的概念区分开，我之前有篇文章介绍：<a href="https://imzlp.com/posts/21831/">C++ 中 declaration 与 define 的区别</a>。</p>
<p>因为我们想要访问的 <strong> 全局对象</strong>，应该只有一个实例，而不是每个使用模块都包含了一个定义的实例，所以只应该在有一个定义，其他模块引用时只是一个声明，声明它在外部模块中定义，应该去其他模块中访问该实例。</p>
<p>以 Windows 为例，UE 的模块，会编译成 DLL，如果我们想要访问某个模块的符号，就是要访问它的 DLL 中的符号。在 UE 中，导出符号使用 <code>XXXX_API</code> 封装，同样在之前的笔记中有记录：</p>
<ul>
<li><a href="https://imzlp.com/notes/ue/#MODULE-NAME-API">MODULE_NAME_API</a></li>
<li><a href="https://imzlp.com/notes/ue/#%E6%A8%A1%E5%9D%97%E7%9A%84%E5%AE%8F%E5%AE%9A%E4%B9%89">模块的宏定义</a></li>
</ul>
<p>以 A、B 两个模块为例：<code>A_API</code>在 A 模块中被定义为 <code>DLLEXPORT</code>，在 B 模块中被定义为<code>DLLIMPORT</code>，所以，A 中使用<code>A_API</code> 定义一个符号，会控制它编译出的 A.dll 中该符号导出，在外部模块 B 中使用该符号时，就是导入。</p>
<p>理解起来或许有点绕，以代码来理解：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// A.h</span></span><br><span class="line"><span class="keyword">extern</span> A_API int32* GTestPtr; <span class="comment">// declare a external pointer symbal</span></span><br><span class="line"><span class="comment">// extern DLLEXPORT int32* GTestPtr = nullptr;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// A.cpp</span></span><br><span class="line">A_API int32* GTestPtr = <span class="literal">nullptr</span>; <span class="comment">// define the global symbal</span></span><br><span class="line"><span class="comment">// DLLEXPORT int32* GTestPtr = nullptr;</span></span><br></pre></td></tr></table></figure>
<p>在 B 中访问它：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// B.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;A.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(GTestPtr)&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>在 B 中包含 A.h，在 B 中，A.h 中的 <code>extern A_API int32* GTestPtr;</code> 就变成了以下代码：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">extern</span> DLLIMPORT int32* GTestPtr;</span><br></pre></td></tr></table></figure>
<p>在编译 B 模块时，<code>DLLIMPORT</code>会指导链接器 (linker) 去外部的模块查找该符号，从而实现在 B 中访问 A 中定义的全局对象。</p>
<p>错误用法 1：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// A.h</span></span><br><span class="line">int32* GTestPtr;</span><br><span class="line"><span class="comment">// A.cpp</span></span><br><span class="line"><span class="keyword">int</span>* GTestPtr = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>
<p>如果在 A 中这么声明，在 B 中访问 GTestPtr 则会有符号未定义的链接错误。</p>
<p>错误用法 2：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// A.h</span></span><br><span class="line"><span class="keyword">static</span> int32* GTestPtr;</span><br></pre></td></tr></table></figure>
<p>则每个包含 A.h 的翻译单元都包含了一个 <code>GTestPtr</code> 的符号实例，并不是全局唯一的。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Programming</category>
        <category>C++</category>
      </categories>
      <tags>
        <tag>C++</tag>
        <tag>Programming</tag>
      </tags>
  </entry>
  <entry>
    <title>成员模板函数特化不要放在 Class Scope</title>
    <url>/wiki/41830/</url>
    <content><![CDATA[<p> 如下面代码：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">	Template&amp; <span class="keyword">operator</span>&gt;&gt;(T&amp; Value)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">template</span>&lt;&gt;</span><br><span class="line">	Template&amp; <span class="keyword">operator</span>&gt;&gt;&lt;<span class="keyword">bool</span>&gt;(<span class="keyword">bool</span>&amp; Value)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// do something</span></span><br><span class="line">		<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p> 声明了模板函数 <code>operator&gt;&gt;</code>，而且添加了一个 bool 的特化，这个代码在 Windows 下编译没有问题，但是在打包 Android 时会产生错误：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">error: explicit specialization of &#x27;operator&gt;&gt;&#x27; in class scope</span><br></pre></td></tr></table></figure>

<p> 说时显式特化写在了类作用域内，解决办法是把特化的版本放到类之外：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">	Template&amp; <span class="keyword">operator</span>&gt;&gt;(T&amp; Value)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line">Template&amp; Template::<span class="keyword">operator</span>&gt;&gt;&lt;<span class="keyword">bool</span>&gt;(<span class="keyword">bool</span>&amp; Value)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// do something</span></span><br><span class="line">	<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><a href="https://stackoverflow.com/questions/9487034/how-can-i-use-template-specialization-in-c-classes-and-why-this-doesnt-compi">How can I use template specialization in c++ classes, and why this doesn’t compile?</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Programming</category>
        <category>C++</category>
      </categories>
      <tags>
        <tag>C++</tag>
        <tag>Template</tag>
      </tags>
  </entry>
  <entry>
    <title>UnLua 函数覆写实现分析</title>
    <url>/wiki/35271/</url>
    <content><![CDATA[<blockquote>
<p>概括来说：UnLua 绑定了 UE 创建对象的事件，当创建 CDO 时会调用到 UnLua 的 <code>NotifyUObjectCreated</code>，在其中拿到了该对象的 UClass，对该对象的 UClass 中的 UFUNCTION 通过<code>SetNativeFunc</code> 修改为 <code>CallLua</code> 函数，这样就实现了覆写 UFUNCTION。</p>
</blockquote>
<p>下面来具体分析一下实现。UnLua 实现覆写完整的调用栈：<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/UnLua/analysis-overridden/ue4-notifyUObjectCreated-call-stack.webp"></p>
<h3 id="替换 Thunk 函数"><a href="# 替换 Thunk 函数" class="headerlink" title="替换 Thunk 函数"></a>替换 Thunk 函数 </h3><p> 在 UnLua 的 FLuaContext 的 initialize 函数中，将 GLuaCxt 注册到了 <code>GUObjectArray</code> 中：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// LuaContext.cpp</span></span><br><span class="line"><span class="keyword">if</span> (!bAddUObjectNotify)</span><br><span class="line">&#123;</span><br><span class="line">    GUObjectArray.<span class="built_in">AddUObjectCreateListener</span>(GLuaCxt);    <span class="comment">// add listener for creating UObject</span></span><br><span class="line">    GUObjectArray.<span class="built_in">AddUObjectDeleteListener</span>(GLuaCxt);    <span class="comment">// add listener for deleting UObject</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而 <code>FLuaContext</code> 继承自 <code>FUObjectArray::FUObjectCreateListener</code> 和<code>FUObjectArray::FUObjectDeleteListener</code>，所以当 UE 的对象系统创建对象的时候会把调用到 FLuaContext 的 <code>NotifyUObjectCreated</code> 与<code>NotifyUObjectDeleted</code>。</p>
<p>当创建一个 UObject 的时候会在 <code>FObjectArray</code> 的<code>AllocateUObjectIndex</code>中对多有注册过的 <code>CreateListener</code> 调用 <code>NotifyUObjectDeleted</code> 函数。</p>
<p>而 UnLua 实现覆写 UFUNCTION 的逻辑就是写在 <code>NotifyUObjectCreated</code> 中的 <code>TryBindLua</code> 调用中，栈如下：<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/UnLua/analysis-overridden/unlua-trybindlua-call-stack.webp"><br>一个一个来说他们的作用：</p>
<h3 id="FLuaContext-TryBindUnlua"><a href="#FLuaContext-TryBindUnlua" class="headerlink" title="FLuaContext::TryBindUnlua"></a>FLuaContext::TryBindUnlua</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Try to bind Lua module for a UObject</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FLuaContext::TryToBindLua</span><span class="params">(UObjectBaseUtility *Object)</span></span>;</span><br></pre></td></tr></table></figure>
<p>主要作用是：如果创建的对象继承了 <code>UUnLuaInterface</code>，具有<code>GetModuleName</code> 函数，则通过传进来的 UObject 获取到它的 UCclass，然后再通过 UClass 得到 <code>GetModuleName</code> 函数的<code>UFunction</code>，并通过 CDO 对象调用该 UFunction，得到该 CLass 绑定的 Lua 模块名。</p>
<p>若没有静态绑定，则检查是否具有动态绑定。</p>
<h3 id="UUnLuaManager-Bind"><a href="#UUnLuaManager-Bind" class="headerlink" title="UUnLuaManager::Bind"></a>UUnLuaManager::Bind</h3><p>该函数定义在 <code>UnLua/pRIVATE/UnLuaManager.cpp</code> 文件中。</p>
<p>在 <code>TryBindUnlua</code> 中得到了当前创建对象的 <code>UClass</code> 和绑定的模块名，传递到了 Bind 函数中，它主要做了几件事情：</p>
<ol>
<li>注册 Class 到 lua</li>
<li>require 对应的 lua 模块</li>
<li>调用 <code>UnLuaManager::BindInternal</code> 函数</li>
<li>为当前对象创建一个 lua 端对象并 push 上一个 <code>Initialize</code> 函数并调用</li>
</ol>
<h3 id="BindInternal"><a href="#BindInternal" class="headerlink" title="BindInternal"></a>BindInternal</h3><p>其中的关键函数为<code>UnLuaManager::BindInternal</code>：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Bind a Lua module for a UObject</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UUnLuaManager::BindInternal</span><span class="params">(UObjectBaseUtility *Object, UClass *Class, <span class="keyword">const</span> FString &amp;InModuleName, <span class="keyword">bool</span> bNewCreated)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!Object || !Class)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lua_State *L = *GLuaCxt;</span><br><span class="line">    TStringConversion&lt;TStringConvert&lt;TCHAR, ANSICHAR&gt;&gt; <span class="built_in">ModuleName</span>(*InModuleName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!bNewCreated)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">BindSurvivalObject</span>(L, Object, Class, ModuleName.<span class="built_in">Get</span>()))    <span class="comment">// try to bind Lua module for survival UObject again...</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        FString *ModuleNamePtr = ModuleNames.<span class="built_in">Find</span>(Class);</span><br><span class="line">        <span class="keyword">if</span> (ModuleNamePtr)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ModuleNames.<span class="built_in">Add</span>(Class, InModuleName);</span><br><span class="line">    Classes.<span class="built_in">Add</span>(InModuleName, Class);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UE_BUILD_DEBUG</span></span><br><span class="line">    TSet&lt;FName&gt; *LuaFunctionsPtr = ModuleFunctions.<span class="built_in">Find</span>(InModuleName);</span><br><span class="line">    <span class="built_in">check</span>(!LuaFunctionsPtr);</span><br><span class="line">    TMap&lt;FName, UFunction*&gt; *UEFunctionsPtr = OverridableFunctions.<span class="built_in">Find</span>(Class);</span><br><span class="line">    <span class="built_in">check</span>(!UEFunctionsPtr);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    TSet&lt;FName&gt; &amp;LuaFunctions = ModuleFunctions.<span class="built_in">Add</span>(InModuleName);</span><br><span class="line">    <span class="built_in">GetFunctionList</span>(L, ModuleName.<span class="built_in">Get</span>(), LuaFunctions);                         <span class="comment">// get all functions defined in the Lua module</span></span><br><span class="line">    TMap&lt;FName, UFunction*&gt; &amp;UEFunctions = OverridableFunctions.<span class="built_in">Add</span>(Class);</span><br><span class="line">    <span class="built_in">GetOverridableFunctions</span>(Class, UEFunctions);                                <span class="comment">// get all overridable UFunctions</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">OverrideFunctions</span>(LuaFunctions, UEFunctions, Class, bNewCreated);           <span class="comment">// try to override UFunctions</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">ConditionalUpdateClass</span>(Class, LuaFunctions, UEFunctions);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数接受到的参数是创建出来的 UObject，以及它的 UClass，还有对应的 Lua 的模块名。</p>
<ol>
<li>把对象的 UClass 与 Lua 的模块名对应添加到 <code>ModuleNames</code> 和<code>Classes</code>中</li>
<li>从 Lua 端通过 L 获取所指定模块名中的所有函数</li>
<li>从 UClass 获取所有的 BlueprintEvent、RepNotifyFunc 函数</li>
<li>对两边获取的结果调用 <code>UUnLuaManager::OverrideFunctions</code> 执行替换</li>
</ol>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/UnLua/analysis-overridden/unlua-get-lua-func-and-get-ue-ufuncion.webp"></p>
<h3 id="UUnLuaManager-OverrideFunctions"><a href="#UUnLuaManager-OverrideFunctions" class="headerlink" title="UUnLuaManager::OverrideFunctions"></a>UUnLuaManager::OverrideFunctions</h3><p>对从 Lua 端获取的函数使用名字在当前类的 UFunction 中查找，依次对其调用<code>UUnLuaManager::OverrideFunction</code>.</p>
<h3 id="UUnLuaManager-OverrideFunction"><a href="#UUnLuaManager-OverrideFunction" class="headerlink" title="UUnLuaManager::OverrideFunction"></a>UUnLuaManager::OverrideFunction</h3><ol>
<li>判断传入的 UFunction 是不是属于传入的 Outer UClasss</li>
<li>判断是否允许调用被覆写的函数</li>
<li>调用 <code>AddFunction</code> 函数</li>
</ol>
<h3 id="UUnLuaManager-AddFunction"><a href="#UUnLuaManager-AddFunction" class="headerlink" title="UUnLuaManager::AddFunction"></a>UUnLuaManager::AddFunction</h3><ol>
<li>如果函数为 <code>FUNC_Native</code> 则将 <code>FLuaInvoker::execCallLua</code> 和所覆写的函数名通过 <code>AddNativeFunction</code> 添加至 UClass</li>
<li>将 <code>UFunction</code> 内的函数指针替换为<code>(FNativeFuncPtr)&amp;FLuaInvoker::execCallLua</code></li>
<li>如果开启了允许调用被覆写的函数，则把替换 NativeFunc 之前的 UFunction 对象存到 <code>GReflectionRegistry</code> 中</li>
</ol>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/UnLua/analysis-overridden/unlua-replace-ufunction-native-function-pointer.webp"></p>
<h3 id="Call-lua"><a href="#Call-lua" class="headerlink" title="Call lua"></a>Call lua</h3><p>首先，需要说的一点是，当使用 UEC++ 写的带有 <code>UFUNCTION</code> 并具有 <code>BlueprintNativeEvent</code> 或者 <code>BlueprintImplementableEvent</code> 标记的函数，UHT 会给生成对应名字的函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UFUNCTION</span>(BlueprintNativeEvent,BlueprintCallable)</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">TESTFUNC</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">TESTFUNC_Implementation</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">UFUNCTION</span>(BlueprintImplementableEvent, meta = (DisplayName = <span class="string">&quot;BeginPlay&quot;</span>))</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">TESTImplEvent</span><span class="params">(AActor* InActor,int32 InIval)</span></span>;</span><br></pre></td></tr></table></figure>

<p>UHT 生成的函数和传递的数据结构：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// generated.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MicroEnd_423_Source_MicroEnd_423_Public_MyActor_h_13_EVENT_PARMS \</span></span><br><span class="line"><span class="meta">	struct MyActor_eventReceiveBytes_Parms \</span></span><br><span class="line"><span class="meta">	&#123; \</span></span><br><span class="line"><span class="meta">		TArray<span class="meta-string">&lt;uint8&gt;</span> InData; \</span></span><br><span class="line"><span class="meta">	&#125;; \</span></span><br><span class="line"><span class="meta">	struct MyActor_eventTESTFUNC_Parms \</span></span><br><span class="line"><span class="meta">	&#123; \</span></span><br><span class="line"><span class="meta">		bool ReturnValue; \</span></span><br><span class="line"><span class="meta"> \</span></span><br><span class="line"><span class="meta">		<span class="comment">/** Constructor, initializes return property only **/</span> \</span></span><br><span class="line"><span class="meta">		MyActor_eventTESTFUNC_Parms() \</span></span><br><span class="line"><span class="meta">			: ReturnValue(false) \</span></span><br><span class="line"><span class="meta">		&#123; \</span></span><br><span class="line"><span class="meta">		&#125; \</span></span><br><span class="line"><span class="meta">	&#125;; \</span></span><br><span class="line"><span class="meta">	struct MyActor_eventTESTImplEvent_Parms \</span></span><br><span class="line"><span class="meta">	&#123; \</span></span><br><span class="line"><span class="meta">		AActor* InActor; \</span></span><br><span class="line"><span class="meta">		int32 InIval; \</span></span><br><span class="line"><span class="meta">		bool ReturnValue; \</span></span><br><span class="line"><span class="meta"> \</span></span><br><span class="line"><span class="meta">		<span class="comment">/** Constructor, initializes return property only **/</span> \</span></span><br><span class="line"><span class="meta">		MyActor_eventTESTImplEvent_Parms() \</span></span><br><span class="line"><span class="meta">			: ReturnValue(false) \</span></span><br><span class="line"><span class="meta">		&#123; \</span></span><br><span class="line"><span class="meta">		&#125; \</span></span><br><span class="line"><span class="meta">	&#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// gen.cpp</span></span><br><span class="line"><span class="keyword">static</span> FName NAME_AMyActor_TESTFUNC = <span class="built_in">FName</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;TESTFUNC&quot;</span>));</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">AMyActor::TESTFUNC</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	MyActor_eventTESTFUNC_Parms Parms;</span><br><span class="line">	<span class="built_in">ProcessEvent</span>(<span class="built_in">FindFunctionChecked</span>(NAME_AMyActor_TESTFUNC),&amp;Parms);</span><br><span class="line">	<span class="keyword">return</span> !!Parms.ReturnValue;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> FName NAME_AMyActor_TESTImplEvent = <span class="built_in">FName</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;TESTImplEvent&quot;</span>));</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">AMyActor::TESTImplEvent</span><span class="params">(AActor* InActor, int32 InIval)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	MyActor_eventTESTImplEvent_Parms Parms;</span><br><span class="line">	Parms.InActor=InActor;</span><br><span class="line">	Parms.InIval=InIval;</span><br><span class="line">	<span class="built_in">ProcessEvent</span>(<span class="built_in">FindFunctionChecked</span>(NAME_AMyActor_TESTImplEvent),&amp;Parms);</span><br><span class="line">	<span class="keyword">return</span> !!Parms.ReturnValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，UHT 帮我们定义了同名函数，并将其转发给<code>ProcessEvent</code>。</p>
<p>注意：这里通过 <code>FindFunctionChecked</code> 方法是调用的<code>UObject::FindFunctionChecked</code>：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">UFunction* <span class="title">UObject::FindFunction</span><span class="params">(FName InName)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">GetClass</span>()-&gt;<span class="built_in">FindFunctionByName</span>(InName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">UFunction* <span class="title">UObject::FindFunctionChecked</span><span class="params">(FName InName)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UFunction* Result = <span class="built_in">FindFunction</span>(InName);</span><br><span class="line">	<span class="keyword">if</span> (Result == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">UE_LOG</span>(LogScriptCore, Fatal, <span class="built_in">TEXT</span>(<span class="string">&quot;Failed to find function %s in %s&quot;</span>), *InName.<span class="built_in">ToString</span>(), *<span class="built_in">GetFullName</span>());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> Result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，这里传递给 <code>ProcessEvent</code> 的<code>UFunction*</code>就是从当前对象的 UClass 中得到的。</p>
<p>经过前面分分析可以知道，UnLua 实现的函数覆写，就是把 UClass 中的 UFunction 中的原生 thunk 函数指针替换为 <code>FLuaInvoker::execCallLua</code>，而且当一个对象的<code>BlueprintNativeEvent</code> 和<code>BlueprintImplementableEvent</code>函数被调用的时候会调用到 <code>ProcessEvent</code> 并传入对应的 <code>UFunction*</code>，在<code>ProcessEvent</code> 中又调<code>Invork</code>（调用其中的原生指针），也就是实现调用到了 unlua 中替换绑定的<code>FLuaInvoker::execCallLua</code>，在这个函数中再转发给调用 lua 端的函数，从而实现了覆写函数的目的。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/UnLua/analysis-overridden/unlua-process-event-call-stack.webp"></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Programming</category>
        <category>Lua</category>
      </categories>
      <tags>
        <tag>UnLua</tag>
      </tags>
  </entry>
  <entry>
    <title>基于 UnLua 的 Lua 编程指南</title>
    <url>/wiki/36659/</url>
    <content><![CDATA[<p>UE 使用的是 C++ 这种编译型语言，在编译之后就成了二进制，只有通过玩家重新安装才能打到更新游戏的目的。但是对于游戏业务而言，对于需求调整和 bug 修复时间要求非常迫切，频繁地让玩家更新 App 是不能接受的，游戏项目一般使用 Lua 作为游戏业务的脚本语言，是为了把运行时不可变的 C++ 代码变成运行时可更新的 Lua 代码。</p>
<p>UE 官方没有提供 Lua 的支持，但是腾讯开源了<a href="https://github.com/Tencent/UnLua">UnLua</a>，在我当前的项目使用了，这两天我梳理了一下 UnLua 的资料（主要是官方文档、issus、宣讲 PPT），加上自己测试 UnLua 写了一个小 Demo 的感悟，形成了本篇 UE 结合 UnLua 的编程指南，主要是总结使用 UnLua 来写业务的一些基本方法和坑，方便查看，本篇文章会持续更新。</p>
<blockquote>
<p>另外，Lua 文件打包成 Pak 可以用我之前开源的工具：<a href="https://github.com/hxhb/HotPatcher">hxhb/HotPatcher</a>，而且我基于 UnLua 自己修改了一个版本，添加了一些额外的优化，源码集成了 <a href="https://github.com/diegonehab/luasocket">Luasocket</a>/<a href="https://github.com/Tencent/LuaPanda">Luapanda</a>/<code>lpeg</code>/<code>Sproto</code>/<code>Luacrypt</code> 库，可以直接使用 <a href="https://github.com/Tencent/LuaPanda">LuaPanda</a> 调试，Github 地址为：<a href="https://github.com/hxhb/debugable-unlua">hxhb/debugable-unlua</a>.</p>
</blockquote>
<p><strong>参考资料</strong>：</p>
<ul>
<li><a href="UnLua/UnLua_UE4%E4%B8%8B%E7%9A%84Lua%E8%84%9A%E6%9C%AC%E6%8F%92%E4%BB%B6.pdf">UnLua_UE4 下的 Lua 脚本插件 PPT</a></li>
<li><a href="https://github.com/Tencent/UnLua/blob/master/UnLua_Programming_Guide_EN.md">UnLua_Programming_Guide_EN</a></li>
<li><a href="https://www.lua.org/pil/contents.html">Programming in Lua,1th</a></li>
<li><a href="https://github.com/Tencent/UnLua/issues/">Tencent/UnLua/issus</a></li>
</ul>
<h3 id="UnLua 注意事项"><a href="#UnLua 注意事项" class="headerlink" title="UnLua 注意事项"></a>UnLua 注意事项 </h3><p> 这些是 UnLua 官方仓库里我摘录出来的一些可能有坑的地方。</p>
<ul>
<li>并非所有的 UFUNCTION 都支持，只支持<code>BlueprintNativeEvent</code>/<code>BlueprintImplementationEvent</code>/<code>Replication Notify</code>/<code>Animation Notify</code>/<code>Input Event</code>。</li>
<li>UnLua 不支持多 State，所以在 PIE 模式下运行多个 Client 会有问题。<a href="https://github.com/Tencent/UnLua/issues/78">issus/78</a></li>
<li><del>不要在 Lua 里访问蓝图定义的结构体。<a href="https://github.com/Tencent/UnLua/issues/119">issues/119</a> / <a href="https://github.com/Tencent/UnLua/issues/40">issus/40</a></del>（新的提交已支持）</li>
<li>UnLua 里使用 <code>self.Super</code> 不会递归向下遍历继承层次中的所有基类。<a href="https://github.com/Tencent/UnLua/issues/131">issus/131</a></li>
<li>非 dynamic delegate 不支持。<a href="https://github.com/Tencent/UnLua/issues/128">issus/128</a></li>
<li>不可以直接导出类的 static 成员，但可以为它封装一个 static 方法。<a href="https://github.com/Tencent/UnLua/issues/22">issus/22</a></li>
<li>不支持绑定 lua 脚本到对象实例，NewObject 指定的脚本是绑定到 UCLASS 的。<a href="https://github.com/Tencent/UnLua/issues/134">issus/134</a></li>
<li>Unlua 里使用 <code>UE4.TArray</code> 的下标规则是从 1 开始的，与引擎中 <code>TArray</code> 以 0 开始不同.<a href="https://github.com/Tencent/UnLua/issues/41">issues/41</a></li>
<li>注意导出给 Lua 的函数很多与蓝图中的名字不同，如蓝图中的 <code>GetActorTransform</code> 其实在 lua 里要用 <code>GetTransform</code>，在 lua 里使用的名字都是 C++ 真实定义的函数名字，而不是<code>DisplayName</code> 的名字。</li>
</ul>
<h3 id="Lua 代码提示"><a href="#Lua 代码提示" class="headerlink" title="Lua 代码提示"></a>Lua 代码提示 </h3><h4 id="导出符号"><a href="# 导出符号" class="headerlink" title="导出符号"></a> 导出符号 </h4><p>UnLua 提供了对引擎内反射符号的导出，也可以自己静态导出非反射类的符号，并且提供了一个<code>Commandlet</code> 类<code>UUnLuaIntelliSenseCommandlet</code>导出这些符号。</p>
<p>下面简单介绍一下 <code>Commandlet</code> 的调用方法：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">UE4Editor-cmd.exe PROJECT_PATH.uproject -run=COMMANDLET</span><br></pre></td></tr></table></figure>
<p>那么 UnLua 的 Commandlet 用法为：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">D:\UnrealEngine\Epic\UE_4.23\Engine\Binaries\Win64\UE4Editor-cmd.exe C:\Users\imzlp\Documents\UnrealProjectSSD\MicroEnd_423\MicroEnd_423.uproject -run=UnLuaIntelliSense</span><br></pre></td></tr></table></figure>

<p>执行完毕之后，会生成 <code>UnLua/Interamate/IntelliSense</code> 这个目录，里面有引擎导出到 lua 的符号。</p>
<h4 id="VSCode 中使用"><a href="#VSCode 中使用" class="headerlink" title="VSCode 中使用"></a>VSCode 中使用 </h4><p> 在 VSCode 中安装 Emmylua 插件，安装之后把上一步生成的 <code>IntelliSense</code> 目录添加到 vcode 的工作区即可。</p>
<h3 id="调用父类函数"><a href="# 调用父类函数" class="headerlink" title="调用父类函数"></a>调用父类函数 </h3><p> 在 UEC++ 中，当我们重写了一个父类的虚函数，可以通过调用 <code>Super::</code> 来指定调用父类实现，但是在 Lua 中不同。</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="built_in">self</span>.Super.ReceiveBeginPlay(<span class="built_in">self</span>)</span><br></pre></td></tr></table></figure>
<p>在 Lua 使用 <code>self.Super</code> 来调用父类的函数。</p>
<blockquote>
<p>注意：UnLua 里的 Super 只是简单模拟了“继承”语义，在继承多层的情况下会有问题，Super 不会主动向下遍历 Super。“父类”不是 Class()返回的表的元表，只设置在 Super 这个 field 上（元表在插件的 c++ 代码里定义了，这个过程已经固化）。</p>
</blockquote>
<p>对于 <code> 基类的基类 </code> 的 Super 调用：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">a.lua</span><br><span class="line"><span class="keyword">local</span> a = Class()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">a:test</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> a</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------</span></span><br><span class="line"></span><br><span class="line">b.lua</span><br><span class="line"><span class="keyword">local</span> b = Class(<span class="string">&quot;a&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------</span></span><br><span class="line"></span><br><span class="line">c.lua</span><br><span class="line"><span class="keyword">local</span> c = Class(<span class="string">&quot;b&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">a:test</span><span class="params">()</span></span></span><br><span class="line"> c.Super.Super.test(<span class="built_in">self</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>该问题摘录于 UnLua 的 issus：<a href="https://github.com/Tencent/UnLua/issues/131">Class 内的 Super 的使用问题</a></p>
</blockquote>
<h3 id="调用被覆写的方法"><a href="# 调用被覆写的方法" class="headerlink" title="调用被覆写的方法"></a>调用被覆写的方法</h3><blockquote>
<p>注意：Lua 和原来的类并不是继承关系，而是依附关系，lua 依赖于蓝图或者 C++ 的类。Lua 覆写的类的函数，相当于给当前类的函数换了一个实现。</p>
</blockquote>
<p>当在 Lua 中重写了一个附属类的 UFUNCTION 函数时，可以通过下列方法调用, 有点类似于 <code>Super</code> 但要写成<code>Overridden</code>：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">BP_Game_C:ReceiveBeginPlay</span><span class="params">()</span></span></span><br><span class="line">   <span class="built_in">self</span>.Overridden.ReceiveBeginPlay(<span class="built_in">self</span>) </span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>注意一定要传 <code>self</code> 进去，不然 Unlua 调用的时候执行的参数检查会 Crash，在 UnLua 中调用 UE 函数有点类似于拿到成员函数的原生指针，必须要手动传 this 进去。</p>
<h3 id="调用 UE 的 C- 函数"><a href="# 调用 UE 的 C- 函数" class="headerlink" title="调用 UE 的 C++ 函数"></a>调用 UE 的 C++ 函数</h3><p>UnLua 在编译时可以开启是否启用 UE 的 namespace（也就是 UE 的函数都需要加 UE4 前缀）。</p>
<p>调用方法为：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">UE4.UKismetSystemLibrary.PrintString(<span class="built_in">self</span>,<span class="string">&quot;HelloWorld&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>参数与 C++ 调用的相匹配（具有默认参数的同样可以不写）：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">UKismetSystemLibrary::<span class="built_in">PrintString</span>(<span class="keyword">this</span>,<span class="built_in">TEXT</span>(<span class="string">&quot;Hello&quot;</span>))</span><br></pre></td></tr></table></figure>

<h3 id="覆写多返回值的函数"><a href="# 覆写多返回值的函数" class="headerlink" title="覆写多返回值的函数"></a>覆写多返回值的函数 </h3><h4 id="蓝图"><a href="# 蓝图" class="headerlink" title="蓝图"></a> 蓝图</h4><p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/36659/UnLua/override-mulit-return-value.webp"></p>
<p>覆写的 lua 代码：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">LoadingMap_C:GetName</span><span class="params">(InString)</span></span></span><br><span class="line">    UE4.UKismetSystemLibrary.PrintString(<span class="built_in">self</span>,InString)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>,<span class="string">&quot;helloworld&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h4 id="C"><a href="#C" class="headerlink" title="C++"></a>C++</h4><p>因为 C++ 的多返回值是通过传递引用参数进去实现的，所以在 Lua 中这个不太一样。</p>
<p>如下面的 C++ 函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// .h</span></span><br><span class="line"><span class="built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="string">&quot;GameCore|Flib|GameFrameworkStatics&quot;</span>, meta = (CallableWithoutWorldContext, WorldContext = <span class="string">&quot;WorldContextObject&quot;</span>))</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">LuaGetMultiReturnExample</span><span class="params">(UObject* WorldContextObject, FString&amp; OutString, int32&amp; OutInt, UObject*&amp; OutGameInstance)</span></span>;</span><br><span class="line"><span class="comment">// .cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UFlibGameFrameworkStatics::LuaGetMultiReturnExample</span><span class="params">(UObject* WorldContextObject, FString&amp; OutString, int32&amp; OutInt, UObject*&amp; OutGameInstance)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">bool</span> bStatus = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">if</span> (WorldContextObject)</span><br><span class="line">	&#123;</span><br><span class="line">		OutString = <span class="built_in">TEXT</span>(<span class="string">&quot;HelloWorld&quot;</span>);</span><br><span class="line">		OutInt = <span class="number">1111</span>;</span><br><span class="line">		OutGameInstance = UGameplayStatics::<span class="built_in">GetGameInstance</span>(WorldContextObject);</span><br><span class="line">		bStatus = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bStatus;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数接收 <code>WorldContextObject</code> 的参数，并接收 <code>FString</code>/<code>int32</code>/<code>UObject*</code> 这三个类型的引用类型，并返回一个 bool，那么这个函数该怎么在 lua 中接收这些参数值的？</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> ret1,ret2,ret3,ret4 = UE4.UFlibGameFrameworkStatics.LuaGetMultiReturnExample(<span class="built_in">self</span>,<span class="literal">nil</span>,<span class="literal">nil</span>,<span class="literal">nil</span>)</span><br></pre></td></tr></table></figure>

<p>这种 <code>local ret1,ret2=func()</code> 的这种写法是 Lua 里的规则，可以看 Programming in Lua，4th 的第六章。</p>
<blockquote>
<p>注意：接收引用参数的返回值和真正函数返回值的顺序是：ret1,ret2,ret3 都是引用参数，最终函数的返回 bool 是最后一个 ret4。</p>
</blockquote>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/36659/UnLua/lua-call-cpp-function-get-multi-ret.webp"></p>
<h4 id="非 const 引用参数作为返回值需要注意的问题"><a href="# 非 const 引用参数作为返回值需要注意的问题" class="headerlink" title="非 const 引用参数作为返回值需要注意的问题"></a>非 const 引用参数作为返回值需要注意的问题</h4><blockquote>
<p><strong>注意</strong>：当调用 UFUNCTION 函数时，非 const 引用参数可以忽略，但是非 UFUNCTION 而是静态导出的函数则不行，因为 UnLua 对静态导出的函数有参数个数检查。</p>
</blockquote>
<p>而且，使用引用作为返回参数的的使用方式需要考虑到下面两种情况：</p>
<ol>
<li>非 const 引用作为纯输出</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GetPlayerBaseInfo</span><span class="params">(int32 &amp;Level, <span class="keyword">float</span> &amp;Health, FString &amp;Name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Level = <span class="number">7</span>;</span><br><span class="line">    Health = <span class="number">77</span>;</span><br><span class="line">    Name = <span class="string">&quot;Marcus&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种情况下返回值和传入值是没有任何关系的。在 lua 中可以这么使用：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> level,heath,name = <span class="built_in">self</span>:GetPlayerBaseInfo(<span class="number">0</span>,<span class="number">0</span>,<span class="string">&quot;&quot;</span>);</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>非 const 引用参数既作为输入又作为输出</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GetPlayerBaseInfo</span><span class="params">(int32 &amp;Level, <span class="keyword">float</span> &amp;Health, FString &amp;Name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Level += <span class="number">7</span>;</span><br><span class="line">    Health += <span class="number">77</span>;</span><br><span class="line">    Name += <span class="string">&quot;Marcus&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这种情况下，返回值和输入是有直接关系的，所以不能像情况 1 中那样使用：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> level,heath,name</span><br><span class="line">level,heath,name = <span class="built_in">self</span>:GetPlayerBaseInfo(level,heath,name);</span><br></pre></td></tr></table></figure>

<p>在这种情况下，在 lua 里调用传入的参数和返回的参数是都 <strong> 必须 </strong> 要传递和接收的，这样才会有正常的行为，如果不接收返回值：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> level,heath,name</span><br><span class="line"><span class="built_in">self</span>:GetPlayerBaseInfo(level,heath,name);</span><br></pre></td></tr></table></figure>

<p><code>level,heath,name</code>这些传进去的对象的值并不会像 C++ 中传递的引用那样值会改变。</p>
<blockquote>
<p>所以函数怎么调用还是要看函数里是怎么写的。</p>
</blockquote>
<p>这个在 UnLua 的 issus 里有提到：<a href="https://github.com/Tencent/UnLua/issues/25">issus/25</a></p>
<h3 id="检测是否继承接口"><a href="# 检测是否继承接口" class="headerlink" title="检测是否继承接口"></a>检测是否继承接口</h3><p>C++ 里使用<code>UKismetSystemLibrary::DoesImplementInterface</code>，Lua 里也一样，不过区别是接口类型的传入：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> CubeClass = UE4.UClass.Load(<span class="string">&quot;/Game/Cube_Blueprint.Cube_Blueprint&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> World = <span class="built_in">self</span>:GetWorld()</span><br><span class="line"><span class="keyword">local</span> Cube_Ins = World:SpawnActor(CubeClass,<span class="built_in">self</span>:GetTransform(),UE4.ESpawnActorCollisionHandlingMethod.AlwaysSpawn, <span class="built_in">self</span>, <span class="built_in">self</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> UE4.UKismetSystemLibrary.DoesImplementInterface(Cube_Ins,UE4.UMyInterface) <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">print</span>(fmt(<span class="string">&quot;&#123;1&#125; inheritanced &#123;2&#125;&quot;</span>,CubeClass,UE4.UMyInterface))</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>要使用 <code>UE4.U*Interface</code> 这种形式。</p>
<h3 id="获取 TScriptInterface 接口对象"><a href="# 获取 TScriptInterface 接口对象" class="headerlink" title="获取 TScriptInterface 接口对象"></a>获取 TScriptInterface 接口对象 </h3><p> 当我们在 C++ 中获得一个接口时，获得的类型是 <code>TScriptInterface&lt;&gt;</code> 类型，本来以为还要自己导出 <code>TScriptInterface</code> 才可以拿到接口，但是发现并不是这样，UnLua 里可以直接拿到 <code>TScriptInterface&lt;&gt;</code> 就像普通的 UObject 对象：</p>
<p>如下面这样一个函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="string">&quot;GameCore|Flib|GameFrameworkStatics&quot;</span>, meta = (CallableWithoutWorldContext,WorldContext=<span class="string">&quot;WorldContextObject&quot;</span>))</span><br><span class="line"><span class="function"><span class="keyword">static</span> TScriptInterface&lt;IINetGameInstance&gt; <span class="title">GetNetGameInstance</span><span class="params">(UObject* WorldContextObject)</span></span>;</span><br></pre></td></tr></table></figure>

<p>在 Lua 里调用：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">local GameInstance = UE4.UFlibGameFrameworkStatics.<span class="built_in">GetNetGameInstance</span>(self);</span><br></pre></td></tr></table></figure>

<p>这个得到的类型在 C++ 里是 <code>TScriptInterface&lt;&gt;</code> 但在 Lua 里得到的就是该接口的 UObject 对象。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/posts/36659/UnLua/unlua-get-tscriptinterface.webp"></p>
<h3 id="调用成员函数"><a href="# 调用成员函数" class="headerlink" title="调用成员函数"></a>调用成员函数 </h3><p> 上面讲了怎么得到 <code>TScriptInterface</code> 的接口（在 lua 里得到的其实就是该接口的 UObject），那么怎么通过它来调用接口的函数呢？有三种方法。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// This class does not need to be modified.</span></span><br><span class="line"><span class="built_in">UINTERFACE</span>(BlueprintType,MinimalAPI)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UINetGameInstance</span> :</span> <span class="keyword">public</span> UIBaseEntityInterface</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GWORLD_API</span> <span class="title">IINetGameInstance</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">UFUNCTION</span>(Category = <span class="string">&quot;GameCore|GamePlayFramework&quot;</span>)</span><br><span class="line">		<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">FindSubsystem</span><span class="params">(<span class="keyword">const</span> FString&amp; InSysName,TScriptInterface&lt;IISubsystem&gt;&amp; OutSubsystem)</span></span>=<span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="通过对象调用函数"><a href="# 通过对象调用函数" class="headerlink" title="通过对象调用函数"></a>通过对象调用函数</h4><ol>
<li>可以通过拿到实现接口的对象然后通过该对象调用函数（使用 lua 的 <code>:</code> 操作符）：</li>
</ol>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> GameInstance = UE4.UFlibGameFrameworkStatics.GetNetGameInstance(<span class="built_in">self</span>);</span><br><span class="line"><span class="keyword">local</span> findRet1,findRet2 = GameInstance:FindSubsystem(<span class="string">&quot;TouchController&quot;</span>)</span><br></pre></td></tr></table></figure>
<h4 id="指定类和函数名调用"><a href="# 指定类和函数名调用" class="headerlink" title="指定类和函数名调用"></a>指定类和函数名调用</h4><ol start="2">
<li>也可以直接通过指定实现该接口的类型名字来调用，就像函数指针，需要把调用该函数的对象传递进去：</li>
</ol>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> GameInstance = UE4.UFlibGameFrameworkStatics.GetNetGameInstance(<span class="built_in">self</span>);</span><br><span class="line"><span class="keyword">local</span> findRet1,findRet2 = UE4.UNetGameInstance.FindSubsystem(GameInstance,<span class="string">&quot;TouchController&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="指定接口的类和函数名调用"><a href="# 指定接口的类和函数名调用" class="headerlink" title="指定接口的类和函数名调用"></a>指定接口的类和函数名调用</h4><ol start="3">
<li>以及通过接口的类型调用（因为接口也是 UClass，接口中的函数也都标记了 UFUNCTION）：</li>
</ol>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> GameInstance = UE4.UFlibGameFrameworkStatics.GetNetGameInstance(<span class="built_in">self</span>);</span><br><span class="line"><span class="keyword">local</span> findRet1,findRet2 = UE4.UINetGameInstance.FindSubsystem(GameInstance,<span class="string">&quot;TouchController&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="获取 UClass"><a href="# 获取 UClass" class="headerlink" title="获取 UClass"></a>获取 UClass</h3><p>lua 中获取 uclass 可以用于创建对象，其方法为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">local uclass = UE4.UClass.<span class="built_in">Load</span>(<span class="string">&quot;/Game/Core/Blueprints/AI/BP_AICharacter.BP_AICharacter_C&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>Load 的路径是该类的<code>PackagePath</code>。</p>
<p>如，在 lua 中加载 UMG 的类然后创建并添加至视口：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">LoadingMap_C:ReceiveBeginPlay</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> UMG_C = UE4.UClass.Load(<span class="string">&quot;/Game/Test/BPUI_TestMain.BPUI_TestMain_C&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> UMG_TestMain_Ins = UE4.UWidgetBlueprintLibrary.Create(<span class="built_in">self</span>,UMG_C)</span><br><span class="line">    UMG_TestMain_Ins:AddToViewport()</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>注意：UnLua 官方的 <code>UE4.UClass.Load</code> 实现是默认只能创建蓝图类的，具体实现看 <code>LuaLib_Class.cpp</code> 中的 <code>UClass_Load</code> 的实现。</p>
<p>可以修改一下支持 C++ 的类：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">int32 <span class="title">UClass_Load</span><span class="params">(lua_State *L)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    int32 NumParams = <span class="built_in">lua_gettop</span>(L);</span><br><span class="line">    <span class="keyword">if</span> (NumParams != <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogUnLua, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;%s: Invalid parameters!&quot;</span>), <span class="built_in">ANSI_TO_TCHAR</span>(__FUNCTION__));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *ClassName = <span class="built_in">lua_tostring</span>(L, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (!ClassName)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogUnLua, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;%s: Invalid class name!&quot;</span>), <span class="built_in">ANSI_TO_TCHAR</span>(__FUNCTION__));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="function">FString <span class="title">ClassPath</span><span class="params">(ClassName)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> IsCppClass = ClassPath.<span class="built_in">StartsWith</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;/Script&quot;</span>));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!IsCppClass)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">const</span> TCHAR *Suffix = <span class="built_in">TEXT</span>(<span class="string">&quot;_C&quot;</span>);</span><br><span class="line">		int32 Index = INDEX_NONE;</span><br><span class="line">		ClassPath.<span class="built_in">FindChar</span>(<span class="built_in">TCHAR</span>(<span class="string">&#x27;.&#x27;</span>), Index);</span><br><span class="line">		<span class="keyword">if</span> (Index == INDEX_NONE)</span><br><span class="line">		&#123;</span><br><span class="line">			ClassPath.<span class="built_in">FindLastChar</span>(<span class="built_in">TCHAR</span>(<span class="string">&#x27;/&#x27;</span>), Index);</span><br><span class="line">			<span class="keyword">if</span> (Index != INDEX_NONE)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">const</span> FString Name = ClassPath.<span class="built_in">Mid</span>(Index + <span class="number">1</span>);</span><br><span class="line">				ClassPath += <span class="built_in">TCHAR</span>(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">				ClassPath += Name;</span><br><span class="line">				ClassPath.<span class="built_in">AppendChars</span>(Suffix, <span class="number">2</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (ClassPath.<span class="built_in">Right</span>(<span class="number">2</span>) != <span class="built_in">TEXT</span>(<span class="string">&quot;_C&quot;</span>))</span><br><span class="line">			&#123;</span><br><span class="line">				ClassPath.<span class="built_in">AppendChars</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;_C&quot;</span>), <span class="number">2</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    FClassDesc *ClassDesc = <span class="built_in">RegisterClass</span>(L, <span class="built_in">TCHAR_TO_ANSI</span>(*ClassPath));</span><br><span class="line">    <span class="keyword">if</span> (ClassDesc &amp;&amp; ClassDesc-&gt;<span class="built_in">AsClass</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        UnLua::<span class="built_in">PushUObject</span>(L, ClassDesc-&gt;<span class="built_in">AsClass</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">lua_pushnil</span>(L);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>C++ 类的路径为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">/Script/GWorld.GWorldGameEngine</span><br></pre></td></tr></table></figure>

<p>以 <code>/Script</code> 开头，其后是该 C++ 类所属的模块名，<code>.</code>之后的是类名（不包含 <code>U</code>/<code>A</code> 之类的开头）。</p>
<h3 id="LoadObject"><a href="#LoadObject" class="headerlink" title="LoadObject"></a>LoadObject</h3><p>把资源加载到内存：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> Object = LoadObject(<span class="string">&quot;/Game/Core/Blueprints/AI/BT_Enemy&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>比如加载某个材质球给模型：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">function Cube3_Blueprint_C:<span class="built_in">ReceiveBeginPlay</span>()</span><br><span class="line">    local MatIns = <span class="built_in">LoadObject</span>(<span class="string">&quot;/Game/TEST/Cube_Mat_Ins&quot;</span>)</span><br><span class="line">    UE4.UPrimitiveComponent.<span class="built_in">SetMaterial</span>(self.StaticMeshComponent,<span class="number">0</span>,MatIns)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>注：LuaObject 在 UnLua 里对应的是<code>LoadObject&lt;Object&gt;</code>:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">int32 <span class="title">UObject_Load</span><span class="params">(lua_State *L)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">  UObject *Object = LoadObject&lt;UObject&gt;(<span class="literal">nullptr</span>, *ObjectPath);</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="创建对象"><a href="# 创建对象" class="headerlink" title="创建对象"></a>创建对象</h3><blockquote>
<p>注意：Lua 中创建的对象使用动态绑定是绑定到该类的 UCLASS 上，并不是绑定到该 New 出来的实例。</p>
</blockquote>
<p>UnLua 中对 <code>NewObject</code> 处理的代码为<code>Global_NewObject</code>：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">FScopedLuaDynamicBinding <span class="title">Binding</span><span class="params">(L, Class, ANSI_TO_TCHAR(ModuleName), TableRef)</span></span>;</span><br><span class="line">UObject *Object = <span class="built_in">StaticConstructObject_Internal</span>(Class, Outer, Name);</span><br></pre></td></tr></table></figure>

<h4 id="SpawnActor"><a href="#SpawnActor" class="headerlink" title="SpawnActor"></a>SpawnActor</h4><p>Lua 中 SpawnActor 以及动态绑定：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> World = <span class="built_in">self</span>:GetWorld()</span><br><span class="line"><span class="keyword">local</span> WeaponClass = UE4.UClass.Load(<span class="string">&quot;/Game/Core/Blueprints/Weapon/BP_DefaultWeapon.BP_DefaultWeapon&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> NewWeapon = World:SpawnActor(WeaponClass, <span class="built_in">self</span>:GetTransform(), UE4.ESpawnActorCollisionHandlingMethod.AlwaysSpawn, <span class="built_in">self</span>, <span class="built_in">self</span>, <span class="string">&quot;Weapon.BP_DefaultWeapon_C&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="NewObject"><a href="#NewObject" class="headerlink" title="NewObject"></a>NewObject</h4><p>lua 中调用 NewObject 以及动态绑定：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> ProxyObj = NewObject(ObjClass, <span class="built_in">self</span>, <span class="literal">nil</span>, <span class="string">&quot;Objects.ProxyObject&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>UnLua 中的 <code>NewObject</code> 可以接收四个参数，依次是：创建的 UClass、Outer、Name，以及动态绑定的 Lua 脚本。</p>
<h4 id="Component"><a href="#Component" class="headerlink" title="Component"></a>Component</h4><blockquote>
<p>注意：原版 UnLua 只可以加载 BP 的 UClass，这个需要做改动 (修改<code>LuaLib_Class.cpp</code> 中的 <code>UClass_Load</code> 函数，检测传入是 C++ 类时把添加 <code>_C</code> 后缀的逻辑去掉)， 而且创建 Component 时也需要对其调用 <code>OnComponentCreated</code> 和<code>RegisterComponent</code>，这两个函数不是 UFUNCTION，需要手动导出。</p>
</blockquote>
<p>导出 ActorComponent 中 <code>OnComponentCreated</code> 和<code>RegisterComponent</code>等函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Export Actor Component</span></span><br><span class="line"><span class="built_in">BEGIN_EXPORT_REFLECTED_CLASS</span>(UActorComponent)</span><br><span class="line">	<span class="built_in">ADD_FUNCTION</span>(RegisterComponent)</span><br><span class="line">	<span class="built_in">ADD_FUNCTION</span>(OnComponentCreated)</span><br><span class="line">	<span class="built_in">ADD_FUNCTION</span>(UnregisterComponent)</span><br><span class="line">	<span class="built_in">ADD_CONST_FUNCTION_EX</span>(<span class="string">&quot;IsRegistered&quot;</span>,<span class="keyword">bool</span>, IsRegistered)</span><br><span class="line">	<span class="built_in">ADD_CONST_FUNCTION_EX</span>(<span class="string">&quot;HasBeenCreated&quot;</span>,<span class="keyword">bool</span>, HasBeenCreated)</span><br><span class="line"><span class="built_in">END_EXPORT_CLASS</span>()</span><br><span class="line"><span class="built_in">IMPLEMENT_EXPORTED_CLASS</span>(UActorComponent)</span><br></pre></td></tr></table></figure>

<p>则使用时与 C++ 的使用方法一致：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> StaticMeshClass = UE4.UClass.Load(<span class="string">&quot;/Script/Engine.StaticMeshComponent&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> MeshObject = LoadObject(<span class="string">&quot;/Engine/VREditor/LaserPointer/CursorPointer&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> StaticMeshComponent= NewObject(StaticMeshClass,<span class="built_in">self</span>,<span class="string">&quot;StaticMesh&quot;</span>)</span><br><span class="line">StaticMeshComponent:SetStaticMesh(MeshObject)</span><br><span class="line">StaticMeshComponent:RegisterComponent()</span><br><span class="line">StaticMeshComponent:OnComponentCreated()</span><br><span class="line"><span class="built_in">self</span>:ReceiveStaticMeshComponent(StaticMeshComponent)</span><br><span class="line"><span class="comment">-- StaticMeshComponent:K2_AttachToComponent(self.StaticMeshComponent,&quot;&quot;,EAttachmentRule.SnapToTarget,EAttachmentRule.SnapToTarget,EAttachmentRule.SnapToTarget)</span></span><br><span class="line">UE4.UStaticMeshComponent.K2_AttachToComponent(StaticMeshComponent,<span class="built_in">self</span>.StaticMeshComponent,<span class="string">&quot;&quot;</span>,EAttachmentRule.SnapToTarget,EAttachmentRule.SnapToTarget,EAttachmentRule.SnapToTarget)</span><br></pre></td></tr></table></figure>

<h4 id="UMG"><a href="#UMG" class="headerlink" title="UMG"></a>UMG</h4><p>创建 UMG 首先需要获取到 UI 的 UClass，然后使用 <code>UWidgetBlueprintLibrary::Create</code> 来创建，与 C++ 一致：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> UMG_C = UE4.UClass.Load(<span class="string">&quot;/Game/Test/BPUI_TestMain.BPUI_TestMain_C&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> UMG_TestMain_Ins = UE4.UWidgetBlueprintLibrary.Create(<span class="built_in">self</span>,UMG_C)</span><br><span class="line">UMG_TestMain_Ins:AddToViewport()</span><br></pre></td></tr></table></figure>

<h3 id="绑定代理"><a href="# 绑定代理" class="headerlink" title="绑定代理"></a>绑定代理 </h3><h4 id="动态多播代理"><a href="# 动态多播代理" class="headerlink" title="动态多播代理"></a> 动态多播代理 </h4><p> 在 C++ 代码中写了一个动态多播代理：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam</span>(FGameInstanceDyDlg, <span class="keyword">const</span> FString&amp;,InString);</span><br><span class="line"></span><br><span class="line"><span class="comment">// in class</span></span><br><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line">FGameInstanceDyDlg GameInstanceDyDlg;</span><br></pre></td></tr></table></figure>

<p>在 lua 中绑定，可以绑定到 lua 的函数：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> GameInstance = UE4.UFlibGameFrameworkStatics.GetNetGameInstance(<span class="built_in">self</span>);</span><br><span class="line">GameInstance.GameInstanceDyMultiDlg:Add(<span class="built_in">self</span>,LoadingMap_C.BindGameInstanceDyMultiDlg)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- test bind dynamic multicast delegate lua func</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">LoadingMap_C:BindGameInstanceDyMultiDlg</span><span class="params">(InString)</span></span></span><br><span class="line">    UE4.UKismetSystemLibrary.PrintString(<span class="built_in">self</span>,InString)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>同样也可以对该代理进行调用、清理、移除：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">-- remove </span><br><span class="line">GameInstance.GameInstanceDyMultiDlg:<span class="built_in">Remove</span>(self,LoadingMap_C.BindGameInstanceDyDlg)</span><br><span class="line">-- Clear</span><br><span class="line">GameInstance.GameInstanceDyMultiDlg:<span class="built_in">Clear</span>()</span><br><span class="line">-- broadcast</span><br><span class="line">GameInstance.GameInstanceDyMultiDlg:<span class="built_in">Broadcast</span>(<span class="string">&quot;66666666&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="动态代理"><a href="# 动态代理" class="headerlink" title="动态代理"></a>动态代理</h4><p>C++ 中有如下动态代理声明：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">DECLARE_DYNAMIC_DELEGATE_OneParam</span>(FGameInstanceDyDlg,<span class="keyword">const</span> FString&amp;,InString);</span><br><span class="line"></span><br><span class="line"><span class="comment">// in class</span></span><br><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line">FGameInstanceDyDlg GameInstanceDyDlg;</span><br></pre></td></tr></table></figure>

<p>在 lua 中绑定：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">GameInstance.GameInstanceDyDlg:Bind(<span class="built_in">self</span>,LoadingMap_C.BindGameInstanceDyMultiDlg)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- test bind dynamic delegate lua func</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">LoadingMap_C:BindGameInstanceDyDlg</span><span class="params">(InString)</span></span></span><br><span class="line">    UE4.UKismetSystemLibrary.PrintString(<span class="built_in">self</span>,InString)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>动态代理支持 <code>Bind</code>/<code>Unbind</code>/<code>Execute</code> 操作：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- bind</span></span><br><span class="line">GameInstance.GameInstanceDyDlg:Bind(<span class="built_in">self</span>,LoadingMap_C.BindGameInstanceDyMultiDlg)</span><br><span class="line"><span class="comment">-- UnBind</span></span><br><span class="line">GameInstance.GameInstanceDyDlg:Unbind()</span><br><span class="line"><span class="comment">-- Execute</span></span><br><span class="line">GameInstance.GameInstanceDyDlg:Execute(<span class="string">&quot;GameInstanceDyMultiDlg&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="不支持非 Dynamic-Delegate"><a href="# 不支持非 Dynamic-Delegate" class="headerlink" title="不支持非 Dynamic Delegate"></a>不支持非 Dynamic Delegate</h4><p>因为 <code>BindStatic</code>/<code>BindRaw</code>/<code>BindUFunction</code> 这些都是模板函数，UnLua 的静态导出方案不支持将他们导出。</p>
<p>官方 issus：<a href="https://github.com/Tencent/UnLua/issues/128">如何正确静态导出继承自 FScriptDelegate 的普通委托</a></p>
<h3 id="使用异步事件"><a href="# 使用异步事件" class="headerlink" title="使用异步事件"></a>使用异步事件 </h3><h4 id="Delay"><a href="#Delay" class="headerlink" title="Delay"></a>Delay</h4><p> 如果想要使用类似 Delay 的函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Perform a latent action with a delay (specified in seconds).  Calling again while it is counting down will be ignored.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param WorldContextWorld context.</span></span><br><span class="line"><span class="comment"> * @param Duration length of delay (in seconds).</span></span><br><span class="line"><span class="comment"> * @param LatentInfo The latent action.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">UFUNCTION</span>(BlueprintCallable, Category=<span class="string">&quot;Utilities|FlowControl&quot;</span>, meta=(Latent, WorldContext=<span class="string">&quot;WorldContextObject&quot;</span>, LatentInfo=<span class="string">&quot;LatentInfo&quot;</span>, Duration=<span class="string">&quot;0.2&quot;</span>, Keywords=<span class="string">&quot;sleep&quot;</span>))</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">voidDelay</span><span class="params">(UObject* WorldContextObject, <span class="keyword">float</span> Duration, struct FLatentActionInfo LatentInfo )</span></span>;</span><br></pre></td></tr></table></figure>

<p>在 lua 中可以通过 <code> 协程 (coroutine)</code> 来实现：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">LoadingMap_C:DelayFunc</span><span class="params">(Induration)</span></span></span><br><span class="line">    <span class="built_in">coroutine</span>.<span class="built_in">resume</span>(<span class="built_in">coroutine</span>.<span class="built_in">create</span>(</span><br><span class="line">        <span class="function"><span class="keyword">function</span><span class="params">(WorldContectObject,duration)</span></span>    </span><br><span class="line">            UE4.UKismetSystemLibrary.Delay(WorldContectObject,duration)</span><br><span class="line">            UE4.UKismetSystemLibrary.PrintString(WorldContectObject,<span class="string">&quot;Helloworld&quot;</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    ),</span><br><span class="line">    <span class="built_in">self</span>,Induration)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>就是通过 <code>coroutine.create</code> 绑定上一个函数，可以直接在 <code>coroutine.create</code> 里写，或者绑定上一个已有的函数：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">LoadingMap_C:DelayFunc</span><span class="params">(Induration)</span></span></span><br><span class="line">    <span class="built_in">coroutine</span>.<span class="built_in">resume</span>(<span class="built_in">coroutine</span>.<span class="built_in">create</span>(LoadingMap_C.DoDelay),<span class="built_in">self</span>,<span class="built_in">self</span>,Induration)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">LoadingMap_C:DoDelay</span><span class="params">(WorldContectObject,duration)</span></span>    </span><br><span class="line">    UE4.UKismetSystemLibrary.Delay(WorldContectObject,duration)</span><br><span class="line">    UE4.UKismetSystemLibrary.PrintString(WorldContectObject,<span class="string">&quot;Helloworld&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>但是要 <strong> 注意一点</strong>：在绑定已有的 lua 函数时，传递的参数需要多一个<code>self</code>，标识调用指定函数的调用者。</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="built_in">coroutine</span>.<span class="built_in">resume</span>(<span class="built_in">coroutine</span>.<span class="built_in">create</span>(LoadingMap_C.DoDelay),<span class="built_in">self</span>,<span class="built_in">self</span>,Induration)</span><br></pre></td></tr></table></figure>

<p>这里的第一个 <code>self</code>，就是在通过<code>self</code> 调用<code>LoadingMap_C.DoDelay</code>，后面的两个参数才作为传递给协程函数的参数。</p>
<p>调用代码为：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">LoadingMap_C:ReceiveBeginPlay</span><span class="params">()</span></span></span><br><span class="line">    <span class="comment">-- 5s 后输出 HelloWorld</span></span><br><span class="line">    <span class="built_in">self</span>:DelayFunc(<span class="number">5.0</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：对于直接是 UFUNCTION 但是带有 <code>FLatentActionInfo</code> 的函数可以直接使用上面的方法，但是对于 UE 封装的异步节点，不是函数而是一个类的节点需要自己导出。</p>
</blockquote>
<h4 id="AsyncLoadPrimaryAsset"><a href="#AsyncLoadPrimaryAsset" class="headerlink" title="AsyncLoadPrimaryAsset"></a>AsyncLoadPrimaryAsset</h4><p>在 C++ 里可以使用 <code>UAsyncActionLoadPrimaryAsset::AsyncLoadPrimaryAsset</code> 来异步加载资源：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Load a primary asset into memory. The completed delegate will go off when the load succeeds or fails, you should cast the Loaded object to verify it is the correct type.</span></span><br><span class="line"><span class="comment"> * If LoadBundles is specified, those bundles are loaded along with the asset</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">UFUNCTION</span>(BlueprintCallable, meta=(BlueprintInternalUseOnly=<span class="string">&quot;true&quot;</span>, Category = <span class="string">&quot;AssetManager&quot;</span>, AutoCreateRefTerm = <span class="string">&quot;LoadBundles&quot;</span>, WorldContext = <span class="string">&quot;WorldContextObject&quot;</span>))</span><br><span class="line"><span class="function"><span class="keyword">static</span> UAsyncActionLoadPrimaryAsset* <span class="title">AsyncLoadPrimaryAsset</span><span class="params">(UObject* WorldContextObject, FPrimaryAssetId PrimaryAsset, <span class="keyword">const</span> TArray&lt;FName&gt;&amp; LoadBundles)</span></span>;</span><br></pre></td></tr></table></figure>

<p>想要在 Lua 中使用的话需要把 <code>FPrimaryAssetId</code> 这个结构导出：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;UnLuaEx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;LuaCore.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;UObject/PrimaryAssetId.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">BEGIN_EXPORT_CLASS</span>(FPrimaryAssetId,<span class="keyword">const</span> FString&amp;)</span><br><span class="line">	<span class="built_in">ADD_FUNCTION_EX</span>(<span class="string">&quot;ToString&quot;</span>,FString, ToString)</span><br><span class="line">	<span class="built_in">ADD_STATIC_FUNCTION_EX</span>(<span class="string">&quot;FromString&quot;</span>,FPrimaryAssetId, FromString,<span class="keyword">const</span> FString&amp;)</span><br><span class="line">	<span class="built_in">ADD_FUNCTION_EX</span>(<span class="string">&quot;IsValid&quot;</span>, <span class="keyword">bool</span>, IsValid)</span><br><span class="line"><span class="built_in">END_EXPORT_CLASS</span>()</span><br><span class="line"><span class="built_in">IMPLEMENT_EXPORTED_CLASS</span>(FPrimaryAssetId)</span><br></pre></td></tr></table></figure>

<p>然后就可以在 Lua 中使用了，如异步加载关卡资源，加载完成后打开：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Cube_Blueprint_C:ReceiveBeginPlay</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> Map = UE4.FPrimaryAssetId(<span class="string">&quot;Map:/Game/Test/LoadingMap&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> AsyncActionLoadPrimaryAsset = UE4.UAsyncActionLoadPrimaryAsset.AsyncLoadPrimaryAsset(<span class="built_in">self</span>,Map,<span class="literal">nil</span>)</span><br><span class="line">    AsyncActionLoadPrimaryAsset.Completed:Add(<span class="built_in">self</span>,Cube_Blueprint_C.ReceiveLoadedMap)</span><br><span class="line">    AsyncActionLoadPrimaryAsset:Activate()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Cube_Blueprint_C:ReceiveLoadedMap</span><span class="params">(Object)</span></span></span><br><span class="line">    UE4.UGameplayStatics.OpenLevel(<span class="built_in">self</span>,<span class="string">&quot;/Game/Test/LoadingMap&quot;</span>,<span class="literal">true</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h4 id="SetTimer"><a href="#SetTimer" class="headerlink" title="SetTimer"></a>SetTimer</h4><p>有些需求需要 Timer 循环调用，在 C++ 里可以使用 <code>UKismetSystemLibrary::K2_SetTimerDelegate</code>，在蓝图中对应的是<code>SetTimerByEvent</code>，因为它是<code>UFUNCTION</code> 的函数，所以在 lua 中也可以调用。</p>
<p>绑定代理和清理操作：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">LoadingMap_C:ReceiveBeginPlay</span><span class="params">()</span></span></span><br><span class="line">    UpdateUILoopCount = <span class="number">0</span>;</span><br><span class="line">	UpdateUITimerHandle = UE4.UKismetSystemLibrary.K2_SetTimerDelegate(&#123;<span class="built_in">self</span>,LoadingMap_C.UpdateUI&#125;,<span class="number">0.3</span>,<span class="literal">true</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">LoadingMap_C:UpdateUI</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">if</span> UpdateUILoopCount &lt; <span class="number">10</span> <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;HelloWorld&quot;</span>)</span><br><span class="line">        UpdateUILoopCount = UpdateUILoopCount + <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        UE4.UKismetSystemLibrary.K2_ClearAndInvalidateTimerHandle(<span class="built_in">self</span>,UpdateUITimerHandle)</span><br><span class="line">    <span class="keyword">end</span> </span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>{self,FUNCTION}会创建出来一个 Delegate，本来还以为要自己导出一个创建 Dynamic Delegate 的方法，其实不用。</p>
</blockquote>
<h3 id="绑定 UMG 控件事件"><a href="# 绑定 UMG 控件事件" class="headerlink" title="绑定 UMG 控件事件"></a>绑定 UMG 控件事件 </h3><p> 如果要绑定类似 <code>UButton</code> 的<code>OnPressed</code>/<code>OnClicked</code>/<code>OnReleased</code>/<code>OnHovered</code>/<code>OnUnhovered</code>等事件，它们都是多播代理，所以要用 <code>Add</code> 来添加：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">DECLARE_DYNAMIC_MULTICAST_DELEGATE</span>(FOnButtonClickedEvent);</span><br><span class="line"><span class="built_in">DECLARE_DYNAMIC_MULTICAST_DELEGATE</span>(FOnButtonPressedEvent);</span><br><span class="line"><span class="built_in">DECLARE_DYNAMIC_MULTICAST_DELEGATE</span>(FOnButtonReleasedEvent);</span><br><span class="line"><span class="built_in">DECLARE_DYNAMIC_MULTICAST_DELEGATE</span>(FOnButtonHoverEvent);</span><br></pre></td></tr></table></figure>

<p>在 lua 中绑定：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UMG_LoadingMap_C:Construct</span><span class="params">()</span></span></span><br><span class="line">    <span class="built_in">self</span>.ButtonItem.OnPressed:Add(<span class="built_in">self</span>,UMG_LoadingMap_C.OnButtonItemPressed)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UMG_LoadingMap_C:OnButtonItemPressed</span><span class="params">()</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;On Button Item Pressed&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="UE4-TArray"><a href="#UE4-TArray" class="headerlink" title="UE4.TArray"></a>UE4.TArray</h3><p>Unlua 里使用 <code>UE4.TArray</code> 的下标规则是从 1 开始的，而不是与引擎中相同的 0.<a href="https://github.com/Tencent/UnLua/issues/41">issues/41</a></p>
<h3 id="Cast"><a href="#Cast" class="headerlink" title="Cast"></a>Cast</h3><p>UnLua 里的类型转换语法为：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">Obj:Cast(UE4.AActor)</span><br></pre></td></tr></table></figure>

<p>如：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> Character = Pawn:Cast(UE4.ABP_CharacterBase_C)</span><br></pre></td></tr></table></figure>

<h3 id="lua 使用蓝图结构"><a href="#lua 使用蓝图结构" class="headerlink" title="lua 使用蓝图结构"></a>lua 使用蓝图结构 </h3><p> 在 bp 里创建一个蓝图结构:<br><img src="https://img.imzlp.com/imgs/zlp/blog/posts/36659/UnLua/ue-bp-struct.webp"><br>在 UnLua 里可以通过下列方式访问:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">local bp_struct_ins = UE4.<span class="built_in">FBPStruct</span>()</span><br><span class="line">bp_struct_ins.string = <span class="string">&quot;123456&quot;</span></span><br><span class="line">bp_struct_ins.int32 = <span class="number">12345</span></span><br><span class="line">bp_struct_ins.<span class="keyword">float</span> = <span class="number">123.456</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;string: &#123;&#125;,int32: &#123;&#125;,float: &#123;&#125;&quot;</span>,bp_struct_ins.string,bp_struct_ins.int32,bp_struct_ins.<span class="keyword">float</span>))</span><br></pre></td></tr></table></figure>
<p>可以像 C++ 的结构那样使用, 需要 <strong> 注意 </strong> 的地方为, 需要在蓝图结构类型的名字前加<code>F</code>, 如上面的例子里, 在蓝图中的名字为<code>BPStruct</code>, 在 UnLua 中访问时则为<code>FBPStruct</code>.</p>
<h3 id="Insight-Profiler"><a href="#Insight-Profiler" class="headerlink" title="Insight Profiler"></a>Insight Profiler</h3><p>详见 wiki：<a href="https://ue5wiki.com/wiki/351387851/">Insight Profiling in lua</a></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Programming</category>
        <category>Lua</category>
      </categories>
      <tags>
        <tag>UnLua</tag>
        <tag>热更新</tag>
        <tag>Lua</tag>
      </tags>
  </entry>
  <entry>
    <title>ON_SCOPE_EXIT</title>
    <url>/wiki/38318/</url>
    <content><![CDATA[<p>UE 中有一个宏<code>ON_SCOPE_EXIT</code>，它的用法为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Make sure module info is added to known modules and proper delegates are fired on exit.</span></span><br><span class="line">ON_SCOPE_EXIT</span><br><span class="line">&#123;</span><br><span class="line">  FModuleManager::<span class="built_in">Get</span>().<span class="built_in">AddModuleToModulesList</span>(InModuleName, ModuleInfo);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在 <a href="https://imzlp.com/posts/31203/">UE4 Modules:Find the DLL and load it</a> 里曾提到过这种用法：</p>
<blockquote>
<p>这段代码的意思是在退出当前的作用域 (Scope) 时执行 <code>&#123;&#125;</code> 中的逻辑，简单地来说，它定义了一个当前作用域的对象并托管了一个 Lambda，在离开当前作用域的时候通过 C++ 的 RAII 机制来调用托管的 Lambda.</p>
</blockquote>
<p>今天来简单分析一下它的实现。</p>
<p>首先，<code>ON_SCOPE_EXIT</code>的宏定义为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ON_SCOPE_EXIT const auto ANONYMOUS_VARIABLE(ScopeGuard_) = ::ScopeExitSupport::FScopeGuardSyntaxSupport() + [&amp;]()</span></span><br></pre></td></tr></table></figure>

<p>由此展开，最开始的那个使用的宏就等价替换为：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">auto</span> <span class="title">ANONYMOUS_VARIABLE</span><span class="params">(ScopeGuard_)</span> </span>= ::ScopeExitSupport::<span class="built_in">FScopeGuardSyntaxSupport</span>() + [&amp;]()&#123;</span><br><span class="line">    FModuleManager::<span class="built_in">Get</span>().<span class="built_in">AddModuleToModulesList</span>(InModuleName, ModuleInfo);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>通常 lambda 用在谓词和调用的时候还好理解，但是这个搞了个 <code>+</code> 有点不走寻常路，由此可以推断类型 <code>::ScopeExitSupport::FScopeGuardSyntaxSupport</code> 必然重载了 <code>operator+</code> 操作符，并且是个模板函数。</p>
<p>查看 <code>::ScopeExitSupport::FScopeGuardSyntaxSupport</code> 的代码：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime\Core\Public\Misc\ScopeExit.h</span></span><br><span class="line"><span class="keyword">namespace</span> ScopeExitSupport</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Not meant for direct consumption : use ON_SCOPE_EXIT instead.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * RAII class that calls a lambda when it is destroyed.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> FuncType&gt;</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">TScopeGuard</span> :</span> <span class="keyword">public</span> FNoncopyable</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// Given a lambda, constructs an RAII scope guard.</span></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">TScopeGuard</span><span class="params">(FuncType&amp;&amp; InFunc)</span></span></span><br><span class="line"><span class="function">      : Func(MoveTemp(InFunc))&#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This constructor needs to be available for the code to compile.</span></span><br><span class="line">    <span class="comment">// It will be almost definitely be RVOed out (even in DEBUG).</span></span><br><span class="line">    <span class="built_in">TScopeGuard</span>(TScopeGuard&amp;&amp; Other)</span><br><span class="line">      : <span class="built_in">Func</span>(<span class="built_in">MoveTemp</span>(Other.Func))</span><br><span class="line">    &#123;</span><br><span class="line">      Other.Func.<span class="built_in">Reset</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Causes</span></span><br><span class="line">    ~<span class="built_in">TScopeGuard</span>()</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (Func.<span class="built_in">IsSet</span>())</span><br><span class="line">      &#123;</span><br><span class="line">        Func.<span class="built_in">GetValue</span>()();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// The lambda to be executed when this guard goes out of scope.</span></span><br><span class="line">    TOptional&lt;FuncType&gt; Func;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">FScopeGuardSyntaxSupport</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> FuncType&gt;</span><br><span class="line">    TScopeGuard&lt;FuncType&gt; <span class="keyword">operator</span>+(FuncType&amp;&amp; InFunc)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> TScopeGuard&lt;FuncType&gt;(Forward&lt;FuncType&gt;(InFunc));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>果然！类型 <code>FScopeGuardSyntaxSupport</code> 通过模板重载了 <code>operator+</code>，它要求接收一个重载了<code>operator()</code> 的泛型 ** 函数对象 (functional object)** 类型，据此产生一个<code>TScopeGuard</code> 的类型，并将传递进来的函数对象托管，在这个 <code>TScopeGuard</code> 的对象的析构函数中 (destructor) 调用了托管的函数对象。</p>
<p>其中隐藏的关键是通过 <code>::ScopeExitSupport::FScopeGuardSyntaxSupport() + [&amp;]()&#123;&#125;</code> 得到的 <code>TScopeGuard</code> 的对象是个 ** 局部对象 (automattic storage duration)**，只存在于当前的作用域(Scope) 中，在离开当前作用域时会自动销毁(调用析构函数)，离开作用域时局部变量的销毁顺序为按定义的逆序执行。</p>
<blockquote>
<p>[ISO/IEC 14882:2014 § 6.6]On exit from a scope (however accomplished), objects with automatic storage duration (3.7.3) that have been constructed in that scope are destroyed in the reverse order of their construction.</p>
</blockquote>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Programming</category>
        <category>Tricks</category>
      </categories>
  </entry>
  <entry>
    <title>Mac 部署 UE 开发环境</title>
    <url>/wiki/2329190d/</url>
    <content><![CDATA[<h3 id="MacOS 安装 UE"><a href="#MacOS 安装 UE" class="headerlink" title="MacOS 安装 UE"></a>MacOS 安装 UE</h3><p>UE 要求 MacOS 的分区格式为 <strong> 不区分大小写 </strong>（不然 EpicLauncher 也无法安装），而且安装引擎的要求是系统版本大于<code>10.13.5</code>，否则会出现引擎崩溃和一些不支持的情况(尝试忽略错误无法安装成功)。<br> 编译依赖 xcode，就像依赖 VS 一样，需要安装编译环境。<br>如果安装完 UE 和 Xcode 之后创建项目提示下列错误：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">An error occurred <span class="keyword">while</span> trying to generate project files.</span><br><span class="line">Running Mono...</span><br><span class="line">Setting up Mono</span><br><span class="line">/Users/Shared/UnrealEngine/<span class="number">4.22</span>/Engine /Users/Shared/UnrealEngine/<span class="number">4.22</span>/Engine/Binaries/Mac</span><br><span class="line">Discovering modules, targets <span class="keyword">and</span> source code <span class="keyword">for</span> project...</span><br><span class="line">Compiling with non-<span class="function">standard <span class="title">Xcode</span> <span class="params">(xcode-select)</span>: /Library/Developer/CommandLineTools/</span></span><br><span class="line"><span class="function">Triggered an exception while looking for SDK directory in Xcode.app</span></span><br><span class="line"><span class="function">System.IO.DirectoryNotFoundException: Directory <span class="string">&#x27;/Library/Developer/CommandLineTools/Platforms/MacOSX.platform/Developer/SDKs&#x27;</span> not found.</span></span><br><span class="line"><span class="function">  at System.IO.Directory.ValidateDirectoryListing (System.String path, System.String searchPattern, System.Boolean&amp; stop) [<span class="number">0x00000</span>] in &lt;filename unknown&gt;:<span class="number">0</span> </span></span><br><span class="line"><span class="function">  at System.IO.Directory.GetFileSystemEntries (System.String path, System.String searchPattern, FileAttributes mask, FileAttributes attrs) [<span class="number">0x00000</span>] in &lt;filename unknown&gt;:<span class="number">0</span> </span></span><br><span class="line"><span class="function">  at System.IO.Directory.GetDirectories (System.String path, System.String searchPattern) [<span class="number">0x00000</span>] in &lt;filename unknown&gt;:<span class="number">0</span> </span></span><br><span class="line"><span class="function">  at System.IO.Directory.GetDirectories (System.String path) [<span class="number">0x00000</span>] in &lt;filename unknown&gt;:<span class="number">0</span> </span></span><br><span class="line"><span class="function">  at UnrealBuildTool.AppleToolChain.SelectSDK (System.String BaseSDKDir, System.String OSPrefix, System.String&amp; PlatformSDKVersion, Boolean bVerbose) [<span class="number">0x00000</span>] in &lt;filename unknown&gt;:<span class="number">0</span> </span></span><br><span class="line"><span class="function">ERROR: Invalid SDK MacOSX.sdk, not found in /Library/Developer/CommandLineTools/Platforms/MacOSX.platform/Developer/SDKs</span></span><br></pre></td></tr></table></figure>

<p>则安装<a href="https://download.developer.apple.com/Developer_Tools/Command_Line_Tools_macOS_10.13_for_Xcode_9.3/Command_Line_Tools_macOS_10.13_for_Xcode_9.3.dmg">Xcode Command Line Tools</a>，然后执行以下命令即可：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo ln -s /Applications/Xcode.app/Contents/Developer/Platforms /Library/Developer/CommandLineTools/</span><br></pre></td></tr></table></figure>

<ul>
<li><a href="https://forums.unrealengine.com/development-discussion/c-gameplay-programming/102037-os-x-can-t-create-new-project">OS X: Can’t create new project</a></li>
<li><a href="https://answers.unrealengine.com/questions/777184/i-cant-build-a-c-program-on-my-mac-with-xcode.html">I can’t build a c++ program on my Mac with Xcode</a></li>
</ul>
<h3 id="Mac 修改 SSHD 默认端口"><a href="#Mac 修改 SSHD 默认端口" class="headerlink" title="Mac 修改 SSHD 默认端口"></a>Mac 修改 SSHD 默认端口 </h3><p> 有些内网有端口限制，低于 xxxx 的端口默认不开放，所以在 22 端口被限制的情况下如何进行远程构建？修改 SSH 的默认端口！</p>
<p>编辑 <code>/etc/services</code> 文件中的 ssh 的端口：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim /etc/services</span><br></pre></td></tr></table></figure>
<p>把 SSH 的端口改为其他的：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh              22/udp     # SSH Remote Login Protocol</span><br><span class="line">ssh              22/tcp     # SSH Remote Login Protocol</span><br></pre></td></tr></table></figure>
<p>修改为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh              2222/udp     # SSH Remote Login Protocol</span><br><span class="line">ssh              2222/tcp     # SSH Remote Login Protocol</span><br></pre></td></tr></table></figure>
<p>保存退出。<br>还需要重新加载配置使端口生效：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo launchctl unload /System/Library/LaunchDaemons/ssh.plist</span><br><span class="line">$ sudo launchctl load -w /System/Library/LaunchDaemons/ssh.plist</span><br></pre></td></tr></table></figure>
<p>然后测试端口是否可以连接:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ssh localhost -p 2222</span><br></pre></td></tr></table></figure>

<ul>
<li><a href="https://superuser.com/questions/1398824/cant-change-port-listen-on-macos-x-mojave-for-built-in-ssh">Can’t change PORT listen on macOS X Mojave for built-in SSH</a></li>
</ul>
<h3 id="为 xcode 开启多线程编译"><a href="# 为 xcode 开启多线程编译" class="headerlink" title="为 xcode 开启多线程编译"></a>为 xcode 开启多线程编译 </h3><p> 首先看一下 Mac 的硬件配置：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sysctl machdep.cpu</span><br></pre></td></tr></table></figure>
<p>找到 <code>machdep.cpu.core_count</code> 字段，其中的数值就是 Mac 的核心数。</p>
<p>然后可以给 xcode 开启多线程，数量数为核心数 *2，如我的是 8 核，就可以开启 16 线程：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ defaults write com.apple.Xcode PBXNumberOfParallelBuildSubtasks 16</span><br></pre></td></tr></table></figure>
<h3 id="Mac 系统内置的 Framework"><a href="#Mac 系统内置的 Framework" class="headerlink" title="Mac 系统内置的 Framework"></a>Mac 系统内置的 Framework</h3><p>有时候需要在 UE 的模块中引入系统的 Framework，那么 Mac 默认包含哪些 Framework 呢？可以通过以下方式查看。<br>我使用的系统版本为 <code>10.15.2</code>，可以通过<code>sw_vers</code> 查看：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">buildmachine@LIPENGZHA-MC0 ~ % sw_vers</span><br><span class="line">ProductName:    Mac OS X</span><br><span class="line">ProductVersion: 10.15.2</span><br><span class="line">BuildVersion:   19C57</span><br></pre></td></tr></table></figure>
<p>系统内置的 Framework 在以下目录中：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/System/Library/Frameworks</span><br></pre></td></tr></table></figure>
<p>在 <code>10.15.2</code> 版本中包含以下 framework：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">AGL.framework                           ColorSync.framework                     CoreVideo.framework                    GameKit.framework</span><br><span class="line">LinkPresentation.framework              OpenGL.framework                        SoundAnalysis.framework</span><br><span class="line">AVFoundation.framework                  Combine.framework                       CoreWLAN.framework                     GameplayKit.framework</span><br><span class="line">LocalAuthentication.framework           PCSC.framework                          Speech.framework</span><br><span class="line">AVKit.framework                         Contacts.framework                      CryptoKit.framework                    HIDDriverKit.framework</span><br><span class="line">MapKit.framework                        PDFKit.framework                        SpriteKit.framework</span><br><span class="line">Accelerate.framework                    ContactsUI.framework                    CryptoTokenKit.framework               Hypervisor.framework</span><br><span class="line">MediaAccessibility.framework            PencilKit.framework                     StoreKit.framework</span><br><span class="line">Accounts.framework                      CoreAudio.framework                     DVDPlayback.framework                  ICADevices.framework</span><br><span class="line">MediaLibrary.framework                  Photos.framework                        SwiftUI.framework</span><br><span class="line">AdSupport.framework                     CoreAudioKit.framework                  DeviceCheck.framework                  IMServicePlugIn.framework</span><br><span class="line">MediaPlayer.framework                   PhotosUI.framework                      SyncServices.framework</span><br><span class="line">AddressBook.framework                   CoreAudioTypes.framework                DirectoryService.framework             IOBluetooth.framework</span><br><span class="line">MediaToolbox.framework                  PreferencePanes.framework               System.framework</span><br><span class="line">AppKit.framework                        CoreBluetooth.framework                 DiscRecording.framework                IOBluetoothUI.framework</span><br><span class="line">Message.framework                       PushKit.framework                       SystemConfiguration.framework</span><br><span class="line">AppleScriptKit.framework                CoreData.framework                      DiscRecordingUI.framework              IOKit.framework</span><br><span class="line">Metal.framework                         Python.framework                        SystemExtensions.framework</span><br><span class="line">AppleScriptObjC.framework               CoreDisplay.framework                   DiskArbitration.framework              IOSurface.framework</span><br><span class="line">MetalKit.framework                      QTKit.framework                         TWAIN.framework</span><br><span class="line">ApplicationServices.framework           CoreFoundation.framework                DriverKit.framework                    IOUSBHost.framework</span><br><span class="line">MetalPerformanceShaders.framework       Quartz.framework                        Tcl.framework</span><br><span class="line">AudioToolbox.framework                  CoreGraphics.framework                  EventKit.framework                     IdentityLookup.framework</span><br><span class="line">MetricKit.framework                     QuartzCore.framework                    Tk.framework</span><br><span class="line">AudioUnit.framework                     CoreHaptics.framework                   ExceptionHandling.framework            ImageCaptureCore.framework</span><br><span class="line">ModelIO.framework                       QuickLook.framework                     USBDriverKit.framework</span><br><span class="line">AudioVideoBridging.framework            CoreImage.framework                     ExecutionPolicy.framework              ImageIO.framework</span><br><span class="line">MultipeerConnectivity.framework         QuickLookThumbnailing.framework         UserNotifications.framework</span><br><span class="line">AuthenticationServices.framework        CoreLocation.framework                  ExternalAccessory.framework            InputMethodKit.framework</span><br><span class="line">NaturalLanguage.framework               RealityKit.framework                    VideoDecodeAcceleration.framework</span><br><span class="line">Automator.framework                     CoreMIDI.framework                      FWAUserLib.framework                   InstallerPlugins.framework</span><br><span class="line">NetFS.framework                         Ruby.framework                          VideoSubscriberAccount.framework</span><br><span class="line">BackgroundTasks.framework               CoreMIDIServer.framework                FileProvider.framework                 InstantMessage.framework</span><br><span class="line">Network.framework                       SafariServices.framework                VideoToolbox.framework</span><br><span class="line">BusinessChat.framework                  CoreML.framework                        FileProviderUI.framework               Intents.framework</span><br><span class="line">NetworkExtension.framework              SceneKit.framework                      Vision.framework</span><br><span class="line">CFNetwork.framework                     CoreMedia.framework                     FinderSync.framework                   JavaFrameEmbedding.framework</span><br><span class="line">NetworkingDriverKit.framework           ScreenSaver.framework                   WebKit.framework</span><br><span class="line">CalendarStore.framework                 CoreMediaIO.framework                   ForceFeedback.framework                JavaScriptCore.framework</span><br><span class="line">NotificationCenter.framework            ScriptingBridge.framework               iTunesLibrary.framework</span><br><span class="line">CallKit.framework                       CoreMotion.framework                    Foundation.framework                   JavaVM.framework</span><br><span class="line">OSAKit.framework                        Security.framework                      vecLib.framework</span><br><span class="line">Carbon.framework                        CoreServices.framework                  GLKit.framework                        Kerberos.framework</span><br><span class="line">OSLog.framework                         SecurityFoundation.framework            vmnet.framework</span><br><span class="line">CloudKit.framework                      CoreSpotlight.framework                 GLUT.framework                         Kernel.framework</span><br><span class="line">OpenAL.framework                        SecurityInterface.framework</span><br><span class="line">Cocoa.framework                         CoreTelephony.framework                 GSS.framework                          LDAP.framework</span><br><span class="line">OpenCL.framework                        ServiceManagement.framework</span><br><span class="line">Collaboration.framework                 CoreText.framework                      GameController.framework               LatentSemanticMapping.framework</span><br><span class="line">OpenDirectory.framework                 Social.framework</span><br></pre></td></tr></table></figure>
<h3 id="安装 CommandLineTool"><a href="# 安装 CommandLineTool" class="headerlink" title="安装 CommandLineTool"></a>安装 CommandLineTool</h3><blockquote>
<p>Xcode’s metal shader compiler was not found, verify Xcode has been installed on this Mac and that it has been selected in Xcode &gt; Preferences &gt; Locations &gt; Command-line Tools.</p>
</blockquote>
<p>相关问题：</p>
<ul>
<li><a href="https://answers.unrealengine.com/questions/723143/unreal-engine-inaccurately-reports-xcode-is-too-ol-1.html">Unreal Engine inaccurately reports “XCode is too old” when CommandLineTools installed</a></li>
</ul>
<p>离线安装 <code>XCode</code> 和<code>Command Line Tools for Xcode</code>可以从苹果的开发者网站下载：<a href="https://developer.apple.com/download/more/">More Downloads for Apple Developers</a></p>
<p>在安装完 <code>Command Line Tools</code> 之后，如果 cook 时还是提示这个错误，则需要执行下列命令 (当然要首先确保<code>/Library/Developer/CommandLineTools</code> 路径存在，一般 <code>Command Line Tools</code> 的默认安装路径是这个)：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo xcode-select -s /Library/Developer/CommandLineTools</span><br></pre></td></tr></table></figure>

<p>当设置 <code>CommandLineTools</code> 之后打包时可能会提示:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">ERROR: Invalid SDK MacOSX.sdk, <span class="keyword">not</span> found in /Library/Developer/CommandLineTools/Platforms/MacOSX.platform/Developer/SDKs</span><br></pre></td></tr></table></figure>
<p>这是因为通过 <code>xcode-select</code> 设置为 <code>CommandLineTools</code> 之后，打包时找不到 Xcode 里的库了。<br>解决的办法是在 <code>CommandLineTools</code> 的目录下创建一个 Xcode 中的 <code>Platforms</code> 目录的软连接：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo ln -s /Applications/Xcode.app/Contents/Developer/Platforms /Library/Developer/CommandLineTools/Platforms</span><br></pre></td></tr></table></figure>
<h3 id="actool 错误"><a href="#actool 错误" class="headerlink" title="actool 错误"></a>actool 错误</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UATHelper: Packaging (iOS):   xcrun: error: unable to find utility &quot;actool&quot;, not a developer tool or in PATH</span><br><span class="line">PackagingResults: Error: unable to find utility &quot;actool&quot;, not a developer tool or in PATH</span><br></pre></td></tr></table></figure>
<p>这是因为把 <code>CommandLinTool</code> 设置为默认的命令行工具之后，<code>CommandLinTool/use/bin</code>下并没有 <code>actool</code> 等工具。<br>这是个十分坑爹的问题，用 xcode 作为默认的命令行工具导致 Cook 不过，用 CommandLineTool 又在编译时有问题。<br>我的解办法是把 <code>/Applications/Xcode.app/Contents/Developer/usr/bin</code> 通过软连接方式链接到<code>/Library/Developer/CommandLineTools/usr</code>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 当然要先备份 CommandLineTool/usr/bin</span></span><br><span class="line">$ mv /Library/Developer/CommandLineTools/usr/bin /Library/Developer/CommandLineTools/usr/Command_bin</span><br><span class="line"><span class="comment"># 创建 xcode 的 bin 目录的软连接</span></span><br><span class="line">$ sudo ln -s /Applications/Xcode.app/Contents/Developer/usr/bin /Library/Developer/CommandLineTools/usr/bin</span><br></pre></td></tr></table></figure>
<h3 id="解除 MacOS 安装软件的限制"><a href="# 解除 MacOS 安装软件的限制" class="headerlink" title="解除 MacOS 安装软件的限制"></a>解除 MacOS 安装软件的限制</h3><ul>
<li>允许任何来源，运行第三方应用</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo spctl --master-disable</span><br></pre></td></tr></table></figure>
<ul>
<li>安装灰色的 dmg</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hdiutil attach <span class="comment">#dmg 文件名 #</span></span><br></pre></td></tr></table></figure>

<ul>
<li><a href="http://16bing.com/2017/04/06/mac-security-anywhere/">打开 macOS Sierra 允许“任何来源”选项，运行第三方应用</a></li>
<li><a href="http://www.voidcn.com/article/p-gtvyrrux-bau.html">Mac dmg 文件灰色无法安装</a></li>
</ul>
<h3 id="MacOS 读写 NTFS"><a href="#MacOS 读写 NTFS" class="headerlink" title="MacOS 读写 NTFS"></a>MacOS 读写 NTFS</h3><p>装上 macOS 之后发现，macOS 可以读取 ntfs 的文件，但是不可以写入，这十分蛋疼。<br>查了一下说是因为微软的限制，但是 macOS 本身是做了读写的功能的，只是被关闭了，可以通过以下方法开启。</p>
<p>首先，在终端下执行 <code>diskutil list</code> 查看磁盘信息：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">visionsmile$ diskutil list</span><br><span class="line">/dev/disk0 (internal, physical):</span><br><span class="line">   <span class="comment">#:                       TYPE NAME                    SIZE       IDENTIFIER</span></span><br><span class="line">   0:      GUID_partition_scheme                        *240.1 GB   disk0</span><br><span class="line">   1:                        EFI                         312.5 MB   disk0s1</span><br><span class="line">   2:         Microsoft Reserved                         134.2 MB   disk0s2</span><br><span class="line">   3:       Microsoft Basic Data Windows                 164.3 GB   disk0s3</span><br><span class="line">   4:                 Apple_APFS Container disk1         75.3 GB    disk0s4</span><br><span class="line"></span><br><span class="line">/dev/disk1 (synthesized):</span><br><span class="line">   <span class="comment">#:                       TYPE NAME                    SIZE       IDENTIFIER</span></span><br><span class="line">   0:      APFS Container Scheme -                      +75.3 GB    disk1</span><br><span class="line">                                 Physical Store disk0s4</span><br><span class="line">   1:                APFS Volume OSX                     34.2 GB    disk1s1</span><br><span class="line">   2:                APFS Volume Preboot                 21.1 MB    disk1s2</span><br><span class="line">   3:                APFS Volume Recovery                509.8 MB   disk1s3</span><br><span class="line">   4:                APFS Volume VM                      2.1 GB     disk1s4</span><br><span class="line"></span><br><span class="line">/dev/disk2 (external, physical):</span><br><span class="line">   <span class="comment">#:                       TYPE NAME                    SIZE       IDENTIFIER</span></span><br><span class="line">   0:      GUID_partition_scheme                        *4.0 TB     disk2</span><br><span class="line">   1:         Microsoft Reserved                         134.2 MB   disk2s1</span><br><span class="line">   2:       Microsoft Basic Data Document                4.0 TB     disk2s2</span><br><span class="line"></span><br><span class="line">/dev/disk3 (internal, physical):</span><br><span class="line">   <span class="comment">#:                       TYPE NAME                    SIZE       IDENTIFIER</span></span><br><span class="line">   0:     FDisk_partition_scheme                        *1.0 TB     disk3</span><br><span class="line">   1:               Windows_NTFS Documents2              1.0 TB     disk3s1</span><br></pre></td></tr></table></figure>
<p>需要记录的是 ntfs 磁盘的 NAME 信息，我这里有三个 ntfs 分区<code>windows</code>/<code>Documents</code>/<code>Documents2</code>.</p>
<p>然后继续执行命令，更新 fatab 文件：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo nano /etc/fstab</span><br></pre></td></tr></table></figure>
<p>输入下列内容，并把 <code>LABEL=</code> 之后的内容替换为上面记录的分区的名字：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">LABEL=Windows none ntfs rw,auto,nobrowse</span><br><span class="line">LABEL=Documents none ntfs rw,auto,nobrowse</span><br><span class="line">LABEL=Documents2 none ntfs rw,auto,nobrowse</span><br></pre></td></tr></table></figure>
<p>重启之后即可。<br>注意：重启之后的移动磁盘不会在桌面上现实，必须要打开 Finder 才可以看到。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>开发环境</category>
        <category>Mac</category>
      </categories>
      <tags>
        <tag>开发环境</tag>
        <tag>Mac</tag>
      </tags>
  </entry>
  <entry>
    <title>Windows 的 UE 编译环境</title>
    <url>/wiki/c4fd7a75/</url>
    <content><![CDATA[<p>Visual Studio Intaller 的下载地址：<a href="https://visualstudio.microsoft.com/">Visual Studio IDE, Code Editor</a><br> 开发 UE，可以使用以下 VS 的安装配置文件（保存为.vsconfig 文件，在 vs_installer 中导入）：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">&quot;version&quot;</span>: <span class="string">&quot;1.0&quot;</span>,</span><br><span class="line"><span class="attr">&quot;components&quot;</span>: [</span><br><span class="line"><span class="string">&quot;Microsoft.VisualStudio.Workload.NativeDesktop&quot;</span>,</span><br><span class="line"><span class="string">&quot;Microsoft.VisualStudio.Workload.Python&quot;</span>,</span><br><span class="line"><span class="string">&quot;Microsoft.VisualStudio.Workload.Node&quot;</span>,</span><br><span class="line"><span class="string">&quot;Microsoft.VisualStudio.Workload.NativeGame&quot;</span>,</span><br><span class="line"><span class="string">&quot;Microsoft.VisualStudio.Workload.NativeCrossPlat&quot;</span>,</span><br><span class="line"><span class="string">&quot;microsoft.visualstudio.component.debugger.justintime&quot;</span>,</span><br><span class="line"><span class="string">&quot;microsoft.net.component.4.6.2.sdk&quot;</span>,</span><br><span class="line"><span class="string">&quot;microsoft.net.component.4.6.2.targetingpack&quot;</span>,</span><br><span class="line"><span class="string">&quot;microsoft.net.component.4.7.sdk&quot;</span>,</span><br><span class="line"><span class="string">&quot;microsoft.net.component.4.7.targetingpack&quot;</span>,</span><br><span class="line"><span class="string">&quot;microsoft.net.component.4.7.1.sdk&quot;</span>,</span><br><span class="line"><span class="string">&quot;microsoft.net.component.4.7.1.targetingpack&quot;</span>,</span><br><span class="line"><span class="string">&quot;microsoft.net.component.4.7.2.sdk&quot;</span>,</span><br><span class="line"><span class="string">&quot;microsoft.net.component.4.7.2.targetingpack&quot;</span>,</span><br><span class="line"><span class="string">&quot;microsoft.visualstudio.component.vc.diagnostictools&quot;</span>,</span><br><span class="line"><span class="string">&quot;microsoft.visualstudio.component.vc.cmake.project&quot;</span>,</span><br><span class="line"><span class="string">&quot;microsoft.visualstudio.component.vc.atl&quot;</span>,</span><br><span class="line"><span class="string">&quot;microsoft.visualstudio.component.vc.testadapterforboosttest&quot;</span>,</span><br><span class="line"><span class="string">&quot;microsoft.visualstudio.component.vc.testadapterforgoogletest&quot;</span>,</span><br><span class="line"><span class="string">&quot;microsoft.visualstudio.component.winxp&quot;</span>,</span><br><span class="line"><span class="string">&quot;microsoft.visualstudio.component.vc.cli.support&quot;</span>,</span><br><span class="line"><span class="string">&quot;microsoft.visualstudio.component.vc.modules.x86.x64&quot;</span>,</span><br><span class="line"><span class="string">&quot;microsoft.component.netfx.core.runtime&quot;</span>,</span><br><span class="line"><span class="string">&quot;microsoft.component.cookiecuttertools&quot;</span>,</span><br><span class="line"><span class="string">&quot;microsoft.component.pythontools.web&quot;</span>,</span><br><span class="line"><span class="string">&quot;microsoft.visualstudio.component.classdesigner&quot;</span>,</span><br><span class="line"><span class="string">&quot;microsoft.net.component.3.5.developertools&quot;</span>,</span><br><span class="line"><span class="string">&quot;component.unreal.android&quot;</span>,</span><br><span class="line"><span class="string">&quot;component.linux.cmake&quot;</span>,</span><br><span class="line"><span class="string">&quot;microsoft.component.helpviewer&quot;</span>,</span><br><span class="line"><span class="string">&quot;microsoft.visualstudio.component.vc.clangc2&quot;</span>,</span><br><span class="line"><span class="string">&quot;microsoft.visualstudio.component.vc.tools.14.14&quot;</span></span><br><span class="line">]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>开发环境</category>
        <category>Windows</category>
      </categories>
      <tags>
        <tag>开发环境</tag>
        <tag>Windows</tag>
      </tags>
  </entry>
  <entry>
    <title>Editor 中资源打包和真机加载流程</title>
    <url>/wiki/5b49d53f/</url>
    <content><![CDATA[<p>随着游戏内资源越来越多，包体越来越大，但移动端的包大小是有限制的，不能无限度地把所有的资源都打到基础包中，Android 上限是 2G（可以开启 <code>Allow Large Obb files</code> 以支持 4G），IOS 提交到 AppStore 的上限也是 4G，通常会保持 IOS/Android 基础包内的资源统一，其余的资源用热更或动态下载的形式更新到设备上。</p>
<p>所以，实际上在 <strong> 开发阶段 </strong> 打进基础包内的资源，只是工程中的一部分。经常无法满足策划、美术、测试同学的验证需要。</p>
<ol>
<li>新的地图、资源想要在真机查看</li>
<li>包内资源有问题，提交后等待整包构建时间太久</li>
<li>基础包的资源量超标，可能无法添加新的资源</li>
</ol>
<p>基于这种需求，在开发阶段，可以使用 <strong> 基础包 </strong>+<strong> 补丁 </strong> 的形式实现。</p>
<h3 id="资源的打包"><a href="# 资源的打包" class="headerlink" title="资源的打包"></a>资源的打包 </h3><p> 在我们当前的工程中，在编辑器中，可以直接在资源、目录上右键选择<strong>Cook And Pak Actions</strong>，选择对应的平台，以及选择<strong>AnalysisDependencies</strong>（分析依赖）。</p>
<p>不同平台的包需要选择的不一样（根据自己项目实际情况选择）：</p>
<ul>
<li>安卓：Android_ASTC</li>
<li>IOS：IOS</li>
<li>PCVersion：WindowsNoEditor</li>
</ul>
<p><img src="https://img.imzlp.com/imgs/zlp/picgo/2022/20221018124619.png"></p>
<p>执行之后右下角会有执行提示：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/picgo/2022/20221018125021.png"></p>
<p>需要等待执行完毕，这个过程不会卡住编辑器，可以做其他的编辑操作。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/picgo/2022/20221018130012.png"></p>
<blockquote>
<p>执行的耗时取决于引用的资源量，以及所选择的资源之前有没有执行过打包（DDC）。</p>
</blockquote>
<p>执行完毕之后，会在项目的 <code>Saved/HotPatcher/Paks/&#123;EXECUTE_TIME&#125;/Android_ASTC</code> 下面创建出一个对应的 <strong>.pak</strong> 文件，这个 <strong>pak</strong> 文件就是打包资源的补丁包，文件名中包含了平台名，不同平台的 <strong>pak</strong> 文件 <strong> 不能混用</strong>。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/picgo/2022/20221018130123.png"></p>
<h3 id="放入真机中"><a href="# 放入真机中" class="headerlink" title="放入真机中"></a>放入真机中</h3><h4 id="PCVersion"><a href="#PCVersion" class="headerlink" title="PCVersion"></a>PCVersion</h4><p>PCVersion 需要将这个 Pak 文件放到以下目录中：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">WindowsNoEditor\PROJECT_NAME\Content\Paks</span><br></pre></td></tr></table></figure>
<p>若不存在 Paks 目录，可手动创建。</p>
<h4 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h4><p>在 Android 中，需要将这个 <strong>pak</strong> 文件放到下面目录中：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UE4Game/PROJECT_NAME/PROJECT_NAME/Saved/Paks</span><br></pre></td></tr></table></figure>
<p>如果修改了数据目录到沙盒路径，则是这个路径：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Android/data/com.xxxx.yyyy/files/UE4Game/PROJECT_NAME/PROJECT_NAME/Saved/Paks</span><br></pre></td></tr></table></figure>
<p>如果没有 Paks 目录，可以手动创建一个。</p>
<h4 id="IOS"><a href="#IOS" class="headerlink" title="IOS"></a>IOS</h4><p>IOS 则要复杂一些，需要用 <strong> 爱思助手 </strong> 或<strong>iMaZing</strong>等 IOS 管理工具传递文件。<br>放入 <strong>文稿 </strong> - <strong>PROJECT_NAME</strong> - <strong>Saved</strong> - <strong>Paks</strong> 下，若不存在 Paks 目录，可手动创建。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/picgo/2022/20221018125828.png"></p>
<h3 id="检查挂载情况"><a href="# 检查挂载情况" class="headerlink" title="检查挂载情况"></a>检查挂载情况 </h3><p> 当将 <strong>pak</strong> 文件放入上述目录之后，就可以启动游戏了。</p>
<p>如果为了确认 <strong>pak</strong> 文件是否生效，可以从 Log 中查看：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">LogPakFile: Display: Found Pak file ../../../PROJECT_NAME/Saved/Paks/2022.10.18-13.02.53_IOS_001_P.pak attempting to mount.</span><br><span class="line">LogPakFile: Display: Mounting pak file ../../../PROJECT_NAME/Saved/Paks/2022.10.18-13.02.53_IOS_001_P.pak.</span><br></pre></td></tr></table></figure>
<p>有这样的 Log，就代表资源包被引擎读取成功，可以直接使用，<strong>就像它被打进了基础包中一样</strong>。</p>
<h3 id="注意事项"><a href="# 注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><blockquote>
<p>手动打包 <strong>Pak</strong> 的优先级高于基础包内的资源，意味着一个资源如果 <strong> 补丁包 </strong> 和<strong>基础包 </strong> 中<strong>同时 </strong> 存在，就会 <strong> 替换 </strong> 基础包内的，就像热更新逻辑。</p>
</blockquote>
<ol>
<li>不同平台的 <strong>pak</strong> 不能混用！</li>
<li>测试完毕之后要把设备上的 pak 文件删除，不然后面新打的包可能会出现资源表现错误。</li>
</ol>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>热更新</category>
        <category>Pak</category>
      </categories>
      <tags>
        <tag>资源管理</tag>
        <tag>热更新</tag>
        <tag>Pak</tag>
      </tags>
  </entry>
  <entry>
    <title>Mount Point 的作用</title>
    <url>/wiki/14307/</url>
    <content><![CDATA[<p>在 Mount Pak 的时候，有一个参数可以指定 MountPoint:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Mounts a pak file at the specified path.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* @param InPakFilename Pak filename.</span></span><br><span class="line"><span class="comment">* @param InPath Path to mount the pak at.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Mount</span><span class="params">(<span class="keyword">const</span> TCHAR* InPakFilename, uint32 PakOrder, <span class="keyword">const</span> TCHAR* InPath = <span class="literal">NULL</span>, <span class="keyword">bool</span> bLoadIndex = <span class="literal">true</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>那么它是干什么的呢？<br>首先从 Mount 函数开始：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (InPath != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  Pak-&gt;<span class="built_in">SetMountPoint</span>(InPath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果在调用 Mount 时传递了 <code>InPath</code>，则通过加载 Pak 的 FPakFile 实例调用<code>SetMountPoint</code>，把 InPath 设置给它。<br> 其实在 FPakFile 中，MountPath 是有默认值的（从 Pak 文件中读取），在 FPakFile 的构造函数中调用了 <code>Initialize(Reader, bLoadIndex);</code>，Initialize 中又调用了<code>LoadIndex</code>，在<code>LoadIndex</code> 中从 Pak 中读取 Pak 的 Mount Point 的逻辑：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime/PakFile/Private/IPlatformFilePak.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FPakFile::LoadIndex</span><span class="params">(FArchive* Reader)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (CachedTotalSize &lt; (Info.IndexOffset + Info.IndexSize))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">UE_LOG</span>(LogPakFile, Fatal, <span class="built_in">TEXT</span>(<span class="string">&quot;Corrupted index offset in pak file.&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (Info.Version &gt;= FPakInfo::PakFile_Version_FrozenIndex &amp;&amp; Info.bIndexIsFrozen)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;PakFile_LoadFrozen&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// read frozen data</span></span><br><span class="line">      Reader-&gt;<span class="built_in">Seek</span>(Info.IndexOffset);</span><br><span class="line">      int32 FrozenSize = Info.IndexSize;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// read in the index, etc data in one lump</span></span><br><span class="line">      <span class="keyword">void</span>* DataMemory = FMemory::<span class="built_in">Malloc</span>(FrozenSize);</span><br><span class="line">      Reader-&gt;<span class="built_in">Serialize</span>(DataMemory, FrozenSize);</span><br><span class="line">      Data = TUniquePtr&lt;FPakFileData&gt;((FPakFileData*)DataMemory);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// cache the number of entries</span></span><br><span class="line">      NumEntries = Data-&gt;Files.<span class="built_in">Num</span>();</span><br><span class="line">      <span class="comment">// @todo loadtime: it is nice to serialize the mountpoint right into the Data so that IndexSize is right here</span></span><br><span class="line">      <span class="comment">// but it takes this to copy it out, because it&#x27;s too painful for the string manipulation when dealing with</span></span><br><span class="line">      <span class="comment">// MemoryImageString everywhere MountPoint is used</span></span><br><span class="line">      MountPoint = Data-&gt;MountPoint;</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单的可以理解为：如果 Mount 时不传递 Mount Point 就会从 Pak 文件中读取，如果有传入就设置为传入的值（Pak 文件中的 MountPoint 是 Pak 中所有文件的公共路径）。</p>
<p>那么，给 Pak 设置 MountPoint 的作用是什么呢？<br>真实目的是，检测要加载的文件是否存在于当前 Pak 中！因为 Pak 的 Mount Point 的默认含义是当前 Pak 中所有文件的公共路径，所以只需要检测要读取的文件是否以这个路径开头，就可以首先排除掉基础路径不对的文件（基础路径都不对，意味着这个文件在 Pak 中也不存在）。</p>
<p>具体逻辑可以看这个函数的实现：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime/PakFile/Public/IPlatformFilePak.h</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Finds a file in the specified pak files.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* @param Paks Pak files to find the file in.</span></span><br><span class="line"><span class="comment">* @param Filename File to find in pak files.</span></span><br><span class="line"><span class="comment">* @param OutPakFile Optional pointer to a pak file where the filename was found.</span></span><br><span class="line"><span class="comment">* @return Pointer to pak entry if the file was found, NULL otherwise.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">FindFileInPakFiles</span><span class="params">(TArray&lt;FPakListEntry&gt;&amp; Paks,<span class="keyword">const</span> TCHAR* Filename,FPakFile** OutPakFile,FPakEntry* OutEntry = <span class="literal">nullptr</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">FString <span class="title">StandardFilename</span><span class="params">(Filename)</span></span>;</span><br><span class="line">    FPaths::<span class="built_in">MakeStandardFilename</span>(StandardFilename);</span><br><span class="line"></span><br><span class="line">    int32 DeletedReadOrder = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (int32 PakIndex = <span class="number">0</span>; PakIndex &lt; Paks.<span class="built_in">Num</span>(); PakIndex++)</span><br><span class="line">    &#123;</span><br><span class="line">        int32 PakReadOrder = Paks[PakIndex].ReadOrder;</span><br><span class="line">        <span class="keyword">if</span> (DeletedReadOrder != <span class="number">-1</span> &amp;&amp; DeletedReadOrder &gt; PakReadOrder)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//found a delete record in a higher priority patch level, but now we&#x27;re at a lower priority set - don&#x27;t search further back or we&#x27;ll find the original, old file.</span></span><br><span class="line">            <span class="built_in">UE_LOG</span>(LogPakFile, Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;Delete Record: Accepted a delete record for %s&quot;</span>), Filename );</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        FPakFile::EFindResult FindResult = Paks[PakIndex].PakFile-&gt;<span class="built_in">Find</span>(*StandardFilename, OutEntry);</span><br><span class="line">        <span class="keyword">if</span> (FindResult == FPakFile::EFindResult::Found)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (OutPakFile != <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                *OutPakFile = Paks[PakIndex].PakFile;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">UE_CLOG</span>(DeletedReadOrder != <span class="number">-1</span>, LogPakFile, Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;Delete Record: Ignored delete record for %s - found it in %s instead (asset was moved between chunks)&quot;</span>), Filename, *Paks[PakIndex].PakFile-&gt;<span class="built_in">GetFilename</span>());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (FindResult == FPakFile::EFindResult::FoundDeleted)</span><br><span class="line">        &#123;</span><br><span class="line">            DeletedReadOrder = PakReadOrder;</span><br><span class="line">            <span class="built_in">UE_LOG</span>(LogPakFile, Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;Delete Record: Found a delete record for %s in %s&quot;</span>), Filename, *Paks[PakIndex].PakFile-&gt;<span class="built_in">GetFilename</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UE_CLOG</span>(DeletedReadOrder != <span class="number">-1</span>, LogPakFile, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Delete Record: No lower priority pak files looking for %s. (maybe not downloaded?)&quot;</span>), Filename );</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当我们从 Pak 中读取文件时，通过对游戏中所有 Mount 的 Pak 调用 <code>Find</code> 函数，而 <code>FPakFile::Find</code> 的函数就实现了上述我说的逻辑：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime/PakFile/Private/IPlatformFilePak.cpp</span></span><br><span class="line"><span class="function">FPakFile::EFindResult <span class="title">FPakFile::Find</span><span class="params">(<span class="keyword">const</span> FString&amp; Filename, FPakEntry* OutEntry)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">QUICK_SCOPE_CYCLE_COUNTER</span>(PakFileFind);</span><br><span class="line">  <span class="keyword">if</span> (Filename.<span class="built_in">StartsWith</span>(MountPoint))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function">FString <span class="title">Path</span><span class="params">(FPaths::GetPath(Filename))</span></span>;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以，MountPoint 的作用就是在从 Pak 中查找文件时，首先判断文件的路径是否与 Pak 中所有文件的 <strong> 基础路径 </strong> 相匹配（StartWith），如果不存在也就不会进入后续的流程了。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>热更新</category>
        <category>Pak</category>
      </categories>
      <tags>
        <tag>热更新</tag>
        <tag>Pak</tag>
      </tags>
  </entry>
  <entry>
    <title>not-uasset 文件过滤规则</title>
    <url>/wiki/61ac95b3/</url>
    <content><![CDATA[<p> 可以控制 not-uasset 文件进 Pak 的规则。<a href="https://github.com/EpicGames/UnrealEngine/blob/d11782b9046e9d0b130309591e4efc57f4b8b037/Engine/Source/Programs/AutomationTool/Scripts/CopyBuildToStagingDirectory.Automation.cs#L1887">AutomationTool/Scripts/CopyBuildToStagingDirectory.Automation.cs#L1887</a></p>
<figure class="highlight csharp"><figcaption><span>Scripts/CopyBuildToStagingDirectory.Automation.cs</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Reads Default/BasePakFileRules.ini and returns all PakFileRules objects that apply for this deployment</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Params&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;SC&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;PakFileRules&gt; <span class="title">GetPakFileRules</span>(<span class="params">ProjectParams Params, DeploymentContext SC</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">bool</span> bWarnedAboutMultipleTargets = <span class="literal">false</span>;</span><br><span class="line">  <span class="built_in">bool</span> bFoundConfig = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  List&lt;ConfigFile&gt; ConfigFiles = <span class="keyword">new</span> List&lt;ConfigFile&gt;();</span><br><span class="line">  FileReference BaseConfigFileReference = FileReference.Combine(SC.EngineRoot, <span class="string">&quot;Config&quot;</span>, <span class="string">&quot;BasePakFileRules.ini&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (FileReference.Exists(BaseConfigFileReference))</span><br><span class="line">  &#123;</span><br><span class="line">    ConfigFiles.Add(<span class="keyword">new</span> ConfigFile(BaseConfigFileReference));</span><br><span class="line">    bFoundConfig = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  FileReference ProjectConfigFileReference = FileReference.Combine(SC.ProjectRoot, <span class="string">&quot;Config&quot;</span>, <span class="string">&quot;DefaultPakFileRules.ini&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (FileReference.Exists(ProjectConfigFileReference))</span><br><span class="line">  &#123;</span><br><span class="line">    ConfigFiles.Add(<span class="keyword">new</span> ConfigFile(ProjectConfigFileReference));</span><br><span class="line">    bFoundConfig = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!bFoundConfig)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span> bChunkedBuild = SC.PlatformUsesChunkManifests &amp;&amp; DoesChunkPakManifestExist(Params, SC);</span><br><span class="line"></span><br><span class="line">  ConfigHierarchy PakRulesConfig = <span class="keyword">new</span> ConfigHierarchy(ConfigFiles);</span><br><span class="line"></span><br><span class="line">  List&lt;PakFileRules&gt; RulesList = <span class="keyword">new</span> List&lt;PakFileRules&gt;();</span><br><span class="line">  <span class="keyword">foreach</span> (<span class="built_in">string</span> SectionName <span class="keyword">in</span> PakRulesConfig.SectionNames)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">//LogInformation(&quot;Building PakFileRules for Section &#123;0&#125;&quot;, SectionName);</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">bool</span> bOnlyChunkedBuilds = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (!PakRulesConfig.TryGetValue(SectionName, <span class="string">&quot;bOnlyChunkedBuilds&quot;</span>, <span class="keyword">out</span> bOnlyChunkedBuilds))</span><br><span class="line">    &#123;</span><br><span class="line">      bOnlyChunkedBuilds = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">bool</span> bOnlyNonChunkedBuilds = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (!PakRulesConfig.TryGetValue(SectionName, <span class="string">&quot;bOnlyNonChunkedBuilds&quot;</span>, <span class="keyword">out</span> bOnlyNonChunkedBuilds))</span><br><span class="line">    &#123;</span><br><span class="line">      bOnlyNonChunkedBuilds = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bChunkedBuild &amp;&amp; bOnlyNonChunkedBuilds)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!bChunkedBuild &amp;&amp; bOnlyChunkedBuilds)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> PlatformString;</span><br><span class="line">    <span class="keyword">if</span> (PakRulesConfig.TryGetValue(SectionName, <span class="string">&quot;Platforms&quot;</span>, <span class="keyword">out</span> PlatformString))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">string</span>[] PlatformStrings = PlatformString.Split(<span class="keyword">new</span> <span class="built_in">char</span>[] &#123; <span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27; &#x27;</span> &#125;, StringSplitOptions.RemoveEmptyEntries);</span><br><span class="line">      <span class="built_in">bool</span> bMatches = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Check platform string</span></span><br><span class="line">      <span class="keyword">foreach</span> (<span class="built_in">string</span> Platform <span class="keyword">in</span> PlatformStrings)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (SC.StageTargetPlatform.PlatformType.ToString().Equals(Platform, StringComparison.OrdinalIgnoreCase))</span><br><span class="line">        &#123;</span><br><span class="line">          bMatches = <span class="literal">true</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (SC.StageTargetPlatform.IniPlatformType.ToString().Equals(Platform, StringComparison.OrdinalIgnoreCase))</span><br><span class="line">        &#123;</span><br><span class="line">          bMatches = <span class="literal">true</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!bMatches)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">//LogInformation(&quot;No matching platform for PakFileRules for Section &#123;0&#125; : &#123;1&#125;, &#123;2&#125;&quot;, SectionName, SC.StageTargetPlatform.PlatformType.ToString(), SC.StageTargetPlatform.IniPlatformType.ToString());</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> TargetString;</span><br><span class="line">    <span class="keyword">if</span> (PakRulesConfig.TryGetValue(SectionName, <span class="string">&quot;Targets&quot;</span>, <span class="keyword">out</span> TargetString))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">string</span>[] TargetStrings = TargetString.Split(<span class="keyword">new</span> <span class="built_in">char</span>[] &#123; <span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27; &#x27;</span> &#125;, StringSplitOptions.RemoveEmptyEntries);</span><br><span class="line">      <span class="built_in">bool</span> bMatches = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Check target string</span></span><br><span class="line">      <span class="keyword">foreach</span> (<span class="built_in">string</span> Target <span class="keyword">in</span> TargetStrings)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (UnrealTargetConfiguration C <span class="keyword">in</span> SC.StageTargetConfigurations)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (C.ToString() == Target)</span><br><span class="line">          &#123;</span><br><span class="line">            bMatches = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!bMatches)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (SC.StageTargetConfigurations.Count &gt; <span class="number">0</span> &amp;&amp; !bWarnedAboutMultipleTargets)</span><br><span class="line">      &#123;</span><br><span class="line">        bWarnedAboutMultipleTargets = <span class="literal">true</span>;</span><br><span class="line">        LogInformation(<span class="string">&quot;Staging with more than one target, PakFileRules may apply too many rules!&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PakFileRules PakRules = <span class="keyword">new</span> PakFileRules();</span><br><span class="line">    PakRules.Name = SectionName;</span><br><span class="line">    PakRulesConfig.TryGetValue(SectionName, <span class="string">&quot;bExcludeFromPaks&quot;</span>, <span class="keyword">out</span> PakRules.bExcludeFromPaks);</span><br><span class="line">    PakRulesConfig.TryGetValue(SectionName, <span class="string">&quot;bOverrideChunkManifest&quot;</span>, <span class="keyword">out</span> PakRules.bOverrideChunkManifest);</span><br><span class="line">    PakRulesConfig.TryGetValue(SectionName, <span class="string">&quot;bDisabled&quot;</span>, <span class="keyword">out</span> PakRules.bDisabled);</span><br><span class="line">    <span class="built_in">string</span> PakString;</span><br><span class="line">    PakRulesConfig.TryGetValue(SectionName, <span class="string">&quot;OverridePaks&quot;</span>, <span class="keyword">out</span> PakString);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (PakString != <span class="literal">null</span> &amp;&amp; PakString.Length &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      PakRules.OverridePaks = PakString.Split(<span class="keyword">new</span> <span class="built_in">char</span>[] &#123; <span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27; &#x27;</span> &#125;, StringSplitOptions.RemoveEmptyEntries).ToList();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      PakRules.OverridePaks = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (PakRules.bExcludeFromPaks &amp;&amp; PakRules.OverridePaks != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      LogWarning(<span class="string">&quot;Error in PakFileRules &#123;0&#125;, set to exclude but also sets override!&quot;</span>, PakRules.Name);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!PakRules.bExcludeFromPaks &amp;&amp; PakRules.OverridePaks == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      LogWarning(<span class="string">&quot;Error in PakFileRules &#123;0&#125;, set to include but did not specify paks!&quot;</span>, PakRules.Name);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IReadOnlyList&lt;<span class="built_in">string</span>&gt; FilesEnumberable;</span><br><span class="line">    <span class="keyword">if</span> (PakRulesConfig.TryGetValues(SectionName, <span class="string">&quot;Files&quot;</span>, <span class="keyword">out</span> FilesEnumberable))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// Only add if we have actual files, we can end up with none due to config overriding</span></span><br><span class="line">      PakRules.Filter = <span class="keyword">new</span> FileFilter();</span><br><span class="line">      <span class="keyword">foreach</span> (<span class="built_in">string</span> FileFilter <span class="keyword">in</span> FilesEnumberable)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">//LogInformation(&quot;Adding to PakFileRules for Section &#123;0&#125; : &#123;1&#125;&quot;, SectionName, FileFilter);</span></span><br><span class="line">        PakRules.Filter.AddRule(FileFilter);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      RulesList.Add(PakRules);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> RulesList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 配置规则，在项目 Config 下创建一个 DefaultPakFileRules.ini：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment">; These rules are applied in order, the first rule that applies per file is taken and no others are evaluated</span></span><br><span class="line"><span class="comment">; [SectionName]</span></span><br><span class="line"><span class="comment">; bOverrideChunkManifest=false 		; If true this allows overriding assignments from the cooker</span></span><br><span class="line"><span class="comment">; bExcludeFromPaks=false 			; If true this removes entirely, cannot coexist with overridepaks</span></span><br><span class="line"><span class="comment">; OverridePaks=&quot;pakchunk1&quot; 			; If set this will override pak list, comma separated</span></span><br><span class="line"><span class="comment">; Platforms=&quot;iOS,Android&quot;			; If set this rule will only apply to these platforms</span></span><br><span class="line"><span class="comment">; Targets=&quot;Shipping,Test&quot;			; If set this rule will only apply to these configurations</span></span><br><span class="line"><span class="comment">; bOnlyChunkedBuilds=true			; If set this rule will only apply to chunked builds</span></span><br><span class="line"><span class="comment">; bOnlyNonChunkedBuilds=true		; If set this rule will only apply to non-chunked builds</span></span><br><span class="line"><span class="comment">; +Files=&quot;.../*FileMask*.*&quot;			; List of file masks to apply to, using the C# FileFilter class</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[ExcludeContentForMobile]</span></span><br><span class="line"><span class="comment">; Exclude specific large textures on mobile platforms, this was moved from CopyBuildToStagingDirectory.cs</span></span><br><span class="line"><span class="comment">; This can be added to in a game&#x27;s DefaultPakFileRules.ini by using the same sections, and new sections can be added</span></span><br><span class="line"><span class="comment">; To remove this rule, use !Files to clear the list of file paths</span></span><br><span class="line"><span class="attr">Platforms</span>=<span class="string">&quot;Android,iOS,tvOS&quot;</span></span><br><span class="line"><span class="attr">bExcludeFromPaks</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">bOverrideChunkManifest</span>=<span class="literal">true</span></span><br><span class="line">+<span class="attr">Files</span>=<span class="string">&quot;.../Engine/Content/EngineMaterials/DefaultBloomKernel.*&quot;</span></span><br></pre></td></tr></table></figure>

<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>热更新</category>
        <category>Pak</category>
      </categories>
      <tags>
        <tag>资源管理</tag>
        <tag>热更新</tag>
        <tag>Pak</tag>
      </tags>
  </entry>
  <entry>
    <title>Patch 的挂载和资源加载</title>
    <url>/wiki/10855/</url>
    <content><![CDATA[<p>这两天在看 UE 打包 Patch 作为热更的方案，UE 打包 Patch 的逻辑是这样的：</p>
<ol>
<li>如果在版本 1.0 中，场景 <code>Scene01</code> 中对资源 A 有直接引用（放在场景中），在修改了 A 资源之后，打包 Patch0.1，想要让场景 <code>Scene01</code> 中资源 A 的改动也生效，则需要把 <code>Scene01</code> 也需要打到 Patch 中，因为是直接放置在场景中的，场景记录了该资源 A 的引用信息，这个不会随着资源 A 的更新而更新，加载时会产生 <code>AsyncLoading.cpp</code> 中的报错。</li>
</ol>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Patch/unreal-load-patch-asset.webp"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[2019.11.13-06.03.27:766][68]LogLinker: Warning: The file &#x27;../../../GWorld/Content/PAK/Cube.uasset&#x27; contains unrecognizable data, check that it is of the expected type.</span><br><span class="line">[2019.11.13-06.03.27:770][68]LogStreaming: Error: ****DumpDependencies [Dependencies]:</span><br><span class="line">[2019.11.13-06.03.27:771][68]LogStreaming: Error:     Export 8 /Game/Map2.Map2:PersistentLevel.Cube_2</span><br><span class="line">[2019.11.13-06.03.27:772][68]LogStreaming: Error:     Linker is ../../../GWorld/Content/Map2.umap</span><br><span class="line">[2019.11.13-06.03.27:774][68]LogStreaming: Error:         Dep C_BEFORE_S Export    38    /Game/Map2.Map2:PersistentLevel.Cube_2.Cube     (class StaticMeshComponent)</span><br><span class="line">[2019.11.13-06.03.27:774][68]LogStreaming: Error:         Dep C_BEFORE_S Export    29    /Game/Map2.Map2:PersistentLevel.Cube_2.DefaultSceneRoot     (class SceneComponent)</span><br><span class="line">[2019.11.13-06.03.27:775][68]LogStreaming: Error:         Dep S_BEFORE_C Import     3   /Game/PAK/Cube.Cube_C</span><br><span class="line">[2019.11.13-06.03.27:776][68]LogStreaming: Error:         Dep S_BEFORE_C Import    42   /Game/PAK/Cube.Default__Cube_C</span><br><span class="line">[2019.11.13-06.03.27:776][68]LogStreaming: Error:         Dep C_BEFORE_C Export    23    /Game/Map2.Map2:PersistentLevel     (class Level)</span><br><span class="line">[2019.11.13-06.03.27:777][68]LogStreaming: Error: Missing Dependency, request for /Game/PAK/Cube.Cube_C but it hasn&#x27;t been created yet.</span><br><span class="line">[2019.11.13-06.03.27:778][68]LogStreaming: Error: Could not find class Cube_C to create Cube_2</span><br><span class="line">[2019.11.13-06.03.27:778][68]LogStreaming: Error: Could not find outer Cube_2 to create DefaultSceneRoot</span><br><span class="line">[2019.11.13-06.03.27:779][68]LogStreaming: Error: Could not find outer Cube_2 to create Cube</span><br></pre></td></tr></table></figure>

<p>解决这个问题的办法是通过 <code>SoftClassReference</code> 动态加载资源，比如直接 <code>SpawnActorFromClass</code> 直接指定 Class 为具体的类也是会产生上面的错误，但是用 <code>SoftClassReference</code> 可以避免这个错误（因为 <code>SoftClassReference</code> 本质就是存了个路径）：<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Patch/ue4-dynamic-load-asset.webp"></p>
<ol start="2">
<li>如果在版本 1.0 中，资源 A 引用了其他资源 B，在 Patch1.0 中将资源 A 中引用的 B 换为了资源 C，则该 Patch 的 pak 中会有资源 A/B/C 三个，因为资源的引用关系变了，但是如果不改动引用关系只是改动 B 中的信息，然后只 Patch 资源 B 是可以的。</li>
</ol>
<p>直接使用 <code>Unreal.pak</code> 将<code>Cooked</code>的资源打包为 <code>pak</code> 文件需要注意一点：修改 Mount 的路径。<br>如果说直接使用下列命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ UnrealPak.exe New_0_P.pak -create=D:\GWorldClient\Saved\Cooked\WindowsNoEditor\GWorld\Content\PAK</span><br></pre></td></tr></table></figure>
<p>则打出来的 pak 的 Mount 路径为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\GWorldClient\Saved\Cooked\WindowsNoEditor\GWorld\Content\PAK</span><br></pre></td></tr></table></figure>
<p>而查看使用引擎打包的 Pak 和 patch 的 pak 都是相对路径的，这个性格对路径就是 UE 的工程里资源的路径：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">D:\GWorldPackage\WindowsNoEditor\GWorld\Content\Paks&gt;UnrealPak.exe GWorld-WindowsNoEditor.pak -list</span><br><span class="line">LogPaths: Warning: No paths <span class="keyword">for</span> game localization data were specifed in the game configuration.</span><br><span class="line">LogPakFile: Display: Using command line <span class="keyword">for</span> crypto configuration</span><br><span class="line">LogPakFile: Display: Added <span class="number">0</span> entries to add to pak file.</span><br><span class="line">LogPakFile: Display: Mount point ../../../</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;Engine/Content/BasicShapes/BasicShapeMaterial.uasset&quot;</span> offset: <span class="number">0</span>, size: <span class="number">749</span> bytes, sha1: E028879C8856192DC648EA4C422C145E38951DA9, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;Engine/Content/EditorMaterials/PreviewShadowIndicator.uasset&quot;</span> offset: <span class="number">819</span>, size: <span class="number">496</span> bytes, sha1: <span class="number">80B</span>CDD2FF2674FED35763CD6A8C93C5A0EC27442, compression: Zlib.</span><br><span class="line"><span class="comment">// ....</span></span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/AssetRegistry.bin&quot;</span> offset: <span class="number">16928768</span>, size: <span class="number">2759</span> bytes, sha1: <span class="number">35E6</span>A5C7667C23FDDFD1F3BDC5535FA4E3BFF24F, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Config/DefaultEngine.ini&quot;</span> offset: <span class="number">16932864</span>, size: <span class="number">2378</span> bytes, sha1: <span class="number">7E33</span>CA6CC805CC1A6E2FF84EF3010CEACBF99E04, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Config/DefaultGame.ini&quot;</span> offset: <span class="number">16935312</span>, size: <span class="number">523</span> bytes, sha1: DDD788C5E2C9446AB11E2C8BC7D83EA24CB85AA9, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Config/DefaultInput.ini&quot;</span> offset: <span class="number">16935905</span>, size: <span class="number">753</span> bytes, sha1: <span class="number">6</span>C03DCDAE9605BEB9CB2EB250631D6AA2C2A4336, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Content/Map2.uexp&quot;</span> offset: <span class="number">16936960</span>, size: <span class="number">339962</span> bytes, sha1: <span class="number">6605</span>D83E8355CC2B4D20DE31C3D6182324BA556C, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Content/Map2.umap&quot;</span> offset: <span class="number">17278976</span>, size: <span class="number">5541</span> bytes, sha1: A400A39FD85529E832750CB481D9F845E4C4A74B, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Content/Map2_BuiltData.uasset&quot;</span> offset: <span class="number">17285120</span>, size: <span class="number">795</span> bytes, sha1: <span class="number">1388</span>AE2CCFA55587DD0A3120CA9679AAF8FC9336, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Content/Map2_BuiltData.ubulk&quot;</span> offset: <span class="number">17287168</span>, size: <span class="number">8637</span> bytes, sha1: <span class="number">7</span>D8E7AE0D100415553DF6F222B9C35EBACF4BE28, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Content/Map2_BuiltData.uexp&quot;</span> offset: <span class="number">17297408</span>, size: <span class="number">586603</span> bytes, sha1: <span class="number">3B</span>776E46005F6A4BEECA505674ED7FB0B8C432D6, compression: Zlib.</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Content/ShaderArchive-GWorld-PCD3D_SM5.ushaderbytecode&quot;</span> offset: <span class="number">23377920</span>, size: <span class="number">1207165</span> bytes, sha1: <span class="number">44474138</span>CD033FEF89EDFA86A480E569615A8850, compression: None.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/GWorld.uproject&quot;</span> offset: <span class="number">24585135</span>, size: <span class="number">323</span> bytes, sha1: D2E183A541A10DEEC5C87533400FFC0E89CA3B83, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Plugins/GWorld.upluginmanifest&quot;</span> offset: <span class="number">24586240</span>, size: <span class="number">5022</span> bytes, sha1: CFDB721323DABBA1C7C7ABE6CB967852EA2AC23B, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Plugins/LowEntryExtStdLib/LowEntryExtStdLib.uplugin&quot;</span> offset: <span class="number">24591332</span>, size: <span class="number">434</span> bytes, sha1: <span class="number">5</span>CD75BB5212731BEA8E0A552C99B69B259FA489C, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Plugins/UIFramework/UIFramework.uplugin&quot;</span> offset: <span class="number">24591836</span>, size: <span class="number">236</span> bytes, sha1: C9426AD575AA6ADECEF5C1AE79CF4A49304C3350, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Plugins/VaRestPlugin/VaRestPlugin.uplugin&quot;</span> offset: <span class="number">24592384</span>, size: <span class="number">393</span> bytes, sha1: <span class="number">28B</span>9C2F3CEB767F4A8D5D466CB8C6EEF772CDA43, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="number">1257</span> <span class="built_in">files</span> (<span class="number">24050765</span> bytes), (<span class="number">0</span> filtered bytes).</span><br><span class="line">LogPakFile: Display: Unreal pak executed in <span class="number">1.746391</span> seconds</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>解决方案 </strong> 是可以通过 <code>UnrealPak.exe</code> 的<code>-create</code>来指定一个 txt 文件来指定某个资源的绝对路径换算为相对路径：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;D:\GWorldClient\Saved\Cooked\WindowsNoEditor\GWorld\Content\PAK\BasicShapeMaterial_3.uasset&quot; &quot;../../../GWorld/Content/PAK/BasicShapeMaterial_3.uasset&quot; -compress</span><br><span class="line">&quot;D:\GWorldClient\Saved\Cooked\WindowsNoEditor\GWorld\Content\PAK\BasicShapeMaterial_3.uexp&quot; &quot;../../../GWorld/Content/PAK/BasicShapeMaterial_3.uexp&quot; -compress</span><br></pre></td></tr></table></figure>

<p>可以看作有数列的表，第一列是资源的 <strong> 绝对路径 </strong>，第二列是<strong> 该绝对路径资源对应的相对路径 </strong>，后面是<strong> 参数 </strong>（可以是<code>-compress</code>/<code>-encrypt</code>），生成的代码在<code>Source/Programs/AutomationTool/Script/CopyBuildToStagingDirectory.Automation.cs</code> 中。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">D:\&gt;UnrealPak.exe D:\NEW_6_P.pak -create=<span class="string">&quot;D:\GWorldClient\Saved\Cooked\WindowsNoEditor\GWorld\Content\New.txt&quot;</span></span><br><span class="line">LogPaths: Warning: No paths <span class="keyword">for</span> game localization data were specifed <span class="keyword">in</span> the game configuration.</span><br><span class="line">LogPakFile: Display: Using <span class="built_in">command</span> line <span class="keyword">for</span> crypto configuration</span><br><span class="line">LogPakFile: Display: Loading response file D:\GWorldClient\Saved\Cooked\WindowsNoEditor\GWorld\Content\New.txt</span><br><span class="line">LogPakFile: Display: Added 2 entries to add to pak file.</span><br><span class="line">LogPakFile: Display: Collecting files to add to pak file...</span><br><span class="line">LogPakFile: Display: Collected 2 files <span class="keyword">in</span> 0.00s.</span><br><span class="line">LogPakFile: Display: Encrypting using embedded key</span><br><span class="line">LogPakFile: Display: Added 2 files, 8549 bytes total, time 0.00s.</span><br><span class="line">LogPakFile: Display: Compression summary: 13.27% of original size. Compressed Size 7981 bytes, Original Size 60159 bytes.</span><br><span class="line">LogPakFile: Display: Encryption - DISABLED</span><br><span class="line">LogPakFile: Display: Unreal pak executed <span class="keyword">in</span> 0.010672 seconds</span><br></pre></td></tr></table></figure>

<p>检查打包出来的<code>New_6_P.pak</code>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">D:\&gt;UnrealPak.exe NEW_6_P.pak -list</span><br><span class="line">LogPaths: Warning: No paths <span class="keyword">for</span> game localization data were specifed <span class="keyword">in</span> the game configuration.</span><br><span class="line">LogPakFile: Display: Using <span class="built_in">command</span> line <span class="keyword">for</span> crypto configuration</span><br><span class="line">LogPakFile: Display: Added 0 entries to add to pak file.</span><br><span class="line">LogPakFile: Display: Mount point ../../../GWorld/Content/PAK/</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;BasicShapeMaterial_3.uasset&quot;</span> offset: 0, size: 753 bytes, sha1: 63E00757694E91070403390CFB808829E13D01FF, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;BasicShapeMaterial_3.uexp&quot;</span> offset: 823, size: 7228 bytes, sha1: BD3C0B302FC49790327CF804F2B644F01A14EFCD, compression: Zlib.</span><br><span class="line">LogPakFile: Display: 2 files (7981 bytes), (0 filtered bytes).</span><br><span class="line">LogPakFile: Display: Unreal pak executed <span class="keyword">in</span> 0.001987 seconds</span><br></pre></td></tr></table></figure>

<p>可以看到变成了相对路径了。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>热更新</category>
        <category>Pak</category>
      </categories>
      <tags>
        <tag>热更新</tag>
        <tag>Pak</tag>
      </tags>
  </entry>
  <entry>
    <title>引擎启动时 Pak 的加载</title>
    <url>/wiki/11831/</url>
    <content><![CDATA[<p>当在 UE 的 <code>Project Setting</code> 里<code>Project</code>-<code>Packaging</code>-<code>UsePakFile</code>启用时，会打包出来 <code>pak</code> 文件，以 <code>Windows</code> 平台为例，打包出来的 <code>pak</code> 路径为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">WindowsNoEditor/PROJECT_NAME/Content/Paks</span><br></pre></td></tr></table></figure>
<p>该目录下的 <code>pak</code> 文件在游戏启动时会自动加载，在引擎的 <code>FEngineLoop::PreInit</code> 中调用 <code>LaunchCheckForFileOverride</code>(<code>LaunchEngineLoop.cpp</code>) 又调用 <code>ConditionallyCreateFileWrapper</code> 来加载 <code>PakFile</code> 的<code>PlatformFile</code>，但是在 <code>ConditionallyCreateFileWrapper</code> 的代码中做了一层 <code>WrapperFile-&gt;ShouldBeUsed</code> 判断：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime/Launch/Private/LaunchEngineLoop.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> IPlatformFile* <span class="title">ConditionallyCreateFileWrapper</span><span class="params">(<span class="keyword">const</span> TCHAR* Name, IPlatformFile* CurrentPlatformFile, <span class="keyword">const</span> TCHAR* CommandLine, <span class="keyword">bool</span>* OutFailedToInitialize = <span class="literal">nullptr</span>, <span class="keyword">bool</span>* bOutShouldBeUsed = <span class="literal">nullptr</span> )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (OutFailedToInitialize)</span><br><span class="line">	&#123;</span><br><span class="line">		*OutFailedToInitialize = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (bOutShouldBeUsed)</span><br><span class="line">	&#123;</span><br><span class="line">		*bOutShouldBeUsed = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	IPlatformFile* WrapperFile = FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">GetPlatformFile</span>(Name);</span><br><span class="line">	<span class="keyword">if</span> (WrapperFile != <span class="literal">nullptr</span> &amp;&amp; WrapperFile-&gt;<span class="built_in">ShouldBeUsed</span>(CurrentPlatformFile, CommandLine))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (bOutShouldBeUsed)</span><br><span class="line">		&#123;</span><br><span class="line">			*bOutShouldBeUsed = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (WrapperFile-&gt;<span class="built_in">Initialize</span>(CurrentPlatformFile, CommandLine) == <span class="literal">false</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (OutFailedToInitialize)</span><br><span class="line">			&#123;</span><br><span class="line">				*OutFailedToInitialize = <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// Don&#x27;t delete the platform file. It will be automatically deleted by its module.</span></span><br><span class="line">			WrapperFile = <span class="literal">nullptr</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Make sure it won&#x27;t be used.</span></span><br><span class="line">		WrapperFile = <span class="literal">nullptr</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> WrapperFile;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果为 <code>false</code> 不会对该 <code>PlatformFile</code> 调用 <code>Initialize</code>，而<code>FPakPlatformFile</code> 的一些成员就是在这里被设置的。<code>FPakPlatformFile::ShoubleBeUsed</code>的定义如下(UE_4.22.3)：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime/PakFile/Private/IPlatformFilePak.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FPakPlatformFile::ShouldBeUsed</span><span class="params">(IPlatformFile* Inner, <span class="keyword">const</span> TCHAR* CmdLine)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">bool</span> Result = <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !WITH_EDITOR</span></span><br><span class="line">	<span class="keyword">if</span> (!FParse::<span class="built_in">Param</span>(CmdLine, <span class="built_in">TEXT</span>(<span class="string">&quot;NoPak&quot;</span>)))</span><br><span class="line">	&#123;</span><br><span class="line">		TArray&lt;FString&gt; PakFolders;</span><br><span class="line">		<span class="built_in">GetPakFolders</span>(CmdLine, PakFolders);</span><br><span class="line">		Result = <span class="built_in">CheckIfPakFilesExist</span>(Inner, PakFolders);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span> Result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编辑器模式下直接就是 false，即编辑器模式下不可以使用 pak 的 <code>mount</code> 操作，因为 <code>mount</code> 中需要用到 <code>LowerLevel</code> 成员，而该成员在 <code>FPakPlatformFile::Initialize</code> 中被设置，所以不可以调用 mount，否则必 Crash。</p>
<p>Mount 所有 pak 的相关代码在：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime\PakFile\Private\IPlatformFilePak.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FPakPlatformFile::Initialize</span><span class="params">(IPlatformFile* Inner, <span class="keyword">const</span> TCHAR* CmdLine)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">LLM_SCOPE</span>(ELLMTag::FileSystem);</span><br><span class="line">  <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;FPakPlatformFile::Initialize&quot;</span>);</span><br><span class="line">  <span class="comment">// Inner is required.</span></span><br><span class="line">  <span class="built_in">check</span>(Inner != <span class="literal">NULL</span>);</span><br><span class="line">  LowerLevel = Inner;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> EXCLUDE_NONPAK_UE_EXTENSIONS</span></span><br><span class="line">  <span class="comment">// Extensions for file types that should only ever be in a pak file. Used to stop unnecessary access to the lower level platform file</span></span><br><span class="line">  ExcludedNonPakExtensions.<span class="built_in">Add</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;uasset&quot;</span>));</span><br><span class="line">  ExcludedNonPakExtensions.<span class="built_in">Add</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;umap&quot;</span>));</span><br><span class="line">  ExcludedNonPakExtensions.<span class="built_in">Add</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ubulk&quot;</span>));</span><br><span class="line">  ExcludedNonPakExtensions.<span class="built_in">Add</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;uexp&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DISABLE_NONUFS_INI_WHEN_COOKED</span></span><br><span class="line">  IniFileExtension = <span class="built_in">TEXT</span>(<span class="string">&quot;.ini&quot;</span>);</span><br><span class="line">  GameUserSettingsIniFilename = <span class="built_in">TEXT</span>(<span class="string">&quot;GameUserSettings.ini&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// signed if we have keys, and are not running with fileopenlog (currently results in a deadlock).</span></span><br><span class="line">  bSigned = <span class="built_in">GetPakSigningKey</span>().<span class="built_in">IsValid</span>() &amp;&amp; !FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;fileopenlog&quot;</span>));;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Find and mount pak files from the specified directories.</span></span><br><span class="line">  TArray&lt;FString&gt; PakFolders;</span><br><span class="line">  <span class="built_in">GetPakFolders</span>(FCommandLine::<span class="built_in">Get</span>(), PakFolders);</span><br><span class="line">  <span class="built_in">MountAllPakFiles</span>(PakFolders);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !UE_BUILD_SHIPPING</span></span><br><span class="line">  GPakExec = MakeUnique&lt;FPakExec&gt;(*<span class="keyword">this</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// !UE_BUILD_SHIPPING</span></span></span><br><span class="line"></span><br><span class="line">  FCoreDelegates::OnMountAllPakFiles.<span class="built_in">BindRaw</span>(<span class="keyword">this</span>, &amp;FPakPlatformFile::MountAllPakFiles);</span><br><span class="line">  FCoreDelegates::OnMountPak.<span class="built_in">BindRaw</span>(<span class="keyword">this</span>, &amp;FPakPlatformFile::HandleMountPakDelegate);</span><br><span class="line">  FCoreDelegates::OnUnmountPak.<span class="built_in">BindRaw</span>(<span class="keyword">this</span>, &amp;FPakPlatformFile::HandleUnmountPakDelegate);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !(IS_PROGRAM || WITH_EDITOR)</span></span><br><span class="line">  FCoreDelegates::OnFEngineLoopInitComplete.<span class="built_in">AddLambda</span>([<span class="keyword">this</span>] &#123;</span><br><span class="line">      FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Checking Pak Config&quot;</span>));</span><br><span class="line">      <span class="keyword">bool</span> bUnloadPakEntryFilenamesIfPossible = <span class="literal">false</span>;</span><br><span class="line">      GConfig-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Pak&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;UnloadPakEntryFilenamesIfPossible&quot;</span>), bUnloadPakEntryFilenamesIfPossible, GEngineIni);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (bUnloadPakEntryFilenamesIfPossible)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// With [Pak] UnloadPakEntryFilenamesIfPossible enabled, [Pak] DirectoryRootsToKeepInMemoryWhenUnloadingPakEntryFilenames</span></span><br><span class="line">        <span class="comment">// can contain pak entry directory wildcards of which the entire recursive directory structure of filenames underneath a</span></span><br><span class="line">        <span class="comment">// matching wildcard will be kept.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Example:</span></span><br><span class="line">        <span class="comment">//   [Pak]</span></span><br><span class="line">        <span class="comment">//   DirectoryRootsToKeepInMemoryWhenUnloadingPakEntryFilenames=&quot;*/Config/Tags/&quot;</span></span><br><span class="line">        <span class="comment">//   +DirectoryRootsToKeepInMemoryWhenUnloadingPakEntryFilenames=&quot;*/Content/Localization/*&quot;</span></span><br><span class="line">        TArray&lt;FString&gt; DirectoryRootsToKeep;</span><br><span class="line">        GConfig-&gt;<span class="built_in">GetArray</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Pak&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;DirectoryRootsToKeepInMemoryWhenUnloadingPakEntryFilenames&quot;</span>), DirectoryRootsToKeep, GEngineIni);</span><br><span class="line"></span><br><span class="line">        FPakPlatformFile* PakPlatformFile = (FPakPlatformFile*)(FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">FindPlatformFile</span>(FPakPlatformFile::<span class="built_in">GetTypeName</span>()));</span><br><span class="line">        PakPlatformFile-&gt;<span class="built_in">UnloadPakEntryFilenames</span>(&amp;DirectoryRootsToKeep);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">bool</span> bShrinkPakEntriesMemoryUsage = <span class="literal">false</span>;</span><br><span class="line">      GConfig-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Pak&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;ShrinkPakEntriesMemoryUsage&quot;</span>), bShrinkPakEntriesMemoryUsage, GEngineIni);</span><br><span class="line">      <span class="keyword">if</span> (bShrinkPakEntriesMemoryUsage)</span><br><span class="line">      &#123;</span><br><span class="line">        FPakPlatformFile* PakPlatformFile = (FPakPlatformFile*)(FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">FindPlatformFile</span>(FPakPlatformFile::<span class="built_in">GetTypeName</span>()));</span><br><span class="line">        PakPlatformFile-&gt;<span class="built_in">ShrinkPakEntriesMemoryUsage</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> !!LowerLevel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UE 自动加载的 pak 路径：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime\PakFile\Private\IPlatformFilePak.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FPakPlatformFile::GetPakFolders</span><span class="params">(<span class="keyword">const</span> TCHAR* CmdLine, TArray&lt;FString&gt;&amp; OutPakFolders)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !UE_BUILD_SHIPPING</span></span><br><span class="line">  <span class="comment">// Command line folders</span></span><br><span class="line">  FString PakDirs;</span><br><span class="line">  <span class="keyword">if</span> (FParse::<span class="built_in">Value</span>(CmdLine, <span class="built_in">TEXT</span>(<span class="string">&quot;-pakdir=&quot;</span>), PakDirs))</span><br><span class="line">  &#123;</span><br><span class="line">    TArray&lt;FString&gt; CmdLineFolders;</span><br><span class="line">    PakDirs.<span class="built_in">ParseIntoArray</span>(CmdLineFolders, <span class="built_in">TEXT</span>(<span class="string">&quot;*&quot;</span>), <span class="literal">true</span>);</span><br><span class="line">    OutPakFolders.<span class="built_in">Append</span>(CmdLineFolders);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// @todo plugin urgent: Needs to handle plugin Pak directories, too</span></span><br><span class="line">  <span class="comment">// Hardcoded locations</span></span><br><span class="line">  OutPakFolders.<span class="built_in">Add</span>(FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%sPaks/&quot;</span>), *FPaths::<span class="built_in">ProjectContentDir</span>()));</span><br><span class="line">  OutPakFolders.<span class="built_in">Add</span>(FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%sPaks/&quot;</span>), *FPaths::<span class="built_in">ProjectSavedDir</span>()));</span><br><span class="line">  OutPakFolders.<span class="built_in">Add</span>(FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%sPaks/&quot;</span>), *FPaths::<span class="built_in">EngineContentDir</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在非 <code>Shipping</code> 打包的时候可以通过才命令行加启动参数 <code>-pakdir</code> 来添加额外的 pak 路径。</p>
<p>引擎默认添加的路径为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># relative to Project Path</span><br><span class="line">Content/Paks/</span><br><span class="line">Saved/Paks/</span><br><span class="line"># relative to Engine Path</span><br><span class="line">Content/Paks</span><br></pre></td></tr></table></figure>
<p>之后又调用了 <code>FPakPlatformFile::MountAllPakFiles</code> 来把挂载所有 pak（默认对 pak 的名字进行了个降序排序，但是这里的排序没用），在该函数中 <code>mount</code> 的时候会给不同的路径加载的 <code>pak</code> 设置不同的<code>Order</code>，其函数在：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime\PakFile\Private\IPlatformFilePak.cpp</span></span><br><span class="line"><span class="function">int32 <span class="title">FPakPlatformFile::GetPakOrderFromPakFilePath</span><span class="params">(<span class="keyword">const</span> FString&amp; PakFilePath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (PakFilePath.<span class="built_in">StartsWith</span>(FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%sPaks/%s-&quot;</span>), *FPaths::<span class="built_in">ProjectContentDir</span>(), FApp::<span class="built_in">GetProjectName</span>())))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (PakFilePath.<span class="built_in">StartsWith</span>(FPaths::<span class="built_in">ProjectContentDir</span>()))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (PakFilePath.<span class="built_in">StartsWith</span>(FPaths::<span class="built_in">EngineContentDir</span>()))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (PakFilePath.<span class="built_in">StartsWith</span>(FPaths::<span class="built_in">ProjectSavedDir</span>()))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>概括来说：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># relative to project path</span><br><span class="line">4 Content/Paks/PROJECT_NAME-*.pak</span><br><span class="line">3 Content/Paks/</span><br><span class="line">1 Saved/Paks</span><br><span class="line"></span><br><span class="line"># relative to engine path</span><br><span class="line">2 Content/Paks/</span><br></pre></td></tr></table></figure>
<p>可以看到 <code>Saved/Paks</code> 下的 <code>pak</code> 文件加载的优先级是最低的。</p>
<p>在 <code>Mount</code> 的时候如果上述路径中有打出来 Patch 包，以 <code>_Num_P.pak</code> 结尾的文件，其中 <code>Num</code> 是数字，Patch 包的优先级高于普通的 pak，在 <code>IPlatformFilePak.cpp</code> 中默认给 <code>_P.pak</code> 的<code>PakOrder</code>加了 100，<code>_P.pak</code>前面的数字越大，其加载的优先级就越高。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runtime\PakFile\Private\IPlatformFilePak.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FPakPlatformFile::Mount</span><span class="params">(<span class="keyword">const</span> TCHAR* InPakFilename, uint32 PakOrder, <span class="keyword">const</span> TCHAR* InPath <span class="comment">/*= NULL*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">bool</span> bSuccess = <span class="literal">false</span>;</span><br><span class="line">  TSharedPtr&lt;IFileHandle&gt; PakHandle = <span class="built_in">MakeShareable</span>(LowerLevel-&gt;<span class="built_in">OpenRead</span>(InPakFilename));</span><br><span class="line">  <span class="keyword">if</span> (PakHandle.<span class="built_in">IsValid</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    FPakFile* Pak = <span class="keyword">new</span> <span class="built_in">FPakFile</span>(LowerLevel, InPakFilename, bSigned);</span><br><span class="line">    <span class="keyword">if</span> (Pak-&gt;<span class="built_in">IsValid</span>())</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (InPath != <span class="literal">NULL</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        Pak-&gt;<span class="built_in">SetMountPoint</span>(InPath);</span><br><span class="line">      &#125;</span><br><span class="line">      FString PakFilename = InPakFilename;</span><br><span class="line">      <span class="keyword">if</span> (PakFilename.<span class="built_in">EndsWith</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;_P.pak&quot;</span>)))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// Prioritize based on the chunk version number</span></span><br><span class="line">        <span class="comment">// Default to version 1 for single patch system</span></span><br><span class="line">        uint32 ChunkVersionNumber = <span class="number">1</span>;</span><br><span class="line">        FString StrippedPakFilename = PakFilename.<span class="built_in">LeftChop</span>(<span class="number">6</span>);</span><br><span class="line">        int32 VersionEndIndex = PakFilename.<span class="built_in">Find</span>(<span class="string">&quot;_&quot;</span>, ESearchCase::CaseSensitive, ESearchDir::FromEnd);</span><br><span class="line">        <span class="keyword">if</span> (VersionEndIndex != INDEX_NONE &amp;&amp; VersionEndIndex &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          int32 VersionStartIndex = PakFilename.<span class="built_in">Find</span>(<span class="string">&quot;_&quot;</span>, ESearchCase::CaseSensitive, ESearchDir::FromEnd, VersionEndIndex - <span class="number">1</span>);</span><br><span class="line">          <span class="keyword">if</span> (VersionStartIndex != INDEX_NONE)</span><br><span class="line">          &#123;</span><br><span class="line">            VersionStartIndex++;</span><br><span class="line">            FString VersionString = PakFilename.<span class="built_in">Mid</span>(VersionStartIndex, VersionEndIndex - VersionStartIndex);</span><br><span class="line">            <span class="keyword">if</span> (VersionString.<span class="built_in">IsNumeric</span>())</span><br><span class="line">            &#123;</span><br><span class="line">              int32 ChunkVersionSigned = FCString::<span class="built_in">Atoi</span>(*VersionString);</span><br><span class="line">              <span class="keyword">if</span> (ChunkVersionSigned &gt;= <span class="number">1</span>)</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="comment">// Increment by one so that the first patch file still gets more priority than the base pak file</span></span><br><span class="line">                ChunkVersionNumber = (uint32)ChunkVersionSigned + <span class="number">1</span>;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        PakOrder += <span class="number">100</span> * ChunkVersionNumber;</span><br><span class="line">      &#125;</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// Add new pak file</span></span><br><span class="line">        <span class="function">FScopeLock <span class="title">ScopedLock</span><span class="params">(&amp;PakListCritical)</span></span>;</span><br><span class="line">        FPakListEntry Entry;</span><br><span class="line">        Entry.ReadOrder = PakOrder;</span><br><span class="line">        Entry.PakFile = Pak;</span><br><span class="line">        PakFiles.<span class="built_in">Add</span>(Entry);</span><br><span class="line">        PakFiles.<span class="built_in">StableSort</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      bSuccess = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (Pak-&gt;<span class="built_in">GetInfo</span>().EncryptionKeyGuid.<span class="built_in">IsValid</span>())</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogPakFile, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;Deferring mount of pak \&quot;%s\&quot; until encryption key &#x27;%s&#x27; becomes available&quot;</span>), InPakFilename, *Pak-&gt;<span class="built_in">GetInfo</span>().EncryptionKeyGuid.<span class="built_in">ToString</span>());</span><br><span class="line"></span><br><span class="line">        <span class="built_in">check</span>(!<span class="built_in">GetRegisteredEncryptionKeys</span>().<span class="built_in">HasKey</span>(Pak-&gt;<span class="built_in">GetInfo</span>().EncryptionKeyGuid));</span><br><span class="line">        FPakListDeferredEntry&amp; Entry = PendingEncryptedPakFiles[PendingEncryptedPakFiles.<span class="built_in">Add</span>(<span class="built_in">FPakListDeferredEntry</span>())];</span><br><span class="line">        Entry.Filename = InPakFilename;</span><br><span class="line">        Entry.Path = InPath;</span><br><span class="line">        Entry.ReadOrder = PakOrder;</span><br><span class="line">        Entry.EncryptionKeyGuid = Pak-&gt;<span class="built_in">GetInfo</span>().EncryptionKeyGuid;</span><br><span class="line">        Entry.ChunkID = Pak-&gt;ChunkID;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">delete</span> Pak;</span><br><span class="line">        PakHandle.<span class="built_in">Reset</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogPakFile, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Failed to mount pak \&quot;%s\&quot;, pak is invalid.&quot;</span>), InPakFilename);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">UE_LOG</span>(LogPakFile, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Pak \&quot;%s\&quot; does not exist!&quot;</span>), InPakFilename);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> bSuccess;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外，腾讯的和平精英的热更新的 pak 就是放在 <code>Saved/Paks</code> 里面。<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-game-shadowtrackerextra-pak.webp"></p>
<p>而且，和平精英的 apk 的大小是 1.6G，我下载完之后又热更新了 1.2G 左右的内容，总共占了 3 个多 G…这样的 apk 里面 obb 的数据估计和外部的 <code>pak</code> 中的内容都是覆盖的，但是 apk 内容又没办法改，只能越更新越多了（但是可以在用户更新 APK 之后删除多余的 pak）。</p>
<p>注：腾讯的吃鸡用 sluaunreal，脚本的热更也是通过 pak 方式来加载的，这点在 sluaunreal 中有写：<a href="https://github.com/Tencent/sluaunreal/issues/238">sluaunreal 增量打包问题</a></p>
<p>如果从省空间的角度考虑，最好的方式就是基础 apk+ 更新的方式修改游戏内容，但是玩家下载完 apk 之后还需要再更新可能会造成用户流失，这是个要考虑的问题。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>热更新</category>
        <category>Pak</category>
      </categories>
      <tags>
        <tag>热更新</tag>
        <tag>Pak</tag>
      </tags>
  </entry>
  <entry>
    <title>运行时在 Pak 中访问非资源文件</title>
    <url>/wiki/10456/</url>
    <content><![CDATA[<p>可以把一些非 UE 资源文件（比如 txt，视频）等文件打包到 Pak 中，在游戏运行中访问，可以使用我上面写的 HotPatcher 工具来打包，这里写一下在运行时访问的方法。</p>
<p>首先将文件打包到 Pak：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Paks/package-outside-file-to-pak.webp"></p>
<p>这里我是将文件 <code>AAAAA.json</code> 打包到了 Pak 中，其挂载路径为<code>../../../PROJECT_NAME/AAAAA.json</code>.</p>
<p>在游戏中访问一定要使用挂载路径，可以使用 <code>FPaths::ProjectDir</code> 在打包后获取到的是相对路径，在 PIE 下是项目的相对路径。</p>
<p>使用方法：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Paks/load-extern-file-form-pak-in-runtime.webp"></p>
<p>其中的 <code>PeojectDir</code> 是<code>FPaths::ProjectDir</code>，<code>LoadFileToString</code>则是 <code>IFileManager::LoadFileToString</code> 的封装。</p>
<p>运行结果：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Paks/visitor-pak-not-asset-file-in-package-game.webp"></p>
<p>如果想要访问打包出的项目文件和挂载的 Pak 中的文件，可以使用下面的代码：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UPakVisitorHelper::VisitorProjectDir</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	IPlatformFile&amp; PlatformFile = FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">GetPlatformFile</span>();</span><br><span class="line"></span><br><span class="line">	FFillArrayDirectoryVisitor Visitor;</span><br><span class="line">	PlatformFile.<span class="built_in">IterateDirectory</span>(*FPaths::<span class="built_in">ProjectDir</span>(), Visitor);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UE_LOG</span>(LogTemp,Log,<span class="built_in">TEXT</span>(<span class="string">&quot;Found Files:&quot;</span>));</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; File : Visitor.Files)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">UE_LOG</span>(LogTemp, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;%s&quot;</span>), *File);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">UE_LOG</span>(LogTemp, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;Found Directorys:&quot;</span>));</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; Dir : Visitor.Directories)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">UE_LOG</span>(LogTemp, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;%s&quot;</span>), *Dir);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>IPlatformFile::IterateDirectory</code>这个函数有两个原型：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">IterateDirectory</span><span class="params">(<span class="keyword">const</span> TCHAR * Directory, FDirectoryVisitor Visitor)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">IterateDirectory</span><span class="params">(<span class="keyword">const</span> TCHAR * Directory,FDirectoryVisitorFunc Visitor)</span></span>;</span><br></pre></td></tr></table></figure>

<p>可以传入一个继承自 <code>FDirectoryVisitor</code> 的对象，或者传入一个下列签名的函数对象：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> TFunctionRef &lt; <span class="built_in"><span class="keyword">bool</span></span>(<span class="keyword">const</span> TCHAR *, <span class="keyword">bool</span>)&gt; FDirectoryVisitorFunc</span><br></pre></td></tr></table></figure>

<p>支持传入一个 Lambda 也是可以的：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">TArray&lt;FString&gt; Files;</span><br><span class="line">TArray&lt;FString&gt; Dirs;</span><br><span class="line"></span><br><span class="line">IPlatformFile&amp; PlatformFile = FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">GetPlatformFile</span>();</span><br><span class="line"><span class="keyword">auto</span> FallArrayDirVisitor = [&amp;Files,&amp;Dirs](<span class="keyword">const</span> TCHAR* InItem,<span class="keyword">bool</span> bInDir)-&gt;<span class="keyword">bool</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (bInDir)</span><br><span class="line">	&#123;</span><br><span class="line">		Dirs.<span class="built_in">AddUnique</span>(InItem);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		Files.<span class="built_in">AddUnique</span>(InItem);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br><span class="line">PlatformFile.<span class="built_in">IterateDirectory</span>(*InRelativePath, FallArrayDirVisitor);</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Paks/visitor-projectdir.webp"></p>
<p><code>AssetRegistry.bin</code>/<code>*.uproject</code>等文件都是在打包的时候打包进 pak 里的，<code>AAAAA.json</code>则是上面手动打到 Patch 的 Pak 里的。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>热更新</category>
        <category>Pak</category>
      </categories>
      <tags>
        <tag>热更新</tag>
        <tag>Pak</tag>
      </tags>
  </entry>
  <entry>
    <title>4.25.2Mac 打包的 metal-ar 错误</title>
    <url>/wiki/35250/</url>
    <content><![CDATA[<p>在 4.25.2 引擎版本，使用 Mac 打包时提示 metal-ar 错误，Log 中有执行 metal-ar 的报错：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UATHelper: Packaging (iOS):   LogShaders: Error: Archiving failed: metal-ar failed with code 2: Couldn&#x27;t posix_spawn: error 7</span><br><span class="line">UATHelper: Packaging (iOS):   LogShaders: Error: Archiving failed: metal-ar failed with code 2: Couldn&#x27;t posix_spawn: error 7</span><br><span class="line">UATHelper: Packaging (iOS):   LogShaders: Error: Archiving failed: metal-ar failed with code 2: Couldn&#x27;t posix_spawn: error 7</span><br><span class="line">UATHelper: Packaging (iOS):   LogShaders: Error: Archiving failed: no valid input for metallib.</span><br><span class="line">UATHelper: Packaging (iOS):   LogShaders: Error: Archiving failed: no valid input for metallib.</span><br><span class="line">UATHelper: Packaging (iOS):   LogShaders: Error: Archiving failed: no valid input for metallib.</span><br><span class="line">UATHelper: Packaging (iOS):   LogZipArchiveWriter: Display: Closing zip file with 25491 entries.</span><br><span class="line">UATHelper: Packaging (iOS):   CookResults: Error: Package Native Shader Library failed for IOS.</span><br><span class="line">UATHelper: Packaging (iOS):   LogCook: Display: Saved scl.csv /Users/buildmachine/Documents/BuildWorkspace/workspace/PackageClient/Client/Saved/Cooked/IOS/FGame/Metadata/PipelineCaches/ShaderStableInfo-Global-SF_METAL.scl.csv for platform IOS</span><br><span class="line">UATHelper: Packaging (iOS):   LogCook: Display: Saved scl.csv /Users/buildmachine/Documents/BuildWorkspace/workspace/PackageClient/Client/Saved/Cooked/IOS/FGame/Metadata/PipelineCaches/ShaderStableInfo-FGame-SF_METAL.scl.csv for platform IOS</span><br><span class="line">PackagingResults: Error: Archiving failed: metal-ar failed with code 2: Couldn&#x27;t posix_spawn: error 7</span><br><span class="line">PackagingResults: Error: Archiving failed: metal-ar failed with code 2: Couldn&#x27;t posix_spawn: error 7</span><br><span class="line">PackagingResults: Error: Archiving failed: metal-ar failed with code 2: Couldn&#x27;t posix_spawn: error 7</span><br><span class="line">PackagingResults: Error: Archiving failed: no valid input for metallib.</span><br><span class="line">PackagingResults: Error: Archiving failed: no valid input for metallib.</span><br><span class="line">PackagingResults: Error: Archiving failed: no valid input for metallib.</span><br><span class="line">PackagingResults: Error: Package Native Shader Library failed for IOS.</span><br></pre></td></tr></table></figure>
<p><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210603141828.webp"></p>
<p>引擎中调用 metal-ar 的代码如下：<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210603141722.webp"></p>
<p>感觉错误的问题像是传递给 metal-ar 的参数太长了导致的，把 metal-ar 参数打出来发现确实非常长：<br><img src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210603141944.webp"></p>
<p>解决办法，把在 Mac 上 <code>GetMaxArgLength</code> 的返回值改成一个较小的值或者从环境变量中获取即可：</p>
<figure class="highlight cpp"><figcaption><span>Developer\Apple\MetalShaderFormat\Private\MetalShaderCompiler.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> uint32 <span class="title">GetMaxArgLength</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_MAC &amp;&amp; !UNIXLIKE_TO_MAC_REMOTE_BUILDING</span></span><br><span class="line">  <span class="comment">// 引擎中原始代码为返回 ARG_MAX</span></span><br><span class="line">  <span class="comment">// return ARG_MAX;</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">4096</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="comment">// Ask the remote machine via &quot;getconf ARG_MAX&quot;</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">1024</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在官方版本的 4.25.2 中已经修复：<a href="https://github.com/EpicGames/UnrealEngine/commit/6c47cef5a9349fe8c9ac7d3445c74fd948a507ad">Use runtime evaluation of ARG_MAX instead of the compile-time constant (which in Xcode 12 is now 1m)</a></p>
<figure class="highlight cpp"><figcaption><span>Developer\Apple\MetalShaderFormat\Private\MetalShaderCompiler.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> uint32 <span class="title">GetMaxArgLength</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_MAC &amp;&amp; !UNIXLIKE_TO_MAC_REMOTE_BUILDING</span></span><br><span class="line">    <span class="keyword">static</span> uint32 MaxLength = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!MaxLength)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// It&#x27;s dangerous to use &quot;ARG_MAX&quot; directly because it&#x27;s a compile time constant and may not be compatible with the running OS.</span></span><br><span class="line">        <span class="comment">// It&#x27;s safer to get the number from &quot;getconf ARG_MAX&quot; and only use the constant as the fallback</span></span><br><span class="line">        FString StdOut, StdError;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">ExecRemoteProcess</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;/usr/bin/getconf&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;ARG_MAX&quot;</span>), <span class="literal">nullptr</span>, &amp;StdOut, &amp;StdError))</span><br><span class="line">        &#123;</span><br><span class="line">            MaxLength = FCString::<span class="built_in">Atoi</span>(*StdOut);</span><br><span class="line">            <span class="built_in">check</span>(MaxLength &gt; <span class="number">0</span>);</span><br><span class="line">            <span class="built_in">UE_LOG</span>(LogMetalShaderCompiler, Display, <span class="built_in">TEXT</span>(<span class="string">&quot;Set MaxArgLength to %d via getconf&quot;</span>), MaxLength);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            MaxLength = FMath::<span class="built_in">Min</span>(ARG_MAX, <span class="number">256</span> * <span class="number">1024</span>);</span><br><span class="line">            <span class="built_in">UE_LOG</span>(LogMetalShaderCompiler, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Failed to determine MaxArgLength via getconf: %s\nSet it to %d which is the lesser of MAX_ARG and the value from the 10.15 SDK&quot;</span>), *StdError, MaxLength);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> MaxLength;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="comment">// Ask the remote machine via &quot;getconf ARG_MAX&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1024</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
        <category>Bug</category>
        <category>4.25</category>
      </categories>
      <tags>
        <tag>IOS</tag>
        <tag>打包</tag>
        <tag>Bug</tag>
        <tag>Mac</tag>
      </tags>
  </entry>
  <entry>
    <title>UE4.25 Mac 字符转换 bug</title>
    <url>/wiki/38876/</url>
    <content><![CDATA[<blockquote>
<p> 在 4.26+ 中已修复。</p>
</blockquote>
<p>Mac 用的是 2 字节的宽字符，但却按 4 字节的去转，当材质里参数有中文时，就会出现不一致的 bug：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/Core/Private/Serialization/MemoryImage.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line">FHashedName::<span class="built_in">FHashedName</span>(<span class="keyword">const</span> FName&amp; InName)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (!InName.<span class="built_in">IsNone</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">const</span> FNameEntry* Entry = InName.<span class="built_in">GetComparisonNameEntry</span>();</span><br><span class="line">    <span class="keyword">const</span> int32 InternalNumber = InName.<span class="built_in">GetNumber</span>();</span><br><span class="line">    <span class="keyword">if</span> (Entry-&gt;<span class="built_in">IsWide</span>())</span><br><span class="line">    &#123;</span><br><span class="line">      WIDECHAR WideNameBuffer[NAME_SIZE];</span><br><span class="line">      Entry-&gt;<span class="built_in">GetWideName</span>(WideNameBuffer);</span><br><span class="line">      <span class="keyword">for</span> (int32 i = <span class="number">0</span>; i &lt; Entry-&gt;<span class="built_in">GetNameLength</span>(); ++i)</span><br><span class="line">      &#123;</span><br><span class="line">        WideNameBuffer[i] = FCharWide::<span class="built_in">ToUpper</span>(WideNameBuffer[i]);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Bug</span></span><br><span class="line">      <span class="comment">// const FTCHARToUTF8 NameUTF8(WCHAR_TO_TCHAR(WideNameBuffer));</span></span><br><span class="line">      <span class="comment">// Hash = CityHash64WithSeed(NameUTF8.Get(), NameUTF8.Length(), InternalNumber);</span></span><br><span class="line">          </span><br><span class="line">      <span class="comment">// WChar conversion bug in Mac</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in"><span class="keyword">sizeof</span></span>(WIDECHAR) != <span class="built_in"><span class="keyword">sizeof</span></span>(TCHAR))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="function"><span class="keyword">const</span> FTCHARToUTF8 <span class="title">NameUTF8</span><span class="params">(WCHAR_TO_TCHAR(WideNameBuffer))</span></span>;</span><br><span class="line">        Hash = <span class="built_in">CityHash64WithSeed</span>(NameUTF8.<span class="built_in">Get</span>(), NameUTF8.<span class="built_in">Length</span>(), InternalNumber);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">const</span> FTCHARToUTF8 <span class="built_in">NameUTF8</span>((TCHAR*)WideNameBuffer);</span><br><span class="line">        Hash = <span class="built_in">CityHash64WithSeed</span>(NameUTF8.<span class="built_in">Get</span>(), NameUTF8.<span class="built_in">Length</span>(), InternalNumber);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      ANSICHAR AnsiNameBuffer[NAME_SIZE];</span><br><span class="line">      Entry-&gt;<span class="built_in">GetAnsiName</span>(AnsiNameBuffer);</span><br><span class="line">      <span class="keyword">for</span> (int32 i = <span class="number">0</span>; i &lt; Entry-&gt;<span class="built_in">GetNameLength</span>(); ++i)</span><br><span class="line">      &#123;</span><br><span class="line">        AnsiNameBuffer[i] = FCharAnsi::<span class="built_in">ToUpper</span>(AnsiNameBuffer[i]);</span><br><span class="line">      &#125;</span><br><span class="line">      Hash = <span class="built_in">CityHash64WithSeed</span>(AnsiNameBuffer, Entry-&gt;<span class="built_in">GetNameLength</span>(), InternalNumber);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    Hash = <span class="number">0u</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
        <category>Bug</category>
        <category>4.25</category>
      </categories>
      <tags>
        <tag>Bug</tag>
      </tags>
  </entry>
  <entry>
    <title>UE4.25.1 的 Assembly 路径错误</title>
    <url>/wiki/39506/</url>
    <content><![CDATA[<p>在 UE4.25.1 中，引擎生成的 <code>Engine/Intermediate/Build/BuildRules/UE4Rules.dll</code> 等文件具有路径错误。</p>
<p>具体的原因是在 <code>UnrealBuildTool/System/RulesCompiler.cs</code> 的<code>CreateEngineOrEnterpriseRulesAssembly</code>函数：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UE 4.25.1</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> RulesAssembly <span class="title">CreateEngineOrEnterpriseRulesAssembly</span>(<span class="params">RulesScope Scope, List&lt;DirectoryReference&gt; RootDirectories, <span class="built_in">string</span> AssemblyPrefix, IReadOnlyList&lt;PluginInfo&gt; Plugins, <span class="built_in">bool</span> bReadOnly, <span class="built_in">bool</span> bSkipCompile, RulesAssembly Parent</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// Get the path to store any generated assemblies</span></span><br><span class="line">  DirectoryReference AssemblyDir = RootDirectories[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">if</span> (UnrealBuildTool.IsFileInstalled(FileReference.Combine(AssemblyDir, AssemblyPrefix)))</span><br><span class="line">  &#123;</span><br><span class="line">  DirectoryReference UserDir = Utils.GetUserSettingDirectory();</span><br><span class="line">      <span class="keyword">if</span> (UserDir != <span class="literal">null</span>)</span><br><span class="line">  &#123;</span><br><span class="line">      ReadOnlyBuildVersion Version = ReadOnlyBuildVersion.Current;</span><br><span class="line">      AssemblyDir = DirectoryReference.Combine(UserDir, <span class="string">&quot;UnrealEngine&quot;</span>, String.Format(<span class="string">&quot;&#123;0&#125;.&#123;1&#125;&quot;</span>, Version.MajorVersion, Version.MinorVersion));</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create the assembly</span></span><br><span class="line">  FileReference EngineAssemblyFileName = FileReference.Combine(AssemblyDir, <span class="string">&quot;Intermediate&quot;</span>, <span class="string">&quot;Build&quot;</span>, <span class="string">&quot;BuildRules&quot;</span>, AssemblyPrefix + <span class="string">&quot;Rules&quot;</span> + FrameworkAssemblyExtension);</span><br><span class="line">  RulesAssembly EngineAssembly = <span class="keyword">new</span> RulesAssembly(Scope, RootDirectories, Plugins, ModuleFileToContext, <span class="keyword">new</span> List&lt;FileReference&gt;(), EngineAssemblyFileName, bContainsEngineModules: <span class="literal">true</span>, DefaultBuildSettings: BuildSettingsVersion.Latest, bReadOnly: bReadOnly, bSkipCompile: bSkipCompile, Parent: Parent);</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码中 <code>AssemblyDir</code> 是引擎目录，<code>AssemblyPrefix</code>是 <code>UE4</code>，拼接起来能够通过<code>UnrealBuildTool.IsFileInstalled</code> 的检测。<br>但是，在 if 的代码块中，获取了用户目录，在 IOS 中就是：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># win</span></span><br><span class="line">C:\Users\lipengzha\AppData\Local\UnrealEngine\4.25</span><br><span class="line"><span class="comment"># Mac</span></span><br><span class="line">/Users/buildmachine/Library/Application Support/Epic</span><br></pre></td></tr></table></figure>
<p>拼接起来就是上面这两个 <code>USER_DIR</code> 的<code>UnrealEngine/4.25/</code>，在下面读取 <code>Assembly</code> 的流程中就会使用这个路径。</p>
<p>在使用 Win 的时候，其实没有问题，因为就算把 <code>UE4Rules.dll</code> 写入到用户目录下，在 Win 上同样是可以访问到的。<strong>但是 </strong>，在使用 Win 远程构建 IOS 的时候就会出现问题。<br> 在远程构建时，会使用 Rsync 把引擎的文件同步到 Mac 上再执行编译，其中就包括 <code>Engine/Intermediate/Build/BuildRuls/</code> 下的所有文件，因为 4.25.1 中的代码会把 <code>Build/BuildRuls/UE4Rules.dll</code> 等生成到 Win 的用户目录下，所以远程构建，RSync 就不能正确地把 <code>BuildRuls</code> 下的文件上传到 Mac 上，故而引起打包错误：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ERROR: Precompiled rules assembly <span class="string">&#x27;/Users/buildmachine/Library/Application Support/Epic/UnrealEngine/4.25/Intermediate/Build/BuildRules/UE4Rules.dl</span></span><br><span class="line"><span class="string">l&#x27;</span> does not exist.</span><br></pre></td></tr></table></figure>
<p>可以看到，在 Mac 上也是从 Mac 的用户目录查找的，因为压根 Mac 上就没有这俩文件，所以就会产生这个错误。<br>解决这个问题的办法，就是修改 <code>UnrealBuildTool/System/RulesCompiler.cs</code> 的<code>CreateEngineOrEnterpriseRulesAssembly</code>函数，把 <code>BuildRules</code> 相关的文件写入到 <code>Engine/Intermediate/Build/BuildRules</code> 中，在 UE4.25.2 中已经修复了这个错误。<br>在 <a href="https://forums.unrealengine.com/unreal-engine/announcements-and-releases/1791750-4-25-2-hotfix-released">4.25.2 Hotfix released</a> 中列出了 <strong>Fixed! UE-94140 Fix assembly location for remote toolchain</strong>，其实就是直接修改了<code>CreateEngineOrEnterpriseRulesAssembly</code> 函数:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UE 4.25.2</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> RulesAssembly <span class="title">CreateEngineOrEnterpriseRulesAssembly</span>(<span class="params">RulesScope Scope, List&lt;DirectoryReference&gt; RootDirectories, <span class="built_in">string</span> AssemblyPrefix, IReadOnlyList&lt;PluginInfo&gt; Plugins, <span class="built_in">bool</span> bReadOnly, <span class="built_in">bool</span> bSkipCompile, RulesAssembly Parent</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// Create the assembly</span></span><br><span class="line">  FileReference EngineAssemblyFileName = FileReference.Combine(RootDirectories[<span class="number">0</span>], <span class="string">&quot;Intermediate&quot;</span>, <span class="string">&quot;Build&quot;</span>, <span class="string">&quot;BuildRules&quot;</span>, AssemblyPrefix + <span class="string">&quot;Rules&quot;</span> + FrameworkAssemblyExtension);</span><br><span class="line">  RulesAssembly EngineAssembly = <span class="keyword">new</span> RulesAssembly(Scope, RootDirectories[<span class="number">0</span>], Plugins, ModuleFileToContext, <span class="keyword">new</span> List&lt;FileReference&gt;(), EngineAssemblyFileName, bContainsEngineModules: <span class="literal">true</span>, DefaultBuildSettings: BuildSettingsVersion.Latest, bReadOnly: bReadOnly, bSkipCompile: bSkipCompile, Parent: Parent);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以直接在 github 中查看:<a href="https://github.com/EpicGames/UnrealEngine/blob/4.24.2-release/Engine/Source/Programs/UnrealBuildTool/System/RulesCompiler.cs#L442">UnrealBuildTool/System/RulesCompiler.cs#L442</a></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
        <category>Bug</category>
        <category>4.25</category>
      </categories>
      <tags>
        <tag>Bug</tag>
      </tags>
  </entry>
  <entry>
    <title>UE4.25 中 ShaderPatch 问题</title>
    <url>/wiki/16280/</url>
    <content><![CDATA[<p>在 4.25 引擎版本中调用 <code>FShaderCodeLibrary::CreatePatchLibrary</code> 来创建 ShaderCode Patch 会触发 check 抛异常：<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201211125932.webp"></p>
<p>这是因为 <code>FEditorShaderCodeArchive</code> 的构造函数中调用了 ShaderHashTable 的 Initialize，并给了默认值<code>0x1000</code>：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">FEditorShaderCodeArchive</span>(FName InFormat)</span><br><span class="line">    : <span class="built_in">FormatName</span>(InFormat)</span><br><span class="line">    , <span class="built_in">Format</span>(<span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">  Format = <span class="built_in">GetTargetPlatformManagerRef</span>().<span class="built_in">FindShaderFormat</span>(InFormat);</span><br><span class="line">  <span class="built_in">check</span>(Format);</span><br><span class="line"></span><br><span class="line">  SerializedShaders.ShaderHashTable.<span class="built_in">Initialize</span>(<span class="number">0x10000</span>);</span><br><span class="line">  SerializedShaders.ShaderMapHashTable.<span class="built_in">Initialize</span>(<span class="number">0x10000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201211125525.webp"></p>
<p>导致在后续的流程中 (<code>FSerializedShaderArchive::Serialize</code>) 调用 <code>Initialize</code> 的时候 check 失败了(因为 HaseSize 已经有值了，并不是 0，对其再调用 Initialize 就触发了 check)：<br><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201211130200.webp"></p>
<p>查了下 <code>FEditorShaderCodeArchive</code> 构造函数中调用 <code>Initialize</code> 的代码是在 4.25 之后的引擎版本才有的，所以影响到的之后 4.25+ 的版本。<br>代码对比：</p>
<ul>
<li><a href="https://github.com/EpicGames/UnrealEngine/blob/4.24.3-release/Engine/Source/Runtime/RenderCore/Private/ShaderCodeLibrary.cpp#L922">4.24.3-release/Engine/Source/Runtime/RenderCore/Private/ShaderCodeLibrary.cpp#L922</a></li>
<li><a href="https://github.com/EpicGames/UnrealEngine/blob/4.25.0-release/Engine/Source/Runtime/RenderCore/Private/ShaderCodeLibrary.cpp#L801">4.25.0-release/Engine/Source/Runtime/RenderCore/Private/ShaderCodeLibrary.cpp#L801</a></li>
</ul>
<p>解决方案：把 <code>FSerializedShaderArchive::Serialize</code> 中<code>ShaderMapHashTable</code>的 <code>Initialize</code> 和<code>ShaderHashTable</code>的 <code>Initialize</code> 在 Editor 下注释掉，因为 <code>FEditorShaderCodeArchive</code> 的代码只在 Editor 下有效，并且是只在生成 ShaderPatch 时有用。</p>
<p>这就造成了以下几个问题：</p>
<ol>
<li><code>FEditorShaderCodeArchive</code>的构造只有 Eidotor 并且 ShaderPatch 是才有用，也就意味着这里写的 <code>ShaderMapHashTable</code> 的<code>Initialize</code>和 <code>ShaderHashTable</code> 的<code>Initialize</code>只有在创建 ShaderPatch 时才会执行</li>
<li>在打基础包时执行 Cook 会编译 shader，但是不会执行 FEditorShaderCodeArchive 的构造，<code>ShaderMapHashTable</code>的 <code>Initialize</code> 和<code>ShaderHashTable</code>的 <code>Initialize</code> 也就不会执行，就需要在使用的地方来调用它们的初始化</li>
</ol>
<p>这也是 UE 中没有管理好这两个状态的地方：在 <code>FEditorShaderCodeArchive</code> 和<code>FSerializedShaderArchive::Serialize</code>中都做了 Initialize 的操作，在打基础包时造成了 <code>ShaderMapHashTable</code> 和<code>ShaderHashTable</code>的 <code>Initialize</code> 已经被 <code>FEditorShaderCodeArchive</code> 初始化的情况下又被 <code>FSerializedShaderArchive::Serialize</code> 执行了一遍，导致 Crash，但是我们又不能粗暴地把任何一处的初始化操作去掉，只能通过检测 <code>ShaderMapHashTable</code> 和<code>ShaderHashTable</code>的 <code>Initialize</code> 是否已经被执行，来选择性的跳过。</p>
<p>阅读代码可以知道 <code>ShaderMapHashTable</code> 和<code>ShaderHashTable</code>的 <code>Initialize</code> 只应该执行一次，并且初始化之后 HashSize 和 IndexSize 应该具有非 0 值：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/Core/Public/Containers/HashTable.h</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function">FORCEINLINE <span class="keyword">void</span> <span class="title">FHashTable::Initialize</span><span class="params">(uint32 InHashSize, uint32 InIndexSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">check</span>(HashSize == <span class="number">0u</span>);</span><br><span class="line">  <span class="built_in">check</span>(IndexSize == <span class="number">0u</span>);</span><br><span class="line"></span><br><span class="line">  HashSize = InHashSize;</span><br><span class="line">  IndexSize = InIndexSize;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">check</span>(HashSize &lt;= <span class="number">0x10000</span>);</span><br><span class="line">  <span class="built_in">check</span>(FMath::<span class="built_in">IsPowerOfTwo</span>(HashSize));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (IndexSize)</span><br><span class="line">  &#123;</span><br><span class="line">    HashMask = (uint16)(HashSize - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    Hash = <span class="keyword">new</span> uint32[HashSize];</span><br><span class="line">    NextIndex = <span class="keyword">new</span> uint32[IndexSize];</span><br><span class="line"></span><br><span class="line">    FMemory::<span class="built_in">Memset</span>(Hash, <span class="number">0xff</span>, HashSize * <span class="number">4</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>Initialize</code> 时会检测当前的 <code>HashSize</code> 和<code>IndexSize</code>是否为 0，并在之后进行赋值。所以，我们只要获取 <code>FHashTable</code> 的<code>HashSize</code>和 <code>IndexSize</code> 检测它们是否为 0 即可判断当前的 <code>HashTable</code> 对象是否已经被 <code>Initialize</code> 过，但是，UE 里的 <code>FHashTable</code> 里这两个成员都是 <code>protected</code> 的，只能修改引擎来实现了：</p>
<p>添加获取 <code>FHashTable</code> 的<code>HashSize</code>和 <code>IndexSize</code> 属性的成员函数：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FHashTable</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="function">FORCEINLINE uint32 <span class="title">GetHashSize</span><span class="params">()</span><span class="keyword">const</span></span>&#123;<span class="keyword">return</span> HashSize;&#125;;</span><br><span class="line">  <span class="function">FORCEINLINE uint32 <span class="title">GetIndexSize</span><span class="params">()</span><span class="keyword">const</span></span>&#123;<span class="keyword">return</span> IndexSize;&#125;;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>然后在 <code>FSerializedShaderArchive::Serialize</code> 进行检测，如果已被初始化则跳过 <code>Initialize</code> 逻辑：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/RenderCore/Private/ShaderCodeArchive.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FSerializedShaderArchive::Serialize</span><span class="params">(FArchive&amp; Ar)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Ar &lt;&lt; ShaderMapHashes;</span><br><span class="line">  Ar &lt;&lt; ShaderHashes;</span><br><span class="line">  Ar &lt;&lt; ShaderMapEntries;</span><br><span class="line">  Ar &lt;&lt; ShaderEntries;</span><br><span class="line">  Ar &lt;&lt; PreloadEntries;</span><br><span class="line">  Ar &lt;&lt; ShaderIndices;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">check</span>(ShaderHashes.<span class="built_in">Num</span>() == ShaderEntries.<span class="built_in">Num</span>());</span><br><span class="line">  <span class="built_in">check</span>(ShaderMapHashes.<span class="built_in">Num</span>() == ShaderMapEntries.<span class="built_in">Num</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (Ar.<span class="built_in">IsLoading</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">    <span class="keyword">auto</span> ShaderHashInitialized = [](<span class="keyword">const</span> FHashTable&amp; HashTable)-&gt;<span class="keyword">bool</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> HashTable.<span class="built_in">GetHashSize</span>() || HashTable.<span class="built_in">GetIndexSize</span>();</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">const</span> uint32 HashSize = FMath::Min&lt;uint32&gt;(<span class="number">0x10000</span>, <span class="number">1u</span> &lt;&lt; FMath::<span class="built_in">CeilLogTwo</span>(ShaderMapHashes.<span class="built_in">Num</span>()));</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">      <span class="keyword">if</span>(!<span class="built_in">ShaderHashInitialized</span>(ShaderMapHashTable))</span><br><span class="line">      &#123;</span><br><span class="line">        ShaderMapHashTable.<span class="built_in">Initialize</span>(HashSize, ShaderMapHashes.<span class="built_in">Num</span>());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">for</span> (int32 Index = <span class="number">0</span>; Index &lt; ShaderMapHashes.<span class="built_in">Num</span>(); ++Index)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">const</span> uint32 Key = <span class="built_in">GetTypeHash</span>(ShaderMapHashes[Index]);</span><br><span class="line">        ShaderMapHashTable.<span class="built_in">Add</span>(Key, Index);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">const</span> uint32 HashSize = FMath::Min&lt;uint32&gt;(<span class="number">0x10000</span>, <span class="number">1u</span> &lt;&lt; FMath::<span class="built_in">CeilLogTwo</span>(ShaderHashes.<span class="built_in">Num</span>()));</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">      <span class="keyword">if</span>(!<span class="built_in">ShaderHashInitialized</span>(ShaderHashTable))</span><br><span class="line">      &#123;</span><br><span class="line">        ShaderHashTable.<span class="built_in">Initialize</span>(HashSize, ShaderHashes.<span class="built_in">Num</span>());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">for</span> (int32 Index = <span class="number">0</span>; Index &lt; ShaderHashes.<span class="built_in">Num</span>(); ++Index)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">const</span> uint32 Key = <span class="built_in">GetTypeHash</span>(ShaderHashes[Index]);</span><br><span class="line">        ShaderHashTable.<span class="built_in">Add</span>(Key, Index);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样可以统一 ShaderPatch 和 Runtime 的 HashTable 的 Initialize 流程。</p>
<p>而且，需要注意的是：生成出来的 ShaderPatch 的 <code>ushaderbytecode</code> 文件是与基础包内的文件名一致的，所以不能使用引擎启动时的默认挂载（会导致基础包内的 ushaderbytecode 文件无法被加载，从而 crash）。</p>
<p><img src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/auto-mount-shaderpatch-crash.webp"></p>
<p>应该在挂载之后自己处理 ShaderPatch 的 ushaderbytecode 文件的加载，使用以下函数加载：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UFlibPatchParserHelper::LoadShaderbytecode</span><span class="params">(<span class="keyword">const</span> FString&amp; LibraryName, <span class="keyword">const</span> FString&amp; LibraryDir)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> FShaderCodeLibrary::<span class="built_in">OpenLibrary</span>(LibraryName, LibraryDir);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：ShaderPatch 的更新不直接支持 Patch 的迭代，如：1.0 Metadata + 1.1 的 ShaderPatch，并不能生成 1.2 的 ShaderPatch，必须要基于 1.1 的完整 Metadata 才可以，即每次 Patch 必须要基于上一次完整的 Metadate 数据（Project 和 Global 的 ushaderbytecode 文件），在工程管理上每次打包都需要把完整的 Metadata 收集起来。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Engine</category>
        <category>Bug</category>
        <category>4.25</category>
      </categories>
      <tags>
        <tag>Bug</tag>
        <tag>ShaderPatcher</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20230524 | 本周日见</title>
    <url>/wiki/external1631247399/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/631800013"> 虚幻周报 20230524 | 本周日见 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20230517 | 下一站北京</title>
    <url>/wiki/external1072820005/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/630027891"> 虚幻周报 20230517 | 下一站北京 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
  <entry>
    <title>虚幻周报 20230511 | 5.2 要来啦</title>
    <url>/wiki/external1755787467/</url>
    <content><![CDATA[<p> 本篇文章为外部内容，请点击链接跳转至原站点：<a href="https://zhuanlan.zhihu.com/p/628555743"> 虚幻周报 20230511 | 5.2 要来啦 </a>。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>虚幻周报</category>
      </categories>
      <tags>
        <tag>虚幻周报</tag>
      </tags>
  </entry>
</search>
